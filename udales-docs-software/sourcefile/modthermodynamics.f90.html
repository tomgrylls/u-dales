<!DOCTYPE html>
<html lang="en">
  <head>
    <meta charset="utf-8">
    <meta http-equiv="X-UA-Compatible" content="IE=edge">
    <meta name="viewport" content="width=device-width, initial-scale=1">
   
    <meta name="description" content="Documentation for uDALES">
   
    <meta name="author" content="The uDALES Team" >
    <link rel="icon" href="../favicon.png">

    <title>modthermodynamics.f90 &ndash; uDALES</title>

    <link href="../css/bootstrap.min.css" rel="stylesheet">
    <link href="../css/pygments.css" rel="stylesheet">
    <link href="../css/font-awesome.min.css" rel="stylesheet">
    <link href="../css/local.css" rel="stylesheet">
    
    <link  href="../tipuesearch/tipuesearch.css" rel="stylesheet">
    
    

    <!-- HTML5 shim and Respond.js for IE8 support of HTML5 elements and media queries -->
    <!--[if lt IE 9]>
      <script src="https://oss.maxcdn.com/html5shiv/3.7.2/html5shiv.min.js"></script>
      <script src="https://oss.maxcdn.com/respond/1.4.2/respond.min.js"></script>
    <![endif]-->
    
    <script src="../js/jquery-2.1.3.min.js"></script>
    <script src="../js/svg-pan-zoom.min.js"></script>

  </head>

  <body>

    <!-- Fixed navbar -->
    <nav class="navbar navbar-inverse navbar-fixed-top">
      <div class="container">
        <div class="navbar-header">
          <button type="button" class="navbar-toggle collapsed" data-toggle="collapse" data-target="#navbar" aria-expanded="false" aria-controls="navbar">
            <span class="sr-only">Toggle navigation</span>
            <span class="icon-bar"></span>
            <span class="icon-bar"></span>
            <span class="icon-bar"></span>
          </button>
          <a class="navbar-brand" href="../index.html">uDALES </a>
        </div>
        <div id="navbar" class="navbar-collapse collapse">
          <ul class="nav navbar-nav">
        
            <li class="dropdown hidden-xs visible-sm visible-md hidden-lg">
              <a href="#" class="dropdown-toggle"
              data-toggle="dropdown" role="button"
              aria-haspopup="true"
     aria-expanded="false">Contents <span class="caret"></span></a>
        <ul class="dropdown-menu">
          
              
            <li><a href="../lists/files.html">Source Files</a></li>
        
        
        
            <li><a href="../lists/modules.html">Modules</a></li>
        
            
                                
            <li><a href="../lists/procedures.html">Procedures</a></li>
        
               
            <li><a href="../lists/types.html">Derived Types</a></li>
        
        
            <li><a href="../program/dalesurban.html">Program</a></li>
      
            </ul>
            </li>


<li class="visible-xs hidden-sm visible-lg"><a href="../lists/files.html">Source Files</a></li>



<li class="visible-xs hidden-sm visible-lg"><a href="../lists/modules.html">Modules</a></li>



<li class="visible-xs hidden-sm visible-lg"><a href="../lists/procedures.html">Procedures</a></li>

                             
<li class="visible-xs hidden-sm visible-lg"><a href="../lists/types.html">Derived Types</a></li>


<li class="visible-xs hidden-sm visible-lg"><a href="../program/dalesurban.html">Program</a></li>

          </ul>
        
        <form action="../search.html" class="navbar-form navbar-right" role="search">
        <div class="form-group">
          <input type="text" class="form-control" placeholder="Search" name="q" id="tipue_search_input" autocomplete="off" required>
        </div>
<!--
        <button type="submit" class="btn btn-default">Submit</button>
-->
        </form>
        
        </div><!--/.nav-collapse -->
      </div>
    </nav>

    <div class="container">
    
  
  <div class="row">
    <h1>modthermodynamics.f90
    <small>Source File</small>
    
    </h1>
    
<div class="row">
  <div class="col-lg-12">
<div class="well well-sm">
  <ul class="list-inline" style="margin-bottom:0px;display:inline">
     
     
     
     
    
    
     <li><i class="fa fa-list-ol"></i>
       <a data-toggle="tooltip"
    data-placement="bottom" data-html="true"
    title=" 1.9% of total for source files.">273 statements</a>
     </li> 
     
     
     
    <li><i class="fa fa-code"></i><a href="../src/modthermodynamics.f90"> Source File</a></li>
     
     
  </ul>
  <ol class="breadcrumb in-well text-right">
  
    
  
     <li class="active">modthermodynamics.f90</li>
  </ol>
</div>
</div>
</div>
<script>
  $(function () {
  $('[data-toggle="tooltip"]').tooltip()
  })
</script>

  </div>
  <div class="row">
    <div class="col-md-3 hidden-xs hidden-sm visible-md visible-lg">
    
<div id="sidebar">
  
<h3>Contents</h3>
 







<div class="panel panel-primary">
  <div class="panel-heading text-left"><h3 class="panel-title"><a data-toggle="collapse" href="#mods-0">Modules</a></h3></div>
  <div id="mods-0" class="panel-collapse collapse">
    <div class="list-group">
      
      <a class="list-group-item" href="../module/modthermodynamics.html">modthermodynamics</a>
      
    </div>
  </div>
</div>
















<div class="panel panel-primary">
  <div class="panel-heading text-left"><h3 class="panel-title">Source Code</h3></div>
  <div class="list-group">
    <a class="list-group-item" href="../sourcefile/modthermodynamics.f90.html#src">modthermodynamics.f90</a>
  </div>
</div>



</div>

    </div>
    <div class="col-md-9" id='text'>
      
      <br>
    
    <div class="panel panel-default">
      <div class="panel-heading">
  <h3 class="panel-title">This file depends on</h3>
      </div>
      <div class="panel-body">
  <div class="depgraph"><?xml version="1.0" encoding="UTF-8" standalone="no"?>
<!DOCTYPE svg PUBLIC "-//W3C//DTD SVG 1.1//EN"
 "http://www.w3.org/Graphics/SVG/1.1/DTD/svg11.dtd">
<!-- Generated by graphviz version 2.40.1 (20161225.0304)
 -->
<!-- Title: sourcefile~~modthermodynamics.f90~~EfferentGraph Pages: 1 -->
<svg id="sourcefilemodthermodynamicsf90EfferentGraph" width="486pt" height="105pt"
 viewBox="0.00 0.00 486.00 104.76" xmlns="http://www.w3.org/2000/svg" xmlns:xlink="http://www.w3.org/1999/xlink">
<g id="sourcefile~~modthermodynamics.f90~~EfferentGraph" class="graph" transform="scale(1 1) rotate(0) translate(4 100.7608)">
<title>sourcefile~~modthermodynamics.f90~~EfferentGraph</title>
<polygon fill="#ffffff" stroke="transparent" points="-4,4 -4,-100.7608 482,-100.7608 482,4 -4,4"/>
<!-- sourcefile~modthermodynamics.f90 -->
<g id="sourcefile~~modthermodynamics.f90~~EfferentGraph_node1" class="node">
<title>sourcefile~modthermodynamics.f90</title>
<polygon fill="none" stroke="#000000" points="478,-61.4431 348,-61.4431 348,-37.4431 478,-37.4431 478,-61.4431"/>
<text text-anchor="middle" x="413" y="-47.0431" font-family="Helvetica,sans-Serif" font-size="10.50" fill="#000000">modthermodynamics.f90</text>
</g>
<!-- sourcefile~modglobal.f90 -->
<g id="sourcefile~~modthermodynamics.f90~~EfferentGraph_node2" class="node">
<title>sourcefile~modglobal.f90</title>
<g id="a_sourcefile~~modthermodynamics.f90~~EfferentGraph_node2"><a xlink:href=".././sourcefile/modglobal.f90.html" xlink:title="modglobal.f90">
<polygon fill="#f0ad4e" stroke="#f0ad4e" points="185,-82.4431 105,-82.4431 105,-58.4431 185,-58.4431 185,-82.4431"/>
<text text-anchor="middle" x="145" y="-68.0431" font-family="Helvetica,sans-Serif" font-size="10.50" fill="#ffffff">modglobal.f90</text>
</a>
</g>
</g>
<!-- sourcefile~modthermodynamics.f90&#45;&gt;sourcefile~modglobal.f90 -->
<g id="sourcefile~~modthermodynamics.f90~~EfferentGraph_edge1" class="edge">
<title>sourcefile~modthermodynamics.f90&#45;&gt;sourcefile~modglobal.f90</title>
<path fill="none" stroke="#ff0000" stroke-dasharray="5,2" d="M390.9442,-61.6066C371.0045,-71.8638 340.4931,-85.7549 312,-91.4431 272.3382,-99.3609 261.0776,-96.8783 221,-91.4431 211.0299,-90.091 200.5201,-87.7842 190.6022,-85.1824"/>
<polygon fill="#ff0000" stroke="#ff0000" points="191.4947,-81.7979 180.9236,-82.5067 189.6294,-88.5448 191.4947,-81.7979"/>
</g>
<!-- sourcefile~modfields.f90 -->
<g id="sourcefile~~modthermodynamics.f90~~EfferentGraph_node3" class="node">
<title>sourcefile~modfields.f90</title>
<g id="a_sourcefile~~modthermodynamics.f90~~EfferentGraph_node3"><a xlink:href=".././sourcefile/modfields.f90.html" xlink:title="modfields.f90">
<polygon fill="#f0ad4e" stroke="#f0ad4e" points="304.5,-82.4431 228.5,-82.4431 228.5,-58.4431 304.5,-58.4431 304.5,-82.4431"/>
<text text-anchor="middle" x="266.5" y="-68.0431" font-family="Helvetica,sans-Serif" font-size="10.50" fill="#ffffff">modfields.f90</text>
</a>
</g>
</g>
<!-- sourcefile~modthermodynamics.f90&#45;&gt;sourcefile~modfields.f90 -->
<g id="sourcefile~~modthermodynamics.f90~~EfferentGraph_edge2" class="edge">
<title>sourcefile~modthermodynamics.f90&#45;&gt;sourcefile~modfields.f90</title>
<path fill="none" stroke="#ff0000" stroke-dasharray="5,2" d="M347.8898,-58.7763C336.655,-60.3867 325.1616,-62.0343 314.4844,-63.5648"/>
<polygon fill="#ff0000" stroke="#ff0000" points="313.9348,-60.1077 304.5327,-64.9913 314.9281,-67.0369 313.9348,-60.1077"/>
</g>
<!-- sourcefile~modsurfdata.f90 -->
<g id="sourcefile~~modthermodynamics.f90~~EfferentGraph_node4" class="node">
<title>sourcefile~modsurfdata.f90</title>
<g id="a_sourcefile~~modthermodynamics.f90~~EfferentGraph_node4"><a xlink:href=".././sourcefile/modsurfdata.f90.html" xlink:title="modsurfdata.f90">
<polygon fill="#f0ad4e" stroke="#f0ad4e" points="312,-40.4431 221,-40.4431 221,-16.4431 312,-16.4431 312,-40.4431"/>
<text text-anchor="middle" x="266.5" y="-26.0431" font-family="Helvetica,sans-Serif" font-size="10.50" fill="#ffffff">modsurfdata.f90</text>
</a>
</g>
</g>
<!-- sourcefile~modthermodynamics.f90&#45;&gt;sourcefile~modsurfdata.f90 -->
<g id="sourcefile~~modthermodynamics.f90~~EfferentGraph_edge3" class="edge">
<title>sourcefile~modthermodynamics.f90&#45;&gt;sourcefile~modsurfdata.f90</title>
<path fill="none" stroke="#ff0000" stroke-dasharray="5,2" d="M347.8898,-40.1099C339.3058,-38.8794 330.5708,-37.6273 322.1643,-36.4223"/>
<polygon fill="#ff0000" stroke="#ff0000" points="322.5007,-32.9348 312.1052,-34.9804 321.5074,-39.864 322.5007,-32.9348"/>
</g>
<!-- sourcefile~modmpi.f90 -->
<g id="sourcefile~~modthermodynamics.f90~~EfferentGraph_node5" class="node">
<title>sourcefile~modmpi.f90</title>
<g id="a_sourcefile~~modthermodynamics.f90~~EfferentGraph_node5"><a xlink:href=".././sourcefile/modmpi.f90.html" xlink:title="modmpi.f90">
<polygon fill="#f0ad4e" stroke="#f0ad4e" points="69,-41.4431 0,-41.4431 0,-17.4431 69,-17.4431 69,-41.4431"/>
<text text-anchor="middle" x="34.5" y="-27.0431" font-family="Helvetica,sans-Serif" font-size="10.50" fill="#ffffff">modmpi.f90</text>
</a>
</g>
</g>
<!-- sourcefile~modthermodynamics.f90&#45;&gt;sourcefile~modmpi.f90 -->
<g id="sourcefile~~modthermodynamics.f90~~EfferentGraph_edge4" class="edge">
<title>sourcefile~modthermodynamics.f90&#45;&gt;sourcefile~modmpi.f90</title>
<path fill="none" stroke="#ff0000" stroke-dasharray="5,2" d="M390.9442,-37.2796C371.0045,-27.0224 340.4931,-13.1313 312,-7.4431 230.7986,8.7675 133.9878,-6.5754 78.8348,-18.4968"/>
<polygon fill="#ff0000" stroke="#ff0000" points="78.0371,-15.0886 69.0345,-20.6746 79.5557,-21.9219 78.0371,-15.0886"/>
</g>
<!-- sourcefile~modglobal.f90&#45;&gt;sourcefile~modmpi.f90 -->
<g id="sourcefile~~modthermodynamics.f90~~EfferentGraph_edge5" class="edge">
<title>sourcefile~modglobal.f90&#45;&gt;sourcefile~modmpi.f90</title>
<path fill="none" stroke="#ff0000" stroke-dasharray="5,2" d="M112.444,-58.3635C101.3032,-54.2298 88.6724,-49.5432 76.8716,-45.1647"/>
<polygon fill="#ff0000" stroke="#ff0000" points="77.7981,-41.7754 67.2051,-41.578 75.363,-48.3382 77.7981,-41.7754"/>
</g>
<!-- sourcefile~modfields.f90&#45;&gt;sourcefile~modglobal.f90 -->
<g id="sourcefile~~modthermodynamics.f90~~EfferentGraph_edge6" class="edge">
<title>sourcefile~modfields.f90&#45;&gt;sourcefile~modglobal.f90</title>
<path fill="none" stroke="#7fff00" stroke-dasharray="5,2" d="M228.39,-70.4431C217.84,-70.4431 206.227,-70.4431 195.1054,-70.4431"/>
<polygon fill="#7fff00" stroke="#7fff00" points="195.0743,-66.9432 185.0743,-70.4431 195.0743,-73.9432 195.0743,-66.9432"/>
</g>
</g>
</svg>
</div><div><a type="button" class="graph-help" data-toggle="modal" href="#graph-help-text">Help</a></div><div class="modal fade" id="graph-help-text" tabindex="-1" role="dialog"><div class="modal-dialog modal-lg" role="document"><div class="modal-content"><div class="modal-header"><button type="button" class="close" data-dismiss="modal" aria-label="Close"><span aria-hidden="true">&times;</span></button><h4 class="modal-title" id="-graph-help-label">Graph Key</h4></div><div class="modal-body">
    <p>Nodes of different colours represent the following: </p>
    <?xml version="1.0" encoding="UTF-8" standalone="no"?>
<!DOCTYPE svg PUBLIC "-//W3C//DTD SVG 1.1//EN"
 "http://www.w3.org/Graphics/SVG/1.1/DTD/svg11.dtd">
<!-- Generated by graphviz version 2.40.1 (20161225.0304)
 -->
<!-- Title: Graph Key Pages: 1 -->
<svg width="190pt" height="32pt"
 viewBox="0.00 0.00 190.00 32.00" xmlns="http://www.w3.org/2000/svg" xmlns:xlink="http://www.w3.org/1999/xlink">
<g id="graph0" class="graph" transform="scale(1 1) rotate(0) translate(4 28)">
<title>Graph Key</title>
<polygon fill="#ffffff" stroke="transparent" points="-4,4 -4,-28 186,-28 186,4 -4,4"/>
<!-- Source File -->
<g id="node1" class="node">
<title>Source File</title>
<polygon fill="#f0ad4e" stroke="#f0ad4e" points="67,-24 0,-24 0,0 67,0 67,-24"/>
<text text-anchor="middle" x="33.5" y="-9.6" font-family="Helvetica,sans-Serif" font-size="10.50" fill="#ffffff">Source File</text>
</g>
<!-- This Page&#39;s Entity -->
<g id="node2" class="node">
<title>This Page&#39;s Entity</title>
<polygon fill="none" stroke="#000000" points="182,-24 85,-24 85,0 182,0 182,-24"/>
<text text-anchor="middle" x="133.5" y="-9.6" font-family="Helvetica,sans-Serif" font-size="10.50" fill="#000000">This Page&#39;s Entity</text>
</g>
</g>
</svg>

    
    <p>Solid arrows point from a file to a file which it depends on. A file
    is dependent upon another if the latter must be compiled before the former
    can be. Where possible, edges connecting nodes are given different colours to make them easier to distinguish in large graphs.
    </p>
    </div></div></div></div>
      </div>
    </div>
    
      
    <div class="panel panel-default">
      <div class="panel-heading">
  <h3 class="panel-title">Files dependent on this one</h3>
      </div>
      <div class="panel-body">
  <div class="depgraph"><?xml version="1.0" encoding="UTF-8" standalone="no"?>
<!DOCTYPE svg PUBLIC "-//W3C//DTD SVG 1.1//EN"
 "http://www.w3.org/Graphics/SVG/1.1/DTD/svg11.dtd">
<!-- Generated by graphviz version 2.40.1 (20161225.0304)
 -->
<!-- Title: sourcefile~~modthermodynamics.f90~~AfferentGraph Pages: 1 -->
<svg id="sourcefilemodthermodynamicsf90AfferentGraph" width="366pt" height="52pt"
 viewBox="0.00 0.00 366.00 52.00" xmlns="http://www.w3.org/2000/svg" xmlns:xlink="http://www.w3.org/1999/xlink">
<g id="sourcefile~~modthermodynamics.f90~~AfferentGraph" class="graph" transform="scale(1 1) rotate(0) translate(4 48)">
<title>sourcefile~~modthermodynamics.f90~~AfferentGraph</title>
<polygon fill="#ffffff" stroke="transparent" points="-4,4 -4,-48 362,-48 362,4 -4,4"/>
<!-- sourcefile~modthermodynamics.f90 -->
<g id="sourcefile~~modthermodynamics.f90~~AfferentGraph_node1" class="node">
<title>sourcefile~modthermodynamics.f90</title>
<polygon fill="none" stroke="#000000" points="130,-44 0,-44 0,-20 130,-20 130,-44"/>
<text text-anchor="middle" x="65" y="-29.6" font-family="Helvetica,sans-Serif" font-size="10.50" fill="#000000">modthermodynamics.f90</text>
</g>
<!-- sourcefile~modstartup.f90 -->
<g id="sourcefile~~modthermodynamics.f90~~AfferentGraph_node2" class="node">
<title>sourcefile~modstartup.f90</title>
<g id="a_sourcefile~~modthermodynamics.f90~~AfferentGraph_node2"><a xlink:href=".././sourcefile/modstartup.f90.html" xlink:title="modstartup.f90">
<polygon fill="#f0ad4e" stroke="#f0ad4e" points="251,-24 166,-24 166,0 251,0 251,-24"/>
<text text-anchor="middle" x="208.5" y="-9.6" font-family="Helvetica,sans-Serif" font-size="10.50" fill="#ffffff">modstartup.f90</text>
</a>
</g>
</g>
<!-- sourcefile~modstartup.f90&#45;&gt;sourcefile~modthermodynamics.f90 -->
<g id="sourcefile~~modthermodynamics.f90~~AfferentGraph_edge1" class="edge">
<title>sourcefile~modstartup.f90&#45;&gt;sourcefile~modthermodynamics.f90</title>
<path fill="none" stroke="#ff0000" stroke-dasharray="5,2" d="M165.8338,-17.9465C157.6702,-19.0843 148.902,-20.3063 140.0665,-21.5378"/>
<polygon fill="#ff0000" stroke="#ff0000" points="139.5122,-18.0811 130.0911,-22.9281 140.4785,-25.0141 139.5122,-18.0811"/>
</g>
<!-- sourcefile~program.f90 -->
<g id="sourcefile~~modthermodynamics.f90~~AfferentGraph_node3" class="node">
<title>sourcefile~program.f90</title>
<g id="a_sourcefile~~modthermodynamics.f90~~AfferentGraph_node3"><a xlink:href=".././sourcefile/program.f90.html" xlink:title="program.f90">
<polygon fill="#f0ad4e" stroke="#f0ad4e" points="358,-44 287,-44 287,-20 358,-20 358,-44"/>
<text text-anchor="middle" x="322.5" y="-29.6" font-family="Helvetica,sans-Serif" font-size="10.50" fill="#ffffff">program.f90</text>
</a>
</g>
</g>
<!-- sourcefile~program.f90&#45;&gt;sourcefile~modthermodynamics.f90 -->
<g id="sourcefile~~modthermodynamics.f90~~AfferentGraph_edge2" class="edge">
<title>sourcefile~program.f90&#45;&gt;sourcefile~modthermodynamics.f90</title>
<path fill="none" stroke="#ff0000" stroke-dasharray="5,2" d="M286.8598,-32.5965C275.409,-32.7619 262.6693,-32.9184 251,-33 213.2231,-33.2642 203.7773,-33.187 166,-33 157.6817,-32.9588 148.9781,-32.8986 140.3177,-32.8277"/>
<polygon fill="#ff0000" stroke="#ff0000" points="140.2266,-29.3269 130.1966,-32.7402 140.166,-36.3266 140.2266,-29.3269"/>
</g>
<!-- sourcefile~program.f90&#45;&gt;sourcefile~modstartup.f90 -->
<g id="sourcefile~~modthermodynamics.f90~~AfferentGraph_edge3" class="edge">
<title>sourcefile~program.f90&#45;&gt;sourcefile~modstartup.f90</title>
<path fill="none" stroke="#ff0000" stroke-dasharray="5,2" d="M286.7425,-25.7267C278.67,-24.3105 269.9343,-22.7779 261.3262,-21.2677"/>
<polygon fill="#ff0000" stroke="#ff0000" points="261.7814,-17.7942 251.327,-19.5135 260.5717,-24.6889 261.7814,-17.7942"/>
</g>
</g>
</svg>
</div><div><a type="button" class="graph-help" data-toggle="modal" href="#graph-help-text">Help</a></div><div class="modal fade" id="graph-help-text" tabindex="-1" role="dialog"><div class="modal-dialog modal-lg" role="document"><div class="modal-content"><div class="modal-header"><button type="button" class="close" data-dismiss="modal" aria-label="Close"><span aria-hidden="true">&times;</span></button><h4 class="modal-title" id="-graph-help-label">Graph Key</h4></div><div class="modal-body">
    <p>Nodes of different colours represent the following: </p>
    <?xml version="1.0" encoding="UTF-8" standalone="no"?>
<!DOCTYPE svg PUBLIC "-//W3C//DTD SVG 1.1//EN"
 "http://www.w3.org/Graphics/SVG/1.1/DTD/svg11.dtd">
<!-- Generated by graphviz version 2.40.1 (20161225.0304)
 -->
<!-- Title: Graph Key Pages: 1 -->
<svg width="190pt" height="32pt"
 viewBox="0.00 0.00 190.00 32.00" xmlns="http://www.w3.org/2000/svg" xmlns:xlink="http://www.w3.org/1999/xlink">
<g id="graph0" class="graph" transform="scale(1 1) rotate(0) translate(4 28)">
<title>Graph Key</title>
<polygon fill="#ffffff" stroke="transparent" points="-4,4 -4,-28 186,-28 186,4 -4,4"/>
<!-- Source File -->
<g id="node1" class="node">
<title>Source File</title>
<polygon fill="#f0ad4e" stroke="#f0ad4e" points="67,-24 0,-24 0,0 67,0 67,-24"/>
<text text-anchor="middle" x="33.5" y="-9.6" font-family="Helvetica,sans-Serif" font-size="10.50" fill="#ffffff">Source File</text>
</g>
<!-- This Page&#39;s Entity -->
<g id="node2" class="node">
<title>This Page&#39;s Entity</title>
<polygon fill="none" stroke="#000000" points="182,-24 85,-24 85,0 182,0 182,-24"/>
<text text-anchor="middle" x="133.5" y="-9.6" font-family="Helvetica,sans-Serif" font-size="10.50" fill="#000000">This Page&#39;s Entity</text>
</g>
</g>
</svg>

    
    <p>Solid arrows point from a file to a file which it depends on. A file
    is dependent upon another if the latter must be compiled before the former
    can be. Where possible, edges connecting nodes are given different colours to make them easier to distinguish in large graphs.
    </p>
    </div></div></div></div>
      </div>
    </div>
      
      <br>

    <section class="visible-xs visible-sm hidden-md">
      
<h3>Contents</h3>
 







<div class="panel panel-primary">
  <div class="panel-heading text-left"><h3 class="panel-title"><a data-toggle="collapse" href="#mods-1">Modules</a></h3></div>
  <div id="mods-1" class="panel-collapse collapse">
    <div class="list-group">
      
      <a class="list-group-item" href="../module/modthermodynamics.html">modthermodynamics</a>
      
    </div>
  </div>
</div>
















<div class="panel panel-primary">
  <div class="panel-heading text-left"><h3 class="panel-title">Source Code</h3></div>
  <div class="list-group">
    <a class="list-group-item" href="../sourcefile/modthermodynamics.f90.html#src">modthermodynamics.f90</a>
  </div>
</div>



    </section>
    <br class="visible-xs visible-sm hidden-md">

    <section>
      <h2><span class="anchor" id="src"></span>Source Code</h2>
    <div class="hl"><pre><span></span><a name="ln-1"></a><span class="c">!&gt;\file modthermodynamics.f90</span>
<a name="ln-2"></a><span class="c">!! Do the thermodynamics</span>
<a name="ln-3"></a>
<a name="ln-4"></a><span class="c">!&gt;</span>
<a name="ln-5"></a><span class="c">!! Do the thermodynamics</span>
<a name="ln-6"></a><span class="c">!&gt;</span>
<a name="ln-7"></a><span class="c">!! Timeseries of the most relevant parameters. Written to tmser1.expnr and tmsurf.expnr</span>
<a name="ln-8"></a><span class="c">!! If netcdf is true, this module leads the tmser.expnr.nc output</span>
<a name="ln-9"></a><span class="c">!!  \author Pier Siebesma, K.N.M.I.</span>
<a name="ln-10"></a><span class="c">!!  \author Stephan de Roode,TU Delft</span>
<a name="ln-11"></a><span class="c">!!  \author Thijs Heus,MPI-M</span>
<a name="ln-12"></a><span class="c">!!  \par Revision list</span>
<a name="ln-13"></a><span class="c">!  This file is part of DALES.</span>
<a name="ln-14"></a><span class="c">!</span>
<a name="ln-15"></a><span class="c">! DALES is free software; you can redistribute it and/or modify</span>
<a name="ln-16"></a><span class="c">! it under the terms of the GNU General Public License as published by</span>
<a name="ln-17"></a><span class="c">! the Free Software Foundation; either version 3 of the License, or</span>
<a name="ln-18"></a><span class="c">! (at your option) any later version.</span>
<a name="ln-19"></a><span class="c">!</span>
<a name="ln-20"></a><span class="c">! DALES is distributed in the hope that it will be useful,</span>
<a name="ln-21"></a><span class="c">! but WITHOUT ANY WARRANTY; without even the implied warranty of</span>
<a name="ln-22"></a><span class="c">! MERCHANTABILITY or FITNESS FOR A PARTICULAR PURPOSE.  See the</span>
<a name="ln-23"></a><span class="c">! GNU General Public License for more details.</span>
<a name="ln-24"></a><span class="c">!</span>
<a name="ln-25"></a><span class="c">! You should have received a copy of the GNU General Public License</span>
<a name="ln-26"></a><span class="c">! along with this program.  If not, see &lt;http://www.gnu.org/licenses/&gt;.</span>
<a name="ln-27"></a><span class="c">!</span>
<a name="ln-28"></a><span class="c">!  Copyright 1993-2009 Delft University of Technology, Wageningen University, Utrecht University, KNMI</span>
<a name="ln-29"></a><span class="c">!</span>
<a name="ln-30"></a>
<a name="ln-31"></a><span class="k">module </span><span class="n">modthermodynamics</span>
<a name="ln-32"></a>
<a name="ln-33"></a>  <span class="k">implicit none</span>
<a name="ln-34"></a>  <span class="c">!   private</span>
<a name="ln-35"></a>  <span class="k">public</span> <span class="kd">::</span> <span class="n">thermodynamics</span><span class="p">,</span><span class="n">calc_halflev</span>
<a name="ln-36"></a>  <span class="k">public</span> <span class="kd">::</span> <span class="n">lqlnr</span>
<a name="ln-37"></a>  <span class="kt">logical</span> <span class="kd">::</span> <span class="n">lqlnr</span>    <span class="o">=</span> <span class="p">.</span><span class="n">false</span><span class="p">.</span> <span class="c">!&lt; switch for ql calc. with Newton-Raphson (on/off)</span>
<a name="ln-38"></a>  <span class="kt">real</span><span class="p">,</span> <span class="k">allocatable</span> <span class="kd">::</span> <span class="n">th0av</span><span class="p">(:)</span>
<a name="ln-39"></a>  <span class="kt">real</span> <span class="kd">::</span> <span class="n">chi_half</span><span class="o">=</span><span class="mf">0.5</span>  <span class="c">!&lt; set wet, dry or intermediate (default) mixing over the cloud edge</span>
<a name="ln-40"></a>  <span class="kt">real</span><span class="p">,</span> <span class="k">allocatable</span> <span class="kd">::</span> <span class="n">thv0</span><span class="p">(:,:,:)</span>
<a name="ln-41"></a><span class="k">contains</span>
<a name="ln-42"></a>
<a name="ln-43"></a>  <span class="c">!&gt; Allocate and initialize arrays</span>
<a name="ln-44"></a>  <span class="k">subroutine </span><span class="n">initthermodynamics</span>
<a name="ln-45"></a>    <span class="k">use </span><span class="n">modglobal</span><span class="p">,</span> <span class="n">only</span> <span class="p">:</span> <span class="n">kb</span><span class="p">,</span><span class="n">ke</span><span class="p">,</span><span class="n">kh</span><span class="p">,</span><span class="n">ib</span><span class="p">,</span><span class="n">ie</span><span class="p">,</span><span class="n">jb</span><span class="p">,</span><span class="n">je</span>
<a name="ln-46"></a>
<a name="ln-47"></a>    <span class="k">implicit none</span>
<a name="ln-48"></a>
<a name="ln-49"></a><span class="k">    allocate</span><span class="p">(</span><span class="n">th0av</span><span class="p">(</span><span class="n">kb</span><span class="p">:</span><span class="n">ke</span><span class="o">+</span><span class="n">kh</span><span class="p">))</span>
<a name="ln-50"></a>    <span class="k">allocate</span><span class="p">(</span><span class="n">thv0</span><span class="p">(</span><span class="n">ib</span><span class="p">:</span><span class="n">ie</span><span class="p">,</span><span class="n">jb</span><span class="p">:</span><span class="n">je</span><span class="p">,</span><span class="n">kb</span><span class="p">:</span><span class="n">ke</span><span class="o">+</span><span class="n">kh</span><span class="p">))</span>
<a name="ln-51"></a>    <span class="n">th0av</span> <span class="o">=</span> <span class="mf">0.</span>
<a name="ln-52"></a>
<a name="ln-53"></a>  <span class="k">end subroutine </span><span class="n">initthermodynamics</span>
<a name="ln-54"></a>
<a name="ln-55"></a>  <span class="c">!&gt; Do moist thermodynamics.</span>
<a name="ln-56"></a>  <span class="c">!! Calculate the liquid water content, do the microphysics, calculate the mean hydrostatic pressure, calculate the fields at the half levels, and finally calculate the virtual potential temperature.</span>
<a name="ln-57"></a>  <span class="k">subroutine </span><span class="n">thermodynamics</span>
<a name="ln-58"></a>    <span class="k">use </span><span class="n">modglobal</span><span class="p">,</span> <span class="n">only</span> <span class="p">:</span> <span class="n">lmoist</span><span class="p">,</span> <span class="n">timee</span><span class="p">,</span> <span class="n">kb</span><span class="p">,</span> <span class="n">ke</span><span class="p">,</span> <span class="n">kh</span><span class="p">,</span> <span class="n">ib</span><span class="p">,</span> <span class="n">ih</span><span class="p">,</span> <span class="n">ie</span><span class="p">,</span> <span class="n">jb</span><span class="p">,</span> <span class="n">jh</span><span class="p">,</span> <span class="n">je</span><span class="p">,</span><span class="n">rlv</span><span class="p">,</span> <span class="n">cp</span><span class="p">,</span> <span class="n">rslabs</span><span class="p">,</span> <span class="n">rd</span><span class="p">,</span> <span class="n">rv</span><span class="p">,</span> <span class="n">libm</span><span class="p">,</span> <span class="n">eps1</span>
<a name="ln-59"></a>    <span class="k">use </span><span class="n">modfields</span><span class="p">,</span> <span class="n">only</span> <span class="p">:</span> <span class="n">thl0</span><span class="p">,</span><span class="n">thl0h</span><span class="p">,</span><span class="n">qt0</span><span class="p">,</span><span class="n">qt0h</span><span class="p">,</span><span class="n">ql0</span><span class="p">,</span><span class="n">ql0h</span><span class="p">,</span><span class="n">presf</span><span class="p">,</span><span class="n">presh</span><span class="p">,</span><span class="n">exnf</span><span class="p">,</span><span class="n">exnh</span><span class="p">,</span><span class="n">thvh</span><span class="p">,</span><span class="n">thv0h</span><span class="p">,</span><span class="n">qt0av</span><span class="p">,</span><span class="n">ql0av</span><span class="p">,</span><span class="n">thvf</span><span class="p">,</span><span class="n">rhof</span><span class="p">,</span><span class="n">IIc</span><span class="p">,</span><span class="n">IIw</span><span class="p">,</span><span class="n">IIcs</span><span class="p">,</span><span class="n">IIws</span>
<a name="ln-60"></a>    <span class="k">use </span><span class="n">modmpi</span><span class="p">,</span>    <span class="n">only</span> <span class="p">:</span> <span class="n">slabsum</span><span class="p">,</span><span class="n">avexy_ibm</span><span class="p">,</span><span class="n">myid</span>
<a name="ln-61"></a><span class="c">!ILS13 added variables behind &quot;exnh&quot;</span>
<a name="ln-62"></a>    <span class="k">implicit none</span>
<a name="ln-63"></a><span class="k">    </span><span class="kt">integer</span> <span class="kd">::</span> <span class="n">k</span>
<a name="ln-64"></a>    <span class="k">if</span> <span class="p">(</span><span class="n">timee</span><span class="o">==</span><span class="mi">0</span><span class="p">)</span> <span class="k">call </span><span class="n">diagfld</span>
<a name="ln-65"></a>    <span class="k">if</span> <span class="p">(</span><span class="n">lmoist</span><span class="p">)</span> <span class="k">then</span>
<a name="ln-66"></a><span class="k">       call </span><span class="n">thermo</span><span class="p">(</span><span class="n">thl0</span><span class="p">,</span><span class="n">qt0</span><span class="p">,</span><span class="n">ql0</span><span class="p">,</span><span class="n">presf</span><span class="p">,</span><span class="n">exnf</span><span class="p">)</span>
<a name="ln-67"></a>    <span class="k">end if</span>
<a name="ln-68"></a>
<a name="ln-69"></a><span class="k">    call </span><span class="n">diagfld</span>
<a name="ln-70"></a>    <span class="k">call </span><span class="n">calc_halflev</span> <span class="c">!calculate halflevel values of qt0 and thl0</span>
<a name="ln-71"></a>    <span class="k">if</span> <span class="p">(</span><span class="n">lmoist</span><span class="p">)</span> <span class="k">then</span>
<a name="ln-72"></a><span class="k">       call </span><span class="n">thermo</span><span class="p">(</span><span class="n">thl0h</span><span class="p">,</span><span class="n">qt0h</span><span class="p">,</span><span class="n">ql0h</span><span class="p">,</span><span class="n">presh</span><span class="p">,</span><span class="n">exnh</span><span class="p">)</span>
<a name="ln-73"></a>    <span class="k">end if</span>
<a name="ln-74"></a><span class="k">    call </span><span class="n">calthv</span>
<a name="ln-75"></a>
<a name="ln-76"></a><span class="c">!ILS13 introduced from DALES4.0   13.05.2015</span>
<a name="ln-77"></a>    <span class="n">thvh</span><span class="o">=</span><span class="mf">0.</span>
<a name="ln-78"></a><span class="c">!    call slabsum(thvh,kb,ke+kh,thv0h(:,:,kb:ke+kh),ib-ih,ie+ih,jb-jh,je+jh,kb,ke+kh,ib,ie,jb,je,kb,ke+kh) !redefine halflevel thv using calculated thv</span>
<a name="ln-79"></a><span class="c">!    thvh = thvh/rslabs</span>
<a name="ln-80"></a>    <span class="k">call </span><span class="n">avexy_ibm</span><span class="p">(</span><span class="n">thvh</span><span class="p">(</span><span class="n">kb</span><span class="p">:</span><span class="n">ke</span><span class="o">+</span><span class="n">kh</span><span class="p">),</span><span class="n">thv0h</span><span class="p">(</span><span class="n">ib</span><span class="p">:</span><span class="n">ie</span><span class="p">,</span><span class="n">jb</span><span class="p">:</span><span class="n">je</span><span class="p">,</span><span class="n">kb</span><span class="p">:</span><span class="n">ke</span><span class="o">+</span><span class="n">kh</span><span class="p">),</span><span class="n">ib</span><span class="p">,</span><span class="n">ie</span><span class="p">,</span><span class="n">jb</span><span class="p">,</span><span class="n">je</span><span class="p">,</span><span class="n">kb</span><span class="p">,</span><span class="n">ke</span><span class="p">,</span><span class="n">ih</span><span class="p">,</span><span class="n">jh</span><span class="p">,</span><span class="n">kh</span><span class="p">,</span><span class="n">IIw</span><span class="p">(</span><span class="n">ib</span><span class="p">:</span><span class="n">ie</span><span class="p">,</span><span class="n">jb</span><span class="p">:</span><span class="n">je</span><span class="p">,</span><span class="n">kb</span><span class="p">:</span><span class="n">ke</span><span class="o">+</span><span class="n">kh</span><span class="p">),</span><span class="n">IIws</span><span class="p">(</span><span class="n">kb</span><span class="p">:</span><span class="n">ke</span><span class="o">+</span><span class="n">kh</span><span class="p">),.</span><span class="n">false</span><span class="p">.)</span>
<a name="ln-81"></a>
<a name="ln-82"></a><span class="c">!    if (libm) then</span>
<a name="ln-83"></a><span class="c">!      call avexy_ibm(thvh(kb:ke),thv0h(ib:ie,jb:je,kb:ke),ib,ie,jb,je,kb,ke,IIw(ib:ie,jb:je,kb:ke),IIws(kb:ke))    </span>
<a name="ln-84"></a><span class="c">!    else</span>
<a name="ln-85"></a><span class="c">!      call slabsum(thvh,kb,ke+kh,thv0h(:,:,kb:ke+kh),ib-ih,ie+ih,jb-jh,je+jh,kb,ke+kh,ib,ie,jb,je,kb,ke+kh)</span>
<a name="ln-86"></a><span class="c">!     !redefine halflevel thv using calculated thv</span>
<a name="ln-87"></a><span class="c">!     thvh = thvh/rslabs</span>
<a name="ln-88"></a><span class="c">!    end if</span>
<a name="ln-89"></a>
<a name="ln-90"></a>    <span class="n">thvh</span><span class="p">(</span><span class="n">kb</span><span class="p">)</span> <span class="o">=</span> <span class="n">th0av</span><span class="p">(</span><span class="n">kb</span><span class="p">)</span><span class="o">*</span><span class="p">(</span><span class="mi">1</span><span class="o">+</span><span class="p">(</span><span class="n">rv</span><span class="o">/</span><span class="n">rd</span><span class="o">-</span><span class="mi">1</span><span class="p">)</span><span class="o">*</span><span class="n">qt0av</span><span class="p">(</span><span class="n">kb</span><span class="p">)</span><span class="o">-</span><span class="n">rv</span><span class="o">/</span><span class="n">rd</span><span class="o">*</span><span class="n">ql0av</span><span class="p">(</span><span class="n">kb</span><span class="p">))</span> <span class="c">! override first level</span>
<a name="ln-91"></a>    <span class="k">if</span> <span class="p">(</span><span class="nb">abs</span><span class="p">(</span><span class="n">thvh</span><span class="p">(</span><span class="n">kb</span><span class="o">+</span><span class="mi">1</span><span class="p">))</span><span class="o">&lt;</span><span class="n">eps1</span><span class="p">)</span> <span class="k">then</span>
<a name="ln-92"></a><span class="k">      </span><span class="n">thvh</span><span class="p">(</span><span class="n">kb</span><span class="o">+</span><span class="mi">1</span><span class="p">)</span> <span class="o">=</span> <span class="n">th0av</span><span class="p">(</span><span class="n">kb</span><span class="o">+</span><span class="mi">1</span><span class="p">)</span><span class="o">*</span><span class="p">(</span><span class="mi">1</span><span class="o">+</span><span class="p">(</span><span class="n">rv</span><span class="o">/</span><span class="n">rd</span><span class="o">-</span><span class="mi">1</span><span class="p">)</span><span class="o">*</span><span class="n">qt0av</span><span class="p">(</span><span class="n">kb</span><span class="o">+</span><span class="mi">1</span><span class="p">)</span><span class="o">-</span><span class="n">rv</span><span class="o">/</span><span class="n">rd</span><span class="o">*</span><span class="n">ql0av</span><span class="p">(</span><span class="n">kb</span><span class="o">+</span><span class="mi">1</span><span class="p">))</span> <span class="c">! override second level if all blocks at kb</span>
<a name="ln-93"></a>    <span class="k">end if</span>
<a name="ln-94"></a><span class="c">!    where (thvh==0) !override slabs completely covered by blocks</span>
<a name="ln-95"></a><span class="c">!      thvh = th0av(kb)*(1+(rv/rd-1)*qt0av(kb)-rv/rd*ql0av(kb))</span>
<a name="ln-96"></a><span class="c">!    endwhere</span>
<a name="ln-97"></a>
<a name="ln-98"></a>    <span class="k">do </span><span class="n">k</span><span class="o">=</span><span class="n">kb</span><span class="p">,</span><span class="n">ke</span><span class="o">+</span><span class="n">kh</span>
<a name="ln-99"></a><span class="c">!    thv0(ib+ih:ie,jb+jh:je,k) = (thl0(ib+ih:ie,jb+ih:je,k)+rlv*ql0(ib+ih:ie,jb+ih:je,k)/(cp*exnf(k)))*(1+(rv/rd-1)*qt0(ib+ih:ie,jb+ih:je,k)-rv/rd*ql0(ib+ih:ie,jb+ih:je,k))</span>
<a name="ln-100"></a>    <span class="n">thv0</span><span class="p">(</span><span class="n">ib</span><span class="p">:</span><span class="n">ie</span><span class="p">,</span><span class="n">jb</span><span class="p">:</span><span class="n">je</span><span class="p">,</span><span class="n">k</span><span class="p">)</span> <span class="o">=</span> <span class="p">(</span><span class="n">thl0</span><span class="p">(</span><span class="n">ib</span><span class="p">:</span><span class="n">ie</span><span class="p">,</span><span class="n">jb</span><span class="p">:</span><span class="n">je</span><span class="p">,</span><span class="n">k</span><span class="p">)</span><span class="o">+</span><span class="n">rlv</span><span class="o">*</span><span class="n">ql0</span><span class="p">(</span><span class="n">ib</span><span class="p">:</span><span class="n">ie</span><span class="p">,</span><span class="n">jb</span><span class="p">:</span><span class="n">je</span><span class="p">,</span><span class="n">k</span><span class="p">)</span><span class="o">/</span><span class="p">(</span><span class="n">cp</span><span class="o">*</span><span class="n">exnf</span><span class="p">(</span><span class="n">k</span><span class="p">)))</span><span class="o">*</span><span class="p">(</span><span class="mi">1</span><span class="o">+</span><span class="p">(</span><span class="n">rv</span><span class="o">/</span><span class="n">rd</span><span class="o">-</span><span class="mi">1</span><span class="p">)</span><span class="o">*</span><span class="n">qt0</span><span class="p">(</span><span class="n">ib</span><span class="p">:</span><span class="n">ie</span><span class="p">,</span><span class="n">jb</span><span class="p">:</span><span class="n">je</span><span class="p">,</span><span class="n">k</span><span class="p">)</span><span class="o">-</span><span class="n">rv</span><span class="o">/</span><span class="n">rd</span><span class="o">*</span><span class="n">ql0</span><span class="p">(</span><span class="n">ib</span><span class="p">:</span><span class="n">ie</span><span class="p">,</span><span class="n">jb</span><span class="p">:</span><span class="n">je</span><span class="p">,</span><span class="n">k</span><span class="p">))</span>
<a name="ln-101"></a>    <span class="n">enddo</span>
<a name="ln-102"></a>    <span class="n">thvf</span> <span class="o">=</span> <span class="mf">0.0</span>
<a name="ln-103"></a>
<a name="ln-104"></a>    <span class="c">!write(*,*) &quot;thv0&quot;,thv0</span>
<a name="ln-105"></a><span class="c">!    call slabsum(thvf,kb,ke+kh,thv0,ib,ie+ih,jb,je+jh,kb,ke+kh,ib+ih,ie,jb+ih,je,kb,ke+kh)</span>
<a name="ln-106"></a><span class="c">!    call slabsum(thvf,kb,ke+kh,thv0,ib,ie,jb,je,kb,ke+kh,ib,ie,jb,je,kb,ke+kh)</span>
<a name="ln-107"></a>    <span class="k">call </span><span class="n">avexy_ibm</span><span class="p">(</span><span class="n">thvf</span><span class="p">(</span><span class="n">kb</span><span class="p">:</span><span class="n">ke</span><span class="o">+</span><span class="n">kh</span><span class="p">),</span><span class="n">thv0</span><span class="p">(</span><span class="n">ib</span><span class="p">:</span><span class="n">ie</span><span class="p">,</span><span class="n">jb</span><span class="p">:</span><span class="n">je</span><span class="p">,</span><span class="n">kb</span><span class="p">:</span><span class="n">ke</span><span class="o">+</span><span class="n">kh</span><span class="p">),</span><span class="n">ib</span><span class="p">,</span><span class="n">ie</span><span class="p">,</span><span class="n">jb</span><span class="p">,</span><span class="n">je</span><span class="p">,</span><span class="n">kb</span><span class="p">,</span><span class="n">ke</span><span class="p">,</span><span class="n">ih</span><span class="p">,</span><span class="n">jh</span><span class="p">,</span><span class="n">kh</span><span class="p">,</span><span class="n">IIc</span><span class="p">(</span><span class="n">ib</span><span class="p">:</span><span class="n">ie</span><span class="p">,</span><span class="n">jb</span><span class="p">:</span><span class="n">je</span><span class="p">,</span><span class="n">kb</span><span class="p">:</span><span class="n">ke</span><span class="o">+</span><span class="n">kh</span><span class="p">),</span><span class="n">IIcs</span><span class="p">(</span><span class="n">kb</span><span class="p">:</span><span class="n">ke</span><span class="o">+</span><span class="n">kh</span><span class="p">),.</span><span class="n">false</span><span class="p">.)</span>
<a name="ln-108"></a><span class="c">!    write(*,*) &#39;IIc(2,2,:), myid&#39; , IIc(12,2,:), myid</span>
<a name="ln-109"></a>
<a name="ln-110"></a><span class="c">!    where (thvf==0) !override slabs completely covered by blocks</span>
<a name="ln-111"></a><span class="c">!      thvf = th0av(kb)*(1+(rv/rd-1)*qt0av(kb)-rv/rd*ql0av(kb))</span>
<a name="ln-112"></a><span class="c">!    endwhere</span>
<a name="ln-113"></a>
<a name="ln-114"></a><span class="c">!    thvf = thvf/rslabs</span>
<a name="ln-115"></a>    <span class="c">!write(*,*) &quot;thvf&quot;,thvf</span>
<a name="ln-116"></a>    <span class="c">!write(*,*) &quot;exnf&quot;,exnf</span>
<a name="ln-117"></a>   
<a name="ln-118"></a><span class="c">!    do k=1,k1</span>
<a name="ln-119"></a><span class="c">!      rhof(k) = presf(k)/(rd*thvf(k)*exnf(k))</span>
<a name="ln-120"></a><span class="c">!    end do</span>
<a name="ln-121"></a>
<a name="ln-122"></a>  <span class="k">end subroutine </span><span class="n">thermodynamics</span>
<a name="ln-123"></a>  <span class="c">!&gt; Cleans up after the run</span>
<a name="ln-124"></a>  <span class="k">subroutine </span><span class="n">exitthermodynamics</span>
<a name="ln-125"></a>    <span class="k">implicit none</span>
<a name="ln-126"></a><span class="k">    deallocate</span><span class="p">(</span><span class="n">th0av</span><span class="p">)</span>
<a name="ln-127"></a>  <span class="k">end subroutine </span><span class="n">exitthermodynamics</span>
<a name="ln-128"></a>
<a name="ln-129"></a>  <span class="c">!&gt; Calculate thetav and dthvdz</span>
<a name="ln-130"></a>  <span class="k">subroutine </span><span class="n">calthv</span>
<a name="ln-131"></a>    <span class="k">use </span><span class="n">modglobal</span><span class="p">,</span> <span class="n">only</span> <span class="p">:</span> <span class="n">lmoist</span><span class="p">,</span><span class="n">ib</span><span class="p">,</span><span class="n">ie</span><span class="p">,</span><span class="n">jb</span><span class="p">,</span><span class="n">je</span><span class="p">,</span><span class="n">kb</span><span class="p">,</span><span class="n">ke</span><span class="p">,</span><span class="n">kh</span><span class="p">,</span><span class="n">zf</span><span class="p">,</span><span class="n">zh</span><span class="p">,</span><span class="n">dzh</span><span class="p">,</span><span class="n">rlv</span><span class="p">,</span><span class="n">rd</span><span class="p">,</span><span class="n">rv</span><span class="p">,</span><span class="n">cp</span><span class="p">,</span><span class="n">eps1</span>
<a name="ln-132"></a>    <span class="k">use </span><span class="n">modfields</span><span class="p">,</span> <span class="n">only</span> <span class="p">:</span> <span class="n">thl0</span><span class="p">,</span><span class="n">thl0h</span><span class="p">,</span><span class="n">ql0</span><span class="p">,</span><span class="n">ql0h</span><span class="p">,</span><span class="n">qt0</span><span class="p">,</span><span class="n">qt0h</span><span class="p">,</span><span class="n">sv0</span><span class="p">,</span><span class="n">exnf</span><span class="p">,</span><span class="n">exnh</span><span class="p">,</span><span class="n">thv0h</span><span class="p">,</span><span class="n">dthvdz</span>
<a name="ln-133"></a>    <span class="k">use </span><span class="n">modsurfdata</span><span class="p">,</span><span class="n">only</span> <span class="p">:</span> <span class="n">dthldz</span><span class="p">,</span><span class="n">dqtdz</span>
<a name="ln-134"></a>
<a name="ln-135"></a>    <span class="k">implicit none</span>
<a name="ln-136"></a>
<a name="ln-137"></a><span class="k">    </span><span class="kt">integer </span><span class="n">i</span><span class="p">,</span> <span class="n">j</span><span class="p">,</span> <span class="n">k</span>
<a name="ln-138"></a>    <span class="kt">real    </span><span class="n">qs</span>
<a name="ln-139"></a>    <span class="kt">real    </span><span class="n">c1</span><span class="p">,</span><span class="n">c2</span><span class="p">,</span><span class="n">dq</span><span class="p">,</span><span class="n">dth</span><span class="p">,</span><span class="n">dthv</span><span class="p">,</span><span class="n">temp</span>
<a name="ln-140"></a>    <span class="kt">real    </span><span class="n">a_dry</span><span class="p">,</span> <span class="n">b_dry</span><span class="p">,</span> <span class="n">a_moist</span><span class="p">,</span> <span class="n">b_moist</span><span class="p">,</span> <span class="n">c_liquid</span><span class="p">,</span> <span class="nb">epsilon</span><span class="p">,</span> <span class="n">eps_I</span><span class="p">,</span> <span class="n">chi_sat</span><span class="p">,</span> <span class="n">chi</span>
<a name="ln-141"></a>    <span class="kt">real    </span><span class="n">del_thv_sat</span><span class="p">,</span> <span class="n">del_thv_dry</span>
<a name="ln-142"></a>    <span class="n">dthvdz</span> <span class="o">=</span> <span class="mf">0.0</span>
<a name="ln-143"></a>    <span class="k">if</span> <span class="p">(</span><span class="n">lmoist</span><span class="p">)</span> <span class="k">then</span>
<a name="ln-144"></a>
<a name="ln-145"></a><span class="k">       do  </span><span class="n">k</span><span class="o">=</span><span class="n">kb</span><span class="p">,</span><span class="n">ke</span><span class="o">+</span><span class="n">kh</span>
<a name="ln-146"></a>          <span class="k">do  </span><span class="n">j</span><span class="o">=</span><span class="n">jb</span><span class="p">,</span><span class="n">je</span>
<a name="ln-147"></a>             <span class="k">do  </span><span class="n">i</span><span class="o">=</span><span class="n">ib</span><span class="p">,</span><span class="n">ie</span>
<a name="ln-148"></a>                <span class="n">thv0h</span><span class="p">(</span><span class="n">i</span><span class="p">,</span><span class="n">j</span><span class="p">,</span><span class="n">k</span><span class="p">)</span> <span class="o">=</span> <span class="p">(</span><span class="n">thl0h</span><span class="p">(</span><span class="n">i</span><span class="p">,</span><span class="n">j</span><span class="p">,</span><span class="n">k</span><span class="p">)</span><span class="o">+</span><span class="n">rlv</span><span class="o">*</span><span class="n">ql0h</span><span class="p">(</span><span class="n">i</span><span class="p">,</span><span class="n">j</span><span class="p">,</span><span class="n">k</span><span class="p">)</span><span class="o">/</span><span class="p">(</span><span class="n">cp</span><span class="o">*</span><span class="n">exnh</span><span class="p">(</span><span class="n">k</span><span class="p">)))</span> <span class="p">&amp;</span>
<a name="ln-149"></a>                     <span class="o">*</span><span class="p">(</span><span class="mi">1</span><span class="o">+</span><span class="p">(</span><span class="n">rv</span><span class="o">/</span><span class="n">rd</span><span class="o">-</span><span class="mi">1</span><span class="p">)</span><span class="o">*</span><span class="n">qt0h</span><span class="p">(</span><span class="n">i</span><span class="p">,</span><span class="n">j</span><span class="p">,</span><span class="n">k</span><span class="p">)</span><span class="o">-</span><span class="n">rv</span><span class="o">/</span><span class="n">rd</span><span class="o">*</span><span class="n">ql0h</span><span class="p">(</span><span class="n">i</span><span class="p">,</span><span class="n">j</span><span class="p">,</span><span class="n">k</span><span class="p">))</span>
<a name="ln-150"></a>             <span class="k">end do</span>
<a name="ln-151"></a><span class="k">          end do</span>
<a name="ln-152"></a><span class="k">       end do</span>
<a name="ln-153"></a>
<a name="ln-154"></a><span class="k">       do </span><span class="n">k</span><span class="o">=</span><span class="n">kb</span><span class="o">+</span><span class="mi">1</span><span class="p">,</span><span class="n">ke</span>
<a name="ln-155"></a>          <span class="k">do </span><span class="n">j</span><span class="o">=</span><span class="n">jb</span><span class="p">,</span><span class="n">je</span>
<a name="ln-156"></a>             <span class="k">do </span><span class="n">i</span><span class="o">=</span><span class="n">ib</span><span class="p">,</span><span class="n">ie</span>
<a name="ln-157"></a>                <span class="c">!</span>
<a name="ln-158"></a>                <span class="c">!         default thv jump computed unsaturated</span>
<a name="ln-159"></a>                <span class="c">!</span>
<a name="ln-160"></a>                <span class="nb">epsilon</span> <span class="o">=</span> <span class="n">rd</span><span class="o">/</span><span class="n">rv</span>
<a name="ln-161"></a>                <span class="n">eps_I</span> <span class="o">=</span> <span class="mi">1</span><span class="o">/</span><span class="nb">epsilon</span> <span class="o">-</span> <span class="mf">1.</span>  <span class="c">!cstep approx 0.608</span>
<a name="ln-162"></a>
<a name="ln-163"></a>                <span class="n">a_dry</span> <span class="o">=</span> <span class="mf">1.</span> <span class="o">+</span> <span class="n">eps_I</span> <span class="o">*</span> <span class="n">qt0</span><span class="p">(</span><span class="n">i</span><span class="p">,</span><span class="n">j</span><span class="p">,</span><span class="n">k</span><span class="p">)</span>
<a name="ln-164"></a>                <span class="n">b_dry</span> <span class="o">=</span> <span class="n">eps_I</span> <span class="o">*</span> <span class="n">thl0</span><span class="p">(</span><span class="n">i</span><span class="p">,</span><span class="n">j</span><span class="p">,</span><span class="n">k</span><span class="p">)</span>
<a name="ln-165"></a>
<a name="ln-166"></a>                <span class="n">dth</span> <span class="o">=</span> <span class="n">thl0</span><span class="p">(</span><span class="n">i</span><span class="p">,</span><span class="n">j</span><span class="p">,</span><span class="n">k</span><span class="o">+</span><span class="mi">1</span><span class="p">)</span><span class="o">-</span><span class="n">thl0</span><span class="p">(</span><span class="n">i</span><span class="p">,</span><span class="n">j</span><span class="p">,</span><span class="n">k</span><span class="o">-</span><span class="mi">1</span><span class="p">)</span>
<a name="ln-167"></a>                <span class="n">dq</span>  <span class="o">=</span> <span class="n">qt0</span><span class="p">(</span><span class="n">i</span><span class="p">,</span><span class="n">j</span><span class="p">,</span><span class="n">k</span><span class="o">+</span><span class="mi">1</span><span class="p">)</span><span class="o">-</span><span class="n">qt0</span><span class="p">(</span><span class="n">i</span><span class="p">,</span><span class="n">j</span><span class="p">,</span><span class="n">k</span><span class="o">-</span><span class="mi">1</span><span class="p">)</span>
<a name="ln-168"></a>
<a name="ln-169"></a>                <span class="n">del_thv_dry</span> <span class="o">=</span> <span class="n">a_dry</span>   <span class="o">*</span> <span class="n">dth</span> <span class="o">+</span> <span class="n">b_dry</span> <span class="o">*</span> <span class="n">dq</span>
<a name="ln-170"></a>
<a name="ln-171"></a>                <span class="n">dthv</span> <span class="o">=</span> <span class="n">del_thv_dry</span>
<a name="ln-172"></a>
<a name="ln-173"></a>                <span class="k">if</span>  <span class="p">(</span><span class="n">ql0</span><span class="p">(</span><span class="n">i</span><span class="p">,</span><span class="n">j</span><span class="p">,</span><span class="n">k</span><span class="p">)</span><span class="o">&gt;</span> <span class="mi">0</span><span class="p">)</span> <span class="k">then</span>  <span class="c">!include moist thermodynamics</span>
<a name="ln-174"></a>                   <span class="n">temp</span> <span class="o">=</span> <span class="n">thl0</span><span class="p">(</span><span class="n">i</span><span class="p">,</span><span class="n">j</span><span class="p">,</span><span class="n">k</span><span class="p">)</span><span class="o">*</span><span class="n">exnf</span><span class="p">(</span><span class="n">k</span><span class="p">)</span><span class="o">+</span><span class="p">(</span><span class="n">rlv</span><span class="o">/</span><span class="n">cp</span><span class="p">)</span><span class="o">*</span><span class="n">ql0</span><span class="p">(</span><span class="n">i</span><span class="p">,</span><span class="n">j</span><span class="p">,</span><span class="n">k</span><span class="p">)</span>
<a name="ln-175"></a>                   <span class="n">qs</span>   <span class="o">=</span> <span class="n">qt0</span><span class="p">(</span><span class="n">i</span><span class="p">,</span><span class="n">j</span><span class="p">,</span><span class="n">k</span><span class="p">)</span> <span class="o">-</span> <span class="n">ql0</span><span class="p">(</span><span class="n">i</span><span class="p">,</span><span class="n">j</span><span class="p">,</span><span class="n">k</span><span class="p">)</span>
<a name="ln-176"></a>
<a name="ln-177"></a>                   <span class="n">a_moist</span> <span class="o">=</span> <span class="p">(</span><span class="mf">1.</span><span class="o">-</span><span class="n">qt0</span><span class="p">(</span><span class="n">i</span><span class="p">,</span><span class="n">j</span><span class="p">,</span><span class="n">k</span><span class="p">)</span><span class="o">+</span><span class="n">qs</span><span class="o">/</span><span class="nb">epsilon</span><span class="o">*</span><span class="p">(</span><span class="mf">1.</span><span class="o">+</span><span class="n">rlv</span><span class="o">/</span><span class="p">(</span><span class="n">rv</span><span class="o">*</span><span class="n">temp</span><span class="p">)))</span> <span class="p">&amp;</span>
<a name="ln-178"></a>                        <span class="o">/</span><span class="p">(</span><span class="mf">1.</span><span class="o">+</span><span class="n">rlv</span><span class="o">**</span><span class="mi">2</span><span class="o">*</span><span class="n">qs</span><span class="o">/</span><span class="p">(</span><span class="n">cp</span><span class="o">*</span><span class="n">rv</span><span class="o">*</span><span class="n">temp</span><span class="o">**</span><span class="mi">2</span><span class="p">))</span>
<a name="ln-179"></a>                   <span class="n">b_moist</span> <span class="o">=</span> <span class="n">a_moist</span><span class="o">*</span><span class="n">rlv</span><span class="o">/</span><span class="n">cp</span><span class="o">-</span><span class="n">temp</span>
<a name="ln-180"></a>                   <span class="n">c_liquid</span> <span class="o">=</span> <span class="n">a_dry</span> <span class="o">*</span> <span class="n">rlv</span> <span class="o">/</span> <span class="n">cp</span> <span class="o">-</span> <span class="n">thl0</span><span class="p">(</span><span class="n">i</span><span class="p">,</span><span class="n">j</span><span class="p">,</span><span class="n">k</span><span class="p">)</span> <span class="o">/</span> <span class="nb">epsilon</span>
<a name="ln-181"></a>
<a name="ln-182"></a><span class="nb">                   </span><span class="n">del_thv_sat</span> <span class="o">=</span> <span class="n">a_moist</span> <span class="o">*</span> <span class="n">dth</span> <span class="o">+</span> <span class="n">b_moist</span> <span class="o">*</span> <span class="n">dq</span>
<a name="ln-183"></a>
<a name="ln-184"></a>                   <span class="n">chi</span>     <span class="o">=</span> <span class="mi">2</span><span class="o">*</span><span class="n">chi_half</span><span class="o">*</span><span class="p">(</span><span class="n">zf</span><span class="p">(</span><span class="n">k</span><span class="p">)</span> <span class="o">-</span> <span class="n">zf</span><span class="p">(</span><span class="n">k</span><span class="o">-</span><span class="mi">1</span><span class="p">))</span><span class="o">/</span><span class="p">(</span><span class="n">dzh</span><span class="p">(</span><span class="n">k</span><span class="p">)</span><span class="o">+</span><span class="n">dzh</span><span class="p">(</span><span class="n">k</span><span class="o">+</span><span class="mi">1</span><span class="p">))</span>
<a name="ln-185"></a>                   <span class="n">chi_sat</span> <span class="o">=</span> <span class="n">c_liquid</span> <span class="o">*</span> <span class="n">ql0</span><span class="p">(</span><span class="n">i</span><span class="p">,</span><span class="n">j</span><span class="p">,</span><span class="n">k</span><span class="p">)</span> <span class="o">/</span> <span class="p">(</span><span class="n">del_thv_dry</span> <span class="o">-</span> <span class="n">del_thv_sat</span><span class="p">)</span>
<a name="ln-186"></a>
<a name="ln-187"></a>                   <span class="k">if</span> <span class="p">(</span><span class="n">chi</span> <span class="o">&lt;</span> <span class="n">chi_sat</span><span class="p">)</span> <span class="k">then</span>  <span class="c">!mixed parcel is saturated</span>
<a name="ln-188"></a>                      <span class="n">dthv</span> <span class="o">=</span> <span class="n">del_thv_sat</span>
<a name="ln-189"></a>                   <span class="k">end if</span>
<a name="ln-190"></a><span class="k">                end if</span>
<a name="ln-191"></a>
<a name="ln-192"></a><span class="k">                </span><span class="n">dthvdz</span><span class="p">(</span><span class="n">i</span><span class="p">,</span><span class="n">j</span><span class="p">,</span><span class="n">k</span><span class="p">)</span> <span class="o">=</span> <span class="n">dthv</span><span class="o">/</span><span class="p">(</span><span class="n">dzh</span><span class="p">(</span><span class="n">k</span><span class="o">+</span><span class="mi">1</span><span class="p">)</span><span class="o">+</span><span class="n">dzh</span><span class="p">(</span><span class="n">k</span><span class="p">))</span>
<a name="ln-193"></a>             <span class="k">end do</span>
<a name="ln-194"></a><span class="k">          end do</span>
<a name="ln-195"></a><span class="k">       end do</span>
<a name="ln-196"></a>
<a name="ln-197"></a><span class="k">       do </span><span class="n">j</span><span class="o">=</span><span class="n">jb</span><span class="p">,</span><span class="n">je</span>
<a name="ln-198"></a>          <span class="k">do </span><span class="n">i</span><span class="o">=</span><span class="n">ib</span><span class="p">,</span><span class="n">ie</span>
<a name="ln-199"></a>            <span class="n">dthvdz</span><span class="p">(</span><span class="n">i</span><span class="p">,</span><span class="n">j</span><span class="p">,</span><span class="n">kb</span><span class="p">)</span><span class="o">=</span><span class="mf">0.</span>
<a name="ln-200"></a>          <span class="k">end do</span>
<a name="ln-201"></a><span class="k">       end do</span>
<a name="ln-202"></a>
<a name="ln-203"></a><span class="k">    else</span>
<a name="ln-204"></a>       <span class="c">!      thv0h = thl0h</span>
<a name="ln-205"></a>       <span class="n">thv0h</span> <span class="o">=</span> <span class="n">thl0h</span><span class="p">(:,:,</span><span class="n">kb</span><span class="p">:</span><span class="n">ke</span><span class="o">+</span><span class="n">kh</span><span class="p">)</span>
<a name="ln-206"></a>       <span class="k">do </span><span class="n">k</span><span class="o">=</span><span class="n">kb</span><span class="o">+</span><span class="mi">1</span><span class="p">,</span><span class="n">ke</span>
<a name="ln-207"></a>          <span class="k">do </span><span class="n">j</span><span class="o">=</span><span class="n">jb</span><span class="p">,</span><span class="n">je</span>
<a name="ln-208"></a>             <span class="k">do </span><span class="n">i</span><span class="o">=</span><span class="n">ib</span><span class="p">,</span><span class="n">ie</span>
<a name="ln-209"></a>                <span class="n">dthvdz</span><span class="p">(</span><span class="n">i</span><span class="p">,</span><span class="n">j</span><span class="p">,</span><span class="n">k</span><span class="p">)</span> <span class="o">=</span> <span class="p">(</span><span class="n">thl0</span><span class="p">(</span><span class="n">i</span><span class="p">,</span><span class="n">j</span><span class="p">,</span><span class="n">k</span><span class="o">+</span><span class="mi">1</span><span class="p">)</span><span class="o">-</span><span class="n">thl0</span><span class="p">(</span><span class="n">i</span><span class="p">,</span><span class="n">j</span><span class="p">,</span><span class="n">k</span><span class="o">-</span><span class="mi">1</span><span class="p">))</span><span class="o">/</span><span class="p">(</span><span class="n">dzh</span><span class="p">(</span><span class="n">k</span><span class="o">+</span><span class="mi">1</span><span class="p">)</span><span class="o">+</span><span class="n">dzh</span><span class="p">(</span><span class="n">k</span><span class="p">))</span>
<a name="ln-210"></a>             <span class="k">end do</span>
<a name="ln-211"></a><span class="k">          end do</span>
<a name="ln-212"></a><span class="k">       end do</span>
<a name="ln-213"></a><span class="k">       do  </span><span class="n">j</span><span class="o">=</span><span class="n">jb</span><span class="p">,</span><span class="n">je</span>
<a name="ln-214"></a>          <span class="k">do  </span><span class="n">i</span><span class="o">=</span><span class="n">ib</span><span class="p">,</span><span class="n">ie</span>
<a name="ln-215"></a>            <span class="n">dthvdz</span><span class="p">(</span><span class="n">i</span><span class="p">,</span><span class="n">j</span><span class="p">,</span><span class="n">kb</span><span class="p">)</span><span class="o">=</span><span class="mf">0.</span>
<a name="ln-216"></a>          <span class="k">end do</span>
<a name="ln-217"></a><span class="k">       end do</span>
<a name="ln-218"></a><span class="k">    end if</span>
<a name="ln-219"></a>
<a name="ln-220"></a>    <span class="c">!CvH remove WHERE</span>
<a name="ln-221"></a>    <span class="c">!where (abs(dthvdz)&lt;eps1)</span>
<a name="ln-222"></a>    <span class="c">!  dthvdz = sign(eps1,dthvdz)</span>
<a name="ln-223"></a>    <span class="c">!end where</span>
<a name="ln-224"></a>    <span class="k">do </span><span class="n">k</span><span class="o">=</span><span class="n">kb</span><span class="p">,</span><span class="n">ke</span>
<a name="ln-225"></a>       <span class="k">do </span><span class="n">j</span><span class="o">=</span><span class="n">jb</span><span class="p">,</span><span class="n">je</span>
<a name="ln-226"></a>          <span class="k">do </span><span class="n">i</span><span class="o">=</span><span class="n">ib</span><span class="p">,</span><span class="n">ie</span>
<a name="ln-227"></a>             <span class="k">if</span><span class="p">(</span><span class="nb">abs</span><span class="p">(</span><span class="n">dthvdz</span><span class="p">(</span><span class="n">i</span><span class="p">,</span><span class="n">j</span><span class="p">,</span><span class="n">k</span><span class="p">))</span> <span class="o">&lt;</span> <span class="n">eps1</span><span class="p">)</span> <span class="k">then</span>
<a name="ln-228"></a><span class="k">                </span><span class="n">dthvdz</span><span class="p">(</span><span class="n">i</span><span class="p">,</span><span class="n">j</span><span class="p">,</span><span class="n">k</span><span class="p">)</span> <span class="o">=</span> <span class="nb">sign</span><span class="p">(</span><span class="n">eps1</span><span class="p">,</span> <span class="n">dthvdz</span><span class="p">(</span><span class="n">i</span><span class="p">,</span><span class="n">j</span><span class="p">,</span><span class="n">k</span><span class="p">))</span>
<a name="ln-229"></a>             <span class="k">end if</span>
<a name="ln-230"></a><span class="k">          end do</span>
<a name="ln-231"></a><span class="k">       end do</span>
<a name="ln-232"></a><span class="k">    end do</span>
<a name="ln-233"></a>
<a name="ln-234"></a>
<a name="ln-235"></a>
<a name="ln-236"></a><span class="k">  end subroutine </span><span class="n">calthv</span>
<a name="ln-237"></a>  <span class="c">!&gt; Calculate diagnostic slab averaged fields.</span>
<a name="ln-238"></a>  <span class="c">!!     Calculates slab averaged fields assuming</span>
<a name="ln-239"></a>  <span class="c">!!     hydrostatic equilibrium for: u,v,theta_l,theta_v,</span>
<a name="ln-240"></a>  <span class="c">!!     qt,ql,exner,pressure and the density</span>
<a name="ln-241"></a>  <span class="c">!! \author      Pier Siebesma   K.N.M.I.     06/01/1995</span>
<a name="ln-242"></a>  <span class="k">subroutine </span><span class="n">diagfld</span>
<a name="ln-243"></a>
<a name="ln-244"></a>    <span class="k">use </span><span class="n">modglobal</span><span class="p">,</span> <span class="n">only</span> <span class="p">:</span> <span class="n">ib</span><span class="p">,</span><span class="n">ie</span><span class="p">,</span><span class="n">ih</span><span class="p">,</span><span class="n">jb</span><span class="p">,</span><span class="n">je</span><span class="p">,</span><span class="n">jh</span><span class="p">,</span><span class="n">kb</span><span class="p">,</span><span class="n">ke</span><span class="p">,</span><span class="n">kh</span><span class="p">,</span><span class="n">khc</span><span class="p">,</span><span class="n">nsv</span><span class="p">,</span><span class="n">zh</span><span class="p">,</span><span class="n">zf</span><span class="p">,</span><span class="n">rslabs</span><span class="p">,</span><span class="n">grav</span><span class="p">,</span><span class="n">rlv</span><span class="p">,</span><span class="n">cp</span><span class="p">,</span><span class="n">rd</span><span class="p">,</span><span class="n">rv</span><span class="p">,</span><span class="n">pref0</span>
<a name="ln-245"></a>    <span class="k">use </span><span class="n">modfields</span><span class="p">,</span> <span class="n">only</span> <span class="p">:</span> <span class="n">u0</span><span class="p">,</span><span class="n">v0</span><span class="p">,</span><span class="n">thl0</span><span class="p">,</span><span class="n">qt0</span><span class="p">,</span><span class="n">ql0</span><span class="p">,</span><span class="n">sv0</span><span class="p">,</span><span class="n">u0av</span><span class="p">,</span><span class="n">v0av</span><span class="p">,</span><span class="n">thl0av</span><span class="p">,</span><span class="n">qt0av</span><span class="p">,</span><span class="n">ql0av</span><span class="p">,</span><span class="n">sv0av</span><span class="p">,</span> <span class="p">&amp;</span>
<a name="ln-246"></a>         <span class="n">presf</span><span class="p">,</span><span class="n">presh</span><span class="p">,</span><span class="n">exnf</span><span class="p">,</span><span class="n">exnh</span><span class="p">,</span><span class="n">rhof</span><span class="p">,</span><span class="n">thvf</span><span class="p">,</span><span class="n">IIc</span><span class="p">,</span><span class="n">IIcs</span><span class="p">,</span><span class="n">IIu</span><span class="p">,</span><span class="n">IIus</span><span class="p">,</span><span class="n">IIv</span><span class="p">,</span><span class="n">IIvs</span>
<a name="ln-247"></a>    <span class="k">use </span><span class="n">modsurfdata</span><span class="p">,</span><span class="n">only</span> <span class="p">:</span> <span class="n">thls</span><span class="p">,</span><span class="n">ps</span>
<a name="ln-248"></a>    <span class="k">use </span><span class="n">modmpi</span><span class="p">,</span>    <span class="n">only</span> <span class="p">:</span> <span class="n">slabsum</span><span class="p">,</span><span class="n">myid</span><span class="p">,</span><span class="n">avexy_ibm</span>
<a name="ln-249"></a>    <span class="k">implicit none</span>
<a name="ln-250"></a>
<a name="ln-251"></a><span class="k">    </span><span class="kt">real     </span><span class="n">tv</span>
<a name="ln-252"></a>    <span class="kt">integer  </span><span class="n">k</span><span class="p">,</span> <span class="n">n</span>
<a name="ln-253"></a>
<a name="ln-254"></a>
<a name="ln-255"></a>    <span class="c">!!*********************************************************</span>
<a name="ln-256"></a>    <span class="c">!!  1.0   calculate average profiles of u,v,thl,qt and ql *</span>
<a name="ln-257"></a>    <span class="c">!!        assuming hydrostatic equilibrium                *</span>
<a name="ln-258"></a>    <span class="c">!!*********************************************************</span>
<a name="ln-259"></a>
<a name="ln-260"></a>    <span class="c">! initialise local MPI arrays</span>
<a name="ln-261"></a>    <span class="n">u0av</span> <span class="o">=</span> <span class="mf">0.0</span>
<a name="ln-262"></a>    <span class="n">v0av</span> <span class="o">=</span> <span class="mf">0.0</span>
<a name="ln-263"></a>    <span class="n">thl0av</span> <span class="o">=</span> <span class="mf">0.0</span>
<a name="ln-264"></a>    <span class="n">th0av</span>  <span class="o">=</span> <span class="mf">0.0</span>
<a name="ln-265"></a>    <span class="n">qt0av</span>  <span class="o">=</span> <span class="mf">0.0</span>
<a name="ln-266"></a>    <span class="n">ql0av</span>  <span class="o">=</span> <span class="mf">0.0</span>
<a name="ln-267"></a>    <span class="n">sv0av</span> <span class="o">=</span> <span class="mf">0.</span>
<a name="ln-268"></a>
<a name="ln-269"></a>
<a name="ln-270"></a>    <span class="c">!CvH changed momentum array dimensions to same value as scalars!</span>
<a name="ln-271"></a>    <span class="c">!  call slabsum(u0av  ,kb,ke+kh,u0  ,ib-ih,ie+ih,jb-jh,je+jh,kb,ke+kh,ib,ie,jb,je,kb,ke+kh)</span>
<a name="ln-272"></a><span class="c">!    call slabsum(u0av  ,kb,ke+kh,u0(:,:,kb:ke+kh)  ,ib-ih,ie+ih,jb-jh,je+jh,kb,ke+kh,ib,ie,jb,je,kb,ke+kh)</span>
<a name="ln-273"></a>    <span class="k">call </span><span class="n">avexy_ibm</span><span class="p">(</span><span class="n">u0av</span><span class="p">(</span><span class="n">kb</span><span class="p">:</span><span class="n">ke</span><span class="o">+</span><span class="n">kh</span><span class="p">),</span><span class="n">u0</span><span class="p">(</span><span class="n">ib</span><span class="p">:</span><span class="n">ie</span><span class="p">,</span><span class="n">jb</span><span class="p">:</span><span class="n">je</span><span class="p">,</span><span class="n">kb</span><span class="p">:</span><span class="n">ke</span><span class="o">+</span><span class="n">kh</span><span class="p">),</span><span class="n">ib</span><span class="p">,</span><span class="n">ie</span><span class="p">,</span><span class="n">jb</span><span class="p">,</span><span class="n">je</span><span class="p">,</span><span class="n">kb</span><span class="p">,</span><span class="n">ke</span><span class="p">,</span><span class="n">ih</span><span class="p">,</span><span class="n">jh</span><span class="p">,</span><span class="n">kh</span><span class="p">,</span><span class="n">IIu</span><span class="p">(</span><span class="n">ib</span><span class="p">:</span><span class="n">ie</span><span class="p">,</span><span class="n">jb</span><span class="p">:</span><span class="n">je</span><span class="p">,</span><span class="n">kb</span><span class="p">:</span><span class="n">ke</span><span class="o">+</span><span class="n">kh</span><span class="p">),</span><span class="n">IIus</span><span class="p">(</span><span class="n">kb</span><span class="p">:</span><span class="n">ke</span><span class="o">+</span><span class="n">kh</span><span class="p">),.</span><span class="n">false</span><span class="p">.)</span>
<a name="ln-274"></a>    <span class="c">!  call slabsum(v0av  ,kb,ke+kh,v0  ,ib-ih,ie+ih,jb-jh,je+jh,kb,ke+kh,ib,ie,jb,je,kb,ke+kh)</span>
<a name="ln-275"></a><span class="c">!    call slabsum(v0av  ,kb,ke+kh,v0(:,:,kb:ke+kh)  ,ib-ih,ie+ih,jb-jh,je+jh,kb,ke+kh,ib,ie,jb,je,kb,ke+kh)</span>
<a name="ln-276"></a>    <span class="k">call </span><span class="n">avexy_ibm</span><span class="p">(</span><span class="n">v0av</span><span class="p">(</span><span class="n">kb</span><span class="p">:</span><span class="n">ke</span><span class="o">+</span><span class="n">kh</span><span class="p">),</span><span class="n">v0</span><span class="p">(</span><span class="n">ib</span><span class="p">:</span><span class="n">ie</span><span class="p">,</span><span class="n">jb</span><span class="p">:</span><span class="n">je</span><span class="p">,</span><span class="n">kb</span><span class="p">:</span><span class="n">ke</span><span class="o">+</span><span class="n">kh</span><span class="p">),</span><span class="n">ib</span><span class="p">,</span><span class="n">ie</span><span class="p">,</span><span class="n">jb</span><span class="p">,</span><span class="n">je</span><span class="p">,</span><span class="n">kb</span><span class="p">,</span><span class="n">ke</span><span class="p">,</span><span class="n">ih</span><span class="p">,</span><span class="n">jh</span><span class="p">,</span><span class="n">kh</span><span class="p">,</span><span class="n">IIv</span><span class="p">(</span><span class="n">ib</span><span class="p">:</span><span class="n">ie</span><span class="p">,</span><span class="n">jb</span><span class="p">:</span><span class="n">je</span><span class="p">,</span><span class="n">kb</span><span class="p">:</span><span class="n">ke</span><span class="o">+</span><span class="n">kh</span><span class="p">),</span><span class="n">IIvs</span><span class="p">(</span><span class="n">kb</span><span class="p">:</span><span class="n">ke</span><span class="o">+</span><span class="n">kh</span><span class="p">),.</span><span class="n">false</span><span class="p">.)</span>
<a name="ln-277"></a>    <span class="c">!  call slabsum(thl0av,kb,ke+kh,thl0,ib-ih,ie+ih,jb-jh,je+jh,kb,ke+kh,ib,ie,jb,je,kb,ke+kh)</span>
<a name="ln-278"></a><span class="c">!    call slabsum(thl0av,kb,ke+kh,thl0(:,:,kb:ke+kh),ib-ih,ie+ih,jb-jh,je+jh,kb,ke+kh,ib,ie,jb,je,kb,ke+kh)</span>
<a name="ln-279"></a>    <span class="k">call </span><span class="n">avexy_ibm</span><span class="p">(</span><span class="n">thl0av</span><span class="p">(</span><span class="n">kb</span><span class="p">:</span><span class="n">ke</span><span class="o">+</span><span class="n">kh</span><span class="p">),</span><span class="n">thl0</span><span class="p">(</span><span class="n">ib</span><span class="p">:</span><span class="n">ie</span><span class="p">,</span><span class="n">jb</span><span class="p">:</span><span class="n">je</span><span class="p">,</span><span class="n">kb</span><span class="p">:</span><span class="n">ke</span><span class="o">+</span><span class="n">kh</span><span class="p">),</span><span class="n">ib</span><span class="p">,</span><span class="n">ie</span><span class="p">,</span><span class="n">jb</span><span class="p">,</span><span class="n">je</span><span class="p">,</span><span class="n">kb</span><span class="p">,</span><span class="n">ke</span><span class="p">,</span><span class="n">ih</span><span class="p">,</span><span class="n">jh</span><span class="p">,</span><span class="n">kh</span><span class="p">,</span><span class="n">IIc</span><span class="p">(</span><span class="n">ib</span><span class="p">:</span><span class="n">ie</span><span class="p">,</span><span class="n">jb</span><span class="p">:</span><span class="n">je</span><span class="p">,</span><span class="n">kb</span><span class="p">:</span><span class="n">ke</span><span class="o">+</span><span class="n">kh</span><span class="p">),</span><span class="n">IIcs</span><span class="p">(</span><span class="n">kb</span><span class="p">:</span><span class="n">ke</span><span class="o">+</span><span class="n">kh</span><span class="p">),.</span><span class="n">false</span><span class="p">.)</span>
<a name="ln-280"></a>
<a name="ln-281"></a>    <span class="c">!write(*,*) &#39;thl0av(kb), thl0av(kb+1)&#39;, thl0av(kb), thl0av(kb+1)</span>
<a name="ln-282"></a>   
<a name="ln-283"></a>    <span class="c">!if (IIbl == 0) then ! as lEB applies blocks to kb and masking matrices average this to zero</span>
<a name="ln-284"></a>    <span class="c">!  thl0av(kb) = thl0av(kb+1)</span>
<a name="ln-285"></a>    <span class="c">!end if</span>
<a name="ln-286"></a>
<a name="ln-287"></a>    <span class="c">!  call slabsum(qt0av ,kb,ke+kh,qt0 ,ib-ih,ie+ih,jb-jh,je+jh,kb,ke+kh,ib,ie,jb,je,kb,ke+kh)</span>
<a name="ln-288"></a><span class="c">!    call slabsum(qt0av ,kb,ke+kh,qt0(:,:,kb:ke+kh) ,ib-ih,ie+ih,jb-jh,je+jh,kb,ke+kh,ib,ie,jb,je,kb,ke+kh)</span>
<a name="ln-289"></a>    <span class="k">call </span><span class="n">avexy_ibm</span><span class="p">(</span><span class="n">qt0av</span><span class="p">(</span><span class="n">kb</span><span class="p">:</span><span class="n">ke</span><span class="o">+</span><span class="n">kh</span><span class="p">),</span><span class="n">qt0</span><span class="p">(</span><span class="n">ib</span><span class="p">:</span><span class="n">ie</span><span class="p">,</span><span class="n">jb</span><span class="p">:</span><span class="n">je</span><span class="p">,</span><span class="n">kb</span><span class="p">:</span><span class="n">ke</span><span class="o">+</span><span class="n">kh</span><span class="p">),</span><span class="n">ib</span><span class="p">,</span><span class="n">ie</span><span class="p">,</span><span class="n">jb</span><span class="p">,</span><span class="n">je</span><span class="p">,</span><span class="n">kb</span><span class="p">,</span><span class="n">ke</span><span class="p">,</span><span class="n">ih</span><span class="p">,</span><span class="n">jh</span><span class="p">,</span><span class="n">kh</span><span class="p">,</span><span class="n">IIc</span><span class="p">(</span><span class="n">ib</span><span class="p">:</span><span class="n">ie</span><span class="p">,</span><span class="n">jb</span><span class="p">:</span><span class="n">je</span><span class="p">,</span><span class="n">kb</span><span class="p">:</span><span class="n">ke</span><span class="o">+</span><span class="n">kh</span><span class="p">),</span><span class="n">IIcs</span><span class="p">(</span><span class="n">kb</span><span class="p">:</span><span class="n">ke</span><span class="o">+</span><span class="n">kh</span><span class="p">),.</span><span class="n">false</span><span class="p">.)</span>
<a name="ln-290"></a><span class="c">!    call slabsum(ql0av ,kb,ke+kh,ql0 ,ib-ih,ie+ih,jb-jh,je+jh,kb,ke+kh,ib,ie,jb,je,kb,ke+kh)</span>
<a name="ln-291"></a>    <span class="k">call </span><span class="n">avexy_ibm</span><span class="p">(</span><span class="n">ql0av</span><span class="p">(</span><span class="n">kb</span><span class="p">:</span><span class="n">ke</span><span class="o">+</span><span class="n">kh</span><span class="p">),</span><span class="n">ql0</span><span class="p">(</span><span class="n">ib</span><span class="p">:</span><span class="n">ie</span><span class="p">,</span><span class="n">jb</span><span class="p">:</span><span class="n">je</span><span class="p">,</span><span class="n">kb</span><span class="p">:</span><span class="n">ke</span><span class="o">+</span><span class="n">kh</span><span class="p">),</span><span class="n">ib</span><span class="p">,</span><span class="n">ie</span><span class="p">,</span><span class="n">jb</span><span class="p">,</span><span class="n">je</span><span class="p">,</span><span class="n">kb</span><span class="p">,</span><span class="n">ke</span><span class="p">,</span><span class="n">ih</span><span class="p">,</span><span class="n">jh</span><span class="p">,</span><span class="n">kh</span><span class="p">,</span><span class="n">IIc</span><span class="p">(</span><span class="n">ib</span><span class="p">:</span><span class="n">ie</span><span class="p">,</span><span class="n">jb</span><span class="p">:</span><span class="n">je</span><span class="p">,</span><span class="n">kb</span><span class="p">:</span><span class="n">ke</span><span class="o">+</span><span class="n">kh</span><span class="p">),</span><span class="n">IIcs</span><span class="p">(</span><span class="n">kb</span><span class="p">:</span><span class="n">ke</span><span class="o">+</span><span class="n">kh</span><span class="p">),.</span><span class="n">false</span><span class="p">.)</span>
<a name="ln-292"></a>
<a name="ln-293"></a>    <span class="n">exnf</span>   <span class="o">=</span> <span class="mi">1</span><span class="o">-</span><span class="n">grav</span><span class="o">*</span><span class="n">zf</span><span class="o">/</span><span class="p">(</span><span class="n">cp</span><span class="o">*</span><span class="n">thls</span><span class="p">)</span>
<a name="ln-294"></a>    <span class="n">exnh</span>  <span class="o">=</span> <span class="mi">1</span><span class="o">-</span><span class="n">grav</span><span class="o">*</span><span class="n">zh</span><span class="o">/</span><span class="p">(</span><span class="n">cp</span><span class="o">*</span><span class="n">thls</span><span class="p">)</span>
<a name="ln-295"></a>    <span class="n">th0av</span>  <span class="o">=</span> <span class="n">thl0av</span> <span class="o">+</span> <span class="p">(</span><span class="n">rlv</span><span class="o">/</span><span class="n">cp</span><span class="p">)</span><span class="o">*</span><span class="n">ql0av</span><span class="o">/</span><span class="n">exnf</span>
<a name="ln-296"></a>
<a name="ln-297"></a>    <span class="c">!write(*,*) &#39;thl0av&#39;,thl0av</span>
<a name="ln-298"></a>    <span class="c">!write(*,*) &#39;th0av&#39;,th0av</span>
<a name="ln-299"></a>    
<a name="ln-300"></a>
<a name="ln-301"></a>    <span class="k">do </span><span class="n">n</span><span class="o">=</span><span class="mi">1</span><span class="p">,</span><span class="n">nsv</span>
<a name="ln-302"></a><span class="c">!       call slabsum(sv0av(kb,n),kb,ke+kh,sv0(ib-ih,jb-jh,kb,n),ib-ih,ie+ih,jb-jh,je+jh,kb,ke+kh,ib,ie,jb,je,kb,ke+kh)</span>
<a name="ln-303"></a>    <span class="k">call </span><span class="n">avexy_ibm</span><span class="p">(</span><span class="n">sv0av</span><span class="p">(</span><span class="n">kb</span><span class="p">:</span><span class="n">ke</span><span class="o">+</span><span class="n">khc</span><span class="p">,</span><span class="n">n</span><span class="p">),</span><span class="n">sv0</span><span class="p">(</span><span class="n">ib</span><span class="p">:</span><span class="n">ie</span><span class="p">,</span><span class="n">jb</span><span class="p">:</span><span class="n">je</span><span class="p">,</span><span class="n">kb</span><span class="p">:</span><span class="n">ke</span><span class="o">+</span><span class="n">khc</span><span class="p">,</span><span class="n">n</span><span class="p">),</span><span class="n">ib</span><span class="p">,</span><span class="n">ie</span><span class="p">,</span><span class="n">jb</span><span class="p">,</span><span class="n">je</span><span class="p">,</span><span class="n">kb</span><span class="p">,</span><span class="n">ke</span><span class="p">,</span><span class="n">ih</span><span class="p">,</span><span class="n">jh</span><span class="p">,</span><span class="n">kh</span><span class="p">,</span><span class="n">IIc</span><span class="p">(</span><span class="n">ib</span><span class="p">:</span><span class="n">ie</span><span class="p">,</span><span class="n">jb</span><span class="p">:</span><span class="n">je</span><span class="p">,</span><span class="n">kb</span><span class="p">:</span><span class="n">ke</span><span class="o">+</span><span class="n">khc</span><span class="p">),</span><span class="n">IIcs</span><span class="p">(</span><span class="n">kb</span><span class="p">:</span><span class="n">ke</span><span class="o">+</span><span class="n">khc</span><span class="p">),.</span><span class="n">false</span><span class="p">.)</span>
<a name="ln-304"></a>    <span class="k">end do</span>
<a name="ln-305"></a><span class="c">!    sv0av = sv0av/rslabs</span>
<a name="ln-306"></a>
<a name="ln-307"></a>    <span class="c">!***********************************************************</span>
<a name="ln-308"></a>    <span class="c">!  2.0   calculate average profile of pressure at full and *</span>
<a name="ln-309"></a>    <span class="c">!        half levels, assuming hydrostatic equilibrium.    *</span>
<a name="ln-310"></a>    <span class="c">!***********************************************************</span>
<a name="ln-311"></a>
<a name="ln-312"></a>    <span class="c">!    2.1 Use first guess of theta, then recalculate theta</span>
<a name="ln-313"></a>    <span class="k">call </span><span class="n">fromztop</span>
<a name="ln-314"></a>    <span class="n">exnf</span> <span class="o">=</span> <span class="p">(</span><span class="n">presf</span><span class="o">/</span><span class="n">pref0</span><span class="p">)</span><span class="o">**</span><span class="p">(</span><span class="n">rd</span><span class="o">/</span><span class="n">cp</span><span class="p">)</span>
<a name="ln-315"></a>    <span class="n">th0av</span> <span class="o">=</span> <span class="n">thl0av</span> <span class="o">+</span> <span class="p">(</span><span class="n">rlv</span><span class="o">/</span><span class="n">cp</span><span class="p">)</span><span class="o">*</span><span class="n">ql0av</span><span class="o">/</span><span class="n">exnf</span>
<a name="ln-316"></a>
<a name="ln-317"></a>
<a name="ln-318"></a>    <span class="c">!    2.2 Use new updated value of theta for determination of pressure</span>
<a name="ln-319"></a>
<a name="ln-320"></a>    <span class="k">call </span><span class="n">fromztop</span>
<a name="ln-321"></a>
<a name="ln-322"></a>
<a name="ln-323"></a>
<a name="ln-324"></a>    <span class="c">!***********************************************************</span>
<a name="ln-325"></a>    <span class="c">!  3.0   Construct density profiles and exner function     *</span>
<a name="ln-326"></a>    <span class="c">!       for further use in the program                     *</span>
<a name="ln-327"></a>    <span class="c">!***********************************************************</span>
<a name="ln-328"></a>
<a name="ln-329"></a>    <span class="c">!    3.1 determine exner</span>
<a name="ln-330"></a>
<a name="ln-331"></a>    <span class="n">exnh</span><span class="p">(</span><span class="n">kb</span><span class="p">)</span> <span class="o">=</span> <span class="p">(</span><span class="n">ps</span><span class="o">/</span><span class="n">pref0</span><span class="p">)</span><span class="o">**</span><span class="p">(</span><span class="n">rd</span><span class="o">/</span><span class="n">cp</span><span class="p">)</span>
<a name="ln-332"></a>    <span class="n">exnf</span><span class="p">(</span><span class="n">kb</span><span class="p">)</span> <span class="o">=</span> <span class="p">(</span><span class="n">presf</span><span class="p">(</span><span class="n">kb</span><span class="p">)</span><span class="o">/</span><span class="n">pref0</span><span class="p">)</span><span class="o">**</span><span class="p">(</span><span class="n">rd</span><span class="o">/</span><span class="n">cp</span><span class="p">)</span>
<a name="ln-333"></a>    <span class="k">do </span><span class="n">k</span><span class="o">=</span><span class="n">kb</span><span class="o">+</span><span class="mi">1</span><span class="p">,</span><span class="n">ke</span><span class="o">+</span><span class="n">kh</span>
<a name="ln-334"></a>       <span class="n">exnf</span><span class="p">(</span><span class="n">k</span><span class="p">)</span> <span class="o">=</span> <span class="p">(</span><span class="n">presf</span><span class="p">(</span><span class="n">k</span><span class="p">)</span><span class="o">/</span><span class="n">pref0</span><span class="p">)</span><span class="o">**</span><span class="p">(</span><span class="n">rd</span><span class="o">/</span><span class="n">cp</span><span class="p">)</span>
<a name="ln-335"></a>       <span class="n">exnh</span><span class="p">(</span><span class="n">k</span><span class="p">)</span> <span class="o">=</span> <span class="p">(</span><span class="n">presh</span><span class="p">(</span><span class="n">k</span><span class="p">)</span><span class="o">/</span><span class="n">pref0</span><span class="p">)</span><span class="o">**</span><span class="p">(</span><span class="n">rd</span><span class="o">/</span><span class="n">cp</span><span class="p">)</span>
<a name="ln-336"></a>    <span class="k">end do</span>
<a name="ln-337"></a>
<a name="ln-338"></a><span class="k">    </span><span class="n">thvf</span><span class="p">(</span><span class="n">kb</span><span class="p">)</span>      <span class="o">=</span> <span class="n">th0av</span><span class="p">(</span><span class="n">kb</span><span class="p">)</span><span class="o">*</span><span class="n">exnf</span><span class="p">(</span><span class="n">kb</span><span class="p">)</span><span class="o">*</span><span class="p">(</span><span class="mi">1</span><span class="o">+</span><span class="p">(</span><span class="n">rv</span><span class="o">/</span><span class="n">rd</span><span class="o">-</span><span class="mi">1</span><span class="p">)</span><span class="o">*</span><span class="n">qt0av</span><span class="p">(</span><span class="n">kb</span><span class="p">)</span><span class="o">-</span><span class="n">rv</span><span class="o">/</span><span class="n">rd</span><span class="o">*</span><span class="n">ql0av</span><span class="p">(</span><span class="n">kb</span><span class="p">))</span>
<a name="ln-339"></a>    <span class="n">rhof</span><span class="p">(</span><span class="n">kb</span><span class="p">)</span> <span class="o">=</span> <span class="n">presf</span><span class="p">(</span><span class="n">kb</span><span class="p">)</span><span class="o">/</span><span class="p">(</span><span class="n">rd</span><span class="o">*</span><span class="n">thvf</span><span class="p">(</span><span class="n">kb</span><span class="p">))</span>
<a name="ln-340"></a>
<a name="ln-341"></a>    <span class="c">!    3.2 determine rho</span>
<a name="ln-342"></a>
<a name="ln-343"></a>    <span class="k">do </span><span class="n">k</span><span class="o">=</span><span class="n">kb</span><span class="o">+</span><span class="mi">1</span><span class="p">,</span><span class="n">ke</span>     <span class="c">!+kh    ?</span>
<a name="ln-344"></a>    <span class="c">!   write(*,*) &quot;exnf(k)&quot;,exnf(k)</span>
<a name="ln-345"></a>    <span class="c">!   write(*,*) &quot;th0av(k)&quot;,th0av(k)</span>
<a name="ln-346"></a>    <span class="c">!   write(*,*) &quot;qt0av(k)&quot;,qt0av(k)</span>
<a name="ln-347"></a>    <span class="c">!   write(*,*) &quot;ql0av(k)&quot;,ql0av(k)</span>
<a name="ln-348"></a>       <span class="n">thvf</span><span class="p">(</span><span class="n">k</span><span class="p">)</span> <span class="o">=</span> <span class="n">th0av</span><span class="p">(</span><span class="n">k</span><span class="p">)</span><span class="o">*</span><span class="n">exnf</span><span class="p">(</span><span class="n">k</span><span class="p">)</span><span class="o">*</span><span class="p">(</span><span class="mf">1.</span><span class="o">+</span><span class="p">(</span><span class="n">rv</span><span class="o">/</span><span class="n">rd</span><span class="o">-</span><span class="mi">1</span><span class="p">)</span><span class="o">*</span><span class="n">qt0av</span><span class="p">(</span><span class="n">k</span><span class="p">)</span><span class="o">-</span><span class="n">rv</span><span class="o">/</span><span class="n">rd</span><span class="o">*</span><span class="n">ql0av</span><span class="p">(</span><span class="n">k</span><span class="p">))</span>
<a name="ln-349"></a>       <span class="n">rhof</span><span class="p">(</span><span class="n">k</span><span class="p">)</span> <span class="o">=</span> <span class="n">presf</span><span class="p">(</span><span class="n">k</span><span class="p">)</span><span class="o">/</span><span class="p">(</span><span class="n">rd</span><span class="o">*</span><span class="n">thvf</span><span class="p">(</span><span class="n">k</span><span class="p">))</span>
<a name="ln-350"></a>    <span class="k">end do</span>
<a name="ln-351"></a><span class="k">    return</span>
<a name="ln-352"></a><span class="k">  end subroutine </span><span class="n">diagfld</span>
<a name="ln-353"></a>
<a name="ln-354"></a>
<a name="ln-355"></a>  <span class="c">!&gt; Calculates slab averaged pressure</span>
<a name="ln-356"></a>  <span class="c">!!      Input :  zf,zh,theta and qt profile</span>
<a name="ln-357"></a>  <span class="c">!!      Output:  pressure profile at full and</span>
<a name="ln-358"></a>  <span class="c">!!               half levels</span>
<a name="ln-359"></a>  <span class="c">!!</span>
<a name="ln-360"></a>  <span class="c">!!      Method: Using hydrostatic equilibrium</span>
<a name="ln-361"></a>  <span class="c">!!</span>
<a name="ln-362"></a>  <span class="c">!!                              -g*pref0**(rd/cp)</span>
<a name="ln-363"></a>  <span class="c">!! =====&gt;       dp**(rd/cp)/dz = --------------</span>
<a name="ln-364"></a>  <span class="c">!!                                 cp*thetav</span>
<a name="ln-365"></a>  <span class="c">!! \author Pier Siebesma   K.N.M.I.     06/01/1995</span>
<a name="ln-366"></a>  <span class="k">subroutine </span><span class="n">fromztop</span>
<a name="ln-367"></a>
<a name="ln-368"></a>    <span class="k">use </span><span class="n">modglobal</span><span class="p">,</span> <span class="n">only</span> <span class="p">:</span> <span class="n">kmax</span><span class="p">,</span><span class="n">kb</span><span class="p">,</span><span class="n">ke</span><span class="p">,</span><span class="n">kh</span><span class="p">,</span><span class="n">dzf</span><span class="p">,</span><span class="n">dzh</span><span class="p">,</span><span class="n">rv</span><span class="p">,</span><span class="n">rd</span><span class="p">,</span><span class="n">cp</span><span class="p">,</span><span class="n">tmelt</span><span class="p">,</span><span class="n">zf</span><span class="p">,</span><span class="n">grav</span><span class="p">,</span><span class="n">pref0</span><span class="p">,</span><span class="n">lEB</span>
<a name="ln-369"></a>    <span class="k">use </span><span class="n">modfields</span><span class="p">,</span> <span class="n">only</span> <span class="p">:</span> <span class="n">qt0av</span><span class="p">,</span><span class="n">ql0av</span><span class="p">,</span><span class="n">presf</span><span class="p">,</span><span class="n">presh</span><span class="p">,</span><span class="n">thvh</span><span class="p">,</span><span class="n">thvf</span><span class="p">,</span><span class="n">IIcs</span>
<a name="ln-370"></a>    <span class="k">use </span><span class="n">modsurfdata</span><span class="p">,</span><span class="n">only</span> <span class="p">:</span> <span class="n">ps</span><span class="p">,</span><span class="n">thvs</span>
<a name="ln-371"></a>    <span class="k">implicit none</span>
<a name="ln-372"></a>
<a name="ln-373"></a><span class="k">    </span><span class="kt">integer   </span><span class="n">k</span>
<a name="ln-374"></a>    <span class="kt">real      </span><span class="n">rdocp</span>
<a name="ln-375"></a>    <span class="kt">real</span><span class="p">,</span><span class="k">allocatable</span><span class="p">,</span><span class="k">dimension</span> <span class="p">(:)</span> <span class="kd">::</span> <span class="n">thetah</span><span class="p">,</span> <span class="n">qth</span><span class="p">,</span> <span class="n">qlh</span>
<a name="ln-376"></a>
<a name="ln-377"></a>    <span class="k">allocate</span><span class="p">(</span><span class="n">thetah</span><span class="p">(</span><span class="n">kb</span><span class="p">:</span><span class="n">ke</span><span class="o">+</span><span class="n">kh</span><span class="p">),</span> <span class="n">qth</span><span class="p">(</span><span class="n">kb</span><span class="p">:</span><span class="n">ke</span><span class="o">+</span><span class="n">kh</span><span class="p">),</span> <span class="n">qlh</span><span class="p">(</span><span class="n">kb</span><span class="p">:</span><span class="n">ke</span><span class="o">+</span><span class="n">kh</span><span class="p">))</span>
<a name="ln-378"></a>    <span class="n">rdocp</span> <span class="o">=</span> <span class="n">rd</span><span class="o">/</span><span class="n">cp</span>
<a name="ln-379"></a>
<a name="ln-380"></a>    <span class="c">!**************************************************</span>
<a name="ln-381"></a>    <span class="c">!    1.0 Determine theta and qt at half levels    *</span>
<a name="ln-382"></a>    <span class="c">!**************************************************</span>
<a name="ln-383"></a>
<a name="ln-384"></a>    <span class="k">do </span><span class="n">k</span><span class="o">=</span><span class="n">kb</span><span class="o">+</span><span class="mi">1</span><span class="p">,</span><span class="n">ke</span><span class="o">+</span><span class="n">kh</span>
<a name="ln-385"></a>       <span class="n">thetah</span><span class="p">(</span><span class="n">k</span><span class="p">)</span> <span class="o">=</span> <span class="p">(</span><span class="n">th0av</span><span class="p">(</span><span class="n">k</span><span class="p">)</span><span class="o">*</span><span class="n">dzf</span><span class="p">(</span><span class="n">k</span><span class="o">-</span><span class="mi">1</span><span class="p">)</span> <span class="o">+</span> <span class="n">th0av</span><span class="p">(</span><span class="n">k</span><span class="o">-</span><span class="mi">1</span><span class="p">)</span><span class="o">*</span><span class="n">dzf</span><span class="p">(</span><span class="n">k</span><span class="p">))</span><span class="o">/</span><span class="p">(</span><span class="mi">2</span><span class="o">*</span><span class="n">dzh</span><span class="p">(</span><span class="n">k</span><span class="p">))</span>
<a name="ln-386"></a>       <span class="n">qth</span>   <span class="p">(</span><span class="n">k</span><span class="p">)</span> <span class="o">=</span> <span class="p">(</span><span class="n">qt0av</span><span class="p">(</span><span class="n">k</span><span class="p">)</span><span class="o">*</span><span class="n">dzf</span><span class="p">(</span><span class="n">k</span><span class="o">-</span><span class="mi">1</span><span class="p">)</span> <span class="o">+</span> <span class="n">qt0av</span><span class="p">(</span><span class="n">k</span><span class="o">-</span><span class="mi">1</span><span class="p">)</span><span class="o">*</span><span class="n">dzf</span><span class="p">(</span><span class="n">k</span><span class="p">))</span><span class="o">/</span><span class="p">(</span><span class="mi">2</span><span class="o">*</span><span class="n">dzh</span><span class="p">(</span><span class="n">k</span><span class="p">))</span>
<a name="ln-387"></a>       <span class="n">qlh</span>   <span class="p">(</span><span class="n">k</span><span class="p">)</span> <span class="o">=</span> <span class="p">(</span><span class="n">ql0av</span><span class="p">(</span><span class="n">k</span><span class="p">)</span><span class="o">*</span><span class="n">dzf</span><span class="p">(</span><span class="n">k</span><span class="o">-</span><span class="mi">1</span><span class="p">)</span> <span class="o">+</span> <span class="n">ql0av</span><span class="p">(</span><span class="n">k</span><span class="o">-</span><span class="mi">1</span><span class="p">)</span><span class="o">*</span><span class="n">dzf</span><span class="p">(</span><span class="n">k</span><span class="p">))</span><span class="o">/</span><span class="p">(</span><span class="mi">2</span><span class="o">*</span><span class="n">dzh</span><span class="p">(</span><span class="n">k</span><span class="p">))</span>
<a name="ln-388"></a>    <span class="k">end do</span>
<a name="ln-389"></a>
<a name="ln-390"></a>    <span class="c">!**************************************************</span>
<a name="ln-391"></a>    <span class="c">!     2.1  calculate pressures at full levels     *</span>
<a name="ln-392"></a>    <span class="c">!          assuming hydrostatic equilibrium       *</span>
<a name="ln-393"></a>    <span class="c">!**************************************************</span>
<a name="ln-394"></a>
<a name="ln-395"></a>    <span class="c">!     1: lowest level: use thvs</span>
<a name="ln-396"></a>
<a name="ln-397"></a>    <span class="n">thvh</span><span class="p">(</span><span class="n">kb</span><span class="p">)</span> <span class="o">=</span> <span class="n">thvs</span>
<a name="ln-398"></a>    <span class="n">presf</span><span class="p">(</span><span class="n">kb</span><span class="p">)</span> <span class="o">=</span> <span class="n">ps</span><span class="o">**</span><span class="n">rdocp</span> <span class="o">-</span> <span class="p">&amp;</span>
<a name="ln-399"></a>         <span class="n">grav</span><span class="o">*</span><span class="p">(</span><span class="n">pref0</span><span class="o">**</span><span class="n">rdocp</span><span class="p">)</span><span class="o">*</span><span class="n">zf</span><span class="p">(</span><span class="n">kb</span><span class="p">)</span> <span class="o">/</span><span class="p">(</span><span class="n">cp</span><span class="o">*</span><span class="n">thvh</span><span class="p">(</span><span class="n">kb</span><span class="p">))</span>
<a name="ln-400"></a>    <span class="n">presf</span><span class="p">(</span><span class="n">kb</span><span class="p">)</span> <span class="o">=</span> <span class="n">presf</span><span class="p">(</span><span class="n">kb</span><span class="p">)</span><span class="o">**</span><span class="p">(</span><span class="mf">1.</span><span class="o">/</span><span class="n">rdocp</span><span class="p">)</span>
<a name="ln-401"></a>
<a name="ln-402"></a>    <span class="c">!     2: higher levels</span>
<a name="ln-403"></a>
<a name="ln-404"></a>    <span class="k">do </span><span class="n">k</span><span class="o">=</span><span class="n">kb</span><span class="o">+</span><span class="mi">1</span><span class="p">,</span><span class="n">ke</span><span class="o">+</span><span class="n">kh</span> 
<a name="ln-405"></a>       <span class="n">thvh</span><span class="p">(</span><span class="n">k</span><span class="p">)</span>  <span class="o">=</span> <span class="n">thetah</span><span class="p">(</span><span class="n">k</span><span class="p">)</span><span class="o">*</span><span class="p">(</span><span class="mi">1</span><span class="o">+</span><span class="p">(</span><span class="n">rv</span><span class="o">/</span><span class="n">rd</span><span class="o">-</span><span class="mi">1</span><span class="p">)</span><span class="o">*</span><span class="n">qth</span><span class="p">(</span><span class="n">k</span><span class="p">)</span><span class="o">-</span><span class="n">rv</span><span class="o">/</span><span class="n">rd</span><span class="o">*</span><span class="n">qlh</span><span class="p">(</span><span class="n">k</span><span class="p">))</span>
<a name="ln-406"></a>       <span class="n">presf</span><span class="p">(</span><span class="n">k</span><span class="p">)</span> <span class="o">=</span> <span class="n">presf</span><span class="p">(</span><span class="n">k</span><span class="o">-</span><span class="mi">1</span><span class="p">)</span><span class="o">**</span><span class="n">rdocp</span> <span class="o">-</span> <span class="n">grav</span><span class="o">*</span><span class="p">(</span><span class="n">pref0</span><span class="o">**</span><span class="n">rdocp</span><span class="p">)</span><span class="o">*</span><span class="n">dzh</span><span class="p">(</span><span class="n">k</span><span class="p">)</span> <span class="o">/</span><span class="p">(</span><span class="n">cp</span><span class="o">*</span><span class="n">thvh</span><span class="p">(</span><span class="n">k</span><span class="p">))</span>
<a name="ln-407"></a>       <span class="n">presf</span><span class="p">(</span><span class="n">k</span><span class="p">)</span> <span class="o">=</span> <span class="n">presf</span><span class="p">(</span><span class="n">k</span><span class="p">)</span><span class="o">**</span><span class="p">(</span><span class="mf">1.</span><span class="o">/</span><span class="n">rdocp</span><span class="p">)</span>
<a name="ln-408"></a>    <span class="k">end do</span>
<a name="ln-409"></a>
<a name="ln-410"></a>    <span class="c">!**************************************************</span>
<a name="ln-411"></a>    <span class="c">!     2.2   calculate pressures at half levels    *</span>
<a name="ln-412"></a>    <span class="c">!           assuming hydrostatic equilibrium      *</span>
<a name="ln-413"></a>    <span class="c">!**************************************************</span>
<a name="ln-414"></a>
<a name="ln-415"></a>    <span class="n">presh</span><span class="p">(</span><span class="n">kb</span><span class="p">)</span> <span class="o">=</span> <span class="n">ps</span>
<a name="ln-416"></a>    <span class="n">thvf</span><span class="p">(</span><span class="n">kb</span><span class="p">)</span> <span class="o">=</span> <span class="n">th0av</span><span class="p">(</span><span class="n">kb</span><span class="p">)</span><span class="o">*</span><span class="p">(</span><span class="mi">1</span><span class="o">+</span><span class="p">(</span><span class="n">rv</span><span class="o">/</span><span class="n">rd</span><span class="o">-</span><span class="mi">1</span><span class="p">)</span><span class="o">*</span><span class="n">qt0av</span><span class="p">(</span><span class="n">kb</span><span class="p">)</span><span class="o">-</span><span class="n">rv</span><span class="o">/</span><span class="n">rd</span><span class="o">*</span><span class="n">ql0av</span><span class="p">(</span><span class="n">kb</span><span class="p">))</span>
<a name="ln-417"></a>    <span class="k">do </span><span class="n">k</span><span class="o">=</span><span class="n">kb</span><span class="o">+</span><span class="mi">1</span><span class="p">,</span><span class="n">ke</span><span class="o">+</span><span class="n">kh</span>
<a name="ln-418"></a>       <span class="n">thvf</span><span class="p">(</span><span class="n">k</span><span class="p">)</span>  <span class="o">=</span> <span class="n">th0av</span><span class="p">(</span><span class="n">k</span><span class="p">)</span><span class="o">*</span><span class="p">(</span><span class="mi">1</span><span class="o">+</span><span class="p">(</span><span class="n">rv</span><span class="o">/</span><span class="n">rd</span><span class="o">-</span><span class="mi">1</span><span class="p">)</span><span class="o">*</span><span class="n">qt0av</span><span class="p">(</span><span class="n">k</span><span class="p">)</span><span class="o">-</span><span class="n">rv</span><span class="o">/</span><span class="n">rd</span><span class="o">*</span><span class="n">ql0av</span><span class="p">(</span><span class="n">k</span><span class="p">))</span>
<a name="ln-419"></a>       <span class="n">presh</span><span class="p">(</span><span class="n">k</span><span class="p">)</span> <span class="o">=</span> <span class="n">presh</span><span class="p">(</span><span class="n">k</span><span class="o">-</span><span class="mi">1</span><span class="p">)</span><span class="o">**</span><span class="n">rdocp</span> <span class="o">-</span> <span class="n">grav</span><span class="o">*</span><span class="p">(</span><span class="n">pref0</span><span class="o">**</span><span class="n">rdocp</span><span class="p">)</span><span class="o">*</span><span class="n">dzf</span><span class="p">(</span><span class="n">k</span><span class="o">-</span><span class="mi">1</span><span class="p">)</span> <span class="o">/</span> <span class="p">(</span><span class="n">cp</span><span class="o">*</span><span class="n">thvf</span><span class="p">(</span><span class="n">k</span><span class="o">-</span><span class="mi">1</span><span class="p">))</span>
<a name="ln-420"></a>       <span class="n">presh</span><span class="p">(</span><span class="n">k</span><span class="p">)</span> <span class="o">=</span> <span class="n">presh</span><span class="p">(</span><span class="n">k</span><span class="p">)</span><span class="o">**</span><span class="p">(</span><span class="mf">1.</span><span class="o">/</span><span class="n">rdocp</span><span class="p">)</span>
<a name="ln-421"></a>    <span class="k">end do</span>
<a name="ln-422"></a>
<a name="ln-423"></a><span class="k">    deallocate</span><span class="p">(</span><span class="n">thetah</span><span class="p">,</span> <span class="n">qth</span><span class="p">,</span> <span class="n">qlh</span><span class="p">)</span>
<a name="ln-424"></a>
<a name="ln-425"></a>    <span class="k">return</span>
<a name="ln-426"></a><span class="k">  end subroutine </span><span class="n">fromztop</span>
<a name="ln-427"></a>
<a name="ln-428"></a>  <span class="c">!&gt; Calculates liquid water content.</span>
<a name="ln-429"></a>  <span class="c">!!     Given theta_l and q_tot the liquid water content</span>
<a name="ln-430"></a>  <span class="c">!!     is calculated, making an &quot;all-or-nothing&quot; assumption.</span>
<a name="ln-431"></a>  <span class="c">!!     if lfull=true   ==&gt; ql at full levels on output</span>
<a name="ln-432"></a>  <span class="c">!!     if lfull=false  ==&gt; ql at half levels on output</span>
<a name="ln-433"></a>  <span class="c">!!</span>
<a name="ln-434"></a>  <span class="c">!! \author Hans Cuijpers   I.M.A.U.</span>
<a name="ln-435"></a>  <span class="c">!! \author Pier Siebesma   K.N.M.I.     06/01/1995</span>
<a name="ln-436"></a>  <span class="k">subroutine </span><span class="n">thermo</span> <span class="p">(</span><span class="n">thl</span><span class="p">,</span><span class="n">qt</span><span class="p">,</span><span class="n">ql</span><span class="p">,</span><span class="n">pressure</span><span class="p">,</span><span class="n">exner</span><span class="p">)</span>
<a name="ln-437"></a>
<a name="ln-438"></a>
<a name="ln-439"></a>
<a name="ln-440"></a>    <span class="c">!  use modglobal, only : ih,jh,i1,j1,k1,es0,at,bt,rd,rv,rlv,cp,tmelt</span>
<a name="ln-441"></a>    <span class="k">use </span><span class="n">modglobal</span><span class="p">,</span> <span class="n">only</span> <span class="p">:</span> <span class="n">ih</span><span class="p">,</span><span class="n">jh</span><span class="p">,</span><span class="n">ib</span><span class="p">,</span><span class="n">ie</span><span class="p">,</span><span class="n">jb</span><span class="p">,</span><span class="n">je</span><span class="p">,</span><span class="n">kb</span><span class="p">,</span><span class="n">ke</span><span class="p">,</span><span class="n">kh</span><span class="p">,</span><span class="n">es0</span><span class="p">,</span><span class="n">at</span><span class="p">,</span><span class="n">bt</span><span class="p">,</span><span class="n">rd</span><span class="p">,</span><span class="n">rv</span><span class="p">,</span><span class="n">rlv</span><span class="p">,</span><span class="n">cp</span><span class="p">,</span><span class="n">tmelt</span>
<a name="ln-442"></a>    <span class="k">use </span><span class="n">modsurfdata</span><span class="p">,</span> <span class="n">only</span> <span class="p">:</span> <span class="n">thls</span>
<a name="ln-443"></a>    <span class="k">implicit none</span>
<a name="ln-444"></a>
<a name="ln-445"></a><span class="k">    </span><span class="kt">integer </span><span class="n">i</span><span class="p">,</span> <span class="n">j</span><span class="p">,</span> <span class="n">k</span>
<a name="ln-446"></a>    <span class="kt">real </span><span class="n">tl</span><span class="p">,</span> <span class="n">es</span><span class="p">,</span> <span class="n">qs</span><span class="p">,</span> <span class="n">qsl</span><span class="p">,</span> <span class="n">b1</span>
<a name="ln-447"></a>    <span class="c">!  real, intent(in)  :: qt(ib-ih:ie+ih,jb-jh:je+jh,kb:ke+kh),thl(ib-ih:ie+ih,jb-jh:je+jh,kb:ke+kh),exner(kb:ke+kh),pressure(kb:ke+kh)</span>
<a name="ln-448"></a>    <span class="kt">real</span><span class="p">,</span> <span class="k">intent</span><span class="p">(</span><span class="n">in</span><span class="p">)</span>  <span class="kd">::</span> <span class="n">qt</span><span class="p">(</span><span class="n">ib</span><span class="o">-</span><span class="n">ih</span><span class="p">:</span><span class="n">ie</span><span class="o">+</span><span class="n">ih</span><span class="p">,</span><span class="n">jb</span><span class="o">-</span><span class="n">jh</span><span class="p">:</span><span class="n">je</span><span class="o">+</span><span class="n">jh</span><span class="p">,</span><span class="n">kb</span><span class="o">-</span><span class="n">kh</span><span class="p">:</span><span class="n">ke</span><span class="o">+</span><span class="n">kh</span><span class="p">),</span><span class="n">thl</span><span class="p">(</span><span class="n">ib</span><span class="o">-</span><span class="n">ih</span><span class="p">:</span><span class="n">ie</span><span class="o">+</span><span class="n">ih</span><span class="p">,</span><span class="n">jb</span><span class="o">-</span><span class="n">jh</span><span class="p">:</span><span class="n">je</span><span class="o">+</span><span class="n">jh</span><span class="p">,</span><span class="n">kb</span><span class="o">-</span><span class="n">kh</span><span class="p">:</span><span class="n">ke</span><span class="o">+</span><span class="n">kh</span><span class="p">),</span><span class="n">exner</span><span class="p">(</span><span class="n">kb</span><span class="p">:</span><span class="n">ke</span><span class="o">+</span><span class="n">kh</span><span class="p">),</span><span class="n">pressure</span><span class="p">(</span><span class="n">kb</span><span class="p">:</span><span class="n">ke</span><span class="o">+</span><span class="n">kh</span><span class="p">)</span>
<a name="ln-449"></a>    <span class="kt">real</span><span class="p">,</span> <span class="k">intent</span><span class="p">(</span><span class="n">out</span><span class="p">)</span> <span class="kd">::</span> <span class="n">ql</span><span class="p">(</span><span class="n">ib</span><span class="o">-</span><span class="n">ih</span><span class="p">:</span><span class="n">ie</span><span class="o">+</span><span class="n">ih</span><span class="p">,</span><span class="n">jb</span><span class="o">-</span><span class="n">jh</span><span class="p">:</span><span class="n">je</span><span class="o">+</span><span class="n">jh</span><span class="p">,</span><span class="n">kb</span><span class="p">:</span><span class="n">ke</span><span class="o">+</span><span class="n">kh</span><span class="p">)</span>
<a name="ln-450"></a>    <span class="kt">real</span> <span class="kd">::</span> <span class="n">Tnr</span><span class="p">,</span><span class="n">qsatur</span><span class="p">,</span><span class="n">Tnr_old</span>
<a name="ln-451"></a>    <span class="kt">integer</span> <span class="kd">::</span> <span class="n">niter</span><span class="p">,</span><span class="n">nitert</span>
<a name="ln-452"></a>
<a name="ln-453"></a>    <span class="k">if</span> <span class="p">(</span><span class="n">lqlnr</span><span class="p">)</span> <span class="k">then</span>
<a name="ln-454"></a>       <span class="c">!mc      calculation of T with Newton-Raphson method</span>
<a name="ln-455"></a>       <span class="c">!mc      first guess is Tnr=tl</span>
<a name="ln-456"></a>       <span class="c">!mc</span>
<a name="ln-457"></a>       <span class="n">nitert</span> <span class="o">=</span> <span class="mi">0</span>
<a name="ln-458"></a>       <span class="k">do </span><span class="n">k</span><span class="o">=</span><span class="n">kb</span><span class="p">,</span><span class="n">ke</span><span class="o">+</span><span class="n">kh</span>
<a name="ln-459"></a>          <span class="k">do </span><span class="n">j</span><span class="o">=</span><span class="n">jb</span><span class="p">,</span><span class="n">je</span>
<a name="ln-460"></a>             <span class="k">do </span><span class="n">i</span><span class="o">=</span><span class="n">ib</span><span class="p">,</span><span class="n">ie</span>
<a name="ln-461"></a>
<a name="ln-462"></a>                <span class="n">tl</span>  <span class="o">=</span> <span class="n">thl</span><span class="p">(</span><span class="n">i</span><span class="p">,</span><span class="n">j</span><span class="p">,</span><span class="n">k</span><span class="p">)</span><span class="o">*</span><span class="n">exner</span><span class="p">(</span><span class="n">k</span><span class="p">)</span>
<a name="ln-463"></a>                <span class="n">Tnr</span><span class="o">=</span><span class="n">tl</span>
<a name="ln-464"></a>                <span class="n">Tnr_old</span><span class="o">=</span><span class="mf">0.</span>
<a name="ln-465"></a>                <span class="k">do while</span> <span class="p">(</span><span class="nb">abs</span><span class="p">(</span><span class="n">Tnr</span><span class="o">-</span><span class="n">Tnr_old</span><span class="p">)</span><span class="o">/</span><span class="n">Tnr</span><span class="o">&gt;</span><span class="mf">1e-5</span><span class="p">)</span>
<a name="ln-466"></a>                   <span class="n">niter</span> <span class="o">=</span> <span class="n">niter</span><span class="o">+</span><span class="mi">1</span>
<a name="ln-467"></a>                   <span class="n">Tnr_old</span> <span class="o">=</span> <span class="n">Tnr</span>
<a name="ln-468"></a>                   <span class="n">es</span>    <span class="o">=</span> <span class="n">es0</span><span class="o">*</span><span class="nb">exp</span><span class="p">(</span><span class="n">at</span><span class="o">*</span><span class="p">(</span><span class="n">Tnr</span><span class="o">-</span><span class="n">tmelt</span><span class="p">)</span><span class="o">/</span><span class="p">(</span><span class="n">Tnr</span><span class="o">-</span><span class="n">bt</span><span class="p">))</span>
<a name="ln-469"></a>                   <span class="n">qsatur</span><span class="o">=</span> <span class="n">rd</span><span class="o">/</span><span class="n">rv</span><span class="o">*</span><span class="n">es</span><span class="o">/</span><span class="p">(</span><span class="n">pressure</span><span class="p">(</span><span class="n">k</span><span class="p">)</span><span class="o">-</span><span class="p">(</span><span class="mi">1</span><span class="o">-</span><span class="n">rd</span><span class="o">/</span><span class="n">rv</span><span class="p">)</span><span class="o">*</span><span class="n">es</span><span class="p">)</span>
<a name="ln-470"></a>                   <span class="n">Tnr</span> <span class="o">=</span> <span class="n">Tnr</span> <span class="o">-</span> <span class="p">(</span><span class="n">Tnr</span><span class="o">+</span><span class="p">(</span><span class="n">rlv</span><span class="o">/</span><span class="n">cp</span><span class="p">)</span><span class="o">*</span><span class="n">qsatur</span><span class="o">-</span><span class="n">tl</span><span class="o">-</span> <span class="p">&amp;</span>
<a name="ln-471"></a>                        <span class="p">(</span><span class="n">rlv</span><span class="o">/</span><span class="n">cp</span><span class="p">)</span><span class="o">*</span><span class="n">qt</span><span class="p">(</span><span class="n">i</span><span class="p">,</span><span class="n">j</span><span class="p">,</span><span class="n">k</span><span class="p">))</span><span class="o">/</span><span class="p">(</span><span class="mi">1</span><span class="o">+</span><span class="p">(</span><span class="n">rlv</span><span class="o">**</span><span class="mi">2</span><span class="o">*</span><span class="n">qsatur</span><span class="p">)</span><span class="o">/</span> <span class="p">&amp;</span>
<a name="ln-472"></a>                        <span class="p">(</span><span class="n">rv</span><span class="o">*</span><span class="n">cp</span><span class="o">*</span><span class="n">Tnr</span><span class="o">**</span><span class="mi">2</span><span class="p">))</span>
<a name="ln-473"></a>                <span class="k">end do</span>
<a name="ln-474"></a><span class="k">                </span><span class="n">nitert</span> <span class="o">=</span><span class="nb">max</span><span class="p">(</span><span class="n">nitert</span><span class="p">,</span><span class="n">niter</span><span class="p">)</span>
<a name="ln-475"></a>                <span class="n">niter</span> <span class="o">=</span> <span class="mi">0</span>
<a name="ln-476"></a>
<a name="ln-477"></a>                <span class="n">ql</span><span class="p">(</span><span class="n">i</span><span class="p">,</span><span class="n">j</span><span class="p">,</span><span class="n">k</span><span class="p">)</span> <span class="o">=</span> <span class="nb">dim</span><span class="p">(</span><span class="n">qt</span><span class="p">(</span><span class="n">i</span><span class="p">,</span><span class="n">j</span><span class="p">,</span><span class="n">k</span><span class="p">)</span><span class="o">-</span><span class="n">qsatur</span><span class="p">,</span><span class="mf">0.</span><span class="p">)</span>
<a name="ln-478"></a>
<a name="ln-479"></a>             <span class="k">end do</span>
<a name="ln-480"></a><span class="k">          end do</span>
<a name="ln-481"></a><span class="k">       end do</span>
<a name="ln-482"></a><span class="k">    else</span>
<a name="ln-483"></a>
<a name="ln-484"></a>
<a name="ln-485"></a><span class="k">       do </span><span class="n">k</span><span class="o">=</span><span class="n">kb</span><span class="p">,</span><span class="n">ke</span><span class="o">+</span><span class="n">kh</span>
<a name="ln-486"></a>          <span class="k">do </span><span class="n">j</span><span class="o">=</span><span class="n">jb</span><span class="p">,</span><span class="n">je</span>
<a name="ln-487"></a>             <span class="k">do </span><span class="n">i</span><span class="o">=</span><span class="n">ib</span><span class="p">,</span><span class="n">ie</span>
<a name="ln-488"></a>                <span class="n">tl</span>  <span class="o">=</span> <span class="n">thl</span><span class="p">(</span><span class="n">i</span><span class="p">,</span><span class="n">j</span><span class="p">,</span><span class="n">k</span><span class="p">)</span><span class="o">*</span><span class="n">exner</span><span class="p">(</span><span class="n">k</span><span class="p">)</span>
<a name="ln-489"></a>                <span class="n">es</span>  <span class="o">=</span> <span class="n">es0</span><span class="o">*</span><span class="nb">exp</span><span class="p">(</span><span class="n">at</span><span class="o">*</span><span class="p">(</span><span class="n">tl</span><span class="o">-</span><span class="n">tmelt</span><span class="p">)</span><span class="o">/</span><span class="p">(</span><span class="n">tl</span><span class="o">-</span><span class="n">bt</span><span class="p">))</span>
<a name="ln-490"></a>                <span class="n">qsl</span> <span class="o">=</span> <span class="n">rd</span><span class="o">/</span><span class="n">rv</span><span class="o">*</span><span class="n">es</span><span class="o">/</span><span class="p">(</span><span class="n">pressure</span><span class="p">(</span><span class="n">k</span><span class="p">)</span><span class="o">-</span><span class="p">(</span><span class="mi">1</span><span class="o">-</span><span class="n">rd</span><span class="o">/</span><span class="n">rv</span><span class="p">)</span><span class="o">*</span><span class="n">es</span><span class="p">)</span>
<a name="ln-491"></a>                <span class="n">b1</span>  <span class="o">=</span> <span class="n">rlv</span><span class="o">**</span><span class="mi">2</span><span class="o">/</span><span class="p">(</span><span class="n">tl</span><span class="o">**</span><span class="mi">2</span><span class="o">*</span><span class="n">cp</span><span class="o">*</span><span class="n">rv</span><span class="p">)</span>
<a name="ln-492"></a>                <span class="n">qs</span>  <span class="o">=</span> <span class="n">qsl</span><span class="o">*</span><span class="p">(</span><span class="mf">1.</span><span class="o">+</span><span class="n">b1</span><span class="o">*</span><span class="n">qt</span><span class="p">(</span><span class="n">i</span><span class="p">,</span><span class="n">j</span><span class="p">,</span><span class="n">k</span><span class="p">))</span><span class="o">/</span><span class="p">(</span><span class="mf">1.</span><span class="o">+</span><span class="n">b1</span><span class="o">*</span><span class="n">qsl</span><span class="p">)</span>
<a name="ln-493"></a>                <span class="n">ql</span><span class="p">(</span><span class="n">i</span><span class="p">,</span><span class="n">j</span><span class="p">,</span><span class="n">k</span><span class="p">)</span> <span class="o">=</span> <span class="nb">dim</span><span class="p">(</span><span class="n">qt</span><span class="p">(</span><span class="n">i</span><span class="p">,</span><span class="n">j</span><span class="p">,</span><span class="n">k</span><span class="p">)</span><span class="o">-</span><span class="n">qs</span><span class="p">,</span><span class="mf">0.</span><span class="p">)</span>
<a name="ln-494"></a>             <span class="k">end do</span>
<a name="ln-495"></a><span class="k">          end do</span>
<a name="ln-496"></a><span class="k">       end do</span>
<a name="ln-497"></a><span class="k">    end if</span>
<a name="ln-498"></a>
<a name="ln-499"></a><span class="k">    return</span>
<a name="ln-500"></a><span class="k">  end subroutine </span><span class="n">thermo</span>
<a name="ln-501"></a>
<a name="ln-502"></a>  <span class="c">!&gt; Calculates the scalars at half levels.</span>
<a name="ln-503"></a>  <span class="c">!! If the kappa advection scheme is active, interpolation needs to be done consistently.</span>
<a name="ln-504"></a>  <span class="k">subroutine </span><span class="n">calc_halflev</span>
<a name="ln-505"></a>    <span class="k">use </span><span class="n">modglobal</span><span class="p">,</span> <span class="n">only</span> <span class="p">:</span> <span class="n">ib</span><span class="p">,</span><span class="n">ie</span><span class="p">,</span><span class="n">jb</span><span class="p">,</span><span class="n">je</span><span class="p">,</span><span class="n">kb</span><span class="p">,</span><span class="n">ke</span><span class="p">,</span><span class="n">kh</span><span class="p">,</span><span class="n">dzf</span><span class="p">,</span><span class="n">dzh</span><span class="p">,</span><span class="n">iadv_thl</span><span class="p">,</span> <span class="n">iadv_qt</span><span class="p">,</span> <span class="n">iadv_kappa</span>
<a name="ln-506"></a>    <span class="k">use </span><span class="n">modfields</span><span class="p">,</span> <span class="n">only</span> <span class="p">:</span> <span class="n">thl0</span><span class="p">,</span><span class="n">thl0h</span><span class="p">,</span><span class="n">qt0</span><span class="p">,</span><span class="n">qt0h</span>
<a name="ln-507"></a>    <span class="k">use </span><span class="n">modsurfdata</span><span class="p">,</span><span class="n">only</span><span class="p">:</span> <span class="n">qts</span><span class="p">,</span><span class="n">thls</span>
<a name="ln-508"></a>    <span class="k">implicit none</span>
<a name="ln-509"></a>
<a name="ln-510"></a><span class="k">    </span><span class="kt">integer</span> <span class="kd">::</span> <span class="n">i</span><span class="p">,</span><span class="n">j</span><span class="p">,</span><span class="n">k</span>
<a name="ln-511"></a>
<a name="ln-512"></a>
<a name="ln-513"></a>    <span class="c">!      do  k=kb+1,ke+kh</span>
<a name="ln-514"></a>    <span class="k">do  </span><span class="n">k</span><span class="o">=</span><span class="n">kb</span><span class="p">,</span><span class="n">ke</span><span class="o">+</span><span class="n">kh</span>
<a name="ln-515"></a>       <span class="k">do  </span><span class="n">j</span><span class="o">=</span><span class="n">jb</span><span class="p">,</span><span class="n">je</span>
<a name="ln-516"></a>          <span class="k">do  </span><span class="n">i</span><span class="o">=</span><span class="n">ib</span><span class="p">,</span><span class="n">ie</span>
<a name="ln-517"></a>             <span class="n">thl0h</span><span class="p">(</span><span class="n">i</span><span class="p">,</span><span class="n">j</span><span class="p">,</span><span class="n">k</span><span class="p">)</span> <span class="o">=</span> <span class="p">(</span><span class="n">thl0</span><span class="p">(</span><span class="n">i</span><span class="p">,</span><span class="n">j</span><span class="p">,</span><span class="n">k</span><span class="p">)</span><span class="o">*</span><span class="n">dzf</span><span class="p">(</span><span class="n">k</span><span class="o">-</span><span class="mi">1</span><span class="p">)</span><span class="o">+</span><span class="n">thl0</span><span class="p">(</span><span class="n">i</span><span class="p">,</span><span class="n">j</span><span class="p">,</span><span class="n">k</span><span class="o">-</span><span class="mi">1</span><span class="p">)</span><span class="o">*</span><span class="n">dzf</span><span class="p">(</span><span class="n">k</span><span class="p">))</span><span class="o">/</span><span class="p">(</span><span class="mi">2</span><span class="o">*</span><span class="n">dzh</span><span class="p">(</span><span class="n">k</span><span class="p">))</span>
<a name="ln-518"></a>          <span class="k">end do</span>
<a name="ln-519"></a><span class="k">       end do</span>
<a name="ln-520"></a>
<a name="ln-521"></a><span class="k">    end do</span>
<a name="ln-522"></a><span class="k">        </span><span class="n">thl0h</span><span class="p">(</span><span class="n">ib</span><span class="p">:</span><span class="n">ie</span><span class="p">,</span><span class="n">jb</span><span class="p">:</span><span class="n">je</span><span class="p">,</span><span class="n">kb</span><span class="p">)</span> <span class="o">=</span> <span class="n">thls</span>
<a name="ln-523"></a>
<a name="ln-524"></a>    <span class="c">!      do  k=kb+1,ke+kh</span>
<a name="ln-525"></a>    <span class="k">do  </span><span class="n">k</span><span class="o">=</span><span class="n">kb</span><span class="p">,</span><span class="n">ke</span><span class="o">+</span><span class="n">kh</span>
<a name="ln-526"></a>       <span class="k">do  </span><span class="n">j</span><span class="o">=</span><span class="n">jb</span><span class="p">,</span><span class="n">je</span>
<a name="ln-527"></a>          <span class="k">do  </span><span class="n">i</span><span class="o">=</span><span class="n">ib</span><span class="p">,</span><span class="n">ie</span>
<a name="ln-528"></a>             <span class="n">qt0h</span><span class="p">(</span><span class="n">i</span><span class="p">,</span><span class="n">j</span><span class="p">,</span><span class="n">k</span><span class="p">)</span>  <span class="o">=</span> <span class="p">(</span><span class="n">qt0</span> <span class="p">(</span><span class="n">i</span><span class="p">,</span><span class="n">j</span><span class="p">,</span><span class="n">k</span><span class="p">)</span><span class="o">*</span><span class="n">dzf</span><span class="p">(</span><span class="n">k</span><span class="o">-</span><span class="mi">1</span><span class="p">)</span><span class="o">+</span><span class="n">qt0</span> <span class="p">(</span><span class="n">i</span><span class="p">,</span><span class="n">j</span><span class="p">,</span><span class="n">k</span><span class="o">-</span><span class="mi">1</span><span class="p">)</span><span class="o">*</span><span class="n">dzf</span><span class="p">(</span><span class="n">k</span><span class="p">))</span><span class="o">/</span><span class="p">(</span><span class="mi">2</span><span class="o">*</span><span class="n">dzh</span><span class="p">(</span><span class="n">k</span><span class="p">))</span>
<a name="ln-529"></a>          <span class="k">end do</span>
<a name="ln-530"></a><span class="k">       end do</span>
<a name="ln-531"></a><span class="k">    end do</span>
<a name="ln-532"></a><span class="k">          </span><span class="n">qt0h</span><span class="p">(</span><span class="n">ib</span><span class="p">:</span><span class="n">ie</span><span class="p">,</span><span class="n">jb</span><span class="p">:</span><span class="n">je</span><span class="p">,</span><span class="n">kb</span><span class="p">)</span>  <span class="o">=</span> <span class="n">qts</span>
<a name="ln-533"></a>
<a name="ln-534"></a>  <span class="k">end subroutine </span><span class="n">calc_halflev</span>
<a name="ln-535"></a>
<a name="ln-536"></a><span class="k">end module </span><span class="n">modthermodynamics</span>
</pre></div>

    </section>
    </div>
  </div>

  
    <hr>    
    </div> <!-- /container -->
    <footer>
      <div class="container">
      <div class="row">
        <div class="col-xs-6 col-md-4"><p>&copy; 2021 
                                          </p></div>
        <div class="col-xs-6 col-md-4 col-md-push-4">
          <p class="text-right">
            Documentation generated by 
            <a href="https://github.com/cmacmackin/ford">FORD</a>
            
          </p>
        </div>
        <div class="col-xs-12 col-md-4 col-md-pull-4"><p class="text-center"> uDALES was developed by The uDALES Team</p></div>
      </div>
      <br>
      </div> <!-- /container -->    
    </footer>

    <!-- Bootstrap core JavaScript
    ================================================== -->
    <!-- Placed at the end of the document so the pages load faster -->
<!--
    <script src="https://ajax.googleapis.com/ajax/libs/jquery/1.11.1/jquery.min.js"></script>
-->
    <script src="../js/bootstrap.min.js"></script>
    <!-- IE10 viewport hack for Surface/desktop Windows 8 bug -->
    <script src="../js/ie10-viewport-bug-workaround.js"></script>

    <!-- MathJax JavaScript
    ================================================== -->
    <!-- Placed at the end of the document so the pages load faster -->
    <script type="text/x-mathjax-config">
      MathJax.Hub.Config({
        TeX: { extensions: ['AMSmath.js','AMSsymbols.js','noErrors.js','noUndefined.js'], equationNumbers: { autoNumber: 'AMS' } },
        jax: ['input/TeX','input/MathML','output/HTML-CSS'],
        extensions: ['tex2jax.js','mml2jax.js','MathMenu.js','MathZoom.js']
      });
    </script>
    
    <script src="https://cdnjs.cloudflare.com/ajax/libs/mathjax/2.7.1/MathJax.js?config=TeX-AMS-MML_HTMLorMML"></script>
    
    
    <script src="../tipuesearch/tipuesearch_content.js"></script>
    <script src="../tipuesearch/tipuesearch_set.js"></script>
    <script src="../tipuesearch/tipuesearch.js"></script>
    
    
  </body>
</html>