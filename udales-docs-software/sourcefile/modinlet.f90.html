<!DOCTYPE html>
<html lang="en">
  <head>
    <meta charset="utf-8">
    <meta http-equiv="X-UA-Compatible" content="IE=edge">
    <meta name="viewport" content="width=device-width, initial-scale=1">
   
    <meta name="description" content="Documentation for uDALES">
   
    <meta name="author" content="The uDALES Team" >
    <link rel="icon" href="../favicon.png">

    <title>modinlet.f90 &ndash; uDALES</title>

    <link href="../css/bootstrap.min.css" rel="stylesheet">
    <link href="../css/pygments.css" rel="stylesheet">
    <link href="../css/font-awesome.min.css" rel="stylesheet">
    <link href="../css/local.css" rel="stylesheet">
    
    <link  href="../tipuesearch/tipuesearch.css" rel="stylesheet">
    
    

    <!-- HTML5 shim and Respond.js for IE8 support of HTML5 elements and media queries -->
    <!--[if lt IE 9]>
      <script src="https://oss.maxcdn.com/html5shiv/3.7.2/html5shiv.min.js"></script>
      <script src="https://oss.maxcdn.com/respond/1.4.2/respond.min.js"></script>
    <![endif]-->
    
    <script src="../js/jquery-2.1.3.min.js"></script>
    <script src="../js/svg-pan-zoom.min.js"></script>

  </head>

  <body>

    <!-- Fixed navbar -->
    <nav class="navbar navbar-inverse navbar-fixed-top">
      <div class="container">
        <div class="navbar-header">
          <button type="button" class="navbar-toggle collapsed" data-toggle="collapse" data-target="#navbar" aria-expanded="false" aria-controls="navbar">
            <span class="sr-only">Toggle navigation</span>
            <span class="icon-bar"></span>
            <span class="icon-bar"></span>
            <span class="icon-bar"></span>
          </button>
          <a class="navbar-brand" href="../index.html">uDALES </a>
        </div>
        <div id="navbar" class="navbar-collapse collapse">
          <ul class="nav navbar-nav">
        
            <li class="dropdown hidden-xs visible-sm visible-md hidden-lg">
              <a href="#" class="dropdown-toggle"
              data-toggle="dropdown" role="button"
              aria-haspopup="true"
     aria-expanded="false">Contents <span class="caret"></span></a>
        <ul class="dropdown-menu">
          
              
            <li><a href="../lists/files.html">Source Files</a></li>
        
        
        
            <li><a href="../lists/modules.html">Modules</a></li>
        
            
                                
            <li><a href="../lists/procedures.html">Procedures</a></li>
        
               
            <li><a href="../lists/types.html">Derived Types</a></li>
        
        
            <li><a href="../program/dalesurban.html">Program</a></li>
      
            </ul>
            </li>


<li class="visible-xs hidden-sm visible-lg"><a href="../lists/files.html">Source Files</a></li>



<li class="visible-xs hidden-sm visible-lg"><a href="../lists/modules.html">Modules</a></li>



<li class="visible-xs hidden-sm visible-lg"><a href="../lists/procedures.html">Procedures</a></li>

                             
<li class="visible-xs hidden-sm visible-lg"><a href="../lists/types.html">Derived Types</a></li>


<li class="visible-xs hidden-sm visible-lg"><a href="../program/dalesurban.html">Program</a></li>

          </ul>
        
        <form action="../search.html" class="navbar-form navbar-right" role="search">
        <div class="form-group">
          <input type="text" class="form-control" placeholder="Search" name="q" id="tipue_search_input" autocomplete="off" required>
        </div>
<!--
        <button type="submit" class="btn btn-default">Submit</button>
-->
        </form>
        
        </div><!--/.nav-collapse -->
      </div>
    </nav>

    <div class="container">
    
  
  <div class="row">
    <h1>modinlet.f90
    <small>Source File</small>
    
    </h1>
    
<div class="row">
  <div class="col-lg-12">
<div class="well well-sm">
  <ul class="list-inline" style="margin-bottom:0px;display:inline">
     
     
     
     
    
    
     <li><i class="fa fa-list-ol"></i>
       <a data-toggle="tooltip"
    data-placement="bottom" data-html="true"
    title="12.7% of total for source files.">1798 statements</a>
     </li> 
     
     
     
    <li><i class="fa fa-code"></i><a href="../src/modinlet.f90"> Source File</a></li>
     
     
  </ul>
  <ol class="breadcrumb in-well text-right">
  
    
  
     <li class="active">modinlet.f90</li>
  </ol>
</div>
</div>
</div>
<script>
  $(function () {
  $('[data-toggle="tooltip"]').tooltip()
  })
</script>

  </div>
  <div class="row">
    <div class="col-md-3 hidden-xs hidden-sm visible-md visible-lg">
    
<div id="sidebar">
  
<h3>Contents</h3>
 







<div class="panel panel-primary">
  <div class="panel-heading text-left"><h3 class="panel-title"><a data-toggle="collapse" href="#mods-0">Modules</a></h3></div>
  <div id="mods-0" class="panel-collapse collapse">
    <div class="list-group">
      
      <a class="list-group-item" href="../module/modinlet.html">modinlet</a>
      
    </div>
  </div>
</div>
















<div class="panel panel-primary">
  <div class="panel-heading text-left"><h3 class="panel-title">Source Code</h3></div>
  <div class="list-group">
    <a class="list-group-item" href="../sourcefile/modinlet.f90.html#src">modinlet.f90</a>
  </div>
</div>



</div>

    </div>
    <div class="col-md-9" id='text'>
      
      <br>
    
    <div class="panel panel-default">
      <div class="panel-heading">
  <h3 class="panel-title">This file depends on</h3>
      </div>
      <div class="panel-body">
  <div class="depgraph"><?xml version="1.0" encoding="UTF-8" standalone="no"?>
<!DOCTYPE svg PUBLIC "-//W3C//DTD SVG 1.1//EN"
 "http://www.w3.org/Graphics/SVG/1.1/DTD/svg11.dtd">
<!-- Generated by graphviz version 2.40.1 (20161225.0304)
 -->
<!-- Title: sourcefile~~modinlet.f90~~EfferentGraph Pages: 1 -->
<svg id="sourcefilemodinletf90EfferentGraph" width="554pt" height="409pt"
 viewBox="0.00 0.00 554.00 408.88" xmlns="http://www.w3.org/2000/svg" xmlns:xlink="http://www.w3.org/1999/xlink">
<g id="sourcefile~~modinlet.f90~~EfferentGraph" class="graph" transform="scale(1 1) rotate(0) translate(4 404.8778)">
<title>sourcefile~~modinlet.f90~~EfferentGraph</title>
<polygon fill="#ffffff" stroke="transparent" points="-4,4 -4,-404.8778 550,-404.8778 550,4 -4,4"/>
<!-- sourcefile~modinlet.f90 -->
<g id="sourcefile~~modinlet.f90~~EfferentGraph_node1" class="node">
<title>sourcefile~modinlet.f90</title>
<polygon fill="none" stroke="#000000" points="546,-212.4237 475,-212.4237 475,-188.4237 546,-188.4237 546,-212.4237"/>
<text text-anchor="middle" x="510.5" y="-198.0237" font-family="Helvetica,sans-Serif" font-size="10.50" fill="#000000">modinlet.f90</text>
</g>
<!-- sourcefile~modsurfdata.f90 -->
<g id="sourcefile~~modinlet.f90~~EfferentGraph_node2" class="node">
<title>sourcefile~modsurfdata.f90</title>
<g id="a_sourcefile~~modinlet.f90~~EfferentGraph_node2"><a xlink:href=".././sourcefile/modsurfdata.f90.html" xlink:title="modsurfdata.f90">
<polygon fill="#f0ad4e" stroke="#f0ad4e" points="320.5,-355.4237 229.5,-355.4237 229.5,-331.4237 320.5,-331.4237 320.5,-355.4237"/>
<text text-anchor="middle" x="275" y="-341.0237" font-family="Helvetica,sans-Serif" font-size="10.50" fill="#ffffff">modsurfdata.f90</text>
</a>
</g>
</g>
<!-- sourcefile~modinlet.f90&#45;&gt;sourcefile~modsurfdata.f90 -->
<g id="sourcefile~~modinlet.f90~~EfferentGraph_edge1" class="edge">
<title>sourcefile~modinlet.f90&#45;&gt;sourcefile~modsurfdata.f90</title>
<path fill="none" stroke="#ff0000" stroke-dasharray="5,2" d="M402,-383.4237C385.0099,-389.8744 340.9812,-373.3116 309.5372,-359.5715"/>
<polygon fill="#ff0000" stroke="#ff0000" points="310.7857,-356.2962 300.2266,-355.4266 307.9387,-362.6911 310.7857,-356.2962"/>
</g>
<!-- sourcefile~modinletdata.f90 -->
<g id="sourcefile~~modinlet.f90~~EfferentGraph_node3" class="node">
<title>sourcefile~modinletdata.f90</title>
<g id="a_sourcefile~~modinlet.f90~~EfferentGraph_node3"><a xlink:href=".././sourcefile/modinletdata.f90.html" xlink:title="modinletdata.f90">
<polygon fill="#f0ad4e" stroke="#f0ad4e" points="321,-313.4237 229,-313.4237 229,-289.4237 321,-289.4237 321,-313.4237"/>
<text text-anchor="middle" x="275" y="-299.0237" font-family="Helvetica,sans-Serif" font-size="10.50" fill="#ffffff">modinletdata.f90</text>
</a>
</g>
</g>
<!-- sourcefile~modinlet.f90&#45;&gt;sourcefile~modinletdata.f90 -->
<g id="sourcefile~~modinlet.f90~~EfferentGraph_edge2" class="edge">
<title>sourcefile~modinlet.f90&#45;&gt;sourcefile~modinletdata.f90</title>
<path fill="none" stroke="#ff0000" stroke-dasharray="5,2" d="M508.4246,-212.5765C501.4476,-248.8754 475.0313,-355.6957 402,-383.4237"/>
<path fill="none" stroke="#ff0000" stroke-dasharray="5,2" d="M402,-383.4237C362.4724,-398.4313 365.4053,-343.9251 329,-322.4237 326.1851,-320.7612 323.2146,-319.1824 320.1734,-317.6928"/>
<polygon fill="#ff0000" stroke="#ff0000" points="321.4753,-314.4401 310.9225,-313.4971 318.5839,-320.8151 321.4753,-314.4401"/>
</g>
<!-- sourcefile~modfields.f90 -->
<g id="sourcefile~~modinlet.f90~~EfferentGraph_node4" class="node">
<title>sourcefile~modfields.f90</title>
<g id="a_sourcefile~~modinlet.f90~~EfferentGraph_node4"><a xlink:href=".././sourcefile/modfields.f90.html" xlink:title="modfields.f90">
<polygon fill="#f0ad4e" stroke="#f0ad4e" points="313,-69.4237 237,-69.4237 237,-45.4237 313,-45.4237 313,-69.4237"/>
<text text-anchor="middle" x="275" y="-55.0237" font-family="Helvetica,sans-Serif" font-size="10.50" fill="#ffffff">modfields.f90</text>
</a>
</g>
</g>
<!-- sourcefile~modinlet.f90&#45;&gt;sourcefile~modfields.f90 -->
<g id="sourcefile~~modinlet.f90~~EfferentGraph_edge3" class="edge">
<title>sourcefile~modinlet.f90&#45;&gt;sourcefile~modfields.f90</title>
<path fill="none" stroke="#ff0000" stroke-dasharray="5,2" d="M402,-17.4237C385.4131,-9.6208 340.6365,-26.8374 308.9634,-41.0686"/>
<polygon fill="#ff0000" stroke="#ff0000" points="307.2337,-38.0112 299.6002,-45.3584 310.1493,-44.3751 307.2337,-38.0112"/>
</g>
<!-- sourcefile~modsave.f90 -->
<g id="sourcefile~~modinlet.f90~~EfferentGraph_node5" class="node">
<title>sourcefile~modsave.f90</title>
<g id="a_sourcefile~~modinlet.f90~~EfferentGraph_node5"><a xlink:href=".././sourcefile/modsave.f90.html" xlink:title="modsave.f90">
<polygon fill="#f0ad4e" stroke="#f0ad4e" points="439,-212.4237 365,-212.4237 365,-188.4237 439,-188.4237 439,-212.4237"/>
<text text-anchor="middle" x="402" y="-198.0237" font-family="Helvetica,sans-Serif" font-size="10.50" fill="#ffffff">modsave.f90</text>
</a>
</g>
</g>
<!-- sourcefile~modinlet.f90&#45;&gt;sourcefile~modsave.f90 -->
<g id="sourcefile~~modinlet.f90~~EfferentGraph_edge4" class="edge">
<title>sourcefile~modinlet.f90&#45;&gt;sourcefile~modsave.f90</title>
<path fill="none" stroke="#ff0000" stroke-dasharray="5,2" d="M474.973,-200.4237C466.7107,-200.4237 457.788,-200.4237 449.1131,-200.4237"/>
<polygon fill="#ff0000" stroke="#ff0000" points="449.0977,-196.9238 439.0977,-200.4237 449.0976,-203.9238 449.0977,-196.9238"/>
</g>
<!-- sourcefile~modglobal.f90 -->
<g id="sourcefile~~modinlet.f90~~EfferentGraph_node6" class="node">
<title>sourcefile~modglobal.f90</title>
<g id="a_sourcefile~~modinlet.f90~~EfferentGraph_node6"><a xlink:href=".././sourcefile/modglobal.f90.html" xlink:title="modglobal.f90">
<polygon fill="#f0ad4e" stroke="#f0ad4e" points="185,-109.4237 105,-109.4237 105,-85.4237 185,-85.4237 185,-109.4237"/>
<text text-anchor="middle" x="145" y="-95.0237" font-family="Helvetica,sans-Serif" font-size="10.50" fill="#ffffff">modglobal.f90</text>
</a>
</g>
</g>
<!-- sourcefile~modinlet.f90&#45;&gt;sourcefile~modglobal.f90 -->
<g id="sourcefile~~modinlet.f90~~EfferentGraph_edge5" class="edge">
<title>sourcefile~modinlet.f90&#45;&gt;sourcefile~modglobal.f90</title>
<path fill="none" stroke="#ff0000" stroke-dasharray="5,2" d="M508.1032,-188.2725C500.3673,-152.9184 472.3528,-50.5195 402,-17.4237"/>
<path fill="none" stroke="#ff0000" stroke-dasharray="5,2" d="M402,-17.4237C328.8078,17.0077 295.7983,-5.6368 221,-36.4237 198.4266,-45.7149 177.157,-63.9094 162.8918,-78.0201"/>
<polygon fill="#ff0000" stroke="#ff0000" points="160.2087,-75.758 155.7235,-85.3567 165.2155,-80.65 160.2087,-75.758"/>
</g>
<!-- sourcefile~modmpi.f90 -->
<g id="sourcefile~~modinlet.f90~~EfferentGraph_node7" class="node">
<title>sourcefile~modmpi.f90</title>
<g id="a_sourcefile~~modinlet.f90~~EfferentGraph_node7"><a xlink:href=".././sourcefile/modmpi.f90.html" xlink:title="modmpi.f90">
<polygon fill="#f0ad4e" stroke="#f0ad4e" points="69,-191.4237 0,-191.4237 0,-167.4237 69,-167.4237 69,-191.4237"/>
<text text-anchor="middle" x="34.5" y="-177.0237" font-family="Helvetica,sans-Serif" font-size="10.50" fill="#ffffff">modmpi.f90</text>
</a>
</g>
</g>
<!-- sourcefile~modinlet.f90&#45;&gt;sourcefile~modmpi.f90 -->
<g id="sourcefile~~modinlet.f90~~EfferentGraph_edge6" class="edge">
<title>sourcefile~modinlet.f90&#45;&gt;sourcefile~modmpi.f90</title>
<path fill="none" stroke="#ff0000" stroke-dasharray="5,2" d="M402,-383.4237C326.3805,-412.1345 291.2009,-404.604 221,-364.4237 171.6249,-336.1634 196.9662,-284.5766 145,-261.4237"/>
</g>
<!-- sourcefile~modfields.f90&#45;&gt;sourcefile~modglobal.f90 -->
<g id="sourcefile~~modinlet.f90~~EfferentGraph_edge7" class="edge">
<title>sourcefile~modfields.f90&#45;&gt;sourcefile~modglobal.f90</title>
<path fill="none" stroke="#00ff00" stroke-dasharray="5,2" d="M236.6988,-69.2087C223.3112,-73.328 208.0946,-78.01 193.9578,-82.3598"/>
<polygon fill="#00ff00" stroke="#00ff00" points="192.9076,-79.0209 184.3792,-85.3071 194.9663,-85.7114 192.9076,-79.0209"/>
</g>
<!-- sourcefile~modsave.f90&#45;&gt;sourcefile~modsurfdata.f90 -->
<g id="sourcefile~~modinlet.f90~~EfferentGraph_edge10" class="edge">
<title>sourcefile~modsave.f90&#45;&gt;sourcefile~modsurfdata.f90</title>
<path fill="none" stroke="#00ffff" stroke-dasharray="5,2" d="M397.8048,-212.6141C388.8811,-236.839 365.7745,-291.3712 329,-322.4237 327.4437,-323.7379 325.7957,-324.9756 324.0803,-326.1406"/>
<polygon fill="#00ffff" stroke="#00ffff" points="321.9463,-323.3323 315.0536,-331.3785 325.4595,-329.3868 321.9463,-323.3323"/>
</g>
<!-- sourcefile~modsave.f90&#45;&gt;sourcefile~modinletdata.f90 -->
<g id="sourcefile~~modinlet.f90~~EfferentGraph_edge11" class="edge">
<title>sourcefile~modsave.f90&#45;&gt;sourcefile~modinletdata.f90</title>
<path fill="none" stroke="#00ffff" stroke-dasharray="5,2" d="M392.4515,-212.6191C379.4453,-228.622 354.8091,-256.8492 329,-275.4237 324.4078,-278.7287 319.3303,-281.8026 314.1806,-284.5946"/>
<polygon fill="#00ffff" stroke="#00ffff" points="312.2485,-281.6506 304.9228,-289.3047 315.4227,-287.8896 312.2485,-281.6506"/>
</g>
<!-- sourcefile~modsave.f90&#45;&gt;sourcefile~modfields.f90 -->
<g id="sourcefile~~modinlet.f90~~EfferentGraph_edge12" class="edge">
<title>sourcefile~modsave.f90&#45;&gt;sourcefile~modfields.f90</title>
<path fill="none" stroke="#00ffff" stroke-dasharray="5,2" d="M397.1642,-188.2579C387.426,-165.1045 363.407,-114.2675 329,-83.4237 325.3198,-80.1247 321.1462,-77.1548 316.7891,-74.5054"/>
<polygon fill="#00ffff" stroke="#00ffff" points="318.138,-71.2535 307.6867,-69.5148 314.7726,-77.3914 318.138,-71.2535"/>
</g>
<!-- sourcefile~modsave.f90&#45;&gt;sourcefile~modglobal.f90 -->
<g id="sourcefile~~modinlet.f90~~EfferentGraph_edge14" class="edge">
<title>sourcefile~modsave.f90&#45;&gt;sourcefile~modglobal.f90</title>
<path fill="none" stroke="#00ffff" stroke-dasharray="5,2" d="M395.4112,-188.1168C384.4573,-169.0369 360.5473,-132.8124 329,-116.4237 287.5356,-94.8832 233.7676,-91.6904 195.0755,-92.9475"/>
<polygon fill="#00ffff" stroke="#00ffff" points="194.9222,-89.4508 185.0834,-93.3812 195.2258,-96.4442 194.9222,-89.4508"/>
</g>
<!-- sourcefile~modsave.f90&#45;&gt;sourcefile~modmpi.f90 -->
<g id="sourcefile~~modinlet.f90~~EfferentGraph_edge15" class="edge">
<title>sourcefile~modsave.f90&#45;&gt;sourcefile~modmpi.f90</title>
<path fill="none" stroke="#00ffff" stroke-dasharray="5,2" d="M385.5519,-212.5949C371.3456,-222.4204 349.8701,-235.681 329,-242.4237 250.769,-267.6986 219.9724,-295.1588 145,-261.4237"/>
</g>
<!-- sourcefile~modsubgriddata.f90 -->
<g id="sourcefile~~modinlet.f90~~EfferentGraph_node8" class="node">
<title>sourcefile~modsubgriddata.f90</title>
<g id="a_sourcefile~~modinlet.f90~~EfferentGraph_node8"><a xlink:href=".././sourcefile/modsubgriddata.f90.html" xlink:title="modsubgriddata.f90">
<polygon fill="#f0ad4e" stroke="#f0ad4e" points="329,-191.4237 221,-191.4237 221,-167.4237 329,-167.4237 329,-191.4237"/>
<text text-anchor="middle" x="275" y="-177.0237" font-family="Helvetica,sans-Serif" font-size="10.50" fill="#ffffff">modsubgriddata.f90</text>
</a>
</g>
</g>
<!-- sourcefile~modsave.f90&#45;&gt;sourcefile~modsubgriddata.f90 -->
<g id="sourcefile~~modinlet.f90~~EfferentGraph_edge9" class="edge">
<title>sourcefile~modsave.f90&#45;&gt;sourcefile~modsubgriddata.f90</title>
<path fill="none" stroke="#00ffff" stroke-dasharray="5,2" d="M364.9249,-194.2932C356.8393,-192.9562 348.058,-191.5042 339.2573,-190.049"/>
<polygon fill="#00ffff" stroke="#00ffff" points="339.7858,-186.5889 329.3487,-188.4105 338.6438,-193.4951 339.7858,-186.5889"/>
</g>
<!-- sourcefile~modibmdata.f90 -->
<g id="sourcefile~~modinlet.f90~~EfferentGraph_node9" class="node">
<title>sourcefile~modibmdata.f90</title>
<g id="a_sourcefile~~modinlet.f90~~EfferentGraph_node9"><a xlink:href=".././sourcefile/modibmdata.f90.html" xlink:title="modibmdata.f90">
<polygon fill="#f0ad4e" stroke="#f0ad4e" points="320,-149.4237 230,-149.4237 230,-125.4237 320,-125.4237 320,-149.4237"/>
<text text-anchor="middle" x="275" y="-135.0237" font-family="Helvetica,sans-Serif" font-size="10.50" fill="#ffffff">modibmdata.f90</text>
</a>
</g>
</g>
<!-- sourcefile~modsave.f90&#45;&gt;sourcefile~modibmdata.f90 -->
<g id="sourcefile~~modinlet.f90~~EfferentGraph_edge8" class="edge">
<title>sourcefile~modsave.f90&#45;&gt;sourcefile~modibmdata.f90</title>
<path fill="none" stroke="#00ffff" stroke-dasharray="5,2" d="M382.9101,-188.3756C368.427,-179.4993 347.859,-167.4522 329,-158.4237 325.4276,-156.7135 321.6766,-155.0325 317.8865,-153.4123"/>
<polygon fill="#00ffff" stroke="#00ffff" points="319.0434,-150.1036 308.4642,-149.528 316.3754,-156.5752 319.0434,-150.1036"/>
</g>
<!-- sourcefile~initfac.f90 -->
<g id="sourcefile~~modinlet.f90~~EfferentGraph_node10" class="node">
<title>sourcefile~initfac.f90</title>
<g id="a_sourcefile~~modinlet.f90~~EfferentGraph_node10"><a xlink:href=".././sourcefile/initfac.f90.html" xlink:title="initfac.f90">
<polygon fill="#f0ad4e" stroke="#f0ad4e" points="304,-233.4237 246,-233.4237 246,-209.4237 304,-209.4237 304,-233.4237"/>
<text text-anchor="middle" x="275" y="-219.0237" font-family="Helvetica,sans-Serif" font-size="10.50" fill="#ffffff">initfac.f90</text>
</a>
</g>
</g>
<!-- sourcefile~modsave.f90&#45;&gt;sourcefile~initfac.f90 -->
<g id="sourcefile~~modinlet.f90~~EfferentGraph_edge13" class="edge">
<title>sourcefile~modsave.f90&#45;&gt;sourcefile~initfac.f90</title>
<path fill="none" stroke="#00ffff" stroke-dasharray="5,2" d="M364.9249,-206.5543C349.0694,-209.176 330.5387,-212.2402 314.4324,-214.9034"/>
<polygon fill="#00ffff" stroke="#00ffff" points="313.546,-211.5024 304.251,-216.587 314.688,-218.4086 313.546,-211.5024"/>
</g>
<!-- sourcefile~modglobal.f90&#45;&gt;sourcefile~modmpi.f90 -->
<g id="sourcefile~~modinlet.f90~~EfferentGraph_edge16" class="edge">
<title>sourcefile~modglobal.f90&#45;&gt;sourcefile~modmpi.f90</title>
<path fill="none" stroke="#0000ff" stroke-dasharray="5,2" d="M128.6953,-109.5231C110.3334,-123.1492 80.2946,-145.4404 59.0828,-161.1813"/>
<polygon fill="#0000ff" stroke="#0000ff" points="56.8162,-158.5048 50.8715,-167.2747 60.9877,-164.1261 56.8162,-158.5048"/>
</g>
<!-- sourcefile~initfac.f90&#45;&gt;sourcefile~modglobal.f90 -->
<g id="sourcefile~~modinlet.f90~~EfferentGraph_edge17" class="edge">
<title>sourcefile~initfac.f90&#45;&gt;sourcefile~modglobal.f90</title>
<path fill="none" stroke="#0000ff" stroke-dasharray="5,2" d="M245.9594,-213.5334C237.3917,-210.3399 228.3503,-206.0464 221,-200.4237 191.8099,-178.0948 168.6175,-141.6317 155.8552,-118.6137"/>
<polygon fill="#0000ff" stroke="#0000ff" points="158.8554,-116.8027 151.0372,-109.6524 152.69,-120.1176 158.8554,-116.8027"/>
</g>
<!-- sourcefile~initfac.f90&#45;&gt;sourcefile~modmpi.f90 -->
<g id="sourcefile~~modinlet.f90~~EfferentGraph_edge18" class="edge">
<title>sourcefile~initfac.f90&#45;&gt;sourcefile~modmpi.f90</title>
<path fill="none" stroke="#0000ff" stroke-dasharray="5,2" d="M249.8509,-233.4496C217.6727,-248.097 163.8423,-269.9021 145,-261.4237"/>
<path fill="none" stroke="#0000ff" stroke-dasharray="5,2" d="M145,-261.4237C109.9971,-245.6736 75.4042,-217.393 54.4948,-198.5149"/>
<polygon fill="#0000ff" stroke="#0000ff" points="56.6506,-195.7423 46.9224,-191.5455 51.9101,-200.8929 56.6506,-195.7423"/>
</g>
</g>
</svg>
</div><div><a type="button" class="graph-help" data-toggle="modal" href="#graph-help-text">Help</a></div><div class="modal fade" id="graph-help-text" tabindex="-1" role="dialog"><div class="modal-dialog modal-lg" role="document"><div class="modal-content"><div class="modal-header"><button type="button" class="close" data-dismiss="modal" aria-label="Close"><span aria-hidden="true">&times;</span></button><h4 class="modal-title" id="-graph-help-label">Graph Key</h4></div><div class="modal-body">
    <p>Nodes of different colours represent the following: </p>
    <?xml version="1.0" encoding="UTF-8" standalone="no"?>
<!DOCTYPE svg PUBLIC "-//W3C//DTD SVG 1.1//EN"
 "http://www.w3.org/Graphics/SVG/1.1/DTD/svg11.dtd">
<!-- Generated by graphviz version 2.40.1 (20161225.0304)
 -->
<!-- Title: Graph Key Pages: 1 -->
<svg width="190pt" height="32pt"
 viewBox="0.00 0.00 190.00 32.00" xmlns="http://www.w3.org/2000/svg" xmlns:xlink="http://www.w3.org/1999/xlink">
<g id="graph0" class="graph" transform="scale(1 1) rotate(0) translate(4 28)">
<title>Graph Key</title>
<polygon fill="#ffffff" stroke="transparent" points="-4,4 -4,-28 186,-28 186,4 -4,4"/>
<!-- Source File -->
<g id="node1" class="node">
<title>Source File</title>
<polygon fill="#f0ad4e" stroke="#f0ad4e" points="67,-24 0,-24 0,0 67,0 67,-24"/>
<text text-anchor="middle" x="33.5" y="-9.6" font-family="Helvetica,sans-Serif" font-size="10.50" fill="#ffffff">Source File</text>
</g>
<!-- This Page&#39;s Entity -->
<g id="node2" class="node">
<title>This Page&#39;s Entity</title>
<polygon fill="none" stroke="#000000" points="182,-24 85,-24 85,0 182,0 182,-24"/>
<text text-anchor="middle" x="133.5" y="-9.6" font-family="Helvetica,sans-Serif" font-size="10.50" fill="#000000">This Page&#39;s Entity</text>
</g>
</g>
</svg>

    
    <p>Solid arrows point from a file to a file which it depends on. A file
    is dependent upon another if the latter must be compiled before the former
    can be. Where possible, edges connecting nodes are given different colours to make them easier to distinguish in large graphs.
    </p>
    </div></div></div></div>
      </div>
    </div>
    
      
    <div class="panel panel-default">
      <div class="panel-heading">
  <h3 class="panel-title">Files dependent on this one</h3>
      </div>
      <div class="panel-body">
  <div class="depgraph"><?xml version="1.0" encoding="UTF-8" standalone="no"?>
<!DOCTYPE svg PUBLIC "-//W3C//DTD SVG 1.1//EN"
 "http://www.w3.org/Graphics/SVG/1.1/DTD/svg11.dtd">
<!-- Generated by graphviz version 2.40.1 (20161225.0304)
 -->
<!-- Title: sourcefile~~modinlet.f90~~AfferentGraph Pages: 1 -->
<svg id="sourcefilemodinletf90AfferentGraph" width="579pt" height="173pt"
 viewBox="0.00 0.00 579.00 173.44" xmlns="http://www.w3.org/2000/svg" xmlns:xlink="http://www.w3.org/1999/xlink">
<g id="sourcefile~~modinlet.f90~~AfferentGraph" class="graph" transform="scale(1 1) rotate(0) translate(4 169.4352)">
<title>sourcefile~~modinlet.f90~~AfferentGraph</title>
<polygon fill="#ffffff" stroke="transparent" points="-4,4 -4,-169.4352 575,-169.4352 575,4 -4,4"/>
<!-- sourcefile~modinlet.f90 -->
<g id="sourcefile~~modinlet.f90~~AfferentGraph_node1" class="node">
<title>sourcefile~modinlet.f90</title>
<polygon fill="none" stroke="#000000" points="71,-105.4352 0,-105.4352 0,-81.4352 71,-81.4352 71,-105.4352"/>
<text text-anchor="middle" x="35.5" y="-91.0352" font-family="Helvetica,sans-Serif" font-size="10.50" fill="#000000">modinlet.f90</text>
</g>
<!-- sourcefile~modboundary.f90 -->
<g id="sourcefile~~modinlet.f90~~AfferentGraph_node2" class="node">
<title>sourcefile~modboundary.f90</title>
<g id="a_sourcefile~~modinlet.f90~~AfferentGraph_node2"><a xlink:href=".././sourcefile/modboundary.f90.html" xlink:title="modboundary.f90">
<polygon fill="#f0ad4e" stroke="#f0ad4e" points="204,-85.4352 107,-85.4352 107,-61.4352 204,-61.4352 204,-85.4352"/>
<text text-anchor="middle" x="155.5" y="-71.0352" font-family="Helvetica,sans-Serif" font-size="10.50" fill="#ffffff">modboundary.f90</text>
</a>
</g>
</g>
<!-- sourcefile~modboundary.f90&#45;&gt;sourcefile~modinlet.f90 -->
<g id="sourcefile~~modinlet.f90~~AfferentGraph_edge2" class="edge">
<title>sourcefile~modboundary.f90&#45;&gt;sourcefile~modinlet.f90</title>
<path fill="none" stroke="#ff0000" stroke-dasharray="5,2" d="M106.6914,-81.57C98.2032,-82.9847 89.4053,-84.451 81.0099,-85.8503"/>
<polygon fill="#ff0000" stroke="#ff0000" points="80.3054,-82.4193 71.0169,-87.5158 81.4563,-89.3241 80.3054,-82.4193"/>
</g>
<!-- sourcefile~modstartup.f90 -->
<g id="sourcefile~~modinlet.f90~~AfferentGraph_node3" class="node">
<title>sourcefile~modstartup.f90</title>
<g id="a_sourcefile~~modinlet.f90~~AfferentGraph_node3"><a xlink:href=".././sourcefile/modstartup.f90.html" xlink:title="modstartup.f90">
<polygon fill="#f0ad4e" stroke="#f0ad4e" points="456,-125.4352 371,-125.4352 371,-101.4352 456,-101.4352 456,-125.4352"/>
<text text-anchor="middle" x="413.5" y="-111.0352" font-family="Helvetica,sans-Serif" font-size="10.50" fill="#ffffff">modstartup.f90</text>
</a>
</g>
</g>
<!-- sourcefile~modstartup.f90&#45;&gt;sourcefile~modinlet.f90 -->
<g id="sourcefile~~modinlet.f90~~AfferentGraph_edge1" class="edge">
<title>sourcefile~modstartup.f90&#45;&gt;sourcefile~modinlet.f90</title>
<path fill="none" stroke="#ff0000" stroke-dasharray="5,2" d="M283.5,-113.4352C212.9387,-107.9559 131.1112,-101.2978 81.3426,-97.2143"/>
<polygon fill="#ff0000" stroke="#ff0000" points="81.4776,-93.7137 71.2247,-96.3833 80.9046,-100.6902 81.4776,-93.7137"/>
</g>
<!-- sourcefile~modstartup.f90&#45;&gt;sourcefile~modboundary.f90 -->
<g id="sourcefile~~modinlet.f90~~AfferentGraph_edge4" class="edge">
<title>sourcefile~modstartup.f90&#45;&gt;sourcefile~modboundary.f90</title>
<path fill="none" stroke="#ff0000" stroke-dasharray="5,2" d="M370.9881,-115.0928C345.5644,-115.6715 312.6397,-115.6981 283.5,-113.4352"/>
<path fill="none" stroke="#ff0000" stroke-dasharray="5,2" d="M283.5,-113.4352C251.3276,-110.9369 216.472,-99.4188 191.2692,-89.38"/>
<polygon fill="#ff0000" stroke="#ff0000" points="192.352,-86.0412 181.7718,-85.485 189.6959,-92.5177 192.352,-86.0412"/>
</g>
<!-- sourcefile~modpois.f90 -->
<g id="sourcefile~~modinlet.f90~~AfferentGraph_node4" class="node">
<title>sourcefile~modpois.f90</title>
<g id="a_sourcefile~~modinlet.f90~~AfferentGraph_node4"><a xlink:href=".././sourcefile/modpois.f90.html" xlink:title="modpois.f90">
<polygon fill="#f0ad4e" stroke="#f0ad4e" points="319,-165.4352 248,-165.4352 248,-141.4352 319,-141.4352 319,-165.4352"/>
<text text-anchor="middle" x="283.5" y="-151.0352" font-family="Helvetica,sans-Serif" font-size="10.50" fill="#ffffff">modpois.f90</text>
</a>
</g>
</g>
<!-- sourcefile~modstartup.f90&#45;&gt;sourcefile~modpois.f90 -->
<g id="sourcefile~~modinlet.f90~~AfferentGraph_edge8" class="edge">
<title>sourcefile~modstartup.f90&#45;&gt;sourcefile~modpois.f90</title>
<path fill="none" stroke="#ff0000" stroke-dasharray="5,2" d="M374.4957,-125.4366C360.2763,-129.8118 344.0698,-134.7984 329.3126,-139.3391"/>
<polygon fill="#ff0000" stroke="#ff0000" points="327.8984,-136.1122 319.3699,-142.3984 329.957,-142.8027 327.8984,-136.1122"/>
</g>
<!-- sourcefile~modsubgrid.f90 -->
<g id="sourcefile~~modinlet.f90~~AfferentGraph_node6" class="node">
<title>sourcefile~modsubgrid.f90</title>
<g id="a_sourcefile~~modinlet.f90~~AfferentGraph_node6"><a xlink:href=".././sourcefile/modsubgrid.f90.html" xlink:title="modsubgrid.f90">
<polygon fill="#f0ad4e" stroke="#f0ad4e" points="327,-85.4352 240,-85.4352 240,-61.4352 327,-61.4352 327,-85.4352"/>
<text text-anchor="middle" x="283.5" y="-71.0352" font-family="Helvetica,sans-Serif" font-size="10.50" fill="#ffffff">modsubgrid.f90</text>
</a>
</g>
</g>
<!-- sourcefile~modstartup.f90&#45;&gt;sourcefile~modsubgrid.f90 -->
<g id="sourcefile~~modinlet.f90~~AfferentGraph_edge11" class="edge">
<title>sourcefile~modstartup.f90&#45;&gt;sourcefile~modsubgrid.f90</title>
<path fill="none" stroke="#0000ff" stroke-dasharray="5,2" d="M374.4957,-101.4339C361.376,-97.3971 346.5645,-92.8397 332.7607,-88.5924"/>
<polygon fill="#0000ff" stroke="#0000ff" points="333.5132,-85.162 322.9261,-85.5663 331.4545,-91.8525 333.5132,-85.162"/>
</g>
<!-- sourcefile~modpois.f90&#45;&gt;sourcefile~modboundary.f90 -->
<g id="sourcefile~~modinlet.f90~~AfferentGraph_edge3" class="edge">
<title>sourcefile~modpois.f90&#45;&gt;sourcefile~modboundary.f90</title>
<path fill="none" stroke="#ff0000" stroke-dasharray="5,2" d="M263.0641,-141.3915C255.7584,-137.0409 247.4837,-132.0616 240,-127.4352 220.7579,-115.5401 199.2798,-101.8083 182.7928,-91.1689"/>
<polygon fill="#ff0000" stroke="#ff0000" points="184.4906,-88.0987 174.1928,-85.6075 180.6894,-93.9768 184.4906,-88.0987"/>
</g>
<!-- sourcefile~program.f90 -->
<g id="sourcefile~~modinlet.f90~~AfferentGraph_node5" class="node">
<title>sourcefile~program.f90</title>
<g id="a_sourcefile~~modinlet.f90~~AfferentGraph_node5"><a xlink:href=".././sourcefile/program.f90.html" xlink:title="program.f90">
<polygon fill="#f0ad4e" stroke="#f0ad4e" points="571,-85.4352 500,-85.4352 500,-61.4352 571,-61.4352 571,-85.4352"/>
<text text-anchor="middle" x="535.5" y="-71.0352" font-family="Helvetica,sans-Serif" font-size="10.50" fill="#ffffff">program.f90</text>
</a>
</g>
</g>
<!-- sourcefile~program.f90&#45;&gt;sourcefile~modboundary.f90 -->
<g id="sourcefile~~modinlet.f90~~AfferentGraph_edge5" class="edge">
<title>sourcefile~program.f90&#45;&gt;sourcefile~modboundary.f90</title>
<path fill="none" stroke="#ff0000" stroke-dasharray="5,2" d="M525.963,-61.1776C513.5573,-46.3416 490.333,-22.1419 464,-12.4352 366.1812,23.622 242.6465,-28.0511 186.1841,-56.6381"/>
<polygon fill="#ff0000" stroke="#ff0000" points="184.3523,-53.645 177.0763,-61.3463 187.5668,-59.8633 184.3523,-53.645"/>
</g>
<!-- sourcefile~program.f90&#45;&gt;sourcefile~modstartup.f90 -->
<g id="sourcefile~~modinlet.f90~~AfferentGraph_edge7" class="edge">
<title>sourcefile~program.f90&#45;&gt;sourcefile~modstartup.f90</title>
<path fill="none" stroke="#00ffff" stroke-dasharray="5,2" d="M499.8846,-85.1124C487.4424,-89.1918 473.2853,-93.8335 460.0838,-98.1619"/>
<polygon fill="#00ffff" stroke="#00ffff" points="458.6309,-94.9548 450.219,-101.3962 460.8118,-101.6064 458.6309,-94.9548"/>
</g>
<!-- sourcefile~program.f90&#45;&gt;sourcefile~modpois.f90 -->
<g id="sourcefile~~modinlet.f90~~AfferentGraph_edge9" class="edge">
<title>sourcefile~program.f90&#45;&gt;sourcefile~modpois.f90</title>
<path fill="none" stroke="#ff0000" stroke-dasharray="5,2" d="M525.5664,-85.5031C512.9274,-99.9073 489.6381,-123.426 464,-134.4352 420.994,-152.9023 367.1281,-156.336 329.4825,-155.9645"/>
<polygon fill="#ff0000" stroke="#ff0000" points="329.3829,-152.462 319.3172,-155.7682 329.2477,-159.4607 329.3829,-152.462"/>
</g>
<!-- sourcefile~program.f90&#45;&gt;sourcefile~modsubgrid.f90 -->
<g id="sourcefile~~modinlet.f90~~AfferentGraph_edge10" class="edge">
<title>sourcefile~program.f90&#45;&gt;sourcefile~modsubgrid.f90</title>
<path fill="none" stroke="#0000ff" stroke-dasharray="5,2" d="M499.929,-73.4352C457.6238,-73.4352 386.5726,-73.4352 337.4809,-73.4352"/>
<polygon fill="#0000ff" stroke="#0000ff" points="337.3568,-69.9353 327.3568,-73.4352 337.3568,-76.9353 337.3568,-69.9353"/>
</g>
<!-- sourcefile~modstatsdump.f90 -->
<g id="sourcefile~~modinlet.f90~~AfferentGraph_node7" class="node">
<title>sourcefile~modstatsdump.f90</title>
<g id="a_sourcefile~~modinlet.f90~~AfferentGraph_node7"><a xlink:href=".././sourcefile/modstatsdump.f90.html" xlink:title="modstatsdump.f90">
<polygon fill="#f0ad4e" stroke="#f0ad4e" points="464,-45.4352 363,-45.4352 363,-21.4352 464,-21.4352 464,-45.4352"/>
<text text-anchor="middle" x="413.5" y="-31.0352" font-family="Helvetica,sans-Serif" font-size="10.50" fill="#ffffff">modstatsdump.f90</text>
</a>
</g>
</g>
<!-- sourcefile~program.f90&#45;&gt;sourcefile~modstatsdump.f90 -->
<g id="sourcefile~~modinlet.f90~~AfferentGraph_edge13" class="edge">
<title>sourcefile~program.f90&#45;&gt;sourcefile~modstatsdump.f90</title>
<path fill="none" stroke="#ff0000" stroke-dasharray="5,2" d="M499.8846,-61.7581C487.4424,-57.6787 473.2853,-53.037 460.0838,-48.7086"/>
<polygon fill="#ff0000" stroke="#ff0000" points="460.8118,-45.264 450.219,-45.4743 458.6309,-51.9156 460.8118,-45.264"/>
</g>
<!-- sourcefile~modsubgrid.f90&#45;&gt;sourcefile~modboundary.f90 -->
<g id="sourcefile~~modinlet.f90~~AfferentGraph_edge6" class="edge">
<title>sourcefile~modsubgrid.f90&#45;&gt;sourcefile~modboundary.f90</title>
<path fill="none" stroke="#ff0000" stroke-dasharray="5,2" d="M239.8077,-73.4352C231.6725,-73.4352 223.049,-73.4352 214.543,-73.4352"/>
<polygon fill="#ff0000" stroke="#ff0000" points="214.2665,-69.9353 204.2664,-73.4352 214.2664,-76.9353 214.2665,-69.9353"/>
</g>
<!-- sourcefile~modstatsdump.f90&#45;&gt;sourcefile~modsubgrid.f90 -->
<g id="sourcefile~~modinlet.f90~~AfferentGraph_edge12" class="edge">
<title>sourcefile~modstatsdump.f90&#45;&gt;sourcefile~modsubgrid.f90</title>
<path fill="none" stroke="#0000ff" stroke-dasharray="5,2" d="M374.4957,-45.4366C361.376,-49.4734 346.5645,-54.0308 332.7607,-58.2781"/>
<polygon fill="#0000ff" stroke="#0000ff" points="331.4545,-55.018 322.9261,-61.3041 333.5132,-61.7084 331.4545,-55.018"/>
</g>
</g>
</svg>
</div><div><a type="button" class="graph-help" data-toggle="modal" href="#graph-help-text">Help</a></div><div class="modal fade" id="graph-help-text" tabindex="-1" role="dialog"><div class="modal-dialog modal-lg" role="document"><div class="modal-content"><div class="modal-header"><button type="button" class="close" data-dismiss="modal" aria-label="Close"><span aria-hidden="true">&times;</span></button><h4 class="modal-title" id="-graph-help-label">Graph Key</h4></div><div class="modal-body">
    <p>Nodes of different colours represent the following: </p>
    <?xml version="1.0" encoding="UTF-8" standalone="no"?>
<!DOCTYPE svg PUBLIC "-//W3C//DTD SVG 1.1//EN"
 "http://www.w3.org/Graphics/SVG/1.1/DTD/svg11.dtd">
<!-- Generated by graphviz version 2.40.1 (20161225.0304)
 -->
<!-- Title: Graph Key Pages: 1 -->
<svg width="190pt" height="32pt"
 viewBox="0.00 0.00 190.00 32.00" xmlns="http://www.w3.org/2000/svg" xmlns:xlink="http://www.w3.org/1999/xlink">
<g id="graph0" class="graph" transform="scale(1 1) rotate(0) translate(4 28)">
<title>Graph Key</title>
<polygon fill="#ffffff" stroke="transparent" points="-4,4 -4,-28 186,-28 186,4 -4,4"/>
<!-- Source File -->
<g id="node1" class="node">
<title>Source File</title>
<polygon fill="#f0ad4e" stroke="#f0ad4e" points="67,-24 0,-24 0,0 67,0 67,-24"/>
<text text-anchor="middle" x="33.5" y="-9.6" font-family="Helvetica,sans-Serif" font-size="10.50" fill="#ffffff">Source File</text>
</g>
<!-- This Page&#39;s Entity -->
<g id="node2" class="node">
<title>This Page&#39;s Entity</title>
<polygon fill="none" stroke="#000000" points="182,-24 85,-24 85,0 182,0 182,-24"/>
<text text-anchor="middle" x="133.5" y="-9.6" font-family="Helvetica,sans-Serif" font-size="10.50" fill="#000000">This Page&#39;s Entity</text>
</g>
</g>
</svg>

    
    <p>Solid arrows point from a file to a file which it depends on. A file
    is dependent upon another if the latter must be compiled before the former
    can be. Where possible, edges connecting nodes are given different colours to make them easier to distinguish in large graphs.
    </p>
    </div></div></div></div>
      </div>
    </div>
      
      <br>

    <section class="visible-xs visible-sm hidden-md">
      
<h3>Contents</h3>
 







<div class="panel panel-primary">
  <div class="panel-heading text-left"><h3 class="panel-title"><a data-toggle="collapse" href="#mods-1">Modules</a></h3></div>
  <div id="mods-1" class="panel-collapse collapse">
    <div class="list-group">
      
      <a class="list-group-item" href="../module/modinlet.html">modinlet</a>
      
    </div>
  </div>
</div>
















<div class="panel panel-primary">
  <div class="panel-heading text-left"><h3 class="panel-title">Source Code</h3></div>
  <div class="list-group">
    <a class="list-group-item" href="../sourcefile/modinlet.f90.html#src">modinlet.f90</a>
  </div>
</div>



    </section>
    <br class="visible-xs visible-sm hidden-md">

    <section>
      <h2><span class="anchor" id="src"></span>Source Code</h2>
    <div class="hl"><pre><span></span><a name="ln-1"></a><span class="c">!! modinlet.f90 contains the method of Lund (1998) to a generate a turbulent inlet profile.</span>
<a name="ln-2"></a><span class="c">!! The velocity is extracted from a recycle plane, rescaled, and used as inlet condition</span>
<a name="ln-3"></a><span class="c">!! Note that due to the staggered grid arrangement the u-components are recycled from </span>
<a name="ln-4"></a><span class="c">!! cell(irecycl,:,:), while the v- and w- components are read from cell (irecycle-1,:,:). </span>
<a name="ln-5"></a><span class="c">!! This is because the inlet condition is located at i=ib for u, and at i=ib-1 for v and w.</span>
<a name="ln-6"></a><span class="c">!!</span>
<a name="ln-7"></a><span class="c">!! Also the method of Kong (2000) is added to generate a turbulent temperature inlet profile</span>
<a name="ln-8"></a><span class="c">!!</span>
<a name="ln-9"></a><span class="c">!!  \author Jasper Tomas,TU Delft, June 4th 2015</span>
<a name="ln-10"></a><span class="c">!!  \par Revision list</span>
<a name="ln-11"></a><span class="c">!!  \todo Documentation</span>
<a name="ln-12"></a><span class="c">!!</span>
<a name="ln-13"></a><span class="k">module </span><span class="n">modinlet</span>
<a name="ln-14"></a><span class="k">use </span><span class="n">modinletdata</span>
<a name="ln-15"></a><span class="k">implicit none</span>
<a name="ln-16"></a><span class="k">save</span>
<a name="ln-17"></a><span class="k">  public</span> <span class="kd">::</span> <span class="n">initinlet</span><span class="p">,</span><span class="n">exitinlet</span><span class="p">,</span><span class="n">momentumthickness</span><span class="p">,</span><span class="n">blthickness</span><span class="p">,</span><span class="n">dispthickness</span><span class="p">,</span><span class="n">writeinletfile</span><span class="p">,</span><span class="n">readinletfile</span><span class="p">,</span><span class="n">enthalpythickness</span><span class="p">,</span><span class="n">inletgen</span><span class="p">,</span><span class="n">inletgennotemp</span><span class="p">,</span><span class="n">zinterpolate1d</span><span class="p">,</span><span class="n">zinterpolatew1d</span><span class="p">,</span><span class="n">zinterpolatet1d</span><span class="p">,</span><span class="n">zinterpolate2d</span><span class="p">,</span><span class="n">blthicknesst</span><span class="p">,</span><span class="n">momentumthicknessexp</span><span class="p">,</span><span class="n">dispthicknessexp</span>
<a name="ln-18"></a>
<a name="ln-19"></a><span class="k">contains</span>
<a name="ln-20"></a><span class="k">  subroutine </span><span class="n">initinlet</span>
<a name="ln-21"></a>    <span class="k">use </span><span class="n">modglobal</span><span class="p">,</span> <span class="n">only</span> <span class="p">:</span> <span class="n">ih</span><span class="p">,</span><span class="n">ib</span><span class="p">,</span><span class="n">ie</span><span class="p">,</span><span class="n">jh</span><span class="p">,</span><span class="n">jb</span><span class="p">,</span><span class="n">je</span><span class="p">,</span><span class="n">kb</span><span class="p">,</span><span class="n">ke</span><span class="p">,</span><span class="n">kh</span><span class="p">,</span><span class="n">iinletgen</span><span class="p">,</span><span class="n">iplane</span><span class="p">,</span><span class="n">xf</span><span class="p">,</span><span class="n">lstoreplane</span><span class="p">,</span><span class="n">nstore</span><span class="p">,</span><span class="n">Uinf</span><span class="p">,</span><span class="n">ltempeq</span><span class="p">,</span><span class="n">pi</span><span class="p">,</span><span class="n">zf</span><span class="p">,</span><span class="n">zh</span>
<a name="ln-22"></a>    <span class="k">use </span><span class="n">modfields</span><span class="p">,</span> <span class="n">only</span> <span class="p">:</span> <span class="n">um</span>
<a name="ln-23"></a>    <span class="k">use </span><span class="n">modmpi</span><span class="p">,</span> <span class="n">only</span> <span class="p">:</span> <span class="n">myid</span><span class="p">,</span><span class="n">nprocs</span>
<a name="ln-24"></a>   
<a name="ln-25"></a>    <span class="k">implicit none</span>
<a name="ln-26"></a><span class="k">    </span><span class="kt">real</span>    <span class="kd">::</span> <span class="n">pfi</span><span class="p">,</span> <span class="n">epsi</span>
<a name="ln-27"></a>    <span class="kt">integer</span> <span class="kd">::</span> <span class="n">k</span>
<a name="ln-28"></a>
<a name="ln-29"></a>
<a name="ln-30"></a>  <span class="k">if</span> <span class="p">(</span><span class="n">iinletgen</span><span class="o">==</span><span class="mi">1</span><span class="p">)</span> <span class="k">then</span>
<a name="ln-31"></a>
<a name="ln-32"></a><span class="k">  allocate</span><span class="p">(</span><span class="n">Utav</span><span class="p">(</span><span class="n">ib</span><span class="p">:</span><span class="n">ie</span><span class="p">,</span><span class="n">kb</span><span class="p">:</span><span class="n">ke</span><span class="p">))</span>
<a name="ln-33"></a>  <span class="k">allocate</span><span class="p">(</span><span class="n">Uinl</span><span class="p">(</span><span class="n">kb</span><span class="p">:</span><span class="n">ke</span><span class="p">))</span>
<a name="ln-34"></a>  <span class="k">allocate</span><span class="p">(</span><span class="n">Winl</span><span class="p">(</span><span class="n">kb</span><span class="p">:</span><span class="n">ke</span><span class="o">+</span><span class="mi">1</span><span class="p">))</span>
<a name="ln-35"></a>  <span class="k">allocate</span><span class="p">(</span><span class="n">Urec</span><span class="p">(</span><span class="n">kb</span><span class="p">:</span><span class="n">ke</span><span class="p">))</span>
<a name="ln-36"></a>  <span class="k">allocate</span><span class="p">(</span><span class="n">Wrec</span><span class="p">(</span><span class="n">kb</span><span class="p">:</span><span class="n">ke</span><span class="o">+</span><span class="mi">1</span><span class="p">))</span>
<a name="ln-37"></a>  <span class="k">allocate</span><span class="p">(</span><span class="n">u0inletbc</span><span class="p">(</span><span class="n">jb</span><span class="p">:</span><span class="n">je</span><span class="p">,</span><span class="n">kb</span><span class="p">:</span><span class="n">ke</span><span class="p">))</span>
<a name="ln-38"></a>  <span class="k">allocate</span><span class="p">(</span><span class="n">v0inletbc</span><span class="p">(</span><span class="n">jb</span><span class="p">:</span><span class="n">je</span><span class="p">,</span><span class="n">kb</span><span class="p">:</span><span class="n">ke</span><span class="p">))</span>
<a name="ln-39"></a>  <span class="k">allocate</span><span class="p">(</span><span class="n">w0inletbc</span><span class="p">(</span><span class="n">jb</span><span class="p">:</span><span class="n">je</span><span class="p">,</span><span class="n">kb</span><span class="p">:</span><span class="n">ke</span><span class="o">+</span><span class="mi">1</span><span class="p">))</span>
<a name="ln-40"></a>  <span class="k">allocate</span><span class="p">(</span><span class="n">u0inletbcold</span><span class="p">(</span><span class="n">jb</span><span class="p">:</span><span class="n">je</span><span class="p">,</span><span class="n">kb</span><span class="p">:</span><span class="n">ke</span><span class="p">))</span>
<a name="ln-41"></a>  <span class="k">allocate</span><span class="p">(</span><span class="n">v0inletbcold</span><span class="p">(</span><span class="n">jb</span><span class="p">:</span><span class="n">je</span><span class="p">,</span><span class="n">kb</span><span class="p">:</span><span class="n">ke</span><span class="p">))</span>
<a name="ln-42"></a>  <span class="k">allocate</span><span class="p">(</span><span class="n">w0inletbcold</span><span class="p">(</span><span class="n">jb</span><span class="p">:</span><span class="n">je</span><span class="p">,</span><span class="n">kb</span><span class="p">:</span><span class="n">ke</span><span class="o">+</span><span class="mi">1</span><span class="p">))</span>
<a name="ln-43"></a>  <span class="k">allocate</span><span class="p">(</span><span class="n">uminletbc</span><span class="p">(</span><span class="n">jb</span><span class="p">:</span><span class="n">je</span><span class="p">,</span><span class="n">kb</span><span class="p">:</span><span class="n">ke</span><span class="p">))</span>
<a name="ln-44"></a>  <span class="k">allocate</span><span class="p">(</span><span class="n">vminletbc</span><span class="p">(</span><span class="n">jb</span><span class="p">:</span><span class="n">je</span><span class="p">,</span><span class="n">kb</span><span class="p">:</span><span class="n">ke</span><span class="p">))</span>
<a name="ln-45"></a>  <span class="k">allocate</span><span class="p">(</span><span class="n">wminletbc</span><span class="p">(</span><span class="n">jb</span><span class="p">:</span><span class="n">je</span><span class="p">,</span><span class="n">kb</span><span class="p">:</span><span class="n">ke</span><span class="o">+</span><span class="mi">1</span><span class="p">))</span>
<a name="ln-46"></a>  <span class="k">allocate</span><span class="p">(</span><span class="n">uaver</span><span class="p">(</span><span class="n">ib</span><span class="p">:</span><span class="n">ie</span><span class="p">,</span><span class="n">kb</span><span class="p">:</span><span class="n">ke</span><span class="p">))</span>
<a name="ln-47"></a>  <span class="k">allocate</span><span class="p">(</span><span class="n">zirf</span><span class="p">(</span><span class="n">kb</span><span class="p">:</span><span class="n">ke</span><span class="p">))</span>
<a name="ln-48"></a>  <span class="k">allocate</span><span class="p">(</span><span class="n">ziif</span><span class="p">(</span><span class="n">kb</span><span class="p">:</span><span class="n">ke</span><span class="p">))</span>
<a name="ln-49"></a>  <span class="k">allocate</span><span class="p">(</span><span class="n">zirh</span><span class="p">(</span><span class="n">kb</span><span class="p">:</span><span class="n">ke</span><span class="o">+</span><span class="mi">1</span><span class="p">))</span>
<a name="ln-50"></a>  <span class="k">allocate</span><span class="p">(</span><span class="n">ziih</span><span class="p">(</span><span class="n">kb</span><span class="p">:</span><span class="n">ke</span><span class="o">+</span><span class="mi">1</span><span class="p">))</span>
<a name="ln-51"></a>  <span class="k">allocate</span><span class="p">(</span><span class="n">zorf</span><span class="p">(</span><span class="n">kb</span><span class="p">:</span><span class="n">ke</span><span class="p">))</span>
<a name="ln-52"></a>  <span class="k">allocate</span><span class="p">(</span><span class="n">zoif</span><span class="p">(</span><span class="n">kb</span><span class="p">:</span><span class="n">ke</span><span class="p">))</span>
<a name="ln-53"></a>  <span class="k">allocate</span><span class="p">(</span><span class="n">zorh</span><span class="p">(</span><span class="n">kb</span><span class="p">:</span><span class="n">ke</span><span class="o">+</span><span class="mi">1</span><span class="p">))</span>
<a name="ln-54"></a>  <span class="k">allocate</span><span class="p">(</span><span class="n">zoih</span><span class="p">(</span><span class="n">kb</span><span class="p">:</span><span class="n">ke</span><span class="o">+</span><span class="mi">1</span><span class="p">))</span>
<a name="ln-55"></a>  <span class="k">allocate</span><span class="p">(</span><span class="n">loclowif</span><span class="p">(</span><span class="n">kb</span><span class="p">:</span><span class="n">ke</span><span class="p">))</span>
<a name="ln-56"></a>  <span class="k">allocate</span><span class="p">(</span><span class="n">locupif</span><span class="p">(</span><span class="n">kb</span><span class="p">:</span><span class="n">ke</span><span class="p">))</span>
<a name="ln-57"></a>  <span class="k">allocate</span><span class="p">(</span><span class="n">loclowih</span><span class="p">(</span><span class="n">kb</span><span class="p">:</span><span class="n">ke</span><span class="o">+</span><span class="mi">1</span><span class="p">))</span>
<a name="ln-58"></a>  <span class="k">allocate</span><span class="p">(</span><span class="n">locupih</span><span class="p">(</span><span class="n">kb</span><span class="p">:</span><span class="n">ke</span><span class="o">+</span><span class="mi">1</span><span class="p">))</span>
<a name="ln-59"></a>  <span class="k">allocate</span><span class="p">(</span><span class="n">loclowof</span><span class="p">(</span><span class="n">kb</span><span class="p">:</span><span class="n">ke</span><span class="p">))</span>
<a name="ln-60"></a>  <span class="k">allocate</span><span class="p">(</span><span class="n">locupof</span><span class="p">(</span><span class="n">kb</span><span class="p">:</span><span class="n">ke</span><span class="p">))</span>
<a name="ln-61"></a>  <span class="k">allocate</span><span class="p">(</span><span class="n">loclowoh</span><span class="p">(</span><span class="n">kb</span><span class="p">:</span><span class="n">ke</span><span class="o">+</span><span class="mi">1</span><span class="p">))</span>
<a name="ln-62"></a>  <span class="k">allocate</span><span class="p">(</span><span class="n">locupoh</span><span class="p">(</span><span class="n">kb</span><span class="p">:</span><span class="n">ke</span><span class="o">+</span><span class="mi">1</span><span class="p">))</span>
<a name="ln-63"></a>  <span class="k">allocate</span><span class="p">(</span><span class="n">displ</span><span class="p">(</span><span class="n">ib</span><span class="p">:</span><span class="n">ie</span><span class="p">))</span>
<a name="ln-64"></a>  <span class="k">allocate</span><span class="p">(</span><span class="n">displold</span><span class="p">(</span><span class="n">ib</span><span class="p">:</span><span class="n">ie</span><span class="p">))</span>
<a name="ln-65"></a>  <span class="k">allocate</span><span class="p">(</span><span class="n">upupavinl</span><span class="p">(</span><span class="n">kb</span><span class="p">:</span><span class="n">ke</span><span class="p">))</span>
<a name="ln-66"></a>  <span class="k">allocate</span><span class="p">(</span><span class="n">vpvpavinl</span><span class="p">(</span><span class="n">kb</span><span class="p">:</span><span class="n">ke</span><span class="p">))</span>
<a name="ln-67"></a>  <span class="k">allocate</span><span class="p">(</span><span class="n">wpwpavinl</span><span class="p">(</span><span class="n">kb</span><span class="p">:</span><span class="n">ke</span><span class="p">))</span>
<a name="ln-68"></a>  <span class="k">allocate</span><span class="p">(</span><span class="n">upwpavinl</span><span class="p">(</span><span class="n">kb</span><span class="p">:</span><span class="n">ke</span><span class="p">))</span>
<a name="ln-69"></a>  <span class="k">allocate</span><span class="p">(</span><span class="n">thlpthlpavinl</span><span class="p">(</span><span class="n">kb</span><span class="p">:</span><span class="n">ke</span><span class="p">))</span>
<a name="ln-70"></a>  <span class="k">allocate</span><span class="p">(</span><span class="n">thlpupavinl</span><span class="p">(</span><span class="n">kb</span><span class="p">:</span><span class="n">ke</span><span class="p">))</span>
<a name="ln-71"></a>  <span class="k">allocate</span><span class="p">(</span><span class="n">thlpwpavinl</span><span class="p">(</span><span class="n">kb</span><span class="p">:</span><span class="n">ke</span><span class="p">))</span>
<a name="ln-72"></a>  <span class="k">allocate</span><span class="p">(</span><span class="n">heavif</span><span class="p">(</span><span class="n">kb</span><span class="p">:</span><span class="n">ke</span><span class="p">))</span>
<a name="ln-73"></a>  <span class="k">allocate</span><span class="p">(</span><span class="n">heavih</span><span class="p">(</span><span class="n">kb</span><span class="p">:</span><span class="n">ke</span><span class="o">+</span><span class="mi">1</span><span class="p">))</span>
<a name="ln-74"></a>
<a name="ln-75"></a>  <span class="k">if</span> <span class="p">(</span><span class="n">lstoreplane</span> <span class="p">)</span> <span class="k">then</span>
<a name="ln-76"></a><span class="k">    allocate</span><span class="p">(</span><span class="n">storeu0inletbc</span><span class="p">(</span><span class="n">jb</span><span class="p">:</span><span class="n">je</span><span class="p">,</span><span class="n">kb</span><span class="p">:</span><span class="n">ke</span><span class="p">,</span><span class="mi">1</span><span class="p">:</span><span class="n">nstore</span><span class="p">))</span>
<a name="ln-77"></a>    <span class="k">allocate</span><span class="p">(</span><span class="n">storev0inletbc</span><span class="p">(</span><span class="n">jb</span><span class="p">:</span><span class="n">je</span><span class="p">,</span><span class="n">kb</span><span class="p">:</span><span class="n">ke</span><span class="p">,</span><span class="mi">1</span><span class="p">:</span><span class="n">nstore</span><span class="p">))</span>
<a name="ln-78"></a>    <span class="k">allocate</span><span class="p">(</span><span class="n">storew0inletbc</span><span class="p">(</span><span class="n">jb</span><span class="p">:</span><span class="n">je</span><span class="p">,</span><span class="n">kb</span><span class="p">:</span><span class="n">ke</span><span class="o">+</span><span class="mi">1</span><span class="p">,</span><span class="mi">1</span><span class="p">:</span><span class="n">nstore</span><span class="p">))</span>
<a name="ln-79"></a>  <span class="k">end if </span>
<a name="ln-80"></a>
<a name="ln-81"></a><span class="k">  </span><span class="n">epsi</span> <span class="o">=</span> <span class="mf">0.25</span><span class="o">*</span><span class="n">di</span>
<a name="ln-82"></a>  <span class="k">do </span><span class="n">k</span><span class="o">=</span><span class="n">kb</span><span class="p">,</span><span class="n">ke</span>
<a name="ln-83"></a>    <span class="n">pfi</span> <span class="o">=</span> <span class="n">zf</span><span class="p">(</span><span class="n">k</span><span class="p">)</span> <span class="o">-</span><span class="mf">1.2</span><span class="o">*</span><span class="n">di</span> <span class="o">-</span><span class="n">epsi</span>
<a name="ln-84"></a>    <span class="k">if</span> <span class="p">(</span><span class="n">pfi</span> <span class="o">&lt;</span> <span class="o">-</span><span class="n">epsi</span><span class="p">)</span> <span class="k">then</span>
<a name="ln-85"></a><span class="k">      </span><span class="n">heavif</span><span class="p">(</span><span class="n">k</span><span class="p">)</span> <span class="o">=</span> <span class="mf">1.</span>
<a name="ln-86"></a>    <span class="n">elseif</span><span class="p">(</span><span class="n">pfi</span> <span class="o">&lt;=</span> <span class="n">epsi</span><span class="p">)</span> <span class="k">then</span>
<a name="ln-87"></a><span class="k">      </span><span class="n">heavif</span><span class="p">(</span><span class="n">k</span><span class="p">)</span> <span class="o">=</span> <span class="mf">0.5</span><span class="o">*</span> <span class="p">(</span> <span class="mf">1.</span> <span class="o">-</span> <span class="p">(</span><span class="n">pfi</span> <span class="o">/</span> <span class="n">epsi</span><span class="p">)</span> <span class="o">-</span> <span class="p">(</span><span class="mf">1.</span><span class="o">/</span><span class="n">pi</span><span class="p">)</span><span class="o">*</span><span class="nb">sin</span><span class="p">(</span><span class="n">pi</span><span class="o">*</span><span class="n">pfi</span><span class="o">/</span><span class="n">epsi</span><span class="p">))</span>
<a name="ln-88"></a>    <span class="n">elseif</span> <span class="p">(</span><span class="n">pfi</span> <span class="o">&gt;</span> <span class="n">epsi</span><span class="p">)</span> <span class="k">then</span>
<a name="ln-89"></a><span class="k">      </span><span class="n">heavif</span><span class="p">(</span><span class="n">k</span><span class="p">)</span> <span class="o">=</span> <span class="mf">0.</span>
<a name="ln-90"></a>    <span class="k">end if  </span>
<a name="ln-91"></a><span class="k">  end do</span>
<a name="ln-92"></a>
<a name="ln-93"></a><span class="k">  do </span><span class="n">k</span><span class="o">=</span><span class="n">kb</span><span class="p">,</span><span class="n">ke</span><span class="o">+</span><span class="mi">1</span>
<a name="ln-94"></a>    <span class="n">pfi</span> <span class="o">=</span> <span class="n">zh</span><span class="p">(</span><span class="n">k</span><span class="p">)</span> <span class="o">-</span><span class="mf">1.2</span><span class="o">*</span><span class="n">di</span> <span class="o">-</span><span class="n">epsi</span>
<a name="ln-95"></a>    <span class="k">if</span> <span class="p">(</span><span class="n">pfi</span> <span class="o">&lt;</span> <span class="o">-</span><span class="n">epsi</span><span class="p">)</span> <span class="k">then</span>
<a name="ln-96"></a><span class="k">      </span><span class="n">heavih</span><span class="p">(</span><span class="n">k</span><span class="p">)</span> <span class="o">=</span> <span class="mf">1.</span>
<a name="ln-97"></a>    <span class="n">elseif</span><span class="p">(</span><span class="n">pfi</span> <span class="o">&lt;=</span> <span class="n">epsi</span><span class="p">)</span> <span class="k">then</span>
<a name="ln-98"></a><span class="k">      </span><span class="n">heavih</span><span class="p">(</span><span class="n">k</span><span class="p">)</span> <span class="o">=</span> <span class="mf">0.5</span><span class="o">*</span> <span class="p">(</span> <span class="mf">1.</span> <span class="o">-</span> <span class="p">(</span><span class="n">pfi</span> <span class="o">/</span> <span class="n">epsi</span><span class="p">)</span> <span class="o">-</span> <span class="p">(</span><span class="mf">1.</span><span class="o">/</span><span class="n">pi</span><span class="p">)</span><span class="o">*</span><span class="nb">sin</span><span class="p">(</span><span class="n">pi</span><span class="o">*</span><span class="n">pfi</span><span class="o">/</span><span class="n">epsi</span><span class="p">))</span>
<a name="ln-99"></a>    <span class="n">elseif</span> <span class="p">(</span><span class="n">pfi</span> <span class="o">&gt;</span> <span class="n">epsi</span><span class="p">)</span> <span class="k">then</span>
<a name="ln-100"></a><span class="k">      </span><span class="n">heavih</span><span class="p">(</span><span class="n">k</span><span class="p">)</span> <span class="o">=</span> <span class="mf">0.</span>
<a name="ln-101"></a>    <span class="k">end if</span>
<a name="ln-102"></a><span class="k">  end do</span>
<a name="ln-103"></a>
<a name="ln-104"></a>
<a name="ln-105"></a>
<a name="ln-106"></a><span class="k">  if</span> <span class="p">(</span><span class="n">ltempeq</span>  <span class="p">)</span> <span class="k">then</span>
<a name="ln-107"></a><span class="k">    allocate</span><span class="p">(</span><span class="n">Ttav</span><span class="p">(</span><span class="n">ib</span><span class="p">:</span><span class="n">ie</span><span class="p">,</span><span class="n">kb</span><span class="p">:</span><span class="n">ke</span><span class="p">))</span>
<a name="ln-108"></a>    <span class="k">allocate</span><span class="p">(</span><span class="n">taver</span><span class="p">(</span><span class="n">ib</span><span class="p">:</span><span class="n">ie</span><span class="p">,</span><span class="n">kb</span><span class="p">:</span><span class="n">ke</span><span class="p">))</span>
<a name="ln-109"></a>    <span class="k">allocate</span><span class="p">(</span><span class="n">Tinl</span><span class="p">(</span><span class="n">kb</span><span class="p">:</span><span class="n">ke</span><span class="p">))</span>
<a name="ln-110"></a>    <span class="k">allocate</span><span class="p">(</span><span class="n">Trec</span><span class="p">(</span><span class="n">kb</span><span class="p">:</span><span class="n">ke</span><span class="p">))</span>
<a name="ln-111"></a>    <span class="k">allocate</span><span class="p">(</span><span class="n">t0inletbc</span><span class="p">(</span><span class="n">jb</span><span class="p">:</span><span class="n">je</span><span class="p">,</span><span class="n">kb</span><span class="p">:</span><span class="n">ke</span><span class="p">))</span>
<a name="ln-112"></a>    <span class="k">allocate</span><span class="p">(</span><span class="n">t0inletbcold</span><span class="p">(</span><span class="n">jb</span><span class="p">:</span><span class="n">je</span><span class="p">,</span><span class="n">kb</span><span class="p">:</span><span class="n">ke</span><span class="p">))</span>
<a name="ln-113"></a>    <span class="k">allocate</span><span class="p">(</span><span class="n">tminletbc</span><span class="p">(</span><span class="n">jb</span><span class="p">:</span><span class="n">je</span><span class="p">,</span><span class="n">kb</span><span class="p">:</span><span class="n">ke</span><span class="p">))</span>
<a name="ln-114"></a>    <span class="k">allocate</span><span class="p">(</span><span class="n">zotr</span><span class="p">(</span><span class="n">kb</span><span class="p">:</span><span class="n">ke</span><span class="p">))</span>
<a name="ln-115"></a>    <span class="k">allocate</span><span class="p">(</span><span class="n">zoti</span><span class="p">(</span><span class="n">kb</span><span class="p">:</span><span class="n">ke</span><span class="p">))</span>
<a name="ln-116"></a>    <span class="k">allocate</span><span class="p">(</span><span class="n">loclowot</span><span class="p">(</span><span class="n">kb</span><span class="p">:</span><span class="n">ke</span><span class="p">))</span>
<a name="ln-117"></a>    <span class="k">allocate</span><span class="p">(</span><span class="n">locupot</span><span class="p">(</span><span class="n">kb</span><span class="p">:</span><span class="n">ke</span><span class="p">))</span>
<a name="ln-118"></a>    <span class="k">allocate</span><span class="p">(</span><span class="n">heavit</span><span class="p">(</span><span class="n">kb</span><span class="p">:</span><span class="n">ke</span><span class="p">))</span>
<a name="ln-119"></a>  
<a name="ln-120"></a>    <span class="k">if</span> <span class="p">(</span><span class="n">lstoreplane</span> <span class="p">)</span> <span class="k">then</span>
<a name="ln-121"></a><span class="k">      allocate</span><span class="p">(</span><span class="n">storet0inletbc</span><span class="p">(</span><span class="n">jb</span><span class="p">:</span><span class="n">je</span><span class="p">,</span><span class="n">kb</span><span class="p">:</span><span class="n">ke</span><span class="p">,</span><span class="mi">1</span><span class="p">:</span><span class="n">nstore</span><span class="p">))</span>
<a name="ln-122"></a>    <span class="k">end if</span>
<a name="ln-123"></a><span class="c">! Heaviside function for temperature</span>
<a name="ln-124"></a>    <span class="n">epsi</span> <span class="o">=</span> <span class="mf">0.25</span><span class="o">*</span><span class="n">dti</span>
<a name="ln-125"></a>    <span class="k">do </span><span class="n">k</span><span class="o">=</span><span class="n">kb</span><span class="p">,</span><span class="n">ke</span>
<a name="ln-126"></a>      <span class="n">pfi</span> <span class="o">=</span> <span class="n">zf</span><span class="p">(</span><span class="n">k</span><span class="p">)</span> <span class="o">-</span><span class="mf">1.2</span><span class="o">*</span><span class="n">dti</span> <span class="o">-</span><span class="n">epsi</span>
<a name="ln-127"></a>      <span class="k">if</span> <span class="p">(</span><span class="n">pfi</span> <span class="o">&lt;</span> <span class="o">-</span><span class="n">epsi</span><span class="p">)</span> <span class="k">then</span>
<a name="ln-128"></a><span class="k">        </span><span class="n">heavit</span><span class="p">(</span><span class="n">k</span><span class="p">)</span> <span class="o">=</span> <span class="mf">1.</span>
<a name="ln-129"></a>      <span class="n">elseif</span><span class="p">(</span><span class="n">pfi</span> <span class="o">&lt;=</span> <span class="n">epsi</span><span class="p">)</span> <span class="k">then</span>
<a name="ln-130"></a><span class="k">        </span><span class="n">heavit</span><span class="p">(</span><span class="n">k</span><span class="p">)</span> <span class="o">=</span> <span class="mf">0.5</span><span class="o">*</span> <span class="p">(</span> <span class="mf">1.</span> <span class="o">-</span> <span class="p">(</span><span class="n">pfi</span> <span class="o">/</span> <span class="n">epsi</span><span class="p">)</span> <span class="o">-</span> <span class="p">(</span><span class="mf">1.</span><span class="o">/</span><span class="n">pi</span><span class="p">)</span><span class="o">*</span><span class="nb">sin</span><span class="p">(</span><span class="n">pi</span><span class="o">*</span><span class="n">pfi</span><span class="o">/</span><span class="n">epsi</span><span class="p">))</span>
<a name="ln-131"></a>      <span class="n">elseif</span> <span class="p">(</span><span class="n">pfi</span> <span class="o">&gt;</span> <span class="n">epsi</span><span class="p">)</span> <span class="k">then</span>
<a name="ln-132"></a><span class="k">        </span><span class="n">heavit</span><span class="p">(</span><span class="n">k</span><span class="p">)</span> <span class="o">=</span> <span class="mf">0.</span>
<a name="ln-133"></a>      <span class="k">end if</span>
<a name="ln-134"></a><span class="k">    end do</span>
<a name="ln-135"></a>
<a name="ln-136"></a><span class="k"> </span>
<a name="ln-137"></a><span class="k">  end if</span>
<a name="ln-138"></a>
<a name="ln-139"></a><span class="k">  </span><span class="n">displ</span><span class="o">=</span><span class="mf">0.</span>
<a name="ln-140"></a>  <span class="n">displold</span> <span class="o">=</span><span class="mf">0.</span>
<a name="ln-141"></a>
<a name="ln-142"></a>  <span class="n">irecy</span> <span class="o">=</span> <span class="n">ib</span><span class="o">+</span><span class="n">iplane</span>        <span class="c">! index of recycle plane equals iplane (read from namoptions)</span>
<a name="ln-143"></a>
<a name="ln-144"></a>
<a name="ln-145"></a>  <span class="n">xfm</span>  <span class="o">=</span> <span class="nb">sum</span><span class="p">(</span><span class="n">xf</span><span class="p">(</span><span class="n">ib</span><span class="p">:</span><span class="n">ie</span><span class="p">))</span><span class="o">/</span><span class="p">(</span><span class="n">ie</span><span class="o">-</span><span class="n">ib</span><span class="o">+</span><span class="mi">1</span><span class="p">)</span>            <span class="c">! mean(xf) </span>
<a name="ln-146"></a>  <span class="n">xf2m</span> <span class="o">=</span> <span class="nb">sum</span><span class="p">(</span><span class="n">xf</span><span class="p">(</span><span class="n">ib</span><span class="p">:</span><span class="n">ie</span><span class="p">)</span><span class="o">**</span><span class="mf">2.</span><span class="p">)</span><span class="o">/</span><span class="p">(</span><span class="n">ie</span><span class="o">-</span><span class="n">ib</span><span class="o">+</span><span class="mi">1</span><span class="p">)</span>        <span class="c">! mean(xf^2)</span>
<a name="ln-147"></a><span class="c">!  btime = timee                              ! this is done to make sure btime is set when avint is computed correctly at startup (only for RA) </span>
<a name="ln-148"></a>
<a name="ln-149"></a>  
<a name="ln-150"></a>  <span class="k">else if</span> <span class="p">(</span><span class="n">iinletgen</span> <span class="o">==</span> <span class="mi">2</span><span class="p">)</span> <span class="k">then</span>
<a name="ln-151"></a><span class="k">    allocate</span><span class="p">(</span><span class="n">storeu0inletbc</span><span class="p">(</span><span class="n">jb</span><span class="p">:</span><span class="n">je</span><span class="p">,</span><span class="n">kb</span><span class="p">:</span><span class="n">ke</span><span class="p">,</span><span class="mi">1</span><span class="p">:</span><span class="n">nstore</span><span class="p">))</span>
<a name="ln-152"></a>    <span class="k">allocate</span><span class="p">(</span><span class="n">storev0inletbc</span><span class="p">(</span><span class="n">jb</span><span class="p">:</span><span class="n">je</span><span class="p">,</span><span class="n">kb</span><span class="p">:</span><span class="n">ke</span><span class="p">,</span><span class="mi">1</span><span class="p">:</span><span class="n">nstore</span><span class="p">))</span>
<a name="ln-153"></a>    <span class="k">allocate</span><span class="p">(</span><span class="n">storew0inletbc</span><span class="p">(</span><span class="n">jb</span><span class="p">:</span><span class="n">je</span><span class="p">,</span><span class="n">kb</span><span class="p">:</span><span class="n">ke</span><span class="o">+</span><span class="mi">1</span><span class="p">,</span><span class="mi">1</span><span class="p">:</span><span class="n">nstore</span><span class="p">))</span>
<a name="ln-154"></a>    <span class="k">allocate</span><span class="p">(</span><span class="n">u0rot</span><span class="p">(</span><span class="mi">1</span><span class="p">:</span><span class="n">nstore</span><span class="p">,</span><span class="n">jb</span><span class="o">-</span><span class="n">jh</span><span class="p">:</span><span class="n">je</span><span class="o">+</span><span class="n">jh</span><span class="p">,</span><span class="n">kb</span><span class="p">:</span><span class="n">ke</span><span class="p">))</span>
<a name="ln-155"></a>    <span class="k">allocate</span><span class="p">(</span><span class="n">v0rot</span><span class="p">(</span><span class="mi">1</span><span class="p">:</span><span class="n">nstore</span><span class="p">,</span><span class="n">jb</span><span class="o">-</span><span class="n">jh</span><span class="p">:</span><span class="n">je</span><span class="o">+</span><span class="n">jh</span><span class="p">,</span><span class="n">kb</span><span class="p">:</span><span class="n">ke</span><span class="p">))</span>
<a name="ln-156"></a>    <span class="k">allocate</span><span class="p">(</span><span class="n">u0inletbc</span><span class="p">(</span><span class="n">jb</span><span class="p">:</span><span class="n">je</span><span class="p">,</span><span class="n">kb</span><span class="p">:</span><span class="n">ke</span><span class="p">))</span>
<a name="ln-157"></a>    <span class="k">allocate</span><span class="p">(</span><span class="n">v0inletbc</span><span class="p">(</span><span class="n">jb</span><span class="p">:</span><span class="n">je</span><span class="p">,</span><span class="n">kb</span><span class="p">:</span><span class="n">ke</span><span class="p">))</span>
<a name="ln-158"></a>    <span class="k">allocate</span><span class="p">(</span><span class="n">w0inletbc</span><span class="p">(</span><span class="n">jb</span><span class="p">:</span><span class="n">je</span><span class="p">,</span><span class="n">kb</span><span class="p">:</span><span class="n">ke</span><span class="o">+</span><span class="mi">1</span><span class="p">))</span>
<a name="ln-159"></a>    <span class="k">allocate</span><span class="p">(</span><span class="n">u0inletbcold</span><span class="p">(</span><span class="n">jb</span><span class="p">:</span><span class="n">je</span><span class="p">,</span><span class="n">kb</span><span class="p">:</span><span class="n">ke</span><span class="p">))</span>
<a name="ln-160"></a>    <span class="k">allocate</span><span class="p">(</span><span class="n">v0inletbcold</span><span class="p">(</span><span class="n">jb</span><span class="p">:</span><span class="n">je</span><span class="p">,</span><span class="n">kb</span><span class="p">:</span><span class="n">ke</span><span class="p">))</span>
<a name="ln-161"></a>    <span class="k">allocate</span><span class="p">(</span><span class="n">w0inletbcold</span><span class="p">(</span><span class="n">jb</span><span class="p">:</span><span class="n">je</span><span class="p">,</span><span class="n">kb</span><span class="p">:</span><span class="n">ke</span><span class="o">+</span><span class="mi">1</span><span class="p">))</span>
<a name="ln-162"></a>    <span class="k">allocate</span><span class="p">(</span><span class="n">uminletbc</span><span class="p">(</span><span class="n">jb</span><span class="p">:</span><span class="n">je</span><span class="p">,</span><span class="n">kb</span><span class="p">:</span><span class="n">ke</span><span class="p">))</span>
<a name="ln-163"></a>    <span class="k">allocate</span><span class="p">(</span><span class="n">vminletbc</span><span class="p">(</span><span class="n">jb</span><span class="p">:</span><span class="n">je</span><span class="p">,</span><span class="n">kb</span><span class="p">:</span><span class="n">ke</span><span class="p">))</span>
<a name="ln-164"></a>    <span class="k">allocate</span><span class="p">(</span><span class="n">wminletbc</span><span class="p">(</span><span class="n">jb</span><span class="p">:</span><span class="n">je</span><span class="p">,</span><span class="n">kb</span><span class="p">:</span><span class="n">ke</span><span class="o">+</span><span class="mi">1</span><span class="p">))</span>
<a name="ln-165"></a>    <span class="k">if</span> <span class="p">(</span><span class="n">ltempeq</span> <span class="p">)</span> <span class="k">then</span>
<a name="ln-166"></a><span class="k">      allocate</span><span class="p">(</span><span class="n">storet0inletbc</span><span class="p">(</span><span class="n">jb</span><span class="p">:</span><span class="n">je</span><span class="p">,</span><span class="n">kb</span><span class="p">:</span><span class="n">ke</span><span class="p">,</span><span class="mi">1</span><span class="p">:</span><span class="n">nstore</span><span class="p">))</span>
<a name="ln-167"></a>      <span class="k">allocate</span><span class="p">(</span><span class="n">t0inletbc</span><span class="p">(</span><span class="n">jb</span><span class="p">:</span><span class="n">je</span><span class="p">,</span><span class="n">kb</span><span class="p">:</span><span class="n">ke</span><span class="p">))</span>
<a name="ln-168"></a>      <span class="k">allocate</span><span class="p">(</span><span class="n">t0inletbcold</span><span class="p">(</span><span class="n">jb</span><span class="p">:</span><span class="n">je</span><span class="p">,</span><span class="n">kb</span><span class="p">:</span><span class="n">ke</span><span class="p">))</span>
<a name="ln-169"></a>      <span class="k">allocate</span><span class="p">(</span><span class="n">tminletbc</span><span class="p">(</span><span class="n">jb</span><span class="p">:</span><span class="n">je</span><span class="p">,</span><span class="n">kb</span><span class="p">:</span><span class="n">ke</span><span class="p">))</span>
<a name="ln-170"></a>    <span class="k">end if</span>
<a name="ln-171"></a>    <span class="c">!iangle = iangledeg * pi / 180.  ! convert degrees to radians</span>
<a name="ln-172"></a>    <span class="n">irecy</span> <span class="o">=</span> <span class="n">ib</span><span class="o">+</span><span class="n">iplane</span>
<a name="ln-173"></a>  <span class="c">! read coordinates of inletprofile  </span>
<a name="ln-174"></a>    <span class="k">call </span><span class="n">readzincoord</span>
<a name="ln-175"></a><span class="c">!    ddispdx      = 0.00038/Uinf        ! this value should becomputed from the w0 computed in the inletgenerator</span>
<a name="ln-176"></a>    <span class="n">ddispdx</span>      <span class="o">=</span> <span class="n">wtop</span><span class="o">/</span><span class="n">Uinf</span>            <span class="c">! wtop is read from zgrid.inf </span>
<a name="ln-177"></a>    <span class="n">ddispdxold</span>   <span class="o">=</span> <span class="n">ddispdx</span>              <span class="c">! this value should becomputed from the w0 computed in the inletgenerator</span>
<a name="ln-178"></a><span class="c">!    inlfactor    = nprocs/nprocsinl     ! nprocs should be larger or equal to nprocsin!</span>
<a name="ln-179"></a><span class="c">!    write(6,*) &#39;inlfactor= &#39;,inlfactor</span>
<a name="ln-180"></a>  <span class="k">else</span>
<a name="ln-181"></a><span class="k">   return</span>
<a name="ln-182"></a><span class="k">  end if</span>
<a name="ln-183"></a><span class="k"> </span>
<a name="ln-184"></a><span class="k">  end subroutine </span><span class="n">initinlet</span>
<a name="ln-185"></a>
<a name="ln-186"></a>  <span class="k">subroutine </span><span class="n">inletgen</span>
<a name="ln-187"></a>    <span class="k">use </span><span class="n">modglobal</span><span class="p">,</span>   <span class="n">only</span> <span class="p">:</span> <span class="n">ib</span><span class="p">,</span><span class="n">ie</span><span class="p">,</span><span class="n">jb</span><span class="p">,</span><span class="n">je</span><span class="p">,</span><span class="n">jgb</span><span class="p">,</span><span class="n">jge</span><span class="p">,</span><span class="n">kb</span><span class="p">,</span><span class="n">ke</span><span class="p">,</span><span class="n">zf</span><span class="p">,</span><span class="n">zh</span><span class="p">,</span><span class="n">dzf</span><span class="p">,</span><span class="n">dzhi</span><span class="p">,</span><span class="n">timee</span><span class="p">,</span><span class="n">btime</span><span class="p">,</span><span class="n">totavtime</span><span class="p">,</span><span class="n">rk3step</span><span class="p">,</span><span class="n">dt</span><span class="p">,</span><span class="n">numol</span><span class="p">,</span><span class="n">iplane</span><span class="p">,</span><span class="n">lles</span><span class="p">,</span><span class="n">iinletgen</span><span class="p">,</span><span class="n">inletav</span><span class="p">,</span><span class="n">runavtime</span><span class="p">,</span><span class="n">Uinf</span><span class="p">,</span><span class="n">lwallfunc</span><span class="p">,</span><span class="n">linletRA</span><span class="p">,</span><span class="n">totinletav</span><span class="p">,</span><span class="n">lstoreplane</span><span class="p">,</span><span class="n">nstore</span><span class="p">,</span><span class="n">prandtlmoli</span><span class="p">,</span><span class="n">numol</span><span class="p">,</span><span class="n">grav</span><span class="p">,</span><span class="n">lbuoyancy</span><span class="p">,</span><span class="n">lfixinlet</span><span class="p">,</span><span class="n">luvolflowr</span><span class="p">,</span><span class="n">lfixutauin</span>
<a name="ln-188"></a>    <span class="k">use </span><span class="n">modfields</span><span class="p">,</span>   <span class="n">only</span> <span class="p">:</span> <span class="n">u0</span><span class="p">,</span><span class="n">v0</span><span class="p">,</span><span class="n">w0</span><span class="p">,</span><span class="n">thl0</span><span class="p">,</span><span class="n">wm</span><span class="p">,</span><span class="n">uprof</span>
<a name="ln-189"></a>    <span class="k">use </span><span class="n">modsurfdata</span><span class="p">,</span> <span class="n">only</span> <span class="p">:</span> <span class="n">thls</span><span class="p">,</span><span class="n">thl_top</span>
<a name="ln-190"></a>    <span class="k">use </span><span class="n">modsave</span><span class="p">,</span>     <span class="n">only</span> <span class="p">:</span> <span class="n">writerestartfiles</span>
<a name="ln-191"></a>    <span class="k">use </span><span class="n">modmpi</span><span class="p">,</span>      <span class="n">only</span> <span class="p">:</span> <span class="n">slabsum</span><span class="p">,</span><span class="n">myid</span>
<a name="ln-192"></a>    <span class="k">implicit none</span>
<a name="ln-193"></a><span class="k">   </span>
<a name="ln-194"></a><span class="k">    </span><span class="kt">real</span><span class="p">,</span><span class="k">dimension</span><span class="p">(</span><span class="n">ib</span><span class="p">:</span><span class="n">ib</span><span class="p">,</span><span class="n">jb</span><span class="p">:</span><span class="n">je</span><span class="p">,</span><span class="n">kb</span><span class="p">:</span><span class="n">ke</span><span class="p">)</span>   <span class="kd">::</span> <span class="n">uinletbc2</span>   <span class="c">! dummy variable</span>
<a name="ln-195"></a>    <span class="kt">real</span><span class="p">,</span><span class="k">dimension</span><span class="p">(</span><span class="n">ib</span><span class="p">:</span><span class="n">ib</span><span class="p">,</span><span class="n">jb</span><span class="p">:</span><span class="n">je</span><span class="p">,</span><span class="n">kb</span><span class="p">:</span><span class="n">ke</span><span class="p">)</span>   <span class="kd">::</span> <span class="n">tinletbc2</span>   <span class="c">! dummy variable</span>
<a name="ln-196"></a>    <span class="kt">real</span><span class="p">,</span><span class="k">dimension</span><span class="p">(</span><span class="n">jb</span><span class="p">:</span><span class="n">je</span><span class="p">,</span><span class="n">kb</span><span class="p">:</span><span class="n">ke</span><span class="p">)</span>   <span class="kd">::</span> <span class="n">uprec</span>             <span class="c">! velocity fluctuation (up_rec = u0 - Urec)</span>
<a name="ln-197"></a>    <span class="kt">real</span><span class="p">,</span><span class="k">dimension</span><span class="p">(</span><span class="n">jb</span><span class="p">:</span><span class="n">je</span><span class="p">,</span><span class="n">kb</span><span class="p">:</span><span class="n">ke</span><span class="p">)</span>   <span class="kd">::</span> <span class="n">vprec</span>             <span class="c">! velocity fluctuation (vp_rec = v0 - 0)</span>
<a name="ln-198"></a>    <span class="kt">real</span><span class="p">,</span><span class="k">dimension</span><span class="p">(</span><span class="n">jb</span><span class="p">:</span><span class="n">je</span><span class="p">,</span><span class="n">kb</span><span class="p">:</span><span class="n">ke</span><span class="o">+</span><span class="mi">1</span><span class="p">)</span> <span class="kd">::</span> <span class="n">wprec</span>             <span class="c">! velocity fluctuation (wp_rec = w0 - Wrec)</span>
<a name="ln-199"></a>    <span class="kt">real</span><span class="p">,</span><span class="k">dimension</span><span class="p">(</span><span class="n">jb</span><span class="p">:</span><span class="n">je</span><span class="p">,</span><span class="n">kb</span><span class="p">:</span><span class="n">ke</span><span class="p">)</span>   <span class="kd">::</span> <span class="n">tprec</span>             <span class="c">! temperature fluctuation (tp_rec = t0 - Trec)</span>
<a name="ln-200"></a>    <span class="kt">real</span><span class="p">,</span><span class="k">dimension</span><span class="p">(</span><span class="n">jb</span><span class="p">:</span><span class="n">je</span><span class="p">,</span><span class="n">kb</span><span class="p">:</span><span class="n">ke</span><span class="p">)</span>   <span class="kd">::</span> <span class="n">upinli</span><span class="p">,</span><span class="n">vpinli</span>     <span class="c">! = gamma * (uprec,v interpolated to zii grid)</span>
<a name="ln-201"></a>    <span class="kt">real</span><span class="p">,</span><span class="k">dimension</span><span class="p">(</span><span class="n">jb</span><span class="p">:</span><span class="n">je</span><span class="p">,</span><span class="n">kb</span><span class="p">:</span><span class="n">ke</span><span class="p">)</span>   <span class="kd">::</span> <span class="n">tpinli</span>            <span class="c">! = lambda  * (tprec   interpolated to zii grid)</span>
<a name="ln-202"></a>    <span class="kt">real</span><span class="p">,</span><span class="k">dimension</span><span class="p">(</span><span class="n">jb</span><span class="p">:</span><span class="n">je</span><span class="p">,</span><span class="n">kb</span><span class="p">:</span><span class="n">ke</span><span class="p">)</span>   <span class="kd">::</span> <span class="n">upinlo</span><span class="p">,</span><span class="n">vpinlo</span>     <span class="c">! = gamma * (uprec,v interpolated to zoi grid)</span>
<a name="ln-203"></a>    <span class="kt">real</span><span class="p">,</span><span class="k">dimension</span><span class="p">(</span><span class="n">jb</span><span class="p">:</span><span class="n">je</span><span class="p">,</span><span class="n">kb</span><span class="p">:</span><span class="n">ke</span><span class="p">)</span>   <span class="kd">::</span> <span class="n">tpinlo</span>            <span class="c">! = lambda  * (tprec   interpolated to zoti grid)</span>
<a name="ln-204"></a>    <span class="kt">real</span><span class="p">,</span><span class="k">dimension</span><span class="p">(</span><span class="n">jb</span><span class="p">:</span><span class="n">je</span><span class="p">,</span><span class="n">kb</span><span class="p">:</span><span class="n">ke</span><span class="o">+</span><span class="mi">1</span><span class="p">)</span> <span class="kd">::</span> <span class="n">wpinli</span>            <span class="c">! = gamma * (wprec   interpolated to zii grid)</span>
<a name="ln-205"></a>    <span class="kt">real</span><span class="p">,</span><span class="k">dimension</span><span class="p">(</span><span class="n">jb</span><span class="p">:</span><span class="n">je</span><span class="p">,</span><span class="n">kb</span><span class="p">:</span><span class="n">ke</span><span class="o">+</span><span class="mi">1</span><span class="p">)</span> <span class="kd">::</span> <span class="n">wpinlo</span>            <span class="c">! = gamma * (wprec   interpolated to zoi grid)</span>
<a name="ln-206"></a>    <span class="kt">real</span><span class="p">,</span><span class="k">dimension</span><span class="p">(</span><span class="n">kb</span><span class="p">:</span><span class="n">ke</span><span class="p">)</span>   <span class="kd">::</span> <span class="n">udiff</span>                   <span class="c">! difference between Uinl and Urec</span>
<a name="ln-207"></a><span class="c">!    real,dimension(kb:ke)   :: Urecdiff                ! difference between Urec new and old</span>
<a name="ln-208"></a>    <span class="kt">real</span><span class="p">,</span><span class="k">dimension</span><span class="p">(</span><span class="n">kb</span><span class="p">:</span><span class="n">ke</span><span class="p">)</span>   <span class="kd">::</span> <span class="n">urav</span>                    <span class="c">! j-averaged u-velocity (not time-averaged) </span>
<a name="ln-209"></a>    <span class="kt">real</span><span class="p">,</span><span class="k">dimension</span><span class="p">(</span><span class="n">kb</span><span class="p">:</span><span class="n">ke</span><span class="p">)</span>   <span class="kd">::</span> <span class="n">trav</span>                    <span class="c">! j-averaged temperature (not time-averaged) </span>
<a name="ln-210"></a>    <span class="kt">real</span><span class="p">,</span><span class="k">dimension</span><span class="p">(</span><span class="n">kb</span><span class="p">:</span><span class="n">ke</span><span class="p">)</span>   <span class="kd">::</span> <span class="n">uravdzf</span>                 <span class="c">! j-averaged u-velocity (not time-averaged) times dzf</span>
<a name="ln-211"></a>    <span class="kt">real</span><span class="p">,</span><span class="k">dimension</span><span class="p">(</span><span class="n">kb</span><span class="p">:</span><span class="n">ke</span><span class="p">)</span>   <span class="kd">::</span> <span class="n">uinldzf</span>                 <span class="c">! j-averaged u-velocity (not time-averaged) times dzf</span>
<a name="ln-212"></a>    <span class="kt">real</span><span class="p">,</span><span class="k">dimension</span><span class="p">(</span><span class="n">kb</span><span class="p">:</span><span class="n">ke</span><span class="p">)</span>   <span class="kd">::</span> <span class="n">Urecdzf</span>                 <span class="c">! Urec times dzf</span>
<a name="ln-213"></a>    <span class="kt">real</span><span class="p">,</span><span class="k">dimension</span><span class="p">(</span><span class="n">kb</span><span class="p">:</span><span class="n">ke</span><span class="o">+</span><span class="mi">1</span><span class="p">)</span> <span class="kd">::</span> <span class="n">wrav</span>                    <span class="c">! j-averaged w-velocity (not time-averaged) </span>
<a name="ln-214"></a>    <span class="kt">real</span><span class="p">,</span><span class="k">dimension</span><span class="p">(</span><span class="n">kb</span><span class="p">:</span><span class="n">ke</span><span class="p">)</span>   <span class="kd">::</span> <span class="n">Uinli</span>                   <span class="c">! = gamma * (Urec interpolated to ziif grid points)</span>
<a name="ln-215"></a>    <span class="kt">real</span><span class="p">,</span><span class="k">dimension</span><span class="p">(</span><span class="n">kb</span><span class="p">:</span><span class="n">ke</span><span class="o">+</span><span class="mi">1</span><span class="p">)</span> <span class="kd">::</span> <span class="n">Winli</span>                   <span class="c">! = gamma * (Wrec interpolated to ziih grid points)</span>
<a name="ln-216"></a>    <span class="kt">real</span><span class="p">,</span><span class="k">dimension</span><span class="p">(</span><span class="n">kb</span><span class="p">:</span><span class="n">ke</span><span class="p">)</span>   <span class="kd">::</span> <span class="n">Tinli</span>                   <span class="c">! = lambda  * (Trec interpolated to ziif grid points)</span>
<a name="ln-217"></a>    <span class="kt">real</span><span class="p">,</span><span class="k">dimension</span><span class="p">(</span><span class="n">kb</span><span class="p">:</span><span class="n">ke</span><span class="p">)</span>   <span class="kd">::</span> <span class="n">Uinlo</span>                   <span class="c">! = gamma * (Urec interpolated to zioif grid points)</span>
<a name="ln-218"></a>    <span class="kt">real</span><span class="p">,</span><span class="k">dimension</span><span class="p">(</span><span class="n">kb</span><span class="p">:</span><span class="n">ke</span><span class="o">+</span><span class="mi">1</span><span class="p">)</span> <span class="kd">::</span> <span class="n">Winlo</span>                   <span class="c">! = gamma * (Wrec interpolated to zoih grid points)</span>
<a name="ln-219"></a>    <span class="kt">real</span><span class="p">,</span><span class="k">dimension</span><span class="p">(</span><span class="n">kb</span><span class="p">:</span><span class="n">ke</span><span class="p">)</span>   <span class="kd">::</span> <span class="n">Tinlo</span>                   <span class="c">! = lambda  * (Trec interpolated to zoti grid points)</span>
<a name="ln-220"></a>    <span class="kt">real</span><span class="p">,</span><span class="k">dimension</span><span class="p">(</span><span class="n">kb</span><span class="p">:</span><span class="n">ke</span><span class="p">)</span>   <span class="kd">::</span> <span class="n">wfuncf</span>                  <span class="c">! weight function at full level</span>
<a name="ln-221"></a>    <span class="kt">real</span><span class="p">,</span><span class="k">dimension</span><span class="p">(</span><span class="n">kb</span><span class="p">:</span><span class="n">ke</span><span class="o">+</span><span class="mi">1</span><span class="p">)</span> <span class="kd">::</span> <span class="n">wfunch</span>                  <span class="c">! weight function at half level</span>
<a name="ln-222"></a>    <span class="kt">real</span><span class="p">,</span><span class="k">dimension</span><span class="p">(</span><span class="n">kb</span><span class="p">:</span><span class="n">ke</span><span class="p">)</span>   <span class="kd">::</span> <span class="n">wfunct</span>                  <span class="c">! weight function at full level</span>
<a name="ln-223"></a>    <span class="kt">real</span>                    <span class="kd">::</span> <span class="n">utaur2</span><span class="p">,</span><span class="n">utaui2</span>           <span class="c">! (utau)^2 at recycle station and inlet</span>
<a name="ln-224"></a>    <span class="kt">real</span>                    <span class="kd">::</span> <span class="n">gamm</span>                    <span class="c">! utaui / utaur</span>
<a name="ln-225"></a>    <span class="kt">real</span>                    <span class="kd">::</span> <span class="n">lamb</span>                    <span class="c">! ttaui / ttaur</span>
<a name="ln-226"></a>    <span class="kt">real</span>                    <span class="kd">::</span> <span class="n">avint</span><span class="p">,</span><span class="n">avinti</span>            <span class="c">! avering interval</span>
<a name="ln-227"></a>    <span class="kt">real</span>                    <span class="kd">::</span> <span class="n">alpha</span><span class="p">,</span><span class="n">beta</span>              <span class="c">! factors used in the Weight function</span>
<a name="ln-228"></a><span class="c">!    real                    :: totalu                  ! total u-velocity at outlet</span>
<a name="ln-229"></a>    <span class="kt">real</span>                    <span class="kd">::</span> <span class="n">Urectot</span>                  <span class="c">! total u-velocity at recycle plane</span>
<a name="ln-230"></a>    <span class="kt">real</span>                    <span class="kd">::</span> <span class="n">rk3coef</span>
<a name="ln-231"></a><span class="c">!    real                    :: di_test                 ! BL thickness as measured from Uinl</span>
<a name="ln-232"></a>    <span class="kt">real</span>                    <span class="kd">::</span> <span class="n">utop</span>                    <span class="c">! j-averaged top velocity</span>
<a name="ln-233"></a>    <span class="kt">real</span>                    <span class="kd">::</span> <span class="n">interval</span>
<a name="ln-234"></a>    <span class="kt">real</span>                    <span class="kd">::</span> <span class="n">dtinrk</span>                  <span class="c">! RK time step in inlet data</span>
<a name="ln-235"></a>    <span class="kt">real</span>                    <span class="kd">::</span> <span class="n">rk3coefin</span>               <span class="c">! Cumulative RK time step in inlet data</span>
<a name="ln-236"></a>    <span class="kt">real</span>                    <span class="kd">::</span> <span class="n">dr_old</span>
<a name="ln-237"></a>    <span class="kt">real</span>                    <span class="kd">::</span> <span class="n">scalef</span>                      <span class="c">! scale factor to scale instantaneous velocity profile with to get constant mass flux</span>
<a name="ln-238"></a>    <span class="kt">real</span>                    <span class="kd">::</span> <span class="n">totaluinl</span>                   <span class="c">! bulk velocity at the inlet</span>
<a name="ln-239"></a><span class="c">!    real                    :: q0                      ! heat flux</span>
<a name="ln-240"></a>    <span class="kt">integer </span><span class="n">i</span><span class="p">,</span><span class="n">j</span><span class="p">,</span><span class="n">k</span><span class="p">,</span><span class="n">kk</span><span class="p">,</span><span class="n">kdamp</span>
<a name="ln-241"></a>
<a name="ln-242"></a>
<a name="ln-243"></a>   <span class="k">if</span> <span class="p">(</span><span class="n">iinletgen</span> <span class="o">==</span> <span class="mi">1</span><span class="p">)</span> <span class="k">then</span>
<a name="ln-244"></a>
<a name="ln-245"></a><span class="k">   </span><span class="n">u0inletbcold</span> <span class="o">=</span> <span class="n">u0inletbc</span>
<a name="ln-246"></a>   <span class="n">v0inletbcold</span> <span class="o">=</span> <span class="n">v0inletbc</span>
<a name="ln-247"></a>   <span class="n">w0inletbcold</span> <span class="o">=</span> <span class="n">w0inletbc</span>
<a name="ln-248"></a>   <span class="n">t0inletbcold</span> <span class="o">=</span> <span class="n">t0inletbc</span>    <span class="c">! temperature</span>
<a name="ln-249"></a>   <span class="n">totaluold</span>    <span class="o">=</span> <span class="n">totalu</span>
<a name="ln-250"></a>   <span class="n">displold</span>     <span class="o">=</span> <span class="n">displ</span>
<a name="ln-251"></a>   <span class="n">ddispdxold</span>   <span class="o">=</span> <span class="n">ddispdx</span>
<a name="ln-252"></a>
<a name="ln-253"></a>   <span class="c">! compute time-average velocities</span>
<a name="ln-254"></a>    <span class="n">rk3coef</span> <span class="o">=</span> <span class="n">dt</span> <span class="o">/</span> <span class="p">(</span><span class="mf">4.</span> <span class="o">-</span> <span class="nb">dble</span><span class="p">(</span><span class="n">rk3step</span><span class="p">))</span>
<a name="ln-255"></a>    <span class="k">if</span> <span class="p">(</span><span class="n">rk3step</span><span class="o">==</span><span class="mi">1</span><span class="p">)</span> <span class="k">then</span>
<a name="ln-256"></a><span class="k">      </span><span class="n">deltat</span> <span class="o">=</span> <span class="n">rk3coef</span>
<a name="ln-257"></a>    <span class="n">elseif</span> <span class="p">(</span><span class="n">rk3step</span><span class="o">==</span><span class="mi">2</span><span class="p">)</span> <span class="k">then</span>
<a name="ln-258"></a><span class="k">      </span><span class="n">deltat</span> <span class="o">=</span> <span class="n">rk3coef</span> <span class="o">-</span> <span class="p">(</span><span class="n">dt</span><span class="o">/</span><span class="mf">3.</span><span class="p">)</span>
<a name="ln-259"></a>    <span class="n">elseif</span> <span class="p">(</span><span class="n">rk3step</span><span class="o">==</span><span class="mi">3</span><span class="p">)</span> <span class="k">then</span>
<a name="ln-260"></a><span class="k">      </span><span class="n">deltat</span> <span class="o">=</span> <span class="n">rk3coef</span> <span class="o">-</span> <span class="p">(</span><span class="n">dt</span><span class="o">/</span><span class="mf">2.</span><span class="p">)</span>
<a name="ln-261"></a>    <span class="k">end if</span>
<a name="ln-262"></a>
<a name="ln-263"></a><span class="k">    if</span> <span class="p">(</span><span class="n">linletRA</span><span class="p">)</span> <span class="k">then</span>  <span class="c">! this is a switch to use &#39;running average&#39;</span>
<a name="ln-264"></a>      <span class="n">avint</span> <span class="o">=</span> <span class="n">totinletav</span> <span class="o">+</span> <span class="n">timee</span><span class="o">-</span><span class="n">btime</span> <span class="c">! runav interval = averaging interval previuous sim  + current elapsed sim time</span>
<a name="ln-265"></a>    <span class="k">else</span>
<a name="ln-266"></a><span class="k">      </span><span class="n">avint</span>  <span class="o">=</span> <span class="n">inletav</span>
<a name="ln-267"></a>    <span class="k">end if</span>
<a name="ln-268"></a><span class="k">    </span><span class="n">avinti</span> <span class="o">=</span> <span class="mf">1.</span><span class="o">/</span><span class="n">avint</span>
<a name="ln-269"></a>    <span class="n">uaver</span><span class="o">=</span><span class="mf">0.</span> 
<a name="ln-270"></a>    <span class="n">taver</span><span class="o">=</span><span class="mf">0.</span> 
<a name="ln-271"></a>    <span class="k">do </span><span class="n">i</span><span class="o">=</span><span class="n">ib</span><span class="p">,</span><span class="n">ie</span>
<a name="ln-272"></a>      <span class="k">call </span><span class="n">slabsum</span><span class="p">(</span><span class="n">uaver</span><span class="p">(</span><span class="n">i</span><span class="p">,:),</span><span class="n">kb</span><span class="p">,</span><span class="n">ke</span><span class="p">,</span>  <span class="n">u0</span><span class="p">(</span><span class="n">i</span><span class="p">:</span><span class="n">i</span><span class="p">,</span><span class="n">jb</span><span class="p">:</span><span class="n">je</span><span class="p">,</span><span class="n">kb</span><span class="p">:</span><span class="n">ke</span><span class="p">),</span><span class="n">i</span><span class="p">,</span><span class="n">i</span><span class="p">,</span><span class="n">jb</span><span class="p">,</span><span class="n">je</span><span class="p">,</span><span class="n">kb</span><span class="p">,</span><span class="n">ke</span><span class="p">,</span><span class="n">i</span><span class="p">,</span><span class="n">i</span><span class="p">,</span><span class="n">jb</span><span class="p">,</span><span class="n">je</span><span class="p">,</span><span class="n">kb</span><span class="p">,</span><span class="n">ke</span><span class="p">)</span>
<a name="ln-273"></a>      <span class="k">call </span><span class="n">slabsum</span><span class="p">(</span><span class="n">taver</span><span class="p">(</span><span class="n">i</span><span class="p">,:),</span><span class="n">kb</span><span class="p">,</span><span class="n">ke</span><span class="p">,</span><span class="n">thl0</span><span class="p">(</span><span class="n">i</span><span class="p">:</span><span class="n">i</span><span class="p">,</span><span class="n">jb</span><span class="p">:</span><span class="n">je</span><span class="p">,</span><span class="n">kb</span><span class="p">:</span><span class="n">ke</span><span class="p">),</span><span class="n">i</span><span class="p">,</span><span class="n">i</span><span class="p">,</span><span class="n">jb</span><span class="p">,</span><span class="n">je</span><span class="p">,</span><span class="n">kb</span><span class="p">,</span><span class="n">ke</span><span class="p">,</span><span class="n">i</span><span class="p">,</span><span class="n">i</span><span class="p">,</span><span class="n">jb</span><span class="p">,</span><span class="n">je</span><span class="p">,</span><span class="n">kb</span><span class="p">,</span><span class="n">ke</span><span class="p">)</span>
<a name="ln-274"></a>    <span class="k">end do</span>
<a name="ln-275"></a>
<a name="ln-276"></a><span class="k">    </span><span class="n">wrav</span><span class="o">=</span><span class="mf">0.</span>
<a name="ln-277"></a>    <span class="k">call </span><span class="n">slabsum</span><span class="p">(</span><span class="n">wrav</span><span class="p">(</span><span class="n">kb</span><span class="p">:</span><span class="n">ke</span><span class="o">+</span><span class="mi">1</span><span class="p">),</span><span class="n">kb</span><span class="p">,</span><span class="n">ke</span><span class="p">,</span><span class="n">w0</span><span class="p">(</span><span class="n">irecy</span><span class="o">-</span><span class="mi">1</span><span class="p">:</span><span class="n">irecy</span><span class="o">-</span><span class="mi">1</span><span class="p">,</span><span class="n">jb</span><span class="p">:</span><span class="n">je</span><span class="p">,</span><span class="n">kb</span><span class="p">:</span><span class="n">ke</span><span class="o">+</span><span class="mi">1</span><span class="p">),</span><span class="n">irecy</span><span class="o">-</span><span class="mi">1</span><span class="p">,</span><span class="n">irecy</span><span class="o">-</span><span class="mi">1</span><span class="p">,</span><span class="n">jb</span><span class="p">,</span><span class="n">je</span><span class="p">,</span><span class="n">kb</span><span class="p">,</span><span class="n">ke</span><span class="o">+</span><span class="mi">1</span><span class="p">,</span><span class="n">irecy</span><span class="o">-</span><span class="mi">1</span><span class="p">,</span><span class="n">irecy</span><span class="o">-</span><span class="mi">1</span><span class="p">,</span><span class="n">jb</span><span class="p">,</span><span class="n">je</span><span class="p">,</span><span class="n">kb</span><span class="p">,</span><span class="n">ke</span><span class="o">+</span><span class="mi">1</span><span class="p">)</span>
<a name="ln-278"></a>    <span class="n">trav</span><span class="o">=</span><span class="mf">0.</span>
<a name="ln-279"></a>    <span class="k">call </span><span class="n">slabsum</span><span class="p">(</span><span class="n">trav</span><span class="p">(</span><span class="n">kb</span><span class="p">:</span><span class="n">ke</span><span class="p">),</span>  <span class="n">kb</span><span class="p">,</span><span class="n">ke</span><span class="p">,</span><span class="n">thl0</span><span class="p">(</span><span class="n">irecy</span><span class="o">-</span><span class="mi">1</span><span class="p">:</span><span class="n">irecy</span><span class="o">-</span><span class="mi">1</span><span class="p">,</span><span class="n">jb</span><span class="p">:</span><span class="n">je</span><span class="p">,</span><span class="n">kb</span><span class="p">:</span><span class="n">ke</span><span class="p">),</span> <span class="n">irecy</span><span class="o">-</span><span class="mi">1</span><span class="p">,</span><span class="n">irecy</span><span class="o">-</span><span class="mi">1</span><span class="p">,</span><span class="n">jb</span><span class="p">,</span><span class="n">je</span><span class="p">,</span><span class="n">kb</span><span class="p">,</span><span class="n">ke</span><span class="p">,</span>  <span class="n">irecy</span><span class="o">-</span><span class="mi">1</span><span class="p">,</span><span class="n">irecy</span><span class="o">-</span><span class="mi">1</span><span class="p">,</span><span class="n">jb</span><span class="p">,</span><span class="n">je</span><span class="p">,</span><span class="n">kb</span><span class="p">,</span><span class="n">ke</span><span class="p">)</span>
<a name="ln-280"></a>
<a name="ln-281"></a>    <span class="n">uaver</span> <span class="o">=</span> <span class="n">uaver</span> <span class="o">/</span> <span class="p">(</span><span class="n">jge</span><span class="o">-</span><span class="n">jgb</span> <span class="o">+</span><span class="mi">1</span><span class="p">)</span>                    <span class="c">! average over j-direction</span>
<a name="ln-282"></a>    <span class="n">taver</span> <span class="o">=</span> <span class="n">taver</span> <span class="o">/</span> <span class="p">(</span><span class="n">jge</span><span class="o">-</span><span class="n">jgb</span> <span class="o">+</span><span class="mi">1</span><span class="p">)</span>                    <span class="c">! average over j-direction</span>
<a name="ln-283"></a>    <span class="n">urav</span> <span class="o">=</span> <span class="n">uaver</span><span class="p">(</span><span class="n">irecy</span><span class="p">,:)</span>
<a name="ln-284"></a>    <span class="n">wrav</span> <span class="o">=</span> <span class="n">wrav</span> <span class="o">/</span> <span class="p">(</span><span class="n">jge</span><span class="o">-</span><span class="n">jgb</span> <span class="o">+</span><span class="mi">1</span><span class="p">)</span>                    <span class="c">! average over j-direction</span>
<a name="ln-285"></a>    <span class="n">trav</span> <span class="o">=</span> <span class="n">trav</span> <span class="o">/</span> <span class="p">(</span><span class="n">jge</span><span class="o">-</span><span class="n">jgb</span> <span class="o">+</span><span class="mi">1</span><span class="p">)</span>                    <span class="c">! average over j-direction</span>
<a name="ln-286"></a>
<a name="ln-287"></a>    <span class="k">do </span><span class="n">k</span><span class="o">=</span><span class="n">kb</span><span class="p">,</span><span class="n">ke</span>
<a name="ln-288"></a>      <span class="n">Urec</span><span class="p">(</span><span class="n">k</span><span class="p">)</span> <span class="o">=</span>  <span class="n">urav</span><span class="p">(</span><span class="n">k</span><span class="p">)</span><span class="o">*</span><span class="n">deltat</span><span class="o">*</span><span class="n">avinti</span> <span class="o">+</span> <span class="p">(</span><span class="mf">1.</span><span class="o">-</span><span class="n">deltat</span><span class="o">*</span><span class="n">avinti</span><span class="p">)</span><span class="o">*</span><span class="n">Urec</span><span class="p">(</span><span class="n">k</span><span class="p">)</span>
<a name="ln-289"></a>      <span class="n">Trec</span><span class="p">(</span><span class="n">k</span><span class="p">)</span> <span class="o">=</span>  <span class="n">trav</span><span class="p">(</span><span class="n">k</span><span class="p">)</span><span class="o">*</span><span class="n">deltat</span><span class="o">*</span><span class="n">avinti</span> <span class="o">+</span> <span class="p">(</span><span class="mf">1.</span><span class="o">-</span><span class="n">deltat</span><span class="o">*</span><span class="n">avinti</span><span class="p">)</span><span class="o">*</span><span class="n">Trec</span><span class="p">(</span><span class="n">k</span><span class="p">)</span>
<a name="ln-290"></a>    <span class="k">end do</span>
<a name="ln-291"></a><span class="k">    do </span><span class="n">k</span><span class="o">=</span><span class="n">kb</span><span class="p">,</span><span class="n">ke</span><span class="o">+</span><span class="mi">1</span>
<a name="ln-292"></a>      <span class="n">Wrec</span><span class="p">(</span><span class="n">k</span><span class="p">)</span> <span class="o">=</span>  <span class="n">wrav</span><span class="p">(</span><span class="n">k</span><span class="p">)</span><span class="o">*</span><span class="n">deltat</span><span class="o">*</span><span class="n">avinti</span> <span class="o">+</span> <span class="p">(</span><span class="mf">1.</span><span class="o">-</span><span class="n">deltat</span><span class="o">*</span><span class="n">avinti</span><span class="p">)</span><span class="o">*</span><span class="n">Wrec</span><span class="p">(</span><span class="n">k</span><span class="p">)</span>
<a name="ln-293"></a>    <span class="k">end do</span>
<a name="ln-294"></a><span class="k">    do </span><span class="n">k</span><span class="o">=</span><span class="n">kb</span><span class="p">,</span><span class="n">ke</span>
<a name="ln-295"></a>    <span class="k">do </span><span class="n">i</span><span class="o">=</span><span class="n">ib</span><span class="p">,</span><span class="n">ie</span>
<a name="ln-296"></a>      <span class="n">Utav</span><span class="p">(</span><span class="n">i</span><span class="p">,</span><span class="n">k</span><span class="p">)</span> <span class="o">=</span>  <span class="n">uaver</span><span class="p">(</span><span class="n">i</span><span class="p">,</span><span class="n">k</span><span class="p">)</span><span class="o">*</span><span class="n">deltat</span><span class="o">*</span><span class="n">avinti</span> <span class="o">+</span> <span class="p">(</span><span class="mf">1.</span><span class="o">-</span><span class="n">deltat</span><span class="o">*</span><span class="n">avinti</span><span class="p">)</span><span class="o">*</span><span class="n">Utav</span><span class="p">(</span><span class="n">i</span><span class="p">,</span><span class="n">k</span><span class="p">)</span>
<a name="ln-297"></a>      <span class="n">Ttav</span><span class="p">(</span><span class="n">i</span><span class="p">,</span><span class="n">k</span><span class="p">)</span> <span class="o">=</span>  <span class="n">taver</span><span class="p">(</span><span class="n">i</span><span class="p">,</span><span class="n">k</span><span class="p">)</span><span class="o">*</span><span class="n">deltat</span><span class="o">*</span><span class="n">avinti</span> <span class="o">+</span> <span class="p">(</span><span class="mf">1.</span><span class="o">-</span><span class="n">deltat</span><span class="o">*</span><span class="n">avinti</span><span class="p">)</span><span class="o">*</span><span class="n">Ttav</span><span class="p">(</span><span class="n">i</span><span class="p">,</span><span class="n">k</span><span class="p">)</span>
<a name="ln-298"></a>    <span class="k">end do</span>
<a name="ln-299"></a><span class="k">    end do</span>
<a name="ln-300"></a>   
<a name="ln-301"></a><span class="c">!    Urec = Urec +(Uinf-Urec(ke))     ! make sure at the recycle plane the top velocity equals Uinf</span>
<a name="ln-302"></a>      
<a name="ln-303"></a>
<a name="ln-304"></a><span class="c">!    Urecdiff = Urecdiff - Urec </span>
<a name="ln-305"></a><span class="c">!    if (myid==0) then</span>
<a name="ln-306"></a><span class="c">!      write(6,*) &#39;Urec_old - Urec_new (kb+40)=&#39;,Urecdiff(kb+40) </span>
<a name="ln-307"></a><span class="c">!    end if</span>
<a name="ln-308"></a>
<a name="ln-309"></a><span class="c">!! check if Urec contains NaN</span>
<a name="ln-310"></a><span class="c">!    if (myid==0) then</span>
<a name="ln-311"></a><span class="c">!      write(6,*) &#39;Checking Urec for NaN&#39; </span>
<a name="ln-312"></a><span class="c">!      do k=kb,ke</span>
<a name="ln-313"></a><span class="c">!        if (ISNAN(Urec(k))) then</span>
<a name="ln-314"></a><span class="c">!          write(6,*) &#39;Urec(k)=NaN at k=kb+&#39;, k-kb</span>
<a name="ln-315"></a><span class="c">!        end if</span>
<a name="ln-316"></a><span class="c">!      end do</span>
<a name="ln-317"></a><span class="c">!      write(6,*) &#39;Finished checking Urec for NaN&#39;  </span>
<a name="ln-318"></a><span class="c">!    end if</span>
<a name="ln-319"></a>
<a name="ln-320"></a>
<a name="ln-321"></a><span class="c">!    if (myid==0) then</span>
<a name="ln-322"></a><span class="c">!      write(6,*) &#39;myid, Urec(ke)=&#39;,myid, Urec(ke)</span>
<a name="ln-323"></a><span class="c">!      write(6,*) &#39;wrav(ke), Wrec(ke)=&#39;,wrav(ke), Wrec(ke)</span>
<a name="ln-324"></a><span class="c">!      write(6,*) &#39;wrav(ke-1), Wrec(ke-1)=&#39;,wrav(ke-1), Wrec(ke-1)</span>
<a name="ln-325"></a><span class="c">!      write(6,*) &#39;wrav(ke-10), Wrec(ke-10)=&#39;,wrav(ke-10), Wrec(ke-10)</span>
<a name="ln-326"></a><span class="c">!      write(6,*) &#39;wrav(ke-30), Wrec(ke-30)=&#39;,wrav(ke-30), Wrec(ke-30)</span>
<a name="ln-327"></a><span class="c">!      write(6,*) &#39;wrav(kb+10), Wrec(kb+10)=&#39;,wrav(kb+10), Wrec(kb+10)</span>
<a name="ln-328"></a><span class="c">!      write(6,*) &#39;wrav(kb+11), Wrec(kb+11)=&#39;,wrav(kb+11), Wrec(kb+11)</span>
<a name="ln-329"></a><span class="c">!    end if</span>
<a name="ln-330"></a>
<a name="ln-331"></a>
<a name="ln-332"></a>   <span class="c">! compute velocity fluctuation at recycle station</span>
<a name="ln-333"></a>    <span class="k">do </span><span class="n">k</span><span class="o">=</span><span class="n">kb</span><span class="p">,</span><span class="n">ke</span>
<a name="ln-334"></a>      <span class="k">do </span><span class="n">j</span><span class="o">=</span><span class="n">jb</span><span class="p">,</span><span class="n">je</span>
<a name="ln-335"></a>        <span class="n">uprec</span><span class="p">(</span><span class="n">j</span><span class="p">,</span><span class="n">k</span><span class="p">)</span> <span class="o">=</span> <span class="n">u0</span><span class="p">(</span><span class="n">irecy</span><span class="p">,</span><span class="n">j</span><span class="p">,</span><span class="n">k</span><span class="p">)</span> <span class="o">-</span> <span class="n">Urec</span><span class="p">(</span><span class="n">k</span><span class="p">)</span>
<a name="ln-336"></a>        <span class="n">vprec</span><span class="p">(</span><span class="n">j</span><span class="p">,</span><span class="n">k</span><span class="p">)</span> <span class="o">=</span> <span class="n">v0</span><span class="p">(</span><span class="n">irecy</span><span class="o">-</span><span class="mi">1</span><span class="p">,</span><span class="n">j</span><span class="p">,</span><span class="n">k</span><span class="p">)</span>             <span class="c">! mean v is zero</span>
<a name="ln-337"></a>        <span class="n">tprec</span><span class="p">(</span><span class="n">j</span><span class="p">,</span><span class="n">k</span><span class="p">)</span> <span class="o">=</span> <span class="n">thl0</span><span class="p">(</span><span class="n">irecy</span><span class="o">-</span><span class="mi">1</span><span class="p">,</span><span class="n">j</span><span class="p">,</span><span class="n">k</span><span class="p">)</span> <span class="o">-</span> <span class="n">Trec</span><span class="p">(</span><span class="n">k</span><span class="p">)</span>
<a name="ln-338"></a>      <span class="k">end do</span>
<a name="ln-339"></a><span class="k">    end do</span>
<a name="ln-340"></a>
<a name="ln-341"></a><span class="k">    do </span><span class="n">k</span><span class="o">=</span><span class="n">kb</span><span class="p">,</span><span class="n">ke</span><span class="o">+</span><span class="mi">1</span>
<a name="ln-342"></a>      <span class="k">do </span><span class="n">j</span><span class="o">=</span><span class="n">jb</span><span class="p">,</span><span class="n">je</span>
<a name="ln-343"></a>        <span class="n">wprec</span><span class="p">(</span><span class="n">j</span><span class="p">,</span><span class="n">k</span><span class="p">)</span> <span class="o">=</span> <span class="n">w0</span><span class="p">(</span><span class="n">irecy</span><span class="o">-</span><span class="mi">1</span><span class="p">,</span><span class="n">j</span><span class="p">,</span><span class="n">k</span><span class="p">)</span> <span class="o">-</span> <span class="n">Wrec</span><span class="p">(</span><span class="n">k</span><span class="p">)</span>   <span class="c">! note that w-velocity is taken at i=irecy-1 !!</span>
<a name="ln-344"></a>      <span class="k">end do</span>
<a name="ln-345"></a><span class="k">    end do</span>
<a name="ln-346"></a>
<a name="ln-347"></a><span class="k"> </span>
<a name="ln-348"></a><span class="k">    if</span> <span class="p">(</span><span class="n">lwallfunc</span><span class="p">)</span> <span class="k">then</span>
<a name="ln-349"></a><span class="k">      call </span><span class="n">wallawinlet</span><span class="p">(</span><span class="n">Urec</span><span class="p">(</span><span class="n">kb</span><span class="p">),</span><span class="n">dzf</span><span class="p">(</span><span class="n">kb</span><span class="p">),</span><span class="n">numol</span><span class="p">,</span><span class="n">utaur2</span><span class="p">)</span>    <span class="c">! compute wall shear stress at recycle station</span>
<a name="ln-350"></a>    <span class="k">else</span>
<a name="ln-351"></a><span class="k">      </span><span class="n">utaur2</span> <span class="o">=</span> <span class="mf">2.</span><span class="o">*</span><span class="n">numol</span><span class="o">*</span><span class="n">Urec</span><span class="p">(</span><span class="n">kb</span><span class="p">)</span><span class="o">/</span><span class="n">dzf</span><span class="p">(</span><span class="n">kb</span><span class="p">)</span>
<a name="ln-352"></a>    <span class="k">end if</span>
<a name="ln-353"></a><span class="k">    </span><span class="n">utaur</span> <span class="o">=</span> <span class="nb">sqrt</span><span class="p">(</span><span class="nb">abs</span><span class="p">(</span><span class="n">utaur2</span><span class="p">))</span>                          <span class="c">! compute utau at recycle station</span>
<a name="ln-354"></a>    <span class="c">! heat flux at recycle station (isothermal wall) q = alpha * dT/dz = (nu/prandtl) * dT/dz </span>
<a name="ln-355"></a><span class="c">!    q0 = numol*prandtlmoli*(Trec(kb) - Trec(kb-1)) * dzhi(kb) </span>
<a name="ln-356"></a>    <span class="n">q0</span> <span class="o">=</span> <span class="n">numol</span><span class="o">*</span><span class="n">prandtlmoli</span><span class="o">*</span><span class="mi">2</span><span class="o">*</span><span class="p">(</span><span class="n">Trec</span><span class="p">(</span><span class="n">kb</span><span class="p">)</span> <span class="o">-</span> <span class="n">thls</span><span class="p">)</span> <span class="o">/</span> <span class="n">dzf</span><span class="p">(</span><span class="n">kb</span><span class="p">)</span> 
<a name="ln-357"></a>    <span class="n">ttaur</span> <span class="o">=</span> <span class="n">q0</span><span class="o">/</span><span class="n">utaur</span>                <span class="c">! ttau = q/(rho*cp*utau) =  (alpha *dT/dz) / utau</span>
<a name="ln-358"></a>   <span class="c">! compute momentum thickness at inlet and recycle plane</span>
<a name="ln-359"></a>  
<a name="ln-360"></a>   <span class="k">if</span><span class="p">(</span><span class="n">lbuoyancy</span><span class="p">)</span> <span class="k">then</span>
<a name="ln-361"></a><span class="k">     </span><span class="n">lmor</span> <span class="o">=</span> <span class="p">(</span><span class="n">thls</span><span class="o">*</span> <span class="n">utaur</span><span class="o">**</span><span class="mi">2</span> <span class="p">)</span><span class="o">/</span> <span class="p">(</span><span class="mf">0.41</span> <span class="o">*</span> <span class="n">grav</span> <span class="o">*</span> <span class="n">ttaur</span><span class="p">)</span>      <span class="c">! L = -T0*utau^3 / kappa*g*&lt;w&#39;T&#39;&gt; =  </span>
<a name="ln-362"></a><span class="c">!     write(6,*) &#39;Initial dr,myid, utaur, ttaur, Lmor =&#39;, dr,myid,utaur,ttaur,lmor</span>
<a name="ln-363"></a><span class="c">!     lmor = 0.3;</span>
<a name="ln-364"></a>     <span class="n">lmoi</span> <span class="o">=</span> <span class="p">(</span><span class="n">thls</span><span class="o">*</span> <span class="n">utaui</span><span class="o">**</span><span class="mi">2</span> <span class="p">)</span><span class="o">/</span> <span class="p">(</span><span class="mf">0.41</span> <span class="o">*</span> <span class="n">grav</span> <span class="o">*</span> <span class="n">ttaui</span><span class="p">)</span>      <span class="c">! L = -T0*utau^3 / kappa*g*&lt;w&#39;T&#39;&gt; = </span>
<a name="ln-365"></a><span class="c">!     lmoi = 0.3;</span>
<a name="ln-366"></a><span class="c">!     write(6,*) &#39;Initial di_test,myid, utaui, ttaui, Lmoi =&#39;, di_test,myid,utaui,ttaui,lmoi</span>
<a name="ln-367"></a>     <span class="n">dr_old</span> <span class="o">=</span> <span class="n">dr</span>
<a name="ln-368"></a>
<a name="ln-369"></a><span class="c">!     call blthicknessmo(dr,utaur,lmor)                    ! Also needed for momentumthickness</span>
<a name="ln-370"></a>     <span class="k">call </span><span class="n">blthicknesst</span><span class="p">(</span><span class="n">dr</span><span class="p">,</span><span class="n">Urec</span><span class="p">,</span><span class="mf">0.99</span><span class="p">)</span>            <span class="c">! changed back to this one (instead of the above)</span>
<a name="ln-371"></a>
<a name="ln-372"></a><span class="c">!     call momentumthicknessmo(thetai,utaui,di,lmoi)</span>
<a name="ln-373"></a><span class="c">!     call momentumthicknessmo(thetar,utaur,dr,lmor)</span>
<a name="ln-374"></a>     <span class="k">call </span><span class="n">momentumthicknessexp</span><span class="p">(</span><span class="n">thetai</span><span class="p">,</span><span class="n">Uinl</span><span class="p">)</span>
<a name="ln-375"></a>     <span class="k">call </span><span class="n">momentumthicknessexp</span><span class="p">(</span><span class="n">thetar</span><span class="p">,</span><span class="n">Urec</span><span class="p">)</span>
<a name="ln-376"></a>   <span class="k">else</span>
<a name="ln-377"></a><span class="c">!     call blthickness(dr,utaur)                           ! Also needed for momentumthickness</span>
<a name="ln-378"></a>     <span class="k">call </span><span class="n">blthicknesst</span><span class="p">(</span><span class="n">dr</span><span class="p">,</span><span class="n">Urec</span><span class="p">,</span><span class="mf">0.99</span><span class="p">)</span>                        
<a name="ln-379"></a><span class="c">!     call momentumthickness(thetai,utaui,di)</span>
<a name="ln-380"></a><span class="c">!     call momentumthickness(thetar,utaur,dr)</span>
<a name="ln-381"></a>     <span class="k">call </span><span class="n">momentumthicknessexp</span><span class="p">(</span><span class="n">thetai</span><span class="p">,</span><span class="n">Uinl</span><span class="p">)</span>
<a name="ln-382"></a>     <span class="k">call </span><span class="n">momentumthicknessexp</span><span class="p">(</span><span class="n">thetar</span><span class="p">,</span><span class="n">Urec</span><span class="p">)</span>
<a name="ln-383"></a>   <span class="k">end if</span>
<a name="ln-384"></a><span class="k">   call </span><span class="n">enthalpythickness</span><span class="p">(</span><span class="n">thetati</span><span class="p">,</span><span class="n">Tinl</span><span class="p">,</span><span class="n">Uinl</span><span class="p">)</span>
<a name="ln-385"></a>   <span class="k">call </span><span class="n">enthalpythickness</span><span class="p">(</span><span class="n">thetatr</span><span class="p">,</span><span class="n">Trec</span><span class="p">,</span><span class="n">Urec</span><span class="p">)</span>
<a name="ln-386"></a><span class="c">!   call blthickness(dr,utaur)</span>
<a name="ln-387"></a>   <span class="k">call </span><span class="n">blthicknesst</span><span class="p">(</span><span class="n">dtr</span><span class="p">,</span><span class="n">Trec</span><span class="o">-</span><span class="n">thls</span><span class="p">,</span><span class="mf">0.99</span><span class="p">)</span>
<a name="ln-388"></a>   <span class="c">! compute utau at inlet from interior field </span>
<a name="ln-389"></a><span class="c">!    if (thetai == 0.) then</span>
<a name="ln-390"></a><span class="c">!      write(6,*) &#39;!!! thetai = 0, myid=&#39;,myid  </span>
<a name="ln-391"></a><span class="c">!    else if (thetar == 0.) then</span>
<a name="ln-392"></a><span class="c">!      write(6,*) &#39;!!! thetar = 0, myid=&#39;,myid      </span>
<a name="ln-393"></a><span class="c">!      thetar=0.00001 </span>
<a name="ln-394"></a><span class="c">!    else</span>
<a name="ln-395"></a><span class="c">!      utaui = utaur* (thetar/thetai)**(1./8.)    ! See Lund (1998): &#39;Similar to Ludwig-Tillmann correlation&#39;</span>
<a name="ln-396"></a>    <span class="k">if</span> <span class="p">(.</span><span class="nb">not</span><span class="p">.</span><span class="n">lfixutauin</span><span class="p">)</span> <span class="k">then </span>
<a name="ln-397"></a><span class="k">      </span><span class="n">utaui</span>  <span class="o">=</span> <span class="n">utaur</span><span class="o">*</span> <span class="nb">abs</span><span class="p">(</span><span class="n">thetar</span><span class="o">/</span><span class="n">thetai</span><span class="p">)</span><span class="o">**</span><span class="p">(</span><span class="mf">1.</span><span class="o">/</span><span class="mf">8.</span><span class="p">)</span>   <span class="c">! See Lund (1998): &#39;Similar to Ludwig-Tillmann correlation&#39;</span>
<a name="ln-398"></a>    <span class="k">end if</span>
<a name="ln-399"></a><span class="k">    if</span> <span class="p">(</span><span class="n">thetati</span> <span class="o">==</span> <span class="mf">0.</span><span class="p">)</span> <span class="k">then</span>
<a name="ln-400"></a><span class="k">      </span><span class="n">thetati</span> <span class="o">=</span> <span class="mf">0.0000001</span>
<a name="ln-401"></a>    <span class="k">end if  </span>
<a name="ln-402"></a><span class="k">    </span><span class="n">ttaui</span> <span class="o">=</span> <span class="n">ttaur</span><span class="o">*</span><span class="nb">abs</span><span class="p">(</span><span class="n">thetatr</span><span class="o">/</span><span class="n">thetati</span><span class="p">)</span><span class="o">**</span><span class="p">(</span><span class="mf">1.</span><span class="o">/</span><span class="mf">8.</span><span class="p">)</span>   <span class="c">! See Kong (2000):  </span>
<a name="ln-403"></a><span class="c">!    end if</span>
<a name="ln-404"></a>    <span class="n">gamm</span> <span class="o">=</span> <span class="n">utaui</span> <span class="o">/</span> <span class="n">utaur</span>                          <span class="c">! Gamma in Lund (1998)</span>
<a name="ln-405"></a>    <span class="k">if</span> <span class="p">(</span><span class="n">ttaur</span> <span class="o">==</span> <span class="mf">0.</span><span class="p">)</span> <span class="k">then</span>
<a name="ln-406"></a><span class="k">      </span><span class="n">ttaur</span> <span class="o">=</span> <span class="mf">0.0000001</span>
<a name="ln-407"></a>    <span class="k">end if</span>
<a name="ln-408"></a><span class="k">    </span><span class="n">lamb</span> <span class="o">=</span> <span class="n">ttaui</span> <span class="o">/</span> <span class="n">ttaur</span>                          <span class="c">! Lambda in Kong (2000)</span>
<a name="ln-409"></a>
<a name="ln-410"></a>   <span class="c">! compute inner scaling coordinates</span>
<a name="ln-411"></a>    <span class="n">zirf</span> <span class="o">=</span> <span class="n">utaur</span><span class="o">*</span><span class="n">zf</span> <span class="o">/</span> <span class="n">numol</span>                       <span class="c">! inner scaling zf-coordinate at recycle station </span>
<a name="ln-412"></a>    <span class="n">zirh</span> <span class="o">=</span> <span class="n">utaur</span><span class="o">*</span><span class="n">zh</span> <span class="o">/</span> <span class="n">numol</span>                       <span class="c">! inner scaling zh-coordinate at recycle station</span>
<a name="ln-413"></a>    <span class="n">ziif</span> <span class="o">=</span> <span class="n">utaui</span><span class="o">*</span><span class="n">zf</span> <span class="o">/</span> <span class="n">numol</span>                       <span class="c">! inner scaling zf-coordinate at inlet station </span>
<a name="ln-414"></a>    <span class="n">ziih</span> <span class="o">=</span> <span class="n">utaui</span><span class="o">*</span><span class="n">zh</span> <span class="o">/</span> <span class="n">numol</span>                       <span class="c">! inner scaling zh-coordinate at inlet station </span>
<a name="ln-415"></a>  
<a name="ln-416"></a>   <span class="c">! compute outer scaling coordinates   </span>
<a name="ln-417"></a>    <span class="n">zorf</span> <span class="o">=</span> <span class="n">zf</span> <span class="o">/</span> <span class="n">dr</span>                                <span class="c">! outer scaling zf-coor as measured from Uinldinate at recycle station </span>
<a name="ln-418"></a>    <span class="n">zorh</span> <span class="o">=</span> <span class="n">zh</span> <span class="o">/</span> <span class="n">dr</span>                                <span class="c">! outer scaling zh-coordinate at recycle station </span>
<a name="ln-419"></a>    <span class="n">zoif</span> <span class="o">=</span> <span class="n">zf</span> <span class="o">/</span> <span class="n">di</span>                                <span class="c">! outer scaling zf-coordinate at inlet station  (could be done once, actually..) </span>
<a name="ln-420"></a>    <span class="n">zoih</span> <span class="o">=</span> <span class="n">zh</span> <span class="o">/</span> <span class="n">di</span>                                <span class="c">! outer scaling zf-coordinate at inlet station  (could be done once, actually..)</span>
<a name="ln-421"></a>    <span class="n">zotr</span> <span class="o">=</span> <span class="n">zf</span> <span class="o">/</span> <span class="n">dtr</span>                               <span class="c">! temperature outer scaling zf-coordinate at recycle station</span>
<a name="ln-422"></a>    <span class="n">zoti</span> <span class="o">=</span> <span class="n">zf</span> <span class="o">/</span> <span class="n">dti</span>                               <span class="c">! temperature outer scaling zf-coordinate at inlet station</span>
<a name="ln-423"></a>
<a name="ln-424"></a><span class="c">!!!!! Interpolation starts here</span>
<a name="ln-425"></a>
<a name="ln-426"></a> <span class="c">!!! First inner coordinates</span>
<a name="ln-427"></a>   <span class="c">! determine which elements are needed when recycle velocity profile is interpolated on inlet plane</span>
<a name="ln-428"></a>   <span class="c">! for u(,v)-components (zf)</span>
<a name="ln-429"></a>    <span class="k">do </span><span class="n">k</span><span class="o">=</span><span class="n">kb</span><span class="p">,</span><span class="n">ke</span>
<a name="ln-430"></a>      <span class="k">do </span><span class="n">kk</span><span class="o">=</span><span class="n">kb</span><span class="p">,</span><span class="n">ke</span>
<a name="ln-431"></a>        <span class="k">if</span> <span class="p">(</span><span class="n">zirf</span><span class="p">(</span><span class="n">kk</span><span class="p">)</span> <span class="o">&gt;=</span> <span class="n">ziif</span><span class="p">(</span><span class="n">k</span><span class="p">))</span> <span class="k">then</span>
<a name="ln-432"></a><span class="k">          </span><span class="n">locupif</span><span class="p">(</span><span class="n">k</span><span class="p">)</span>  <span class="o">=</span> <span class="n">kk</span>
<a name="ln-433"></a>          <span class="n">loclowif</span><span class="p">(</span><span class="n">k</span><span class="p">)</span> <span class="o">=</span> <span class="n">kk</span><span class="o">-</span><span class="mi">1</span>
<a name="ln-434"></a>          <span class="k">exit</span>
<a name="ln-435"></a><span class="k">        </span><span class="n">elseif</span> <span class="p">(</span><span class="n">kk</span><span class="o">==</span><span class="n">ke</span><span class="p">)</span> <span class="k">then</span>
<a name="ln-436"></a><span class="k">          </span><span class="n">locupif</span><span class="p">(</span><span class="n">k</span><span class="p">)</span>  <span class="o">=</span> <span class="n">ke</span><span class="o">+</span><span class="mi">1</span>            <span class="c">! this means extrapolation!</span>
<a name="ln-437"></a>          <span class="n">loclowif</span><span class="p">(</span><span class="n">k</span><span class="p">)</span> <span class="o">=</span> <span class="n">ke</span><span class="o">-</span><span class="mi">1</span>            <span class="c">! waarom niet ke? of wordt dit niet gebruikt?</span>
<a name="ln-438"></a>        <span class="k">end if</span>
<a name="ln-439"></a><span class="k">      end do</span>
<a name="ln-440"></a><span class="k">    end do</span>
<a name="ln-441"></a>   <span class="c">! for w-components (zh)</span>
<a name="ln-442"></a>    <span class="k">do </span><span class="n">k</span><span class="o">=</span><span class="n">kb</span><span class="p">,</span><span class="n">ke</span><span class="o">+</span><span class="mi">1</span>
<a name="ln-443"></a>      <span class="k">do </span><span class="n">kk</span><span class="o">=</span><span class="n">kb</span><span class="p">,</span><span class="n">ke</span><span class="o">+</span><span class="mi">1</span>
<a name="ln-444"></a>        <span class="k">if</span> <span class="p">(</span><span class="n">zirh</span><span class="p">(</span><span class="n">kk</span><span class="p">)</span> <span class="o">&gt;=</span> <span class="n">ziih</span><span class="p">(</span><span class="n">k</span><span class="p">))</span> <span class="k">then</span>
<a name="ln-445"></a><span class="k">          </span><span class="n">locupih</span><span class="p">(</span><span class="n">k</span><span class="p">)</span>  <span class="o">=</span> <span class="n">kk</span>
<a name="ln-446"></a>          <span class="n">loclowih</span><span class="p">(</span><span class="n">k</span><span class="p">)</span> <span class="o">=</span> <span class="n">kk</span><span class="o">-</span><span class="mi">1</span>
<a name="ln-447"></a>          <span class="k">exit</span>
<a name="ln-448"></a><span class="k">        </span><span class="n">elseif</span> <span class="p">(</span><span class="n">kk</span><span class="o">==</span><span class="n">ke</span><span class="o">+</span><span class="mi">1</span><span class="p">)</span> <span class="k">then</span>
<a name="ln-449"></a><span class="k">          </span><span class="n">locupih</span><span class="p">(</span><span class="n">k</span><span class="p">)</span>  <span class="o">=</span> <span class="n">ke</span><span class="o">+</span><span class="mi">2</span>            <span class="c">! this means extrapolation!</span>
<a name="ln-450"></a>          <span class="n">loclowih</span><span class="p">(</span><span class="n">k</span><span class="p">)</span> <span class="o">=</span> <span class="n">ke</span>
<a name="ln-451"></a>        <span class="k">end if</span>
<a name="ln-452"></a><span class="k">      end do</span>
<a name="ln-453"></a><span class="k">    end do</span>
<a name="ln-454"></a> <span class="c">!!! Finished with inner coordinates</span>
<a name="ln-455"></a>
<a name="ln-456"></a> <span class="c">!!! Do the same trick for outer coordinates</span>
<a name="ln-457"></a>   <span class="c">! determine which elements are needed when recycle velocity profile is interpolated on inlet plane</span>
<a name="ln-458"></a>   <span class="c">! for u(,v)-components (zf)</span>
<a name="ln-459"></a>    <span class="k">do </span><span class="n">k</span><span class="o">=</span><span class="n">kb</span><span class="p">,</span><span class="n">ke</span>
<a name="ln-460"></a>      <span class="k">do </span><span class="n">kk</span><span class="o">=</span><span class="n">kb</span><span class="p">,</span><span class="n">ke</span>
<a name="ln-461"></a>        <span class="k">if</span> <span class="p">(</span><span class="n">zorf</span><span class="p">(</span><span class="n">kk</span><span class="p">)</span> <span class="o">&gt;=</span> <span class="n">zoif</span><span class="p">(</span><span class="n">k</span><span class="p">))</span> <span class="k">then</span>
<a name="ln-462"></a><span class="k">          </span><span class="n">locupof</span><span class="p">(</span><span class="n">k</span><span class="p">)</span>  <span class="o">=</span> <span class="n">kk</span>
<a name="ln-463"></a>          <span class="n">loclowof</span><span class="p">(</span><span class="n">k</span><span class="p">)</span> <span class="o">=</span> <span class="n">kk</span><span class="o">-</span><span class="mi">1</span>
<a name="ln-464"></a>          <span class="k">exit</span>
<a name="ln-465"></a><span class="k">        </span><span class="n">elseif</span> <span class="p">(</span><span class="n">kk</span><span class="o">==</span><span class="n">ke</span><span class="p">)</span> <span class="k">then</span>
<a name="ln-466"></a><span class="k">          </span><span class="n">locupof</span><span class="p">(</span><span class="n">k</span><span class="p">)</span>  <span class="o">=</span> <span class="n">ke</span><span class="o">+</span><span class="mi">1</span>            <span class="c">! this means extrapolation!</span>
<a name="ln-467"></a>          <span class="n">loclowof</span><span class="p">(</span><span class="n">k</span><span class="p">)</span> <span class="o">=</span> <span class="n">ke</span><span class="o">-</span><span class="mi">1</span>
<a name="ln-468"></a>        <span class="k">end if</span>
<a name="ln-469"></a><span class="k">      end do</span>
<a name="ln-470"></a><span class="k">    end do</span>
<a name="ln-471"></a>   <span class="c">! for w-components (zh)</span>
<a name="ln-472"></a>    <span class="k">do </span><span class="n">k</span><span class="o">=</span><span class="n">kb</span><span class="p">,</span><span class="n">ke</span><span class="o">+</span><span class="mi">1</span>
<a name="ln-473"></a>      <span class="k">do </span><span class="n">kk</span><span class="o">=</span><span class="n">kb</span><span class="p">,</span><span class="n">ke</span><span class="o">+</span><span class="mi">1</span>
<a name="ln-474"></a>        <span class="k">if</span> <span class="p">(</span><span class="n">zorh</span><span class="p">(</span><span class="n">kk</span><span class="p">)</span> <span class="o">&gt;=</span> <span class="n">zoih</span><span class="p">(</span><span class="n">k</span><span class="p">))</span> <span class="k">then</span>
<a name="ln-475"></a><span class="k">          </span><span class="n">locupoh</span><span class="p">(</span><span class="n">k</span><span class="p">)</span>  <span class="o">=</span> <span class="n">kk</span>
<a name="ln-476"></a>          <span class="n">loclowoh</span><span class="p">(</span><span class="n">k</span><span class="p">)</span> <span class="o">=</span> <span class="n">kk</span><span class="o">-</span><span class="mi">1</span>
<a name="ln-477"></a>          <span class="k">exit</span>
<a name="ln-478"></a><span class="k">        </span><span class="n">elseif</span> <span class="p">(</span><span class="n">kk</span><span class="o">==</span><span class="n">ke</span><span class="o">+</span><span class="mi">1</span><span class="p">)</span> <span class="k">then</span>
<a name="ln-479"></a><span class="k">          </span><span class="n">locupoh</span><span class="p">(</span><span class="n">k</span><span class="p">)</span>  <span class="o">=</span> <span class="n">ke</span><span class="o">+</span><span class="mi">2</span>            <span class="c">! this means extrapolation!</span>
<a name="ln-480"></a>          <span class="n">loclowoh</span><span class="p">(</span><span class="n">k</span><span class="p">)</span> <span class="o">=</span> <span class="n">ke</span>
<a name="ln-481"></a>        <span class="k">end if</span>
<a name="ln-482"></a><span class="k">      end do</span>
<a name="ln-483"></a><span class="k">    end do</span>
<a name="ln-484"></a>
<a name="ln-485"></a>  <span class="c">!!! Finished with outer coordinates</span>
<a name="ln-486"></a>  <span class="c">!!! Outer coordinates for temperature</span>
<a name="ln-487"></a>    <span class="k">do </span><span class="n">k</span><span class="o">=</span><span class="n">kb</span><span class="p">,</span><span class="n">ke</span>
<a name="ln-488"></a>      <span class="k">do </span><span class="n">kk</span><span class="o">=</span><span class="n">kb</span><span class="p">,</span><span class="n">ke</span>
<a name="ln-489"></a>        <span class="k">if</span> <span class="p">(</span><span class="n">zotr</span><span class="p">(</span><span class="n">kk</span><span class="p">)</span> <span class="o">&gt;=</span> <span class="n">zoti</span><span class="p">(</span><span class="n">k</span><span class="p">))</span> <span class="k">then</span>
<a name="ln-490"></a><span class="k">          </span><span class="n">locupot</span><span class="p">(</span><span class="n">k</span><span class="p">)</span>  <span class="o">=</span> <span class="n">kk</span>
<a name="ln-491"></a>          <span class="n">loclowot</span><span class="p">(</span><span class="n">k</span><span class="p">)</span> <span class="o">=</span> <span class="n">kk</span><span class="o">-</span><span class="mi">1</span>
<a name="ln-492"></a>          <span class="k">exit</span>
<a name="ln-493"></a><span class="k">        </span><span class="n">elseif</span> <span class="p">(</span><span class="n">kk</span><span class="o">==</span><span class="n">ke</span><span class="p">)</span> <span class="k">then</span>
<a name="ln-494"></a><span class="k">          </span><span class="n">locupot</span><span class="p">(</span><span class="n">k</span><span class="p">)</span>  <span class="o">=</span> <span class="n">ke</span><span class="o">+</span><span class="mi">1</span>            <span class="c">! this means extrapolation!</span>
<a name="ln-495"></a>          <span class="n">loclowot</span><span class="p">(</span><span class="n">k</span><span class="p">)</span> <span class="o">=</span> <span class="n">ke</span><span class="o">-</span><span class="mi">1</span>
<a name="ln-496"></a>        <span class="k">end if</span>
<a name="ln-497"></a><span class="k">      end do</span>
<a name="ln-498"></a><span class="k">    end do</span>
<a name="ln-499"></a>  <span class="c">!!! Finished with outer coordinates temperature</span>
<a name="ln-500"></a>
<a name="ln-501"></a><span class="c">!!! Now really interpolate</span>
<a name="ln-502"></a>  <span class="c">!!! First inner coordinates</span>
<a name="ln-503"></a>   <span class="c">! compute Urec on zii grid</span>
<a name="ln-504"></a>    <span class="k">do </span><span class="n">k</span><span class="o">=</span><span class="n">kb</span><span class="p">,</span><span class="n">ke</span>
<a name="ln-505"></a>      <span class="k">if</span> <span class="p">(</span><span class="n">locupif</span><span class="p">(</span><span class="n">k</span><span class="p">)</span> <span class="o">==</span> <span class="n">ke</span><span class="o">+</span><span class="mi">1</span><span class="p">)</span> <span class="k">then</span>      <span class="c">! indicator for extrapolation!</span>
<a name="ln-506"></a><span class="c">!        Uinli(k) = Urec(ke) + (Urec(ke) - Urec(ke-1)) / (zirf(ke)-zirf(ke-1)) * (ziif(k)-zirf(ke))</span>
<a name="ln-507"></a>        <span class="n">Uinli</span><span class="p">(</span><span class="n">k</span><span class="p">)</span> <span class="o">=</span> <span class="n">Urec</span><span class="p">(</span><span class="n">ke</span><span class="p">)</span>
<a name="ln-508"></a>        <span class="n">Tinli</span><span class="p">(</span><span class="n">k</span><span class="p">)</span> <span class="o">=</span> <span class="n">Trec</span><span class="p">(</span><span class="n">ke</span><span class="p">)</span> 
<a name="ln-509"></a>      <span class="n">elseif</span> <span class="p">(</span><span class="n">loclowif</span><span class="p">(</span><span class="n">k</span><span class="p">)</span> <span class="o">==</span> <span class="n">kb</span><span class="o">-</span><span class="mi">1</span><span class="p">)</span> <span class="k">then</span> <span class="c">! interprets this as extrapolation to bottom (use u=0 at z+=0)</span>
<a name="ln-510"></a>        <span class="n">Uinli</span><span class="p">(</span><span class="n">k</span><span class="p">)</span> <span class="o">=</span> <span class="n">Urec</span><span class="p">(</span><span class="n">kb</span><span class="p">)</span><span class="o">/</span><span class="n">zirf</span><span class="p">(</span><span class="n">kb</span><span class="p">)</span> <span class="o">*</span> <span class="n">ziif</span><span class="p">(</span><span class="n">k</span><span class="p">)</span>
<a name="ln-511"></a><span class="c">!        Tinli(k) = thls + Trec(kb)/zirf(kb)*ziif(k)  </span>
<a name="ln-512"></a><span class="c">!        Tinli(k) = (Trec(kb)-thls)/zirf(kb)*ziif(k)  </span>
<a name="ln-513"></a>        <span class="n">Tinli</span><span class="p">(</span><span class="n">k</span><span class="p">)</span> <span class="o">=</span> <span class="n">thls</span> <span class="o">+</span> <span class="p">(</span><span class="n">Trec</span><span class="p">(</span><span class="n">kb</span><span class="p">)</span><span class="o">-</span><span class="n">thls</span><span class="p">)</span><span class="o">/</span><span class="n">zirf</span><span class="p">(</span><span class="n">kb</span><span class="p">)</span><span class="o">*</span><span class="n">ziif</span><span class="p">(</span><span class="n">k</span><span class="p">)</span>  
<a name="ln-514"></a>      <span class="k">else</span>                            <span class="c">! normal interpolation</span>
<a name="ln-515"></a>        <span class="n">Uinli</span><span class="p">(</span><span class="n">k</span><span class="p">)</span> <span class="o">=</span> <span class="n">Urec</span><span class="p">(</span><span class="n">loclowif</span><span class="p">(</span><span class="n">k</span><span class="p">))</span> <span class="o">+</span> <span class="p">(</span><span class="n">Urec</span><span class="p">(</span><span class="n">locupif</span><span class="p">(</span><span class="n">k</span><span class="p">))</span> <span class="o">-</span> <span class="n">Urec</span><span class="p">(</span><span class="n">loclowif</span><span class="p">(</span><span class="n">k</span><span class="p">)))</span> <span class="o">/</span> <span class="p">(</span><span class="n">zirf</span><span class="p">(</span><span class="n">locupif</span><span class="p">(</span><span class="n">k</span><span class="p">))</span> <span class="o">-</span> <span class="n">zirf</span><span class="p">(</span><span class="n">loclowif</span><span class="p">(</span><span class="n">k</span><span class="p">)))</span> <span class="o">*</span> <span class="p">(</span><span class="n">ziif</span><span class="p">(</span><span class="n">k</span><span class="p">)</span> <span class="o">-</span> <span class="n">zirf</span><span class="p">(</span><span class="n">loclowif</span><span class="p">(</span><span class="n">k</span><span class="p">)))</span>
<a name="ln-516"></a>        <span class="n">Tinli</span><span class="p">(</span><span class="n">k</span><span class="p">)</span> <span class="o">=</span> <span class="n">Trec</span><span class="p">(</span><span class="n">loclowif</span><span class="p">(</span><span class="n">k</span><span class="p">))</span> <span class="o">+</span> <span class="p">(</span><span class="n">Trec</span><span class="p">(</span><span class="n">locupif</span><span class="p">(</span><span class="n">k</span><span class="p">))</span> <span class="o">-</span> <span class="n">Trec</span><span class="p">(</span><span class="n">loclowif</span><span class="p">(</span><span class="n">k</span><span class="p">)))</span> <span class="o">/</span> <span class="p">(</span><span class="n">zirf</span><span class="p">(</span><span class="n">locupif</span><span class="p">(</span><span class="n">k</span><span class="p">))</span> <span class="o">-</span> <span class="n">zirf</span><span class="p">(</span><span class="n">loclowif</span><span class="p">(</span><span class="n">k</span><span class="p">)))</span> <span class="o">*</span> <span class="p">(</span><span class="n">ziif</span><span class="p">(</span><span class="n">k</span><span class="p">)</span> <span class="o">-</span> <span class="n">zirf</span><span class="p">(</span><span class="n">loclowif</span><span class="p">(</span><span class="n">k</span><span class="p">)))</span>
<a name="ln-517"></a>        <span class="k">if</span> <span class="p">((</span><span class="n">ziif</span><span class="p">(</span><span class="n">k</span><span class="p">)</span> <span class="p">.</span><span class="n">gt</span><span class="p">.</span> <span class="n">zirf</span><span class="p">(</span><span class="n">locupif</span><span class="p">(</span><span class="n">k</span><span class="p">)))</span> <span class="p">.</span><span class="nb">or</span><span class="p">.</span> <span class="p">(</span><span class="n">ziif</span><span class="p">(</span><span class="n">k</span><span class="p">)</span> <span class="p">.</span><span class="n">lt</span><span class="p">.</span> <span class="n">zirf</span><span class="p">(</span><span class="n">loclowif</span><span class="p">(</span><span class="n">k</span><span class="p">))))</span> <span class="k">then</span>
<a name="ln-518"></a><span class="k">          write</span><span class="p">(</span><span class="mi">6</span><span class="p">,</span><span class="o">*</span><span class="p">)</span> <span class="s1">&#39;!!!Mistake in Interpolation !!!!&#39;</span>
<a name="ln-519"></a>        <span class="k">end if</span>
<a name="ln-520"></a><span class="k">      end if</span>
<a name="ln-521"></a><span class="k">    end do</span>
<a name="ln-522"></a>
<a name="ln-523"></a>   <span class="c">! compute Wrec on zii grid</span>
<a name="ln-524"></a>    <span class="n">Winli</span><span class="p">(</span><span class="n">kb</span><span class="p">)</span> <span class="o">=</span> <span class="mf">0.0</span>                      <span class="c">! corresponds to ground level</span>
<a name="ln-525"></a>    <span class="k">do </span><span class="n">k</span><span class="o">=</span><span class="n">kb</span><span class="o">+</span><span class="mi">1</span><span class="p">,</span><span class="n">ke</span><span class="o">+</span><span class="mi">1</span>
<a name="ln-526"></a>      <span class="k">if</span> <span class="p">(</span><span class="n">locupih</span><span class="p">(</span><span class="n">k</span><span class="p">)</span> <span class="o">==</span> <span class="n">ke</span><span class="o">+</span><span class="mi">2</span><span class="p">)</span> <span class="k">then</span>     <span class="c">! indicator for extrapolation!</span>
<a name="ln-527"></a><span class="c">!        Winli(k) = Wrec(ke+1) + (Wrec(ke+1) - Wrec(ke)) / (zirh(ke+1)-zirh(ke)) * (ziih(k)-zirh(ke+1))</span>
<a name="ln-528"></a>        <span class="n">Winli</span><span class="p">(</span><span class="n">k</span><span class="p">)</span> <span class="o">=</span> <span class="n">Wrec</span><span class="p">(</span><span class="n">ke</span><span class="o">+</span><span class="mi">1</span><span class="p">)</span>
<a name="ln-529"></a>      <span class="k">else</span>                            <span class="c">! normal interpolation</span>
<a name="ln-530"></a>        <span class="n">Winli</span><span class="p">(</span><span class="n">k</span><span class="p">)</span> <span class="o">=</span> <span class="n">Wrec</span><span class="p">(</span><span class="n">loclowih</span><span class="p">(</span><span class="n">k</span><span class="p">))</span> <span class="o">+</span> <span class="p">(</span><span class="n">Wrec</span><span class="p">(</span><span class="n">locupih</span><span class="p">(</span><span class="n">k</span><span class="p">))</span> <span class="o">-</span> <span class="n">Wrec</span><span class="p">(</span><span class="n">loclowih</span><span class="p">(</span><span class="n">k</span><span class="p">)))</span> <span class="o">/</span> <span class="p">(</span><span class="n">zirh</span><span class="p">(</span><span class="n">locupih</span><span class="p">(</span><span class="n">k</span><span class="p">))</span> <span class="o">-</span> <span class="n">zirh</span><span class="p">(</span><span class="n">loclowih</span><span class="p">(</span><span class="n">k</span><span class="p">)))</span> <span class="o">*</span> <span class="p">(</span><span class="n">ziih</span><span class="p">(</span><span class="n">k</span><span class="p">)</span> <span class="o">-</span> <span class="n">zirh</span><span class="p">(</span><span class="n">loclowih</span><span class="p">(</span><span class="n">k</span><span class="p">)))</span>
<a name="ln-531"></a>      <span class="k">end if</span>
<a name="ln-532"></a><span class="k">    end do</span>
<a name="ln-533"></a>
<a name="ln-534"></a>   <span class="c">! compute u- and v- and t-fluctuation on zii grid</span>
<a name="ln-535"></a>    <span class="k">do </span><span class="n">k</span><span class="o">=</span><span class="n">kb</span><span class="p">,</span><span class="n">ke</span>
<a name="ln-536"></a>      <span class="k">if</span> <span class="p">(</span><span class="n">locupif</span><span class="p">(</span><span class="n">k</span><span class="p">)</span> <span class="o">==</span> <span class="n">ke</span><span class="o">+</span><span class="mi">1</span><span class="p">)</span> <span class="k">then</span>      <span class="c">! indicator for extrapolation!</span>
<a name="ln-537"></a><span class="c">!        upinli(:,k) = uprec(:,ke) + (uprec(:,ke) - uprec(:,ke-1)) / (zirf(ke)-zirf(ke-1)) * (ziif(k)-zirf(ke))</span>
<a name="ln-538"></a>        <span class="n">upinli</span><span class="p">(:,</span><span class="n">k</span><span class="p">)</span> <span class="o">=</span> <span class="mf">0.</span>
<a name="ln-539"></a>        <span class="n">vpinli</span><span class="p">(:,</span><span class="n">k</span><span class="p">)</span> <span class="o">=</span> <span class="mf">0.</span>
<a name="ln-540"></a>        <span class="n">tpinli</span><span class="p">(:,</span><span class="n">k</span><span class="p">)</span> <span class="o">=</span> <span class="mf">0.</span>
<a name="ln-541"></a>      <span class="n">elseif</span> <span class="p">(</span><span class="n">loclowif</span><span class="p">(</span><span class="n">k</span><span class="p">)</span> <span class="o">==</span> <span class="n">kb</span><span class="o">-</span><span class="mi">1</span><span class="p">)</span> <span class="k">then</span> <span class="c">! interprets this as extrapolation to bottom (use u=0 at z+=0)</span>
<a name="ln-542"></a>        <span class="n">upinli</span><span class="p">(:,</span><span class="n">k</span><span class="p">)</span> <span class="o">=</span> <span class="n">uprec</span><span class="p">(:,</span><span class="n">kb</span><span class="p">)</span><span class="o">/</span><span class="n">zirf</span><span class="p">(</span><span class="n">kb</span><span class="p">)</span> <span class="o">*</span> <span class="n">ziif</span><span class="p">(</span><span class="n">k</span><span class="p">)</span>
<a name="ln-543"></a>        <span class="n">vpinli</span><span class="p">(:,</span><span class="n">k</span><span class="p">)</span> <span class="o">=</span> <span class="n">vprec</span><span class="p">(:,</span><span class="n">kb</span><span class="p">)</span><span class="o">/</span><span class="n">zirf</span><span class="p">(</span><span class="n">kb</span><span class="p">)</span> <span class="o">*</span> <span class="n">ziif</span><span class="p">(</span><span class="n">k</span><span class="p">)</span>
<a name="ln-544"></a>        <span class="n">tpinli</span><span class="p">(:,</span><span class="n">k</span><span class="p">)</span> <span class="o">=</span> <span class="n">tprec</span><span class="p">(:,</span><span class="n">kb</span><span class="p">)</span><span class="o">/</span><span class="n">zirf</span><span class="p">(</span><span class="n">kb</span><span class="p">)</span> <span class="o">*</span> <span class="n">ziif</span><span class="p">(</span><span class="n">k</span><span class="p">)</span>
<a name="ln-545"></a>      <span class="k">else</span>                            <span class="c">! normal interpolation</span>
<a name="ln-546"></a>        <span class="n">upinli</span><span class="p">(:,</span><span class="n">k</span><span class="p">)</span> <span class="o">=</span> <span class="n">uprec</span><span class="p">(:,</span><span class="n">loclowif</span><span class="p">(</span><span class="n">k</span><span class="p">))</span> <span class="o">+</span> <span class="p">(</span><span class="n">uprec</span><span class="p">(:,</span><span class="n">locupif</span><span class="p">(</span><span class="n">k</span><span class="p">))</span> <span class="o">-</span> <span class="n">uprec</span><span class="p">(:,</span><span class="n">loclowif</span><span class="p">(</span><span class="n">k</span><span class="p">)))</span> <span class="o">/</span> <span class="p">(</span><span class="n">zirf</span><span class="p">(</span><span class="n">locupif</span><span class="p">(</span><span class="n">k</span><span class="p">))</span> <span class="o">-</span> <span class="n">zirf</span><span class="p">(</span><span class="n">loclowif</span><span class="p">(</span><span class="n">k</span><span class="p">)))</span> <span class="o">*</span> <span class="p">(</span><span class="n">ziif</span><span class="p">(</span><span class="n">k</span><span class="p">)</span> <span class="o">-</span> <span class="n">zirf</span><span class="p">(</span><span class="n">loclowif</span><span class="p">(</span><span class="n">k</span><span class="p">)))</span>
<a name="ln-547"></a>        <span class="n">vpinli</span><span class="p">(:,</span><span class="n">k</span><span class="p">)</span> <span class="o">=</span> <span class="n">vprec</span><span class="p">(:,</span><span class="n">loclowif</span><span class="p">(</span><span class="n">k</span><span class="p">))</span> <span class="o">+</span> <span class="p">(</span><span class="n">vprec</span><span class="p">(:,</span><span class="n">locupif</span><span class="p">(</span><span class="n">k</span><span class="p">))</span> <span class="o">-</span> <span class="n">vprec</span><span class="p">(:,</span><span class="n">loclowif</span><span class="p">(</span><span class="n">k</span><span class="p">)))</span> <span class="o">/</span> <span class="p">(</span><span class="n">zirf</span><span class="p">(</span><span class="n">locupif</span><span class="p">(</span><span class="n">k</span><span class="p">))</span> <span class="o">-</span> <span class="n">zirf</span><span class="p">(</span><span class="n">loclowif</span><span class="p">(</span><span class="n">k</span><span class="p">)))</span> <span class="o">*</span> <span class="p">(</span><span class="n">ziif</span><span class="p">(</span><span class="n">k</span><span class="p">)</span> <span class="o">-</span> <span class="n">zirf</span><span class="p">(</span><span class="n">loclowif</span><span class="p">(</span><span class="n">k</span><span class="p">)))</span>
<a name="ln-548"></a>        <span class="n">tpinli</span><span class="p">(:,</span><span class="n">k</span><span class="p">)</span> <span class="o">=</span> <span class="n">tprec</span><span class="p">(:,</span><span class="n">loclowif</span><span class="p">(</span><span class="n">k</span><span class="p">))</span> <span class="o">+</span> <span class="p">(</span><span class="n">tprec</span><span class="p">(:,</span><span class="n">locupif</span><span class="p">(</span><span class="n">k</span><span class="p">))</span> <span class="o">-</span> <span class="n">tprec</span><span class="p">(:,</span><span class="n">loclowif</span><span class="p">(</span><span class="n">k</span><span class="p">)))</span> <span class="o">/</span> <span class="p">(</span><span class="n">zirf</span><span class="p">(</span><span class="n">locupif</span><span class="p">(</span><span class="n">k</span><span class="p">))</span> <span class="o">-</span> <span class="n">zirf</span><span class="p">(</span><span class="n">loclowif</span><span class="p">(</span><span class="n">k</span><span class="p">)))</span> <span class="o">*</span> <span class="p">(</span><span class="n">ziif</span><span class="p">(</span><span class="n">k</span><span class="p">)</span> <span class="o">-</span> <span class="n">zirf</span><span class="p">(</span><span class="n">loclowif</span><span class="p">(</span><span class="n">k</span><span class="p">)))</span>
<a name="ln-549"></a>      <span class="k">end if</span>
<a name="ln-550"></a><span class="k">    end do</span>
<a name="ln-551"></a>   
<a name="ln-552"></a>   <span class="c">! compute w-fluctuation on zii grid</span>
<a name="ln-553"></a>    <span class="k">do </span><span class="n">k</span><span class="o">=</span><span class="n">kb</span><span class="o">+</span><span class="mi">1</span><span class="p">,</span><span class="n">ke</span><span class="o">+</span><span class="mi">1</span>
<a name="ln-554"></a><span class="c">!      if (locupih(k) == ke+1) then      ! indicator for extrapolation!</span>
<a name="ln-555"></a>      <span class="k">if</span> <span class="p">(</span><span class="n">locupih</span><span class="p">(</span><span class="n">k</span><span class="p">)</span> <span class="o">==</span> <span class="n">ke</span><span class="o">+</span><span class="mi">2</span><span class="p">)</span> <span class="k">then</span>      <span class="c">! indicator for extrapolation!</span>
<a name="ln-556"></a><span class="c">!        wpinli(:,k) = wprec(:,ke+1) + (wprec(:,ke+1) - wprec(:,ke)) / (zirh(ke+1)-zirh(ke)) * (ziih(k)-zirh(ke+1))</span>
<a name="ln-557"></a>        <span class="n">wpinli</span><span class="p">(:,</span><span class="n">k</span><span class="p">)</span> <span class="o">=</span> <span class="mf">0.</span>
<a name="ln-558"></a>      <span class="k">else</span>                            <span class="c">! normal interpolation</span>
<a name="ln-559"></a>        <span class="n">wpinli</span><span class="p">(:,</span><span class="n">k</span><span class="p">)</span> <span class="o">=</span> <span class="n">wprec</span><span class="p">(:,</span><span class="n">loclowih</span><span class="p">(</span><span class="n">k</span><span class="p">))</span> <span class="o">+</span> <span class="p">(</span><span class="n">wprec</span><span class="p">(:,</span><span class="n">locupih</span><span class="p">(</span><span class="n">k</span><span class="p">))</span> <span class="o">-</span> <span class="n">wprec</span><span class="p">(:,</span><span class="n">loclowih</span><span class="p">(</span><span class="n">k</span><span class="p">)))</span> <span class="o">/</span> <span class="p">(</span><span class="n">zirh</span><span class="p">(</span><span class="n">locupih</span><span class="p">(</span><span class="n">k</span><span class="p">))</span> <span class="o">-</span> <span class="n">zirh</span><span class="p">(</span><span class="n">loclowih</span><span class="p">(</span><span class="n">k</span><span class="p">)))</span> <span class="o">*</span> <span class="p">(</span><span class="n">ziih</span><span class="p">(</span><span class="n">k</span><span class="p">)</span> <span class="o">-</span> <span class="n">zirh</span><span class="p">(</span><span class="n">loclowih</span><span class="p">(</span><span class="n">k</span><span class="p">)))</span>
<a name="ln-560"></a>      <span class="k">end if</span>
<a name="ln-561"></a><span class="k">    end do</span>
<a name="ln-562"></a>
<a name="ln-563"></a> <span class="c">!! Finished with interpolating inner variables </span>
<a name="ln-564"></a> <span class="c">!! Continue with interpolating outer variables</span>
<a name="ln-565"></a>   <span class="c">! compute Urec on zoi grid</span>
<a name="ln-566"></a>    <span class="k">do </span><span class="n">k</span><span class="o">=</span><span class="n">kb</span><span class="p">,</span><span class="n">ke</span>
<a name="ln-567"></a>      <span class="k">if</span> <span class="p">(</span><span class="n">locupof</span><span class="p">(</span><span class="n">k</span><span class="p">)</span> <span class="o">==</span> <span class="n">ke</span><span class="o">+</span><span class="mi">1</span><span class="p">)</span> <span class="k">then</span>      <span class="c">! indicator for extrapolation!</span>
<a name="ln-568"></a><span class="c">!        Uinlo(k) = Urec(ke) + (Urec(ke) - Urec(ke-1)) / (zorf(ke)-zorf(ke-1)) * (zoif(k)-zorf(ke))</span>
<a name="ln-569"></a><span class="c">!        Uinlo(k) = Urec(ke)</span>
<a name="ln-570"></a>        <span class="n">Uinlo</span><span class="p">(</span><span class="n">k</span><span class="p">)</span> <span class="o">=</span> <span class="n">Uinf</span>
<a name="ln-571"></a>      <span class="n">elseif</span> <span class="p">(</span><span class="n">loclowof</span><span class="p">(</span><span class="n">k</span><span class="p">)</span> <span class="o">==</span> <span class="n">kb</span><span class="o">-</span><span class="mi">1</span><span class="p">)</span> <span class="k">then</span> <span class="c">! interprets this as extrapolation to bottom (use u=0 at z+=0)</span>
<a name="ln-572"></a>        <span class="n">Uinlo</span><span class="p">(</span><span class="n">k</span><span class="p">)</span> <span class="o">=</span> <span class="n">Urec</span><span class="p">(</span><span class="n">kb</span><span class="p">)</span><span class="o">/</span><span class="n">zorf</span><span class="p">(</span><span class="n">kb</span><span class="p">)</span> <span class="o">*</span> <span class="n">zoif</span><span class="p">(</span><span class="n">k</span><span class="p">)</span>
<a name="ln-573"></a>      <span class="k">else</span>                            <span class="c">! normal interpolation</span>
<a name="ln-574"></a>        <span class="n">Uinlo</span><span class="p">(</span><span class="n">k</span><span class="p">)</span> <span class="o">=</span> <span class="n">Urec</span><span class="p">(</span><span class="n">loclowof</span><span class="p">(</span><span class="n">k</span><span class="p">))</span> <span class="o">+</span> <span class="p">(</span><span class="n">Urec</span><span class="p">(</span><span class="n">locupof</span><span class="p">(</span><span class="n">k</span><span class="p">))</span> <span class="o">-</span> <span class="n">Urec</span><span class="p">(</span><span class="n">loclowof</span><span class="p">(</span><span class="n">k</span><span class="p">)))</span> <span class="o">/</span> <span class="p">(</span><span class="n">zorf</span><span class="p">(</span><span class="n">locupof</span><span class="p">(</span><span class="n">k</span><span class="p">))</span> <span class="o">-</span> <span class="n">zorf</span><span class="p">(</span><span class="n">loclowof</span><span class="p">(</span><span class="n">k</span><span class="p">)))</span> <span class="o">*</span> <span class="p">(</span><span class="n">zoif</span><span class="p">(</span><span class="n">k</span><span class="p">)</span> <span class="o">-</span> <span class="n">zorf</span><span class="p">(</span><span class="n">loclowof</span><span class="p">(</span><span class="n">k</span><span class="p">)))</span>
<a name="ln-575"></a>      <span class="k">end if</span>
<a name="ln-576"></a><span class="k">    end do</span>
<a name="ln-577"></a>  
<a name="ln-578"></a>   <span class="c">! compute Wrec on zii grid</span>
<a name="ln-579"></a>    <span class="n">Winlo</span><span class="p">(</span><span class="n">kb</span><span class="p">)</span> <span class="o">=</span> <span class="mf">0.0</span>                      <span class="c">! corresponds to ground level</span>
<a name="ln-580"></a>    <span class="k">do </span><span class="n">k</span><span class="o">=</span><span class="n">kb</span><span class="o">+</span><span class="mi">1</span><span class="p">,</span><span class="n">ke</span><span class="o">+</span><span class="mi">1</span>
<a name="ln-581"></a>      <span class="k">if</span> <span class="p">(</span><span class="n">locupoh</span><span class="p">(</span><span class="n">k</span><span class="p">)</span> <span class="o">==</span> <span class="n">ke</span><span class="o">+</span><span class="mi">2</span><span class="p">)</span> <span class="k">then</span>     <span class="c">! indicator for extrapolation!</span>
<a name="ln-582"></a><span class="c">!        Winlo(k) = Wrec(ke+1) + (Wrec(ke+1) - Wrec(ke)) / (zorh(ke+1)-zorh(ke)) * (zoih(k)-zorh(ke+1))</span>
<a name="ln-583"></a>        <span class="n">Winlo</span><span class="p">(</span><span class="n">k</span><span class="p">)</span> <span class="o">=</span> <span class="n">Wrec</span><span class="p">(</span><span class="n">ke</span><span class="o">+</span><span class="mi">1</span><span class="p">)</span> 
<a name="ln-584"></a>      <span class="k">else</span>                            <span class="c">! normal interpolation</span>
<a name="ln-585"></a>        <span class="n">Winlo</span><span class="p">(</span><span class="n">k</span><span class="p">)</span> <span class="o">=</span> <span class="n">Wrec</span><span class="p">(</span><span class="n">loclowoh</span><span class="p">(</span><span class="n">k</span><span class="p">))</span> <span class="o">+</span> <span class="p">(</span><span class="n">Wrec</span><span class="p">(</span><span class="n">locupoh</span><span class="p">(</span><span class="n">k</span><span class="p">))</span> <span class="o">-</span> <span class="n">Wrec</span><span class="p">(</span><span class="n">loclowoh</span><span class="p">(</span><span class="n">k</span><span class="p">)))</span> <span class="o">/</span> <span class="p">(</span><span class="n">zorh</span><span class="p">(</span><span class="n">locupoh</span><span class="p">(</span><span class="n">k</span><span class="p">))</span> <span class="o">-</span> <span class="n">zorh</span><span class="p">(</span><span class="n">loclowoh</span><span class="p">(</span><span class="n">k</span><span class="p">)))</span> <span class="o">*</span> <span class="p">(</span><span class="n">zoih</span><span class="p">(</span><span class="n">k</span><span class="p">)</span> <span class="o">-</span> <span class="n">zorh</span><span class="p">(</span><span class="n">loclowoh</span><span class="p">(</span><span class="n">k</span><span class="p">)))</span>
<a name="ln-586"></a>      <span class="k">end if</span>
<a name="ln-587"></a><span class="k">    end do</span>
<a name="ln-588"></a>
<a name="ln-589"></a>   <span class="c">! compute u- and v-fluctuation on zoi grid</span>
<a name="ln-590"></a>    <span class="k">do </span><span class="n">k</span><span class="o">=</span><span class="n">kb</span><span class="p">,</span><span class="n">ke</span>
<a name="ln-591"></a>      <span class="k">if</span> <span class="p">(</span><span class="n">locupof</span><span class="p">(</span><span class="n">k</span><span class="p">)</span> <span class="o">==</span> <span class="n">ke</span><span class="o">+</span><span class="mi">1</span><span class="p">)</span> <span class="k">then</span>      <span class="c">! indicator for extrapolation!</span>
<a name="ln-592"></a><span class="c">!        upinlo(:,k) = uprec(:,ke) + (uprec(:,ke) - uprec(:,ke-1)) / (zorf(ke)-zorf(ke-1)) * (zoif(k)-zorf(ke))</span>
<a name="ln-593"></a>        <span class="n">upinlo</span><span class="p">(:,</span><span class="n">k</span><span class="p">)</span> <span class="o">=</span> <span class="mf">0.</span>
<a name="ln-594"></a>        <span class="n">vpinlo</span><span class="p">(:,</span><span class="n">k</span><span class="p">)</span> <span class="o">=</span> <span class="mf">0.</span>
<a name="ln-595"></a>      <span class="n">elseif</span> <span class="p">(</span><span class="n">loclowof</span><span class="p">(</span><span class="n">k</span><span class="p">)</span> <span class="o">==</span> <span class="n">kb</span><span class="o">-</span><span class="mi">1</span><span class="p">)</span> <span class="k">then</span> <span class="c">! interprets this as extrapolation to bottom (use u=0 at z+=0)</span>
<a name="ln-596"></a>        <span class="n">upinlo</span><span class="p">(:,</span><span class="n">k</span><span class="p">)</span> <span class="o">=</span> <span class="n">uprec</span><span class="p">(:,</span><span class="n">kb</span><span class="p">)</span><span class="o">/</span><span class="n">zorf</span><span class="p">(</span><span class="n">kb</span><span class="p">)</span> <span class="o">*</span> <span class="n">zoif</span><span class="p">(</span><span class="n">k</span><span class="p">)</span>
<a name="ln-597"></a>        <span class="n">vpinlo</span><span class="p">(:,</span><span class="n">k</span><span class="p">)</span> <span class="o">=</span> <span class="n">vprec</span><span class="p">(:,</span><span class="n">kb</span><span class="p">)</span><span class="o">/</span><span class="n">zorf</span><span class="p">(</span><span class="n">kb</span><span class="p">)</span> <span class="o">*</span> <span class="n">zoif</span><span class="p">(</span><span class="n">k</span><span class="p">)</span>
<a name="ln-598"></a>      <span class="k">else</span>                            <span class="c">! normal interpolation</span>
<a name="ln-599"></a>        <span class="n">upinlo</span><span class="p">(:,</span><span class="n">k</span><span class="p">)</span> <span class="o">=</span> <span class="n">uprec</span><span class="p">(:,</span><span class="n">loclowof</span><span class="p">(</span><span class="n">k</span><span class="p">))</span> <span class="o">+</span> <span class="p">(</span><span class="n">uprec</span><span class="p">(:,</span><span class="n">locupof</span><span class="p">(</span><span class="n">k</span><span class="p">))</span> <span class="o">-</span> <span class="n">uprec</span><span class="p">(:,</span><span class="n">loclowof</span><span class="p">(</span><span class="n">k</span><span class="p">)))</span> <span class="o">/</span> <span class="p">(</span><span class="n">zorf</span><span class="p">(</span><span class="n">locupof</span><span class="p">(</span><span class="n">k</span><span class="p">))</span> <span class="o">-</span> <span class="n">zorf</span><span class="p">(</span><span class="n">loclowof</span><span class="p">(</span><span class="n">k</span><span class="p">)))</span> <span class="o">*</span> <span class="p">(</span><span class="n">zoif</span><span class="p">(</span><span class="n">k</span><span class="p">)</span> <span class="o">-</span> <span class="n">zorf</span><span class="p">(</span><span class="n">loclowof</span><span class="p">(</span><span class="n">k</span><span class="p">)))</span>
<a name="ln-600"></a>        <span class="n">vpinlo</span><span class="p">(:,</span><span class="n">k</span><span class="p">)</span> <span class="o">=</span> <span class="n">vprec</span><span class="p">(:,</span><span class="n">loclowof</span><span class="p">(</span><span class="n">k</span><span class="p">))</span> <span class="o">+</span> <span class="p">(</span><span class="n">vprec</span><span class="p">(:,</span><span class="n">locupof</span><span class="p">(</span><span class="n">k</span><span class="p">))</span> <span class="o">-</span> <span class="n">vprec</span><span class="p">(:,</span><span class="n">loclowof</span><span class="p">(</span><span class="n">k</span><span class="p">)))</span> <span class="o">/</span> <span class="p">(</span><span class="n">zorf</span><span class="p">(</span><span class="n">locupof</span><span class="p">(</span><span class="n">k</span><span class="p">))</span> <span class="o">-</span> <span class="n">zorf</span><span class="p">(</span><span class="n">loclowof</span><span class="p">(</span><span class="n">k</span><span class="p">)))</span> <span class="o">*</span> <span class="p">(</span><span class="n">zoif</span><span class="p">(</span><span class="n">k</span><span class="p">)</span> <span class="o">-</span> <span class="n">zorf</span><span class="p">(</span><span class="n">loclowof</span><span class="p">(</span><span class="n">k</span><span class="p">)))</span>
<a name="ln-601"></a>      <span class="k">end if</span>
<a name="ln-602"></a><span class="k">    end do</span>
<a name="ln-603"></a>
<a name="ln-604"></a>   <span class="c">! compute w-fluctuation on zoi grid</span>
<a name="ln-605"></a>    <span class="k">do </span><span class="n">k</span><span class="o">=</span><span class="n">kb</span><span class="o">+</span><span class="mi">1</span><span class="p">,</span><span class="n">ke</span><span class="o">+</span><span class="mi">1</span>
<a name="ln-606"></a>      <span class="k">if</span> <span class="p">(</span><span class="n">locupoh</span><span class="p">(</span><span class="n">k</span><span class="p">)</span> <span class="o">==</span> <span class="n">ke</span><span class="o">+</span><span class="mi">2</span><span class="p">)</span> <span class="k">then</span>      <span class="c">! indicator for extrapolation!</span>
<a name="ln-607"></a><span class="c">!        wpinlo(:,k) = wprec(:,ke+1) + (wprec(:,ke+1) - wprec(:,ke)) / (zorh(ke+1)-zorh(ke)) * (zoih(k)-zorh(ke+1))</span>
<a name="ln-608"></a>        <span class="n">wpinlo</span><span class="p">(:,</span><span class="n">k</span><span class="p">)</span> <span class="o">=</span> <span class="mf">0.</span>
<a name="ln-609"></a>      <span class="k">else</span>                            <span class="c">! normal interpolation</span>
<a name="ln-610"></a>        <span class="n">wpinlo</span><span class="p">(:,</span><span class="n">k</span><span class="p">)</span> <span class="o">=</span> <span class="n">wprec</span><span class="p">(:,</span><span class="n">loclowoh</span><span class="p">(</span><span class="n">k</span><span class="p">))</span> <span class="o">+</span> <span class="p">(</span><span class="n">wprec</span><span class="p">(:,</span><span class="n">locupoh</span><span class="p">(</span><span class="n">k</span><span class="p">))</span> <span class="o">-</span> <span class="n">wprec</span><span class="p">(:,</span><span class="n">loclowoh</span><span class="p">(</span><span class="n">k</span><span class="p">)))</span> <span class="o">/</span> <span class="p">(</span><span class="n">zorh</span><span class="p">(</span><span class="n">locupoh</span><span class="p">(</span><span class="n">k</span><span class="p">))</span> <span class="o">-</span> <span class="n">zorh</span><span class="p">(</span><span class="n">loclowoh</span><span class="p">(</span><span class="n">k</span><span class="p">)))</span> <span class="o">*</span> <span class="p">(</span><span class="n">zoih</span><span class="p">(</span><span class="n">k</span><span class="p">)</span> <span class="o">-</span> <span class="n">zorh</span><span class="p">(</span><span class="n">loclowoh</span><span class="p">(</span><span class="n">k</span><span class="p">)))</span>
<a name="ln-611"></a>      <span class="k">end if</span>
<a name="ln-612"></a><span class="k">    end do</span>
<a name="ln-613"></a> <span class="c">!! Finished interpolating outer velocity variables</span>
<a name="ln-614"></a> <span class="c">!! Interpolating outer temperature</span>
<a name="ln-615"></a>   <span class="c">! mean temperature</span>
<a name="ln-616"></a>    <span class="k">do </span><span class="n">k</span><span class="o">=</span><span class="n">kb</span><span class="p">,</span><span class="n">ke</span>
<a name="ln-617"></a>      <span class="k">if</span> <span class="p">(</span><span class="n">locupot</span><span class="p">(</span><span class="n">k</span><span class="p">)</span> <span class="o">==</span> <span class="n">ke</span><span class="o">+</span><span class="mi">1</span><span class="p">)</span> <span class="k">then</span>      <span class="c">! indicator for extrapolation!</span>
<a name="ln-618"></a>        <span class="n">Tinlo</span><span class="p">(</span><span class="n">k</span><span class="p">)</span> <span class="o">=</span> <span class="n">thl_top</span>
<a name="ln-619"></a>      <span class="n">elseif</span> <span class="p">(</span><span class="n">loclowot</span><span class="p">(</span><span class="n">k</span><span class="p">)</span> <span class="o">==</span> <span class="n">kb</span><span class="o">-</span><span class="mi">1</span><span class="p">)</span> <span class="k">then</span> <span class="c">! interprets this as extrapolation to bottom (use Tinlo=thls at z+=0)</span>
<a name="ln-620"></a><span class="c">!        Tinlo(k) = Trec(kb)/zotr(kb) * zoti(k)</span>
<a name="ln-621"></a><span class="c">!        Tinlo(k) = (Trec(kb)-thls)/zotr(kb) * zoti(k)</span>
<a name="ln-622"></a>        <span class="n">Tinlo</span><span class="p">(</span><span class="n">k</span><span class="p">)</span> <span class="o">=</span> <span class="n">thls</span> <span class="o">+</span> <span class="p">(</span><span class="n">Trec</span><span class="p">(</span><span class="n">kb</span><span class="p">)</span><span class="o">-</span><span class="n">thls</span><span class="p">)</span><span class="o">/</span><span class="n">zotr</span><span class="p">(</span><span class="n">kb</span><span class="p">)</span> <span class="o">*</span> <span class="n">zoti</span><span class="p">(</span><span class="n">k</span><span class="p">)</span>
<a name="ln-623"></a>      <span class="k">else</span>                            <span class="c">! normal interpolation</span>
<a name="ln-624"></a>        <span class="n">Tinlo</span><span class="p">(</span><span class="n">k</span><span class="p">)</span> <span class="o">=</span> <span class="n">Trec</span><span class="p">(</span><span class="n">loclowot</span><span class="p">(</span><span class="n">k</span><span class="p">))</span> <span class="o">+</span> <span class="p">(</span><span class="n">Trec</span><span class="p">(</span><span class="n">locupot</span><span class="p">(</span><span class="n">k</span><span class="p">))</span> <span class="o">-</span> <span class="n">Trec</span><span class="p">(</span><span class="n">loclowot</span><span class="p">(</span><span class="n">k</span><span class="p">)))</span> <span class="o">/</span> <span class="p">(</span><span class="n">zotr</span><span class="p">(</span><span class="n">locupot</span><span class="p">(</span><span class="n">k</span><span class="p">))</span> <span class="o">-</span> <span class="n">zotr</span><span class="p">(</span><span class="n">loclowot</span><span class="p">(</span><span class="n">k</span><span class="p">)))</span> <span class="o">*</span> <span class="p">(</span><span class="n">zoti</span><span class="p">(</span><span class="n">k</span><span class="p">)</span> <span class="o">-</span> <span class="n">zotr</span><span class="p">(</span><span class="n">loclowot</span><span class="p">(</span><span class="n">k</span><span class="p">)))</span>
<a name="ln-625"></a>      <span class="k">end if</span>
<a name="ln-626"></a><span class="k">    end do</span>
<a name="ln-627"></a>   
<a name="ln-628"></a>   <span class="c">! fluctuating temperature</span>
<a name="ln-629"></a>    <span class="k">do </span><span class="n">k</span><span class="o">=</span><span class="n">kb</span><span class="p">,</span><span class="n">ke</span>
<a name="ln-630"></a>      <span class="k">if</span> <span class="p">(</span><span class="n">locupot</span><span class="p">(</span><span class="n">k</span><span class="p">)</span> <span class="o">==</span> <span class="n">ke</span><span class="o">+</span><span class="mi">1</span><span class="p">)</span> <span class="k">then</span>      <span class="c">! indicator for extrapolation!</span>
<a name="ln-631"></a><span class="c">!        upinlo(:,k) = uprec(:,ke) + (uprec(:,ke) - uprec(:,ke-1)) / (zorf(ke)-zorf(ke-1)) * (zoif(k)-zorf(ke))</span>
<a name="ln-632"></a>        <span class="n">tpinlo</span><span class="p">(:,</span><span class="n">k</span><span class="p">)</span> <span class="o">=</span> <span class="mf">0.</span>
<a name="ln-633"></a>      <span class="n">elseif</span> <span class="p">(</span><span class="n">loclowot</span><span class="p">(</span><span class="n">k</span><span class="p">)</span> <span class="o">==</span> <span class="n">kb</span><span class="o">-</span><span class="mi">1</span><span class="p">)</span> <span class="k">then</span> <span class="c">! interprets this as extrapolation to bottom (use t=0 at z+=0)</span>
<a name="ln-634"></a>        <span class="n">tpinlo</span><span class="p">(:,</span><span class="n">k</span><span class="p">)</span> <span class="o">=</span> <span class="n">tprec</span><span class="p">(:,</span><span class="n">kb</span><span class="p">)</span><span class="o">/</span><span class="n">zotr</span><span class="p">(</span><span class="n">kb</span><span class="p">)</span> <span class="o">*</span> <span class="n">zoti</span><span class="p">(</span><span class="n">k</span><span class="p">)</span>
<a name="ln-635"></a>      <span class="k">else</span>                            <span class="c">! normal interpolation</span>
<a name="ln-636"></a>        <span class="n">tpinlo</span><span class="p">(:,</span><span class="n">k</span><span class="p">)</span> <span class="o">=</span> <span class="n">tprec</span><span class="p">(:,</span><span class="n">loclowot</span><span class="p">(</span><span class="n">k</span><span class="p">))</span> <span class="o">+</span> <span class="p">(</span><span class="n">tprec</span><span class="p">(:,</span><span class="n">locupot</span><span class="p">(</span><span class="n">k</span><span class="p">))</span> <span class="o">-</span> <span class="n">tprec</span><span class="p">(:,</span><span class="n">loclowot</span><span class="p">(</span><span class="n">k</span><span class="p">)))</span> <span class="o">/</span> <span class="p">(</span><span class="n">zotr</span><span class="p">(</span><span class="n">locupot</span><span class="p">(</span><span class="n">k</span><span class="p">))</span> <span class="o">-</span> <span class="n">zotr</span><span class="p">(</span><span class="n">loclowot</span><span class="p">(</span><span class="n">k</span><span class="p">)))</span> <span class="o">*</span> <span class="p">(</span><span class="n">zoti</span><span class="p">(</span><span class="n">k</span><span class="p">)</span> <span class="o">-</span> <span class="n">zotr</span><span class="p">(</span><span class="n">loclowot</span><span class="p">(</span><span class="n">k</span><span class="p">)))</span>
<a name="ln-637"></a>      <span class="k">end if</span>
<a name="ln-638"></a><span class="k">    end do</span>
<a name="ln-639"></a>     
<a name="ln-640"></a> <span class="c">!! Finished interpolating out temperature</span>
<a name="ln-641"></a><span class="c">!!!!! Finished Interpolation! !!!!!</span>
<a name="ln-642"></a>
<a name="ln-643"></a>
<a name="ln-644"></a>   <span class="c">! compute rescaled inner variables ! Winli = Winli (interpolation is enough)</span>
<a name="ln-645"></a>    <span class="n">Uinli</span> <span class="o">=</span> <span class="n">gamm</span><span class="o">*</span> <span class="n">Uinli</span>                   
<a name="ln-646"></a>    <span class="n">Tinli</span> <span class="o">=</span> <span class="n">lamb</span><span class="o">*</span> <span class="n">Tinli</span> <span class="o">+</span> <span class="p">(</span><span class="mf">1.</span><span class="o">-</span><span class="n">lamb</span><span class="p">)</span><span class="o">*</span><span class="n">thls</span>     <span class="c">! this is different for isoflux wall!                   </span>
<a name="ln-647"></a>    <span class="n">upinli</span> <span class="o">=</span> <span class="n">gamm</span><span class="o">*</span> <span class="n">upinli</span>
<a name="ln-648"></a>    <span class="n">vpinli</span> <span class="o">=</span> <span class="n">gamm</span><span class="o">*</span> <span class="n">vpinli</span>
<a name="ln-649"></a>    <span class="n">wpinli</span> <span class="o">=</span> <span class="n">gamm</span><span class="o">*</span> <span class="n">wpinli</span> 
<a name="ln-650"></a>    <span class="n">tpinli</span> <span class="o">=</span> <span class="n">lamb</span><span class="o">*</span> <span class="n">tpinli</span>         <span class="c">! See Kong (2000)</span>
<a name="ln-651"></a>   <span class="c">! compute rescaled outer variables ! Winlo = Winlo (interpolation is enough)</span>
<a name="ln-652"></a>    <span class="n">Uinlo</span> <span class="o">=</span> <span class="n">gamm</span><span class="o">*</span> <span class="n">Uinlo</span>  <span class="o">+</span> <span class="p">(</span><span class="mf">1.</span><span class="o">-</span> <span class="n">gamm</span><span class="p">)</span><span class="o">*</span><span class="n">Uinf</span>
<a name="ln-653"></a>    <span class="n">Tinlo</span> <span class="o">=</span> <span class="n">lamb</span><span class="o">*</span> <span class="n">Tinlo</span>  <span class="o">+</span> <span class="p">(</span><span class="mf">1.</span><span class="o">-</span> <span class="n">lamb</span><span class="p">)</span><span class="o">*</span><span class="n">thl_top</span> 
<a name="ln-654"></a><span class="c">!    Uinlo = gamm* Uinlo  + (1.- gamm)*Urec(ke) </span>
<a name="ln-655"></a>    <span class="n">upinlo</span> <span class="o">=</span> <span class="n">gamm</span><span class="o">*</span> <span class="n">upinlo</span>
<a name="ln-656"></a>    <span class="n">vpinlo</span> <span class="o">=</span> <span class="n">gamm</span><span class="o">*</span> <span class="n">vpinlo</span>
<a name="ln-657"></a>    <span class="n">wpinlo</span> <span class="o">=</span> <span class="n">gamm</span><span class="o">*</span> <span class="n">wpinlo</span>
<a name="ln-658"></a>    <span class="n">tpinlo</span> <span class="o">=</span> <span class="n">lamb</span><span class="o">*</span> <span class="n">tpinlo</span>         <span class="c">! See Kong (2000)</span>
<a name="ln-659"></a>
<a name="ln-660"></a><span class="c">!    utop = Uinlo(ke)</span>
<a name="ln-661"></a><span class="c">!    Uinlo = Uinlo +(Uinf-utop)     ! make sure at the inlet the mean top velocity equals Uinf</span>
<a name="ln-662"></a><span class="c">!! add defect velocity to make sure the j-averaged velocity at the top equals Uinf</span>
<a name="ln-663"></a><span class="c">!    utop = Uinlo(ke)</span>
<a name="ln-664"></a><span class="c">!    do k=kb,ke</span>
<a name="ln-665"></a><span class="c">!        Uinlo(k) = Uinlo(k)*Uinf/utop</span>
<a name="ln-666"></a><span class="c">!    end do</span>
<a name="ln-667"></a>
<a name="ln-668"></a>
<a name="ln-669"></a>   <span class="c">! Compute weight function (alpha=4, b=0.2)</span>
<a name="ln-670"></a>    <span class="n">alpha</span> <span class="o">=</span> <span class="mf">4.</span>
<a name="ln-671"></a>    <span class="n">beta</span> <span class="o">=</span> <span class="mf">0.2</span>
<a name="ln-672"></a>    <span class="n">wfuncf</span> <span class="o">=</span> <span class="mf">0.5</span><span class="o">*</span><span class="p">(</span><span class="mf">1.</span> <span class="o">+</span> <span class="nb">tanh</span><span class="p">(</span> <span class="n">alpha</span><span class="o">*</span><span class="p">(</span><span class="n">zoif</span><span class="o">-</span><span class="n">beta</span><span class="p">)</span><span class="o">/</span><span class="p">((</span><span class="mf">1.</span><span class="o">-</span><span class="mf">2.</span><span class="o">*</span><span class="n">beta</span><span class="p">)</span><span class="o">*</span><span class="n">zoif</span><span class="o">+</span><span class="n">beta</span><span class="p">)</span> <span class="p">)</span><span class="o">/</span><span class="nb">tanh</span><span class="p">(</span><span class="n">alpha</span><span class="p">)</span> <span class="p">)</span> <span class="c">! for full level height</span>
<a name="ln-673"></a>    <span class="n">wfunch</span> <span class="o">=</span> <span class="mf">0.5</span><span class="o">*</span><span class="p">(</span><span class="mf">1.</span> <span class="o">+</span> <span class="nb">tanh</span><span class="p">(</span> <span class="n">alpha</span><span class="o">*</span><span class="p">(</span><span class="n">zoih</span><span class="o">-</span><span class="n">beta</span><span class="p">)</span><span class="o">/</span><span class="p">((</span><span class="mf">1.</span><span class="o">-</span><span class="mf">2.</span><span class="o">*</span><span class="n">beta</span><span class="p">)</span><span class="o">*</span><span class="n">zoih</span><span class="o">+</span><span class="n">beta</span><span class="p">)</span> <span class="p">)</span><span class="o">/</span><span class="nb">tanh</span><span class="p">(</span><span class="n">alpha</span><span class="p">)</span> <span class="p">)</span> <span class="c">! for half level height</span>
<a name="ln-674"></a>    <span class="n">wfunct</span> <span class="o">=</span> <span class="mf">0.5</span><span class="o">*</span><span class="p">(</span><span class="mf">1.</span> <span class="o">+</span> <span class="nb">tanh</span><span class="p">(</span> <span class="n">alpha</span><span class="o">*</span><span class="p">(</span><span class="n">zoti</span><span class="o">-</span><span class="n">beta</span><span class="p">)</span><span class="o">/</span><span class="p">((</span><span class="mf">1.</span><span class="o">-</span><span class="mf">2.</span><span class="o">*</span><span class="n">beta</span><span class="p">)</span><span class="o">*</span><span class="n">zoti</span><span class="o">+</span><span class="n">beta</span><span class="p">)</span> <span class="p">)</span><span class="o">/</span><span class="nb">tanh</span><span class="p">(</span><span class="n">alpha</span><span class="p">)</span> <span class="p">)</span> <span class="c">! for temperature (full level height)</span>
<a name="ln-675"></a>    <span class="k">do </span><span class="n">k</span><span class="o">=</span><span class="n">kb</span><span class="p">,</span><span class="n">ke</span>
<a name="ln-676"></a>      <span class="k">if</span> <span class="p">(</span><span class="n">wfuncf</span><span class="p">(</span><span class="n">k</span><span class="p">)</span> <span class="p">.</span><span class="n">gt</span><span class="p">.</span> <span class="mf">1.</span><span class="p">)</span> <span class="k">then  </span>
<a name="ln-677"></a><span class="k">        </span><span class="n">wfuncf</span><span class="p">(</span><span class="n">k</span><span class="p">)</span> <span class="o">=</span> <span class="mf">1.</span>
<a name="ln-678"></a>      <span class="k">end if</span>
<a name="ln-679"></a><span class="k">      if</span> <span class="p">(</span><span class="n">wfunct</span><span class="p">(</span><span class="n">k</span><span class="p">)</span> <span class="p">.</span><span class="n">gt</span><span class="p">.</span> <span class="mf">1.</span><span class="p">)</span> <span class="k">then  </span>
<a name="ln-680"></a><span class="k">        </span><span class="n">wfunct</span><span class="p">(</span><span class="n">k</span><span class="p">)</span> <span class="o">=</span> <span class="mf">1.</span>
<a name="ln-681"></a>      <span class="k">end if</span>
<a name="ln-682"></a><span class="k">    end do</span>
<a name="ln-683"></a><span class="k">    do </span><span class="n">k</span><span class="o">=</span><span class="n">kb</span><span class="p">,</span><span class="n">ke</span><span class="o">+</span><span class="mi">1</span>
<a name="ln-684"></a>      <span class="k">if</span> <span class="p">(</span><span class="n">wfunch</span><span class="p">(</span><span class="n">k</span><span class="p">)</span> <span class="p">.</span><span class="n">gt</span><span class="p">.</span> <span class="mf">1.</span><span class="p">)</span> <span class="k">then  </span>
<a name="ln-685"></a><span class="k">        </span><span class="n">wfunch</span><span class="p">(</span><span class="n">k</span><span class="p">)</span> <span class="o">=</span> <span class="mf">1.</span>
<a name="ln-686"></a>      <span class="k">end if</span>
<a name="ln-687"></a><span class="k">    end do</span>
<a name="ln-688"></a>    
<a name="ln-689"></a>
<a name="ln-690"></a> 
<a name="ln-691"></a><span class="c">!    write(6,*) &#39;maxval(wfuncf)=&#39;, maxval(wfuncf)</span>
<a name="ln-692"></a><span class="c">!    write(6,*) &#39;maxval(wfunch)=&#39;, maxval(wfunch)</span>
<a name="ln-693"></a>
<a name="ln-694"></a>
<a name="ln-695"></a>   <span class="c">! Compute the velocity components for the inlet BC</span>
<a name="ln-696"></a>    <span class="k">do </span><span class="n">k</span><span class="o">=</span><span class="n">kb</span><span class="p">,</span><span class="n">ke</span>  
<a name="ln-697"></a>    <span class="k">do </span><span class="n">j</span><span class="o">=</span><span class="n">jb</span><span class="p">,</span><span class="n">je</span>
<a name="ln-698"></a><span class="c">!      u0inletbc(j,k) = (Uinli(k)+ upinli(j,k))*(1.-wfuncf(k)) +  (Uinlo(k) + upinlo(j,k))* wfuncf(k)</span>
<a name="ln-699"></a><span class="c">!      v0inletbc(j,k) =            vpinli(j,k) *(1.-wfuncf(k)) +              vpinlo(j,k) * wfuncf(k) </span>
<a name="ln-700"></a><span class="c">!      t0inletbc(j,k) = (Tinli(k)+ tpinli(j,k))*(1.-wfunct(k)) +  (Tinlo(k) + tpinlo(j,k))* wfunct(k)      </span>
<a name="ln-701"></a>      <span class="n">u0inletbc</span><span class="p">(</span><span class="n">j</span><span class="p">,</span><span class="n">k</span><span class="p">)</span> <span class="o">=</span> <span class="p">(</span><span class="n">Uinli</span><span class="p">(</span><span class="n">k</span><span class="p">)</span><span class="o">+</span> <span class="n">upinli</span><span class="p">(</span><span class="n">j</span><span class="p">,</span><span class="n">k</span><span class="p">)</span><span class="o">*</span><span class="n">heavif</span><span class="p">(</span><span class="n">k</span><span class="p">))</span><span class="o">*</span><span class="p">(</span><span class="mf">1.</span><span class="o">-</span><span class="n">wfuncf</span><span class="p">(</span><span class="n">k</span><span class="p">))</span> <span class="o">+</span>  <span class="p">(</span><span class="n">Uinlo</span><span class="p">(</span><span class="n">k</span><span class="p">)</span> <span class="o">+</span> <span class="n">upinlo</span><span class="p">(</span><span class="n">j</span><span class="p">,</span><span class="n">k</span><span class="p">)</span><span class="o">*</span><span class="n">heavif</span><span class="p">(</span><span class="n">k</span><span class="p">))</span><span class="o">*</span> <span class="n">wfuncf</span><span class="p">(</span><span class="n">k</span><span class="p">)</span>
<a name="ln-702"></a>      <span class="n">v0inletbc</span><span class="p">(</span><span class="n">j</span><span class="p">,</span><span class="n">k</span><span class="p">)</span> <span class="o">=</span>            <span class="n">vpinli</span><span class="p">(</span><span class="n">j</span><span class="p">,</span><span class="n">k</span><span class="p">)</span><span class="o">*</span><span class="n">heavif</span><span class="p">(</span><span class="n">k</span><span class="p">)</span> <span class="o">*</span><span class="p">(</span><span class="mf">1.</span><span class="o">-</span><span class="n">wfuncf</span><span class="p">(</span><span class="n">k</span><span class="p">))</span> <span class="o">+</span>              <span class="n">vpinlo</span><span class="p">(</span><span class="n">j</span><span class="p">,</span><span class="n">k</span><span class="p">)</span><span class="o">*</span><span class="n">heavif</span><span class="p">(</span><span class="n">k</span><span class="p">)</span> <span class="o">*</span> <span class="n">wfuncf</span><span class="p">(</span><span class="n">k</span><span class="p">)</span> 
<a name="ln-703"></a>      <span class="n">t0inletbc</span><span class="p">(</span><span class="n">j</span><span class="p">,</span><span class="n">k</span><span class="p">)</span> <span class="o">=</span> <span class="p">(</span><span class="n">Tinli</span><span class="p">(</span><span class="n">k</span><span class="p">)</span><span class="o">+</span> <span class="n">tpinli</span><span class="p">(</span><span class="n">j</span><span class="p">,</span><span class="n">k</span><span class="p">)</span><span class="o">*</span><span class="n">heavit</span><span class="p">(</span><span class="n">k</span><span class="p">))</span><span class="o">*</span><span class="p">(</span><span class="mf">1.</span><span class="o">-</span><span class="n">wfunct</span><span class="p">(</span><span class="n">k</span><span class="p">))</span> <span class="o">+</span>  <span class="p">(</span><span class="n">Tinlo</span><span class="p">(</span><span class="n">k</span><span class="p">)</span> <span class="o">+</span> <span class="n">tpinlo</span><span class="p">(</span><span class="n">j</span><span class="p">,</span><span class="n">k</span><span class="p">)</span><span class="o">*</span><span class="n">heavit</span><span class="p">(</span><span class="n">k</span><span class="p">))</span><span class="o">*</span> <span class="n">wfunct</span><span class="p">(</span><span class="n">k</span><span class="p">)</span>      
<a name="ln-704"></a>    <span class="k">end do</span>
<a name="ln-705"></a><span class="k">    end do</span>
<a name="ln-706"></a><span class="k">   </span>
<a name="ln-707"></a><span class="k">    do </span><span class="n">k</span><span class="o">=</span><span class="n">kb</span><span class="p">,</span><span class="n">ke</span><span class="o">+</span><span class="mi">1</span> 
<a name="ln-708"></a>    <span class="k">do </span><span class="n">j</span><span class="o">=</span><span class="n">jb</span><span class="p">,</span><span class="n">je</span>
<a name="ln-709"></a>      <span class="n">w0inletbc</span><span class="p">(</span><span class="n">j</span><span class="p">,</span><span class="n">k</span><span class="p">)</span> <span class="o">=</span> <span class="p">(</span><span class="n">Winli</span><span class="p">(</span><span class="n">k</span><span class="p">)</span><span class="o">+</span> <span class="n">wpinli</span><span class="p">(</span><span class="n">j</span><span class="p">,</span><span class="n">k</span><span class="p">)</span><span class="o">*</span><span class="n">heavih</span><span class="p">(</span><span class="n">k</span><span class="p">))</span><span class="o">*</span><span class="p">(</span><span class="mi">1</span><span class="o">-</span><span class="n">wfunch</span><span class="p">(</span><span class="n">k</span><span class="p">))</span> <span class="o">+</span>  <span class="p">(</span><span class="n">Winlo</span><span class="p">(</span><span class="n">k</span><span class="p">)</span> <span class="o">+</span> <span class="n">wpinlo</span><span class="p">(</span><span class="n">j</span><span class="p">,</span><span class="n">k</span><span class="p">)</span><span class="o">*</span><span class="n">heavih</span><span class="p">(</span><span class="n">k</span><span class="p">))</span><span class="o">*</span> <span class="n">wfunch</span><span class="p">(</span><span class="n">k</span><span class="p">)</span>
<a name="ln-710"></a>    <span class="k">end do</span>
<a name="ln-711"></a><span class="k">    end do</span>
<a name="ln-712"></a><span class="k">    </span><span class="n">w0inletbc</span><span class="p">(:,</span><span class="n">kb</span><span class="p">)</span> <span class="o">=</span> <span class="mf">0.</span>
<a name="ln-713"></a>    <span class="n">w0inletbc</span><span class="p">(:,</span><span class="n">ke</span><span class="o">+</span><span class="mi">1</span><span class="p">)</span> <span class="o">=</span> <span class="mf">0.</span>
<a name="ln-714"></a>
<a name="ln-715"></a><span class="c">!!    kdamp = kb + floor(0.75*(ke-kb+1))</span>
<a name="ln-716"></a><span class="c">!    kdamp = kb + 144  ! =&gt; zf = 2.24</span>
<a name="ln-717"></a><span class="c">!    do k=kdamp,ke  </span>
<a name="ln-718"></a><span class="c">!    do j=jb,je</span>
<a name="ln-719"></a><span class="c">!      if (u0inletbc(j,k) &gt; Uinf) then</span>
<a name="ln-720"></a><span class="c">!        u0inletbc(j,k) = Uinf</span>
<a name="ln-721"></a><span class="c">!      end if</span>
<a name="ln-722"></a><span class="c">!    end do</span>
<a name="ln-723"></a><span class="c">!    end do</span>
<a name="ln-724"></a>
<a name="ln-725"></a>
<a name="ln-726"></a>
<a name="ln-727"></a>   <span class="c">! Compute j-averaged inlet U  (used for compute thetai)</span>
<a name="ln-728"></a>    <span class="n">uinletbc2</span><span class="p">(</span><span class="n">ib</span><span class="p">,</span><span class="n">jb</span><span class="p">:</span><span class="n">je</span><span class="p">,</span><span class="n">kb</span><span class="p">:</span><span class="n">ke</span><span class="p">)</span> <span class="o">=</span> <span class="n">u0inletbc</span><span class="p">(</span><span class="n">jb</span><span class="p">:</span><span class="n">je</span><span class="p">,</span><span class="n">kb</span><span class="p">:</span><span class="n">ke</span><span class="p">)</span>  <span class="c">! this is just a dummy variable to give uninletbc the right dimension in slabsum</span>
<a name="ln-729"></a>    <span class="n">tinletbc2</span><span class="p">(</span><span class="n">ib</span><span class="p">,</span><span class="n">jb</span><span class="p">:</span><span class="n">je</span><span class="p">,</span><span class="n">kb</span><span class="p">:</span><span class="n">ke</span><span class="p">)</span> <span class="o">=</span> <span class="n">t0inletbc</span><span class="p">(</span><span class="n">jb</span><span class="p">:</span><span class="n">je</span><span class="p">,</span><span class="n">kb</span><span class="p">:</span><span class="n">ke</span><span class="p">)</span>  <span class="c">! this is just a dummy variable to give tninletbc the right dimension in slabsum</span>
<a name="ln-730"></a>    <span class="n">urav</span> <span class="o">=</span> <span class="mf">0.</span>
<a name="ln-731"></a>    <span class="n">trav</span> <span class="o">=</span> <span class="mf">0.</span>
<a name="ln-732"></a>    <span class="k">call </span><span class="n">slabsum</span><span class="p">(</span><span class="n">urav</span>  <span class="p">,</span><span class="n">kb</span><span class="p">,</span><span class="n">ke</span><span class="p">,</span><span class="n">uinletbc2</span> <span class="p">,</span><span class="n">ib</span><span class="p">,</span><span class="n">ib</span><span class="p">,</span><span class="n">jb</span><span class="p">,</span><span class="n">je</span><span class="p">,</span><span class="n">kb</span><span class="p">,</span><span class="n">ke</span><span class="p">,</span><span class="n">ib</span><span class="p">,</span><span class="n">ib</span><span class="p">,</span><span class="n">jb</span><span class="p">,</span><span class="n">je</span><span class="p">,</span><span class="n">kb</span><span class="p">,</span><span class="n">ke</span><span class="p">)</span>
<a name="ln-733"></a>    <span class="k">call </span><span class="n">slabsum</span><span class="p">(</span><span class="n">trav</span>  <span class="p">,</span><span class="n">kb</span><span class="p">,</span><span class="n">ke</span><span class="p">,</span><span class="n">tinletbc2</span> <span class="p">,</span><span class="n">ib</span><span class="p">,</span><span class="n">ib</span><span class="p">,</span><span class="n">jb</span><span class="p">,</span><span class="n">je</span><span class="p">,</span><span class="n">kb</span><span class="p">,</span><span class="n">ke</span><span class="p">,</span><span class="n">ib</span><span class="p">,</span><span class="n">ib</span><span class="p">,</span><span class="n">jb</span><span class="p">,</span><span class="n">je</span><span class="p">,</span><span class="n">kb</span><span class="p">,</span><span class="n">ke</span><span class="p">)</span>
<a name="ln-734"></a><span class="c">!    call slabsum(urav  ,kb,ke,u0 ,ib-1,ie+1,jb-1,je+1,kb-1,ke+1,ib,ib,jb,je,kb,ke)</span>
<a name="ln-735"></a>    <span class="n">urav</span> <span class="o">=</span> <span class="n">urav</span> <span class="o">/</span> <span class="p">(</span><span class="n">jge</span><span class="o">-</span><span class="n">jgb</span> <span class="o">+</span><span class="mi">1</span><span class="p">)</span>                    <span class="c">! average over j-direction</span>
<a name="ln-736"></a>    <span class="n">trav</span> <span class="o">=</span> <span class="n">trav</span> <span class="o">/</span> <span class="p">(</span><span class="n">jge</span><span class="o">-</span><span class="n">jgb</span> <span class="o">+</span><span class="mi">1</span><span class="p">)</span>                    <span class="c">! average over j-direction</span>
<a name="ln-737"></a>
<a name="ln-738"></a><span class="c">! determine bulk velocity of new profile</span>
<a name="ln-739"></a>    <span class="k">do </span><span class="n">k</span><span class="o">=</span><span class="n">kb</span><span class="p">,</span><span class="n">ke</span>
<a name="ln-740"></a>      <span class="n">uravdzf</span><span class="p">(</span><span class="n">k</span><span class="p">)</span> <span class="o">=</span> <span class="n">urav</span><span class="p">(</span><span class="n">k</span><span class="p">)</span><span class="o">*</span><span class="n">dzf</span><span class="p">(</span><span class="n">k</span><span class="p">)</span>
<a name="ln-741"></a>    <span class="k">end do</span>
<a name="ln-742"></a><span class="k">    </span><span class="n">totalu</span>    <span class="o">=</span> <span class="nb">sum</span><span class="p">(</span><span class="n">uravdzf</span><span class="p">(</span><span class="n">kb</span><span class="p">:</span><span class="n">ke</span><span class="p">))</span><span class="o">/</span><span class="p">(</span><span class="n">zh</span><span class="p">(</span><span class="n">ke</span><span class="o">+</span><span class="mi">1</span><span class="p">)</span><span class="o">-</span><span class="n">zh</span><span class="p">(</span><span class="n">kb</span><span class="p">))</span>      <span class="c">! Area-averaged outflow velocity</span>
<a name="ln-743"></a>
<a name="ln-744"></a><span class="c">! rescale the instantaneous profile to keep mass flux constant (tot avoid pressure fluctuations)</span>
<a name="ln-745"></a>    <span class="k">if</span> <span class="p">(</span><span class="n">luvolflowr</span> <span class="p">)</span> <span class="k">then </span>
<a name="ln-746"></a><span class="k">      do </span><span class="n">k</span><span class="o">=</span><span class="n">kb</span><span class="p">,</span><span class="n">ke</span>
<a name="ln-747"></a>        <span class="n">uinldzf</span><span class="p">(</span><span class="n">k</span><span class="p">)</span> <span class="o">=</span> <span class="n">Uinl</span><span class="p">(</span><span class="n">k</span><span class="p">)</span><span class="o">*</span><span class="n">dzf</span><span class="p">(</span><span class="n">k</span><span class="p">)</span>
<a name="ln-748"></a>      <span class="k">end do</span>
<a name="ln-749"></a><span class="k">      </span><span class="n">totaluinl</span> <span class="o">=</span> <span class="nb">sum</span><span class="p">(</span><span class="n">uinldzf</span><span class="p">(</span><span class="n">kb</span><span class="p">:</span><span class="n">ke</span><span class="p">))</span><span class="o">/</span><span class="p">(</span><span class="n">zh</span><span class="p">(</span><span class="n">ke</span><span class="o">+</span><span class="mi">1</span><span class="p">)</span><span class="o">-</span><span class="n">zh</span><span class="p">(</span><span class="n">kb</span><span class="p">))</span>      <span class="c">! Area-averaged inflow velocity</span>
<a name="ln-750"></a>      <span class="n">scalef</span> <span class="o">=</span> <span class="n">totaluinl</span><span class="o">/</span><span class="n">totalu</span> <span class="c">! compute factor to scale the velocity profile with</span>
<a name="ln-751"></a>      <span class="n">u0inletbc</span><span class="p">(:,:)</span> <span class="o">=</span> <span class="n">u0inletbc</span><span class="p">(:,:)</span><span class="o">*</span><span class="n">scalef</span>  <span class="c">! rescale the velocity profile to have constant mass-flux </span>
<a name="ln-752"></a>      <span class="n">urav</span><span class="p">(:)</span> <span class="o">=</span> <span class="n">urav</span><span class="p">(:)</span><span class="o">*</span><span class="n">scalef</span>                <span class="c">! also rescale the part that is added to the mean</span>
<a name="ln-753"></a>    <span class="k">end if</span>
<a name="ln-754"></a>
<a name="ln-755"></a><span class="c">!! add defect velocity to make sure the mass flow is the same as the initial mass flow</span>
<a name="ln-756"></a> <span class="c">!   u0inletbc = u0inletbc + (ubulk-totalu)</span>
<a name="ln-757"></a> <span class="c">!   urav      = urav      + (ubulk-totalu)</span>
<a name="ln-758"></a>
<a name="ln-759"></a><span class="c">!! add defect velocity to make sure the j-averaged velocity at the top equals Uinf</span>
<a name="ln-760"></a><span class="c">!    utop = urav(ke)</span>
<a name="ln-761"></a><span class="c">!    do k=kb,ke</span>
<a name="ln-762"></a><span class="c">!      do j=jb,je</span>
<a name="ln-763"></a><span class="c">!        u0inletbc(j,k) = u0inletbc(j,k)*Uinf/utop</span>
<a name="ln-764"></a><span class="c">!      end do</span>
<a name="ln-765"></a><span class="c">!      urav(k) = urav(k)*Uinf/utop</span>
<a name="ln-766"></a><span class="c">!    end do</span>
<a name="ln-767"></a>   
<a name="ln-768"></a><span class="c">!    u0inletbc = u0inletbc + (Uinf-utop)</span>
<a name="ln-769"></a><span class="c">!    urav      = urav      + (Uinf-utop)</span>
<a name="ln-770"></a>
<a name="ln-771"></a>
<a name="ln-772"></a><span class="c">!    if (myid==0) then</span>
<a name="ln-773"></a><span class="c">!    write(6,*) &#39;u0inletbc(jb+2,ke)&#39;, u0inletbc</span>
<a name="ln-774"></a><span class="c">!    end if</span>
<a name="ln-775"></a>
<a name="ln-776"></a>   <span class="c">! Compute j- and time-averaged  inlet U  (used for compute thetai)</span>
<a name="ln-777"></a>    <span class="k">if</span> <span class="p">(.</span><span class="nb">not</span><span class="p">.</span><span class="n">lfixinlet</span><span class="p">)</span> <span class="k">then</span>  <span class="c">! only update the average inlet profiles when lfixinlet .eqv..false.</span>
<a name="ln-778"></a>      <span class="k">do </span><span class="n">k</span><span class="o">=</span><span class="n">kb</span><span class="p">,</span><span class="n">ke</span>
<a name="ln-779"></a>        <span class="n">Uinl</span><span class="p">(</span><span class="n">k</span><span class="p">)</span> <span class="o">=</span>  <span class="n">urav</span><span class="p">(</span><span class="n">k</span><span class="p">)</span><span class="o">*</span><span class="n">deltat</span><span class="o">*</span><span class="n">avinti</span> <span class="o">+</span> <span class="p">(</span><span class="mf">1.</span><span class="o">-</span><span class="n">deltat</span><span class="o">*</span><span class="n">avinti</span><span class="p">)</span><span class="o">*</span><span class="n">Uinl</span><span class="p">(</span><span class="n">k</span><span class="p">)</span>
<a name="ln-780"></a>      <span class="k">end do</span>
<a name="ln-781"></a><span class="k">    end if</span>
<a name="ln-782"></a><span class="k">    do </span><span class="n">k</span><span class="o">=</span><span class="n">kb</span><span class="p">,</span><span class="n">ke</span>
<a name="ln-783"></a>      <span class="n">Tinl</span><span class="p">(</span><span class="n">k</span><span class="p">)</span> <span class="o">=</span>  <span class="n">trav</span><span class="p">(</span><span class="n">k</span><span class="p">)</span><span class="o">*</span><span class="n">deltat</span><span class="o">*</span><span class="n">avinti</span> <span class="o">+</span> <span class="p">(</span><span class="mf">1.</span><span class="o">-</span><span class="n">deltat</span><span class="o">*</span><span class="n">avinti</span><span class="p">)</span><span class="o">*</span><span class="n">Tinl</span><span class="p">(</span><span class="n">k</span><span class="p">)</span>
<a name="ln-784"></a>    <span class="k">end do</span>
<a name="ln-785"></a>
<a name="ln-786"></a><span class="c">!    utop = Uinl(ke)</span>
<a name="ln-787"></a><span class="c">!    Uinl = Uinl +(Uinf-utop)     ! make sure at the inlet the mean top velocity equals Uinf</span>
<a name="ln-788"></a><span class="c">!    uminletbc = uminletbc + (Uinf-utop)</span>
<a name="ln-789"></a>
<a name="ln-790"></a><span class="c">! write inletplane to array (and to file after 1000 time steps)   </span>
<a name="ln-791"></a>    <span class="k">if</span> <span class="p">(</span><span class="n">lstoreplane</span> <span class="p">)</span> <span class="k">then     </span>
<a name="ln-792"></a><span class="k">      </span><span class="n">storeu0inletbc</span><span class="p">(:,:,</span><span class="n">nstepread</span><span class="p">)</span> <span class="o">=</span> <span class="n">u0inletbc</span><span class="p">(:,:)</span> 
<a name="ln-793"></a>      <span class="n">storev0inletbc</span><span class="p">(:,:,</span><span class="n">nstepread</span><span class="p">)</span> <span class="o">=</span> <span class="n">v0inletbc</span><span class="p">(:,:)</span>
<a name="ln-794"></a>      <span class="n">storew0inletbc</span><span class="p">(:,:,</span><span class="n">nstepread</span><span class="p">)</span> <span class="o">=</span> <span class="n">w0inletbc</span><span class="p">(:,:)</span>
<a name="ln-795"></a>      <span class="n">storet0inletbc</span><span class="p">(:,:,</span><span class="n">nstepread</span><span class="p">)</span> <span class="o">=</span> <span class="n">t0inletbc</span><span class="p">(:,:)</span>
<a name="ln-796"></a>      <span class="n">nstepread</span> <span class="o">=</span> <span class="n">nstepread</span> <span class="o">+</span><span class="mi">1</span>
<a name="ln-797"></a>      <span class="k">if</span> <span class="p">(</span><span class="n">nstepread</span> <span class="o">==</span> <span class="n">nstore</span><span class="o">+</span><span class="mi">1</span><span class="p">)</span> <span class="k">then</span>
<a name="ln-798"></a><span class="k">        </span><span class="n">nfile</span> <span class="o">=</span> <span class="n">nfile</span> <span class="o">+</span><span class="mi">1</span>       <span class="c">! next file number</span>
<a name="ln-799"></a>        <span class="k">call </span><span class="n">writeinletfile</span>    <span class="c">! write 1000 time steps to file</span>
<a name="ln-800"></a>        <span class="k">call </span><span class="n">writerestartfiles</span> 
<a name="ln-801"></a>        <span class="n">nstepread</span> <span class="o">=</span> <span class="mi">1</span>          <span class="c">! reset counter </span>
<a name="ln-802"></a>      <span class="k">end if</span>   <span class="c">! nstepread == 1001      </span>
<a name="ln-803"></a>    <span class="k">end if</span> <span class="c">! lstoreplane </span>
<a name="ln-804"></a>    
<a name="ln-805"></a>
<a name="ln-806"></a>    <span class="k">if</span> <span class="p">(</span><span class="n">rk3step</span><span class="o">==</span><span class="mi">1</span><span class="p">)</span> <span class="k">then</span>
<a name="ln-807"></a><span class="k">      </span><span class="n">uminletbc</span> <span class="o">=</span> <span class="n">u0inletbc</span>
<a name="ln-808"></a>      <span class="n">vminletbc</span> <span class="o">=</span> <span class="n">v0inletbc</span>
<a name="ln-809"></a>      <span class="n">wminletbc</span> <span class="o">=</span> <span class="n">w0inletbc</span>
<a name="ln-810"></a>      <span class="n">tminletbc</span> <span class="o">=</span> <span class="n">t0inletbc</span>
<a name="ln-811"></a>    <span class="k">end if</span>
<a name="ln-812"></a>
<a name="ln-813"></a><span class="k">   if</span> <span class="p">(</span><span class="n">lbuoyancy</span> <span class="p">)</span> <span class="k">then</span>
<a name="ln-814"></a><span class="c">!     call blthicknessmo(di_test,utaui,lmoi)</span>
<a name="ln-815"></a>     <span class="k">call </span><span class="n">blthicknesst</span><span class="p">(</span><span class="n">di_test</span><span class="p">,</span><span class="n">Uinl</span><span class="p">,</span><span class="mf">0.99</span><span class="p">)</span>
<a name="ln-816"></a><span class="c">!     call dispthicknessmo(displ)  ! needed in top BC</span>
<a name="ln-817"></a>     <span class="k">call </span><span class="n">dispthicknessexp</span><span class="p">(</span><span class="n">displ</span><span class="p">)</span>
<a name="ln-818"></a>   <span class="k">else</span>
<a name="ln-819"></a><span class="c">!     call blthickness(di_test,utaui)</span>
<a name="ln-820"></a>     <span class="k">call </span><span class="n">blthicknesst</span><span class="p">(</span><span class="n">di_test</span><span class="p">,</span><span class="n">Uinl</span><span class="p">,</span><span class="mf">0.99</span><span class="p">)</span>
<a name="ln-821"></a><span class="c">!     call dispthickness(displ)  ! needed in top BC</span>
<a name="ln-822"></a>     <span class="k">call </span><span class="n">dispthicknessexp</span><span class="p">(</span><span class="n">displ</span><span class="p">)</span>
<a name="ln-823"></a>   <span class="k">end if</span>
<a name="ln-824"></a><span class="k">   call </span><span class="n">blthicknesst</span><span class="p">(</span><span class="n">dti_test</span><span class="p">,</span><span class="n">Tinl</span><span class="o">-</span><span class="n">thls</span><span class="p">,</span><span class="mf">0.99</span><span class="p">)</span>
<a name="ln-825"></a>   <span class="k">if</span> <span class="p">((</span><span class="n">myid</span><span class="o">==</span><span class="mi">0</span><span class="p">)</span> <span class="p">.</span><span class="nb">and</span><span class="p">.</span> <span class="p">(</span><span class="n">rk3step</span><span class="o">==</span><span class="mi">3</span><span class="p">))</span> <span class="k">then</span>
<a name="ln-826"></a><span class="k">     write</span><span class="p">(</span><span class="mi">6</span><span class="p">,</span><span class="o">*</span><span class="p">)</span> <span class="s1">&#39;Inlet Gen: gamma,lambda=&#39;</span><span class="p">,</span><span class="n">gamm</span><span class="p">,</span><span class="n">lamb</span>
<a name="ln-827"></a>     <span class="k">write</span><span class="p">(</span><span class="mi">6</span><span class="p">,</span><span class="o">*</span><span class="p">)</span> <span class="s1">&#39;Inlet Gen: Uinl(ke),Tinl(ke)=&#39;</span><span class="p">,</span><span class="n">Uinl</span><span class="p">(</span><span class="n">ke</span><span class="p">),</span><span class="n">Tinl</span><span class="p">(</span><span class="n">ke</span><span class="p">)</span>
<a name="ln-828"></a>     <span class="k">write</span><span class="p">(</span><span class="mi">6</span><span class="p">,</span><span class="o">*</span><span class="p">)</span> <span class="s1">&#39;Inlet Gen: utaui,utaur =&#39;</span><span class="p">,</span><span class="n">utaui</span><span class="p">,</span><span class="n">utaur</span>
<a name="ln-829"></a>     <span class="k">write</span><span class="p">(</span><span class="mi">6</span><span class="p">,</span><span class="o">*</span><span class="p">)</span> <span class="s1">&#39;Inlet Gen: ttaui,ttaur =&#39;</span><span class="p">,</span><span class="n">ttaui</span><span class="p">,</span><span class="n">ttaur</span>
<a name="ln-830"></a>     <span class="k">write</span><span class="p">(</span><span class="mi">6</span><span class="p">,</span><span class="o">*</span><span class="p">)</span> <span class="s1">&#39;Inlet Gen: Lmoi,Lmor =&#39;</span><span class="p">,</span><span class="n">lmoi</span><span class="p">,</span><span class="n">lmor</span>
<a name="ln-831"></a>     <span class="k">write</span><span class="p">(</span><span class="mi">6</span><span class="p">,</span><span class="o">*</span><span class="p">)</span> <span class="s1">&#39;Inlet Gen: deltar, deltai_test&#39;</span><span class="p">,</span> <span class="n">dr</span><span class="p">,</span> <span class="n">di_test</span>
<a name="ln-832"></a>     <span class="k">write</span><span class="p">(</span><span class="mi">6</span><span class="p">,</span><span class="o">*</span><span class="p">)</span> <span class="s1">&#39;Inlet Gen: deltatr, deltati_test&#39;</span><span class="p">,</span> <span class="n">dtr</span><span class="p">,</span> <span class="n">dti_test</span>
<a name="ln-833"></a>     <span class="k">write</span><span class="p">(</span><span class="mi">6</span><span class="p">,</span><span class="o">*</span><span class="p">)</span> <span class="s1">&#39;Inlet Gen: d*i, d*r=&#39;</span><span class="p">,</span><span class="n">displ</span><span class="p">(</span><span class="n">ib</span><span class="p">),</span><span class="n">displ</span><span class="p">(</span><span class="n">irecy</span><span class="p">)</span>
<a name="ln-834"></a>     <span class="k">write</span><span class="p">(</span><span class="mi">6</span><span class="p">,</span><span class="o">*</span><span class="p">)</span> <span class="s1">&#39;Inlet Gen: thetai,thetar&#39;</span><span class="p">,</span><span class="n">thetai</span><span class="p">,</span><span class="n">thetar</span>
<a name="ln-835"></a>     <span class="k">write</span><span class="p">(</span><span class="mi">6</span><span class="p">,</span><span class="o">*</span><span class="p">)</span> <span class="s1">&#39;Inlet Gen: thetati,thetatr&#39;</span><span class="p">,</span><span class="n">thetati</span><span class="p">,</span><span class="n">thetatr</span>
<a name="ln-836"></a>     <span class="k">if</span> <span class="p">(</span><span class="n">luvolflowr</span> <span class="p">)</span> <span class="k">then</span>
<a name="ln-837"></a><span class="k">       write</span><span class="p">(</span><span class="mi">6</span><span class="p">,</span><span class="o">*</span><span class="p">)</span> <span class="s1">&#39;Inlet Gen: mass flux correction factor = &#39;</span><span class="p">,</span><span class="n">scalef</span>
<a name="ln-838"></a><span class="c">!       write(6,*) &#39;Inlet Gen: mass flux                   = &#39;,totalreadu</span>
<a name="ln-839"></a>       <span class="k">write</span><span class="p">(</span><span class="mi">6</span><span class="p">,</span><span class="o">*</span><span class="p">)</span> <span class="s1">&#39;Inlet Gen: mass flux                   = &#39;</span><span class="p">,</span><span class="n">totaluinl</span>
<a name="ln-840"></a>     <span class="k">end if</span>
<a name="ln-841"></a><span class="k">   end if</span>
<a name="ln-842"></a><span class="k">    </span>
<a name="ln-843"></a><span class="k">    </span><span class="n">elseif</span> <span class="p">(</span><span class="n">iinletgen</span> <span class="o">==</span> <span class="mi">2</span><span class="p">)</span> <span class="k">then</span>
<a name="ln-844"></a><span class="k">      if</span> <span class="p">(</span><span class="n">myid</span><span class="o">==</span><span class="mi">0</span><span class="p">)</span> <span class="k">then</span>
<a name="ln-845"></a><span class="k">        write</span><span class="p">(</span><span class="mi">6</span><span class="p">,</span><span class="o">*</span><span class="p">)</span> <span class="s1">&#39;nstepread=&#39;</span><span class="p">,</span><span class="n">nstepread</span>
<a name="ln-846"></a>      <span class="k">end if</span>
<a name="ln-847"></a><span class="k">      </span><span class="n">u0inletbcold</span> <span class="o">=</span> <span class="n">u0inletbc</span>
<a name="ln-848"></a>      <span class="n">v0inletbcold</span> <span class="o">=</span> <span class="n">v0inletbc</span>
<a name="ln-849"></a>      <span class="n">w0inletbcold</span> <span class="o">=</span> <span class="n">w0inletbc</span>
<a name="ln-850"></a>      <span class="n">t0inletbcold</span> <span class="o">=</span> <span class="n">t0inletbc</span>
<a name="ln-851"></a>
<a name="ln-852"></a>  <span class="c">! determine time step interval in simulation</span>
<a name="ln-853"></a>      <span class="n">rk3coef</span>   <span class="o">=</span> <span class="n">dt</span> <span class="o">/</span> <span class="p">(</span><span class="mf">4.</span> <span class="o">-</span> <span class="nb">dble</span><span class="p">(</span><span class="n">rk3step</span><span class="p">))</span>
<a name="ln-854"></a>      <span class="k">if</span> <span class="p">(</span><span class="n">rk3step</span><span class="o">==</span><span class="mi">1</span><span class="p">)</span> <span class="k">then</span>
<a name="ln-855"></a><span class="k">        </span><span class="n">deltat</span> <span class="o">=</span> <span class="n">rk3coef</span>
<a name="ln-856"></a>      <span class="n">elseif</span> <span class="p">(</span><span class="n">rk3step</span><span class="o">==</span><span class="mi">2</span><span class="p">)</span> <span class="k">then</span>
<a name="ln-857"></a><span class="k">        </span><span class="n">deltat</span> <span class="o">=</span> <span class="n">rk3coef</span>   <span class="o">-</span> <span class="p">(</span><span class="n">dt</span><span class="o">/</span><span class="mf">3.</span><span class="p">)</span>
<a name="ln-858"></a>      <span class="n">elseif</span> <span class="p">(</span><span class="n">rk3step</span><span class="o">==</span><span class="mi">3</span><span class="p">)</span> <span class="k">then</span>
<a name="ln-859"></a><span class="k">        </span><span class="n">deltat</span> <span class="o">=</span> <span class="n">rk3coef</span> <span class="o">-</span> <span class="p">(</span><span class="n">dt</span><span class="o">/</span><span class="mf">2.</span><span class="p">)</span>
<a name="ln-860"></a>      <span class="k">end if</span>
<a name="ln-861"></a>  <span class="c">! determine time step interval in inlet data</span>
<a name="ln-862"></a>      <span class="n">rk3coefin</span> <span class="o">=</span> <span class="n">dtin</span> <span class="o">/</span> <span class="p">(</span><span class="mf">4.</span> <span class="o">-</span> <span class="nb">dble</span><span class="p">(</span><span class="n">rk3stepin</span><span class="p">))</span>
<a name="ln-863"></a>      <span class="k">if</span> <span class="p">(</span><span class="n">rk3stepin</span><span class="o">==</span><span class="mi">1</span><span class="p">)</span> <span class="k">then</span>
<a name="ln-864"></a><span class="k">        </span><span class="n">dtinrk</span> <span class="o">=</span> <span class="n">rk3coefin</span>
<a name="ln-865"></a>      <span class="n">elseif</span> <span class="p">(</span><span class="n">rk3stepin</span><span class="o">==</span><span class="mi">2</span><span class="p">)</span> <span class="k">then</span>
<a name="ln-866"></a><span class="k">        </span><span class="n">dtinrk</span> <span class="o">=</span> <span class="n">rk3coefin</span> <span class="o">-</span> <span class="p">(</span><span class="n">dtin</span><span class="o">/</span><span class="mf">3.</span><span class="p">)</span>
<a name="ln-867"></a>      <span class="n">elseif</span> <span class="p">(</span><span class="n">rk3stepin</span><span class="o">==</span><span class="mi">3</span><span class="p">)</span> <span class="k">then</span>
<a name="ln-868"></a><span class="k">        </span><span class="n">dtinrk</span> <span class="o">=</span> <span class="n">rk3coefin</span> <span class="o">-</span> <span class="p">(</span><span class="n">dtin</span><span class="o">/</span><span class="mf">2.</span><span class="p">)</span>
<a name="ln-869"></a>      <span class="k">end if</span>
<a name="ln-870"></a><span class="k"> </span>
<a name="ln-871"></a><span class="k">      </span><span class="n">interval</span> <span class="o">=</span> <span class="n">dtinrk</span> <span class="o">-</span> <span class="n">elapstep</span>
<a name="ln-872"></a>      <span class="n">elapstep</span> <span class="o">=</span> <span class="n">elapstep</span> <span class="o">+</span> <span class="n">deltat</span>
<a name="ln-873"></a>      <span class="k">if</span> <span class="p">(</span><span class="n">elapstep</span> <span class="o">&gt;</span> <span class="n">dtinrk</span><span class="p">)</span> <span class="k">then</span>      <span class="c">! use new value at next time step</span>
<a name="ln-874"></a>        <span class="n">nstepread</span> <span class="o">=</span> <span class="n">nstepread</span> <span class="o">+</span><span class="mi">1</span>
<a name="ln-875"></a>        <span class="n">elapstep</span> <span class="o">=</span> <span class="nb">mod</span><span class="p">(</span><span class="n">elapstep</span><span class="p">,</span><span class="n">dtinrk</span><span class="p">)</span>
<a name="ln-876"></a>        <span class="n">rk3stepin</span> <span class="o">=</span> <span class="nb">mod</span><span class="p">(</span><span class="n">rk3stepin</span><span class="p">,</span><span class="mi">3</span><span class="p">)</span> <span class="o">+</span> <span class="mi">1</span>
<a name="ln-877"></a>        <span class="n">rk3coefin</span> <span class="o">=</span> <span class="n">dtin</span> <span class="o">/</span> <span class="p">(</span><span class="mf">4.</span> <span class="o">-</span> <span class="nb">dble</span><span class="p">(</span><span class="n">rk3stepin</span><span class="p">))</span>
<a name="ln-878"></a>        <span class="k">if</span> <span class="p">(</span><span class="n">rk3stepin</span><span class="o">==</span><span class="mi">1</span><span class="p">)</span> <span class="k">then</span>
<a name="ln-879"></a><span class="k">          </span><span class="n">dtinrk</span> <span class="o">=</span> <span class="n">rk3coefin</span>
<a name="ln-880"></a>        <span class="n">elseif</span> <span class="p">(</span><span class="n">rk3stepin</span><span class="o">==</span><span class="mi">2</span><span class="p">)</span> <span class="k">then</span>
<a name="ln-881"></a><span class="k">          </span><span class="n">dtinrk</span> <span class="o">=</span> <span class="n">rk3coefin</span> <span class="o">-</span> <span class="p">(</span><span class="n">dtin</span><span class="o">/</span><span class="mf">3.</span><span class="p">)</span>
<a name="ln-882"></a>        <span class="n">elseif</span> <span class="p">(</span><span class="n">rk3stepin</span><span class="o">==</span><span class="mi">3</span><span class="p">)</span> <span class="k">then</span>
<a name="ln-883"></a><span class="k">          </span><span class="n">dtinrk</span> <span class="o">=</span> <span class="n">rk3coefin</span> <span class="o">-</span> <span class="p">(</span><span class="n">dtin</span><span class="o">/</span><span class="mf">2.</span><span class="p">)</span>
<a name="ln-884"></a>        <span class="k">end if</span>
<a name="ln-885"></a><span class="k">        </span><span class="n">u0inletbc</span><span class="p">(:,:)</span> <span class="o">=</span> <span class="n">storeu0inletbc</span><span class="p">(:,:,</span><span class="n">nstepread</span><span class="p">)</span>
<a name="ln-886"></a>        <span class="n">v0inletbc</span><span class="p">(:,:)</span> <span class="o">=</span> <span class="n">storev0inletbc</span><span class="p">(:,:,</span><span class="n">nstepread</span><span class="p">)</span>
<a name="ln-887"></a>        <span class="n">w0inletbc</span><span class="p">(:,:)</span> <span class="o">=</span> <span class="n">storew0inletbc</span><span class="p">(:,:,</span><span class="n">nstepread</span><span class="p">)</span>
<a name="ln-888"></a>        <span class="n">t0inletbc</span><span class="p">(:,:)</span> <span class="o">=</span> <span class="n">storet0inletbc</span><span class="p">(:,:,</span><span class="n">nstepread</span><span class="p">)</span>
<a name="ln-889"></a>        <span class="k">if</span> <span class="p">(</span><span class="n">nstepread</span> <span class="o">==</span> <span class="n">nstore</span><span class="p">)</span> <span class="k">then</span>
<a name="ln-890"></a><span class="k">          </span><span class="n">nfile</span> <span class="o">=</span> <span class="n">nfile</span> <span class="o">+</span> <span class="mi">1</span>
<a name="ln-891"></a>          <span class="k">call </span><span class="n">readinletfile</span>
<a name="ln-892"></a>          <span class="k">call </span><span class="n">writerestartfiles</span>
<a name="ln-893"></a>          <span class="n">nstepread</span> <span class="o">=</span> <span class="mi">0</span>
<a name="ln-894"></a>        <span class="k">end if</span>
<a name="ln-895"></a><span class="k">        </span><span class="n">interval</span> <span class="o">=</span> <span class="n">dtinrk</span>
<a name="ln-896"></a>        <span class="n">deltat</span> <span class="o">=</span> <span class="n">elapstep</span>
<a name="ln-897"></a><span class="c">!        write(6,*) &#39;dtinrk,deltat=&#39;, dtinrk,deltat</span>
<a name="ln-898"></a>      <span class="k">end if</span>
<a name="ln-899"></a><span class="k">      </span><span class="n">u0inletbc</span><span class="p">(:,:)</span> <span class="o">=</span> <span class="p">(</span><span class="mf">1.</span> <span class="o">-</span> <span class="n">deltat</span><span class="o">/</span><span class="n">interval</span><span class="p">)</span><span class="o">*</span><span class="n">u0inletbc</span><span class="p">(:,:)</span> <span class="o">+</span> <span class="p">(</span><span class="n">deltat</span><span class="o">/</span><span class="n">interval</span><span class="p">)</span><span class="o">*</span><span class="n">storeu0inletbc</span><span class="p">(:,:,</span><span class="n">nstepread</span><span class="o">+</span><span class="mi">1</span><span class="p">)</span>
<a name="ln-900"></a>      <span class="n">v0inletbc</span><span class="p">(:,:)</span> <span class="o">=</span> <span class="p">(</span><span class="mf">1.</span> <span class="o">-</span> <span class="n">deltat</span><span class="o">/</span><span class="n">interval</span><span class="p">)</span><span class="o">*</span><span class="n">v0inletbc</span><span class="p">(:,:)</span> <span class="o">+</span> <span class="p">(</span><span class="n">deltat</span><span class="o">/</span><span class="n">interval</span><span class="p">)</span><span class="o">*</span><span class="n">storev0inletbc</span><span class="p">(:,:,</span><span class="n">nstepread</span><span class="o">+</span><span class="mi">1</span><span class="p">)</span>
<a name="ln-901"></a>      <span class="n">w0inletbc</span><span class="p">(:,:)</span> <span class="o">=</span> <span class="p">(</span><span class="mf">1.</span> <span class="o">-</span> <span class="n">deltat</span><span class="o">/</span><span class="n">interval</span><span class="p">)</span><span class="o">*</span><span class="n">w0inletbc</span><span class="p">(:,:)</span> <span class="o">+</span> <span class="p">(</span><span class="n">deltat</span><span class="o">/</span><span class="n">interval</span><span class="p">)</span><span class="o">*</span><span class="n">storew0inletbc</span><span class="p">(:,:,</span><span class="n">nstepread</span><span class="o">+</span><span class="mi">1</span><span class="p">)</span>
<a name="ln-902"></a>      <span class="n">t0inletbc</span><span class="p">(:,:)</span> <span class="o">=</span> <span class="p">(</span><span class="mf">1.</span> <span class="o">-</span> <span class="n">deltat</span><span class="o">/</span><span class="n">interval</span><span class="p">)</span><span class="o">*</span><span class="n">t0inletbc</span><span class="p">(:,:)</span> <span class="o">+</span> <span class="p">(</span><span class="n">deltat</span><span class="o">/</span><span class="n">interval</span><span class="p">)</span><span class="o">*</span><span class="n">storet0inletbc</span><span class="p">(:,:,</span><span class="n">nstepread</span><span class="o">+</span><span class="mi">1</span><span class="p">)</span>
<a name="ln-903"></a>
<a name="ln-904"></a>
<a name="ln-905"></a>
<a name="ln-906"></a>
<a name="ln-907"></a><span class="c">!! massflow correction</span>
<a name="ln-908"></a>      <span class="n">uinletbc2</span><span class="p">(</span><span class="n">ib</span><span class="p">,</span><span class="n">jb</span><span class="p">:</span><span class="n">je</span><span class="p">,</span><span class="n">kb</span><span class="p">:</span><span class="n">ke</span><span class="p">)</span> <span class="o">=</span> <span class="n">u0inletbc</span><span class="p">(</span><span class="n">jb</span><span class="p">:</span><span class="n">je</span><span class="p">,</span><span class="n">kb</span><span class="p">:</span><span class="n">ke</span><span class="p">)</span>  <span class="c">! this is just a dummy variable to give uninletbc the right dimension in slabsum</span>
<a name="ln-909"></a>      <span class="n">urav</span> <span class="o">=</span> <span class="mf">0.</span>
<a name="ln-910"></a>      <span class="k">call </span><span class="n">slabsum</span><span class="p">(</span><span class="n">urav</span>  <span class="p">,</span><span class="n">kb</span><span class="p">,</span><span class="n">ke</span><span class="p">,</span><span class="n">uinletbc2</span> <span class="p">,</span><span class="n">ib</span><span class="p">,</span><span class="n">ib</span><span class="p">,</span><span class="n">jb</span><span class="p">,</span><span class="n">je</span><span class="p">,</span><span class="n">kb</span><span class="p">,</span><span class="n">ke</span><span class="p">,</span><span class="n">ib</span><span class="p">,</span><span class="n">ib</span><span class="p">,</span><span class="n">jb</span><span class="p">,</span><span class="n">je</span><span class="p">,</span><span class="n">kb</span><span class="p">,</span><span class="n">ke</span><span class="p">)</span>
<a name="ln-911"></a>      <span class="n">urav</span> <span class="o">=</span> <span class="n">urav</span> <span class="o">/</span> <span class="p">(</span><span class="n">jge</span><span class="o">-</span><span class="n">jgb</span> <span class="o">+</span><span class="mi">1</span><span class="p">)</span>                    <span class="c">! average over j-direction</span>
<a name="ln-912"></a>
<a name="ln-913"></a>   <span class="c">! determine bulk velocity of new (interpolated) profile</span>
<a name="ln-914"></a>      <span class="k">do </span><span class="n">k</span><span class="o">=</span><span class="n">kb</span><span class="p">,</span><span class="n">ke</span>
<a name="ln-915"></a>        <span class="n">uravdzf</span><span class="p">(</span><span class="n">k</span><span class="p">)</span> <span class="o">=</span> <span class="n">urav</span><span class="p">(</span><span class="n">k</span><span class="p">)</span><span class="o">*</span><span class="n">dzf</span><span class="p">(</span><span class="n">k</span><span class="p">)</span>
<a name="ln-916"></a>      <span class="k">end do</span>
<a name="ln-917"></a><span class="k">      </span><span class="n">totalu</span>    <span class="o">=</span> <span class="nb">sum</span><span class="p">(</span><span class="n">uravdzf</span><span class="p">(</span><span class="n">kb</span><span class="p">:</span><span class="n">ke</span><span class="p">))</span><span class="o">/</span><span class="p">(</span><span class="n">zh</span><span class="p">(</span><span class="n">ke</span><span class="o">+</span><span class="mi">1</span><span class="p">)</span><span class="o">-</span><span class="n">zh</span><span class="p">(</span><span class="n">kb</span><span class="p">))</span>      <span class="c">! Area-averaged outflow velocity</span>
<a name="ln-918"></a>
<a name="ln-919"></a>   <span class="c">! rescale the instantaneous profile to keep mass flux constant (tot avoid pressure fluctuations)</span>
<a name="ln-920"></a>      <span class="n">scalef</span> <span class="o">=</span> <span class="n">totalreadu</span><span class="o">/</span><span class="n">totalu</span> <span class="c">! compute factor to scale the velocity profile with</span>
<a name="ln-921"></a>      <span class="n">u0inletbc</span><span class="p">(:,:)</span> <span class="o">=</span> <span class="n">u0inletbc</span><span class="p">(:,:)</span><span class="o">*</span><span class="n">scalef</span>  <span class="c">! rescale the velocity profile to have constant mass-flux</span>
<a name="ln-922"></a><span class="c">!! end of massflow correction of interpolated streamwise velocity </span>
<a name="ln-923"></a>
<a name="ln-924"></a>      <span class="k">if</span> <span class="p">(</span><span class="n">rk3step</span><span class="o">==</span><span class="mi">1</span><span class="p">)</span> <span class="k">then</span>
<a name="ln-925"></a><span class="k">        </span><span class="n">uminletbc</span> <span class="o">=</span> <span class="n">u0inletbc</span>
<a name="ln-926"></a>        <span class="n">vminletbc</span> <span class="o">=</span> <span class="n">v0inletbc</span>
<a name="ln-927"></a>        <span class="n">wminletbc</span> <span class="o">=</span> <span class="n">w0inletbc</span>
<a name="ln-928"></a>        <span class="n">tminletbc</span> <span class="o">=</span> <span class="n">t0inletbc</span>
<a name="ln-929"></a>      <span class="k">end if</span>
<a name="ln-930"></a><span class="k">    end if</span>  <span class="c">! iinletgen</span>
<a name="ln-931"></a>
<a name="ln-932"></a>  <span class="k">end subroutine </span><span class="n">inletgen</span>
<a name="ln-933"></a> 
<a name="ln-934"></a>  <span class="k">subroutine </span><span class="n">inletgennotemp</span>
<a name="ln-935"></a>    <span class="k">use </span><span class="n">modglobal</span><span class="p">,</span>   <span class="n">only</span> <span class="p">:</span> <span class="n">ib</span><span class="p">,</span><span class="n">ie</span><span class="p">,</span><span class="n">jb</span><span class="p">,</span><span class="n">je</span><span class="p">,</span><span class="n">jgb</span><span class="p">,</span><span class="n">jge</span><span class="p">,</span><span class="n">kb</span><span class="p">,</span><span class="n">ke</span><span class="p">,</span><span class="n">zf</span><span class="p">,</span><span class="n">zh</span><span class="p">,</span><span class="n">dzf</span><span class="p">,</span><span class="n">dzhi</span><span class="p">,</span><span class="n">timee</span><span class="p">,</span><span class="n">btime</span><span class="p">,</span><span class="n">totavtime</span><span class="p">,</span><span class="n">rk3step</span><span class="p">,</span><span class="n">dt</span><span class="p">,</span><span class="n">numol</span><span class="p">,</span><span class="n">iplane</span><span class="p">,</span><span class="n">lles</span><span class="p">,</span><span class="n">iinletgen</span><span class="p">,</span><span class="n">inletav</span><span class="p">,</span><span class="n">runavtime</span><span class="p">,</span><span class="n">Uinf</span><span class="p">,</span><span class="n">lwallfunc</span><span class="p">,</span><span class="n">linletRA</span><span class="p">,</span><span class="n">totinletav</span><span class="p">,</span><span class="n">lstoreplane</span><span class="p">,</span><span class="n">nstore</span><span class="p">,</span><span class="n">lfixinlet</span><span class="p">,</span><span class="n">lfixutauin</span><span class="p">,</span><span class="n">luvolflowr</span>
<a name="ln-936"></a>    <span class="k">use </span><span class="n">modfields</span><span class="p">,</span>   <span class="n">only</span> <span class="p">:</span> <span class="n">u0</span><span class="p">,</span><span class="n">v0</span><span class="p">,</span><span class="n">w0</span><span class="p">,</span><span class="n">wm</span><span class="p">,</span><span class="n">uprof</span>
<a name="ln-937"></a>    <span class="k">use </span><span class="n">modsave</span><span class="p">,</span>     <span class="n">only</span> <span class="p">:</span> <span class="n">writerestartfiles</span>
<a name="ln-938"></a>    <span class="k">use </span><span class="n">modmpi</span><span class="p">,</span>      <span class="n">only</span> <span class="p">:</span> <span class="n">slabsum</span><span class="p">,</span><span class="n">myid</span>
<a name="ln-939"></a>    <span class="k">implicit none</span>
<a name="ln-940"></a><span class="k">   </span>
<a name="ln-941"></a><span class="k">    </span><span class="kt">real</span><span class="p">,</span><span class="k">dimension</span><span class="p">(</span><span class="n">ib</span><span class="p">:</span><span class="n">ib</span><span class="p">,</span><span class="n">jb</span><span class="p">:</span><span class="n">je</span><span class="p">,</span><span class="n">kb</span><span class="p">:</span><span class="n">ke</span><span class="p">)</span>   <span class="kd">::</span> <span class="n">uinletbc2</span>   <span class="c">! dummy variable</span>
<a name="ln-942"></a>    <span class="kt">real</span><span class="p">,</span><span class="k">dimension</span><span class="p">(</span><span class="n">jb</span><span class="p">:</span><span class="n">je</span><span class="p">,</span><span class="n">kb</span><span class="p">:</span><span class="n">ke</span><span class="p">)</span>   <span class="kd">::</span> <span class="n">uprec</span>             <span class="c">! velocity fluctuation (up_rec = u0 - Urec)</span>
<a name="ln-943"></a>    <span class="kt">real</span><span class="p">,</span><span class="k">dimension</span><span class="p">(</span><span class="n">jb</span><span class="p">:</span><span class="n">je</span><span class="p">,</span><span class="n">kb</span><span class="p">:</span><span class="n">ke</span><span class="p">)</span>   <span class="kd">::</span> <span class="n">vprec</span>             <span class="c">! velocity fluctuation (vp_rec = v0 - 0)</span>
<a name="ln-944"></a>    <span class="kt">real</span><span class="p">,</span><span class="k">dimension</span><span class="p">(</span><span class="n">jb</span><span class="p">:</span><span class="n">je</span><span class="p">,</span><span class="n">kb</span><span class="p">:</span><span class="n">ke</span><span class="o">+</span><span class="mi">1</span><span class="p">)</span> <span class="kd">::</span> <span class="n">wprec</span>             <span class="c">! velocity fluctuation (wp_rec = w0 - Wrec)</span>
<a name="ln-945"></a>    <span class="kt">real</span><span class="p">,</span><span class="k">dimension</span><span class="p">(</span><span class="n">jb</span><span class="p">:</span><span class="n">je</span><span class="p">,</span><span class="n">kb</span><span class="p">:</span><span class="n">ke</span><span class="p">)</span>   <span class="kd">::</span> <span class="n">upinli</span><span class="p">,</span><span class="n">vpinli</span>     <span class="c">! = gamma * (uprec,v interpolated to zii grid)</span>
<a name="ln-946"></a>    <span class="kt">real</span><span class="p">,</span><span class="k">dimension</span><span class="p">(</span><span class="n">jb</span><span class="p">:</span><span class="n">je</span><span class="p">,</span><span class="n">kb</span><span class="p">:</span><span class="n">ke</span><span class="p">)</span>   <span class="kd">::</span> <span class="n">upinlo</span><span class="p">,</span><span class="n">vpinlo</span>     <span class="c">! = gamma * (uprec,v interpolated to zoi grid)</span>
<a name="ln-947"></a>    <span class="kt">real</span><span class="p">,</span><span class="k">dimension</span><span class="p">(</span><span class="n">jb</span><span class="p">:</span><span class="n">je</span><span class="p">,</span><span class="n">kb</span><span class="p">:</span><span class="n">ke</span><span class="o">+</span><span class="mi">1</span><span class="p">)</span> <span class="kd">::</span> <span class="n">wpinli</span>            <span class="c">! = gamma * (wprec   interpolated to zii grid)</span>
<a name="ln-948"></a>    <span class="kt">real</span><span class="p">,</span><span class="k">dimension</span><span class="p">(</span><span class="n">jb</span><span class="p">:</span><span class="n">je</span><span class="p">,</span><span class="n">kb</span><span class="p">:</span><span class="n">ke</span><span class="o">+</span><span class="mi">1</span><span class="p">)</span> <span class="kd">::</span> <span class="n">wpinlo</span>            <span class="c">! = gamma * (wprec   interpolated to zoi grid)</span>
<a name="ln-949"></a>    <span class="kt">real</span><span class="p">,</span><span class="k">dimension</span><span class="p">(</span><span class="n">kb</span><span class="p">:</span><span class="n">ke</span><span class="p">)</span>   <span class="kd">::</span> <span class="n">udiff</span>                   <span class="c">! difference between Uinl and Urec</span>
<a name="ln-950"></a><span class="c">!    real,dimension(kb:ke)   :: Urecdiff                ! difference between Urec new and old</span>
<a name="ln-951"></a>    <span class="kt">real</span><span class="p">,</span><span class="k">dimension</span><span class="p">(</span><span class="n">kb</span><span class="p">:</span><span class="n">ke</span><span class="p">)</span>   <span class="kd">::</span> <span class="n">urav</span>                    <span class="c">! j-averaged u-velocity (not time-averaged) </span>
<a name="ln-952"></a>    <span class="kt">real</span><span class="p">,</span><span class="k">dimension</span><span class="p">(</span><span class="n">kb</span><span class="p">:</span><span class="n">ke</span><span class="p">)</span>   <span class="kd">::</span> <span class="n">uravdzf</span>                 <span class="c">! j-averaged u-velocity (not time-averaged) times dzf</span>
<a name="ln-953"></a>    <span class="kt">real</span><span class="p">,</span><span class="k">dimension</span><span class="p">(</span><span class="n">kb</span><span class="p">:</span><span class="n">ke</span><span class="p">)</span>   <span class="kd">::</span> <span class="n">uinldzf</span>                 <span class="c">! j-averaged u-velocity (not time-averaged) times dzf</span>
<a name="ln-954"></a>    <span class="kt">real</span><span class="p">,</span><span class="k">dimension</span><span class="p">(</span><span class="n">kb</span><span class="p">:</span><span class="n">ke</span><span class="p">)</span>   <span class="kd">::</span> <span class="n">Urecdzf</span>                 <span class="c">! Urec times dzf</span>
<a name="ln-955"></a>    <span class="kt">real</span><span class="p">,</span><span class="k">dimension</span><span class="p">(</span><span class="n">kb</span><span class="p">:</span><span class="n">ke</span><span class="o">+</span><span class="mi">1</span><span class="p">)</span> <span class="kd">::</span> <span class="n">wrav</span>                    <span class="c">! j-averaged w-velocity (not time-averaged) </span>
<a name="ln-956"></a>    <span class="kt">real</span><span class="p">,</span><span class="k">dimension</span><span class="p">(</span><span class="n">kb</span><span class="p">:</span><span class="n">ke</span><span class="p">)</span>   <span class="kd">::</span> <span class="n">Uinli</span>                   <span class="c">! = gamma * (Urec interpolated to ziif grid points)</span>
<a name="ln-957"></a>    <span class="kt">real</span><span class="p">,</span><span class="k">dimension</span><span class="p">(</span><span class="n">kb</span><span class="p">:</span><span class="n">ke</span><span class="o">+</span><span class="mi">1</span><span class="p">)</span> <span class="kd">::</span> <span class="n">Winli</span>                   <span class="c">! = gamma * (Wrec interpolated to ziih grid points)</span>
<a name="ln-958"></a>    <span class="kt">real</span><span class="p">,</span><span class="k">dimension</span><span class="p">(</span><span class="n">kb</span><span class="p">:</span><span class="n">ke</span><span class="p">)</span>   <span class="kd">::</span> <span class="n">Uinlo</span>                   <span class="c">! = gamma * (Urec interpolated to zioif grid points)</span>
<a name="ln-959"></a>    <span class="kt">real</span><span class="p">,</span><span class="k">dimension</span><span class="p">(</span><span class="n">kb</span><span class="p">:</span><span class="n">ke</span><span class="o">+</span><span class="mi">1</span><span class="p">)</span> <span class="kd">::</span> <span class="n">Winlo</span>                   <span class="c">! = gamma * (Wrec interpolated to zoih grid points)</span>
<a name="ln-960"></a>    <span class="kt">real</span><span class="p">,</span><span class="k">dimension</span><span class="p">(</span><span class="n">kb</span><span class="p">:</span><span class="n">ke</span><span class="p">)</span>   <span class="kd">::</span> <span class="n">wfuncf</span>                  <span class="c">! weight function at full level</span>
<a name="ln-961"></a>    <span class="kt">real</span><span class="p">,</span><span class="k">dimension</span><span class="p">(</span><span class="n">kb</span><span class="p">:</span><span class="n">ke</span><span class="o">+</span><span class="mi">1</span><span class="p">)</span> <span class="kd">::</span> <span class="n">wfunch</span>                  <span class="c">! weight function at half level</span>
<a name="ln-962"></a>    <span class="kt">real</span>                    <span class="kd">::</span> <span class="n">utaur2</span><span class="p">,</span><span class="n">utaui2</span>           <span class="c">! (utau)^2 at recycle station and inlet</span>
<a name="ln-963"></a>    <span class="kt">real</span>                    <span class="kd">::</span> <span class="n">gamm</span>                    <span class="c">! utaui / utaur</span>
<a name="ln-964"></a>    <span class="kt">real</span>                    <span class="kd">::</span> <span class="n">avint</span><span class="p">,</span><span class="n">avinti</span>            <span class="c">! avering interval</span>
<a name="ln-965"></a>    <span class="kt">real</span>                    <span class="kd">::</span> <span class="n">alpha</span><span class="p">,</span><span class="n">beta</span>              <span class="c">! factors used in the Weight function</span>
<a name="ln-966"></a><span class="c">!    real                    :: totalu                  ! total u-velocity at outlet</span>
<a name="ln-967"></a>    <span class="kt">real</span>                    <span class="kd">::</span> <span class="n">Urectot</span>                  <span class="c">! total u-velocity at recycle plane</span>
<a name="ln-968"></a>    <span class="kt">real</span>                    <span class="kd">::</span> <span class="n">rk3coef</span>
<a name="ln-969"></a><span class="c">!    real                    :: di_test                 ! BL thickness as measured from Uinl</span>
<a name="ln-970"></a>    <span class="kt">real</span>                    <span class="kd">::</span> <span class="n">utop</span>                    <span class="c">! j-averaged top velocity</span>
<a name="ln-971"></a>    <span class="kt">real</span>                    <span class="kd">::</span> <span class="n">interval</span>
<a name="ln-972"></a>    <span class="kt">real</span>                    <span class="kd">::</span> <span class="n">dtinrk</span>                  <span class="c">! RK time step in inlet data</span>
<a name="ln-973"></a>    <span class="kt">real</span>                    <span class="kd">::</span> <span class="n">rk3coefin</span>               <span class="c">! Cumulative RK time step in inlet data</span>
<a name="ln-974"></a>    <span class="kt">real</span>                    <span class="kd">::</span> <span class="n">dr_old</span>
<a name="ln-975"></a>    <span class="kt">real</span>                    <span class="kd">::</span> <span class="n">scalef</span>                      <span class="c">! scale factor to scale instantaneous velocity profile with to get constant mass flux</span>
<a name="ln-976"></a>    <span class="kt">real</span>                    <span class="kd">::</span> <span class="n">totaluinl</span>                   <span class="c">! bulk velocity at the inlet</span>
<a name="ln-977"></a>    <span class="kt">integer </span><span class="n">i</span><span class="p">,</span><span class="n">j</span><span class="p">,</span><span class="n">k</span><span class="p">,</span><span class="n">kk</span>
<a name="ln-978"></a>
<a name="ln-979"></a>   <span class="k">if</span> <span class="p">(</span><span class="n">iinletgen</span> <span class="o">==</span> <span class="mi">1</span><span class="p">)</span> <span class="k">then</span>
<a name="ln-980"></a>
<a name="ln-981"></a><span class="k">   </span><span class="n">u0inletbcold</span> <span class="o">=</span> <span class="n">u0inletbc</span>
<a name="ln-982"></a>   <span class="n">v0inletbcold</span> <span class="o">=</span> <span class="n">v0inletbc</span>
<a name="ln-983"></a>   <span class="n">w0inletbcold</span> <span class="o">=</span> <span class="n">w0inletbc</span>
<a name="ln-984"></a>   <span class="n">totaluold</span>    <span class="o">=</span> <span class="n">totalu</span>
<a name="ln-985"></a>   <span class="n">displold</span>     <span class="o">=</span> <span class="n">displ</span>
<a name="ln-986"></a>   <span class="n">ddispdxold</span>   <span class="o">=</span> <span class="n">ddispdx</span>
<a name="ln-987"></a>
<a name="ln-988"></a>   <span class="c">! compute time-average velocities</span>
<a name="ln-989"></a>    <span class="n">rk3coef</span> <span class="o">=</span> <span class="n">dt</span> <span class="o">/</span> <span class="p">(</span><span class="mf">4.</span> <span class="o">-</span> <span class="nb">dble</span><span class="p">(</span><span class="n">rk3step</span><span class="p">))</span>
<a name="ln-990"></a>    <span class="k">if</span> <span class="p">(</span><span class="n">rk3step</span><span class="o">==</span><span class="mi">1</span><span class="p">)</span> <span class="k">then</span>
<a name="ln-991"></a><span class="k">      </span><span class="n">deltat</span> <span class="o">=</span> <span class="n">rk3coef</span>
<a name="ln-992"></a>    <span class="n">elseif</span> <span class="p">(</span><span class="n">rk3step</span><span class="o">==</span><span class="mi">2</span><span class="p">)</span> <span class="k">then</span>
<a name="ln-993"></a><span class="k">      </span><span class="n">deltat</span> <span class="o">=</span> <span class="n">rk3coef</span> <span class="o">-</span> <span class="p">(</span><span class="n">dt</span><span class="o">/</span><span class="mf">3.</span><span class="p">)</span>
<a name="ln-994"></a>    <span class="n">elseif</span> <span class="p">(</span><span class="n">rk3step</span><span class="o">==</span><span class="mi">3</span><span class="p">)</span> <span class="k">then</span>
<a name="ln-995"></a><span class="k">      </span><span class="n">deltat</span> <span class="o">=</span> <span class="n">rk3coef</span> <span class="o">-</span> <span class="p">(</span><span class="n">dt</span><span class="o">/</span><span class="mf">2.</span><span class="p">)</span>
<a name="ln-996"></a>    <span class="k">end if</span>
<a name="ln-997"></a>
<a name="ln-998"></a><span class="k">    if</span> <span class="p">(</span><span class="n">linletRA</span><span class="p">)</span> <span class="k">then</span>  <span class="c">! this is a switch to use &#39;running average&#39;</span>
<a name="ln-999"></a>      <span class="n">avint</span> <span class="o">=</span> <span class="n">totinletav</span> <span class="o">+</span> <span class="n">timee</span><span class="o">-</span><span class="n">btime</span> <span class="c">! runav interval = averaging interval previuous sim  + current elapsed sim time</span>
<a name="ln-1000"></a>    <span class="k">else</span>
<a name="ln-1001"></a><span class="k">      </span><span class="n">avint</span>  <span class="o">=</span> <span class="n">inletav</span>
<a name="ln-1002"></a>    <span class="k">end if</span>
<a name="ln-1003"></a><span class="k">    </span><span class="n">avinti</span> <span class="o">=</span> <span class="mf">1.</span><span class="o">/</span><span class="n">avint</span>
<a name="ln-1004"></a>    <span class="n">uaver</span><span class="o">=</span><span class="mf">0.</span> 
<a name="ln-1005"></a>    <span class="k">do </span><span class="n">i</span><span class="o">=</span><span class="n">ib</span><span class="p">,</span><span class="n">ie</span>
<a name="ln-1006"></a>      <span class="k">call </span><span class="n">slabsum</span><span class="p">(</span><span class="n">uaver</span><span class="p">(</span><span class="n">i</span><span class="p">,:),</span><span class="n">kb</span><span class="p">,</span><span class="n">ke</span><span class="p">,</span><span class="n">u0</span><span class="p">(</span><span class="n">i</span><span class="p">:</span><span class="n">i</span><span class="p">,</span><span class="n">jb</span><span class="p">:</span><span class="n">je</span><span class="p">,</span><span class="n">kb</span><span class="p">:</span><span class="n">ke</span><span class="p">),</span><span class="n">i</span><span class="p">,</span><span class="n">i</span><span class="p">,</span><span class="n">jb</span><span class="p">,</span><span class="n">je</span><span class="p">,</span><span class="n">kb</span><span class="p">,</span><span class="n">ke</span><span class="p">,</span><span class="n">i</span><span class="p">,</span><span class="n">i</span><span class="p">,</span><span class="n">jb</span><span class="p">,</span><span class="n">je</span><span class="p">,</span><span class="n">kb</span><span class="p">,</span><span class="n">ke</span><span class="p">)</span>
<a name="ln-1007"></a>    <span class="k">end do</span>
<a name="ln-1008"></a>
<a name="ln-1009"></a><span class="k">    </span><span class="n">wrav</span><span class="o">=</span><span class="mf">0.</span>
<a name="ln-1010"></a>    <span class="k">call </span><span class="n">slabsum</span><span class="p">(</span><span class="n">wrav</span><span class="p">(</span><span class="n">kb</span><span class="p">:</span><span class="n">ke</span><span class="o">+</span><span class="mi">1</span><span class="p">),</span><span class="n">kb</span><span class="p">,</span><span class="n">ke</span><span class="p">,</span><span class="n">w0</span><span class="p">(</span><span class="n">irecy</span><span class="o">-</span><span class="mi">1</span><span class="p">:</span><span class="n">irecy</span><span class="o">-</span><span class="mi">1</span><span class="p">,</span><span class="n">jb</span><span class="p">:</span><span class="n">je</span><span class="p">,</span><span class="n">kb</span><span class="p">:</span><span class="n">ke</span><span class="o">+</span><span class="mi">1</span><span class="p">),</span><span class="n">irecy</span><span class="o">-</span><span class="mi">1</span><span class="p">,</span><span class="n">irecy</span><span class="o">-</span><span class="mi">1</span><span class="p">,</span><span class="n">jb</span><span class="p">,</span><span class="n">je</span><span class="p">,</span><span class="n">kb</span><span class="p">,</span><span class="n">ke</span><span class="o">+</span><span class="mi">1</span><span class="p">,</span><span class="n">irecy</span><span class="o">-</span><span class="mi">1</span><span class="p">,</span><span class="n">irecy</span><span class="o">-</span><span class="mi">1</span><span class="p">,</span><span class="n">jb</span><span class="p">,</span><span class="n">je</span><span class="p">,</span><span class="n">kb</span><span class="p">,</span><span class="n">ke</span><span class="o">+</span><span class="mi">1</span><span class="p">)</span>
<a name="ln-1011"></a>
<a name="ln-1012"></a>    <span class="n">uaver</span> <span class="o">=</span> <span class="n">uaver</span> <span class="o">/</span> <span class="p">(</span><span class="n">jge</span><span class="o">-</span><span class="n">jgb</span> <span class="o">+</span><span class="mi">1</span><span class="p">)</span>                    <span class="c">! average over j-direction</span>
<a name="ln-1013"></a>    <span class="n">urav</span> <span class="o">=</span> <span class="n">uaver</span><span class="p">(</span><span class="n">irecy</span><span class="p">,:)</span>
<a name="ln-1014"></a>    <span class="n">wrav</span> <span class="o">=</span> <span class="n">wrav</span> <span class="o">/</span> <span class="p">(</span><span class="n">jge</span><span class="o">-</span><span class="n">jgb</span> <span class="o">+</span><span class="mi">1</span><span class="p">)</span>                    <span class="c">! average over j-direction</span>
<a name="ln-1015"></a>
<a name="ln-1016"></a>    <span class="k">do </span><span class="n">k</span><span class="o">=</span><span class="n">kb</span><span class="p">,</span><span class="n">ke</span>
<a name="ln-1017"></a>      <span class="n">Urec</span><span class="p">(</span><span class="n">k</span><span class="p">)</span> <span class="o">=</span>  <span class="n">urav</span><span class="p">(</span><span class="n">k</span><span class="p">)</span><span class="o">*</span><span class="n">deltat</span><span class="o">*</span><span class="n">avinti</span> <span class="o">+</span> <span class="p">(</span><span class="mf">1.</span><span class="o">-</span><span class="n">deltat</span><span class="o">*</span><span class="n">avinti</span><span class="p">)</span><span class="o">*</span><span class="n">Urec</span><span class="p">(</span><span class="n">k</span><span class="p">)</span>
<a name="ln-1018"></a>    <span class="k">end do</span>
<a name="ln-1019"></a><span class="k">    do </span><span class="n">k</span><span class="o">=</span><span class="n">kb</span><span class="p">,</span><span class="n">ke</span><span class="o">+</span><span class="mi">1</span>
<a name="ln-1020"></a>      <span class="n">Wrec</span><span class="p">(</span><span class="n">k</span><span class="p">)</span> <span class="o">=</span>  <span class="n">wrav</span><span class="p">(</span><span class="n">k</span><span class="p">)</span><span class="o">*</span><span class="n">deltat</span><span class="o">*</span><span class="n">avinti</span> <span class="o">+</span> <span class="p">(</span><span class="mf">1.</span><span class="o">-</span><span class="n">deltat</span><span class="o">*</span><span class="n">avinti</span><span class="p">)</span><span class="o">*</span><span class="n">Wrec</span><span class="p">(</span><span class="n">k</span><span class="p">)</span>
<a name="ln-1021"></a>    <span class="k">end do</span>
<a name="ln-1022"></a><span class="k">    do </span><span class="n">k</span><span class="o">=</span><span class="n">kb</span><span class="p">,</span><span class="n">ke</span>
<a name="ln-1023"></a>    <span class="k">do </span><span class="n">i</span><span class="o">=</span><span class="n">ib</span><span class="p">,</span><span class="n">ie</span>
<a name="ln-1024"></a>      <span class="n">Utav</span><span class="p">(</span><span class="n">i</span><span class="p">,</span><span class="n">k</span><span class="p">)</span> <span class="o">=</span>  <span class="n">uaver</span><span class="p">(</span><span class="n">i</span><span class="p">,</span><span class="n">k</span><span class="p">)</span><span class="o">*</span><span class="n">deltat</span><span class="o">*</span><span class="n">avinti</span> <span class="o">+</span> <span class="p">(</span><span class="mf">1.</span><span class="o">-</span><span class="n">deltat</span><span class="o">*</span><span class="n">avinti</span><span class="p">)</span><span class="o">*</span><span class="n">Utav</span><span class="p">(</span><span class="n">i</span><span class="p">,</span><span class="n">k</span><span class="p">)</span>
<a name="ln-1025"></a>    <span class="k">end do</span>
<a name="ln-1026"></a><span class="k">    end do</span>
<a name="ln-1027"></a>   
<a name="ln-1028"></a>
<a name="ln-1029"></a>
<a name="ln-1030"></a>   <span class="c">! compute velocity fluctuation at recycle station</span>
<a name="ln-1031"></a>    <span class="k">do </span><span class="n">k</span><span class="o">=</span><span class="n">kb</span><span class="p">,</span><span class="n">ke</span>
<a name="ln-1032"></a>      <span class="k">do </span><span class="n">j</span><span class="o">=</span><span class="n">jb</span><span class="p">,</span><span class="n">je</span>
<a name="ln-1033"></a>        <span class="n">uprec</span><span class="p">(</span><span class="n">j</span><span class="p">,</span><span class="n">k</span><span class="p">)</span> <span class="o">=</span> <span class="n">u0</span><span class="p">(</span><span class="n">irecy</span><span class="p">,</span><span class="n">j</span><span class="p">,</span><span class="n">k</span><span class="p">)</span> <span class="o">-</span> <span class="n">Urec</span><span class="p">(</span><span class="n">k</span><span class="p">)</span>
<a name="ln-1034"></a>        <span class="n">vprec</span><span class="p">(</span><span class="n">j</span><span class="p">,</span><span class="n">k</span><span class="p">)</span> <span class="o">=</span> <span class="n">v0</span><span class="p">(</span><span class="n">irecy</span><span class="o">-</span><span class="mi">1</span><span class="p">,</span><span class="n">j</span><span class="p">,</span><span class="n">k</span><span class="p">)</span>             <span class="c">! mean v is zero</span>
<a name="ln-1035"></a>      <span class="k">end do</span>
<a name="ln-1036"></a><span class="k">    end do</span>
<a name="ln-1037"></a>
<a name="ln-1038"></a><span class="k">    do </span><span class="n">k</span><span class="o">=</span><span class="n">kb</span><span class="p">,</span><span class="n">ke</span><span class="o">+</span><span class="mi">1</span>
<a name="ln-1039"></a>      <span class="k">do </span><span class="n">j</span><span class="o">=</span><span class="n">jb</span><span class="p">,</span><span class="n">je</span>
<a name="ln-1040"></a>        <span class="n">wprec</span><span class="p">(</span><span class="n">j</span><span class="p">,</span><span class="n">k</span><span class="p">)</span> <span class="o">=</span> <span class="n">w0</span><span class="p">(</span><span class="n">irecy</span><span class="o">-</span><span class="mi">1</span><span class="p">,</span><span class="n">j</span><span class="p">,</span><span class="n">k</span><span class="p">)</span> <span class="o">-</span> <span class="n">Wrec</span><span class="p">(</span><span class="n">k</span><span class="p">)</span>   <span class="c">! note that w-velocity is taken at i=irecy-1 !!</span>
<a name="ln-1041"></a>      <span class="k">end do</span>
<a name="ln-1042"></a><span class="k">    end do</span>
<a name="ln-1043"></a>
<a name="ln-1044"></a><span class="k"> </span>
<a name="ln-1045"></a><span class="k">    if</span> <span class="p">(</span><span class="n">lwallfunc</span><span class="p">)</span> <span class="k">then</span>
<a name="ln-1046"></a><span class="k">      call </span><span class="n">wallawinlet</span><span class="p">(</span><span class="n">Urec</span><span class="p">(</span><span class="n">kb</span><span class="p">),</span><span class="n">dzf</span><span class="p">(</span><span class="n">kb</span><span class="p">),</span><span class="n">numol</span><span class="p">,</span><span class="n">utaur2</span><span class="p">)</span>    <span class="c">! compute wall shear stress at recycle station</span>
<a name="ln-1047"></a>    <span class="k">else</span>
<a name="ln-1048"></a><span class="k">      </span><span class="n">utaur2</span> <span class="o">=</span> <span class="mf">2.</span><span class="o">*</span><span class="n">numol</span><span class="o">*</span><span class="n">Urec</span><span class="p">(</span><span class="n">kb</span><span class="p">)</span><span class="o">/</span><span class="n">dzf</span><span class="p">(</span><span class="n">kb</span><span class="p">)</span>
<a name="ln-1049"></a>    <span class="k">end if</span>
<a name="ln-1050"></a><span class="k">    </span><span class="n">utaur</span> <span class="o">=</span> <span class="nb">sqrt</span><span class="p">(</span><span class="nb">abs</span><span class="p">(</span><span class="n">utaur2</span><span class="p">))</span>                          <span class="c">! compute utau at recycle station</span>
<a name="ln-1051"></a>   <span class="c">! compute momentum thickness at inlet and recycle plane</span>
<a name="ln-1052"></a>   
<a name="ln-1053"></a>   <span class="n">dr_old</span> <span class="o">=</span> <span class="n">dr</span>
<a name="ln-1054"></a><span class="c">!   call blthickness(dr,utaur)                     ! also needed for thetar</span>
<a name="ln-1055"></a>   <span class="k">call </span><span class="n">blthicknesst</span><span class="p">(</span><span class="n">dr</span><span class="p">,</span><span class="n">Urec</span><span class="p">,</span><span class="mf">0.99</span><span class="p">)</span>                 
<a name="ln-1056"></a><span class="c">!   call momentumthickness(thetai,utaui,di)        ! di is kept fixed</span>
<a name="ln-1057"></a>   <span class="k">call </span><span class="n">momentumthicknessexp</span><span class="p">(</span><span class="n">thetai</span><span class="p">,</span><span class="n">Uinl</span><span class="p">)</span>       
<a name="ln-1058"></a><span class="c">!   call momentumthickness(thetar,utaur,dr)</span>
<a name="ln-1059"></a>   <span class="k">call </span><span class="n">momentumthicknessexp</span><span class="p">(</span><span class="n">thetar</span><span class="p">,</span><span class="n">Urec</span><span class="p">)</span>       
<a name="ln-1060"></a><span class="c">!   call blthickness(dr,utaur)</span>
<a name="ln-1061"></a>  
<a name="ln-1062"></a>    <span class="k">if</span> <span class="p">(.</span><span class="nb">not</span><span class="p">.</span><span class="n">lfixutauin</span><span class="p">)</span> <span class="k">then </span>
<a name="ln-1063"></a><span class="k">      </span><span class="n">utaui</span>  <span class="o">=</span> <span class="n">utaur</span><span class="o">*</span> <span class="nb">abs</span><span class="p">(</span><span class="n">thetar</span><span class="o">/</span><span class="n">thetai</span><span class="p">)</span><span class="o">**</span><span class="p">(</span><span class="mf">1.</span><span class="o">/</span><span class="mf">8.</span><span class="p">)</span>   <span class="c">! See Lund (1998): &#39;Similar to Ludwig-Tillmann correlation&#39;</span>
<a name="ln-1064"></a>    <span class="k">end if</span>
<a name="ln-1065"></a><span class="k">    </span><span class="n">gamm</span> <span class="o">=</span> <span class="n">utaui</span> <span class="o">/</span> <span class="n">utaur</span>                          <span class="c">! Gamma in Lund (1998)</span>
<a name="ln-1066"></a>
<a name="ln-1067"></a>   <span class="c">! compute inner scaling coordinates</span>
<a name="ln-1068"></a>    <span class="n">zirf</span> <span class="o">=</span> <span class="n">utaur</span><span class="o">*</span><span class="n">zf</span> <span class="o">/</span> <span class="n">numol</span>                       <span class="c">! inner scaling zf-coordinate at recycle station </span>
<a name="ln-1069"></a>    <span class="n">zirh</span> <span class="o">=</span> <span class="n">utaur</span><span class="o">*</span><span class="n">zh</span> <span class="o">/</span> <span class="n">numol</span>                       <span class="c">! inner scaling zh-coordinate at recycle station</span>
<a name="ln-1070"></a>    <span class="n">ziif</span> <span class="o">=</span> <span class="n">utaui</span><span class="o">*</span><span class="n">zf</span> <span class="o">/</span> <span class="n">numol</span>                       <span class="c">! inner scaling zf-coordinate at inlet station </span>
<a name="ln-1071"></a>    <span class="n">ziih</span> <span class="o">=</span> <span class="n">utaui</span><span class="o">*</span><span class="n">zh</span> <span class="o">/</span> <span class="n">numol</span>                       <span class="c">! inner scaling zh-coordinate at inlet station </span>
<a name="ln-1072"></a>  
<a name="ln-1073"></a>   <span class="c">! compute outer scaling coordinates   </span>
<a name="ln-1074"></a>    <span class="n">zorf</span> <span class="o">=</span> <span class="n">zf</span> <span class="o">/</span> <span class="n">dr</span>                                <span class="c">! outer scaling zf-coor as measured from Uinldinate at recycle station </span>
<a name="ln-1075"></a>    <span class="n">zorh</span> <span class="o">=</span> <span class="n">zh</span> <span class="o">/</span> <span class="n">dr</span>                                <span class="c">! outer scaling zh-coordinate at recycle station </span>
<a name="ln-1076"></a>    <span class="n">zoif</span> <span class="o">=</span> <span class="n">zf</span> <span class="o">/</span> <span class="n">di</span>                                <span class="c">! outer scaling zf-coordinate at inlet station  (could be done once, actually..) </span>
<a name="ln-1077"></a>    <span class="n">zoih</span> <span class="o">=</span> <span class="n">zh</span> <span class="o">/</span> <span class="n">di</span>                                <span class="c">! outer scaling zf-coordinate at inlet station  (could be done once, actually..)</span>
<a name="ln-1078"></a>
<a name="ln-1079"></a><span class="c">!!!!! Interpolation starts here</span>
<a name="ln-1080"></a>
<a name="ln-1081"></a> <span class="c">!!! First inner coordinates</span>
<a name="ln-1082"></a>   <span class="c">! determine which elements are needed when recycle velocity profile is interpolated on inlet plane</span>
<a name="ln-1083"></a>   <span class="c">! for u(,v)-components (zf)</span>
<a name="ln-1084"></a>    <span class="k">do </span><span class="n">k</span><span class="o">=</span><span class="n">kb</span><span class="p">,</span><span class="n">ke</span>
<a name="ln-1085"></a>      <span class="k">do </span><span class="n">kk</span><span class="o">=</span><span class="n">kb</span><span class="p">,</span><span class="n">ke</span>
<a name="ln-1086"></a>        <span class="k">if</span> <span class="p">(</span><span class="n">zirf</span><span class="p">(</span><span class="n">kk</span><span class="p">)</span> <span class="o">&gt;=</span> <span class="n">ziif</span><span class="p">(</span><span class="n">k</span><span class="p">))</span> <span class="k">then</span>
<a name="ln-1087"></a><span class="k">          </span><span class="n">locupif</span><span class="p">(</span><span class="n">k</span><span class="p">)</span>  <span class="o">=</span> <span class="n">kk</span>
<a name="ln-1088"></a>          <span class="n">loclowif</span><span class="p">(</span><span class="n">k</span><span class="p">)</span> <span class="o">=</span> <span class="n">kk</span><span class="o">-</span><span class="mi">1</span>
<a name="ln-1089"></a>          <span class="k">exit</span>
<a name="ln-1090"></a><span class="k">        </span><span class="n">elseif</span> <span class="p">(</span><span class="n">kk</span><span class="o">==</span><span class="n">ke</span><span class="p">)</span> <span class="k">then</span>
<a name="ln-1091"></a><span class="k">          </span><span class="n">locupif</span><span class="p">(</span><span class="n">k</span><span class="p">)</span>  <span class="o">=</span> <span class="n">ke</span><span class="o">+</span><span class="mi">1</span>            <span class="c">! this means extrapolation!</span>
<a name="ln-1092"></a>          <span class="n">loclowif</span><span class="p">(</span><span class="n">k</span><span class="p">)</span> <span class="o">=</span> <span class="n">ke</span><span class="o">-</span><span class="mi">1</span>            <span class="c">! waarom niet ke? of wordt dit niet gebruikt?</span>
<a name="ln-1093"></a>        <span class="k">end if</span>
<a name="ln-1094"></a><span class="k">      end do</span>
<a name="ln-1095"></a><span class="k">    end do</span>
<a name="ln-1096"></a>   <span class="c">! for w-components (zh)</span>
<a name="ln-1097"></a>    <span class="k">do </span><span class="n">k</span><span class="o">=</span><span class="n">kb</span><span class="p">,</span><span class="n">ke</span><span class="o">+</span><span class="mi">1</span>
<a name="ln-1098"></a>      <span class="k">do </span><span class="n">kk</span><span class="o">=</span><span class="n">kb</span><span class="p">,</span><span class="n">ke</span><span class="o">+</span><span class="mi">1</span>
<a name="ln-1099"></a>        <span class="k">if</span> <span class="p">(</span><span class="n">zirh</span><span class="p">(</span><span class="n">kk</span><span class="p">)</span> <span class="o">&gt;=</span> <span class="n">ziih</span><span class="p">(</span><span class="n">k</span><span class="p">))</span> <span class="k">then</span>
<a name="ln-1100"></a><span class="k">          </span><span class="n">locupih</span><span class="p">(</span><span class="n">k</span><span class="p">)</span>  <span class="o">=</span> <span class="n">kk</span>
<a name="ln-1101"></a>          <span class="n">loclowih</span><span class="p">(</span><span class="n">k</span><span class="p">)</span> <span class="o">=</span> <span class="n">kk</span><span class="o">-</span><span class="mi">1</span>
<a name="ln-1102"></a>          <span class="k">exit</span>
<a name="ln-1103"></a><span class="k">        </span><span class="n">elseif</span> <span class="p">(</span><span class="n">kk</span><span class="o">==</span><span class="n">ke</span><span class="o">+</span><span class="mi">1</span><span class="p">)</span> <span class="k">then</span>
<a name="ln-1104"></a><span class="k">          </span><span class="n">locupih</span><span class="p">(</span><span class="n">k</span><span class="p">)</span>  <span class="o">=</span> <span class="n">ke</span><span class="o">+</span><span class="mi">2</span>            <span class="c">! this means extrapolation!</span>
<a name="ln-1105"></a>          <span class="n">loclowih</span><span class="p">(</span><span class="n">k</span><span class="p">)</span> <span class="o">=</span> <span class="n">ke</span>
<a name="ln-1106"></a>        <span class="k">end if</span>
<a name="ln-1107"></a><span class="k">      end do</span>
<a name="ln-1108"></a><span class="k">    end do</span>
<a name="ln-1109"></a> <span class="c">!!! Finished with inner coordinates</span>
<a name="ln-1110"></a>
<a name="ln-1111"></a> <span class="c">!!! Do the same trick for outer coordinates</span>
<a name="ln-1112"></a>   <span class="c">! determine which elements are needed when recycle velocity profile is interpolated on inlet plane</span>
<a name="ln-1113"></a>   <span class="c">! for u(,v)-components (zf)</span>
<a name="ln-1114"></a>    <span class="k">do </span><span class="n">k</span><span class="o">=</span><span class="n">kb</span><span class="p">,</span><span class="n">ke</span>
<a name="ln-1115"></a>      <span class="k">do </span><span class="n">kk</span><span class="o">=</span><span class="n">kb</span><span class="p">,</span><span class="n">ke</span>
<a name="ln-1116"></a>        <span class="k">if</span> <span class="p">(</span><span class="n">zorf</span><span class="p">(</span><span class="n">kk</span><span class="p">)</span> <span class="o">&gt;=</span> <span class="n">zoif</span><span class="p">(</span><span class="n">k</span><span class="p">))</span> <span class="k">then</span>
<a name="ln-1117"></a><span class="k">          </span><span class="n">locupof</span><span class="p">(</span><span class="n">k</span><span class="p">)</span>  <span class="o">=</span> <span class="n">kk</span>
<a name="ln-1118"></a>          <span class="n">loclowof</span><span class="p">(</span><span class="n">k</span><span class="p">)</span> <span class="o">=</span> <span class="n">kk</span><span class="o">-</span><span class="mi">1</span>
<a name="ln-1119"></a>          <span class="k">exit</span>
<a name="ln-1120"></a><span class="k">        </span><span class="n">elseif</span> <span class="p">(</span><span class="n">kk</span><span class="o">==</span><span class="n">ke</span><span class="p">)</span> <span class="k">then</span>
<a name="ln-1121"></a><span class="k">          </span><span class="n">locupof</span><span class="p">(</span><span class="n">k</span><span class="p">)</span>  <span class="o">=</span> <span class="n">ke</span><span class="o">+</span><span class="mi">1</span>            <span class="c">! this means extrapolation!</span>
<a name="ln-1122"></a>          <span class="n">loclowof</span><span class="p">(</span><span class="n">k</span><span class="p">)</span> <span class="o">=</span> <span class="n">ke</span><span class="o">-</span><span class="mi">1</span>
<a name="ln-1123"></a>        <span class="k">end if</span>
<a name="ln-1124"></a><span class="k">      end do</span>
<a name="ln-1125"></a><span class="k">    end do</span>
<a name="ln-1126"></a>   <span class="c">! for w-components (zh)</span>
<a name="ln-1127"></a>    <span class="k">do </span><span class="n">k</span><span class="o">=</span><span class="n">kb</span><span class="p">,</span><span class="n">ke</span><span class="o">+</span><span class="mi">1</span>
<a name="ln-1128"></a>      <span class="k">do </span><span class="n">kk</span><span class="o">=</span><span class="n">kb</span><span class="p">,</span><span class="n">ke</span><span class="o">+</span><span class="mi">1</span>
<a name="ln-1129"></a>        <span class="k">if</span> <span class="p">(</span><span class="n">zorh</span><span class="p">(</span><span class="n">kk</span><span class="p">)</span> <span class="o">&gt;=</span> <span class="n">zoih</span><span class="p">(</span><span class="n">k</span><span class="p">))</span> <span class="k">then</span>
<a name="ln-1130"></a><span class="k">          </span><span class="n">locupoh</span><span class="p">(</span><span class="n">k</span><span class="p">)</span>  <span class="o">=</span> <span class="n">kk</span>
<a name="ln-1131"></a>          <span class="n">loclowoh</span><span class="p">(</span><span class="n">k</span><span class="p">)</span> <span class="o">=</span> <span class="n">kk</span><span class="o">-</span><span class="mi">1</span>
<a name="ln-1132"></a>          <span class="k">exit</span>
<a name="ln-1133"></a><span class="k">        </span><span class="n">elseif</span> <span class="p">(</span><span class="n">kk</span><span class="o">==</span><span class="n">ke</span><span class="o">+</span><span class="mi">1</span><span class="p">)</span> <span class="k">then</span>
<a name="ln-1134"></a><span class="k">          </span><span class="n">locupoh</span><span class="p">(</span><span class="n">k</span><span class="p">)</span>  <span class="o">=</span> <span class="n">ke</span><span class="o">+</span><span class="mi">2</span>            <span class="c">! this means extrapolation!</span>
<a name="ln-1135"></a>          <span class="n">loclowoh</span><span class="p">(</span><span class="n">k</span><span class="p">)</span> <span class="o">=</span> <span class="n">ke</span>
<a name="ln-1136"></a>        <span class="k">end if</span>
<a name="ln-1137"></a><span class="k">      end do</span>
<a name="ln-1138"></a><span class="k">    end do</span>
<a name="ln-1139"></a>
<a name="ln-1140"></a>  <span class="c">!!! Finished with outer coordinates</span>
<a name="ln-1141"></a>
<a name="ln-1142"></a><span class="c">!!! Now really interpolate</span>
<a name="ln-1143"></a>  <span class="c">!!! First inner coordinates</span>
<a name="ln-1144"></a>   <span class="c">! compute Urec on zii grid</span>
<a name="ln-1145"></a>    <span class="k">do </span><span class="n">k</span><span class="o">=</span><span class="n">kb</span><span class="p">,</span><span class="n">ke</span>
<a name="ln-1146"></a>      <span class="k">if</span> <span class="p">(</span><span class="n">locupif</span><span class="p">(</span><span class="n">k</span><span class="p">)</span> <span class="o">==</span> <span class="n">ke</span><span class="o">+</span><span class="mi">1</span><span class="p">)</span> <span class="k">then</span>      <span class="c">! indicator for extrapolation!</span>
<a name="ln-1147"></a><span class="c">!        Uinli(k) = Urec(ke) + (Urec(ke) - Urec(ke-1)) / (zirf(ke)-zirf(ke-1)) * (ziif(k)-zirf(ke))</span>
<a name="ln-1148"></a>        <span class="n">Uinli</span><span class="p">(</span><span class="n">k</span><span class="p">)</span> <span class="o">=</span> <span class="n">Urec</span><span class="p">(</span><span class="n">ke</span><span class="p">)</span>
<a name="ln-1149"></a>      <span class="n">elseif</span> <span class="p">(</span><span class="n">loclowif</span><span class="p">(</span><span class="n">k</span><span class="p">)</span> <span class="o">==</span> <span class="n">kb</span><span class="o">-</span><span class="mi">1</span><span class="p">)</span> <span class="k">then</span> <span class="c">! interprets this as extrapolation to bottom (use u=0 at z+=0)</span>
<a name="ln-1150"></a>        <span class="n">Uinli</span><span class="p">(</span><span class="n">k</span><span class="p">)</span> <span class="o">=</span> <span class="n">Urec</span><span class="p">(</span><span class="n">kb</span><span class="p">)</span><span class="o">/</span><span class="n">zirf</span><span class="p">(</span><span class="n">kb</span><span class="p">)</span> <span class="o">*</span> <span class="n">ziif</span><span class="p">(</span><span class="n">k</span><span class="p">)</span>
<a name="ln-1151"></a>      <span class="k">else</span>                            <span class="c">! normal interpolation</span>
<a name="ln-1152"></a>        <span class="n">Uinli</span><span class="p">(</span><span class="n">k</span><span class="p">)</span> <span class="o">=</span> <span class="n">Urec</span><span class="p">(</span><span class="n">loclowif</span><span class="p">(</span><span class="n">k</span><span class="p">))</span> <span class="o">+</span> <span class="p">(</span><span class="n">Urec</span><span class="p">(</span><span class="n">locupif</span><span class="p">(</span><span class="n">k</span><span class="p">))</span> <span class="o">-</span> <span class="n">Urec</span><span class="p">(</span><span class="n">loclowif</span><span class="p">(</span><span class="n">k</span><span class="p">)))</span> <span class="o">/</span> <span class="p">(</span><span class="n">zirf</span><span class="p">(</span><span class="n">locupif</span><span class="p">(</span><span class="n">k</span><span class="p">))</span> <span class="o">-</span> <span class="n">zirf</span><span class="p">(</span><span class="n">loclowif</span><span class="p">(</span><span class="n">k</span><span class="p">)))</span><span class="o">*</span> <span class="p">(</span><span class="n">ziif</span><span class="p">(</span><span class="n">k</span><span class="p">)</span> <span class="o">-</span> <span class="n">zirf</span><span class="p">(</span><span class="n">loclowif</span><span class="p">(</span><span class="n">k</span><span class="p">)))</span>
<a name="ln-1153"></a>        <span class="k">if</span> <span class="p">((</span><span class="n">ziif</span><span class="p">(</span><span class="n">k</span><span class="p">)</span> <span class="p">.</span><span class="n">gt</span><span class="p">.</span> <span class="n">zirf</span><span class="p">(</span><span class="n">locupif</span><span class="p">(</span><span class="n">k</span><span class="p">)))</span> <span class="p">.</span><span class="nb">or</span><span class="p">.</span> <span class="p">(</span><span class="n">ziif</span><span class="p">(</span><span class="n">k</span><span class="p">)</span> <span class="p">.</span><span class="n">lt</span><span class="p">.</span> <span class="n">zirf</span><span class="p">(</span><span class="n">loclowif</span><span class="p">(</span><span class="n">k</span><span class="p">))))</span> <span class="k">then</span>
<a name="ln-1154"></a><span class="k">          write</span><span class="p">(</span><span class="mi">6</span><span class="p">,</span><span class="o">*</span><span class="p">)</span> <span class="s1">&#39;!!!Mistake in Interpolation !!!!&#39;</span>
<a name="ln-1155"></a>        <span class="k">end if</span>
<a name="ln-1156"></a><span class="k">      end if</span>
<a name="ln-1157"></a><span class="k">    end do</span>
<a name="ln-1158"></a>
<a name="ln-1159"></a>   <span class="c">! compute Wrec on zii grid</span>
<a name="ln-1160"></a>    <span class="n">Winli</span><span class="p">(</span><span class="n">kb</span><span class="p">)</span> <span class="o">=</span> <span class="mf">0.0</span>                      <span class="c">! corresponds to ground level</span>
<a name="ln-1161"></a>    <span class="k">do </span><span class="n">k</span><span class="o">=</span><span class="n">kb</span><span class="o">+</span><span class="mi">1</span><span class="p">,</span><span class="n">ke</span><span class="o">+</span><span class="mi">1</span>
<a name="ln-1162"></a>      <span class="k">if</span> <span class="p">(</span><span class="n">locupih</span><span class="p">(</span><span class="n">k</span><span class="p">)</span> <span class="o">==</span> <span class="n">ke</span><span class="o">+</span><span class="mi">2</span><span class="p">)</span> <span class="k">then</span>     <span class="c">! indicator for extrapolation!</span>
<a name="ln-1163"></a><span class="c">!        Winli(k) = Wrec(ke+1) + (Wrec(ke+1) - Wrec(ke)) / (zirh(ke+1)-zirh(ke)) * (ziih(k)-zirh(ke+1))</span>
<a name="ln-1164"></a>        <span class="n">Winli</span><span class="p">(</span><span class="n">k</span><span class="p">)</span> <span class="o">=</span> <span class="n">Wrec</span><span class="p">(</span><span class="n">ke</span><span class="o">+</span><span class="mi">1</span><span class="p">)</span>
<a name="ln-1165"></a>      <span class="k">else</span>                            <span class="c">! normal interpolation</span>
<a name="ln-1166"></a>        <span class="n">Winli</span><span class="p">(</span><span class="n">k</span><span class="p">)</span> <span class="o">=</span> <span class="n">Wrec</span><span class="p">(</span><span class="n">loclowih</span><span class="p">(</span><span class="n">k</span><span class="p">))</span> <span class="o">+</span> <span class="p">(</span><span class="n">Wrec</span><span class="p">(</span><span class="n">locupih</span><span class="p">(</span><span class="n">k</span><span class="p">))</span> <span class="o">-</span> <span class="n">Wrec</span><span class="p">(</span><span class="n">loclowih</span><span class="p">(</span><span class="n">k</span><span class="p">)))</span> <span class="o">/</span> <span class="p">(</span><span class="n">zirh</span><span class="p">(</span><span class="n">locupih</span><span class="p">(</span><span class="n">k</span><span class="p">))</span> <span class="o">-</span> <span class="n">zirh</span><span class="p">(</span><span class="n">loclowih</span><span class="p">(</span><span class="n">k</span><span class="p">)))</span> <span class="o">*</span> <span class="p">(</span><span class="n">ziih</span><span class="p">(</span><span class="n">k</span><span class="p">)</span> <span class="o">-</span> <span class="n">zirh</span><span class="p">(</span><span class="n">loclowih</span><span class="p">(</span><span class="n">k</span><span class="p">)))</span>
<a name="ln-1167"></a>      <span class="k">end if</span>
<a name="ln-1168"></a><span class="k">    end do</span>
<a name="ln-1169"></a>
<a name="ln-1170"></a>   <span class="c">! compute u- and v- and t-fluctuation on zii grid</span>
<a name="ln-1171"></a>    <span class="k">do </span><span class="n">k</span><span class="o">=</span><span class="n">kb</span><span class="p">,</span><span class="n">ke</span>
<a name="ln-1172"></a>      <span class="k">if</span> <span class="p">(</span><span class="n">locupif</span><span class="p">(</span><span class="n">k</span><span class="p">)</span> <span class="o">==</span> <span class="n">ke</span><span class="o">+</span><span class="mi">1</span><span class="p">)</span> <span class="k">then</span>      <span class="c">! indicator for extrapolation!</span>
<a name="ln-1173"></a><span class="c">!        upinli(:,k) = uprec(:,ke) + (uprec(:,ke) - uprec(:,ke-1)) / (zirf(ke)-zirf(ke-1)) * (ziif(k)-zirf(ke))</span>
<a name="ln-1174"></a>        <span class="n">upinli</span><span class="p">(:,</span><span class="n">k</span><span class="p">)</span> <span class="o">=</span> <span class="mf">0.</span>
<a name="ln-1175"></a>        <span class="n">vpinli</span><span class="p">(:,</span><span class="n">k</span><span class="p">)</span> <span class="o">=</span> <span class="mf">0.</span>
<a name="ln-1176"></a>      <span class="n">elseif</span> <span class="p">(</span><span class="n">loclowif</span><span class="p">(</span><span class="n">k</span><span class="p">)</span> <span class="o">==</span> <span class="n">kb</span><span class="o">-</span><span class="mi">1</span><span class="p">)</span> <span class="k">then</span> <span class="c">! interprets this as extrapolation to bottom (use u=0 at z+=0)</span>
<a name="ln-1177"></a>        <span class="n">upinli</span><span class="p">(:,</span><span class="n">k</span><span class="p">)</span> <span class="o">=</span> <span class="n">uprec</span><span class="p">(:,</span><span class="n">kb</span><span class="p">)</span><span class="o">/</span><span class="n">zirf</span><span class="p">(</span><span class="n">kb</span><span class="p">)</span> <span class="o">*</span> <span class="n">ziif</span><span class="p">(</span><span class="n">k</span><span class="p">)</span>
<a name="ln-1178"></a>        <span class="n">vpinli</span><span class="p">(:,</span><span class="n">k</span><span class="p">)</span> <span class="o">=</span> <span class="n">vprec</span><span class="p">(:,</span><span class="n">kb</span><span class="p">)</span><span class="o">/</span><span class="n">zirf</span><span class="p">(</span><span class="n">kb</span><span class="p">)</span> <span class="o">*</span> <span class="n">ziif</span><span class="p">(</span><span class="n">k</span><span class="p">)</span>
<a name="ln-1179"></a>      <span class="k">else</span>                            <span class="c">! normal interpolation</span>
<a name="ln-1180"></a>        <span class="n">upinli</span><span class="p">(:,</span><span class="n">k</span><span class="p">)</span> <span class="o">=</span> <span class="n">uprec</span><span class="p">(:,</span><span class="n">loclowif</span><span class="p">(</span><span class="n">k</span><span class="p">))</span> <span class="o">+</span> <span class="p">(</span><span class="n">uprec</span><span class="p">(:,</span><span class="n">locupif</span><span class="p">(</span><span class="n">k</span><span class="p">))</span> <span class="o">-</span> <span class="n">uprec</span><span class="p">(:,</span><span class="n">loclowif</span><span class="p">(</span><span class="n">k</span><span class="p">)))</span> <span class="o">/</span> <span class="p">(</span><span class="n">zirf</span><span class="p">(</span><span class="n">locupif</span><span class="p">(</span><span class="n">k</span><span class="p">))</span> <span class="o">-</span> <span class="n">zirf</span><span class="p">(</span><span class="n">loclowif</span><span class="p">(</span><span class="n">k</span><span class="p">)))</span> <span class="o">*</span> <span class="p">(</span><span class="n">ziif</span><span class="p">(</span><span class="n">k</span><span class="p">)</span> <span class="o">-</span> <span class="n">zirf</span><span class="p">(</span><span class="n">loclowif</span><span class="p">(</span><span class="n">k</span><span class="p">)))</span>
<a name="ln-1181"></a>        <span class="n">vpinli</span><span class="p">(:,</span><span class="n">k</span><span class="p">)</span> <span class="o">=</span> <span class="n">vprec</span><span class="p">(:,</span><span class="n">loclowif</span><span class="p">(</span><span class="n">k</span><span class="p">))</span> <span class="o">+</span> <span class="p">(</span><span class="n">vprec</span><span class="p">(:,</span><span class="n">locupif</span><span class="p">(</span><span class="n">k</span><span class="p">))</span> <span class="o">-</span> <span class="n">vprec</span><span class="p">(:,</span><span class="n">loclowif</span><span class="p">(</span><span class="n">k</span><span class="p">)))</span> <span class="o">/</span> <span class="p">(</span><span class="n">zirf</span><span class="p">(</span><span class="n">locupif</span><span class="p">(</span><span class="n">k</span><span class="p">))</span> <span class="o">-</span> <span class="n">zirf</span><span class="p">(</span><span class="n">loclowif</span><span class="p">(</span><span class="n">k</span><span class="p">)))</span> <span class="o">*</span> <span class="p">(</span><span class="n">ziif</span><span class="p">(</span><span class="n">k</span><span class="p">)</span> <span class="o">-</span> <span class="n">zirf</span><span class="p">(</span><span class="n">loclowif</span><span class="p">(</span><span class="n">k</span><span class="p">)))</span>
<a name="ln-1182"></a>      <span class="k">end if</span>
<a name="ln-1183"></a><span class="k">    end do</span>
<a name="ln-1184"></a>   
<a name="ln-1185"></a>   <span class="c">! compute w-fluctuation on zii grid</span>
<a name="ln-1186"></a>    <span class="k">do </span><span class="n">k</span><span class="o">=</span><span class="n">kb</span><span class="o">+</span><span class="mi">1</span><span class="p">,</span><span class="n">ke</span><span class="o">+</span><span class="mi">1</span>
<a name="ln-1187"></a><span class="c">!      if (locupih(k) == ke+1) then      ! indicator for extrapolation!</span>
<a name="ln-1188"></a>      <span class="k">if</span> <span class="p">(</span><span class="n">locupih</span><span class="p">(</span><span class="n">k</span><span class="p">)</span> <span class="o">==</span> <span class="n">ke</span><span class="o">+</span><span class="mi">2</span><span class="p">)</span> <span class="k">then</span>      <span class="c">! indicator for extrapolation!</span>
<a name="ln-1189"></a><span class="c">!        wpinli(:,k) = wprec(:,ke+1) + (wprec(:,ke+1) - wprec(:,ke)) / (zirh(ke+1)-zirh(ke)) * (ziih(k)-zirh(ke+1))</span>
<a name="ln-1190"></a>        <span class="n">wpinli</span><span class="p">(:,</span><span class="n">k</span><span class="p">)</span> <span class="o">=</span> <span class="mf">0.</span>
<a name="ln-1191"></a>      <span class="k">else</span>                            <span class="c">! normal interpolation</span>
<a name="ln-1192"></a>        <span class="n">wpinli</span><span class="p">(:,</span><span class="n">k</span><span class="p">)</span> <span class="o">=</span> <span class="n">wprec</span><span class="p">(:,</span><span class="n">loclowih</span><span class="p">(</span><span class="n">k</span><span class="p">))</span> <span class="o">+</span> <span class="p">(</span><span class="n">wprec</span><span class="p">(:,</span><span class="n">locupih</span><span class="p">(</span><span class="n">k</span><span class="p">))</span> <span class="o">-</span> <span class="n">wprec</span><span class="p">(:,</span><span class="n">loclowih</span><span class="p">(</span><span class="n">k</span><span class="p">)))</span> <span class="o">/</span> <span class="p">(</span><span class="n">zirh</span><span class="p">(</span><span class="n">locupih</span><span class="p">(</span><span class="n">k</span><span class="p">))</span> <span class="o">-</span> <span class="n">zirh</span><span class="p">(</span><span class="n">loclowih</span><span class="p">(</span><span class="n">k</span><span class="p">)))</span> <span class="o">*</span> <span class="p">(</span><span class="n">ziih</span><span class="p">(</span><span class="n">k</span><span class="p">)</span> <span class="o">-</span> <span class="n">zirh</span><span class="p">(</span><span class="n">loclowih</span><span class="p">(</span><span class="n">k</span><span class="p">)))</span>
<a name="ln-1193"></a>      <span class="k">end if</span>
<a name="ln-1194"></a><span class="k">    end do</span>
<a name="ln-1195"></a>
<a name="ln-1196"></a> <span class="c">!! Finished with interpolating inner variables </span>
<a name="ln-1197"></a> <span class="c">!! Continue with interpolating outer variables</span>
<a name="ln-1198"></a>   <span class="c">! compute Urec on zoi grid</span>
<a name="ln-1199"></a>    <span class="k">do </span><span class="n">k</span><span class="o">=</span><span class="n">kb</span><span class="p">,</span><span class="n">ke</span>
<a name="ln-1200"></a>      <span class="k">if</span> <span class="p">(</span><span class="n">locupof</span><span class="p">(</span><span class="n">k</span><span class="p">)</span> <span class="o">==</span> <span class="n">ke</span><span class="o">+</span><span class="mi">1</span><span class="p">)</span> <span class="k">then</span>      <span class="c">! indicator for extrapolation!</span>
<a name="ln-1201"></a><span class="c">!        Uinlo(k) = Urec(ke) + (Urec(ke) - Urec(ke-1)) / (zorf(ke)-zorf(ke-1)) * (zoif(k)-zorf(ke))</span>
<a name="ln-1202"></a><span class="c">!        Uinlo(k) = Urec(ke)</span>
<a name="ln-1203"></a>        <span class="n">Uinlo</span><span class="p">(</span><span class="n">k</span><span class="p">)</span> <span class="o">=</span> <span class="n">Uinf</span>
<a name="ln-1204"></a>      <span class="n">elseif</span> <span class="p">(</span><span class="n">loclowof</span><span class="p">(</span><span class="n">k</span><span class="p">)</span> <span class="o">==</span> <span class="n">kb</span><span class="o">-</span><span class="mi">1</span><span class="p">)</span> <span class="k">then</span> <span class="c">! interprets this as extrapolation to bottom (use u=0 at z+=0)</span>
<a name="ln-1205"></a>        <span class="n">Uinlo</span><span class="p">(</span><span class="n">k</span><span class="p">)</span> <span class="o">=</span> <span class="n">Urec</span><span class="p">(</span><span class="n">kb</span><span class="p">)</span><span class="o">/</span><span class="n">zorf</span><span class="p">(</span><span class="n">kb</span><span class="p">)</span> <span class="o">*</span> <span class="n">zoif</span><span class="p">(</span><span class="n">k</span><span class="p">)</span>
<a name="ln-1206"></a>      <span class="k">else</span>                            <span class="c">! normal interpolation</span>
<a name="ln-1207"></a>        <span class="n">Uinlo</span><span class="p">(</span><span class="n">k</span><span class="p">)</span> <span class="o">=</span> <span class="n">Urec</span><span class="p">(</span><span class="n">loclowof</span><span class="p">(</span><span class="n">k</span><span class="p">))</span> <span class="o">+</span> <span class="p">(</span><span class="n">Urec</span><span class="p">(</span><span class="n">locupof</span><span class="p">(</span><span class="n">k</span><span class="p">))</span> <span class="o">-</span> <span class="n">Urec</span><span class="p">(</span><span class="n">loclowof</span><span class="p">(</span><span class="n">k</span><span class="p">)))</span> <span class="o">/</span> <span class="p">(</span><span class="n">zorf</span><span class="p">(</span><span class="n">locupof</span><span class="p">(</span><span class="n">k</span><span class="p">))</span> <span class="o">-</span> <span class="n">zorf</span><span class="p">(</span><span class="n">loclowof</span><span class="p">(</span><span class="n">k</span><span class="p">)))</span> <span class="o">*</span> <span class="p">(</span><span class="n">zoif</span><span class="p">(</span><span class="n">k</span><span class="p">)</span> <span class="o">-</span> <span class="n">zorf</span><span class="p">(</span><span class="n">loclowof</span><span class="p">(</span><span class="n">k</span><span class="p">)))</span>
<a name="ln-1208"></a>      <span class="k">end if</span>
<a name="ln-1209"></a><span class="k">    end do</span>
<a name="ln-1210"></a>  
<a name="ln-1211"></a>   <span class="c">! compute Wrec on zii grid</span>
<a name="ln-1212"></a>    <span class="n">Winlo</span><span class="p">(</span><span class="n">kb</span><span class="p">)</span> <span class="o">=</span> <span class="mf">0.0</span>                      <span class="c">! corresponds to ground level</span>
<a name="ln-1213"></a>    <span class="k">do </span><span class="n">k</span><span class="o">=</span><span class="n">kb</span><span class="o">+</span><span class="mi">1</span><span class="p">,</span><span class="n">ke</span><span class="o">+</span><span class="mi">1</span>
<a name="ln-1214"></a>      <span class="k">if</span> <span class="p">(</span><span class="n">locupoh</span><span class="p">(</span><span class="n">k</span><span class="p">)</span> <span class="o">==</span> <span class="n">ke</span><span class="o">+</span><span class="mi">2</span><span class="p">)</span> <span class="k">then</span>     <span class="c">! indicator for extrapolation!</span>
<a name="ln-1215"></a><span class="c">!        Winlo(k) = Wrec(ke+1) + (Wrec(ke+1) - Wrec(ke)) / (zorh(ke+1)-zorh(ke)) * (zoih(k)-zorh(ke+1))</span>
<a name="ln-1216"></a>        <span class="n">Winlo</span><span class="p">(</span><span class="n">k</span><span class="p">)</span> <span class="o">=</span> <span class="n">Wrec</span><span class="p">(</span><span class="n">ke</span><span class="o">+</span><span class="mi">1</span><span class="p">)</span> 
<a name="ln-1217"></a>      <span class="k">else</span>                            <span class="c">! normal interpolation</span>
<a name="ln-1218"></a>        <span class="n">Winlo</span><span class="p">(</span><span class="n">k</span><span class="p">)</span> <span class="o">=</span> <span class="n">Wrec</span><span class="p">(</span><span class="n">loclowoh</span><span class="p">(</span><span class="n">k</span><span class="p">))</span> <span class="o">+</span> <span class="p">(</span><span class="n">Wrec</span><span class="p">(</span><span class="n">locupoh</span><span class="p">(</span><span class="n">k</span><span class="p">))</span> <span class="o">-</span> <span class="n">Wrec</span><span class="p">(</span><span class="n">loclowoh</span><span class="p">(</span><span class="n">k</span><span class="p">)))</span> <span class="o">/</span> <span class="p">(</span><span class="n">zorh</span><span class="p">(</span><span class="n">locupoh</span><span class="p">(</span><span class="n">k</span><span class="p">))</span> <span class="o">-</span> <span class="n">zorh</span><span class="p">(</span><span class="n">loclowoh</span><span class="p">(</span><span class="n">k</span><span class="p">)))</span> <span class="o">*</span> <span class="p">(</span><span class="n">zoih</span><span class="p">(</span><span class="n">k</span><span class="p">)</span> <span class="o">-</span> <span class="n">zorh</span><span class="p">(</span><span class="n">loclowoh</span><span class="p">(</span><span class="n">k</span><span class="p">)))</span>
<a name="ln-1219"></a>      <span class="k">end if</span>
<a name="ln-1220"></a><span class="k">    end do</span>
<a name="ln-1221"></a>
<a name="ln-1222"></a>   <span class="c">! compute u- and v-fluctuation on zoi grid</span>
<a name="ln-1223"></a>    <span class="k">do </span><span class="n">k</span><span class="o">=</span><span class="n">kb</span><span class="p">,</span><span class="n">ke</span>
<a name="ln-1224"></a>      <span class="k">if</span> <span class="p">(</span><span class="n">locupof</span><span class="p">(</span><span class="n">k</span><span class="p">)</span> <span class="o">==</span> <span class="n">ke</span><span class="o">+</span><span class="mi">1</span><span class="p">)</span> <span class="k">then</span>      <span class="c">! indicator for extrapolation!</span>
<a name="ln-1225"></a><span class="c">!        upinlo(:,k) = uprec(:,ke) + (uprec(:,ke) - uprec(:,ke-1)) / (zorf(ke)-zorf(ke-1)) * (zoif(k)-zorf(ke))</span>
<a name="ln-1226"></a>        <span class="n">upinlo</span><span class="p">(:,</span><span class="n">k</span><span class="p">)</span> <span class="o">=</span> <span class="mf">0.</span>
<a name="ln-1227"></a>        <span class="n">vpinlo</span><span class="p">(:,</span><span class="n">k</span><span class="p">)</span> <span class="o">=</span> <span class="mf">0.</span>
<a name="ln-1228"></a>      <span class="n">elseif</span> <span class="p">(</span><span class="n">loclowof</span><span class="p">(</span><span class="n">k</span><span class="p">)</span> <span class="o">==</span> <span class="n">kb</span><span class="o">-</span><span class="mi">1</span><span class="p">)</span> <span class="k">then</span> <span class="c">! interprets this as extrapolation to bottom (use u=0 at z+=0)</span>
<a name="ln-1229"></a>        <span class="n">upinlo</span><span class="p">(:,</span><span class="n">k</span><span class="p">)</span> <span class="o">=</span> <span class="n">uprec</span><span class="p">(:,</span><span class="n">kb</span><span class="p">)</span><span class="o">/</span><span class="n">zorf</span><span class="p">(</span><span class="n">kb</span><span class="p">)</span> <span class="o">*</span> <span class="n">zoif</span><span class="p">(</span><span class="n">k</span><span class="p">)</span>
<a name="ln-1230"></a>        <span class="n">vpinlo</span><span class="p">(:,</span><span class="n">k</span><span class="p">)</span> <span class="o">=</span> <span class="n">vprec</span><span class="p">(:,</span><span class="n">kb</span><span class="p">)</span><span class="o">/</span><span class="n">zorf</span><span class="p">(</span><span class="n">kb</span><span class="p">)</span> <span class="o">*</span> <span class="n">zoif</span><span class="p">(</span><span class="n">k</span><span class="p">)</span>
<a name="ln-1231"></a>      <span class="k">else</span>                            <span class="c">! normal interpolation</span>
<a name="ln-1232"></a>        <span class="n">upinlo</span><span class="p">(:,</span><span class="n">k</span><span class="p">)</span> <span class="o">=</span> <span class="n">uprec</span><span class="p">(:,</span><span class="n">loclowof</span><span class="p">(</span><span class="n">k</span><span class="p">))</span> <span class="o">+</span> <span class="p">(</span><span class="n">uprec</span><span class="p">(:,</span><span class="n">locupof</span><span class="p">(</span><span class="n">k</span><span class="p">))</span> <span class="o">-</span> <span class="n">uprec</span><span class="p">(:,</span><span class="n">loclowof</span><span class="p">(</span><span class="n">k</span><span class="p">)))</span> <span class="o">/</span> <span class="p">(</span><span class="n">zorf</span><span class="p">(</span><span class="n">locupof</span><span class="p">(</span><span class="n">k</span><span class="p">))</span> <span class="o">-</span> <span class="n">zorf</span><span class="p">(</span><span class="n">loclowof</span><span class="p">(</span><span class="n">k</span><span class="p">)))</span> <span class="o">*</span> <span class="p">(</span><span class="n">zoif</span><span class="p">(</span><span class="n">k</span><span class="p">)</span> <span class="o">-</span> <span class="n">zorf</span><span class="p">(</span><span class="n">loclowof</span><span class="p">(</span><span class="n">k</span><span class="p">)))</span>
<a name="ln-1233"></a>        <span class="n">vpinlo</span><span class="p">(:,</span><span class="n">k</span><span class="p">)</span> <span class="o">=</span> <span class="n">vprec</span><span class="p">(:,</span><span class="n">loclowof</span><span class="p">(</span><span class="n">k</span><span class="p">))</span> <span class="o">+</span> <span class="p">(</span><span class="n">vprec</span><span class="p">(:,</span><span class="n">locupof</span><span class="p">(</span><span class="n">k</span><span class="p">))</span> <span class="o">-</span> <span class="n">vprec</span><span class="p">(:,</span><span class="n">loclowof</span><span class="p">(</span><span class="n">k</span><span class="p">)))</span> <span class="o">/</span> <span class="p">(</span><span class="n">zorf</span><span class="p">(</span><span class="n">locupof</span><span class="p">(</span><span class="n">k</span><span class="p">))</span> <span class="o">-</span> <span class="n">zorf</span><span class="p">(</span><span class="n">loclowof</span><span class="p">(</span><span class="n">k</span><span class="p">)))</span> <span class="o">*</span> <span class="p">(</span><span class="n">zoif</span><span class="p">(</span><span class="n">k</span><span class="p">)</span> <span class="o">-</span> <span class="n">zorf</span><span class="p">(</span><span class="n">loclowof</span><span class="p">(</span><span class="n">k</span><span class="p">)))</span>
<a name="ln-1234"></a>      <span class="k">end if</span>
<a name="ln-1235"></a><span class="k">    end do</span>
<a name="ln-1236"></a>
<a name="ln-1237"></a>   <span class="c">! compute w-fluctuation on zoi grid</span>
<a name="ln-1238"></a>    <span class="k">do </span><span class="n">k</span><span class="o">=</span><span class="n">kb</span><span class="o">+</span><span class="mi">1</span><span class="p">,</span><span class="n">ke</span><span class="o">+</span><span class="mi">1</span>
<a name="ln-1239"></a>      <span class="k">if</span> <span class="p">(</span><span class="n">locupoh</span><span class="p">(</span><span class="n">k</span><span class="p">)</span> <span class="o">==</span> <span class="n">ke</span><span class="o">+</span><span class="mi">2</span><span class="p">)</span> <span class="k">then</span>      <span class="c">! indicator for extrapolation!</span>
<a name="ln-1240"></a><span class="c">!        wpinlo(:,k) = wprec(:,ke+1) + (wprec(:,ke+1) - wprec(:,ke)) / (zorh(ke+1)-zorh(ke)) * (zoih(k)-zorh(ke+1))</span>
<a name="ln-1241"></a>        <span class="n">wpinlo</span><span class="p">(:,</span><span class="n">k</span><span class="p">)</span> <span class="o">=</span> <span class="mf">0.</span>
<a name="ln-1242"></a>      <span class="k">else</span>                            <span class="c">! normal interpolation</span>
<a name="ln-1243"></a>        <span class="n">wpinlo</span><span class="p">(:,</span><span class="n">k</span><span class="p">)</span> <span class="o">=</span> <span class="n">wprec</span><span class="p">(:,</span><span class="n">loclowoh</span><span class="p">(</span><span class="n">k</span><span class="p">))</span> <span class="o">+</span> <span class="p">(</span><span class="n">wprec</span><span class="p">(:,</span><span class="n">locupoh</span><span class="p">(</span><span class="n">k</span><span class="p">))</span> <span class="o">-</span> <span class="n">wprec</span><span class="p">(:,</span><span class="n">loclowoh</span><span class="p">(</span><span class="n">k</span><span class="p">)))</span> <span class="o">/</span> <span class="p">(</span><span class="n">zorh</span><span class="p">(</span><span class="n">locupoh</span><span class="p">(</span><span class="n">k</span><span class="p">))</span> <span class="o">-</span> <span class="n">zorh</span><span class="p">(</span><span class="n">loclowoh</span><span class="p">(</span><span class="n">k</span><span class="p">)))</span> <span class="o">*</span> <span class="p">(</span><span class="n">zoih</span><span class="p">(</span><span class="n">k</span><span class="p">)</span> <span class="o">-</span> <span class="n">zorh</span><span class="p">(</span><span class="n">loclowoh</span><span class="p">(</span><span class="n">k</span><span class="p">)))</span>
<a name="ln-1244"></a>      <span class="k">end if</span>
<a name="ln-1245"></a><span class="k">    end do</span>
<a name="ln-1246"></a> <span class="c">!! Finished interpolating outer velocity variables</span>
<a name="ln-1247"></a><span class="c">!!!!! Finished Interpolation! !!!!!</span>
<a name="ln-1248"></a>
<a name="ln-1249"></a>
<a name="ln-1250"></a>   <span class="c">! compute rescaled inner variables ! Winli = Winli (interpolation is enough)</span>
<a name="ln-1251"></a>    <span class="n">Uinli</span> <span class="o">=</span> <span class="n">gamm</span><span class="o">*</span> <span class="n">Uinli</span>                   
<a name="ln-1252"></a>    <span class="n">upinli</span> <span class="o">=</span> <span class="n">gamm</span><span class="o">*</span> <span class="n">upinli</span>
<a name="ln-1253"></a>    <span class="n">vpinli</span> <span class="o">=</span> <span class="n">gamm</span><span class="o">*</span> <span class="n">vpinli</span>
<a name="ln-1254"></a>    <span class="n">wpinli</span> <span class="o">=</span> <span class="n">gamm</span><span class="o">*</span> <span class="n">wpinli</span> 
<a name="ln-1255"></a>   <span class="c">! compute rescaled outer variables ! Winlo = Winlo (interpolation is enough)</span>
<a name="ln-1256"></a>    <span class="n">Uinlo</span> <span class="o">=</span> <span class="n">gamm</span><span class="o">*</span> <span class="n">Uinlo</span>  <span class="o">+</span> <span class="p">(</span><span class="mf">1.</span><span class="o">-</span> <span class="n">gamm</span><span class="p">)</span><span class="o">*</span><span class="n">Uinf</span>
<a name="ln-1257"></a><span class="c">!    Uinlo = gamm* Uinlo  + (1.- gamm)*Urec(ke) </span>
<a name="ln-1258"></a>    <span class="n">upinlo</span> <span class="o">=</span> <span class="n">gamm</span><span class="o">*</span> <span class="n">upinlo</span>
<a name="ln-1259"></a>    <span class="n">vpinlo</span> <span class="o">=</span> <span class="n">gamm</span><span class="o">*</span> <span class="n">vpinlo</span>
<a name="ln-1260"></a>    <span class="n">wpinlo</span> <span class="o">=</span> <span class="n">gamm</span><span class="o">*</span> <span class="n">wpinlo</span>
<a name="ln-1261"></a>
<a name="ln-1262"></a>
<a name="ln-1263"></a>   <span class="c">! Compute weight function (alpha=4, b=0.2)</span>
<a name="ln-1264"></a>    <span class="n">alpha</span> <span class="o">=</span> <span class="mf">4.</span>
<a name="ln-1265"></a>    <span class="n">beta</span> <span class="o">=</span> <span class="mf">0.2</span>
<a name="ln-1266"></a>    <span class="n">wfuncf</span> <span class="o">=</span> <span class="mf">0.5</span><span class="o">*</span><span class="p">(</span><span class="mf">1.</span> <span class="o">+</span> <span class="nb">tanh</span><span class="p">(</span> <span class="n">alpha</span><span class="o">*</span><span class="p">(</span><span class="n">zoif</span><span class="o">-</span><span class="n">beta</span><span class="p">)</span><span class="o">/</span><span class="p">((</span><span class="mf">1.</span><span class="o">-</span><span class="mf">2.</span><span class="o">*</span><span class="n">beta</span><span class="p">)</span><span class="o">*</span><span class="n">zoif</span><span class="o">+</span><span class="n">beta</span><span class="p">)</span> <span class="p">)</span><span class="o">/</span><span class="nb">tanh</span><span class="p">(</span><span class="n">alpha</span><span class="p">)</span> <span class="p">)</span> <span class="c">! for full level height</span>
<a name="ln-1267"></a>    <span class="n">wfunch</span> <span class="o">=</span> <span class="mf">0.5</span><span class="o">*</span><span class="p">(</span><span class="mf">1.</span> <span class="o">+</span> <span class="nb">tanh</span><span class="p">(</span> <span class="n">alpha</span><span class="o">*</span><span class="p">(</span><span class="n">zoih</span><span class="o">-</span><span class="n">beta</span><span class="p">)</span><span class="o">/</span><span class="p">((</span><span class="mf">1.</span><span class="o">-</span><span class="mf">2.</span><span class="o">*</span><span class="n">beta</span><span class="p">)</span><span class="o">*</span><span class="n">zoih</span><span class="o">+</span><span class="n">beta</span><span class="p">)</span> <span class="p">)</span><span class="o">/</span><span class="nb">tanh</span><span class="p">(</span><span class="n">alpha</span><span class="p">)</span> <span class="p">)</span> <span class="c">! for half level height</span>
<a name="ln-1268"></a>    <span class="k">do </span><span class="n">k</span><span class="o">=</span><span class="n">kb</span><span class="p">,</span><span class="n">ke</span>
<a name="ln-1269"></a>      <span class="k">if</span> <span class="p">(</span><span class="n">wfuncf</span><span class="p">(</span><span class="n">k</span><span class="p">)</span> <span class="p">.</span><span class="n">gt</span><span class="p">.</span> <span class="mf">1.</span><span class="p">)</span> <span class="k">then  </span>
<a name="ln-1270"></a><span class="k">        </span><span class="n">wfuncf</span><span class="p">(</span><span class="n">k</span><span class="p">)</span> <span class="o">=</span> <span class="mf">1.</span>
<a name="ln-1271"></a>      <span class="k">end if</span>
<a name="ln-1272"></a><span class="k">    end do</span>
<a name="ln-1273"></a><span class="k">    do </span><span class="n">k</span><span class="o">=</span><span class="n">kb</span><span class="p">,</span><span class="n">ke</span><span class="o">+</span><span class="mi">1</span>
<a name="ln-1274"></a>      <span class="k">if</span> <span class="p">(</span><span class="n">wfunch</span><span class="p">(</span><span class="n">k</span><span class="p">)</span> <span class="p">.</span><span class="n">gt</span><span class="p">.</span> <span class="mf">1.</span><span class="p">)</span> <span class="k">then  </span>
<a name="ln-1275"></a><span class="k">        </span><span class="n">wfunch</span><span class="p">(</span><span class="n">k</span><span class="p">)</span> <span class="o">=</span> <span class="mf">1.</span>
<a name="ln-1276"></a>      <span class="k">end if</span>
<a name="ln-1277"></a><span class="k">    end do</span>
<a name="ln-1278"></a> 
<a name="ln-1279"></a>
<a name="ln-1280"></a>   <span class="c">! Compute the velocity components for the inlet BC</span>
<a name="ln-1281"></a>    <span class="k">do </span><span class="n">k</span><span class="o">=</span><span class="n">kb</span><span class="p">,</span><span class="n">ke</span>  
<a name="ln-1282"></a>    <span class="k">do </span><span class="n">j</span><span class="o">=</span><span class="n">jb</span><span class="p">,</span><span class="n">je</span>
<a name="ln-1283"></a>      <span class="n">u0inletbc</span><span class="p">(</span><span class="n">j</span><span class="p">,</span><span class="n">k</span><span class="p">)</span> <span class="o">=</span> <span class="p">(</span><span class="n">Uinli</span><span class="p">(</span><span class="n">k</span><span class="p">)</span><span class="o">+</span> <span class="n">upinli</span><span class="p">(</span><span class="n">j</span><span class="p">,</span><span class="n">k</span><span class="p">))</span><span class="o">*</span><span class="p">(</span><span class="mf">1.</span><span class="o">-</span><span class="n">wfuncf</span><span class="p">(</span><span class="n">k</span><span class="p">))</span> <span class="o">+</span>  <span class="p">(</span><span class="n">Uinlo</span><span class="p">(</span><span class="n">k</span><span class="p">)</span> <span class="o">+</span> <span class="n">upinlo</span><span class="p">(</span><span class="n">j</span><span class="p">,</span><span class="n">k</span><span class="p">))</span><span class="o">*</span> <span class="n">wfuncf</span><span class="p">(</span><span class="n">k</span><span class="p">)</span>
<a name="ln-1284"></a>      <span class="n">v0inletbc</span><span class="p">(</span><span class="n">j</span><span class="p">,</span><span class="n">k</span><span class="p">)</span> <span class="o">=</span>            <span class="n">vpinli</span><span class="p">(</span><span class="n">j</span><span class="p">,</span><span class="n">k</span><span class="p">)</span> <span class="o">*</span><span class="p">(</span><span class="mf">1.</span><span class="o">-</span><span class="n">wfuncf</span><span class="p">(</span><span class="n">k</span><span class="p">))</span> <span class="o">+</span>              <span class="n">vpinlo</span><span class="p">(</span><span class="n">j</span><span class="p">,</span><span class="n">k</span><span class="p">)</span> <span class="o">*</span> <span class="n">wfuncf</span><span class="p">(</span><span class="n">k</span><span class="p">)</span> 
<a name="ln-1285"></a>    <span class="k">end do</span>
<a name="ln-1286"></a><span class="k">    end do</span>
<a name="ln-1287"></a>
<a name="ln-1288"></a>
<a name="ln-1289"></a><span class="k">    do </span><span class="n">k</span><span class="o">=</span><span class="n">kb</span><span class="p">,</span><span class="n">ke</span><span class="o">+</span><span class="mi">1</span> 
<a name="ln-1290"></a>    <span class="k">do </span><span class="n">j</span><span class="o">=</span><span class="n">jb</span><span class="p">,</span><span class="n">je</span>
<a name="ln-1291"></a>      <span class="n">w0inletbc</span><span class="p">(</span><span class="n">j</span><span class="p">,</span><span class="n">k</span><span class="p">)</span> <span class="o">=</span> <span class="p">(</span><span class="n">Winli</span><span class="p">(</span><span class="n">k</span><span class="p">)</span><span class="o">+</span> <span class="n">wpinli</span><span class="p">(</span><span class="n">j</span><span class="p">,</span><span class="n">k</span><span class="p">))</span><span class="o">*</span><span class="p">(</span><span class="mi">1</span><span class="o">-</span><span class="n">wfunch</span><span class="p">(</span><span class="n">k</span><span class="p">))</span> <span class="o">+</span>  <span class="p">(</span><span class="n">Winlo</span><span class="p">(</span><span class="n">k</span><span class="p">)</span> <span class="o">+</span> <span class="n">wpinlo</span><span class="p">(</span><span class="n">j</span><span class="p">,</span><span class="n">k</span><span class="p">))</span><span class="o">*</span> <span class="n">wfunch</span><span class="p">(</span><span class="n">k</span><span class="p">)</span>
<a name="ln-1292"></a>    <span class="k">end do</span>
<a name="ln-1293"></a><span class="k">    end do</span>
<a name="ln-1294"></a><span class="k">    </span><span class="n">w0inletbc</span><span class="p">(:,</span><span class="n">kb</span><span class="p">)</span> <span class="o">=</span> <span class="mf">0.</span>
<a name="ln-1295"></a>    <span class="n">w0inletbc</span><span class="p">(:,</span><span class="n">ke</span><span class="o">+</span><span class="mi">1</span><span class="p">)</span> <span class="o">=</span> <span class="mf">0.</span>
<a name="ln-1296"></a>
<a name="ln-1297"></a>
<a name="ln-1298"></a>   <span class="c">! Compute j-averaged inlet U  (used for compute thetai)</span>
<a name="ln-1299"></a>    <span class="n">uinletbc2</span><span class="p">(</span><span class="n">ib</span><span class="p">,</span><span class="n">jb</span><span class="p">:</span><span class="n">je</span><span class="p">,</span><span class="n">kb</span><span class="p">:</span><span class="n">ke</span><span class="p">)</span> <span class="o">=</span> <span class="n">u0inletbc</span><span class="p">(</span><span class="n">jb</span><span class="p">:</span><span class="n">je</span><span class="p">,</span><span class="n">kb</span><span class="p">:</span><span class="n">ke</span><span class="p">)</span>  <span class="c">! this is just a dummy variable to give uninletbc the right dimension in slabsum</span>
<a name="ln-1300"></a>    <span class="n">urav</span> <span class="o">=</span> <span class="mf">0.</span>
<a name="ln-1301"></a>    <span class="k">call </span><span class="n">slabsum</span><span class="p">(</span><span class="n">urav</span>  <span class="p">,</span><span class="n">kb</span><span class="p">,</span><span class="n">ke</span><span class="p">,</span><span class="n">uinletbc2</span> <span class="p">,</span><span class="n">ib</span><span class="p">,</span><span class="n">ib</span><span class="p">,</span><span class="n">jb</span><span class="p">,</span><span class="n">je</span><span class="p">,</span><span class="n">kb</span><span class="p">,</span><span class="n">ke</span><span class="p">,</span><span class="n">ib</span><span class="p">,</span><span class="n">ib</span><span class="p">,</span><span class="n">jb</span><span class="p">,</span><span class="n">je</span><span class="p">,</span><span class="n">kb</span><span class="p">,</span><span class="n">ke</span><span class="p">)</span>
<a name="ln-1302"></a>    <span class="n">urav</span> <span class="o">=</span> <span class="n">urav</span> <span class="o">/</span> <span class="p">(</span><span class="n">jge</span><span class="o">-</span><span class="n">jgb</span> <span class="o">+</span><span class="mi">1</span><span class="p">)</span>                    <span class="c">! average over j-direction</span>
<a name="ln-1303"></a>
<a name="ln-1304"></a><span class="c">! determine bulk velocity of new profile</span>
<a name="ln-1305"></a>      <span class="k">do </span><span class="n">k</span><span class="o">=</span><span class="n">kb</span><span class="p">,</span><span class="n">ke</span>
<a name="ln-1306"></a>        <span class="n">uravdzf</span><span class="p">(</span><span class="n">k</span><span class="p">)</span> <span class="o">=</span> <span class="n">urav</span><span class="p">(</span><span class="n">k</span><span class="p">)</span><span class="o">*</span><span class="n">dzf</span><span class="p">(</span><span class="n">k</span><span class="p">)</span>
<a name="ln-1307"></a>      <span class="k">end do</span>
<a name="ln-1308"></a><span class="k">      </span><span class="n">totalu</span> <span class="o">=</span> <span class="nb">sum</span><span class="p">(</span><span class="n">uravdzf</span><span class="p">(</span><span class="n">kb</span><span class="p">:</span><span class="n">ke</span><span class="p">))</span><span class="o">/</span><span class="p">(</span><span class="n">zh</span><span class="p">(</span><span class="n">ke</span><span class="o">+</span><span class="mi">1</span><span class="p">)</span><span class="o">-</span><span class="n">zh</span><span class="p">(</span><span class="n">kb</span><span class="p">))</span>      <span class="c">! Area-averaged outflow velocity</span>
<a name="ln-1309"></a>
<a name="ln-1310"></a><span class="c">! correct instantaneous inflow velocity for constant mass-flux</span>
<a name="ln-1311"></a>      <span class="k">if</span> <span class="p">(</span><span class="n">luvolflowr</span> <span class="p">)</span> <span class="k">then</span>
<a name="ln-1312"></a><span class="k">        do </span><span class="n">k</span><span class="o">=</span><span class="n">kb</span><span class="p">,</span><span class="n">ke</span>
<a name="ln-1313"></a>          <span class="n">uinldzf</span><span class="p">(</span><span class="n">k</span><span class="p">)</span> <span class="o">=</span> <span class="n">Uinl</span><span class="p">(</span><span class="n">k</span><span class="p">)</span><span class="o">*</span><span class="n">dzf</span><span class="p">(</span><span class="n">k</span><span class="p">)</span>     
<a name="ln-1314"></a>        <span class="k">end do</span>
<a name="ln-1315"></a><span class="k">        </span><span class="n">totaluinl</span> <span class="o">=</span> <span class="nb">sum</span><span class="p">(</span><span class="n">uinldzf</span><span class="p">(</span><span class="n">kb</span><span class="p">:</span><span class="n">ke</span><span class="p">))</span><span class="o">/</span><span class="p">(</span><span class="n">zh</span><span class="p">(</span><span class="n">ke</span><span class="o">+</span><span class="mi">1</span><span class="p">)</span><span class="o">-</span><span class="n">zh</span><span class="p">(</span><span class="n">kb</span><span class="p">))</span>      <span class="c">! Area-averaged inflow velocity that should be kept</span>
<a name="ln-1316"></a>        <span class="n">scalef</span> <span class="o">=</span> <span class="n">totaluinl</span><span class="o">/</span><span class="n">totalu</span> <span class="c">! compute factor to scale the velocity profile with</span>
<a name="ln-1317"></a>        <span class="n">u0inletbc</span><span class="p">(:,:)</span> <span class="o">=</span> <span class="n">u0inletbc</span><span class="p">(:,:)</span><span class="o">*</span><span class="n">scalef</span>  <span class="c">! rescale the velocity profile to have constant mass-flux</span>
<a name="ln-1318"></a>        <span class="n">urav</span><span class="p">(:)</span> <span class="o">=</span> <span class="n">urav</span><span class="p">(:)</span><span class="o">*</span><span class="n">scalef</span>                <span class="c">! also rescale the part that is added to the mean</span>
<a name="ln-1319"></a>      <span class="k">end if</span>
<a name="ln-1320"></a>
<a name="ln-1321"></a>   <span class="c">! Compute j- and time-averaged  inlet U  (used for compute thetai)</span>
<a name="ln-1322"></a>    <span class="k">if</span> <span class="p">(.</span><span class="nb">not</span><span class="p">.</span><span class="n">lfixinlet</span><span class="p">)</span> <span class="k">then</span>  <span class="c">! only update the average inlet profiles when lfixinlet .eqv..false.</span>
<a name="ln-1323"></a>      <span class="k">do </span><span class="n">k</span><span class="o">=</span><span class="n">kb</span><span class="p">,</span><span class="n">ke</span>
<a name="ln-1324"></a>        <span class="n">Uinl</span><span class="p">(</span><span class="n">k</span><span class="p">)</span> <span class="o">=</span>  <span class="n">urav</span><span class="p">(</span><span class="n">k</span><span class="p">)</span><span class="o">*</span><span class="n">deltat</span><span class="o">*</span><span class="n">avinti</span> <span class="o">+</span> <span class="p">(</span><span class="mf">1.</span><span class="o">-</span><span class="n">deltat</span><span class="o">*</span><span class="n">avinti</span><span class="p">)</span><span class="o">*</span><span class="n">Uinl</span><span class="p">(</span><span class="n">k</span><span class="p">)</span>
<a name="ln-1325"></a>      <span class="k">end do</span>
<a name="ln-1326"></a><span class="k">    end if</span>
<a name="ln-1327"></a>
<a name="ln-1328"></a><span class="c">! write inletplane to array (and to file after 1000 time steps)   </span>
<a name="ln-1329"></a>    <span class="k">if</span> <span class="p">(</span><span class="n">lstoreplane</span> <span class="p">)</span> <span class="k">then     </span>
<a name="ln-1330"></a><span class="k">      </span><span class="n">storeu0inletbc</span><span class="p">(:,:,</span><span class="n">nstepread</span><span class="p">)</span> <span class="o">=</span> <span class="n">u0inletbc</span><span class="p">(:,:)</span> 
<a name="ln-1331"></a>      <span class="n">storev0inletbc</span><span class="p">(:,:,</span><span class="n">nstepread</span><span class="p">)</span> <span class="o">=</span> <span class="n">v0inletbc</span><span class="p">(:,:)</span>
<a name="ln-1332"></a>      <span class="n">storew0inletbc</span><span class="p">(:,:,</span><span class="n">nstepread</span><span class="p">)</span> <span class="o">=</span> <span class="n">w0inletbc</span><span class="p">(:,:)</span>
<a name="ln-1333"></a>      <span class="n">nstepread</span> <span class="o">=</span> <span class="n">nstepread</span> <span class="o">+</span><span class="mi">1</span>
<a name="ln-1334"></a>      <span class="k">if</span> <span class="p">(</span><span class="n">nstepread</span> <span class="o">==</span> <span class="n">nstore</span><span class="o">+</span><span class="mi">1</span><span class="p">)</span> <span class="k">then</span>
<a name="ln-1335"></a><span class="k">        </span><span class="n">nfile</span> <span class="o">=</span> <span class="n">nfile</span> <span class="o">+</span><span class="mi">1</span>       <span class="c">! next file number</span>
<a name="ln-1336"></a>        <span class="k">call </span><span class="n">writeinletfile</span>    <span class="c">! write 1000 time steps to file</span>
<a name="ln-1337"></a>        <span class="k">call </span><span class="n">writerestartfiles</span>
<a name="ln-1338"></a>        <span class="n">nstepread</span> <span class="o">=</span> <span class="mi">1</span>          <span class="c">! reset counter </span>
<a name="ln-1339"></a>      <span class="k">end if</span>   <span class="c">! nstepread == 1001      </span>
<a name="ln-1340"></a>    <span class="k">end if</span> <span class="c">! lstoreplane </span>
<a name="ln-1341"></a>    
<a name="ln-1342"></a>
<a name="ln-1343"></a>    <span class="k">if</span> <span class="p">(</span><span class="n">rk3step</span><span class="o">==</span><span class="mi">1</span><span class="p">)</span> <span class="k">then</span>
<a name="ln-1344"></a><span class="k">      </span><span class="n">uminletbc</span> <span class="o">=</span> <span class="n">u0inletbc</span>
<a name="ln-1345"></a>      <span class="n">vminletbc</span> <span class="o">=</span> <span class="n">v0inletbc</span>
<a name="ln-1346"></a>      <span class="n">wminletbc</span> <span class="o">=</span> <span class="n">w0inletbc</span>
<a name="ln-1347"></a>    <span class="k">end if</span>
<a name="ln-1348"></a>
<a name="ln-1349"></a><span class="c">!   call blthickness(di_test,utaui)</span>
<a name="ln-1350"></a>   <span class="k">call </span><span class="n">blthicknesst</span><span class="p">(</span><span class="n">di_test</span><span class="p">,</span><span class="n">Uinl</span><span class="p">,</span><span class="mf">0.99</span><span class="p">)</span>
<a name="ln-1351"></a>
<a name="ln-1352"></a><span class="c">!   call dispthickness(displ)  ! needed in top BC</span>
<a name="ln-1353"></a>   <span class="k">call </span><span class="n">dispthicknessexp</span><span class="p">(</span><span class="n">displ</span><span class="p">)</span>  <span class="c">! needed in top BC</span>
<a name="ln-1354"></a>
<a name="ln-1355"></a>   <span class="k">if</span> <span class="p">((</span><span class="n">myid</span><span class="o">==</span><span class="mi">0</span><span class="p">)</span> <span class="p">.</span><span class="nb">and</span><span class="p">.</span> <span class="p">(</span><span class="n">rk3step</span><span class="o">==</span><span class="mi">3</span><span class="p">))</span> <span class="k">then</span>
<a name="ln-1356"></a><span class="k">     write</span><span class="p">(</span><span class="mi">6</span><span class="p">,</span><span class="o">*</span><span class="p">)</span> <span class="s1">&#39;Inlet Gen: gamma=&#39;</span><span class="p">,</span><span class="n">gamm</span>
<a name="ln-1357"></a>     <span class="k">write</span><span class="p">(</span><span class="mi">6</span><span class="p">,</span><span class="o">*</span><span class="p">)</span> <span class="s1">&#39;Inlet Gen: Uinl(ke)=&#39;</span><span class="p">,</span><span class="n">Uinl</span><span class="p">(</span><span class="n">ke</span><span class="p">)</span>
<a name="ln-1358"></a>     <span class="k">write</span><span class="p">(</span><span class="mi">6</span><span class="p">,</span><span class="o">*</span><span class="p">)</span> <span class="s1">&#39;Inlet Gen: utaui,utaur =&#39;</span><span class="p">,</span><span class="n">utaui</span><span class="p">,</span><span class="n">utaur</span>
<a name="ln-1359"></a>     <span class="k">write</span><span class="p">(</span><span class="mi">6</span><span class="p">,</span><span class="o">*</span><span class="p">)</span> <span class="s1">&#39;Inlet Gen: deltar, deltai_test&#39;</span><span class="p">,</span> <span class="n">dr</span><span class="p">,</span> <span class="n">di_test</span>
<a name="ln-1360"></a>     <span class="k">write</span><span class="p">(</span><span class="mi">6</span><span class="p">,</span><span class="o">*</span><span class="p">)</span> <span class="s1">&#39;Inlet Gen: d*i, d*r=&#39;</span><span class="p">,</span><span class="n">displ</span><span class="p">(</span><span class="n">ib</span><span class="p">),</span><span class="n">displ</span><span class="p">(</span><span class="n">irecy</span><span class="p">)</span>
<a name="ln-1361"></a>     <span class="k">write</span><span class="p">(</span><span class="mi">6</span><span class="p">,</span><span class="o">*</span><span class="p">)</span> <span class="s1">&#39;Inlet Gen: thetai,thetar&#39;</span><span class="p">,</span><span class="n">thetai</span><span class="p">,</span><span class="n">thetar</span>
<a name="ln-1362"></a>     <span class="k">if</span> <span class="p">(</span><span class="n">luvolflowr</span> <span class="p">)</span> <span class="k">then</span>
<a name="ln-1363"></a><span class="k">       write</span><span class="p">(</span><span class="mi">6</span><span class="p">,</span><span class="o">*</span><span class="p">)</span> <span class="s1">&#39;Inlet Gen: mass flux correction factor = &#39;</span><span class="p">,</span><span class="n">scalef</span>
<a name="ln-1364"></a><span class="c">!       write(6,*) &#39;Inlet Gen: mass flux                   = &#39;,totalreadu</span>
<a name="ln-1365"></a>       <span class="k">write</span><span class="p">(</span><span class="mi">6</span><span class="p">,</span><span class="o">*</span><span class="p">)</span> <span class="s1">&#39;Inlet Gen: mass flux                   = &#39;</span><span class="p">,</span><span class="n">totaluinl</span>
<a name="ln-1366"></a>     <span class="k">end if</span>
<a name="ln-1367"></a><span class="k">   end if</span>
<a name="ln-1368"></a><span class="k">    </span>
<a name="ln-1369"></a><span class="k">    </span><span class="n">elseif</span> <span class="p">(</span><span class="n">iinletgen</span> <span class="o">==</span> <span class="mi">2</span><span class="p">)</span> <span class="k">then</span>
<a name="ln-1370"></a><span class="k">      if</span> <span class="p">(</span><span class="n">myid</span><span class="o">==</span><span class="mi">0</span><span class="p">)</span> <span class="k">then</span>
<a name="ln-1371"></a><span class="k">        write</span><span class="p">(</span><span class="mi">6</span><span class="p">,</span><span class="o">*</span><span class="p">)</span> <span class="s1">&#39;nstepread=&#39;</span><span class="p">,</span><span class="n">nstepread</span>
<a name="ln-1372"></a>      <span class="k">end if</span>
<a name="ln-1373"></a><span class="k">      </span><span class="n">u0inletbcold</span> <span class="o">=</span> <span class="n">u0inletbc</span>
<a name="ln-1374"></a>      <span class="n">v0inletbcold</span> <span class="o">=</span> <span class="n">v0inletbc</span>
<a name="ln-1375"></a>      <span class="n">w0inletbcold</span> <span class="o">=</span> <span class="n">w0inletbc</span>
<a name="ln-1376"></a>
<a name="ln-1377"></a>  <span class="c">! determine time step interval in simulation</span>
<a name="ln-1378"></a>      <span class="n">rk3coef</span>   <span class="o">=</span> <span class="n">dt</span> <span class="o">/</span> <span class="p">(</span><span class="mf">4.</span> <span class="o">-</span> <span class="nb">dble</span><span class="p">(</span><span class="n">rk3step</span><span class="p">))</span>
<a name="ln-1379"></a>      <span class="k">if</span> <span class="p">(</span><span class="n">rk3step</span><span class="o">==</span><span class="mi">1</span><span class="p">)</span> <span class="k">then</span>
<a name="ln-1380"></a><span class="k">        </span><span class="n">deltat</span> <span class="o">=</span> <span class="n">rk3coef</span>
<a name="ln-1381"></a>      <span class="n">elseif</span> <span class="p">(</span><span class="n">rk3step</span><span class="o">==</span><span class="mi">2</span><span class="p">)</span> <span class="k">then</span>
<a name="ln-1382"></a><span class="k">        </span><span class="n">deltat</span> <span class="o">=</span> <span class="n">rk3coef</span>   <span class="o">-</span> <span class="p">(</span><span class="n">dt</span><span class="o">/</span><span class="mf">3.</span><span class="p">)</span>
<a name="ln-1383"></a>      <span class="n">elseif</span> <span class="p">(</span><span class="n">rk3step</span><span class="o">==</span><span class="mi">3</span><span class="p">)</span> <span class="k">then</span>
<a name="ln-1384"></a><span class="k">        </span><span class="n">deltat</span> <span class="o">=</span> <span class="n">rk3coef</span> <span class="o">-</span> <span class="p">(</span><span class="n">dt</span><span class="o">/</span><span class="mf">2.</span><span class="p">)</span>
<a name="ln-1385"></a>      <span class="k">end if</span>
<a name="ln-1386"></a>  <span class="c">! determine time step interval in inlet data</span>
<a name="ln-1387"></a>      <span class="n">rk3coefin</span> <span class="o">=</span> <span class="n">dtin</span> <span class="o">/</span> <span class="p">(</span><span class="mf">4.</span> <span class="o">-</span> <span class="nb">dble</span><span class="p">(</span><span class="n">rk3stepin</span><span class="p">))</span>
<a name="ln-1388"></a>      <span class="k">if</span> <span class="p">(</span><span class="n">rk3stepin</span><span class="o">==</span><span class="mi">1</span><span class="p">)</span> <span class="k">then</span>
<a name="ln-1389"></a><span class="k">        </span><span class="n">dtinrk</span> <span class="o">=</span> <span class="n">rk3coefin</span>
<a name="ln-1390"></a>      <span class="n">elseif</span> <span class="p">(</span><span class="n">rk3stepin</span><span class="o">==</span><span class="mi">2</span><span class="p">)</span> <span class="k">then</span>
<a name="ln-1391"></a><span class="k">        </span><span class="n">dtinrk</span> <span class="o">=</span> <span class="n">rk3coefin</span> <span class="o">-</span> <span class="p">(</span><span class="n">dtin</span><span class="o">/</span><span class="mf">3.</span><span class="p">)</span>
<a name="ln-1392"></a>      <span class="n">elseif</span> <span class="p">(</span><span class="n">rk3stepin</span><span class="o">==</span><span class="mi">3</span><span class="p">)</span> <span class="k">then</span>
<a name="ln-1393"></a><span class="k">        </span><span class="n">dtinrk</span> <span class="o">=</span> <span class="n">rk3coefin</span> <span class="o">-</span> <span class="p">(</span><span class="n">dtin</span><span class="o">/</span><span class="mf">2.</span><span class="p">)</span>
<a name="ln-1394"></a>      <span class="k">end if</span>
<a name="ln-1395"></a><span class="k"> </span>
<a name="ln-1396"></a><span class="k">      </span><span class="n">interval</span> <span class="o">=</span> <span class="n">dtinrk</span> <span class="o">-</span> <span class="n">elapstep</span>
<a name="ln-1397"></a>      <span class="n">elapstep</span> <span class="o">=</span> <span class="n">elapstep</span> <span class="o">+</span> <span class="n">deltat</span>
<a name="ln-1398"></a>      <span class="k">if</span> <span class="p">(</span><span class="n">elapstep</span> <span class="o">&gt;</span> <span class="n">dtinrk</span><span class="p">)</span> <span class="k">then</span>      <span class="c">! use new value at next time step</span>
<a name="ln-1399"></a>        <span class="n">nstepread</span> <span class="o">=</span> <span class="n">nstepread</span> <span class="o">+</span><span class="mi">1</span>
<a name="ln-1400"></a>        <span class="n">elapstep</span> <span class="o">=</span> <span class="nb">mod</span><span class="p">(</span><span class="n">elapstep</span><span class="p">,</span><span class="n">dtinrk</span><span class="p">)</span>
<a name="ln-1401"></a>        <span class="n">rk3stepin</span> <span class="o">=</span> <span class="nb">mod</span><span class="p">(</span><span class="n">rk3stepin</span><span class="p">,</span><span class="mi">3</span><span class="p">)</span> <span class="o">+</span> <span class="mi">1</span>
<a name="ln-1402"></a>        <span class="n">rk3coefin</span> <span class="o">=</span> <span class="n">dtin</span> <span class="o">/</span> <span class="p">(</span><span class="mf">4.</span> <span class="o">-</span> <span class="nb">dble</span><span class="p">(</span><span class="n">rk3stepin</span><span class="p">))</span>
<a name="ln-1403"></a>        <span class="k">if</span> <span class="p">(</span><span class="n">rk3stepin</span><span class="o">==</span><span class="mi">1</span><span class="p">)</span> <span class="k">then</span>
<a name="ln-1404"></a><span class="k">          </span><span class="n">dtinrk</span> <span class="o">=</span> <span class="n">rk3coefin</span>
<a name="ln-1405"></a>        <span class="n">elseif</span> <span class="p">(</span><span class="n">rk3stepin</span><span class="o">==</span><span class="mi">2</span><span class="p">)</span> <span class="k">then</span>
<a name="ln-1406"></a><span class="k">          </span><span class="n">dtinrk</span> <span class="o">=</span> <span class="n">rk3coefin</span> <span class="o">-</span> <span class="p">(</span><span class="n">dtin</span><span class="o">/</span><span class="mf">3.</span><span class="p">)</span>
<a name="ln-1407"></a>        <span class="n">elseif</span> <span class="p">(</span><span class="n">rk3stepin</span><span class="o">==</span><span class="mi">3</span><span class="p">)</span> <span class="k">then</span>
<a name="ln-1408"></a><span class="k">          </span><span class="n">dtinrk</span> <span class="o">=</span> <span class="n">rk3coefin</span> <span class="o">-</span> <span class="p">(</span><span class="n">dtin</span><span class="o">/</span><span class="mf">2.</span><span class="p">)</span>
<a name="ln-1409"></a>        <span class="k">end if</span>
<a name="ln-1410"></a><span class="k">        </span><span class="n">u0inletbc</span><span class="p">(:,:)</span> <span class="o">=</span> <span class="n">storeu0inletbc</span><span class="p">(:,:,</span><span class="n">nstepread</span><span class="p">)</span>
<a name="ln-1411"></a>        <span class="n">v0inletbc</span><span class="p">(:,:)</span> <span class="o">=</span> <span class="n">storev0inletbc</span><span class="p">(:,:,</span><span class="n">nstepread</span><span class="p">)</span>
<a name="ln-1412"></a>        <span class="n">w0inletbc</span><span class="p">(:,:)</span> <span class="o">=</span> <span class="n">storew0inletbc</span><span class="p">(:,:,</span><span class="n">nstepread</span><span class="p">)</span>
<a name="ln-1413"></a>        <span class="k">if</span> <span class="p">(</span><span class="n">nstepread</span> <span class="o">==</span> <span class="n">nstore</span><span class="p">)</span> <span class="k">then</span>
<a name="ln-1414"></a><span class="k">          </span><span class="n">nfile</span> <span class="o">=</span> <span class="n">nfile</span> <span class="o">+</span> <span class="mi">1</span>
<a name="ln-1415"></a>          <span class="k">call </span><span class="n">readinletfile</span>
<a name="ln-1416"></a>          <span class="k">call </span><span class="n">writerestartfiles</span>
<a name="ln-1417"></a>          <span class="n">nstepread</span> <span class="o">=</span> <span class="mi">0</span>
<a name="ln-1418"></a>        <span class="k">end if</span>
<a name="ln-1419"></a><span class="k">        </span><span class="n">interval</span> <span class="o">=</span> <span class="n">dtinrk</span>
<a name="ln-1420"></a>        <span class="n">deltat</span> <span class="o">=</span> <span class="n">elapstep</span>
<a name="ln-1421"></a><span class="c">!        write(6,*) &#39;dtinrk,deltat=&#39;, dtinrk,deltat</span>
<a name="ln-1422"></a>      <span class="k">end if</span>
<a name="ln-1423"></a><span class="k">      </span><span class="n">u0inletbc</span><span class="p">(:,:)</span> <span class="o">=</span> <span class="p">(</span><span class="mf">1.</span> <span class="o">-</span> <span class="n">deltat</span><span class="o">/</span><span class="n">interval</span><span class="p">)</span><span class="o">*</span><span class="n">u0inletbc</span><span class="p">(:,:)</span> <span class="o">+</span> <span class="p">(</span><span class="n">deltat</span><span class="o">/</span><span class="n">interval</span><span class="p">)</span><span class="o">*</span><span class="n">storeu0inletbc</span><span class="p">(:,:,</span><span class="n">nstepread</span><span class="o">+</span><span class="mi">1</span><span class="p">)</span>
<a name="ln-1424"></a>      <span class="n">v0inletbc</span><span class="p">(:,:)</span> <span class="o">=</span> <span class="p">(</span><span class="mf">1.</span> <span class="o">-</span> <span class="n">deltat</span><span class="o">/</span><span class="n">interval</span><span class="p">)</span><span class="o">*</span><span class="n">v0inletbc</span><span class="p">(:,:)</span> <span class="o">+</span> <span class="p">(</span><span class="n">deltat</span><span class="o">/</span><span class="n">interval</span><span class="p">)</span><span class="o">*</span><span class="n">storev0inletbc</span><span class="p">(:,:,</span><span class="n">nstepread</span><span class="o">+</span><span class="mi">1</span><span class="p">)</span>
<a name="ln-1425"></a>      <span class="n">w0inletbc</span><span class="p">(:,:)</span> <span class="o">=</span> <span class="p">(</span><span class="mf">1.</span> <span class="o">-</span> <span class="n">deltat</span><span class="o">/</span><span class="n">interval</span><span class="p">)</span><span class="o">*</span><span class="n">w0inletbc</span><span class="p">(:,:)</span> <span class="o">+</span> <span class="p">(</span><span class="n">deltat</span><span class="o">/</span><span class="n">interval</span><span class="p">)</span><span class="o">*</span><span class="n">storew0inletbc</span><span class="p">(:,:,</span><span class="n">nstepread</span><span class="o">+</span><span class="mi">1</span><span class="p">)</span>
<a name="ln-1426"></a>
<a name="ln-1427"></a>
<a name="ln-1428"></a><span class="c">!! massflow correction</span>
<a name="ln-1429"></a>      <span class="n">uinletbc2</span><span class="p">(</span><span class="n">ib</span><span class="p">,</span><span class="n">jb</span><span class="p">:</span><span class="n">je</span><span class="p">,</span><span class="n">kb</span><span class="p">:</span><span class="n">ke</span><span class="p">)</span> <span class="o">=</span> <span class="n">u0inletbc</span><span class="p">(</span><span class="n">jb</span><span class="p">:</span><span class="n">je</span><span class="p">,</span><span class="n">kb</span><span class="p">:</span><span class="n">ke</span><span class="p">)</span>  <span class="c">! this is just a dummy variable to give uninletbc the right dimension in slabsum</span>
<a name="ln-1430"></a>      <span class="n">urav</span> <span class="o">=</span> <span class="mf">0.</span>
<a name="ln-1431"></a>      <span class="k">call </span><span class="n">slabsum</span><span class="p">(</span><span class="n">urav</span>  <span class="p">,</span><span class="n">kb</span><span class="p">,</span><span class="n">ke</span><span class="p">,</span><span class="n">uinletbc2</span> <span class="p">,</span><span class="n">ib</span><span class="p">,</span><span class="n">ib</span><span class="p">,</span><span class="n">jb</span><span class="p">,</span><span class="n">je</span><span class="p">,</span><span class="n">kb</span><span class="p">,</span><span class="n">ke</span><span class="p">,</span><span class="n">ib</span><span class="p">,</span><span class="n">ib</span><span class="p">,</span><span class="n">jb</span><span class="p">,</span><span class="n">je</span><span class="p">,</span><span class="n">kb</span><span class="p">,</span><span class="n">ke</span><span class="p">)</span>
<a name="ln-1432"></a>      <span class="n">urav</span> <span class="o">=</span> <span class="n">urav</span> <span class="o">/</span> <span class="p">(</span><span class="n">jge</span><span class="o">-</span><span class="n">jgb</span> <span class="o">+</span><span class="mi">1</span><span class="p">)</span>                    <span class="c">! average over j-direction</span>
<a name="ln-1433"></a>
<a name="ln-1434"></a>   <span class="c">! determine bulk velocity of new (interpolated) profile</span>
<a name="ln-1435"></a>      <span class="k">do </span><span class="n">k</span><span class="o">=</span><span class="n">kb</span><span class="p">,</span><span class="n">ke</span>
<a name="ln-1436"></a>        <span class="n">uravdzf</span><span class="p">(</span><span class="n">k</span><span class="p">)</span> <span class="o">=</span> <span class="n">urav</span><span class="p">(</span><span class="n">k</span><span class="p">)</span><span class="o">*</span><span class="n">dzf</span><span class="p">(</span><span class="n">k</span><span class="p">)</span>
<a name="ln-1437"></a>      <span class="k">end do</span>
<a name="ln-1438"></a><span class="k">      </span><span class="n">totalu</span>    <span class="o">=</span> <span class="nb">sum</span><span class="p">(</span><span class="n">uravdzf</span><span class="p">(</span><span class="n">kb</span><span class="p">:</span><span class="n">ke</span><span class="p">))</span><span class="o">/</span><span class="p">(</span><span class="n">zh</span><span class="p">(</span><span class="n">ke</span><span class="o">+</span><span class="mi">1</span><span class="p">)</span><span class="o">-</span><span class="n">zh</span><span class="p">(</span><span class="n">kb</span><span class="p">))</span>      <span class="c">! Area-averaged outflow velocity</span>
<a name="ln-1439"></a>
<a name="ln-1440"></a>   <span class="c">! rescale the instantaneous profile to keep mass flux constant (tot avoid pressure fluctuations)</span>
<a name="ln-1441"></a>      <span class="n">scalef</span> <span class="o">=</span> <span class="n">totalreadu</span><span class="o">/</span><span class="n">totalu</span> <span class="c">! compute factor to scale the velocity profile with</span>
<a name="ln-1442"></a>      <span class="n">u0inletbc</span><span class="p">(:,:)</span> <span class="o">=</span> <span class="n">u0inletbc</span><span class="p">(:,:)</span><span class="o">*</span><span class="n">scalef</span>  <span class="c">! rescale the velocity profile to have constant mass-flux</span>
<a name="ln-1443"></a><span class="c">!! end of massflow correction of interpolated streamwise velocity</span>
<a name="ln-1444"></a>
<a name="ln-1445"></a>
<a name="ln-1446"></a>
<a name="ln-1447"></a>      <span class="k">if</span> <span class="p">(</span><span class="n">rk3step</span><span class="o">==</span><span class="mi">1</span><span class="p">)</span> <span class="k">then</span>
<a name="ln-1448"></a><span class="k">        </span><span class="n">uminletbc</span> <span class="o">=</span> <span class="n">u0inletbc</span>
<a name="ln-1449"></a>        <span class="n">vminletbc</span> <span class="o">=</span> <span class="n">v0inletbc</span>
<a name="ln-1450"></a>        <span class="n">wminletbc</span> <span class="o">=</span> <span class="n">w0inletbc</span>
<a name="ln-1451"></a>      <span class="k">end if</span>
<a name="ln-1452"></a><span class="k">    end if</span>  <span class="c">! iinletgen</span>
<a name="ln-1453"></a>
<a name="ln-1454"></a>  <span class="k">end subroutine </span><span class="n">inletgennotemp</span>
<a name="ln-1455"></a>
<a name="ln-1456"></a>  <span class="k">subroutine </span><span class="n">momentumthicknessexp</span><span class="p">(</span><span class="n">output</span><span class="p">,</span><span class="n">uinput</span><span class="p">)</span>
<a name="ln-1457"></a>
<a name="ln-1458"></a>    <span class="k">use </span><span class="n">modglobal</span><span class="p">,</span> <span class="n">only</span> <span class="p">:</span> <span class="n">jb</span><span class="p">,</span><span class="n">kb</span><span class="p">,</span><span class="n">ke</span><span class="p">,</span><span class="n">dzf</span> <span class="c">!,Uinf</span>
<a name="ln-1459"></a>    <span class="k">use </span><span class="n">modinletdata</span><span class="p">,</span> <span class="n">only</span> <span class="p">:</span> <span class="n">ubulk</span>
<a name="ln-1460"></a>    <span class="k">use </span><span class="n">modmpi</span><span class="p">,</span> <span class="n">only</span>    <span class="p">:</span> <span class="n">myid</span>
<a name="ln-1461"></a>    <span class="k">implicit none</span>
<a name="ln-1462"></a>
<a name="ln-1463"></a><span class="k">       </span><span class="kt">real</span><span class="p">,</span> <span class="k">dimension</span><span class="p">(</span><span class="n">kb</span><span class="p">:</span><span class="n">ke</span><span class="p">),</span> <span class="k">intent</span><span class="p">(</span><span class="n">in</span><span class="p">)</span> <span class="kd">::</span> <span class="n">uinput</span>  <span class="c">!&lt; input velocity</span>
<a name="ln-1464"></a>       <span class="kt">real</span><span class="p">,</span> <span class="k">intent</span><span class="p">(</span><span class="n">out</span><span class="p">)</span>                  <span class="kd">::</span> <span class="n">output</span>  <span class="c">!&lt; momentum thickness</span>
<a name="ln-1465"></a>       <span class="kt">real</span><span class="p">,</span> <span class="k">dimension</span><span class="p">(</span><span class="n">kb</span><span class="p">:</span><span class="n">ke</span><span class="p">)</span>             <span class="kd">::</span> <span class="n">mthick</span>
<a name="ln-1466"></a><span class="c">!       real    :: umax</span>
<a name="ln-1467"></a>       <span class="kt">integer</span> <span class="kd">::</span> <span class="n">k</span> 
<a name="ln-1468"></a>     
<a name="ln-1469"></a><span class="c">!      write(6,*) &#39;uinletbc(jb,ke),Uinl(ke)=&#39;, uinletbc(jb,ke),uinput(ke)</span>
<a name="ln-1470"></a><span class="c">!       umax = maxval(uinput)</span>
<a name="ln-1471"></a>       <span class="k">do </span><span class="n">k</span><span class="o">=</span><span class="n">kb</span><span class="p">,</span><span class="n">ke</span>
<a name="ln-1472"></a>         <span class="n">mthick</span><span class="p">(</span><span class="n">k</span><span class="p">)</span> <span class="o">=</span> <span class="p">((</span><span class="n">uinput</span><span class="p">(</span><span class="n">k</span><span class="p">)</span><span class="o">/</span><span class="n">uinput</span><span class="p">(</span><span class="n">ke</span><span class="p">))</span> <span class="o">-</span> <span class="p">(</span><span class="n">uinput</span><span class="p">(</span><span class="n">k</span><span class="p">)</span><span class="o">**</span><span class="mf">2.</span> <span class="o">/</span> <span class="n">uinput</span><span class="p">(</span><span class="n">ke</span><span class="p">)</span><span class="o">**</span><span class="mf">2.</span><span class="p">)</span> <span class="p">)</span><span class="o">*</span><span class="n">dzf</span><span class="p">(</span><span class="n">k</span><span class="p">)</span>
<a name="ln-1473"></a><span class="c">!         mthick(k) = ((uinput(k)/umax) - (uinput(k)**2. / umax**2.) )*dzf(k)</span>
<a name="ln-1474"></a>
<a name="ln-1475"></a>       <span class="k">end do</span>
<a name="ln-1476"></a><span class="k">       </span><span class="n">output</span>   <span class="o">=</span> <span class="nb">sum</span><span class="p">(</span><span class="n">mthick</span><span class="p">)</span>  <span class="c">! momentum thickness</span>
<a name="ln-1477"></a>
<a name="ln-1478"></a>  <span class="k">end subroutine </span><span class="n">momentumthicknessexp</span>
<a name="ln-1479"></a>
<a name="ln-1480"></a>  <span class="k">subroutine </span><span class="n">momentumthickness</span><span class="p">(</span><span class="n">output</span><span class="p">,</span><span class="n">ustar</span><span class="p">,</span><span class="n">blth</span><span class="p">)</span>
<a name="ln-1481"></a>
<a name="ln-1482"></a>    <span class="k">use </span><span class="n">modglobal</span><span class="p">,</span> <span class="n">only</span> <span class="p">:</span> <span class="n">pi</span><span class="p">,</span><span class="n">Uinf</span>
<a name="ln-1483"></a><span class="c">!    use modinletdata, only : ubulk</span>
<a name="ln-1484"></a> <span class="c">!   use modmpi, only    : myid</span>
<a name="ln-1485"></a>    <span class="k">implicit none</span>
<a name="ln-1486"></a>
<a name="ln-1487"></a><span class="k">    </span><span class="kt">real</span><span class="p">,</span> <span class="k">intent</span><span class="p">(</span><span class="n">in</span><span class="p">)</span>                   <span class="kd">::</span> <span class="n">ustar</span>      <span class="c">! friction velocity</span>
<a name="ln-1488"></a>    <span class="kt">real</span><span class="p">,</span> <span class="k">intent</span><span class="p">(</span><span class="n">in</span><span class="p">)</span>                   <span class="kd">::</span> <span class="n">blth</span>       <span class="c">! boundary layer thickness</span>
<a name="ln-1489"></a>    <span class="kt">real</span><span class="p">,</span> <span class="k">intent</span><span class="p">(</span><span class="n">out</span><span class="p">)</span>                  <span class="kd">::</span> <span class="n">output</span>     <span class="c">! momentum thickness</span>
<a name="ln-1490"></a>    <span class="kt">real</span> <span class="kd">::</span> <span class="n">B</span>     <span class="o">=</span> <span class="mf">5.0</span>       <span class="c">! Wake parameter</span>
<a name="ln-1491"></a>    <span class="kt">real</span> <span class="kd">::</span> <span class="n">C</span>     <span class="o">=</span> <span class="mf">0.5</span>       <span class="c">! Coles parameter</span>
<a name="ln-1492"></a>    <span class="kt">real</span> <span class="kd">::</span> <span class="n">kappa</span> <span class="o">=</span> <span class="mf">0.41</span>      <span class="c">! Von k�r�n constant</span>
<a name="ln-1493"></a>    <span class="kt">real</span> <span class="kd">::</span> <span class="n">lam</span>               <span class="c">! = Uinf/ustar</span>
<a name="ln-1494"></a>   
<a name="ln-1495"></a>    <span class="n">lam</span> <span class="o">=</span> <span class="n">Uinf</span> <span class="o">/</span> <span class="n">ustar</span>
<a name="ln-1496"></a>    <span class="n">output</span> <span class="o">=</span> <span class="p">((</span><span class="mf">1.</span> <span class="o">+</span> <span class="n">C</span><span class="p">)</span><span class="o">/</span><span class="p">(</span><span class="n">kappa</span><span class="o">*</span><span class="n">lam</span><span class="p">)</span> <span class="o">-</span> <span class="p">(</span><span class="mf">1.</span><span class="o">/</span><span class="p">((</span> <span class="n">kappa</span><span class="o">**</span><span class="mi">2</span><span class="p">)</span><span class="o">*</span><span class="p">(</span><span class="n">lam</span><span class="o">**</span><span class="mi">2</span><span class="p">)))</span><span class="o">*</span><span class="p">(</span><span class="mf">2.</span> <span class="o">+</span> <span class="mf">2.</span><span class="o">*</span><span class="n">C</span><span class="o">*</span><span class="p">(</span><span class="mf">1.852</span><span class="o">/</span><span class="n">pi</span> <span class="o">+</span><span class="mf">1.</span><span class="p">)</span> <span class="o">+</span> <span class="p">(</span><span class="mf">3.</span><span class="o">/</span><span class="mf">2.</span><span class="p">)</span><span class="o">*</span><span class="p">(</span><span class="n">C</span><span class="o">**</span><span class="mi">2</span><span class="p">)))</span><span class="o">*</span> <span class="n">blth</span>
<a name="ln-1497"></a>    
<a name="ln-1498"></a>  <span class="k">end subroutine </span><span class="n">momentumthickness</span>
<a name="ln-1499"></a>
<a name="ln-1500"></a>  <span class="k">subroutine </span><span class="n">momentumthicknessmo</span><span class="p">(</span><span class="n">output</span><span class="p">,</span><span class="n">ustar</span><span class="p">,</span><span class="n">blth</span><span class="p">,</span><span class="n">lmo</span><span class="p">)</span>
<a name="ln-1501"></a>
<a name="ln-1502"></a>    <span class="k">use </span><span class="n">modglobal</span><span class="p">,</span> <span class="n">only</span> <span class="p">:</span> <span class="n">pi</span><span class="p">,</span><span class="n">Uinf</span>
<a name="ln-1503"></a><span class="c">!    use modinletdata, only : ubulk</span>
<a name="ln-1504"></a> <span class="c">!   use modmpi, only    : myid</span>
<a name="ln-1505"></a>    <span class="k">implicit none</span>
<a name="ln-1506"></a>
<a name="ln-1507"></a><span class="k">    </span><span class="kt">real</span><span class="p">,</span> <span class="k">intent</span><span class="p">(</span><span class="n">in</span><span class="p">)</span>                   <span class="kd">::</span> <span class="n">ustar</span>      <span class="c">! friction velocity</span>
<a name="ln-1508"></a>    <span class="kt">real</span><span class="p">,</span> <span class="k">intent</span><span class="p">(</span><span class="n">in</span><span class="p">)</span>                   <span class="kd">::</span> <span class="n">lmo</span>        <span class="c">! Obukhov length</span>
<a name="ln-1509"></a>    <span class="kt">real</span><span class="p">,</span> <span class="k">intent</span><span class="p">(</span><span class="n">in</span><span class="p">)</span>                   <span class="kd">::</span> <span class="n">blth</span>       <span class="c">! boundary layer thickness</span>
<a name="ln-1510"></a>    <span class="kt">real</span><span class="p">,</span> <span class="k">intent</span><span class="p">(</span><span class="n">out</span><span class="p">)</span>                  <span class="kd">::</span> <span class="n">output</span>     <span class="c">! momentum thickness</span>
<a name="ln-1511"></a>    <span class="kt">real</span> <span class="kd">::</span> <span class="n">B</span>     <span class="o">=</span> <span class="mf">5.0</span>       <span class="c">! Wake parameter</span>
<a name="ln-1512"></a>    <span class="kt">real</span> <span class="kd">::</span> <span class="n">C</span>     <span class="o">=</span> <span class="mf">0.5</span>       <span class="c">! Coles parameter</span>
<a name="ln-1513"></a>    <span class="kt">real</span> <span class="kd">::</span> <span class="n">kappa</span> <span class="o">=</span> <span class="mf">0.41</span>      <span class="c">! Von k�r�n constant</span>
<a name="ln-1514"></a>    <span class="kt">real</span> <span class="kd">::</span> <span class="n">cmo</span>   <span class="o">=</span> <span class="mf">0.702</span>     <span class="c">! constant in MO theory (0.135*5.2)</span>
<a name="ln-1515"></a>    <span class="kt">real</span> <span class="kd">::</span> <span class="n">lam</span>               <span class="c">! = Uinf/ustar</span>
<a name="ln-1516"></a>
<a name="ln-1517"></a>    <span class="n">lam</span> <span class="o">=</span> <span class="n">Uinf</span> <span class="o">/</span> <span class="n">ustar</span>
<a name="ln-1518"></a>    <span class="n">output</span> <span class="o">=</span> <span class="p">(</span><span class="mf">1.</span> <span class="o">+</span> <span class="n">C</span> <span class="o">+</span> <span class="mf">0.5</span><span class="o">*</span><span class="n">cmo</span><span class="o">*</span><span class="n">blth</span><span class="o">/</span><span class="n">lmo</span><span class="p">)</span><span class="o">/</span><span class="p">(</span><span class="n">kappa</span><span class="o">*</span><span class="n">lam</span><span class="p">)</span> <span class="o">-</span> <span class="p">(</span><span class="mf">1.</span><span class="o">/</span><span class="p">((</span> <span class="n">kappa</span><span class="o">**</span><span class="mi">2</span><span class="p">)</span><span class="o">*</span><span class="p">(</span><span class="n">lam</span><span class="o">**</span><span class="mi">2</span><span class="p">)))</span><span class="o">*</span><span class="p">(</span><span class="mf">2.</span> <span class="o">+</span> <span class="mf">2.</span><span class="o">*</span><span class="n">C</span><span class="o">*</span><span class="p">(</span><span class="mf">1.852</span><span class="o">/</span><span class="n">pi</span> <span class="o">+</span><span class="mf">1.</span><span class="p">)</span> <span class="o">+</span> <span class="p">(</span><span class="mf">3.</span><span class="o">/</span><span class="mf">2.</span><span class="p">)</span><span class="o">*</span><span class="p">(</span><span class="n">C</span><span class="o">**</span><span class="mi">2</span><span class="p">)</span> <span class="o">+</span> <span class="p">(</span><span class="n">blth</span><span class="o">-</span><span class="mf">0.25</span><span class="p">)</span><span class="o">*</span><span class="mf">2.</span><span class="o">*</span><span class="n">cmo</span><span class="o">/</span><span class="n">lmo</span> <span class="o">+</span> <span class="p">(</span><span class="mf">1.</span> <span class="o">+</span> <span class="mf">4.</span><span class="o">/</span><span class="n">pi</span><span class="p">)</span><span class="o">*</span><span class="n">blth</span><span class="o">*</span><span class="n">C</span><span class="o">*</span><span class="n">cmo</span><span class="o">/</span><span class="n">lmo</span> <span class="o">+</span> <span class="p">(</span><span class="mf">1.</span><span class="o">/</span><span class="mf">6.</span><span class="p">)</span><span class="o">*</span><span class="p">((</span><span class="n">cmo</span><span class="o">/</span><span class="n">lmo</span><span class="p">)</span><span class="o">**</span><span class="mi">2</span><span class="p">)</span><span class="o">*</span><span class="p">(</span><span class="n">blth</span><span class="o">**</span><span class="mi">2</span><span class="p">)</span> <span class="p">)</span><span class="o">*</span> <span class="n">blth</span>
<a name="ln-1519"></a>
<a name="ln-1520"></a>  <span class="k">end subroutine </span><span class="n">momentumthicknessmo</span>
<a name="ln-1521"></a>
<a name="ln-1522"></a> 
<a name="ln-1523"></a>  <span class="k">subroutine </span><span class="n">enthalpythickness</span><span class="p">(</span><span class="n">output</span><span class="p">,</span><span class="n">tinput</span><span class="p">,</span><span class="n">uinput</span><span class="p">)</span>
<a name="ln-1524"></a>
<a name="ln-1525"></a>    <span class="k">use </span><span class="n">modglobal</span><span class="p">,</span> <span class="n">only</span> <span class="p">:</span> <span class="n">jb</span><span class="p">,</span><span class="n">kb</span><span class="p">,</span><span class="n">ke</span><span class="p">,</span><span class="n">dzf</span> <span class="c">!,Uinf</span>
<a name="ln-1526"></a>    <span class="k">use </span><span class="n">modinletdata</span><span class="p">,</span> <span class="n">only</span> <span class="p">:</span> <span class="n">ubulk</span>
<a name="ln-1527"></a>    <span class="k">use </span><span class="n">modsurfdata</span><span class="p">,</span> <span class="n">only</span> <span class="p">:</span> <span class="n">thls</span>
<a name="ln-1528"></a>    <span class="k">use </span><span class="n">modmpi</span><span class="p">,</span> <span class="n">only</span>    <span class="p">:</span> <span class="n">myid</span>
<a name="ln-1529"></a>    <span class="k">implicit none</span>
<a name="ln-1530"></a>
<a name="ln-1531"></a><span class="k">       </span><span class="kt">real</span><span class="p">,</span> <span class="k">dimension</span><span class="p">(</span><span class="n">kb</span><span class="p">:</span><span class="n">ke</span><span class="p">),</span> <span class="k">intent</span><span class="p">(</span><span class="n">in</span><span class="p">)</span> <span class="kd">::</span> <span class="n">tinput</span>  <span class="c">!&lt; input temperature</span>
<a name="ln-1532"></a>       <span class="kt">real</span><span class="p">,</span> <span class="k">dimension</span><span class="p">(</span><span class="n">kb</span><span class="p">:</span><span class="n">ke</span><span class="p">),</span> <span class="k">intent</span><span class="p">(</span><span class="n">in</span><span class="p">)</span> <span class="kd">::</span> <span class="n">uinput</span>  <span class="c">!&lt; input velocity</span>
<a name="ln-1533"></a>       <span class="kt">real</span><span class="p">,</span> <span class="k">intent</span><span class="p">(</span><span class="n">out</span><span class="p">)</span>                  <span class="kd">::</span> <span class="n">output</span>  <span class="c">!&lt; momentum thickness</span>
<a name="ln-1534"></a>       <span class="kt">real</span><span class="p">,</span> <span class="k">dimension</span><span class="p">(</span><span class="n">kb</span><span class="p">:</span><span class="n">ke</span><span class="p">)</span>             <span class="kd">::</span> <span class="n">ethick</span> 
<a name="ln-1535"></a>       <span class="kt">real </span><span class="n">thlsdummy</span>
<a name="ln-1536"></a>       <span class="kt">integer</span> <span class="kd">::</span> <span class="n">k</span> 
<a name="ln-1537"></a>       
<a name="ln-1538"></a>       <span class="n">thlsdummy</span> <span class="o">=</span> <span class="n">thls</span>
<a name="ln-1539"></a>       <span class="k">if</span> <span class="p">(</span><span class="n">tinput</span><span class="p">(</span><span class="n">ke</span><span class="p">)</span> <span class="o">==</span> <span class="n">thls</span><span class="p">)</span> <span class="k">then</span>
<a name="ln-1540"></a><span class="k">         </span><span class="n">thlsdummy</span> <span class="o">=</span> <span class="n">thls</span> <span class="o">-</span><span class="mf">0.000001</span>
<a name="ln-1541"></a>       <span class="k">end if </span>
<a name="ln-1542"></a><span class="k">       do </span><span class="n">k</span><span class="o">=</span><span class="n">kb</span><span class="p">,</span><span class="n">ke</span>
<a name="ln-1543"></a><span class="c">!         ethick(k) = (uinput(k)/uinput(ke)) * ((tinput(k) - tinput(ke)) /(thls - tinput(ke)) )*dzf(k)</span>
<a name="ln-1544"></a>         <span class="n">ethick</span><span class="p">(</span><span class="n">k</span><span class="p">)</span> <span class="o">=</span> <span class="p">(</span><span class="n">uinput</span><span class="p">(</span><span class="n">k</span><span class="p">)</span><span class="o">/</span><span class="n">uinput</span><span class="p">(</span><span class="n">ke</span><span class="p">))</span> <span class="o">*</span> <span class="p">((</span><span class="n">tinput</span><span class="p">(</span><span class="n">k</span><span class="p">)</span> <span class="o">-</span> <span class="n">tinput</span><span class="p">(</span><span class="n">ke</span><span class="p">))</span> <span class="o">/</span><span class="p">(</span><span class="n">thlsdummy</span> <span class="o">-</span> <span class="n">tinput</span><span class="p">(</span><span class="n">ke</span><span class="p">))</span> <span class="p">)</span><span class="o">*</span><span class="n">dzf</span><span class="p">(</span><span class="n">k</span><span class="p">)</span>
<a name="ln-1545"></a>
<a name="ln-1546"></a>       <span class="k">end do</span>
<a name="ln-1547"></a><span class="k">       </span><span class="n">output</span>   <span class="o">=</span> <span class="nb">sum</span><span class="p">(</span><span class="n">ethick</span><span class="p">)</span>  <span class="c">! enthalpy thickness</span>
<a name="ln-1548"></a>       <span class="k">if</span> <span class="p">(</span><span class="n">output</span><span class="o">==</span><span class="mf">0.</span><span class="p">)</span> <span class="k">then</span>
<a name="ln-1549"></a><span class="k">         </span><span class="n">output</span><span class="o">=</span> <span class="mf">0.000001</span>
<a name="ln-1550"></a>       <span class="k">end if</span>
<a name="ln-1551"></a>
<a name="ln-1552"></a><span class="k">  end subroutine </span><span class="n">enthalpythickness</span>
<a name="ln-1553"></a>
<a name="ln-1554"></a>
<a name="ln-1555"></a> 
<a name="ln-1556"></a>  <span class="k">subroutine </span><span class="n">dispthicknessexp</span><span class="p">(</span><span class="n">output</span><span class="p">)</span>
<a name="ln-1557"></a><span class="c">! output is an array of length (ib:ie)) containing displacement thickness values</span>
<a name="ln-1558"></a>    <span class="k">use </span><span class="n">modglobal</span><span class="p">,</span> <span class="n">only</span> <span class="p">:</span> <span class="n">ib</span><span class="p">,</span><span class="n">ie</span><span class="p">,</span><span class="n">kb</span><span class="p">,</span><span class="n">ke</span><span class="p">,</span><span class="n">dzf</span><span class="p">,</span><span class="n">xf</span><span class="c">!,Uinf</span>
<a name="ln-1559"></a>    <span class="k">implicit none</span>
<a name="ln-1560"></a>
<a name="ln-1561"></a><span class="k">       </span><span class="kt">real</span><span class="p">,</span> <span class="k">dimension</span><span class="p">(</span><span class="n">ib</span><span class="p">:</span><span class="n">ie</span><span class="p">),</span>       <span class="k">intent</span><span class="p">(</span><span class="n">out</span><span class="p">)</span> <span class="kd">::</span> <span class="n">output</span>  <span class="c">!&lt; dispacement thickness</span>
<a name="ln-1562"></a>       <span class="kt">real</span><span class="p">,</span> <span class="k">dimension</span><span class="p">(</span><span class="n">kb</span><span class="p">:</span><span class="n">ke</span><span class="p">)</span>                    <span class="kd">::</span> <span class="n">dthick</span>
<a name="ln-1563"></a><span class="c">!       real    :: umax</span>
<a name="ln-1564"></a>       <span class="kt">real</span>    <span class="kd">::</span> <span class="n">dispm</span>
<a name="ln-1565"></a>       <span class="kt">real</span>    <span class="kd">::</span> <span class="n">disp2m</span>
<a name="ln-1566"></a>       <span class="kt">real</span>    <span class="kd">::</span> <span class="n">xfdispm</span>
<a name="ln-1567"></a>       <span class="kt">integer</span> <span class="kd">::</span> <span class="n">i</span><span class="p">,</span><span class="n">k</span> 
<a name="ln-1568"></a>     
<a name="ln-1569"></a>     <span class="c">! write(6,*) &#39;Uinl(ke)=&#39;, uinput(ke)</span>
<a name="ln-1570"></a>       <span class="k">do </span><span class="n">i</span><span class="o">=</span><span class="n">ib</span><span class="p">,</span><span class="n">ie</span>
<a name="ln-1571"></a><span class="c">!       umax = maxval(Utav(i,:))</span>
<a name="ln-1572"></a>       <span class="k">do </span><span class="n">k</span><span class="o">=</span><span class="n">kb</span><span class="p">,</span><span class="n">ke</span>
<a name="ln-1573"></a>         <span class="n">dthick</span><span class="p">(</span><span class="n">k</span><span class="p">)</span> <span class="o">=</span> <span class="p">(</span><span class="mf">1.</span><span class="o">-</span> <span class="n">Utav</span><span class="p">(</span><span class="n">i</span><span class="p">,</span><span class="n">k</span><span class="p">)</span><span class="o">/</span> <span class="n">Utav</span><span class="p">(</span><span class="n">i</span><span class="p">,</span><span class="n">ke</span><span class="p">))</span> <span class="o">*</span><span class="n">dzf</span><span class="p">(</span><span class="n">k</span><span class="p">)</span>       <span class="c">! time-averaged, j-averaged velocity</span>
<a name="ln-1574"></a><span class="c">!         dthick(k) = (1.- Utav(i,k)/ umax) *dzf(k)       ! time-averaged, j-averaged velocity</span>
<a name="ln-1575"></a>
<a name="ln-1576"></a>       <span class="k">end do</span>
<a name="ln-1577"></a><span class="k">       </span><span class="n">output</span><span class="p">(</span><span class="n">i</span><span class="p">)</span>   <span class="o">=</span> <span class="nb">sum</span><span class="p">(</span><span class="n">dthick</span><span class="p">)</span>  <span class="c">! displacement thickness</span>
<a name="ln-1578"></a>       <span class="k">end do</span>
<a name="ln-1579"></a>
<a name="ln-1580"></a><span class="k">       </span><span class="n">dispm</span>  <span class="o">=</span> <span class="nb">sum</span><span class="p">(</span><span class="n">output</span><span class="p">(</span><span class="n">ib</span><span class="p">:</span><span class="n">ie</span><span class="p">))</span><span class="o">/</span><span class="p">(</span><span class="n">ie</span><span class="o">-</span><span class="n">ib</span><span class="o">+</span><span class="mi">1</span><span class="p">)</span>      <span class="c">! mean(displacement)</span>
<a name="ln-1581"></a>       <span class="n">disp2m</span> <span class="o">=</span> <span class="nb">sum</span><span class="p">(</span><span class="n">output</span><span class="p">(</span><span class="n">ib</span><span class="p">:</span><span class="n">ie</span><span class="p">)</span><span class="o">**</span><span class="mf">2.</span><span class="p">)</span><span class="o">/</span><span class="p">(</span><span class="n">ie</span><span class="o">-</span><span class="n">ib</span><span class="o">+</span><span class="mi">1</span><span class="p">)</span>   <span class="c">! mean(displacement^2)</span>
<a name="ln-1582"></a>       <span class="n">xfdispm</span>  <span class="o">=</span> <span class="nb">sum</span><span class="p">(</span><span class="n">xf</span><span class="p">(</span><span class="n">ib</span><span class="p">:</span><span class="n">ie</span><span class="p">)</span><span class="o">*</span><span class="n">output</span><span class="p">(</span><span class="n">ib</span><span class="p">:</span><span class="n">ie</span><span class="p">))</span><span class="o">/</span><span class="p">(</span><span class="n">ie</span><span class="o">-</span><span class="n">ib</span><span class="o">+</span><span class="mi">1</span><span class="p">)</span>     <span class="c">! mean(xf*displ) </span>
<a name="ln-1583"></a>
<a name="ln-1584"></a>       <span class="n">ddispdx</span> <span class="o">=</span> <span class="p">(</span><span class="n">xfdispm</span> <span class="o">-</span> <span class="p">(</span><span class="n">xfm</span><span class="o">*</span><span class="n">dispm</span><span class="p">))</span> <span class="o">/</span> <span class="p">(</span><span class="n">xf2m</span> <span class="o">-</span><span class="n">xfm</span><span class="o">**</span><span class="mf">2.</span><span class="p">)</span>    <span class="c">! this is d/dx(delta*)</span>
<a name="ln-1585"></a><span class="c">!       ddispdx = 0.    ! for the test</span>
<a name="ln-1586"></a><span class="c">!       dinl    = dispm - ddispdx*xfm                         ! this is the starting value (delta* = dinl + d/dx(delta)*x)</span>
<a name="ln-1587"></a>
<a name="ln-1588"></a>  <span class="k">end subroutine </span><span class="n">dispthicknessexp</span>
<a name="ln-1589"></a>
<a name="ln-1590"></a>  <span class="k">subroutine </span><span class="n">dispthickness</span><span class="p">(</span><span class="n">output</span><span class="p">)</span>
<a name="ln-1591"></a><span class="c">! output is an array of length (ib:ie)) containing displacement thickness values</span>
<a name="ln-1592"></a>    <span class="k">use </span><span class="n">modglobal</span><span class="p">,</span> <span class="n">only</span> <span class="p">:</span> <span class="n">ib</span><span class="p">,</span><span class="n">ie</span><span class="p">,</span><span class="n">kb</span><span class="p">,</span><span class="n">ke</span><span class="p">,</span><span class="n">dzf</span><span class="p">,</span><span class="n">xf</span><span class="p">,</span><span class="n">Uinf</span><span class="p">,</span><span class="n">numol</span>
<a name="ln-1593"></a>    <span class="k">implicit none</span>
<a name="ln-1594"></a>
<a name="ln-1595"></a><span class="k">       </span><span class="kt">real</span><span class="p">,</span> <span class="k">dimension</span><span class="p">(</span><span class="n">ib</span><span class="p">:</span><span class="n">ie</span><span class="p">),</span>       <span class="k">intent</span><span class="p">(</span><span class="n">out</span><span class="p">)</span> <span class="kd">::</span> <span class="n">output</span>  <span class="c">!&lt; dispacement thickness</span>
<a name="ln-1596"></a><span class="c">!       real, dimension(kb:ke)                    :: dthick</span>
<a name="ln-1597"></a>       <span class="kt">real</span>    <span class="kd">::</span> <span class="n">dispm</span>
<a name="ln-1598"></a>       <span class="kt">real</span>    <span class="kd">::</span> <span class="n">disp2m</span>
<a name="ln-1599"></a>       <span class="kt">real</span>    <span class="kd">::</span> <span class="n">xfdispm</span>
<a name="ln-1600"></a>       <span class="kt">real</span>    <span class="kd">::</span> <span class="n">ustar</span><span class="p">,</span><span class="n">blth</span>
<a name="ln-1601"></a>       <span class="kt">real</span>    <span class="kd">::</span> <span class="n">B</span>     <span class="o">=</span> <span class="mf">5.0</span>       <span class="c">! Wake parameter</span>
<a name="ln-1602"></a>       <span class="kt">real</span>    <span class="kd">::</span> <span class="n">C</span>     <span class="o">=</span> <span class="mf">0.5</span>       <span class="c">! Coles parameter</span>
<a name="ln-1603"></a>       <span class="kt">real</span>    <span class="kd">::</span> <span class="n">kappa</span> <span class="o">=</span> <span class="mf">0.41</span>      <span class="c">! Von k�r�n constant</span>
<a name="ln-1604"></a>       <span class="kt">real</span>    <span class="kd">::</span> <span class="n">lam</span>               <span class="c">! = Uinf/ustar</span>
<a name="ln-1605"></a>       <span class="kt">integer</span> <span class="kd">::</span> <span class="n">i</span>
<a name="ln-1606"></a>   
<a name="ln-1607"></a>
<a name="ln-1608"></a>       <span class="k">do </span><span class="n">i</span><span class="o">=</span><span class="n">ib</span><span class="p">,</span><span class="n">ie</span>
<a name="ln-1609"></a>         <span class="n">ustar</span>     <span class="o">=</span>  <span class="nb">sqrt</span><span class="p">(</span><span class="nb">abs</span><span class="p">(</span><span class="mi">2</span><span class="o">*</span><span class="n">numol</span><span class="o">*</span> <span class="n">Utav</span><span class="p">(</span><span class="n">i</span><span class="p">,</span><span class="n">kb</span><span class="p">)</span><span class="o">/</span><span class="n">dzf</span><span class="p">(</span><span class="n">kb</span><span class="p">)))</span>              <span class="c">! average streamwise friction</span>
<a name="ln-1610"></a>         <span class="n">lam</span>       <span class="o">=</span> <span class="n">Uinf</span> <span class="o">/</span> <span class="n">ustar</span>
<a name="ln-1611"></a>         <span class="n">blth</span>      <span class="o">=</span> <span class="p">(</span><span class="n">lam</span><span class="o">*</span><span class="n">numol</span><span class="o">/</span><span class="n">Uinf</span><span class="p">)</span> <span class="o">*</span> <span class="nb">exp</span><span class="p">(</span> <span class="n">kappa</span> <span class="o">*</span> <span class="p">(</span><span class="n">lam</span> <span class="o">-</span> <span class="n">B</span><span class="p">)</span> <span class="o">-</span> <span class="mf">2.</span><span class="o">*</span><span class="n">C</span><span class="p">)</span>      <span class="c">! See App. Lund et al.</span>
<a name="ln-1612"></a>         <span class="n">output</span><span class="p">(</span><span class="n">i</span><span class="p">)</span> <span class="o">=</span> <span class="p">((</span><span class="mf">1.</span> <span class="o">+</span> <span class="n">C</span><span class="p">)</span> <span class="o">/</span> <span class="p">(</span><span class="n">kappa</span><span class="o">*</span><span class="n">lam</span><span class="p">)</span> <span class="p">)</span> <span class="o">*</span> <span class="n">blth</span>                 
<a name="ln-1613"></a>       <span class="k">end do</span>
<a name="ln-1614"></a><span class="k">       </span><span class="n">dispm</span>  <span class="o">=</span> <span class="nb">sum</span><span class="p">(</span><span class="n">output</span><span class="p">(</span><span class="n">ib</span><span class="p">:</span><span class="n">ie</span><span class="p">))</span><span class="o">/</span><span class="p">(</span><span class="n">ie</span><span class="o">-</span><span class="n">ib</span><span class="o">+</span><span class="mi">1</span><span class="p">)</span>      <span class="c">! mean(displacement)</span>
<a name="ln-1615"></a>       <span class="n">disp2m</span> <span class="o">=</span> <span class="nb">sum</span><span class="p">(</span><span class="n">output</span><span class="p">(</span><span class="n">ib</span><span class="p">:</span><span class="n">ie</span><span class="p">)</span><span class="o">**</span><span class="mf">2.</span><span class="p">)</span><span class="o">/</span><span class="p">(</span><span class="n">ie</span><span class="o">-</span><span class="n">ib</span><span class="o">+</span><span class="mi">1</span><span class="p">)</span>   <span class="c">! mean(displacement^2)</span>
<a name="ln-1616"></a>       <span class="n">xfdispm</span>  <span class="o">=</span> <span class="nb">sum</span><span class="p">(</span><span class="n">xf</span><span class="p">(</span><span class="n">ib</span><span class="p">:</span><span class="n">ie</span><span class="p">)</span><span class="o">*</span><span class="n">output</span><span class="p">(</span><span class="n">ib</span><span class="p">:</span><span class="n">ie</span><span class="p">))</span><span class="o">/</span><span class="p">(</span><span class="n">ie</span><span class="o">-</span><span class="n">ib</span><span class="o">+</span><span class="mi">1</span><span class="p">)</span>     <span class="c">! mean(xf*displ)</span>
<a name="ln-1617"></a>
<a name="ln-1618"></a>       <span class="n">ddispdx</span> <span class="o">=</span> <span class="p">(</span><span class="n">xfdispm</span> <span class="o">-</span> <span class="p">(</span><span class="n">xfm</span><span class="o">*</span><span class="n">dispm</span><span class="p">))</span> <span class="o">/</span> <span class="p">(</span><span class="n">xf2m</span> <span class="o">-</span><span class="n">xfm</span><span class="o">**</span><span class="mf">2.</span><span class="p">)</span>    <span class="c">! this is d/dx(delta*)</span>
<a name="ln-1619"></a>
<a name="ln-1620"></a>
<a name="ln-1621"></a>  <span class="k">end subroutine </span><span class="n">dispthickness</span>
<a name="ln-1622"></a>
<a name="ln-1623"></a>  <span class="k">subroutine </span><span class="n">dispthicknessmo</span><span class="p">(</span><span class="n">output</span><span class="p">)</span>
<a name="ln-1624"></a><span class="c">! output is an array of length (ib:ie)) containing displacement thickness values</span>
<a name="ln-1625"></a>    <span class="k">use </span><span class="n">modglobal</span><span class="p">,</span> <span class="n">only</span> <span class="p">:</span> <span class="n">ib</span><span class="p">,</span><span class="n">ie</span><span class="p">,</span><span class="n">kb</span><span class="p">,</span><span class="n">ke</span><span class="p">,</span><span class="n">dzf</span><span class="p">,</span><span class="n">xf</span><span class="p">,</span><span class="n">Uinf</span><span class="p">,</span><span class="n">numol</span><span class="p">,</span><span class="n">grav</span><span class="p">,</span><span class="n">prandtlmoli</span>
<a name="ln-1626"></a>    <span class="k">use </span><span class="n">modsurfdata</span><span class="p">,</span> <span class="n">only</span> <span class="p">:</span> <span class="n">thls</span>
<a name="ln-1627"></a>    <span class="k">implicit none</span>
<a name="ln-1628"></a>
<a name="ln-1629"></a><span class="k">       </span><span class="kt">real</span><span class="p">,</span> <span class="k">dimension</span><span class="p">(</span><span class="n">ib</span><span class="p">:</span><span class="n">ie</span><span class="p">),</span>       <span class="k">intent</span><span class="p">(</span><span class="n">out</span><span class="p">)</span> <span class="kd">::</span> <span class="n">output</span>  <span class="c">!&lt; dispacement thickness</span>
<a name="ln-1630"></a><span class="c">!       real, dimension(kb:ke)                    :: dthick</span>
<a name="ln-1631"></a>       <span class="kt">real</span>    <span class="kd">::</span> <span class="n">dispm</span>
<a name="ln-1632"></a>       <span class="kt">real</span>    <span class="kd">::</span> <span class="n">disp2m</span>
<a name="ln-1633"></a>       <span class="kt">real</span>    <span class="kd">::</span> <span class="n">xfdispm</span>
<a name="ln-1634"></a>       <span class="kt">real</span>    <span class="kd">::</span> <span class="n">ustar</span><span class="p">,</span><span class="n">tstar</span><span class="p">,</span><span class="n">blth</span>
<a name="ln-1635"></a>       <span class="kt">real</span>    <span class="kd">::</span> <span class="n">B</span>     <span class="o">=</span> <span class="mf">5.0</span>       <span class="c">! Wake parameter</span>
<a name="ln-1636"></a>       <span class="kt">real</span>    <span class="kd">::</span> <span class="n">C</span>     <span class="o">=</span> <span class="mf">0.5</span>       <span class="c">! Coles parameter</span>
<a name="ln-1637"></a>       <span class="kt">real</span>    <span class="kd">::</span> <span class="n">kappa</span> <span class="o">=</span> <span class="mf">0.41</span>      <span class="c">! Von k�rm�n constant</span>
<a name="ln-1638"></a>       <span class="kt">real</span>    <span class="kd">::</span> <span class="n">cmo</span>   <span class="o">=</span> <span class="mf">0.702</span>     <span class="c">! constant in MO theory (0.135*5.2)</span>
<a name="ln-1639"></a>       <span class="kt">real</span>    <span class="kd">::</span> <span class="n">lam</span>               <span class="c">! = Uinf/ustar</span>
<a name="ln-1640"></a>       <span class="kt">real</span>    <span class="kd">::</span> <span class="n">func</span><span class="p">,</span><span class="n">dfunc</span><span class="p">,</span><span class="n">utaunu</span><span class="p">,</span><span class="n">lmo</span>
<a name="ln-1641"></a>       <span class="kt">integer</span> <span class="kd">::</span> <span class="n">i</span><span class="p">,</span><span class="n">n</span>
<a name="ln-1642"></a>
<a name="ln-1643"></a>       <span class="n">blth</span>      <span class="o">=</span> <span class="n">di</span>      <span class="c">! initial value </span>
<a name="ln-1644"></a>       <span class="k">do </span><span class="n">i</span><span class="o">=</span><span class="n">ib</span><span class="p">,</span><span class="n">ie</span>      
<a name="ln-1645"></a>         <span class="n">ustar</span>     <span class="o">=</span> <span class="nb">sqrt</span><span class="p">(</span><span class="nb">abs</span><span class="p">(</span><span class="mf">2.</span><span class="o">*</span><span class="n">numol</span><span class="o">*</span> <span class="n">Utav</span><span class="p">(</span><span class="n">i</span><span class="p">,</span><span class="n">kb</span><span class="p">)</span><span class="o">/</span><span class="n">dzf</span><span class="p">(</span><span class="n">kb</span><span class="p">)))</span>              <span class="c">! average streamwise friction at x-location</span>
<a name="ln-1646"></a>         <span class="n">tstar</span>     <span class="o">=</span> <span class="n">numol</span><span class="o">*</span><span class="n">prandtlmoli</span><span class="o">*</span> <span class="mf">2.</span><span class="o">*</span><span class="p">(</span><span class="n">Ttav</span><span class="p">(</span><span class="n">i</span><span class="p">,</span><span class="n">kb</span><span class="p">)</span><span class="o">-</span><span class="n">thls</span><span class="p">)</span><span class="o">/</span><span class="p">(</span><span class="n">dzf</span><span class="p">(</span><span class="n">kb</span><span class="p">)</span><span class="o">*</span><span class="n">ustar</span><span class="p">)</span>    <span class="c">! average shear temp. at x-location</span>
<a name="ln-1647"></a>         <span class="n">lmo</span>       <span class="o">=</span> <span class="p">(</span><span class="n">thls</span><span class="o">*</span><span class="n">ustar</span><span class="o">**</span><span class="mi">2</span><span class="p">)</span><span class="o">/</span><span class="p">(</span><span class="n">kappa</span><span class="o">*</span><span class="n">grav</span><span class="o">*</span><span class="n">tstar</span><span class="p">)</span>                  <span class="c">! obukhov length at this x-location</span>
<a name="ln-1648"></a>         <span class="k">if</span> <span class="p">((</span><span class="n">lmo</span> <span class="o">&gt;=</span> <span class="mi">1000</span><span class="mf">0.</span><span class="p">)</span> <span class="p">.</span><span class="nb">or</span><span class="p">.</span> <span class="p">(</span><span class="n">lmo</span> <span class="o">&lt;=</span> <span class="mf">0.01</span><span class="p">))</span> <span class="k">then</span>
<a name="ln-1649"></a><span class="k">           </span><span class="n">lmo</span> <span class="o">=</span> <span class="mi">100</span><span class="mf">0.</span>
<a name="ln-1650"></a>         <span class="k">end if</span>
<a name="ln-1651"></a><span class="c">!         lmo = 0.3  !! TEMPORARY</span>
<a name="ln-1652"></a>         <span class="n">utaunu</span>    <span class="o">=</span> <span class="n">ustar</span> <span class="o">/</span> <span class="n">numol</span>
<a name="ln-1653"></a>         <span class="n">lam</span>       <span class="o">=</span> <span class="n">Uinf</span> <span class="o">/</span> <span class="n">ustar</span>
<a name="ln-1654"></a>         <span class="k">do </span><span class="n">n</span><span class="o">=</span><span class="mi">1</span><span class="p">,</span><span class="mi">10</span>   <span class="c">! Newton Raphson method to find BL height</span>
<a name="ln-1655"></a><span class="c">!           write(6,*) &#39;blth,ustar,tstar,Lmo =&#39;,blth,ustar,tstar,lmo</span>
<a name="ln-1656"></a>           <span class="n">func</span>   <span class="o">=</span> <span class="nb">log</span><span class="p">(</span><span class="n">blth</span><span class="p">)</span> <span class="o">+</span> <span class="p">(</span><span class="n">cmo</span><span class="o">*</span><span class="n">blth</span><span class="o">/</span><span class="n">lmo</span><span class="p">)</span> <span class="o">+</span> <span class="nb">log</span><span class="p">(</span><span class="n">utaunu</span><span class="p">)</span> <span class="o">-</span> <span class="n">kappa</span><span class="o">*</span><span class="p">(</span><span class="n">lam</span><span class="o">-</span><span class="n">B</span><span class="p">)</span> <span class="o">+</span><span class="mf">2.</span><span class="o">*</span><span class="n">C</span>
<a name="ln-1657"></a><span class="c">!           func   = log(blth) + log(utaunu) - kappa*(lam-B) +2.*C</span>
<a name="ln-1658"></a>           <span class="n">dfunc</span>  <span class="o">=</span> <span class="mf">1.</span><span class="o">/</span><span class="n">blth</span> <span class="o">+</span> <span class="n">cmo</span><span class="o">/</span><span class="n">lmo</span>
<a name="ln-1659"></a>           <span class="n">blth</span>   <span class="o">=</span> <span class="n">blth</span> <span class="o">-</span> <span class="p">(</span><span class="n">func</span> <span class="o">/</span> <span class="n">dfunc</span><span class="p">)</span>
<a name="ln-1660"></a>           <span class="k">if</span> <span class="p">(</span><span class="n">blth</span> <span class="o">&lt;=</span> <span class="mf">0.</span><span class="p">)</span> <span class="k">then</span>
<a name="ln-1661"></a><span class="k">             </span><span class="n">blth</span> <span class="o">=</span> <span class="n">di</span>
<a name="ln-1662"></a>           <span class="k">end if</span>
<a name="ln-1663"></a><span class="k">         end do</span>
<a name="ln-1664"></a><span class="k">         </span><span class="n">output</span><span class="p">(</span><span class="n">i</span><span class="p">)</span> <span class="o">=</span> <span class="p">((</span><span class="mf">1.</span> <span class="o">+</span> <span class="n">C</span> <span class="o">+</span> <span class="mf">0.5</span><span class="o">*</span><span class="n">cmo</span><span class="o">*</span><span class="n">blth</span><span class="o">/</span><span class="n">lmo</span><span class="p">)</span> <span class="o">/</span> <span class="p">(</span><span class="n">kappa</span><span class="o">*</span><span class="n">lam</span><span class="p">)</span> <span class="p">)</span> <span class="o">*</span> <span class="n">blth</span>
<a name="ln-1665"></a>       <span class="k">end do</span>
<a name="ln-1666"></a><span class="k">       </span><span class="n">dispm</span>  <span class="o">=</span> <span class="nb">sum</span><span class="p">(</span><span class="n">output</span><span class="p">(</span><span class="n">ib</span><span class="p">:</span><span class="n">ie</span><span class="p">))</span><span class="o">/</span><span class="p">(</span><span class="n">ie</span><span class="o">-</span><span class="n">ib</span><span class="o">+</span><span class="mi">1</span><span class="p">)</span>      <span class="c">! mean(displacement)</span>
<a name="ln-1667"></a>       <span class="n">disp2m</span> <span class="o">=</span> <span class="nb">sum</span><span class="p">(</span><span class="n">output</span><span class="p">(</span><span class="n">ib</span><span class="p">:</span><span class="n">ie</span><span class="p">)</span><span class="o">**</span><span class="mf">2.</span><span class="p">)</span><span class="o">/</span><span class="p">(</span><span class="n">ie</span><span class="o">-</span><span class="n">ib</span><span class="o">+</span><span class="mi">1</span><span class="p">)</span>   <span class="c">! mean(displacement^2)</span>
<a name="ln-1668"></a>       <span class="n">xfdispm</span>  <span class="o">=</span> <span class="nb">sum</span><span class="p">(</span><span class="n">xf</span><span class="p">(</span><span class="n">ib</span><span class="p">:</span><span class="n">ie</span><span class="p">)</span><span class="o">*</span><span class="n">output</span><span class="p">(</span><span class="n">ib</span><span class="p">:</span><span class="n">ie</span><span class="p">))</span><span class="o">/</span><span class="p">(</span><span class="n">ie</span><span class="o">-</span><span class="n">ib</span><span class="o">+</span><span class="mi">1</span><span class="p">)</span>     <span class="c">! mean(xf*displ)</span>
<a name="ln-1669"></a>
<a name="ln-1670"></a>       <span class="n">ddispdx</span> <span class="o">=</span> <span class="p">(</span><span class="n">xfdispm</span> <span class="o">-</span> <span class="p">(</span><span class="n">xfm</span><span class="o">*</span><span class="n">dispm</span><span class="p">))</span> <span class="o">/</span> <span class="p">(</span><span class="n">xf2m</span> <span class="o">-</span><span class="n">xfm</span><span class="o">**</span><span class="mf">2.</span><span class="p">)</span>    <span class="c">! this is d/dx(delta*)</span>
<a name="ln-1671"></a>
<a name="ln-1672"></a>
<a name="ln-1673"></a>  <span class="k">end subroutine </span><span class="n">dispthicknessmo</span>
<a name="ln-1674"></a>
<a name="ln-1675"></a>
<a name="ln-1676"></a>
<a name="ln-1677"></a>  <span class="c">! thermal boundary layer thickness</span>
<a name="ln-1678"></a>  <span class="k">subroutine </span><span class="n">blthicknesst</span><span class="p">(</span><span class="n">output</span><span class="p">,</span><span class="n">uinput</span><span class="p">,</span><span class="n">criterion</span><span class="p">)</span>
<a name="ln-1679"></a>
<a name="ln-1680"></a>    <span class="k">use </span><span class="n">modglobal</span><span class="p">,</span> <span class="n">only</span> <span class="p">:</span> <span class="n">kb</span><span class="p">,</span><span class="n">ke</span><span class="p">,</span><span class="n">zh</span><span class="p">,</span><span class="n">zf</span>
<a name="ln-1681"></a>    <span class="k">implicit none</span>
<a name="ln-1682"></a>
<a name="ln-1683"></a><span class="k">       </span><span class="kt">real</span><span class="p">,</span> <span class="k">dimension</span><span class="p">(</span><span class="n">kb</span><span class="p">:</span><span class="n">ke</span><span class="p">),</span> <span class="k">intent</span><span class="p">(</span><span class="n">in</span><span class="p">)</span> <span class="kd">::</span> <span class="n">uinput</span>     <span class="c">!&lt; input velocity</span>
<a name="ln-1684"></a>       <span class="kt">real</span><span class="p">,</span> <span class="k">intent</span><span class="p">(</span><span class="n">in</span><span class="p">)</span>                   <span class="kd">::</span> <span class="n">criterion</span>  <span class="c">!&lt; criterion for BL thickness computation (e.g. 0.95 or 0.99)</span>
<a name="ln-1685"></a>       <span class="kt">real</span><span class="p">,</span> <span class="k">intent</span><span class="p">(</span><span class="n">out</span><span class="p">)</span>                  <span class="kd">::</span> <span class="n">output</span>     <span class="c">!&lt; BL thickness based on input criterion</span>
<a name="ln-1686"></a><span class="c">!       real, dimension(kb:ke)             :: mthick</span>
<a name="ln-1687"></a>       <span class="kt">real</span>                               <span class="kd">::</span> <span class="n">ucrit</span>
<a name="ln-1688"></a><span class="c">!       real                               :: umax</span>
<a name="ln-1689"></a>       <span class="kt">integer</span> <span class="kd">::</span> <span class="n">k</span>
<a name="ln-1690"></a>
<a name="ln-1691"></a><span class="c">!     umax = maxval(uinput)</span>
<a name="ln-1692"></a>     <span class="n">ucrit</span> <span class="o">=</span> <span class="n">uinput</span><span class="p">(</span><span class="n">ke</span><span class="p">)</span><span class="o">*</span><span class="n">criterion</span>  <span class="c">! Velocity at which BL-thickness is reached</span>
<a name="ln-1693"></a><span class="c">!     ucrit = umax*criterion  ! Velocity at which BL-thickness is reached</span>
<a name="ln-1694"></a>     <span class="k">do </span><span class="n">k</span><span class="o">=</span><span class="n">kb</span><span class="p">,</span><span class="n">ke</span>
<a name="ln-1695"></a>       <span class="k">if</span> <span class="p">(</span><span class="n">uinput</span><span class="p">(</span><span class="n">k</span><span class="p">)</span> <span class="p">.</span><span class="n">GT</span><span class="p">.</span> <span class="n">criterion</span><span class="o">*</span><span class="n">uinput</span><span class="p">(</span><span class="n">ke</span><span class="p">))</span> <span class="k">then</span>
<a name="ln-1696"></a><span class="k">         if</span> <span class="p">(</span><span class="n">k</span><span class="o">==</span><span class="n">kb</span><span class="p">)</span> <span class="k">then</span>
<a name="ln-1697"></a><span class="k">           </span><span class="n">output</span> <span class="o">=</span> <span class="n">zh</span><span class="p">(</span><span class="n">kb</span><span class="p">)</span><span class="o">+</span> <span class="p">(</span><span class="n">zf</span><span class="p">(</span><span class="n">k</span><span class="p">)</span><span class="o">-</span><span class="n">zh</span><span class="p">(</span><span class="n">k</span><span class="p">))</span><span class="o">/</span><span class="n">uinput</span><span class="p">(</span><span class="n">k</span><span class="p">)</span><span class="o">*</span><span class="n">ucrit</span> <span class="c">! interpolate z to BL-height</span>
<a name="ln-1698"></a>           <span class="k">exit</span>
<a name="ln-1699"></a><span class="k">         else</span>
<a name="ln-1700"></a><span class="k">           </span><span class="n">output</span> <span class="o">=</span> <span class="n">zf</span><span class="p">(</span><span class="n">k</span><span class="o">-</span><span class="mi">1</span><span class="p">)</span> <span class="o">+</span> <span class="p">(</span><span class="n">zf</span><span class="p">(</span><span class="n">k</span><span class="p">)</span><span class="o">-</span><span class="n">zf</span><span class="p">(</span><span class="n">k</span><span class="o">-</span><span class="mi">1</span><span class="p">))</span><span class="o">/</span><span class="p">(</span><span class="n">uinput</span><span class="p">(</span><span class="n">k</span><span class="p">)</span><span class="o">-</span><span class="n">uinput</span><span class="p">(</span><span class="n">k</span><span class="o">-</span><span class="mi">1</span><span class="p">))</span><span class="o">*</span><span class="p">(</span><span class="n">ucrit</span><span class="o">-</span><span class="n">uinput</span><span class="p">(</span><span class="n">k</span><span class="o">-</span><span class="mi">1</span><span class="p">))</span> <span class="c">!  interpolate z to BL-height</span>
<a name="ln-1701"></a>           <span class="k">exit</span>
<a name="ln-1702"></a><span class="k">         end if</span>
<a name="ln-1703"></a><span class="k">       else if</span> <span class="p">(</span><span class="n">k</span><span class="o">==</span><span class="n">ke</span><span class="p">)</span> <span class="k">then</span>
<a name="ln-1704"></a><span class="k">         </span><span class="n">output</span> <span class="o">=</span> <span class="n">zf</span><span class="p">(</span><span class="n">ke</span><span class="p">)</span>      <span class="c">! maximum BL thickness</span>
<a name="ln-1705"></a>       <span class="k">end if</span>
<a name="ln-1706"></a><span class="k">     end do</span>
<a name="ln-1707"></a><span class="k">   end subroutine </span><span class="n">blthicknesst</span>
<a name="ln-1708"></a>
<a name="ln-1709"></a>
<a name="ln-1710"></a>
<a name="ln-1711"></a><span class="c">!  subroutine blthickness(output,uinput,criterion)</span>
<a name="ln-1712"></a><span class="c">!</span>
<a name="ln-1713"></a><span class="c">!    use modglobal, only : kb,ke,zh,zf</span>
<a name="ln-1714"></a><span class="c">!    implicit none</span>
<a name="ln-1715"></a><span class="c">!</span>
<a name="ln-1716"></a><span class="c">!       real, dimension(kb:ke), intent(in) :: uinput     !&lt; input velocity</span>
<a name="ln-1717"></a><span class="c">!       real, intent(in)                   :: criterion  !&lt; criterion for BL thickness computation (e.g. 0.95 or 0.99)</span>
<a name="ln-1718"></a><span class="c">!       real, intent(out)                  :: output     !&lt; BL thickness based on input criterion</span>
<a name="ln-1719"></a><span class="c">!!       real, dimension(kb:ke)             :: mthick</span>
<a name="ln-1720"></a><span class="c">!       real                               :: ucrit</span>
<a name="ln-1721"></a><span class="c">!!       real                               :: umax</span>
<a name="ln-1722"></a><span class="c">!       integer :: k </span>
<a name="ln-1723"></a><span class="c">!     </span>
<a name="ln-1724"></a><span class="c">!!     umax = maxval(uinput)</span>
<a name="ln-1725"></a><span class="c">!     ucrit = uinput(ke)*criterion  ! Velocity at which BL-thickness is reached</span>
<a name="ln-1726"></a><span class="c">!!     ucrit = umax*criterion  ! Velocity at which BL-thickness is reached</span>
<a name="ln-1727"></a><span class="c">!     do k=kb,ke</span>
<a name="ln-1728"></a><span class="c">!       if (uinput(k) .GT. criterion*uinput(ke)) then</span>
<a name="ln-1729"></a><span class="c">!         if (k==kb) then</span>
<a name="ln-1730"></a><span class="c">!           output = zh(kb)+ (zf(k)-zh(k))/uinput(k)*ucrit ! interpolate z to BL-height</span>
<a name="ln-1731"></a><span class="c">!           exit</span>
<a name="ln-1732"></a><span class="c">!         else  </span>
<a name="ln-1733"></a><span class="c">!           output = zf(k-1) + (zf(k)-zf(k-1))/(uinput(k)-uinput(k-1))*(ucrit-uinput(k-1)) ! interpolate z to BL-height</span>
<a name="ln-1734"></a><span class="c">!           exit</span>
<a name="ln-1735"></a><span class="c">!         end if</span>
<a name="ln-1736"></a><span class="c">!       else if (k==ke) then</span>
<a name="ln-1737"></a><span class="c">!         output = zf(ke)      ! maximum BL thickness</span>
<a name="ln-1738"></a><span class="c">!       end if</span>
<a name="ln-1739"></a><span class="c">!     end do</span>
<a name="ln-1740"></a><span class="c">!   end subroutine blthickness </span>
<a name="ln-1741"></a>
<a name="ln-1742"></a>  <span class="k">subroutine </span><span class="n">blthickness</span><span class="p">(</span><span class="n">output</span><span class="p">,</span><span class="n">ustar</span><span class="p">)</span>
<a name="ln-1743"></a>
<a name="ln-1744"></a>    <span class="k">use </span><span class="n">modglobal</span><span class="p">,</span> <span class="n">only</span> <span class="p">:</span> <span class="n">numol</span><span class="p">,</span><span class="n">Uinf</span>
<a name="ln-1745"></a>    <span class="k">implicit none</span>
<a name="ln-1746"></a>
<a name="ln-1747"></a><span class="k">       </span><span class="kt">real</span><span class="p">,</span> <span class="k">intent</span><span class="p">(</span><span class="n">in</span><span class="p">)</span>                   <span class="kd">::</span> <span class="n">ustar</span>      <span class="c">! friction velocity</span>
<a name="ln-1748"></a>       <span class="kt">real</span><span class="p">,</span> <span class="k">intent</span><span class="p">(</span><span class="n">out</span><span class="p">)</span>                  <span class="kd">::</span> <span class="n">output</span>     <span class="c">!&lt; BL thickness based on law of the wake</span>
<a name="ln-1749"></a><span class="c">!       real, dimension(kb:ke)             :: mthick</span>
<a name="ln-1750"></a><span class="c">!       real                               :: ucrit</span>
<a name="ln-1751"></a><span class="c">!       real                               :: umax</span>
<a name="ln-1752"></a><span class="c">!       integer :: k</span>
<a name="ln-1753"></a>       <span class="kt">real</span> <span class="kd">::</span> <span class="n">B</span>     <span class="o">=</span> <span class="mf">5.0</span>       <span class="c">! Wake parameter</span>
<a name="ln-1754"></a>       <span class="kt">real</span> <span class="kd">::</span> <span class="n">C</span>     <span class="o">=</span> <span class="mf">0.5</span>       <span class="c">! Coles parameter</span>
<a name="ln-1755"></a>       <span class="kt">real</span> <span class="kd">::</span> <span class="n">kappa</span> <span class="o">=</span> <span class="mf">0.41</span>      <span class="c">! Von k�r�n constant</span>
<a name="ln-1756"></a>       <span class="kt">real</span> <span class="kd">::</span> <span class="n">lam</span>               <span class="c">! = Uinf/ustar</span>
<a name="ln-1757"></a>
<a name="ln-1758"></a>       <span class="n">lam</span> <span class="o">=</span> <span class="n">Uinf</span> <span class="o">/</span> <span class="n">ustar</span>
<a name="ln-1759"></a>       <span class="n">output</span> <span class="o">=</span> <span class="p">(</span><span class="n">lam</span><span class="o">*</span><span class="n">numol</span><span class="o">/</span><span class="n">Uinf</span><span class="p">)</span> <span class="o">*</span> <span class="nb">exp</span><span class="p">(</span> <span class="n">kappa</span> <span class="o">*</span> <span class="p">(</span><span class="n">lam</span> <span class="o">-</span> <span class="n">B</span><span class="p">)</span> <span class="o">-</span> <span class="mf">2.</span><span class="o">*</span><span class="n">C</span><span class="p">)</span>      <span class="c">! See App. Lund et al.</span>
<a name="ln-1760"></a>
<a name="ln-1761"></a>   <span class="k">end subroutine </span><span class="n">blthickness</span>
<a name="ln-1762"></a>
<a name="ln-1763"></a>  <span class="k">subroutine </span><span class="n">blthicknessmo</span><span class="p">(</span><span class="n">output</span><span class="p">,</span><span class="n">ustar</span><span class="p">,</span><span class="n">lmo</span><span class="p">)</span>
<a name="ln-1764"></a><span class="c">! This routine compute the BL thicknes for a buoyancy affected boundary layer:</span>
<a name="ln-1765"></a><span class="c">! Newton-Raphson method is used </span>
<a name="ln-1766"></a>    <span class="k">use </span><span class="n">modglobal</span><span class="p">,</span> <span class="n">only</span> <span class="p">:</span> <span class="n">numol</span><span class="p">,</span><span class="n">Uinf</span>
<a name="ln-1767"></a>    <span class="k">implicit none</span>
<a name="ln-1768"></a>
<a name="ln-1769"></a><span class="k">       </span><span class="kt">real</span><span class="p">,</span> <span class="k">intent</span><span class="p">(</span><span class="n">in</span><span class="p">)</span>                   <span class="kd">::</span> <span class="n">ustar</span>      <span class="c">! friction velocity</span>
<a name="ln-1770"></a>       <span class="kt">real</span><span class="p">,</span> <span class="k">intent</span><span class="p">(</span><span class="n">in</span><span class="p">)</span>                   <span class="kd">::</span> <span class="n">lmo</span>        <span class="c">! Obukhov length</span>
<a name="ln-1771"></a>       <span class="kt">real</span><span class="p">,</span> <span class="k">intent</span><span class="p">(</span><span class="n">inout</span><span class="p">)</span>                <span class="kd">::</span> <span class="n">output</span>     <span class="c">!&lt; BL thickness based on law of the wake</span>
<a name="ln-1772"></a><span class="c">!       real, dimension(kb:ke)             :: mthick</span>
<a name="ln-1773"></a><span class="c">!       real                               :: ucrit</span>
<a name="ln-1774"></a><span class="c">!       real                               :: umax</span>
<a name="ln-1775"></a><span class="c">!       integer :: k</span>
<a name="ln-1776"></a>       <span class="kt">real</span> <span class="kd">::</span> <span class="n">B</span>     <span class="o">=</span> <span class="mf">5.0</span>       <span class="c">! Wake parameter</span>
<a name="ln-1777"></a>       <span class="kt">real</span> <span class="kd">::</span> <span class="n">C</span>     <span class="o">=</span> <span class="mf">0.5</span>       <span class="c">! Coles parameter</span>
<a name="ln-1778"></a>       <span class="kt">real</span> <span class="kd">::</span> <span class="n">kappa</span> <span class="o">=</span> <span class="mf">0.41</span>      <span class="c">! Von k�r�n constant</span>
<a name="ln-1779"></a>       <span class="kt">real</span> <span class="kd">::</span> <span class="n">cmo</span>   <span class="o">=</span> <span class="mf">0.702</span>     <span class="c">! Constant in MO theory (0.135*5.2)</span>
<a name="ln-1780"></a>       <span class="kt">real</span> <span class="kd">::</span> <span class="n">lam</span>               <span class="c">! = Uinf/ustar</span>
<a name="ln-1781"></a>       <span class="kt">real</span> <span class="kd">::</span> <span class="n">func</span><span class="p">,</span><span class="n">dfunc</span><span class="p">,</span><span class="n">utaunu</span>
<a name="ln-1782"></a>       <span class="kt">integer</span> <span class="kd">::</span> <span class="n">n</span>
<a name="ln-1783"></a>       
<a name="ln-1784"></a>       <span class="n">utaunu</span> <span class="o">=</span> <span class="n">ustar</span> <span class="o">/</span> <span class="n">numol</span> 
<a name="ln-1785"></a>       <span class="n">lam</span> <span class="o">=</span> <span class="n">Uinf</span> <span class="o">/</span> <span class="n">ustar</span>
<a name="ln-1786"></a><span class="c">!       write(6,*) &#39;Initial delta, Lmo =&#39;, output,lmo</span>
<a name="ln-1787"></a>       <span class="k">do </span><span class="n">n</span><span class="o">=</span><span class="mi">1</span><span class="p">,</span><span class="mi">10</span>
<a name="ln-1788"></a>         <span class="n">func</span>   <span class="o">=</span> <span class="nb">log</span><span class="p">(</span><span class="n">output</span><span class="p">)</span> <span class="o">+</span> <span class="p">(</span><span class="n">cmo</span><span class="o">*</span><span class="n">output</span><span class="o">/</span><span class="n">lmo</span><span class="p">)</span> <span class="o">+</span> <span class="nb">log</span><span class="p">(</span><span class="n">utaunu</span><span class="p">)</span> <span class="o">-</span> <span class="n">kappa</span><span class="o">*</span><span class="p">(</span><span class="n">lam</span><span class="o">-</span><span class="n">B</span><span class="p">)</span> <span class="o">+</span><span class="mf">2.</span><span class="o">*</span><span class="n">C</span>
<a name="ln-1789"></a><span class="c">!         func   = log(output) + log(utaunu) - kappa*(lam-B) +2.*C</span>
<a name="ln-1790"></a>         <span class="n">dfunc</span>  <span class="o">=</span> <span class="mf">1.</span><span class="o">/</span><span class="n">output</span> <span class="o">+</span> <span class="n">cmo</span><span class="o">/</span><span class="n">lmo</span>
<a name="ln-1791"></a>         <span class="n">output</span> <span class="o">=</span> <span class="n">output</span> <span class="o">-</span> <span class="p">(</span><span class="n">func</span> <span class="o">/</span> <span class="n">dfunc</span><span class="p">)</span>
<a name="ln-1792"></a>         <span class="k">if</span> <span class="p">(</span><span class="n">output</span> <span class="o">&lt;=</span> <span class="mf">0.</span><span class="p">)</span> <span class="k">then</span>
<a name="ln-1793"></a><span class="k">           </span><span class="n">output</span> <span class="o">=</span> <span class="n">di</span>
<a name="ln-1794"></a>         <span class="k">end if</span>
<a name="ln-1795"></a><span class="k">       end do</span>
<a name="ln-1796"></a><span class="c">!       write(6,*) &#39;Computed delta, Lmo =&#39;, output,lmo</span>
<a name="ln-1797"></a>
<a name="ln-1798"></a>   <span class="k">end subroutine </span><span class="n">blthicknessmo</span>
<a name="ln-1799"></a>
<a name="ln-1800"></a>
<a name="ln-1801"></a>
<a name="ln-1802"></a>  <span class="k">subroutine </span><span class="n">wallawinlet</span><span class="p">(</span><span class="n">utan</span><span class="p">,</span><span class="n">dx</span><span class="p">,</span><span class="n">visc</span><span class="p">,</span><span class="n">tau</span><span class="p">)</span>
<a name="ln-1803"></a><span class="c">! this should be the same as wallaw in modboundary!!! This routine is just</span>
<a name="ln-1804"></a><span class="c">! copied to avoid circular dependencies</span>
<a name="ln-1805"></a>    <span class="k">implicit none</span>
<a name="ln-1806"></a>
<a name="ln-1807"></a><span class="k">      </span><span class="kt">real</span><span class="p">,</span> <span class="k">intent</span><span class="p">(</span><span class="n">in</span><span class="p">)</span>  <span class="kd">::</span> <span class="n">utan</span><span class="p">,</span><span class="n">dx</span><span class="p">,</span><span class="n">visc</span>
<a name="ln-1808"></a>      <span class="kt">real</span><span class="p">,</span> <span class="k">intent</span><span class="p">(</span><span class="n">out</span><span class="p">)</span> <span class="kd">::</span> <span class="n">tau</span>
<a name="ln-1809"></a>
<a name="ln-1810"></a>      <span class="kt">real    </span><span class="n">const1</span><span class="p">,</span> <span class="n">const2</span><span class="p">,</span> <span class="n">const3</span><span class="p">,</span> <span class="n">const4</span>
<a name="ln-1811"></a>      <span class="kt">real    </span><span class="n">tausub</span><span class="p">,</span> <span class="n">taupow</span>
<a name="ln-1812"></a>      <span class="kt">real    </span><span class="n">sub</span><span class="p">,</span> <span class="n">dutan</span><span class="p">,</span> <span class="n">utankr</span><span class="p">,</span><span class="n">utanabs</span>
<a name="ln-1813"></a>      <span class="kt">real    </span><span class="n">aaa</span><span class="p">,</span><span class="n">bbb</span>
<a name="ln-1814"></a>      <span class="kt">real    </span><span class="n">dxi</span>
<a name="ln-1815"></a>
<a name="ln-1816"></a>      <span class="k">parameter</span><span class="p">(</span><span class="n">aaa</span> <span class="o">=</span> <span class="mf">8.3</span><span class="p">)</span>
<a name="ln-1817"></a>      <span class="k">parameter</span><span class="p">(</span><span class="n">bbb</span> <span class="o">=</span> <span class="mf">0.1428571429</span><span class="p">)</span>
<a name="ln-1818"></a>
<a name="ln-1819"></a>      <span class="n">dxi</span> <span class="o">=</span> <span class="mf">1.</span><span class="o">/</span><span class="n">dx</span>
<a name="ln-1820"></a>      <span class="n">const1</span> <span class="o">=</span> <span class="mf">0.5</span> <span class="o">*</span> <span class="p">(</span><span class="mf">1.</span> <span class="o">-</span> <span class="n">bbb</span><span class="p">)</span> <span class="o">*</span> <span class="n">aaa</span> <span class="o">**</span> <span class="p">((</span><span class="mf">1.</span> <span class="o">+</span> <span class="n">bbb</span><span class="p">)</span> <span class="o">/</span> <span class="p">(</span><span class="mf">1.</span> <span class="o">-</span> <span class="n">bbb</span><span class="p">))</span>
<a name="ln-1821"></a>      <span class="n">const2</span> <span class="o">=</span> <span class="p">(</span><span class="mf">1.</span> <span class="o">+</span> <span class="n">bbb</span><span class="p">)</span> <span class="o">/</span> <span class="n">aaa</span>
<a name="ln-1822"></a>      <span class="n">const3</span> <span class="o">=</span> <span class="n">aaa</span> <span class="o">**</span> <span class="p">(</span><span class="mf">2.</span> <span class="o">/</span> <span class="p">(</span><span class="mf">1.</span> <span class="o">-</span> <span class="n">bbb</span><span class="p">))</span>
<a name="ln-1823"></a>      <span class="n">const4</span> <span class="o">=</span> <span class="mf">2.</span> <span class="o">/</span> <span class="p">(</span><span class="mf">1.</span> <span class="o">+</span> <span class="n">bbb</span><span class="p">)</span>
<a name="ln-1824"></a>
<a name="ln-1825"></a>      <span class="n">utanabs</span><span class="o">=</span><span class="nb">abs</span><span class="p">(</span><span class="n">utan</span><span class="p">)</span>
<a name="ln-1826"></a>      <span class="n">utankr</span> <span class="o">=</span> <span class="mf">0.5</span> <span class="o">*</span> <span class="n">visc</span> <span class="o">*</span> <span class="n">dxi</span> <span class="o">*</span> <span class="n">const3</span>
<a name="ln-1827"></a>      <span class="n">dutan</span>  <span class="o">=</span> <span class="n">utankr</span> <span class="o">-</span> <span class="n">utanabs</span>
<a name="ln-1828"></a>      <span class="n">sub</span>    <span class="o">=</span> <span class="nb">max</span> <span class="p">(</span><span class="nb">sign</span><span class="p">(</span><span class="mf">1.</span><span class="p">,</span><span class="n">dutan</span><span class="p">),</span><span class="mf">0.</span><span class="p">)</span>
<a name="ln-1829"></a>
<a name="ln-1830"></a>      <span class="n">tausub</span>    <span class="o">=</span> <span class="mf">2.</span> <span class="o">*</span> <span class="n">visc</span> <span class="o">*</span> <span class="n">utanabs</span> <span class="o">*</span> <span class="n">dxi</span>
<a name="ln-1831"></a><span class="c">!      taupow3   =   const1 * (visc * dxi)**(1.+bbb) + (const2 * (visc *</span>
<a name="ln-1832"></a><span class="c">!      dxi)**bbb) * utanabs</span>
<a name="ln-1833"></a>      <span class="n">taupow</span>    <span class="o">=</span> <span class="p">(</span> <span class="n">const1</span> <span class="o">*</span> <span class="p">(</span><span class="n">visc</span> <span class="o">*</span> <span class="n">dxi</span><span class="p">)</span><span class="o">**</span><span class="p">(</span><span class="mf">1.</span><span class="o">+</span><span class="n">bbb</span><span class="p">)</span> <span class="o">+</span> <span class="p">(</span><span class="n">const2</span> <span class="o">*</span> <span class="p">(</span><span class="n">visc</span> <span class="o">*</span> <span class="n">dxi</span><span class="p">)</span><span class="o">**</span><span class="n">bbb</span><span class="p">)</span> <span class="o">*</span> <span class="n">utanabs</span><span class="p">)</span><span class="o">**</span> <span class="n">const4</span>
<a name="ln-1834"></a>
<a name="ln-1835"></a><span class="c">!      if (taupow3&lt;=0) then</span>
<a name="ln-1836"></a><span class="c">!        write(6,*) &#39;taupow3 &lt;=0!!!&#39;</span>
<a name="ln-1837"></a><span class="c">!      end if</span>
<a name="ln-1838"></a>      <span class="n">tau</span> <span class="o">=</span> <span class="n">sub</span> <span class="o">*</span> <span class="n">tausub</span> <span class="o">+</span> <span class="p">(</span><span class="mf">1.</span><span class="o">-</span> <span class="n">sub</span><span class="p">)</span> <span class="o">*</span> <span class="n">taupow</span>
<a name="ln-1839"></a>      <span class="n">tau</span> <span class="o">=</span> <span class="nb">sign</span><span class="p">(</span><span class="n">tau</span><span class="p">,</span><span class="n">utan</span><span class="p">)</span>  <span class="c">! give tau the same sign as utan</span>
<a name="ln-1840"></a>      <span class="k">return</span>
<a name="ln-1841"></a><span class="k">    end subroutine </span><span class="n">wallawinlet</span>
<a name="ln-1842"></a>
<a name="ln-1843"></a>  <span class="k">subroutine </span><span class="n">writeinletfile</span>
<a name="ln-1844"></a>    <span class="k">use </span><span class="n">modglobal</span><span class="p">,</span> <span class="n">only</span> <span class="p">:</span> <span class="n">jb</span><span class="p">,</span><span class="n">je</span><span class="p">,</span><span class="n">kb</span><span class="p">,</span><span class="n">ke</span><span class="p">,</span><span class="n">cexpnr</span><span class="p">,</span><span class="n">ifoutput</span><span class="p">,</span><span class="n">nstore</span><span class="p">,</span><span class="n">ltempeq</span>
<a name="ln-1845"></a>    <span class="k">use </span><span class="n">modmpi</span><span class="p">,</span>    <span class="n">only</span> <span class="p">:</span> <span class="n">cmyid</span><span class="p">,</span><span class="n">myid</span>
<a name="ln-1846"></a><span class="c">!    use modinletdata, only : storeu0inletbc,storev0inletbc,storew0inletbc,nfile</span>
<a name="ln-1847"></a>
<a name="ln-1848"></a>    <span class="k">implicit none</span>
<a name="ln-1849"></a><span class="k">    </span><span class="kt">integer </span><span class="n">fileid</span>
<a name="ln-1850"></a>    <span class="kt">integer </span><span class="n">j</span><span class="p">,</span><span class="n">k</span><span class="p">,</span><span class="n">n</span>
<a name="ln-1851"></a>    <span class="kt">character</span><span class="p">(</span><span class="mi">24</span><span class="p">)</span> <span class="n">name</span>
<a name="ln-1852"></a>
<a name="ln-1853"></a>      <span class="n">name</span> <span class="o">=</span> <span class="s1">&#39;inlet/inlet_    k   .&#39;</span>
<a name="ln-1854"></a>      <span class="k">write</span> <span class="p">(</span><span class="n">name</span><span class="p">(</span><span class="mi">13</span><span class="p">:</span><span class="mi">16</span><span class="p">)</span>  <span class="p">,</span><span class="s1">&#39;(i4.4)&#39;</span><span class="p">)</span> <span class="n">nfile</span>
<a name="ln-1855"></a>      <span class="n">name</span><span class="p">(</span><span class="mi">18</span><span class="p">:</span><span class="mi">20</span><span class="p">)</span><span class="o">=</span> <span class="n">cmyid</span>
<a name="ln-1856"></a>      <span class="n">name</span><span class="p">(</span><span class="mi">22</span><span class="p">:</span><span class="mi">24</span><span class="p">)</span><span class="o">=</span> <span class="n">cexpnr</span>
<a name="ln-1857"></a>
<a name="ln-1858"></a>      <span class="k">write</span><span class="p">(</span><span class="mi">6</span><span class="p">,</span><span class="o">*</span><span class="p">)</span> <span class="s1">&#39;Writing Inlet velocity: &#39;</span><span class="p">,</span> <span class="n">name</span>
<a name="ln-1859"></a>      <span class="k">open</span>  <span class="p">(</span><span class="n">ifoutput</span><span class="p">,</span><span class="k">file</span><span class="o">=</span><span class="n">name</span><span class="p">,</span><span class="n">form</span><span class="o">=</span><span class="s1">&#39;unformatted&#39;</span><span class="p">,</span><span class="n">position</span><span class="o">=</span><span class="s1">&#39;append&#39;</span><span class="p">)</span>
<a name="ln-1860"></a>
<a name="ln-1861"></a>      <span class="k">write</span><span class="p">(</span><span class="n">ifoutput</span><span class="p">)</span>  <span class="p">(((</span><span class="n">storeu0inletbc</span> <span class="p">(</span><span class="n">j</span><span class="p">,</span><span class="n">k</span><span class="p">,</span><span class="n">n</span><span class="p">),</span><span class="n">j</span><span class="o">=</span><span class="n">jb</span><span class="p">,</span><span class="n">je</span><span class="p">),</span><span class="n">k</span><span class="o">=</span><span class="n">kb</span><span class="p">,</span><span class="n">ke</span><span class="p">),</span>  <span class="n">n</span><span class="o">=</span><span class="mi">1</span><span class="p">,</span><span class="n">nstore</span><span class="p">)</span>
<a name="ln-1862"></a>      <span class="k">write</span><span class="p">(</span><span class="n">ifoutput</span><span class="p">)</span>  <span class="p">(((</span><span class="n">storev0inletbc</span> <span class="p">(</span><span class="n">j</span><span class="p">,</span><span class="n">k</span><span class="p">,</span><span class="n">n</span><span class="p">),</span><span class="n">j</span><span class="o">=</span><span class="n">jb</span><span class="p">,</span><span class="n">je</span><span class="p">),</span><span class="n">k</span><span class="o">=</span><span class="n">kb</span><span class="p">,</span><span class="n">ke</span><span class="p">),</span>  <span class="n">n</span><span class="o">=</span><span class="mi">1</span><span class="p">,</span><span class="n">nstore</span><span class="p">)</span>
<a name="ln-1863"></a>      <span class="k">write</span><span class="p">(</span><span class="n">ifoutput</span><span class="p">)</span>  <span class="p">(((</span><span class="n">storew0inletbc</span> <span class="p">(</span><span class="n">j</span><span class="p">,</span><span class="n">k</span><span class="p">,</span><span class="n">n</span><span class="p">),</span><span class="n">j</span><span class="o">=</span><span class="n">jb</span><span class="p">,</span><span class="n">je</span><span class="p">),</span><span class="n">k</span><span class="o">=</span><span class="n">kb</span><span class="p">,</span><span class="n">ke</span><span class="o">+</span><span class="mi">1</span><span class="p">),</span><span class="n">n</span><span class="o">=</span><span class="mi">1</span><span class="p">,</span><span class="n">nstore</span><span class="p">)</span>
<a name="ln-1864"></a>      <span class="k">close</span> <span class="p">(</span><span class="n">ifoutput</span><span class="p">)</span>
<a name="ln-1865"></a>
<a name="ln-1866"></a>      <span class="k">if</span> <span class="p">(</span><span class="n">ltempeq</span> <span class="p">)</span> <span class="k">then</span>
<a name="ln-1867"></a><span class="k">        </span><span class="n">name</span> <span class="o">=</span> <span class="s1">&#39;inlet/itemp_    k   .&#39;</span>
<a name="ln-1868"></a>        <span class="k">write</span> <span class="p">(</span><span class="n">name</span><span class="p">(</span><span class="mi">13</span><span class="p">:</span><span class="mi">16</span><span class="p">)</span>  <span class="p">,</span><span class="s1">&#39;(i4.4)&#39;</span><span class="p">)</span> <span class="n">nfile</span>
<a name="ln-1869"></a>        <span class="n">name</span><span class="p">(</span><span class="mi">18</span><span class="p">:</span><span class="mi">20</span><span class="p">)</span><span class="o">=</span> <span class="n">cmyid</span>
<a name="ln-1870"></a>        <span class="n">name</span><span class="p">(</span><span class="mi">22</span><span class="p">:</span><span class="mi">24</span><span class="p">)</span><span class="o">=</span> <span class="n">cexpnr</span>
<a name="ln-1871"></a>
<a name="ln-1872"></a>        <span class="k">write</span><span class="p">(</span><span class="mi">6</span><span class="p">,</span><span class="o">*</span><span class="p">)</span> <span class="s1">&#39;Writing Inlet temperature: &#39;</span><span class="p">,</span> <span class="n">name</span>
<a name="ln-1873"></a>        <span class="k">open</span>  <span class="p">(</span><span class="n">ifoutput</span><span class="p">,</span><span class="k">file</span><span class="o">=</span><span class="n">name</span><span class="p">,</span><span class="n">form</span><span class="o">=</span><span class="s1">&#39;unformatted&#39;</span><span class="p">,</span><span class="n">position</span><span class="o">=</span><span class="s1">&#39;append&#39;</span><span class="p">)</span>
<a name="ln-1874"></a>
<a name="ln-1875"></a>        <span class="k">write</span><span class="p">(</span><span class="n">ifoutput</span><span class="p">)</span>  <span class="p">(((</span><span class="n">storet0inletbc</span> <span class="p">(</span><span class="n">j</span><span class="p">,</span><span class="n">k</span><span class="p">,</span><span class="n">n</span><span class="p">),</span><span class="n">j</span><span class="o">=</span><span class="n">jb</span><span class="p">,</span><span class="n">je</span><span class="p">),</span><span class="n">k</span><span class="o">=</span><span class="n">kb</span><span class="p">,</span><span class="n">ke</span><span class="p">),</span>  <span class="n">n</span><span class="o">=</span><span class="mi">1</span><span class="p">,</span><span class="n">nstore</span><span class="p">)</span>
<a name="ln-1876"></a>        <span class="k">close</span> <span class="p">(</span><span class="n">ifoutput</span><span class="p">)</span>
<a name="ln-1877"></a>      <span class="k">end if</span>
<a name="ln-1878"></a>
<a name="ln-1879"></a><span class="k">  end subroutine </span><span class="n">writeinletfile</span>
<a name="ln-1880"></a>
<a name="ln-1881"></a>  <span class="k">subroutine </span><span class="n">readinletfile</span>
<a name="ln-1882"></a>    <span class="k">use </span><span class="n">modglobal</span><span class="p">,</span> <span class="n">only</span> <span class="p">:</span> <span class="n">ib</span><span class="p">,</span><span class="n">jb</span><span class="p">,</span><span class="n">je</span><span class="p">,</span><span class="n">jmax</span><span class="p">,</span><span class="n">kb</span><span class="p">,</span><span class="n">ke</span><span class="p">,</span><span class="n">cexpnr</span><span class="p">,</span><span class="n">ifinput</span><span class="p">,</span><span class="n">nstore</span><span class="p">,</span><span class="n">ltempeq</span><span class="p">,</span><span class="n">ntrun</span><span class="p">,</span><span class="n">zh</span><span class="p">,</span><span class="n">jgb</span><span class="p">,</span><span class="n">jge</span><span class="p">,</span><span class="n">jh</span> 
<a name="ln-1883"></a>    <span class="k">use </span><span class="n">modmpi</span><span class="p">,</span>    <span class="n">only</span> <span class="p">:</span> <span class="n">cmyid</span><span class="p">,</span><span class="n">myid</span><span class="p">,</span><span class="n">nprocs</span><span class="p">,</span><span class="n">slabsum</span><span class="p">,</span><span class="n">excjs</span>
<a name="ln-1884"></a><span class="c">!    use modinletdata, only : storeu0inletbc,storev0inletbc,storew0inletbc,nfile</span>
<a name="ln-1885"></a>
<a name="ln-1886"></a>    <span class="k">implicit none</span>
<a name="ln-1887"></a><span class="k">    </span><span class="kt">real</span><span class="p">,</span> <span class="k">dimension</span><span class="p">(</span><span class="n">ib</span><span class="p">:</span><span class="n">ib</span><span class="p">,</span><span class="n">jb</span><span class="p">:</span><span class="n">jb</span><span class="o">+</span><span class="n">inlfactor</span><span class="o">*</span><span class="n">jmax</span><span class="o">-</span><span class="mi">1</span><span class="p">,</span><span class="n">kbin</span><span class="p">:</span><span class="n">kein</span><span class="p">)</span>        <span class="kd">::</span> <span class="n">udummy</span>
<a name="ln-1888"></a>    <span class="kt">real</span><span class="p">,</span> <span class="k">dimension</span><span class="p">(</span><span class="n">kbin</span><span class="p">:</span><span class="n">kein</span><span class="p">)</span>                                     <span class="kd">::</span> <span class="n">uread</span>
<a name="ln-1889"></a>    <span class="kt">real</span><span class="p">,</span> <span class="k">dimension</span><span class="p">(</span><span class="n">kbin</span><span class="p">:</span><span class="n">kein</span><span class="p">)</span>                                     <span class="kd">::</span> <span class="n">ureaddzfin</span>
<a name="ln-1890"></a>    <span class="kt">real</span><span class="p">,</span> <span class="k">dimension</span><span class="p">(</span><span class="n">jb</span><span class="p">:</span><span class="n">jb</span><span class="o">+</span><span class="n">jtotin</span><span class="o">-</span><span class="mi">1</span><span class="p">,</span><span class="n">kbin</span><span class="p">:</span><span class="n">kein</span><span class="p">,</span><span class="mi">1</span><span class="p">:</span><span class="n">nstore</span><span class="p">)</span>     <span class="kd">::</span> <span class="n">storeu0inold</span>
<a name="ln-1891"></a>    <span class="kt">real</span><span class="p">,</span> <span class="k">dimension</span><span class="p">(</span><span class="n">jb</span><span class="p">:</span><span class="n">jb</span><span class="o">+</span><span class="n">jtotin</span><span class="o">-</span><span class="mi">1</span><span class="p">,</span><span class="n">kbin</span><span class="p">:</span><span class="n">kein</span><span class="p">,</span><span class="mi">1</span><span class="p">:</span><span class="n">nstore</span><span class="p">)</span>     <span class="kd">::</span> <span class="n">storev0inold</span>
<a name="ln-1892"></a>    <span class="kt">real</span><span class="p">,</span> <span class="k">dimension</span><span class="p">(</span><span class="n">jb</span><span class="p">:</span><span class="n">jb</span><span class="o">+</span><span class="n">jtotin</span><span class="o">-</span><span class="mi">1</span><span class="p">,</span><span class="n">kbin</span><span class="p">:</span><span class="n">kein</span><span class="o">+</span><span class="mi">1</span><span class="p">,</span><span class="mi">1</span><span class="p">:</span><span class="n">nstore</span><span class="p">)</span>   <span class="kd">::</span> <span class="n">storew0inold</span>
<a name="ln-1893"></a>    <span class="kt">real</span><span class="p">,</span> <span class="k">dimension</span><span class="p">(</span><span class="n">jb</span><span class="p">:</span><span class="n">jb</span><span class="o">+</span><span class="n">jtotin</span><span class="o">-</span><span class="mi">1</span><span class="p">,</span><span class="n">kbin</span><span class="p">:</span><span class="n">kein</span><span class="p">,</span><span class="mi">1</span><span class="p">:</span><span class="n">nstore</span><span class="p">)</span>     <span class="kd">::</span> <span class="n">storet0inold</span>
<a name="ln-1894"></a>    <span class="kt">real</span><span class="p">,</span> <span class="k">dimension</span><span class="p">(</span><span class="n">jb</span><span class="p">:</span><span class="n">jb</span><span class="o">+</span><span class="n">jtotdum</span><span class="o">-</span><span class="mi">1</span><span class="p">,</span><span class="n">kbin</span><span class="p">:</span><span class="n">kein</span><span class="p">,</span><span class="mi">1</span><span class="p">:</span><span class="n">nstore</span><span class="p">)</span>     <span class="kd">::</span> <span class="n">storeu0indum</span>
<a name="ln-1895"></a>    <span class="kt">real</span><span class="p">,</span> <span class="k">dimension</span><span class="p">(</span><span class="n">jb</span><span class="p">:</span><span class="n">jb</span><span class="o">+</span><span class="n">jtotdum</span><span class="o">-</span><span class="mi">1</span><span class="p">,</span><span class="n">kbin</span><span class="p">:</span><span class="n">kein</span><span class="p">,</span><span class="mi">1</span><span class="p">:</span><span class="n">nstore</span><span class="p">)</span>     <span class="kd">::</span> <span class="n">storev0indum</span>
<a name="ln-1896"></a>    <span class="kt">real</span><span class="p">,</span> <span class="k">dimension</span><span class="p">(</span><span class="n">jb</span><span class="p">:</span><span class="n">jb</span><span class="o">+</span><span class="n">jtotdum</span><span class="o">-</span><span class="mi">1</span><span class="p">,</span><span class="n">kbin</span><span class="p">:</span><span class="n">kein</span><span class="o">+</span><span class="mi">1</span><span class="p">,</span><span class="mi">1</span><span class="p">:</span><span class="n">nstore</span><span class="p">)</span>   <span class="kd">::</span> <span class="n">storew0indum</span>
<a name="ln-1897"></a>    <span class="kt">real</span><span class="p">,</span> <span class="k">dimension</span><span class="p">(</span><span class="n">jb</span><span class="p">:</span><span class="n">jb</span><span class="o">+</span><span class="n">jtotdum</span><span class="o">-</span><span class="mi">1</span><span class="p">,</span><span class="n">kbin</span><span class="p">:</span><span class="n">kein</span><span class="p">,</span><span class="mi">1</span><span class="p">:</span><span class="n">nstore</span><span class="p">)</span>     <span class="kd">::</span> <span class="n">storet0indum</span>
<a name="ln-1898"></a>    <span class="kt">real</span><span class="p">,</span> <span class="k">dimension</span><span class="p">(</span><span class="n">jb</span><span class="p">:</span><span class="n">je</span><span class="p">,</span><span class="n">kbin</span><span class="p">:</span><span class="n">kein</span><span class="p">,</span><span class="mi">1</span><span class="p">:</span><span class="n">nstore</span><span class="p">)</span>     <span class="kd">::</span> <span class="n">storeu0innew</span>
<a name="ln-1899"></a>    <span class="kt">real</span><span class="p">,</span> <span class="k">dimension</span><span class="p">(</span><span class="n">jb</span><span class="p">:</span><span class="n">je</span><span class="p">,</span><span class="n">kbin</span><span class="p">:</span><span class="n">kein</span><span class="p">,</span><span class="mi">1</span><span class="p">:</span><span class="n">nstore</span><span class="p">)</span>     <span class="kd">::</span> <span class="n">storev0innew</span>
<a name="ln-1900"></a>    <span class="kt">real</span><span class="p">,</span> <span class="k">dimension</span><span class="p">(</span><span class="n">jb</span><span class="p">:</span><span class="n">je</span><span class="p">,</span><span class="n">kbin</span><span class="p">:</span><span class="n">kein</span><span class="o">+</span><span class="mi">1</span><span class="p">,</span><span class="mi">1</span><span class="p">:</span><span class="n">nstore</span><span class="p">)</span>   <span class="kd">::</span> <span class="n">storew0innew</span>
<a name="ln-1901"></a>    <span class="kt">real</span><span class="p">,</span> <span class="k">dimension</span><span class="p">(</span><span class="n">jb</span><span class="p">:</span><span class="n">je</span><span class="p">,</span><span class="n">kbin</span><span class="p">:</span><span class="n">kein</span><span class="p">,</span><span class="mi">1</span><span class="p">:</span><span class="n">nstore</span><span class="p">)</span>     <span class="kd">::</span> <span class="n">storet0innew</span>
<a name="ln-1902"></a>    <span class="kt">integer </span><span class="n">filen</span><span class="p">,</span><span class="n">filee</span>
<a name="ln-1903"></a>    <span class="kt">integer </span><span class="n">fileid</span>
<a name="ln-1904"></a>    <span class="kt">integer </span><span class="n">j</span><span class="p">,</span><span class="n">k</span><span class="p">,</span><span class="n">n</span><span class="p">,</span><span class="n">js</span><span class="p">,</span><span class="n">jf</span><span class="p">,</span><span class="n">jfdum</span><span class="p">,</span><span class="n">jsdum</span>
<a name="ln-1905"></a>    <span class="kt">character</span><span class="p">(</span><span class="mi">24</span><span class="p">)</span> <span class="n">name</span>
<a name="ln-1906"></a>      <span class="n">jfdum</span> <span class="o">=</span> <span class="n">jbdum</span><span class="o">-</span><span class="mi">1</span>  <span class="c">! initial value</span>
<a name="ln-1907"></a>      <span class="k">do </span><span class="n">fileid</span> <span class="o">=</span> <span class="n">filenumstart</span><span class="p">,</span> <span class="n">filenumstart</span><span class="o">+</span><span class="p">(</span><span class="n">filestoread</span><span class="o">-</span><span class="mi">1</span><span class="p">)</span>
<a name="ln-1908"></a>        <span class="k">if</span> <span class="p">(</span><span class="n">filen</span> <span class="o">==</span> <span class="o">-</span><span class="mi">1</span><span class="p">)</span> <span class="k">then </span>
<a name="ln-1909"></a><span class="k">          </span><span class="n">filen</span> <span class="o">=</span> <span class="n">nprocsinl</span><span class="o">-</span><span class="mi">1</span>                      <span class="c">! -1 means the last proc (periodic)</span>
<a name="ln-1910"></a>        <span class="k">else</span>
<a name="ln-1911"></a><span class="k">          </span><span class="n">filen</span> <span class="o">=</span> <span class="n">fileid</span> <span class="o">-</span> <span class="nb">floor</span><span class="p">(</span><span class="kt">real</span><span class="p">(</span><span class="n">fileid</span><span class="p">)</span><span class="o">/</span><span class="kt">real</span><span class="p">(</span><span class="n">nprocsinl</span><span class="p">))</span><span class="o">*</span><span class="n">nprocsinl</span>  <span class="c">! loop over proc&#39;s</span>
<a name="ln-1912"></a>        <span class="k">end if</span>
<a name="ln-1913"></a><span class="c">!        write(6,*) &#39;!!!!! filen = &#39;, filen</span>
<a name="ln-1914"></a>        <span class="n">name</span> <span class="o">=</span> <span class="s1">&#39;inlet/inlet_    k   .&#39;</span>
<a name="ln-1915"></a>        <span class="k">write</span> <span class="p">(</span><span class="n">name</span><span class="p">(</span><span class="mi">13</span><span class="p">:</span><span class="mi">16</span><span class="p">)</span>  <span class="p">,</span><span class="s1">&#39;(i4.4)&#39;</span><span class="p">)</span> <span class="n">nfile</span>
<a name="ln-1916"></a>        <span class="k">write</span> <span class="p">(</span><span class="n">name</span><span class="p">(</span><span class="mi">18</span><span class="p">:</span><span class="mi">20</span><span class="p">)</span>  <span class="p">,</span><span class="s1">&#39;(i3.3)&#39;</span><span class="p">)</span> <span class="n">filen</span>
<a name="ln-1917"></a>        <span class="n">name</span><span class="p">(</span><span class="mi">22</span><span class="p">:</span><span class="mi">24</span><span class="p">)</span><span class="o">=</span> <span class="n">cexpnr</span>
<a name="ln-1918"></a>        <span class="k">write</span><span class="p">(</span><span class="mi">6</span><span class="p">,</span><span class="o">*</span><span class="p">)</span> <span class="s1">&#39;Reading Inlet velocity: &#39;</span><span class="p">,</span> <span class="n">name</span>
<a name="ln-1919"></a>        <span class="k">open</span><span class="p">(</span><span class="n">unit</span><span class="o">=</span><span class="n">ifinput</span><span class="p">,</span><span class="k">file</span><span class="o">=</span><span class="n">name</span><span class="p">,</span><span class="n">form</span><span class="o">=</span><span class="s1">&#39;unformatted&#39;</span><span class="p">)</span>
<a name="ln-1920"></a>        <span class="k">read</span><span class="p">(</span><span class="n">ifinput</span><span class="p">)</span>  <span class="p">(((</span><span class="n">storeu0inold</span> <span class="p">(</span><span class="n">j</span><span class="p">,</span><span class="n">k</span><span class="p">,</span><span class="n">n</span><span class="p">),</span><span class="n">j</span><span class="o">=</span><span class="n">jbin</span><span class="p">,</span><span class="n">jein</span><span class="p">),</span><span class="n">k</span><span class="o">=</span><span class="n">kbin</span><span class="p">,</span><span class="n">kein</span><span class="p">),</span>  <span class="n">n</span><span class="o">=</span><span class="mi">1</span><span class="p">,</span><span class="n">nstore</span><span class="p">)</span>
<a name="ln-1921"></a>        <span class="k">read</span><span class="p">(</span><span class="n">ifinput</span><span class="p">)</span>  <span class="p">(((</span><span class="n">storev0inold</span> <span class="p">(</span><span class="n">j</span><span class="p">,</span><span class="n">k</span><span class="p">,</span><span class="n">n</span><span class="p">),</span><span class="n">j</span><span class="o">=</span><span class="n">jbin</span><span class="p">,</span><span class="n">jein</span><span class="p">),</span><span class="n">k</span><span class="o">=</span><span class="n">kbin</span><span class="p">,</span><span class="n">kein</span><span class="p">),</span>  <span class="n">n</span><span class="o">=</span><span class="mi">1</span><span class="p">,</span><span class="n">nstore</span><span class="p">)</span>
<a name="ln-1922"></a>        <span class="k">read</span><span class="p">(</span><span class="n">ifinput</span><span class="p">)</span>  <span class="p">(((</span><span class="n">storew0inold</span> <span class="p">(</span><span class="n">j</span><span class="p">,</span><span class="n">k</span><span class="p">,</span><span class="n">n</span><span class="p">),</span><span class="n">j</span><span class="o">=</span><span class="n">jbin</span><span class="p">,</span><span class="n">jein</span><span class="p">),</span><span class="n">k</span><span class="o">=</span><span class="n">kbin</span><span class="p">,</span><span class="n">kein</span><span class="o">+</span><span class="mi">1</span><span class="p">),</span><span class="n">n</span><span class="o">=</span><span class="mi">1</span><span class="p">,</span><span class="n">nstore</span><span class="p">)</span>
<a name="ln-1923"></a>        <span class="k">close</span> <span class="p">(</span><span class="n">ifinput</span><span class="p">)</span>
<a name="ln-1924"></a>
<a name="ln-1925"></a>        <span class="k">if</span> <span class="p">(</span><span class="n">ltempeq</span> <span class="p">)</span> <span class="k">then</span>
<a name="ln-1926"></a><span class="k">          </span><span class="n">name</span> <span class="o">=</span> <span class="s1">&#39;inlet/itemp_    k   .&#39;</span>
<a name="ln-1927"></a>          <span class="k">write</span> <span class="p">(</span><span class="n">name</span><span class="p">(</span><span class="mi">13</span><span class="p">:</span><span class="mi">16</span><span class="p">)</span>  <span class="p">,</span><span class="s1">&#39;(i4.4)&#39;</span><span class="p">)</span> <span class="n">nfile</span>
<a name="ln-1928"></a>          <span class="k">write</span> <span class="p">(</span><span class="n">name</span><span class="p">(</span><span class="mi">18</span><span class="p">:</span><span class="mi">20</span><span class="p">)</span>  <span class="p">,</span><span class="s1">&#39;(i3.3)&#39;</span><span class="p">)</span> <span class="n">filen</span>
<a name="ln-1929"></a>          <span class="n">name</span><span class="p">(</span><span class="mi">22</span><span class="p">:</span><span class="mi">24</span><span class="p">)</span><span class="o">=</span> <span class="n">cexpnr</span>
<a name="ln-1930"></a>          <span class="k">write</span><span class="p">(</span><span class="mi">6</span><span class="p">,</span><span class="o">*</span><span class="p">)</span> <span class="s1">&#39;Reading Inlet temperature: &#39;</span><span class="p">,</span> <span class="n">name</span>
<a name="ln-1931"></a>          <span class="k">open</span><span class="p">(</span><span class="n">unit</span><span class="o">=</span><span class="n">ifinput</span><span class="p">,</span><span class="k">file</span><span class="o">=</span><span class="n">name</span><span class="p">,</span><span class="n">form</span><span class="o">=</span><span class="s1">&#39;unformatted&#39;</span><span class="p">)</span>
<a name="ln-1932"></a>          <span class="k">read</span><span class="p">(</span><span class="n">ifinput</span><span class="p">)</span>  <span class="p">(((</span><span class="n">storet0inold</span> <span class="p">(</span><span class="n">j</span><span class="p">,</span><span class="n">k</span><span class="p">,</span><span class="n">n</span><span class="p">),</span><span class="n">j</span><span class="o">=</span><span class="n">jbin</span><span class="p">,</span><span class="n">jein</span><span class="p">),</span><span class="n">k</span><span class="o">=</span><span class="n">kbin</span><span class="p">,</span><span class="n">kein</span><span class="p">),</span>  <span class="n">n</span><span class="o">=</span><span class="mi">1</span><span class="p">,</span><span class="n">nstore</span><span class="p">)</span>
<a name="ln-1933"></a>          <span class="k">close</span> <span class="p">(</span><span class="n">ifinput</span><span class="p">)</span>
<a name="ln-1934"></a>        <span class="k">end if</span>
<a name="ln-1935"></a>
<a name="ln-1936"></a>
<a name="ln-1937"></a>        <span class="c">! determine start and end indices</span>
<a name="ln-1938"></a>        <span class="k">if</span> <span class="p">(</span><span class="n">filen</span> <span class="o">==</span> <span class="n">procinlo</span><span class="p">)</span> <span class="k">then</span>
<a name="ln-1939"></a><span class="k">          </span><span class="n">js</span> <span class="o">=</span> <span class="n">jbeg</span>
<a name="ln-1940"></a>        <span class="k">else</span>
<a name="ln-1941"></a><span class="k">          </span><span class="n">js</span> <span class="o">=</span> <span class="n">jbin</span>
<a name="ln-1942"></a>        <span class="k">end if</span>
<a name="ln-1943"></a><span class="k">        if</span> <span class="p">(</span><span class="n">filen</span> <span class="o">==</span> <span class="n">procinup</span><span class="p">)</span> <span class="k">then</span>
<a name="ln-1944"></a><span class="k">          </span><span class="n">jf</span> <span class="o">=</span> <span class="n">jend</span>
<a name="ln-1945"></a>        <span class="k">else</span>
<a name="ln-1946"></a><span class="k">          </span><span class="n">jf</span> <span class="o">=</span> <span class="n">jein</span>
<a name="ln-1947"></a>        <span class="k">end if</span>
<a name="ln-1948"></a><span class="k">        </span><span class="n">jsdum</span> <span class="o">=</span> <span class="n">jfdum</span> <span class="o">+</span> <span class="mi">1</span>
<a name="ln-1949"></a>        <span class="n">jfdum</span> <span class="o">=</span> <span class="n">jsdum</span> <span class="o">+</span> <span class="p">(</span><span class="n">jf</span><span class="o">-</span><span class="n">js</span><span class="p">)</span>
<a name="ln-1950"></a><span class="c">!        if (jsdum &gt;= 3) write(6,*) &#39;myid, jsdum = &#39;,myid, jsdum </span>
<a name="ln-1951"></a><span class="c">!        if (jfdum &gt;= 3) write(6,*) &#39;myid, jfdum = &#39;,myid, jfdum </span>
<a name="ln-1952"></a>
<a name="ln-1953"></a> <span class="c">!!! put values from original in dummy variable</span>
<a name="ln-1954"></a>        <span class="n">storeu0indum</span><span class="p">(</span><span class="n">jsdum</span><span class="p">:</span><span class="n">jfdum</span><span class="p">,:,:)</span>    <span class="o">=</span> <span class="n">storeu0inold</span><span class="p">(</span><span class="n">js</span><span class="p">:</span><span class="n">jf</span><span class="p">,:,:)</span>      <span class="c">! s: start  f: final</span>
<a name="ln-1955"></a>        <span class="n">storev0indum</span><span class="p">(</span><span class="n">jsdum</span><span class="p">:</span><span class="n">jfdum</span><span class="p">,:,:)</span>    <span class="o">=</span> <span class="n">storev0inold</span><span class="p">(</span><span class="n">js</span><span class="p">:</span><span class="n">jf</span><span class="p">,:,:)</span>      <span class="c">! s: start  f: final</span>
<a name="ln-1956"></a>        <span class="n">storew0indum</span><span class="p">(</span><span class="n">jsdum</span><span class="p">:</span><span class="n">jfdum</span><span class="p">,:,:)</span>    <span class="o">=</span> <span class="n">storew0inold</span><span class="p">(</span><span class="n">js</span><span class="p">:</span><span class="n">jf</span><span class="p">,:,:)</span>      <span class="c">! s: start  f: final</span>
<a name="ln-1957"></a>        <span class="k">if</span> <span class="p">(</span><span class="n">ltempeq</span> <span class="p">)</span> <span class="k">then</span>
<a name="ln-1958"></a><span class="k">          </span><span class="n">storet0indum</span><span class="p">(</span><span class="n">jsdum</span><span class="p">:</span><span class="n">jfdum</span><span class="p">,:,:)</span>    <span class="o">=</span> <span class="n">storet0inold</span><span class="p">(</span><span class="n">js</span><span class="p">:</span><span class="n">jf</span><span class="p">,:,:)</span>      <span class="c">! s: start  f: final</span>
<a name="ln-1959"></a>        <span class="k">end if</span>
<a name="ln-1960"></a><span class="k">      end do</span>  <span class="c">! loop over original inlet files</span>
<a name="ln-1961"></a>  <span class="c">! now interpolate in y</span>
<a name="ln-1962"></a>      <span class="k">call </span><span class="n">yinterpolate</span> <span class="p">(</span><span class="n">storeu0indum</span><span class="p">,</span><span class="n">storeu0innew</span><span class="p">,</span><span class="n">kbin</span><span class="p">,</span><span class="n">kein</span><span class="p">)</span>
<a name="ln-1963"></a>      <span class="k">call </span><span class="n">yinterpolate</span> <span class="p">(</span><span class="n">storev0indum</span><span class="p">,</span><span class="n">storev0innew</span><span class="p">,</span><span class="n">kbin</span><span class="p">,</span><span class="n">kein</span><span class="p">)</span>
<a name="ln-1964"></a>      <span class="k">call </span><span class="n">yinterpolate</span> <span class="p">(</span><span class="n">storew0indum</span><span class="p">,</span><span class="n">storew0innew</span><span class="p">,</span><span class="n">kbin</span><span class="p">,</span><span class="n">kein</span><span class="o">+</span><span class="mi">1</span><span class="p">)</span>
<a name="ln-1965"></a>      <span class="k">call </span><span class="n">yinterpolate</span> <span class="p">(</span><span class="n">storet0indum</span><span class="p">,</span><span class="n">storet0innew</span><span class="p">,</span><span class="n">kbin</span><span class="p">,</span><span class="n">kein</span><span class="p">)</span>
<a name="ln-1966"></a>
<a name="ln-1967"></a>      <span class="k">if</span> <span class="p">(.</span><span class="nb">not</span><span class="p">.</span><span class="n">lzinzsim</span><span class="p">)</span> <span class="k">then</span> <span class="c">! interpolate when zin =/ zsim</span>
<a name="ln-1968"></a>        <span class="k">call </span><span class="n">zinterpolate</span> <span class="p">(</span><span class="n">storeu0innew</span><span class="p">(:,:,:),</span><span class="n">storeu0inletbc</span><span class="p">)</span>   <span class="c">! interpolate inlet profile to zgrid</span>
<a name="ln-1969"></a>        <span class="k">call </span><span class="n">zinterpolate</span> <span class="p">(</span><span class="n">storev0innew</span><span class="p">(:,:,:),</span><span class="n">storev0inletbc</span><span class="p">)</span>   <span class="c">! interpolate inlet profile to zgrid</span>
<a name="ln-1970"></a>        <span class="k">call </span><span class="n">zinterpolatew</span><span class="p">(</span><span class="n">storew0innew</span><span class="p">(:,:,:),</span><span class="n">storew0inletbc</span><span class="p">)</span>   <span class="c">! interpolate inlet profile to zgrid</span>
<a name="ln-1971"></a>        <span class="k">if</span> <span class="p">(</span><span class="n">ltempeq</span><span class="p">)</span> <span class="k">then</span>
<a name="ln-1972"></a><span class="k">          call </span><span class="n">zinterpolatet</span><span class="p">(</span><span class="n">storet0innew</span><span class="p">(:,:,:),</span><span class="n">storet0inletbc</span><span class="p">)</span>   <span class="c">! interpolate inlet profile to zgrid</span>
<a name="ln-1973"></a>        <span class="k">end if</span>
<a name="ln-1974"></a><span class="k">      else</span>
<a name="ln-1975"></a><span class="k">        </span><span class="n">storeu0inletbc</span><span class="p">(:,:,:)</span> <span class="o">=</span> <span class="n">storeu0inold</span><span class="p">(:,:,:)</span>
<a name="ln-1976"></a>        <span class="n">storev0inletbc</span><span class="p">(:,:,:)</span> <span class="o">=</span> <span class="n">storev0inold</span><span class="p">(:,:,:)</span>
<a name="ln-1977"></a>        <span class="n">storew0inletbc</span><span class="p">(:,:,:)</span> <span class="o">=</span> <span class="n">storew0inold</span><span class="p">(:,:,:)</span>
<a name="ln-1978"></a>        <span class="k">if</span> <span class="p">(</span><span class="n">ltempeq</span><span class="p">)</span> <span class="k">then</span>
<a name="ln-1979"></a><span class="k">          </span><span class="n">storet0inletbc</span><span class="p">(:,:,:)</span> <span class="o">=</span> <span class="n">storet0inold</span><span class="p">(:,:,:)</span>
<a name="ln-1980"></a>        <span class="k">end if</span>
<a name="ln-1981"></a><span class="k">      end if</span>
<a name="ln-1982"></a>
<a name="ln-1983"></a><span class="k">      if</span> <span class="p">(</span><span class="n">iangle</span><span class="o">/=</span><span class="mf">0.0</span><span class="p">)</span> <span class="k">then</span>   <span class="c">! modify for inflow angle</span>
<a name="ln-1984"></a>         <span class="k">do </span><span class="n">n</span><span class="o">=</span><span class="mi">1</span><span class="p">,</span><span class="n">nstore</span>
<a name="ln-1985"></a>         <span class="k">do </span><span class="n">k</span><span class="o">=</span><span class="n">kb</span><span class="p">,</span><span class="n">ke</span>
<a name="ln-1986"></a>         <span class="k">do </span><span class="n">j</span><span class="o">=</span><span class="n">jb</span><span class="p">,</span><span class="n">je</span>
<a name="ln-1987"></a>           <span class="n">u0rot</span><span class="p">(</span><span class="n">n</span><span class="p">,</span><span class="n">j</span><span class="p">,</span><span class="n">k</span><span class="p">)</span> <span class="o">=</span> <span class="n">storeu0inletbc</span><span class="p">(</span><span class="n">j</span><span class="p">,</span><span class="n">k</span><span class="p">,</span><span class="n">n</span><span class="p">)</span>         <span class="c">! swap indices in order</span>
<a name="ln-1988"></a>           <span class="n">v0rot</span><span class="p">(</span><span class="n">n</span><span class="p">,</span><span class="n">j</span><span class="p">,</span><span class="n">k</span><span class="p">)</span> <span class="o">=</span> <span class="n">storev0inletbc</span><span class="p">(</span><span class="n">j</span><span class="p">,</span><span class="n">k</span><span class="p">,</span><span class="n">n</span><span class="p">)</span>         <span class="c">! to use excjs</span>
<a name="ln-1989"></a>         <span class="k">end do</span>
<a name="ln-1990"></a><span class="k">         end do</span>
<a name="ln-1991"></a><span class="k">         end do</span>
<a name="ln-1992"></a><span class="k">         call </span><span class="n">excjs</span><span class="p">(</span><span class="n">u0rot</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span><span class="n">nstore</span><span class="p">,</span><span class="n">jb</span><span class="p">,</span><span class="n">je</span><span class="p">,</span><span class="n">kb</span><span class="p">,</span><span class="n">ke</span><span class="p">,</span><span class="mi">0</span><span class="p">,</span><span class="n">jh</span><span class="p">)</span>
<a name="ln-1993"></a>         <span class="k">call </span><span class="n">excjs</span><span class="p">(</span><span class="n">v0rot</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span><span class="n">nstore</span><span class="p">,</span><span class="n">jb</span><span class="p">,</span><span class="n">je</span><span class="p">,</span><span class="n">kb</span><span class="p">,</span><span class="n">ke</span><span class="p">,</span><span class="mi">0</span><span class="p">,</span><span class="n">jh</span><span class="p">)</span>
<a name="ln-1994"></a><span class="c">!         write(6,*) &#39;v0rot(1,je+1,30) = &#39;,v0rot(1,je+1,30)</span>
<a name="ln-1995"></a>         <span class="k">do </span><span class="n">n</span><span class="o">=</span><span class="mi">1</span><span class="p">,</span><span class="n">nstore</span>
<a name="ln-1996"></a>         <span class="k">do </span><span class="n">k</span><span class="o">=</span><span class="n">kb</span><span class="p">,</span><span class="n">ke</span>
<a name="ln-1997"></a>         <span class="k">do </span><span class="n">j</span><span class="o">=</span><span class="n">jb</span><span class="p">,</span><span class="n">je</span>
<a name="ln-1998"></a>         <span class="c">! apply horizontal rotation (neglecting the delta_x difference)</span>
<a name="ln-1999"></a>           <span class="n">storeu0inletbc</span><span class="p">(</span><span class="n">j</span><span class="p">,</span><span class="n">k</span><span class="p">,</span><span class="n">n</span><span class="p">)</span> <span class="o">=</span> <span class="n">u0rot</span><span class="p">(</span><span class="n">n</span><span class="p">,</span><span class="n">j</span><span class="p">,</span><span class="n">k</span><span class="p">)</span><span class="o">*</span><span class="nb">cos</span><span class="p">(</span><span class="n">iangle</span><span class="p">)</span> <span class="o">-</span> <span class="mf">0.5</span><span class="o">*</span><span class="nb">sin</span><span class="p">(</span><span class="n">iangle</span><span class="p">)</span><span class="o">*</span><span class="p">(</span><span class="n">v0rot</span><span class="p">(</span><span class="n">n</span><span class="p">,</span><span class="n">j</span><span class="p">,</span><span class="n">k</span><span class="p">)</span><span class="o">+</span><span class="n">v0rot</span><span class="p">(</span><span class="n">n</span><span class="p">,</span><span class="n">j</span><span class="o">+</span><span class="mi">1</span><span class="p">,</span><span class="n">k</span><span class="p">))</span>
<a name="ln-2000"></a>           <span class="n">storev0inletbc</span><span class="p">(</span><span class="n">j</span><span class="p">,</span><span class="n">k</span><span class="p">,</span><span class="n">n</span><span class="p">)</span> <span class="o">=</span> <span class="n">v0rot</span><span class="p">(</span><span class="n">n</span><span class="p">,</span><span class="n">j</span><span class="p">,</span><span class="n">k</span><span class="p">)</span><span class="o">*</span><span class="nb">cos</span><span class="p">(</span><span class="n">iangle</span><span class="p">)</span> <span class="o">+</span> <span class="mf">0.5</span><span class="o">*</span><span class="nb">sin</span><span class="p">(</span><span class="n">iangle</span><span class="p">)</span><span class="o">*</span><span class="p">(</span><span class="n">u0rot</span><span class="p">(</span><span class="n">n</span><span class="p">,</span><span class="n">j</span><span class="p">,</span><span class="n">k</span><span class="p">)</span><span class="o">+</span><span class="n">u0rot</span><span class="p">(</span><span class="n">n</span><span class="p">,</span><span class="n">j</span><span class="o">-</span><span class="mi">1</span><span class="p">,</span><span class="n">k</span><span class="p">))</span>
<a name="ln-2001"></a>         <span class="k">end do</span>
<a name="ln-2002"></a><span class="k">         end do</span>
<a name="ln-2003"></a><span class="k">         end do</span>
<a name="ln-2004"></a><span class="k">      end if</span> <span class="c">! iangle =/0.0</span>
<a name="ln-2005"></a>
<a name="ln-2006"></a>
<a name="ln-2007"></a>  <span class="k">end subroutine </span><span class="n">readinletfile</span>
<a name="ln-2008"></a>
<a name="ln-2009"></a>
<a name="ln-2010"></a>
<a name="ln-2011"></a>  <span class="k">subroutine </span><span class="n">zinterpolate</span><span class="p">(</span><span class="n">input</span><span class="p">,</span><span class="n">output</span><span class="p">)</span>
<a name="ln-2012"></a>  <span class="k">use </span><span class="n">modglobal</span><span class="p">,</span>      <span class="n">only</span> <span class="p">:</span> <span class="n">jb</span><span class="p">,</span><span class="n">je</span><span class="p">,</span><span class="n">kb</span><span class="p">,</span><span class="n">ke</span><span class="p">,</span><span class="n">zf</span><span class="p">,</span><span class="n">nstore</span>
<a name="ln-2013"></a>  <span class="k">implicit none</span>
<a name="ln-2014"></a><span class="k">  </span><span class="kt">real</span><span class="p">,</span> <span class="k">dimension</span><span class="p">(</span><span class="n">jb</span><span class="p">:</span><span class="n">je</span><span class="p">,</span><span class="n">kbin</span><span class="p">:</span><span class="n">kein</span><span class="p">,</span><span class="mi">1</span><span class="p">:</span><span class="n">nstore</span><span class="p">),</span> <span class="k">intent</span><span class="p">(</span><span class="n">in</span><span class="p">)</span>  <span class="kd">::</span> <span class="n">input</span>
<a name="ln-2015"></a>  <span class="kt">real</span><span class="p">,</span> <span class="k">dimension</span><span class="p">(</span><span class="n">jb</span><span class="p">:</span><span class="n">je</span><span class="p">,</span><span class="n">kb</span><span class="p">:</span><span class="n">ke</span><span class="p">,</span><span class="mi">1</span><span class="p">:</span><span class="n">nstore</span><span class="p">),</span> <span class="k">intent</span><span class="p">(</span><span class="n">inout</span><span class="p">)</span> <span class="kd">::</span> <span class="n">output</span>
<a name="ln-2016"></a>  <span class="kt">integer </span><span class="n">k</span>
<a name="ln-2017"></a>
<a name="ln-2018"></a>     <span class="k">do </span><span class="n">k</span><span class="o">=</span><span class="n">kb</span><span class="p">,</span><span class="n">ke</span>
<a name="ln-2019"></a>      <span class="k">if</span> <span class="p">(</span><span class="n">linuf</span><span class="p">(</span><span class="n">k</span><span class="p">)</span> <span class="o">==</span> <span class="n">kein</span><span class="o">+</span><span class="mi">1</span><span class="p">)</span> <span class="k">then</span>      <span class="c">! indicator for extrapolation!</span>
<a name="ln-2020"></a>        <span class="n">output</span><span class="p">(:,</span><span class="n">k</span><span class="p">,:)</span> <span class="o">=</span> <span class="n">input</span><span class="p">(:,</span><span class="n">kein</span><span class="p">,:)</span>
<a name="ln-2021"></a>      <span class="n">elseif</span> <span class="p">(</span><span class="n">linlf</span><span class="p">(</span><span class="n">k</span><span class="p">)</span> <span class="o">==</span> <span class="n">kbin</span><span class="o">-</span><span class="mi">1</span><span class="p">)</span> <span class="k">then</span> <span class="c">! interprets this as extrapolation to bottom (use u=0 at z+=0)</span>
<a name="ln-2022"></a>        <span class="n">output</span><span class="p">(:,</span><span class="n">k</span><span class="p">,:)</span> <span class="o">=</span> <span class="n">input</span><span class="p">(:,</span><span class="n">kbin</span><span class="p">,:)</span><span class="o">/</span><span class="n">zfin</span><span class="p">(</span><span class="n">kbin</span><span class="p">)</span> <span class="o">*</span> <span class="n">zf</span><span class="p">(</span><span class="n">k</span><span class="p">)</span>
<a name="ln-2023"></a><span class="c">!        output(:,k,:) = input(:,kbin,:)   ! temeperature is not zero at the wall, so line above is wrong</span>
<a name="ln-2024"></a>      <span class="k">else</span>                            <span class="c">! normal interpolation</span>
<a name="ln-2025"></a>        <span class="n">output</span><span class="p">(:,</span><span class="n">k</span><span class="p">,:)</span> <span class="o">=</span> <span class="n">input</span><span class="p">(:,</span><span class="n">linlf</span><span class="p">(</span><span class="n">k</span><span class="p">),:)</span> <span class="o">+</span> <span class="p">(</span><span class="n">input</span><span class="p">(:,</span><span class="n">linuf</span><span class="p">(</span><span class="n">k</span><span class="p">),:)</span> <span class="o">-</span> <span class="n">input</span><span class="p">(:,</span><span class="n">linlf</span><span class="p">(</span><span class="n">k</span><span class="p">),:))</span> <span class="o">/</span> <span class="p">(</span><span class="n">zfin</span><span class="p">(</span><span class="n">linuf</span><span class="p">(</span><span class="n">k</span><span class="p">))</span> <span class="o">-</span> <span class="n">zfin</span><span class="p">(</span><span class="n">linlf</span><span class="p">(</span><span class="n">k</span><span class="p">)))</span> <span class="o">*</span> <span class="p">(</span><span class="n">zf</span><span class="p">(</span><span class="n">k</span><span class="p">)</span> <span class="o">-</span> <span class="n">zfin</span><span class="p">(</span><span class="n">linlf</span><span class="p">(</span><span class="n">k</span><span class="p">)))</span>
<a name="ln-2026"></a>        <span class="k">if</span> <span class="p">((</span><span class="n">zf</span><span class="p">(</span><span class="n">k</span><span class="p">)</span> <span class="p">.</span><span class="n">gt</span><span class="p">.</span> <span class="n">zfin</span><span class="p">(</span><span class="n">linuf</span><span class="p">(</span><span class="n">k</span><span class="p">)))</span> <span class="p">.</span><span class="nb">or</span><span class="p">.</span> <span class="p">(</span><span class="n">zf</span><span class="p">(</span><span class="n">k</span><span class="p">)</span> <span class="p">.</span><span class="n">lt</span><span class="p">.</span> <span class="n">zfin</span><span class="p">(</span><span class="n">linlf</span><span class="p">(</span><span class="n">k</span><span class="p">))))</span> <span class="k">then</span>
<a name="ln-2027"></a><span class="k">          write</span><span class="p">(</span><span class="mi">6</span><span class="p">,</span><span class="o">*</span><span class="p">)</span> <span class="s1">&#39;!!!Mistake in zinterpolate !!!!&#39;</span>
<a name="ln-2028"></a>        <span class="k">end if</span>
<a name="ln-2029"></a><span class="k">      end if</span>
<a name="ln-2030"></a><span class="k">    end do</span>
<a name="ln-2031"></a>
<a name="ln-2032"></a>
<a name="ln-2033"></a><span class="k">  end subroutine </span><span class="n">zinterpolate</span>
<a name="ln-2034"></a>
<a name="ln-2035"></a>  <span class="k">subroutine </span><span class="n">zinterpolate1d</span><span class="p">(</span><span class="n">input</span><span class="p">,</span><span class="n">output</span><span class="p">)</span>
<a name="ln-2036"></a>  <span class="k">use </span><span class="n">modglobal</span><span class="p">,</span>      <span class="n">only</span> <span class="p">:</span> <span class="n">kb</span><span class="p">,</span><span class="n">ke</span><span class="p">,</span><span class="n">zf</span>
<a name="ln-2037"></a>  <span class="k">implicit none</span>
<a name="ln-2038"></a><span class="k">  </span><span class="kt">real</span><span class="p">,</span> <span class="k">dimension</span><span class="p">(</span><span class="n">kbin</span><span class="p">:</span><span class="n">kein</span><span class="p">),</span> <span class="k">intent</span><span class="p">(</span><span class="n">in</span><span class="p">)</span>  <span class="kd">::</span> <span class="n">input</span>
<a name="ln-2039"></a>  <span class="kt">real</span><span class="p">,</span> <span class="k">dimension</span><span class="p">(</span><span class="n">kb</span><span class="p">:</span><span class="n">ke</span><span class="p">),</span> <span class="k">intent</span><span class="p">(</span><span class="n">inout</span><span class="p">)</span> <span class="kd">::</span> <span class="n">output</span>
<a name="ln-2040"></a>  <span class="kt">integer </span><span class="n">k</span>
<a name="ln-2041"></a>
<a name="ln-2042"></a>     <span class="k">do </span><span class="n">k</span><span class="o">=</span><span class="n">kb</span><span class="p">,</span><span class="n">ke</span>
<a name="ln-2043"></a>      <span class="k">if</span> <span class="p">(</span><span class="n">linuf</span><span class="p">(</span><span class="n">k</span><span class="p">)</span> <span class="o">==</span> <span class="n">kein</span><span class="o">+</span><span class="mi">1</span><span class="p">)</span> <span class="k">then</span>      <span class="c">! indicator for extrapolation!</span>
<a name="ln-2044"></a>        <span class="n">output</span><span class="p">(</span><span class="n">k</span><span class="p">)</span> <span class="o">=</span> <span class="n">input</span><span class="p">(</span><span class="n">kein</span><span class="p">)</span>
<a name="ln-2045"></a>      <span class="n">elseif</span> <span class="p">(</span><span class="n">linlf</span><span class="p">(</span><span class="n">k</span><span class="p">)</span> <span class="o">==</span> <span class="n">kbin</span><span class="o">-</span><span class="mi">1</span><span class="p">)</span> <span class="k">then</span> <span class="c">! interprets this as extrapolation to bottom (use u=0 at z+=0)</span>
<a name="ln-2046"></a>        <span class="n">output</span><span class="p">(</span><span class="n">k</span><span class="p">)</span> <span class="o">=</span> <span class="n">input</span><span class="p">(</span><span class="n">kbin</span><span class="p">)</span><span class="o">/</span><span class="n">zfin</span><span class="p">(</span><span class="n">kbin</span><span class="p">)</span> <span class="o">*</span> <span class="n">zf</span><span class="p">(</span><span class="n">k</span><span class="p">)</span>
<a name="ln-2047"></a><span class="c">!        output(:,k,:) = input(:,kbin,:)   ! temeperature is not zero at the wall, so line above is wrong</span>
<a name="ln-2048"></a>      <span class="k">else</span>                            <span class="c">! normal interpolation</span>
<a name="ln-2049"></a>        <span class="n">output</span><span class="p">(</span><span class="n">k</span><span class="p">)</span> <span class="o">=</span> <span class="n">input</span><span class="p">(</span><span class="n">linlf</span><span class="p">(</span><span class="n">k</span><span class="p">))</span> <span class="o">+</span> <span class="p">(</span><span class="n">input</span><span class="p">(</span><span class="n">linuf</span><span class="p">(</span><span class="n">k</span><span class="p">))</span> <span class="o">-</span> <span class="n">input</span><span class="p">(</span><span class="n">linlf</span><span class="p">(</span><span class="n">k</span><span class="p">)))</span> <span class="o">/</span> <span class="p">(</span><span class="n">zfin</span><span class="p">(</span><span class="n">linuf</span><span class="p">(</span><span class="n">k</span><span class="p">))</span> <span class="o">-</span> <span class="n">zfin</span><span class="p">(</span><span class="n">linlf</span><span class="p">(</span><span class="n">k</span><span class="p">)))</span> <span class="o">*</span> <span class="p">(</span><span class="n">zf</span><span class="p">(</span><span class="n">k</span><span class="p">)</span> <span class="o">-</span> <span class="n">zf</span><span class="p">(</span><span class="n">linlf</span><span class="p">(</span><span class="n">k</span><span class="p">)))</span>
<a name="ln-2050"></a>        <span class="k">if</span> <span class="p">((</span><span class="n">zf</span><span class="p">(</span><span class="n">k</span><span class="p">)</span> <span class="p">.</span><span class="n">gt</span><span class="p">.</span> <span class="n">zfin</span><span class="p">(</span><span class="n">linuf</span><span class="p">(</span><span class="n">k</span><span class="p">)))</span> <span class="p">.</span><span class="nb">or</span><span class="p">.</span> <span class="p">(</span><span class="n">zf</span><span class="p">(</span><span class="n">k</span><span class="p">)</span> <span class="p">.</span><span class="n">lt</span><span class="p">.</span> <span class="n">zfin</span><span class="p">(</span><span class="n">linlf</span><span class="p">(</span><span class="n">k</span><span class="p">))))</span> <span class="k">then</span>
<a name="ln-2051"></a><span class="k">          write</span><span class="p">(</span><span class="mi">6</span><span class="p">,</span><span class="o">*</span><span class="p">)</span> <span class="s1">&#39;!!!Mistake in zinterpolate1d !!!!&#39;</span>
<a name="ln-2052"></a>        <span class="k">end if</span>
<a name="ln-2053"></a><span class="k">      end if</span>
<a name="ln-2054"></a><span class="k">    end do</span>
<a name="ln-2055"></a>
<a name="ln-2056"></a><span class="k">  end subroutine </span><span class="n">zinterpolate1d</span>
<a name="ln-2057"></a>
<a name="ln-2058"></a> <span class="k">subroutine </span><span class="n">zinterpolate2d</span><span class="p">(</span><span class="n">input</span><span class="p">,</span><span class="n">output</span><span class="p">)</span>
<a name="ln-2059"></a>  <span class="k">use </span><span class="n">modglobal</span><span class="p">,</span>      <span class="n">only</span> <span class="p">:</span> <span class="n">ib</span><span class="p">,</span><span class="n">ie</span><span class="p">,</span><span class="n">kb</span><span class="p">,</span><span class="n">ke</span><span class="p">,</span><span class="n">zf</span><span class="p">,</span><span class="n">nstore</span>
<a name="ln-2060"></a>  <span class="k">implicit none</span>
<a name="ln-2061"></a><span class="k">  </span><span class="kt">real</span><span class="p">,</span> <span class="k">dimension</span><span class="p">(</span><span class="n">ib</span><span class="p">:</span><span class="n">ie</span><span class="p">,</span><span class="n">kbin</span><span class="p">:</span><span class="n">kein</span><span class="p">),</span> <span class="k">intent</span><span class="p">(</span><span class="n">in</span><span class="p">)</span>  <span class="kd">::</span> <span class="n">input</span>
<a name="ln-2062"></a>  <span class="kt">real</span><span class="p">,</span> <span class="k">dimension</span><span class="p">(</span><span class="n">ib</span><span class="p">:</span><span class="n">ie</span><span class="p">,</span><span class="n">kb</span><span class="p">:</span><span class="n">ke</span><span class="p">),</span> <span class="k">intent</span><span class="p">(</span><span class="n">inout</span><span class="p">)</span> <span class="kd">::</span> <span class="n">output</span>
<a name="ln-2063"></a>  <span class="kt">integer </span><span class="n">k</span>
<a name="ln-2064"></a>
<a name="ln-2065"></a>     <span class="k">do </span><span class="n">k</span><span class="o">=</span><span class="n">kb</span><span class="p">,</span><span class="n">ke</span>
<a name="ln-2066"></a>      <span class="k">if</span> <span class="p">(</span><span class="n">linuf</span><span class="p">(</span><span class="n">k</span><span class="p">)</span> <span class="o">==</span> <span class="n">kein</span><span class="o">+</span><span class="mi">1</span><span class="p">)</span> <span class="k">then</span>      <span class="c">! indicator for extrapolation!</span>
<a name="ln-2067"></a>        <span class="n">output</span><span class="p">(:,</span><span class="n">k</span><span class="p">)</span> <span class="o">=</span> <span class="n">input</span><span class="p">(:,</span><span class="n">kein</span><span class="p">)</span>
<a name="ln-2068"></a>      <span class="n">elseif</span> <span class="p">(</span><span class="n">linlf</span><span class="p">(</span><span class="n">k</span><span class="p">)</span> <span class="o">==</span> <span class="n">kbin</span><span class="o">-</span><span class="mi">1</span><span class="p">)</span> <span class="k">then</span> <span class="c">! interprets this as extrapolation to bottom (use u=0 at z+=0)</span>
<a name="ln-2069"></a>        <span class="n">output</span><span class="p">(:,</span><span class="n">k</span><span class="p">)</span> <span class="o">=</span> <span class="n">input</span><span class="p">(:,</span><span class="n">kbin</span><span class="p">)</span><span class="o">/</span><span class="n">zfin</span><span class="p">(</span><span class="n">kbin</span><span class="p">)</span> <span class="o">*</span> <span class="n">zf</span><span class="p">(</span><span class="n">k</span><span class="p">)</span>
<a name="ln-2070"></a><span class="c">!        output(:,k,:) = input(:,kbin,:)   ! temeperature is not zero at the wall, so line above is wrong</span>
<a name="ln-2071"></a>      <span class="k">else</span>                            <span class="c">! normal interpolation</span>
<a name="ln-2072"></a>        <span class="n">output</span><span class="p">(:,</span><span class="n">k</span><span class="p">)</span> <span class="o">=</span> <span class="n">input</span><span class="p">(:,</span><span class="n">linlf</span><span class="p">(</span><span class="n">k</span><span class="p">))</span> <span class="o">+</span> <span class="p">(</span><span class="n">input</span><span class="p">(:,</span><span class="n">linuf</span><span class="p">(</span><span class="n">k</span><span class="p">))</span> <span class="o">-</span> <span class="n">input</span><span class="p">(:,</span><span class="n">linlf</span><span class="p">(</span><span class="n">k</span><span class="p">)))</span> <span class="o">/</span> <span class="p">(</span><span class="n">zfin</span><span class="p">(</span><span class="n">linuf</span><span class="p">(</span><span class="n">k</span><span class="p">))</span> <span class="o">-</span> <span class="n">zfin</span><span class="p">(</span><span class="n">linlf</span><span class="p">(</span><span class="n">k</span><span class="p">)))</span> <span class="o">*</span> <span class="p">(</span><span class="n">zf</span><span class="p">(</span><span class="n">k</span><span class="p">)</span> <span class="o">-</span> <span class="n">zf</span><span class="p">(</span><span class="n">linlf</span><span class="p">(</span><span class="n">k</span><span class="p">)))</span>
<a name="ln-2073"></a>        <span class="k">if</span> <span class="p">((</span><span class="n">zf</span><span class="p">(</span><span class="n">k</span><span class="p">)</span> <span class="p">.</span><span class="n">gt</span><span class="p">.</span> <span class="n">zfin</span><span class="p">(</span><span class="n">linuf</span><span class="p">(</span><span class="n">k</span><span class="p">)))</span> <span class="p">.</span><span class="nb">or</span><span class="p">.</span> <span class="p">(</span><span class="n">zf</span><span class="p">(</span><span class="n">k</span><span class="p">)</span> <span class="p">.</span><span class="n">lt</span><span class="p">.</span> <span class="n">zfin</span><span class="p">(</span><span class="n">linlf</span><span class="p">(</span><span class="n">k</span><span class="p">))))</span> <span class="k">then</span>
<a name="ln-2074"></a><span class="k">          write</span><span class="p">(</span><span class="mi">6</span><span class="p">,</span><span class="o">*</span><span class="p">)</span> <span class="s1">&#39;!!!Mistake in zinterpolate2d !!!!&#39;</span>
<a name="ln-2075"></a>        <span class="k">end if</span>
<a name="ln-2076"></a><span class="k">      end if</span>
<a name="ln-2077"></a><span class="k">    end do</span>
<a name="ln-2078"></a>
<a name="ln-2079"></a>
<a name="ln-2080"></a><span class="k">  end subroutine </span><span class="n">zinterpolate2d</span>
<a name="ln-2081"></a>
<a name="ln-2082"></a>
<a name="ln-2083"></a>  <span class="k">subroutine </span><span class="n">zinterpolatew</span><span class="p">(</span><span class="n">input</span><span class="p">,</span><span class="n">output</span><span class="p">)</span>
<a name="ln-2084"></a>  <span class="k">use </span><span class="n">modglobal</span><span class="p">,</span>      <span class="n">only</span> <span class="p">:</span> <span class="n">jb</span><span class="p">,</span><span class="n">je</span><span class="p">,</span><span class="n">kb</span><span class="p">,</span><span class="n">ke</span><span class="p">,</span><span class="n">zh</span><span class="p">,</span><span class="n">nstore</span>
<a name="ln-2085"></a>  <span class="k">implicit none</span>
<a name="ln-2086"></a><span class="k">  </span><span class="kt">real</span><span class="p">,</span> <span class="k">dimension</span><span class="p">(</span><span class="n">jb</span><span class="p">:</span><span class="n">je</span><span class="p">,</span><span class="n">kbin</span><span class="p">:</span><span class="n">kein</span><span class="o">+</span><span class="mi">1</span><span class="p">,</span><span class="mi">1</span><span class="p">:</span><span class="n">nstore</span><span class="p">),</span> <span class="k">intent</span><span class="p">(</span><span class="n">in</span><span class="p">)</span>  <span class="kd">::</span> <span class="n">input</span>
<a name="ln-2087"></a>  <span class="kt">real</span><span class="p">,</span> <span class="k">dimension</span><span class="p">(</span><span class="n">jb</span><span class="p">:</span><span class="n">je</span><span class="p">,</span><span class="n">kb</span><span class="p">:</span><span class="n">ke</span><span class="o">+</span><span class="mi">1</span><span class="p">,</span><span class="mi">1</span><span class="p">:</span><span class="n">nstore</span><span class="p">),</span> <span class="k">intent</span><span class="p">(</span><span class="n">inout</span><span class="p">)</span> <span class="kd">::</span> <span class="n">output</span>
<a name="ln-2088"></a>  <span class="kt">integer </span><span class="n">k</span>
<a name="ln-2089"></a>
<a name="ln-2090"></a>
<a name="ln-2091"></a>     <span class="k">do </span><span class="n">k</span><span class="o">=</span><span class="n">kb</span><span class="p">,</span><span class="n">ke</span><span class="o">+</span><span class="mi">1</span>
<a name="ln-2092"></a>      <span class="k">if</span> <span class="p">(</span><span class="n">linuh</span><span class="p">(</span><span class="n">k</span><span class="p">)</span> <span class="o">==</span> <span class="n">kein</span><span class="o">+</span><span class="mi">2</span><span class="p">)</span> <span class="k">then</span>      <span class="c">! indicator for extrapolation!</span>
<a name="ln-2093"></a>        <span class="n">output</span><span class="p">(:,</span><span class="n">k</span><span class="p">,:)</span> <span class="o">=</span> <span class="n">input</span><span class="p">(:,</span><span class="n">kein</span><span class="o">+</span><span class="mi">1</span><span class="p">,:)</span>
<a name="ln-2094"></a>      <span class="n">elseif</span> <span class="p">(</span><span class="n">linlh</span><span class="p">(</span><span class="n">k</span><span class="p">)</span> <span class="o">==</span> <span class="n">kbin</span><span class="o">-</span><span class="mi">1</span><span class="p">)</span> <span class="k">then</span> <span class="c">! interprets this as extrapolation to bottom (use u=0 at z+=0)</span>
<a name="ln-2095"></a>        <span class="n">output</span><span class="p">(:,</span><span class="n">k</span><span class="p">,:)</span> <span class="o">=</span> <span class="n">input</span><span class="p">(:,</span><span class="n">kbin</span><span class="p">,:)</span>  <span class="c">! =0</span>
<a name="ln-2096"></a><span class="c">!        output(:,k,:) = input(:,kbin,:)/zhin(kbin) * zh(k)</span>
<a name="ln-2097"></a><span class="c">!        output(:,k,:) = input(:,kbin,:)   ! temeperature is not zero at the wall, so line above is wrong</span>
<a name="ln-2098"></a>      <span class="k">else</span>                            <span class="c">! normal interpolation</span>
<a name="ln-2099"></a>        <span class="n">output</span><span class="p">(:,</span><span class="n">k</span><span class="p">,:)</span> <span class="o">=</span> <span class="n">input</span><span class="p">(:,</span><span class="n">linlh</span><span class="p">(</span><span class="n">k</span><span class="p">),:)</span> <span class="o">+</span> <span class="p">(</span><span class="n">input</span><span class="p">(:,</span><span class="n">linuh</span><span class="p">(</span><span class="n">k</span><span class="p">),:)</span> <span class="o">-</span> <span class="n">input</span><span class="p">(:,</span><span class="n">linlh</span><span class="p">(</span><span class="n">k</span><span class="p">),:))</span> <span class="o">/</span> <span class="p">(</span><span class="n">zhin</span><span class="p">(</span><span class="n">linuh</span><span class="p">(</span><span class="n">k</span><span class="p">))</span> <span class="o">-</span> <span class="n">zhin</span><span class="p">(</span><span class="n">linlh</span><span class="p">(</span><span class="n">k</span><span class="p">)))</span> <span class="o">*</span> <span class="p">(</span><span class="n">zh</span><span class="p">(</span><span class="n">k</span><span class="p">)</span> <span class="o">-</span> <span class="n">zhin</span><span class="p">(</span><span class="n">linlh</span><span class="p">(</span><span class="n">k</span><span class="p">)))</span>
<a name="ln-2100"></a>        <span class="k">if</span> <span class="p">((</span><span class="n">zh</span><span class="p">(</span><span class="n">k</span><span class="p">)</span> <span class="p">.</span><span class="n">gt</span><span class="p">.</span> <span class="n">zhin</span><span class="p">(</span><span class="n">linuh</span><span class="p">(</span><span class="n">k</span><span class="p">)))</span> <span class="p">.</span><span class="nb">or</span><span class="p">.</span> <span class="p">(</span><span class="n">zh</span><span class="p">(</span><span class="n">k</span><span class="p">)</span> <span class="p">.</span><span class="n">lt</span><span class="p">.</span> <span class="n">zhin</span><span class="p">(</span><span class="n">linlh</span><span class="p">(</span><span class="n">k</span><span class="p">))))</span> <span class="k">then</span>
<a name="ln-2101"></a><span class="k">          write</span><span class="p">(</span><span class="mi">6</span><span class="p">,</span><span class="o">*</span><span class="p">)</span> <span class="s1">&#39;!!!Mistake in zinterpolatew !!!!&#39;</span>
<a name="ln-2102"></a>        <span class="k">end if</span>
<a name="ln-2103"></a><span class="k">      end if</span>
<a name="ln-2104"></a><span class="k">    end do</span>
<a name="ln-2105"></a>
<a name="ln-2106"></a>
<a name="ln-2107"></a><span class="k">  end subroutine </span><span class="n">zinterpolatew</span>
<a name="ln-2108"></a>
<a name="ln-2109"></a>  <span class="k">subroutine </span><span class="n">zinterpolatew1d</span><span class="p">(</span><span class="n">input</span><span class="p">,</span><span class="n">output</span><span class="p">)</span>
<a name="ln-2110"></a>  <span class="k">use </span><span class="n">modglobal</span><span class="p">,</span>      <span class="n">only</span> <span class="p">:</span> <span class="n">kb</span><span class="p">,</span><span class="n">ke</span><span class="p">,</span><span class="n">zh</span>
<a name="ln-2111"></a>  <span class="k">implicit none</span>
<a name="ln-2112"></a><span class="k">  </span><span class="kt">real</span><span class="p">,</span> <span class="k">dimension</span><span class="p">(</span><span class="n">kbin</span><span class="p">:</span><span class="n">kein</span><span class="o">+</span><span class="mi">1</span><span class="p">),</span> <span class="k">intent</span><span class="p">(</span><span class="n">in</span><span class="p">)</span>  <span class="kd">::</span> <span class="n">input</span>
<a name="ln-2113"></a>  <span class="kt">real</span><span class="p">,</span> <span class="k">dimension</span><span class="p">(</span><span class="n">kb</span><span class="p">:</span><span class="n">ke</span><span class="o">+</span><span class="mi">1</span><span class="p">),</span> <span class="k">intent</span><span class="p">(</span><span class="n">inout</span><span class="p">)</span> <span class="kd">::</span> <span class="n">output</span>
<a name="ln-2114"></a>  <span class="kt">integer </span><span class="n">k</span>
<a name="ln-2115"></a>
<a name="ln-2116"></a>
<a name="ln-2117"></a>     <span class="k">do </span><span class="n">k</span><span class="o">=</span><span class="n">kb</span><span class="p">,</span><span class="n">ke</span><span class="o">+</span><span class="mi">1</span>
<a name="ln-2118"></a>      <span class="k">if</span> <span class="p">(</span><span class="n">linuh</span><span class="p">(</span><span class="n">k</span><span class="p">)</span> <span class="o">==</span> <span class="n">kein</span><span class="o">+</span><span class="mi">2</span><span class="p">)</span> <span class="k">then</span>      <span class="c">! indicator for extrapolation!</span>
<a name="ln-2119"></a>        <span class="n">output</span><span class="p">(</span><span class="n">k</span><span class="p">)</span> <span class="o">=</span> <span class="n">input</span><span class="p">(</span><span class="n">kein</span><span class="o">+</span><span class="mi">1</span><span class="p">)</span>
<a name="ln-2120"></a>      <span class="n">elseif</span> <span class="p">(</span><span class="n">linlh</span><span class="p">(</span><span class="n">k</span><span class="p">)</span> <span class="o">==</span> <span class="n">kbin</span><span class="o">-</span><span class="mi">1</span><span class="p">)</span> <span class="k">then</span> <span class="c">! interprets this as extrapolation to bottom (use u=0 at z+=0)</span>
<a name="ln-2121"></a>        <span class="n">output</span><span class="p">(</span><span class="n">k</span><span class="p">)</span> <span class="o">=</span> <span class="n">input</span><span class="p">(</span><span class="n">kbin</span><span class="p">)</span> <span class="c">!=0</span>
<a name="ln-2122"></a><span class="c">!        output(k) = input(kbin)/zhin(kbin) * zh(k)</span>
<a name="ln-2123"></a><span class="c">!        output(:,k,:) = input(:,kbin,:)   ! temeperature is not zero at the wall, so line above is wrong</span>
<a name="ln-2124"></a>      <span class="k">else</span>                            <span class="c">! normal interpolation</span>
<a name="ln-2125"></a>        <span class="n">output</span><span class="p">(</span><span class="n">k</span><span class="p">)</span> <span class="o">=</span> <span class="n">input</span><span class="p">(</span><span class="n">linlh</span><span class="p">(</span><span class="n">k</span><span class="p">))</span> <span class="o">+</span> <span class="p">(</span><span class="n">input</span><span class="p">(</span><span class="n">linuh</span><span class="p">(</span><span class="n">k</span><span class="p">))</span> <span class="o">-</span> <span class="n">input</span><span class="p">(</span><span class="n">linlh</span><span class="p">(</span><span class="n">k</span><span class="p">)))</span> <span class="o">/</span> <span class="p">(</span><span class="n">zhin</span><span class="p">(</span><span class="n">linuh</span><span class="p">(</span><span class="n">k</span><span class="p">))</span> <span class="o">-</span> <span class="n">zhin</span><span class="p">(</span><span class="n">linlh</span><span class="p">(</span><span class="n">k</span><span class="p">)))</span> <span class="o">*</span> <span class="p">(</span><span class="n">zh</span><span class="p">(</span><span class="n">k</span><span class="p">)</span> <span class="o">-</span> <span class="n">zh</span><span class="p">(</span><span class="n">linlh</span><span class="p">(</span><span class="n">k</span><span class="p">)))</span>
<a name="ln-2126"></a>        <span class="k">if</span> <span class="p">((</span><span class="n">zh</span><span class="p">(</span><span class="n">k</span><span class="p">)</span> <span class="p">.</span><span class="n">gt</span><span class="p">.</span> <span class="n">zhin</span><span class="p">(</span><span class="n">linuh</span><span class="p">(</span><span class="n">k</span><span class="p">)))</span> <span class="p">.</span><span class="nb">or</span><span class="p">.</span> <span class="p">(</span><span class="n">zh</span><span class="p">(</span><span class="n">k</span><span class="p">)</span> <span class="p">.</span><span class="n">lt</span><span class="p">.</span> <span class="n">zhin</span><span class="p">(</span><span class="n">linlh</span><span class="p">(</span><span class="n">k</span><span class="p">))))</span> <span class="k">then</span>
<a name="ln-2127"></a><span class="k">          write</span><span class="p">(</span><span class="mi">6</span><span class="p">,</span><span class="o">*</span><span class="p">)</span> <span class="s1">&#39;!!!Mistake in zinterpolatew1d !!!!&#39;</span>
<a name="ln-2128"></a>        <span class="k">end if</span>
<a name="ln-2129"></a><span class="k">      end if</span>
<a name="ln-2130"></a><span class="k">    end do</span>
<a name="ln-2131"></a>
<a name="ln-2132"></a>
<a name="ln-2133"></a><span class="k">  end subroutine </span><span class="n">zinterpolatew1d</span>
<a name="ln-2134"></a>
<a name="ln-2135"></a>
<a name="ln-2136"></a>
<a name="ln-2137"></a>  <span class="k">subroutine </span><span class="n">zinterpolatet</span><span class="p">(</span><span class="n">input</span><span class="p">,</span><span class="n">output</span><span class="p">)</span>
<a name="ln-2138"></a>  <span class="k">use </span><span class="n">modglobal</span><span class="p">,</span>      <span class="n">only</span> <span class="p">:</span> <span class="n">jb</span><span class="p">,</span><span class="n">je</span><span class="p">,</span><span class="n">kb</span><span class="p">,</span><span class="n">ke</span><span class="p">,</span><span class="n">zf</span><span class="p">,</span><span class="n">nstore</span>
<a name="ln-2139"></a>  <span class="k">use </span><span class="n">modsurfdata</span><span class="p">,</span>     <span class="n">only</span> <span class="p">:</span> <span class="n">thls</span>
<a name="ln-2140"></a>  <span class="k">implicit none</span>
<a name="ln-2141"></a><span class="k">  </span><span class="kt">real</span><span class="p">,</span> <span class="k">dimension</span><span class="p">(</span><span class="n">jb</span><span class="p">:</span><span class="n">je</span><span class="p">,</span><span class="n">kbin</span><span class="p">:</span><span class="n">kein</span><span class="p">,</span><span class="mi">1</span><span class="p">:</span><span class="n">nstore</span><span class="p">),</span> <span class="k">intent</span><span class="p">(</span><span class="n">in</span><span class="p">)</span>  <span class="kd">::</span> <span class="n">input</span>
<a name="ln-2142"></a>  <span class="kt">real</span><span class="p">,</span> <span class="k">dimension</span><span class="p">(</span><span class="n">jb</span><span class="p">:</span><span class="n">je</span><span class="p">,</span><span class="n">kb</span><span class="p">:</span><span class="n">ke</span><span class="p">,</span><span class="mi">1</span><span class="p">:</span><span class="n">nstore</span><span class="p">),</span> <span class="k">intent</span><span class="p">(</span><span class="n">inout</span><span class="p">)</span> <span class="kd">::</span> <span class="n">output</span>
<a name="ln-2143"></a>  <span class="kt">integer </span><span class="n">k</span>
<a name="ln-2144"></a>
<a name="ln-2145"></a>     <span class="k">do </span><span class="n">k</span><span class="o">=</span><span class="n">kb</span><span class="p">,</span><span class="n">ke</span>
<a name="ln-2146"></a>      <span class="k">if</span> <span class="p">(</span><span class="n">linuf</span><span class="p">(</span><span class="n">k</span><span class="p">)</span> <span class="o">==</span> <span class="n">kein</span><span class="o">+</span><span class="mi">1</span><span class="p">)</span> <span class="k">then</span>      <span class="c">! indicator for extrapolation!</span>
<a name="ln-2147"></a>        <span class="n">output</span><span class="p">(:,</span><span class="n">k</span><span class="p">,:)</span> <span class="o">=</span> <span class="n">input</span><span class="p">(:,</span><span class="n">kein</span><span class="p">,:)</span>
<a name="ln-2148"></a>      <span class="n">elseif</span> <span class="p">(</span><span class="n">linlf</span><span class="p">(</span><span class="n">k</span><span class="p">)</span> <span class="o">==</span> <span class="n">kbin</span><span class="o">-</span><span class="mi">1</span><span class="p">)</span> <span class="k">then</span> <span class="c">! interprets this as extrapolation to bottom (use u=0 at z+=0)</span>
<a name="ln-2149"></a>         <span class="n">output</span><span class="p">(:,</span><span class="n">k</span><span class="p">,:)</span> <span class="o">=</span> <span class="n">thls</span> <span class="o">+</span> <span class="p">(</span><span class="n">input</span><span class="p">(:,</span><span class="n">kb</span><span class="p">,:)</span><span class="o">-</span><span class="n">thls</span><span class="p">)</span><span class="o">/</span><span class="n">zfin</span><span class="p">(</span><span class="n">kbin</span><span class="p">)</span><span class="o">*</span><span class="n">zf</span><span class="p">(</span><span class="n">k</span><span class="p">)</span>
<a name="ln-2150"></a><span class="c">!         output(:,k,:) = (input(:,kb,:)-thls)/zfin(kbin)*zf(k)</span>
<a name="ln-2151"></a><span class="c">!        output(:,k,:) = input(:,kbin,:)/zfin(kbin) * zf(k)</span>
<a name="ln-2152"></a><span class="c">!        output(:,k,:) = input(:,kbin,:)   ! temeperature is not zero at the wall, so line above is wrong</span>
<a name="ln-2153"></a>      <span class="k">else</span>                            <span class="c">! normal interpolation</span>
<a name="ln-2154"></a>        <span class="n">output</span><span class="p">(:,</span><span class="n">k</span><span class="p">,:)</span> <span class="o">=</span> <span class="n">input</span><span class="p">(:,</span><span class="n">linlf</span><span class="p">(</span><span class="n">k</span><span class="p">),:)</span> <span class="o">+</span> <span class="p">(</span><span class="n">input</span><span class="p">(:,</span><span class="n">linuf</span><span class="p">(</span><span class="n">k</span><span class="p">),:)</span> <span class="o">-</span> <span class="n">input</span><span class="p">(:,</span><span class="n">linlf</span><span class="p">(</span><span class="n">k</span><span class="p">),:))</span> <span class="o">/</span> <span class="p">(</span><span class="n">zfin</span><span class="p">(</span><span class="n">linuf</span><span class="p">(</span><span class="n">k</span><span class="p">))</span> <span class="o">-</span> <span class="n">zfin</span><span class="p">(</span><span class="n">linlf</span><span class="p">(</span><span class="n">k</span><span class="p">)))</span> <span class="o">*</span> <span class="p">(</span><span class="n">zf</span><span class="p">(</span><span class="n">k</span><span class="p">)</span> <span class="o">-</span> <span class="n">zfin</span><span class="p">(</span><span class="n">linlf</span><span class="p">(</span><span class="n">k</span><span class="p">)))</span>
<a name="ln-2155"></a>        <span class="k">if</span> <span class="p">((</span><span class="n">zf</span><span class="p">(</span><span class="n">k</span><span class="p">)</span> <span class="p">.</span><span class="n">gt</span><span class="p">.</span> <span class="n">zfin</span><span class="p">(</span><span class="n">linuf</span><span class="p">(</span><span class="n">k</span><span class="p">)))</span> <span class="p">.</span><span class="nb">or</span><span class="p">.</span> <span class="p">(</span><span class="n">zf</span><span class="p">(</span><span class="n">k</span><span class="p">)</span> <span class="p">.</span><span class="n">lt</span><span class="p">.</span> <span class="n">zfin</span><span class="p">(</span><span class="n">linlf</span><span class="p">(</span><span class="n">k</span><span class="p">))))</span> <span class="k">then</span>
<a name="ln-2156"></a><span class="k">          write</span><span class="p">(</span><span class="mi">6</span><span class="p">,</span><span class="o">*</span><span class="p">)</span> <span class="s1">&#39;!!!Mistake in zinterpolatet !!!!&#39;</span>
<a name="ln-2157"></a>        <span class="k">end if</span>
<a name="ln-2158"></a><span class="k">      end if</span>
<a name="ln-2159"></a><span class="k">    end do</span>
<a name="ln-2160"></a>
<a name="ln-2161"></a>
<a name="ln-2162"></a><span class="k">  end subroutine </span><span class="n">zinterpolatet</span>
<a name="ln-2163"></a> 
<a name="ln-2164"></a>  <span class="k">subroutine </span><span class="n">zinterpolatet1d</span><span class="p">(</span><span class="n">input</span><span class="p">,</span><span class="n">output</span><span class="p">)</span>
<a name="ln-2165"></a>  <span class="k">use </span><span class="n">modglobal</span><span class="p">,</span>      <span class="n">only</span> <span class="p">:</span> <span class="n">jb</span><span class="p">,</span><span class="n">je</span><span class="p">,</span><span class="n">kb</span><span class="p">,</span><span class="n">ke</span><span class="p">,</span><span class="n">zf</span><span class="p">,</span><span class="n">nstore</span>
<a name="ln-2166"></a>  <span class="k">use </span><span class="n">modsurfdata</span><span class="p">,</span>     <span class="n">only</span> <span class="p">:</span> <span class="n">thls</span>
<a name="ln-2167"></a>  <span class="k">implicit none</span>
<a name="ln-2168"></a><span class="k">  </span><span class="kt">real</span><span class="p">,</span> <span class="k">dimension</span><span class="p">(</span><span class="n">kbin</span><span class="p">:</span><span class="n">kein</span><span class="p">),</span> <span class="k">intent</span><span class="p">(</span><span class="n">in</span><span class="p">)</span>  <span class="kd">::</span> <span class="n">input</span>
<a name="ln-2169"></a>  <span class="kt">real</span><span class="p">,</span> <span class="k">dimension</span><span class="p">(</span><span class="n">kb</span><span class="p">:</span><span class="n">ke</span><span class="p">),</span> <span class="k">intent</span><span class="p">(</span><span class="n">inout</span><span class="p">)</span> <span class="kd">::</span> <span class="n">output</span>
<a name="ln-2170"></a>  <span class="kt">integer </span><span class="n">k</span>
<a name="ln-2171"></a>
<a name="ln-2172"></a>
<a name="ln-2173"></a>     <span class="k">do </span><span class="n">k</span><span class="o">=</span><span class="n">kb</span><span class="p">,</span><span class="n">ke</span>
<a name="ln-2174"></a>      <span class="k">if</span> <span class="p">(</span><span class="n">linuf</span><span class="p">(</span><span class="n">k</span><span class="p">)</span> <span class="o">==</span> <span class="n">kein</span><span class="o">+</span><span class="mi">1</span><span class="p">)</span> <span class="k">then</span>      <span class="c">! indicator for extrapolation!</span>
<a name="ln-2175"></a>        <span class="n">output</span><span class="p">(</span><span class="n">k</span><span class="p">)</span> <span class="o">=</span> <span class="n">input</span><span class="p">(</span><span class="n">kein</span><span class="p">)</span>
<a name="ln-2176"></a>      <span class="n">elseif</span> <span class="p">(</span><span class="n">linlf</span><span class="p">(</span><span class="n">k</span><span class="p">)</span> <span class="o">==</span> <span class="n">kbin</span><span class="o">-</span><span class="mi">1</span><span class="p">)</span> <span class="k">then</span> <span class="c">! interprets this as extrapolation to bottom (use u=0 at z+=0)</span>
<a name="ln-2177"></a>         <span class="n">output</span><span class="p">(</span><span class="n">k</span><span class="p">)</span> <span class="o">=</span> <span class="p">(</span><span class="n">input</span><span class="p">(</span><span class="n">kb</span><span class="p">)</span><span class="o">-</span><span class="n">thls</span><span class="p">)</span><span class="o">/</span><span class="n">zfin</span><span class="p">(</span><span class="n">kbin</span><span class="p">)</span><span class="o">*</span><span class="n">zf</span><span class="p">(</span><span class="n">k</span><span class="p">)</span>
<a name="ln-2178"></a><span class="c">!        output(:,k,:) = input(:,kbin,:)/zfin(kbin) * zf(k)</span>
<a name="ln-2179"></a><span class="c">!        output(:,k,:) = input(:,kbin,:)   ! temeperature is not zero at the wall, so line above is wrong</span>
<a name="ln-2180"></a>      <span class="k">else</span>                            <span class="c">! normal interpolation</span>
<a name="ln-2181"></a>        <span class="n">output</span><span class="p">(</span><span class="n">k</span><span class="p">)</span> <span class="o">=</span> <span class="n">input</span><span class="p">(</span><span class="n">linlf</span><span class="p">(</span><span class="n">k</span><span class="p">))</span> <span class="o">+</span> <span class="p">(</span><span class="n">input</span><span class="p">(</span><span class="n">linuf</span><span class="p">(</span><span class="n">k</span><span class="p">))</span> <span class="o">-</span> <span class="n">input</span><span class="p">(</span><span class="n">linlf</span><span class="p">(</span><span class="n">k</span><span class="p">)))</span> <span class="o">/</span> <span class="p">(</span><span class="n">zfin</span><span class="p">(</span><span class="n">linuf</span><span class="p">(</span><span class="n">k</span><span class="p">))</span> <span class="o">-</span> <span class="n">zfin</span><span class="p">(</span><span class="n">linlf</span><span class="p">(</span><span class="n">k</span><span class="p">)))</span> <span class="o">*</span> <span class="p">(</span><span class="n">zf</span><span class="p">(</span><span class="n">k</span><span class="p">)</span> <span class="o">-</span> <span class="n">zf</span><span class="p">(</span><span class="n">linlf</span><span class="p">(</span><span class="n">k</span><span class="p">)))</span>
<a name="ln-2182"></a>        <span class="k">if</span> <span class="p">((</span><span class="n">zf</span><span class="p">(</span><span class="n">k</span><span class="p">)</span> <span class="p">.</span><span class="n">gt</span><span class="p">.</span> <span class="n">zfin</span><span class="p">(</span><span class="n">linuf</span><span class="p">(</span><span class="n">k</span><span class="p">)))</span> <span class="p">.</span><span class="nb">or</span><span class="p">.</span> <span class="p">(</span><span class="n">zf</span><span class="p">(</span><span class="n">k</span><span class="p">)</span> <span class="p">.</span><span class="n">lt</span><span class="p">.</span> <span class="n">zfin</span><span class="p">(</span><span class="n">linlf</span><span class="p">(</span><span class="n">k</span><span class="p">))))</span> <span class="k">then</span>
<a name="ln-2183"></a><span class="k">          write</span><span class="p">(</span><span class="mi">6</span><span class="p">,</span><span class="o">*</span><span class="p">)</span> <span class="s1">&#39;!!!Mistake in zinterpolatet1d !!!!&#39;</span>
<a name="ln-2184"></a>        <span class="k">end if</span>
<a name="ln-2185"></a><span class="k">      end if</span>
<a name="ln-2186"></a><span class="k">    end do</span>
<a name="ln-2187"></a>
<a name="ln-2188"></a>
<a name="ln-2189"></a><span class="k">  end subroutine </span><span class="n">zinterpolatet1d</span>
<a name="ln-2190"></a>
<a name="ln-2191"></a>  <span class="k">subroutine </span><span class="n">yinterpolate</span><span class="p">(</span><span class="n">input</span><span class="p">,</span><span class="n">output</span><span class="p">,</span><span class="n">ks</span><span class="p">,</span><span class="n">kf</span><span class="p">)</span>
<a name="ln-2192"></a>  <span class="k">use </span><span class="n">modglobal</span><span class="p">,</span> <span class="n">only</span> <span class="p">:</span> <span class="n">jb</span><span class="p">,</span><span class="n">je</span><span class="p">,</span> <span class="n">nstore</span>
<a name="ln-2193"></a>  <span class="kt">integer</span><span class="p">,</span> <span class="k">intent</span><span class="p">(</span><span class="n">in</span><span class="p">)</span> <span class="kd">::</span> <span class="n">ks</span>
<a name="ln-2194"></a>  <span class="kt">integer</span><span class="p">,</span> <span class="k">intent</span><span class="p">(</span><span class="n">in</span><span class="p">)</span> <span class="kd">::</span> <span class="n">kf</span>
<a name="ln-2195"></a>  <span class="kt">real</span><span class="p">,</span> <span class="k">dimension</span><span class="p">(</span><span class="n">jbdum</span><span class="p">:</span><span class="n">jedum</span><span class="p">,</span><span class="n">ks</span><span class="p">:</span><span class="n">kf</span><span class="p">,</span><span class="mi">1</span><span class="p">:</span><span class="n">nstore</span><span class="p">),</span> <span class="k">intent</span><span class="p">(</span><span class="n">in</span><span class="p">)</span>  <span class="kd">::</span> <span class="n">input</span>
<a name="ln-2196"></a>  <span class="kt">real</span><span class="p">,</span> <span class="k">dimension</span><span class="p">(</span><span class="n">jb</span>   <span class="p">:</span><span class="n">je</span>   <span class="p">,</span><span class="n">ks</span><span class="p">:</span><span class="n">kf</span><span class="p">,</span><span class="mi">1</span><span class="p">:</span><span class="n">nstore</span><span class="p">),</span> <span class="k">intent</span><span class="p">(</span><span class="n">inout</span><span class="p">)</span> <span class="kd">::</span> <span class="n">output</span>
<a name="ln-2197"></a>  <span class="kt">integer </span><span class="n">j</span>
<a name="ln-2198"></a>
<a name="ln-2199"></a>    <span class="k">do </span><span class="n">j</span><span class="o">=</span><span class="n">jb</span><span class="p">,</span><span class="n">je</span>
<a name="ln-2200"></a><span class="c">!      if (np==0 .and. yloclowf(j)==)</span>
<a name="ln-2201"></a>      <span class="n">output</span><span class="p">(</span><span class="n">j</span><span class="p">,:,:)</span> <span class="o">=</span> <span class="n">input</span><span class="p">(</span><span class="n">yloclowf</span><span class="p">(</span><span class="n">j</span><span class="p">),:,:)</span> <span class="o">+</span> <span class="p">(</span><span class="n">input</span><span class="p">(</span><span class="n">ylocupf</span><span class="p">(</span><span class="n">j</span><span class="p">),:,:)</span> <span class="o">-</span> <span class="n">input</span><span class="p">(</span><span class="n">yloclowf</span><span class="p">(</span><span class="n">j</span><span class="p">),:,:))</span> <span class="o">/</span> <span class="p">(</span><span class="n">yfdum</span><span class="p">(</span><span class="n">ylocupf</span><span class="p">(</span><span class="n">j</span><span class="p">))</span> <span class="o">-</span> <span class="n">yfdum</span><span class="p">(</span><span class="n">yloclowf</span><span class="p">(</span><span class="n">j</span><span class="p">)))</span> <span class="o">*</span> <span class="p">(</span><span class="n">yf</span><span class="p">(</span><span class="n">j</span><span class="p">)</span> <span class="o">-</span> <span class="n">yfdum</span><span class="p">(</span><span class="n">yloclowf</span><span class="p">(</span><span class="n">j</span><span class="p">)))</span>
<a name="ln-2202"></a>    <span class="k">end do</span>
<a name="ln-2203"></a><span class="k">  end subroutine </span><span class="n">yinterpolate</span>
<a name="ln-2204"></a>
<a name="ln-2205"></a>  <span class="k">subroutine </span><span class="n">yinterpolateh</span><span class="p">(</span><span class="n">input</span><span class="p">,</span><span class="n">output</span><span class="p">,</span><span class="n">ks</span><span class="p">,</span><span class="n">kf</span><span class="p">)</span>
<a name="ln-2206"></a>  <span class="k">use </span><span class="n">modglobal</span><span class="p">,</span> <span class="n">only</span> <span class="p">:</span> <span class="n">jb</span><span class="p">,</span><span class="n">je</span><span class="p">,</span> <span class="n">nstore</span>
<a name="ln-2207"></a>  <span class="kt">integer</span><span class="p">,</span> <span class="k">intent</span><span class="p">(</span><span class="n">in</span><span class="p">)</span> <span class="kd">::</span> <span class="n">ks</span>
<a name="ln-2208"></a>  <span class="kt">integer</span><span class="p">,</span> <span class="k">intent</span><span class="p">(</span><span class="n">in</span><span class="p">)</span> <span class="kd">::</span> <span class="n">kf</span>
<a name="ln-2209"></a>  <span class="kt">real</span><span class="p">,</span> <span class="k">dimension</span><span class="p">(</span><span class="n">jbdum</span><span class="p">:</span><span class="n">jedum</span><span class="p">,</span><span class="n">ks</span><span class="p">:</span><span class="n">kf</span><span class="p">,</span><span class="mi">1</span><span class="p">:</span><span class="n">nstore</span><span class="p">),</span> <span class="k">intent</span><span class="p">(</span><span class="n">in</span><span class="p">)</span>  <span class="kd">::</span> <span class="n">input</span>
<a name="ln-2210"></a>  <span class="kt">real</span><span class="p">,</span> <span class="k">dimension</span><span class="p">(</span><span class="n">jb</span>   <span class="p">:</span><span class="n">je</span>   <span class="p">,</span><span class="n">ks</span><span class="p">:</span><span class="n">kf</span><span class="p">,</span><span class="mi">1</span><span class="p">:</span><span class="n">nstore</span><span class="p">),</span> <span class="k">intent</span><span class="p">(</span><span class="n">inout</span><span class="p">)</span> <span class="kd">::</span> <span class="n">output</span>
<a name="ln-2211"></a>  <span class="kt">integer </span><span class="n">j</span><span class="p">,</span> <span class="n">jj</span>
<a name="ln-2212"></a>
<a name="ln-2213"></a>    <span class="k">do </span><span class="n">j</span><span class="o">=</span><span class="n">jb</span><span class="p">,</span><span class="n">je</span>
<a name="ln-2214"></a><span class="c">!      if (np==0 .and. yloclowf(j)==)</span>
<a name="ln-2215"></a>      <span class="n">output</span><span class="p">(</span><span class="n">j</span><span class="p">,:,:)</span> <span class="o">=</span> <span class="n">input</span><span class="p">(</span><span class="n">yloclowh</span><span class="p">(</span><span class="n">j</span><span class="p">),:,:)</span> <span class="o">+</span> <span class="p">(</span><span class="n">input</span><span class="p">(</span><span class="n">ylocuph</span><span class="p">(</span><span class="n">j</span><span class="p">),:,:)</span> <span class="o">-</span> <span class="n">input</span><span class="p">(</span><span class="n">yloclowh</span><span class="p">(</span><span class="n">j</span><span class="p">),:,:))</span> <span class="o">/</span> <span class="p">(</span><span class="n">yhdum</span><span class="p">(</span><span class="n">ylocuph</span><span class="p">(</span><span class="n">j</span><span class="p">))</span> <span class="o">-</span> <span class="n">yhdum</span><span class="p">(</span><span class="n">yloclowh</span><span class="p">(</span><span class="n">j</span><span class="p">)))</span> <span class="o">*</span> <span class="p">(</span><span class="n">yh</span><span class="p">(</span><span class="n">j</span><span class="p">)</span> <span class="o">-</span> <span class="n">yhdum</span><span class="p">(</span><span class="n">yloclowh</span><span class="p">(</span><span class="n">j</span><span class="p">)))</span>
<a name="ln-2216"></a>    <span class="k">end do</span>
<a name="ln-2217"></a><span class="k">  end subroutine </span><span class="n">yinterpolateh</span>
<a name="ln-2218"></a>
<a name="ln-2219"></a>
<a name="ln-2220"></a>
<a name="ln-2221"></a>  <span class="k">subroutine </span><span class="n">readzincoord</span>
<a name="ln-2222"></a>  <span class="k">use </span><span class="n">modglobal</span><span class="p">,</span>   <span class="n">only</span> <span class="p">:</span>  <span class="n">kb</span><span class="p">,</span><span class="n">ke</span><span class="p">,</span><span class="n">kh</span><span class="p">,</span><span class="n">ifinput</span><span class="p">,</span><span class="n">zf</span><span class="p">,</span><span class="n">zh</span><span class="p">,</span><span class="n">ysize</span><span class="p">,</span><span class="n">jb</span><span class="p">,</span><span class="n">je</span><span class="p">,</span><span class="n">dy</span>
<a name="ln-2223"></a>  <span class="k">use </span><span class="n">modmpi</span><span class="p">,</span>      <span class="n">only</span> <span class="p">:</span>  <span class="n">myid</span><span class="p">,</span> <span class="n">mpi_integer</span><span class="p">,</span><span class="n">comm3d</span><span class="p">,</span><span class="n">mpierr</span><span class="p">,</span><span class="n">my_real</span><span class="p">,</span><span class="n">nprocs</span>  
<a name="ln-2224"></a>  <span class="k">implicit none     </span>
<a name="ln-2225"></a><span class="k">  </span><span class="kt">character</span><span class="p">(</span><span class="mi">72</span><span class="p">)</span> <span class="n">chmess</span>
<a name="ln-2226"></a>  <span class="kt">character</span><span class="p">(</span><span class="mi">20</span><span class="p">)</span> <span class="n">namezinlet</span>
<a name="ln-2227"></a>  <span class="kt">character</span><span class="p">(</span><span class="mi">20</span><span class="p">)</span> <span class="n">namezinfo</span>
<a name="ln-2228"></a>  <span class="kt">integer </span><span class="n">ierr</span><span class="p">,</span><span class="n">k</span><span class="p">,</span><span class="n">kk</span><span class="p">,</span><span class="n">kmaxin</span><span class="p">,</span><span class="n">j</span><span class="p">,</span><span class="n">jj</span>
<a name="ln-2229"></a>  <span class="kt">real </span><span class="n">ysizeproc</span>
<a name="ln-2230"></a>
<a name="ln-2231"></a>      <span class="k">namelist</span><span class="o">/</span><span class="n">INFO</span><span class="o">/</span><span class="n">nprocsinl</span><span class="p">,</span><span class="n">jgtotinl</span><span class="p">,</span><span class="n">kmaxin</span><span class="p">,</span><span class="n">dtin</span><span class="p">,</span><span class="n">wtop</span><span class="p">,</span><span class="n">totalreadu</span>
<a name="ln-2232"></a>
<a name="ln-2233"></a>  <span class="n">namezinlet</span> <span class="o">=</span> <span class="s1">&#39;zgrid.inl&#39;</span>
<a name="ln-2234"></a>  <span class="n">namezinfo</span>  <span class="o">=</span> <span class="s1">&#39;zgrid.inf&#39;</span>
<a name="ln-2235"></a> 
<a name="ln-2236"></a>    <span class="k">if</span> <span class="p">(</span><span class="n">myid</span><span class="o">==</span><span class="mi">0</span><span class="p">)</span> <span class="k">then</span>
<a name="ln-2237"></a><span class="k">  </span>
<a name="ln-2238"></a>
<a name="ln-2239"></a><span class="k">      open</span><span class="p">(</span><span class="n">ifinput</span><span class="p">,</span><span class="k">file</span><span class="o">=</span><span class="n">namezinfo</span><span class="p">,</span><span class="n">status</span><span class="o">=</span><span class="s1">&#39;old&#39;</span><span class="p">,</span><span class="n">iostat</span><span class="o">=</span><span class="n">ierr</span><span class="p">)</span>
<a name="ln-2240"></a>        <span class="k">if</span> <span class="p">(</span><span class="n">ierr</span> <span class="o">/=</span> <span class="mi">0</span><span class="p">)</span> <span class="k">then</span>
<a name="ln-2241"></a><span class="k">          write</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="o">*</span><span class="p">)</span> <span class="s1">&#39;ERROR: zgrid.inf does not exist&#39;</span>
<a name="ln-2242"></a>          <span class="k">stop </span><span class="mi">1</span>
<a name="ln-2243"></a>        <span class="k">end if</span>
<a name="ln-2244"></a><span class="k">        read</span> <span class="p">(</span><span class="n">ifinput</span><span class="p">,</span><span class="n">INFO</span><span class="p">,</span><span class="n">iostat</span><span class="o">=</span><span class="n">ierr</span><span class="p">)</span>
<a name="ln-2245"></a>        <span class="k">if</span> <span class="p">(</span><span class="n">ierr</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">)</span> <span class="k">then</span>
<a name="ln-2246"></a><span class="k">          write</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="o">*</span><span class="p">)</span> <span class="s1">&#39;Problem in zgrid.inf INFO&#39;</span>
<a name="ln-2247"></a>          <span class="k">write</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="o">*</span><span class="p">)</span> <span class="s1">&#39;iostat error: &#39;</span><span class="p">,</span> <span class="n">ierr</span>
<a name="ln-2248"></a>          <span class="k">stop </span><span class="mi">1</span>
<a name="ln-2249"></a>        <span class="n">endif</span>
<a name="ln-2250"></a>        <span class="k">write</span><span class="p">(</span><span class="mi">6</span><span class="p">,</span><span class="n">INFO</span><span class="p">)</span>
<a name="ln-2251"></a>      <span class="k">close</span><span class="p">(</span><span class="n">ifinput</span><span class="p">)</span>
<a name="ln-2252"></a>    <span class="k">end if</span>
<a name="ln-2253"></a><span class="k">    </span><span class="n">kbin</span> <span class="o">=</span> <span class="mi">0</span>
<a name="ln-2254"></a>    <span class="n">kein</span> <span class="o">=</span> <span class="n">kmaxin</span><span class="o">-</span><span class="mi">1</span>
<a name="ln-2255"></a>    <span class="k">call </span><span class="n">MPI_BCAST</span><span class="p">(</span><span class="n">nprocsinl</span><span class="p">,</span><span class="mi">1</span><span class="p">,</span><span class="n">MPI_INTEGER</span><span class="p">,</span><span class="mi">0</span><span class="p">,</span><span class="n">comm3d</span><span class="p">,</span><span class="n">mpierr</span><span class="p">)</span>
<a name="ln-2256"></a>    <span class="k">call </span><span class="n">MPI_BCAST</span><span class="p">(</span><span class="n">jgtotinl</span> <span class="p">,</span><span class="mi">1</span><span class="p">,</span><span class="n">MPI_INTEGER</span><span class="p">,</span><span class="mi">0</span><span class="p">,</span><span class="n">comm3d</span><span class="p">,</span><span class="n">mpierr</span><span class="p">)</span>
<a name="ln-2257"></a>    <span class="k">call </span><span class="n">MPI_BCAST</span><span class="p">(</span><span class="n">kbin</span>     <span class="p">,</span><span class="mi">1</span><span class="p">,</span><span class="n">MPI_INTEGER</span><span class="p">,</span><span class="mi">0</span><span class="p">,</span><span class="n">comm3d</span><span class="p">,</span><span class="n">mpierr</span><span class="p">)</span>
<a name="ln-2258"></a>    <span class="k">call </span><span class="n">MPI_BCAST</span><span class="p">(</span><span class="n">kein</span>     <span class="p">,</span><span class="mi">1</span><span class="p">,</span><span class="n">MPI_INTEGER</span><span class="p">,</span><span class="mi">0</span><span class="p">,</span><span class="n">comm3d</span><span class="p">,</span><span class="n">mpierr</span><span class="p">)</span>
<a name="ln-2259"></a>    <span class="k">call </span><span class="n">MPI_BCAST</span><span class="p">(</span><span class="n">dtin</span>     <span class="p">,</span><span class="mi">1</span><span class="p">,</span><span class="n">MY_REAL</span><span class="p">,</span><span class="mi">0</span><span class="p">,</span><span class="n">comm3d</span><span class="p">,</span><span class="n">mpierr</span><span class="p">)</span>
<a name="ln-2260"></a>    <span class="k">call </span><span class="n">MPI_BCAST</span><span class="p">(</span><span class="n">wtop</span>     <span class="p">,</span><span class="mi">1</span><span class="p">,</span><span class="n">MY_REAL</span><span class="p">,</span><span class="mi">0</span><span class="p">,</span><span class="n">comm3d</span><span class="p">,</span><span class="n">mpierr</span><span class="p">)</span>
<a name="ln-2261"></a>    <span class="k">call </span><span class="n">MPI_BCAST</span><span class="p">(</span><span class="n">totalreadu</span> <span class="p">,</span><span class="mi">1</span><span class="p">,</span><span class="n">MY_REAL</span><span class="p">,</span><span class="mi">0</span><span class="p">,</span><span class="n">comm3d</span><span class="p">,</span><span class="n">mpierr</span><span class="p">)</span>
<a name="ln-2262"></a>    <span class="k">allocate</span><span class="p">(</span><span class="n">zhin</span><span class="p">(</span><span class="n">kbin</span>   <span class="p">:</span><span class="n">kein</span><span class="o">+</span><span class="mi">1</span><span class="p">))</span>
<a name="ln-2263"></a>    <span class="k">allocate</span><span class="p">(</span><span class="n">zfin</span><span class="p">(</span><span class="n">kbin</span>   <span class="p">:</span><span class="n">kein</span><span class="o">+</span><span class="mi">1</span><span class="p">))</span>
<a name="ln-2264"></a>    <span class="k">allocate</span><span class="p">(</span><span class="n">dzfin</span><span class="p">(</span><span class="n">kbin</span><span class="o">-</span><span class="mi">1</span><span class="p">:</span><span class="n">kein</span><span class="o">+</span><span class="mi">1</span><span class="p">))</span>
<a name="ln-2265"></a>    <span class="k">allocate</span><span class="p">(</span><span class="n">dzhin</span><span class="p">(</span><span class="n">kbin</span>  <span class="p">:</span><span class="n">kein</span><span class="o">+</span><span class="mi">1</span><span class="p">))</span>
<a name="ln-2266"></a>
<a name="ln-2267"></a>    <span class="k">if</span> <span class="p">(</span><span class="n">myid</span><span class="o">==</span><span class="mi">0</span><span class="p">)</span> <span class="k">then</span>
<a name="ln-2268"></a><span class="k">      write</span><span class="p">(</span><span class="mi">6</span><span class="p">,</span><span class="o">*</span><span class="p">)</span> <span class="s1">&#39;loading &#39;</span><span class="p">,</span><span class="n">namezinlet</span>
<a name="ln-2269"></a>      <span class="k">open</span> <span class="p">(</span><span class="n">ifinput</span><span class="p">,</span><span class="k">file</span><span class="o">=</span><span class="n">namezinlet</span><span class="p">)</span>
<a name="ln-2270"></a>      <span class="k">read</span><span class="p">(</span><span class="n">ifinput</span><span class="p">,</span><span class="s1">&#39;(a72)&#39;</span><span class="p">)</span> <span class="n">chmess</span>
<a name="ln-2271"></a>      <span class="k">read</span><span class="p">(</span><span class="n">ifinput</span><span class="p">,</span><span class="s1">&#39;(a72)&#39;</span><span class="p">)</span> <span class="n">chmess</span>
<a name="ln-2272"></a>
<a name="ln-2273"></a>      <span class="k">do </span><span class="n">k</span><span class="o">=</span><span class="n">kbin</span><span class="p">,</span><span class="n">kein</span>
<a name="ln-2274"></a>        <span class="k">read</span><span class="p">(</span><span class="n">ifinput</span><span class="p">,</span><span class="o">*</span><span class="p">)</span> <span class="n">zfin</span><span class="p">(</span><span class="n">k</span><span class="p">)</span>
<a name="ln-2275"></a>      <span class="k">end do</span>
<a name="ln-2276"></a><span class="k">      close</span><span class="p">(</span><span class="n">ifinput</span><span class="p">)</span>
<a name="ln-2277"></a>
<a name="ln-2278"></a>      <span class="n">zhin</span><span class="p">(</span><span class="n">kbin</span><span class="p">)</span> <span class="o">=</span> <span class="mf">0.0</span>
<a name="ln-2279"></a>      <span class="k">do </span><span class="n">k</span><span class="o">=</span><span class="n">kbin</span><span class="p">,</span><span class="n">kein</span>
<a name="ln-2280"></a>        <span class="n">zhin</span><span class="p">(</span><span class="n">k</span><span class="o">+</span><span class="mi">1</span><span class="p">)</span> <span class="o">=</span> <span class="n">zhin</span><span class="p">(</span><span class="n">k</span><span class="p">)</span> <span class="o">+</span> <span class="mf">2.0</span><span class="o">*</span><span class="p">(</span><span class="n">zfin</span><span class="p">(</span><span class="n">k</span><span class="p">)</span><span class="o">-</span><span class="n">zhin</span><span class="p">(</span><span class="n">k</span><span class="p">))</span>
<a name="ln-2281"></a>      <span class="k">end do</span>
<a name="ln-2282"></a><span class="k">      </span><span class="n">zfin</span><span class="p">(</span><span class="n">kein</span><span class="o">+</span><span class="n">kh</span><span class="p">)</span>  <span class="o">=</span> <span class="n">zfin</span><span class="p">(</span><span class="n">kein</span><span class="p">)</span><span class="o">+</span> <span class="mf">2.0</span><span class="o">*</span><span class="p">(</span><span class="n">zhin</span><span class="p">(</span><span class="n">kein</span><span class="o">+</span><span class="n">kh</span><span class="p">)</span><span class="o">-</span><span class="n">zfin</span><span class="p">(</span><span class="n">kein</span><span class="p">))</span>
<a name="ln-2283"></a>
<a name="ln-2284"></a>      <span class="k">do  </span><span class="n">k</span><span class="o">=</span><span class="n">kbin</span><span class="p">,</span><span class="n">kein</span>
<a name="ln-2285"></a>        <span class="n">dzfin</span><span class="p">(</span><span class="n">k</span><span class="p">)</span> <span class="o">=</span> <span class="n">zhin</span><span class="p">(</span><span class="n">k</span><span class="o">+</span><span class="mi">1</span><span class="p">)</span> <span class="o">-</span> <span class="n">zhin</span><span class="p">(</span><span class="n">k</span><span class="p">)</span>
<a name="ln-2286"></a>      <span class="k">end do</span>
<a name="ln-2287"></a><span class="k">      </span><span class="n">dzfin</span><span class="p">(</span><span class="n">kein</span><span class="o">+</span><span class="mi">1</span><span class="p">)</span> <span class="o">=</span> <span class="n">dzfin</span><span class="p">(</span><span class="n">kein</span><span class="p">)</span>
<a name="ln-2288"></a>      <span class="n">dzfin</span><span class="p">(</span><span class="n">kbin</span><span class="o">-</span><span class="mi">1</span><span class="p">)</span> <span class="o">=</span> <span class="n">dzfin</span><span class="p">(</span><span class="n">kbin</span><span class="p">)</span>
<a name="ln-2289"></a>
<a name="ln-2290"></a>      <span class="n">dzhin</span><span class="p">(</span><span class="n">kbin</span><span class="p">)</span> <span class="o">=</span> <span class="mi">2</span><span class="o">*</span><span class="n">zfin</span><span class="p">(</span><span class="n">kbin</span><span class="p">)</span>
<a name="ln-2291"></a>      <span class="k">do </span><span class="n">k</span><span class="o">=</span><span class="n">kbin</span><span class="o">+</span><span class="mi">1</span><span class="p">,</span><span class="n">kein</span><span class="o">+</span><span class="n">kh</span>
<a name="ln-2292"></a>        <span class="n">dzhin</span><span class="p">(</span><span class="n">k</span><span class="p">)</span> <span class="o">=</span> <span class="n">zfin</span><span class="p">(</span><span class="n">k</span><span class="p">)</span> <span class="o">-</span> <span class="n">zfin</span><span class="p">(</span><span class="n">k</span><span class="o">-</span><span class="mi">1</span><span class="p">)</span>
<a name="ln-2293"></a>      <span class="k">end do</span>
<a name="ln-2294"></a>
<a name="ln-2295"></a>    <span class="c">! check if the inlet mesh and the simulation mesh differ</span>
<a name="ln-2296"></a>    <span class="k">do </span><span class="n">k</span><span class="o">=</span><span class="n">kb</span><span class="p">,</span><span class="nb">min</span><span class="p">(</span><span class="n">ke</span><span class="p">,</span><span class="n">kein</span><span class="p">)</span>
<a name="ln-2297"></a>      <span class="k">if</span><span class="p">(</span><span class="nb">abs</span><span class="p">(</span><span class="n">zfin</span><span class="p">(</span><span class="n">k</span><span class="p">)</span><span class="o">-</span><span class="n">zf</span><span class="p">(</span><span class="n">k</span><span class="p">))</span> <span class="o">&gt;</span> <span class="mf">1e-7</span><span class="p">)</span> <span class="k">then</span>
<a name="ln-2298"></a><span class="k">        </span><span class="n">lzinzsim</span> <span class="o">=</span> <span class="p">.</span><span class="n">false</span><span class="p">.</span>
<a name="ln-2299"></a>      <span class="k">end if</span>
<a name="ln-2300"></a><span class="k">    </span><span class="n">enddo</span>
<a name="ln-2301"></a>
<a name="ln-2302"></a>    <span class="k">end if</span> <span class="c">! myid==0</span>
<a name="ln-2303"></a>
<a name="ln-2304"></a>  <span class="c">! MPI broadcast kmax elements from zf</span>
<a name="ln-2305"></a>    <span class="k">call </span><span class="n">MPI_BCAST</span><span class="p">(</span> <span class="n">zfin</span><span class="p">,</span><span class="n">kein</span><span class="o">-</span><span class="n">kbin</span><span class="o">+</span><span class="mi">2</span><span class="p">,</span><span class="n">MY_REAL</span>   <span class="p">,</span><span class="mi">0</span><span class="p">,</span><span class="n">comm3d</span><span class="p">,</span><span class="n">mpierr</span><span class="p">)</span>
<a name="ln-2306"></a>    <span class="k">call </span><span class="n">MPI_BCAST</span><span class="p">(</span> <span class="n">zhin</span><span class="p">,</span><span class="n">kein</span><span class="o">-</span><span class="n">kbin</span><span class="o">+</span><span class="mi">2</span><span class="p">,</span><span class="n">MY_REAL</span>   <span class="p">,</span><span class="mi">0</span><span class="p">,</span><span class="n">comm3d</span><span class="p">,</span><span class="n">mpierr</span><span class="p">)</span>
<a name="ln-2307"></a>    <span class="k">call </span><span class="n">MPI_BCAST</span><span class="p">(</span><span class="n">dzfin</span><span class="p">,</span><span class="n">kein</span><span class="o">-</span><span class="n">kbin</span><span class="o">+</span><span class="mi">3</span><span class="p">,</span><span class="n">MY_REAL</span>   <span class="p">,</span><span class="mi">0</span><span class="p">,</span><span class="n">comm3d</span><span class="p">,</span><span class="n">mpierr</span><span class="p">)</span>
<a name="ln-2308"></a>    <span class="k">call </span><span class="n">MPI_BCAST</span><span class="p">(</span><span class="n">dzhin</span><span class="p">,</span><span class="n">kein</span><span class="o">-</span><span class="n">kbin</span><span class="o">+</span><span class="mi">2</span><span class="p">,</span><span class="n">MY_REAL</span>   <span class="p">,</span><span class="mi">0</span><span class="p">,</span><span class="n">comm3d</span><span class="p">,</span><span class="n">mpierr</span><span class="p">)</span>
<a name="ln-2309"></a>    <span class="k">call </span><span class="n">MPI_BCAST</span><span class="p">(</span><span class="n">lzinzsim</span><span class="p">,</span><span class="mi">1</span><span class="p">,</span><span class="n">MPI_INTEGER</span>      <span class="p">,</span><span class="mi">0</span><span class="p">,</span><span class="n">comm3d</span><span class="p">,</span><span class="n">mpierr</span><span class="p">)</span>
<a name="ln-2310"></a>
<a name="ln-2311"></a>    
<a name="ln-2312"></a>    <span class="k">if</span> <span class="p">(.</span><span class="nb">not</span><span class="p">.</span><span class="n">lzinzsim</span><span class="p">)</span> <span class="k">then </span>
<a name="ln-2313"></a><span class="k">      if</span> <span class="p">(</span><span class="n">myid</span><span class="o">==</span><span class="mi">0</span><span class="p">)</span> <span class="k">then</span>
<a name="ln-2314"></a><span class="k">        write</span><span class="p">(</span><span class="mi">6</span><span class="p">,</span><span class="o">*</span><span class="p">)</span> <span class="s1">&#39;zgrid.inl does not equal zgrid.inp: Inlet will be interpolated in z&#39;</span>
<a name="ln-2315"></a>      <span class="k">end if</span>
<a name="ln-2316"></a><span class="c">!      allocate(linlf(kbin:kein)) </span>
<a name="ln-2317"></a><span class="c">!      allocate(linuf(kbin:kein)) </span>
<a name="ln-2318"></a><span class="c">!      allocate(linlh(kbin:kein+1)) </span>
<a name="ln-2319"></a><span class="c">!      allocate(linuh(kbin:kein+1)) </span>
<a name="ln-2320"></a>      <span class="k">allocate</span><span class="p">(</span><span class="n">linlf</span><span class="p">(</span><span class="n">kb</span><span class="p">:</span><span class="n">ke</span><span class="p">))</span> 
<a name="ln-2321"></a>      <span class="k">allocate</span><span class="p">(</span><span class="n">linuf</span><span class="p">(</span><span class="n">kb</span><span class="p">:</span><span class="n">ke</span><span class="p">))</span> 
<a name="ln-2322"></a>      <span class="k">allocate</span><span class="p">(</span><span class="n">linlh</span><span class="p">(</span><span class="n">kb</span><span class="p">:</span><span class="n">ke</span><span class="o">+</span><span class="mi">1</span><span class="p">))</span> 
<a name="ln-2323"></a>      <span class="k">allocate</span><span class="p">(</span><span class="n">linuh</span><span class="p">(</span><span class="n">kb</span><span class="p">:</span><span class="n">ke</span><span class="o">+</span><span class="mi">1</span><span class="p">))</span> 
<a name="ln-2324"></a>   <span class="c">! zf</span>
<a name="ln-2325"></a>      <span class="k">do </span><span class="n">k</span><span class="o">=</span><span class="n">kb</span><span class="p">,</span><span class="n">ke</span>
<a name="ln-2326"></a>        <span class="k">do </span><span class="n">kk</span><span class="o">=</span><span class="n">kbin</span><span class="p">,</span><span class="n">kein</span>
<a name="ln-2327"></a>          <span class="k">if</span> <span class="p">(</span><span class="n">zfin</span><span class="p">(</span><span class="n">kk</span><span class="p">)</span> <span class="o">&gt;=</span> <span class="n">zf</span><span class="p">(</span><span class="n">k</span><span class="p">))</span> <span class="k">then</span>
<a name="ln-2328"></a><span class="k">            </span><span class="n">linuf</span><span class="p">(</span><span class="n">k</span><span class="p">)</span>  <span class="o">=</span> <span class="n">kk</span>
<a name="ln-2329"></a>            <span class="n">linlf</span><span class="p">(</span><span class="n">k</span><span class="p">)</span>  <span class="o">=</span> <span class="n">kk</span><span class="o">-</span><span class="mi">1</span>
<a name="ln-2330"></a>            <span class="k">exit</span>
<a name="ln-2331"></a><span class="k">          </span><span class="n">elseif</span> <span class="p">(</span><span class="n">kk</span><span class="o">==</span><span class="n">kein</span><span class="p">)</span> <span class="k">then</span>
<a name="ln-2332"></a><span class="k">            </span><span class="n">linuf</span><span class="p">(</span><span class="n">k</span><span class="p">)</span>  <span class="o">=</span> <span class="n">kein</span><span class="o">+</span><span class="mi">1</span>            <span class="c">! this means extrapolation!</span>
<a name="ln-2333"></a>            <span class="n">linlf</span><span class="p">(</span><span class="n">k</span><span class="p">)</span>  <span class="o">=</span> <span class="n">kein</span><span class="o">-</span><span class="mi">1</span>            <span class="c">! waarom niet ke? of wordt dit niet gebruikt?</span>
<a name="ln-2334"></a>          <span class="k">end if</span>
<a name="ln-2335"></a><span class="k">        end do</span>
<a name="ln-2336"></a><span class="k">      end do</span>
<a name="ln-2337"></a>   <span class="c">! for w-components (zh)</span>
<a name="ln-2338"></a>      <span class="k">do </span><span class="n">k</span><span class="o">=</span><span class="n">kb</span><span class="p">,</span><span class="n">ke</span><span class="o">+</span><span class="mi">1</span>
<a name="ln-2339"></a>        <span class="k">do </span><span class="n">kk</span><span class="o">=</span><span class="n">kbin</span><span class="p">,</span><span class="n">kein</span><span class="o">+</span><span class="mi">1</span>
<a name="ln-2340"></a>          <span class="k">if</span> <span class="p">(</span><span class="n">zhin</span><span class="p">(</span><span class="n">kk</span><span class="p">)</span> <span class="o">&gt;=</span> <span class="n">zh</span><span class="p">(</span><span class="n">k</span><span class="p">))</span> <span class="k">then</span>
<a name="ln-2341"></a><span class="k">            </span><span class="n">linuh</span><span class="p">(</span><span class="n">k</span><span class="p">)</span>  <span class="o">=</span> <span class="n">kk</span>
<a name="ln-2342"></a>            <span class="n">linlh</span><span class="p">(</span><span class="n">k</span><span class="p">)</span> <span class="o">=</span> <span class="n">kk</span><span class="o">-</span><span class="mi">1</span>
<a name="ln-2343"></a>            <span class="k">exit</span>
<a name="ln-2344"></a><span class="k">          </span><span class="n">elseif</span> <span class="p">(</span><span class="n">kk</span><span class="o">==</span><span class="n">kein</span><span class="o">+</span><span class="mi">1</span><span class="p">)</span> <span class="k">then</span>
<a name="ln-2345"></a><span class="k">            </span><span class="n">linuh</span><span class="p">(</span><span class="n">k</span><span class="p">)</span>  <span class="o">=</span> <span class="n">kein</span><span class="o">+</span><span class="mi">2</span>            <span class="c">! this means extrapolation!</span>
<a name="ln-2346"></a>            <span class="n">linlh</span><span class="p">(</span><span class="n">k</span><span class="p">)</span>  <span class="o">=</span> <span class="n">kein</span>
<a name="ln-2347"></a>          <span class="k">end if</span>
<a name="ln-2348"></a><span class="k">        end do</span>
<a name="ln-2349"></a><span class="k">      end do</span>
<a name="ln-2350"></a>
<a name="ln-2351"></a><span class="k">     else</span>  <span class="c">! lzinzsim  -&gt; grids are equal</span>
<a name="ln-2352"></a>       <span class="k">if</span> <span class="p">(</span><span class="n">myid</span><span class="o">==</span><span class="mi">0</span><span class="p">)</span> <span class="k">then </span>
<a name="ln-2353"></a><span class="k">         write</span><span class="p">(</span><span class="mi">6</span><span class="p">,</span><span class="o">*</span><span class="p">)</span> <span class="s1">&#39;zgrid.inl equals zgrid.inp: Inlet will not be interpolated in z&#39;</span>
<a name="ln-2354"></a>       <span class="k">end if</span>
<a name="ln-2355"></a><span class="k">     end if</span>
<a name="ln-2356"></a>    
<a name="ln-2357"></a><span class="c">! Now prepare everything for interpolation in y-direction</span>
<a name="ln-2358"></a>     <span class="n">jgbin</span> <span class="o">=</span> <span class="mi">1</span>
<a name="ln-2359"></a>     <span class="n">jgein</span> <span class="o">=</span> <span class="n">jgbin</span> <span class="o">+</span> <span class="n">jgtotinl</span> <span class="o">-</span><span class="mi">1</span>
<a name="ln-2360"></a>     <span class="n">jtotin</span> <span class="o">=</span> <span class="n">jgtotinl</span> <span class="o">/</span> <span class="n">nprocsinl</span>
<a name="ln-2361"></a>     <span class="n">jbin</span> <span class="o">=</span> <span class="mi">1</span>
<a name="ln-2362"></a>     <span class="n">jein</span> <span class="o">=</span> <span class="mi">1</span> <span class="o">+</span> <span class="n">jtotin</span> <span class="o">-</span><span class="mi">1</span>
<a name="ln-2363"></a>     <span class="n">ysizeproc</span> <span class="o">=</span> <span class="n">ysize</span><span class="o">/</span><span class="n">nprocs</span>
<a name="ln-2364"></a>     <span class="n">dyin</span> <span class="o">=</span> <span class="n">ysize</span> <span class="o">/</span> <span class="n">jgtotinl</span>
<a name="ln-2365"></a>     <span class="n">jbdum</span> <span class="o">=</span> <span class="mi">1</span>
<a name="ln-2366"></a>     <span class="n">jtotdum</span> <span class="o">=</span> <span class="nb">ceiling</span><span class="p">(</span><span class="n">ysizeproc</span><span class="o">/</span><span class="kt">real</span><span class="p">(</span><span class="n">dyin</span><span class="p">))</span><span class="o">+</span><span class="mi">1</span>                    <span class="c">! dummy indices</span>
<a name="ln-2367"></a>     <span class="n">jedum</span> <span class="o">=</span> <span class="n">jbdum</span> <span class="o">+</span> <span class="n">jtotdum</span><span class="o">-</span><span class="mi">1</span>
<a name="ln-2368"></a>     
<a name="ln-2369"></a><span class="c">!     allocate(yf   (jb    :je)) </span>
<a name="ln-2370"></a>     <span class="k">allocate</span><span class="p">(</span><span class="n">yf</span>   <span class="p">(</span><span class="n">jb</span>    <span class="p">:</span><span class="n">je</span><span class="o">+</span><span class="mi">1</span><span class="p">))</span> 
<a name="ln-2371"></a>     <span class="k">allocate</span><span class="p">(</span><span class="n">yh</span>   <span class="p">(</span><span class="n">jb</span>    <span class="p">:</span><span class="n">je</span><span class="o">+</span><span class="mi">1</span><span class="p">))</span> 
<a name="ln-2372"></a>     <span class="k">allocate</span><span class="p">(</span><span class="n">yfin</span> <span class="p">(</span><span class="n">jgbin</span> <span class="p">:</span><span class="n">jgein</span><span class="o">+</span><span class="mi">1</span><span class="p">))</span> 
<a name="ln-2373"></a>     <span class="k">allocate</span><span class="p">(</span><span class="n">yhin</span> <span class="p">(</span><span class="n">jgbin</span><span class="o">-</span><span class="mi">1</span> <span class="p">:</span><span class="n">jgein</span><span class="o">+</span><span class="mi">1</span><span class="p">))</span> 
<a name="ln-2374"></a><span class="c">!     allocate(yfdum(jbdum :jedum)) </span>
<a name="ln-2375"></a>     <span class="k">allocate</span><span class="p">(</span><span class="n">yfdum</span><span class="p">(</span><span class="n">jbdum</span> <span class="p">:</span><span class="n">jedum</span><span class="o">+</span><span class="mi">1</span><span class="p">))</span> 
<a name="ln-2376"></a>     <span class="k">allocate</span><span class="p">(</span><span class="n">yhdum</span><span class="p">(</span><span class="n">jbdum</span> <span class="p">:</span><span class="n">jedum</span><span class="o">+</span><span class="mi">1</span><span class="p">))</span> 
<a name="ln-2377"></a>     <span class="k">allocate</span><span class="p">(</span><span class="n">yloclowf</span><span class="p">(</span><span class="n">jb</span><span class="p">:</span><span class="n">je</span><span class="o">+</span><span class="mi">1</span><span class="p">))</span>
<a name="ln-2378"></a>     <span class="k">allocate</span><span class="p">(</span><span class="n">ylocupf</span> <span class="p">(</span><span class="n">jb</span><span class="p">:</span><span class="n">je</span><span class="o">+</span><span class="mi">1</span><span class="p">))</span>
<a name="ln-2379"></a>     <span class="k">allocate</span><span class="p">(</span><span class="n">yloclowh</span><span class="p">(</span><span class="n">jb</span><span class="p">:</span><span class="n">je</span><span class="o">+</span><span class="mi">1</span><span class="p">))</span>
<a name="ln-2380"></a>     <span class="k">allocate</span><span class="p">(</span><span class="n">ylocuph</span> <span class="p">(</span><span class="n">jb</span><span class="p">:</span><span class="n">je</span><span class="o">+</span><span class="mi">1</span><span class="p">))</span>
<a name="ln-2381"></a>
<a name="ln-2382"></a>    <span class="c">! make global y-grid (equidistant) for inlet data</span>
<a name="ln-2383"></a>      
<a name="ln-2384"></a>     <span class="k">do </span><span class="n">j</span> <span class="o">=</span> <span class="n">jgbin</span><span class="o">-</span><span class="mi">1</span><span class="p">,</span><span class="n">jgein</span><span class="o">+</span><span class="mi">1</span>
<a name="ln-2385"></a>       <span class="n">yhin</span><span class="p">(</span><span class="n">j</span><span class="p">)</span> <span class="o">=</span> <span class="p">(</span><span class="n">j</span><span class="o">-</span><span class="n">jgbin</span><span class="p">)</span><span class="o">*</span><span class="n">dyin</span>
<a name="ln-2386"></a>     <span class="k">end do</span>
<a name="ln-2387"></a><span class="k">     do </span><span class="n">j</span> <span class="o">=</span> <span class="n">jgbin</span><span class="p">,</span><span class="n">jgein</span><span class="o">+</span><span class="mi">1</span>
<a name="ln-2388"></a>       <span class="n">yfin</span><span class="p">(</span><span class="n">j</span><span class="p">)</span> <span class="o">=</span> <span class="n">yhin</span><span class="p">(</span><span class="n">j</span><span class="p">)</span> <span class="o">+</span> <span class="mf">0.5</span><span class="o">*</span><span class="n">dyin</span>
<a name="ln-2389"></a>     <span class="k">end do</span>
<a name="ln-2390"></a>    <span class="c">! make new y-grid (equidistant)</span>
<a name="ln-2391"></a>     <span class="k">do </span><span class="n">j</span> <span class="o">=</span> <span class="n">jb</span><span class="p">,</span><span class="n">je</span><span class="o">+</span><span class="mi">1</span>
<a name="ln-2392"></a>       <span class="n">yh</span><span class="p">(</span><span class="n">j</span><span class="p">)</span> <span class="o">=</span> <span class="n">myid</span><span class="o">*</span><span class="p">(</span><span class="n">ysize</span><span class="o">/</span><span class="n">nprocs</span><span class="p">)</span> <span class="o">+</span> <span class="p">(</span><span class="n">j</span><span class="o">-</span><span class="n">jb</span><span class="p">)</span><span class="o">*</span><span class="n">dy</span>
<a name="ln-2393"></a>       <span class="n">yf</span><span class="p">(</span><span class="n">j</span><span class="p">)</span> <span class="o">=</span> <span class="n">yh</span><span class="p">(</span><span class="n">j</span><span class="p">)</span> <span class="o">+</span> <span class="mf">0.5</span><span class="o">*</span><span class="n">dy</span>
<a name="ln-2394"></a>     <span class="k">end do</span>
<a name="ln-2395"></a>
<a name="ln-2396"></a>   <span class="c">! check which original cells are needed for interpolation</span>
<a name="ln-2397"></a>      <span class="k">do </span><span class="n">j</span><span class="o">=</span><span class="n">jgein</span><span class="o">+</span><span class="mi">1</span><span class="p">,</span><span class="n">jgbin</span><span class="p">,</span><span class="o">-</span><span class="mi">1</span>
<a name="ln-2398"></a>        <span class="k">if</span> <span class="p">(</span><span class="n">yhin</span><span class="p">(</span><span class="n">j</span><span class="p">)</span><span class="o">&lt;=</span> <span class="n">yh</span><span class="p">(</span><span class="n">jb</span><span class="p">))</span> <span class="k">then</span>
<a name="ln-2399"></a><span class="k">          if</span> <span class="p">(</span><span class="n">yfin</span><span class="p">(</span><span class="n">j</span><span class="p">)</span><span class="o">&lt;=</span> <span class="n">yf</span><span class="p">(</span><span class="n">jb</span><span class="p">))</span> <span class="k">then  </span>
<a name="ln-2400"></a><span class="k">            </span><span class="n">procinlo</span> <span class="o">=</span> <span class="nb">floor</span><span class="p">(</span><span class="kt">real</span><span class="p">(</span><span class="n">j</span><span class="o">-</span><span class="n">jgbin</span><span class="p">)</span><span class="o">/</span><span class="kt">real</span><span class="p">(</span><span class="n">jtotin</span><span class="p">))</span>      <span class="c">! this is the first cell to consider</span>
<a name="ln-2401"></a>            <span class="n">filenumstart</span> <span class="o">=</span> <span class="n">procinlo</span>
<a name="ln-2402"></a>            <span class="n">jgbeg</span> <span class="o">=</span> <span class="n">j</span>
<a name="ln-2403"></a>            <span class="n">jbeg</span> <span class="o">=</span> <span class="n">j</span><span class="o">-</span><span class="p">(</span><span class="n">procinlo</span><span class="o">*</span><span class="n">jtotin</span><span class="p">)</span>
<a name="ln-2404"></a><span class="c">!            jend = jbeg+jtotdum-1</span>
<a name="ln-2405"></a>            <span class="n">jj</span> <span class="o">=</span> <span class="n">j</span><span class="o">+</span><span class="n">jtotdum</span><span class="o">-</span><span class="mi">1</span>
<a name="ln-2406"></a><span class="c">!            procinup = floor((j-jgbin)/real(jtotin))     </span>
<a name="ln-2407"></a><span class="c">!            procinup = floor((j-jgbin+1)/real(jtotin))</span>
<a name="ln-2408"></a>            <span class="n">procinup</span> <span class="o">=</span> <span class="nb">floor</span><span class="p">(</span><span class="kt">real</span><span class="p">(</span><span class="n">jj</span><span class="o">-</span><span class="n">jgbin</span><span class="p">)</span><span class="o">/</span><span class="kt">real</span><span class="p">(</span><span class="n">jtotin</span><span class="p">))</span>
<a name="ln-2409"></a>            <span class="n">filenumend</span> <span class="o">=</span> <span class="n">procinup</span>
<a name="ln-2410"></a>            <span class="n">jend</span> <span class="o">=</span> <span class="n">jj</span><span class="o">-</span><span class="p">(</span><span class="n">procinup</span><span class="o">*</span><span class="n">jtotin</span><span class="p">)</span>
<a name="ln-2411"></a>            <span class="n">procinup</span> <span class="o">=</span> <span class="n">procinup</span><span class="o">-</span><span class="nb">floor</span><span class="p">(</span><span class="kt">real</span><span class="p">(</span><span class="n">procinup</span><span class="p">)</span><span class="o">/</span><span class="kt">real</span><span class="p">(</span><span class="n">nprocsinl</span><span class="p">))</span><span class="o">*</span><span class="n">nprocsinl</span>  <span class="c">! continue on first procinl again</span>
<a name="ln-2412"></a>          <span class="k">else</span>
<a name="ln-2413"></a><span class="k">            if</span> <span class="p">(</span><span class="n">j</span> <span class="o">==</span> <span class="n">jgbin</span><span class="p">)</span> <span class="k">then</span>
<a name="ln-2414"></a><span class="k">              </span><span class="n">jgbeg</span> <span class="o">=</span> <span class="n">j</span><span class="o">-</span><span class="mi">1</span>
<a name="ln-2415"></a>              <span class="n">jbeg</span> <span class="o">=</span> <span class="n">jein</span>
<a name="ln-2416"></a>              <span class="n">procinlo</span> <span class="o">=</span> <span class="n">nprocsinl</span><span class="o">-</span><span class="mi">1</span>
<a name="ln-2417"></a>              <span class="n">filenumstart</span> <span class="o">=</span> <span class="o">-</span><span class="mi">1</span>
<a name="ln-2418"></a>              <span class="n">jj</span> <span class="o">=</span> <span class="n">j</span><span class="o">+</span><span class="n">jtotdum</span><span class="o">-</span><span class="mi">2</span>
<a name="ln-2419"></a>              <span class="n">procinup</span> <span class="o">=</span> <span class="nb">floor</span><span class="p">(</span><span class="kt">real</span><span class="p">(</span><span class="n">jj</span><span class="o">-</span><span class="n">jgbin</span><span class="p">)</span><span class="o">/</span><span class="kt">real</span><span class="p">(</span><span class="n">jtotin</span><span class="p">))</span>
<a name="ln-2420"></a>              <span class="n">filenumend</span> <span class="o">=</span> <span class="n">procinup</span>
<a name="ln-2421"></a>              <span class="n">jend</span> <span class="o">=</span> <span class="n">jj</span><span class="o">-</span><span class="p">(</span><span class="n">procinup</span><span class="o">*</span><span class="n">jtotin</span><span class="p">)</span>
<a name="ln-2422"></a>              <span class="n">procinup</span> <span class="o">=</span> <span class="n">procinup</span><span class="o">-</span><span class="nb">floor</span><span class="p">(</span><span class="kt">real</span><span class="p">(</span><span class="n">procinup</span><span class="p">)</span><span class="o">/</span><span class="kt">real</span><span class="p">(</span><span class="n">nprocsinl</span><span class="p">))</span><span class="o">*</span><span class="n">nprocsinl</span>  <span class="c">!continue on first procinl again</span>
<a name="ln-2423"></a>            <span class="k">else  </span>
<a name="ln-2424"></a><span class="k">              </span><span class="n">procinlo</span> <span class="o">=</span> <span class="nb">floor</span><span class="p">(</span><span class="kt">real</span><span class="p">(</span><span class="n">j</span><span class="o">-</span><span class="n">jgbin</span><span class="o">-</span><span class="mi">1</span><span class="p">)</span><span class="o">/</span><span class="kt">real</span><span class="p">(</span><span class="n">jtotin</span><span class="p">))</span>    <span class="c">! One cell lower is needed</span>
<a name="ln-2425"></a>              <span class="n">filenumstart</span> <span class="o">=</span> <span class="n">procinlo</span>
<a name="ln-2426"></a>              <span class="n">jgbeg</span> <span class="o">=</span> <span class="n">j</span><span class="o">-</span><span class="mi">1</span>
<a name="ln-2427"></a>              <span class="n">jbeg</span> <span class="o">=</span> <span class="n">j</span><span class="o">-</span><span class="p">(</span><span class="n">procinlo</span><span class="o">*</span><span class="n">jtotin</span><span class="p">)</span><span class="o">-</span><span class="mi">1</span>         
<a name="ln-2428"></a>              <span class="n">jj</span> <span class="o">=</span> <span class="n">j</span><span class="o">+</span><span class="n">jtotdum</span><span class="o">-</span><span class="mi">2</span>
<a name="ln-2429"></a>              <span class="n">procinup</span> <span class="o">=</span> <span class="nb">floor</span><span class="p">(</span><span class="kt">real</span><span class="p">(</span><span class="n">jj</span><span class="o">-</span><span class="n">jgbin</span><span class="p">)</span><span class="o">/</span><span class="kt">real</span><span class="p">(</span><span class="n">jtotin</span><span class="p">))</span>
<a name="ln-2430"></a>              <span class="n">filenumend</span> <span class="o">=</span> <span class="n">procinup</span>
<a name="ln-2431"></a>              <span class="n">jend</span> <span class="o">=</span> <span class="n">jj</span><span class="o">-</span><span class="p">(</span><span class="n">procinup</span><span class="o">*</span><span class="n">jtotin</span><span class="p">)</span>
<a name="ln-2432"></a>              <span class="n">procinup</span> <span class="o">=</span> <span class="n">procinup</span><span class="o">-</span><span class="nb">floor</span><span class="p">(</span><span class="kt">real</span><span class="p">(</span><span class="n">procinup</span><span class="p">)</span><span class="o">/</span><span class="kt">real</span><span class="p">(</span><span class="n">nprocsinl</span><span class="p">))</span><span class="o">*</span><span class="n">nprocsinl</span>  <span class="c">! continue on first procinl again</span>
<a name="ln-2433"></a>            <span class="k">end if</span> <span class="c">! j=jgbin</span>
<a name="ln-2434"></a>          <span class="k">end if</span>
<a name="ln-2435"></a><span class="k">          exit</span>
<a name="ln-2436"></a><span class="k">        end if</span>
<a name="ln-2437"></a><span class="k">      end do</span>
<a name="ln-2438"></a>
<a name="ln-2439"></a><span class="k">      write</span><span class="p">(</span><span class="mi">6</span><span class="p">,</span><span class="o">*</span><span class="p">)</span> <span class="s1">&#39;!! myid,procinlo,jbeg,procinup,jend,jgbeg = &#39;</span><span class="p">,</span><span class="n">myid</span><span class="p">,</span><span class="n">procinlo</span><span class="p">,</span><span class="n">jbeg</span><span class="p">,</span><span class="n">procinup</span><span class="p">,</span><span class="n">jend</span><span class="p">,</span><span class="n">jgbeg</span>
<a name="ln-2440"></a>
<a name="ln-2441"></a>
<a name="ln-2442"></a>   <span class="c">! make dummy y-grid (equidistant)</span>
<a name="ln-2443"></a>      <span class="k">do </span><span class="n">j</span> <span class="o">=</span> <span class="n">jbdum</span><span class="p">,</span><span class="n">jedum</span><span class="o">+</span><span class="mi">1</span>
<a name="ln-2444"></a>        <span class="n">yhdum</span><span class="p">(</span><span class="n">j</span><span class="p">)</span> <span class="o">=</span> <span class="n">yhin</span><span class="p">(</span><span class="n">jgbeg</span><span class="p">)</span> <span class="o">+</span> <span class="p">(</span><span class="n">j</span><span class="o">-</span><span class="n">jbdum</span><span class="o">+</span><span class="mi">1</span><span class="p">)</span><span class="o">*</span><span class="n">dyin</span>
<a name="ln-2445"></a>        <span class="n">yfdum</span><span class="p">(</span><span class="n">j</span><span class="p">)</span> <span class="o">=</span> <span class="n">yhdum</span><span class="p">(</span><span class="n">j</span><span class="p">)</span> <span class="o">+</span> <span class="mf">0.5</span><span class="o">*</span><span class="n">dyin</span>
<a name="ln-2446"></a>      <span class="k">end do</span>
<a name="ln-2447"></a><span class="c">!      if (procoldup /= procoldlo) then</span>
<a name="ln-2448"></a><span class="c">!        write(6,*) &#39;!!! Start-cell and end-cell are not in the same file!!!&#39;</span>
<a name="ln-2449"></a><span class="c">!      end if</span>
<a name="ln-2450"></a>      <span class="n">filestoread</span> <span class="o">=</span> <span class="n">filenumend</span> <span class="o">-</span> <span class="n">filenumstart</span> <span class="o">+</span> <span class="mi">1</span> <span class="c">! no. of files to be read</span>
<a name="ln-2451"></a><span class="c">!      write(6,*) &#39;!! procinlo,procinup = &#39;,procinlo,procinup</span>
<a name="ln-2452"></a><span class="c">!      write(6,*) &#39;!! jbin,jein,jbeg,jend= &#39;,jbin,jein,jbeg,jend</span>
<a name="ln-2453"></a>
<a name="ln-2454"></a>   <span class="c">! for components defined on yf</span>
<a name="ln-2455"></a>    <span class="k">do </span><span class="n">j</span><span class="o">=</span><span class="n">jb</span><span class="p">,</span><span class="n">je</span>
<a name="ln-2456"></a>      <span class="k">do </span><span class="n">jj</span><span class="o">=</span><span class="n">jbdum</span><span class="o">+</span><span class="mi">1</span><span class="p">,</span><span class="n">jedum</span><span class="o">+</span><span class="mi">1</span>
<a name="ln-2457"></a>        <span class="k">if</span> <span class="p">(</span><span class="n">yfdum</span><span class="p">(</span><span class="n">jj</span><span class="p">)</span> <span class="o">&gt;=</span> <span class="n">yf</span><span class="p">(</span><span class="n">j</span><span class="p">))</span> <span class="k">then</span>
<a name="ln-2458"></a><span class="k">          </span><span class="n">ylocupf</span><span class="p">(</span><span class="n">j</span><span class="p">)</span>  <span class="o">=</span> <span class="n">jj</span>
<a name="ln-2459"></a>          <span class="n">yloclowf</span><span class="p">(</span><span class="n">j</span><span class="p">)</span> <span class="o">=</span> <span class="n">jj</span><span class="o">-</span><span class="mi">1</span>
<a name="ln-2460"></a>          <span class="k">exit</span>
<a name="ln-2461"></a><span class="k">        end if</span>
<a name="ln-2462"></a><span class="k">      end do</span>
<a name="ln-2463"></a><span class="k">    end do</span>
<a name="ln-2464"></a>   <span class="c">! for components defined on yh</span>
<a name="ln-2465"></a>    <span class="k">do </span><span class="n">j</span><span class="o">=</span><span class="n">jb</span><span class="p">,</span><span class="n">je</span><span class="o">+</span><span class="mi">1</span>
<a name="ln-2466"></a>      <span class="k">do </span><span class="n">jj</span><span class="o">=</span><span class="n">jbdum</span><span class="o">+</span><span class="mi">1</span><span class="p">,</span><span class="n">jedum</span><span class="o">+</span><span class="mi">1</span>
<a name="ln-2467"></a>        <span class="k">if</span> <span class="p">(</span><span class="n">yhdum</span><span class="p">(</span><span class="n">jj</span><span class="p">)</span> <span class="o">&gt;=</span> <span class="n">yh</span><span class="p">(</span><span class="n">j</span><span class="p">))</span> <span class="k">then</span>
<a name="ln-2468"></a><span class="k">          </span><span class="n">ylocuph</span><span class="p">(</span><span class="n">j</span><span class="p">)</span>  <span class="o">=</span> <span class="n">jj</span>
<a name="ln-2469"></a>          <span class="n">yloclowh</span><span class="p">(</span><span class="n">j</span><span class="p">)</span> <span class="o">=</span> <span class="n">jj</span><span class="o">-</span><span class="mi">1</span>
<a name="ln-2470"></a>          <span class="k">exit</span>
<a name="ln-2471"></a><span class="k">        end if</span>
<a name="ln-2472"></a><span class="k">      end do</span>
<a name="ln-2473"></a><span class="k">    end do</span>
<a name="ln-2474"></a>
<a name="ln-2475"></a><span class="k">  end subroutine </span><span class="n">readzincoord</span>
<a name="ln-2476"></a>
<a name="ln-2477"></a>
<a name="ln-2478"></a>  <span class="k">subroutine </span><span class="n">exitinlet</span>
<a name="ln-2479"></a>  <span class="k">use </span><span class="n">modglobal</span><span class="p">,</span>      <span class="n">only</span> <span class="p">:</span> <span class="n">iinletgen</span><span class="p">,</span><span class="n">lstoreplane</span><span class="p">,</span><span class="n">ltempeq</span>
<a name="ln-2480"></a>
<a name="ln-2481"></a>  <span class="k">if</span> <span class="p">(</span><span class="n">iinletgen</span><span class="o">==</span><span class="mi">1</span><span class="p">)</span> <span class="k">then</span>
<a name="ln-2482"></a><span class="k">    deallocate</span><span class="p">(</span><span class="n">Uinl</span><span class="p">,</span><span class="n">Winl</span><span class="p">,</span><span class="n">Urec</span><span class="p">,</span><span class="n">Wrec</span><span class="p">,</span><span class="n">u0inletbc</span><span class="p">,</span><span class="n">v0inletbc</span><span class="p">,</span><span class="n">w0inletbc</span><span class="p">,</span><span class="n">zirf</span><span class="p">,</span><span class="n">ziif</span><span class="p">,</span><span class="n">ziih</span><span class="p">,</span><span class="n">zirh</span><span class="p">,</span><span class="n">zorf</span><span class="p">,</span><span class="n">zoif</span><span class="p">,</span><span class="n">zorh</span><span class="p">,</span><span class="n">zoih</span><span class="p">,</span><span class="n">loclowif</span><span class="p">,</span><span class="n">locupif</span><span class="p">,</span><span class="n">loclowih</span><span class="p">,</span><span class="n">locupih</span><span class="p">,</span><span class="n">loclowof</span><span class="p">,</span><span class="n">locupof</span><span class="p">,</span><span class="n">loclowoh</span><span class="p">,</span><span class="n">locupoh</span><span class="p">,</span><span class="n">uminletbc</span><span class="p">,</span><span class="n">vminletbc</span><span class="p">,</span><span class="n">wminletbc</span><span class="p">,</span><span class="n">u0inletbcold</span><span class="p">,</span><span class="n">v0inletbcold</span><span class="p">,</span><span class="n">w0inletbcold</span><span class="p">,</span><span class="n">Utav</span><span class="p">,</span><span class="n">upupavinl</span><span class="p">,</span><span class="n">vpvpavinl</span><span class="p">,</span><span class="n">wpwpavinl</span><span class="p">,</span><span class="n">upwpavinl</span><span class="p">,</span><span class="n">thlpthlpavinl</span><span class="p">,</span><span class="n">thlpupavinl</span><span class="p">,</span><span class="n">thlpwpavinl</span><span class="p">)</span>
<a name="ln-2483"></a>    <span class="k">if</span> <span class="p">(</span><span class="n">ltempeq</span> <span class="p">)</span> <span class="k">then</span>
<a name="ln-2484"></a><span class="k">       deallocate</span><span class="p">(</span><span class="n">t0inletbc</span><span class="p">,</span><span class="n">tminletbc</span><span class="p">,</span><span class="n">t0inletbcold</span><span class="p">,</span><span class="n">loclowot</span><span class="p">,</span><span class="n">locupot</span><span class="p">,</span><span class="n">zotr</span><span class="p">,</span><span class="n">zoti</span><span class="p">,</span><span class="n">Tinl</span><span class="p">,</span><span class="n">Trec</span><span class="p">)</span>
<a name="ln-2485"></a>    <span class="k">end if</span>
<a name="ln-2486"></a><span class="k">    if</span> <span class="p">(</span><span class="n">lstoreplane</span> <span class="p">)</span> <span class="k">then </span>
<a name="ln-2487"></a><span class="k">      deallocate</span><span class="p">(</span><span class="n">storeu0inletbc</span><span class="p">,</span><span class="n">storev0inletbc</span><span class="p">,</span><span class="n">storew0inletbc</span><span class="p">)</span>
<a name="ln-2488"></a>       <span class="k">if</span> <span class="p">(</span><span class="n">ltempeq</span> <span class="p">)</span> <span class="k">then</span>
<a name="ln-2489"></a><span class="k">         deallocate</span><span class="p">(</span><span class="n">storet0inletbc</span><span class="p">)</span>
<a name="ln-2490"></a>       <span class="k">end if</span>
<a name="ln-2491"></a><span class="k">    end if </span>
<a name="ln-2492"></a><span class="k">  else if</span> <span class="p">(</span><span class="n">iinletgen</span> <span class="o">==</span> <span class="mi">2</span><span class="p">)</span> <span class="k">then</span>
<a name="ln-2493"></a><span class="k">    deallocate</span><span class="p">(</span><span class="n">storeu0inletbc</span><span class="p">,</span><span class="n">storev0inletbc</span><span class="p">,</span><span class="n">storew0inletbc</span><span class="p">,</span><span class="n">u0inletbc</span><span class="p">,</span><span class="n">v0inletbc</span><span class="p">,</span><span class="n">w0inletbc</span><span class="p">,</span><span class="n">uminletbc</span><span class="p">,</span><span class="n">vminletbc</span><span class="p">,</span><span class="n">wminletbc</span><span class="p">,</span><span class="n">u0inletbcold</span><span class="p">,</span><span class="n">v0inletbcold</span><span class="p">,</span><span class="n">w0inletbcold</span><span class="p">)</span>
<a name="ln-2494"></a>    <span class="k">if</span> <span class="p">(</span><span class="n">ltempeq</span> <span class="p">)</span> <span class="k">then</span>
<a name="ln-2495"></a><span class="k">       deallocate</span><span class="p">(</span><span class="n">t0inletbc</span><span class="p">,</span><span class="n">tminletbc</span><span class="p">,</span><span class="n">t0inletbcold</span><span class="p">,</span><span class="n">storet0inletbc</span><span class="p">)</span>
<a name="ln-2496"></a>    <span class="k">end if</span>
<a name="ln-2497"></a><span class="k">  end if</span>
<a name="ln-2498"></a>
<a name="ln-2499"></a><span class="k">  end subroutine </span><span class="n">exitinlet</span>
<a name="ln-2500"></a>
<a name="ln-2501"></a><span class="k">end module</span>
</pre></div>

    </section>
    </div>
  </div>

  
    <hr>    
    </div> <!-- /container -->
    <footer>
      <div class="container">
      <div class="row">
        <div class="col-xs-6 col-md-4"><p>&copy; 2021 
                                          </p></div>
        <div class="col-xs-6 col-md-4 col-md-push-4">
          <p class="text-right">
            Documentation generated by 
            <a href="https://github.com/cmacmackin/ford">FORD</a>
            
          </p>
        </div>
        <div class="col-xs-12 col-md-4 col-md-pull-4"><p class="text-center"> uDALES was developed by The uDALES Team</p></div>
      </div>
      <br>
      </div> <!-- /container -->    
    </footer>

    <!-- Bootstrap core JavaScript
    ================================================== -->
    <!-- Placed at the end of the document so the pages load faster -->
<!--
    <script src="https://ajax.googleapis.com/ajax/libs/jquery/1.11.1/jquery.min.js"></script>
-->
    <script src="../js/bootstrap.min.js"></script>
    <!-- IE10 viewport hack for Surface/desktop Windows 8 bug -->
    <script src="../js/ie10-viewport-bug-workaround.js"></script>

    <!-- MathJax JavaScript
    ================================================== -->
    <!-- Placed at the end of the document so the pages load faster -->
    <script type="text/x-mathjax-config">
      MathJax.Hub.Config({
        TeX: { extensions: ['AMSmath.js','AMSsymbols.js','noErrors.js','noUndefined.js'], equationNumbers: { autoNumber: 'AMS' } },
        jax: ['input/TeX','input/MathML','output/HTML-CSS'],
        extensions: ['tex2jax.js','mml2jax.js','MathMenu.js','MathZoom.js']
      });
    </script>
    
    <script src="https://cdnjs.cloudflare.com/ajax/libs/mathjax/2.7.1/MathJax.js?config=TeX-AMS-MML_HTMLorMML"></script>
    
    
    <script src="../tipuesearch/tipuesearch_content.js"></script>
    <script src="../tipuesearch/tipuesearch_set.js"></script>
    <script src="../tipuesearch/tipuesearch.js"></script>
    
    
  </body>
</html>