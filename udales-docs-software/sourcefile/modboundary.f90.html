<!DOCTYPE html>
<html lang="en">
  <head>
    <meta charset="utf-8">
    <meta http-equiv="X-UA-Compatible" content="IE=edge">
    <meta name="viewport" content="width=device-width, initial-scale=1">
   
    <meta name="description" content="Documentation for uDALES">
   
    <meta name="author" content="The uDALES Team" >
    <link rel="icon" href="../favicon.png">

    <title>modboundary.f90 &ndash; uDALES</title>

    <link href="../css/bootstrap.min.css" rel="stylesheet">
    <link href="../css/pygments.css" rel="stylesheet">
    <link href="../css/font-awesome.min.css" rel="stylesheet">
    <link href="../css/local.css" rel="stylesheet">
    
    <link  href="../tipuesearch/tipuesearch.css" rel="stylesheet">
    
    

    <!-- HTML5 shim and Respond.js for IE8 support of HTML5 elements and media queries -->
    <!--[if lt IE 9]>
      <script src="https://oss.maxcdn.com/html5shiv/3.7.2/html5shiv.min.js"></script>
      <script src="https://oss.maxcdn.com/respond/1.4.2/respond.min.js"></script>
    <![endif]-->
    
    <script src="../js/jquery-2.1.3.min.js"></script>
    <script src="../js/svg-pan-zoom.min.js"></script>

  </head>

  <body>

    <!-- Fixed navbar -->
    <nav class="navbar navbar-inverse navbar-fixed-top">
      <div class="container">
        <div class="navbar-header">
          <button type="button" class="navbar-toggle collapsed" data-toggle="collapse" data-target="#navbar" aria-expanded="false" aria-controls="navbar">
            <span class="sr-only">Toggle navigation</span>
            <span class="icon-bar"></span>
            <span class="icon-bar"></span>
            <span class="icon-bar"></span>
          </button>
          <a class="navbar-brand" href="../index.html">uDALES </a>
        </div>
        <div id="navbar" class="navbar-collapse collapse">
          <ul class="nav navbar-nav">
        
            <li class="dropdown hidden-xs visible-sm visible-md hidden-lg">
              <a href="#" class="dropdown-toggle"
              data-toggle="dropdown" role="button"
              aria-haspopup="true"
     aria-expanded="false">Contents <span class="caret"></span></a>
        <ul class="dropdown-menu">
          
              
            <li><a href="../lists/files.html">Source Files</a></li>
        
        
        
            <li><a href="../lists/modules.html">Modules</a></li>
        
            
                                
            <li><a href="../lists/procedures.html">Procedures</a></li>
        
               
            <li><a href="../lists/types.html">Derived Types</a></li>
        
        
            <li><a href="../program/dalesurban.html">Program</a></li>
      
            </ul>
            </li>


<li class="visible-xs hidden-sm visible-lg"><a href="../lists/files.html">Source Files</a></li>



<li class="visible-xs hidden-sm visible-lg"><a href="../lists/modules.html">Modules</a></li>



<li class="visible-xs hidden-sm visible-lg"><a href="../lists/procedures.html">Procedures</a></li>

                             
<li class="visible-xs hidden-sm visible-lg"><a href="../lists/types.html">Derived Types</a></li>


<li class="visible-xs hidden-sm visible-lg"><a href="../program/dalesurban.html">Program</a></li>

          </ul>
        
        <form action="../search.html" class="navbar-form navbar-right" role="search">
        <div class="form-group">
          <input type="text" class="form-control" placeholder="Search" name="q" id="tipue_search_input" autocomplete="off" required>
        </div>
<!--
        <button type="submit" class="btn btn-default">Submit</button>
-->
        </form>
        
        </div><!--/.nav-collapse -->
      </div>
    </nav>

    <div class="container">
    
  
  <div class="row">
    <h1>modboundary.f90
    <small>Source File</small>
    
    </h1>
    
<div class="row">
  <div class="col-lg-12">
<div class="well well-sm">
  <ul class="list-inline" style="margin-bottom:0px;display:inline">
     
     
     
     
    
    
     <li><i class="fa fa-list-ol"></i>
       <a data-toggle="tooltip"
    data-placement="bottom" data-html="true"
    title=" 6.1% of total for source files.">866 statements</a>
     </li> 
     
     
     
    <li><i class="fa fa-code"></i><a href="../src/modboundary.f90"> Source File</a></li>
     
     
  </ul>
  <ol class="breadcrumb in-well text-right">
  
    
  
     <li class="active">modboundary.f90</li>
  </ol>
</div>
</div>
</div>
<script>
  $(function () {
  $('[data-toggle="tooltip"]').tooltip()
  })
</script>

  </div>
  <div class="row">
    <div class="col-md-3 hidden-xs hidden-sm visible-md visible-lg">
    
<div id="sidebar">
  
<h3>Contents</h3>
 







<div class="panel panel-primary">
  <div class="panel-heading text-left"><h3 class="panel-title"><a data-toggle="collapse" href="#mods-0">Modules</a></h3></div>
  <div id="mods-0" class="panel-collapse collapse">
    <div class="list-group">
      
      <a class="list-group-item" href="../module/modboundary.html">modboundary</a>
      
    </div>
  </div>
</div>
















<div class="panel panel-primary">
  <div class="panel-heading text-left"><h3 class="panel-title">Source Code</h3></div>
  <div class="list-group">
    <a class="list-group-item" href="../sourcefile/modboundary.f90.html#src">modboundary.f90</a>
  </div>
</div>



</div>

    </div>
    <div class="col-md-9" id='text'>
      
      <br>
    
    <div class="panel panel-default">
      <div class="panel-heading">
  <h3 class="panel-title">This file depends on</h3>
      </div>
      <div class="panel-body">
  <div class="depgraph"><?xml version="1.0" encoding="UTF-8" standalone="no"?>
<!DOCTYPE svg PUBLIC "-//W3C//DTD SVG 1.1//EN"
 "http://www.w3.org/Graphics/SVG/1.1/DTD/svg11.dtd">
<!-- Generated by graphviz version 2.40.1 (20161225.0304)
 -->
<!-- Title: sourcefile~~modboundary.f90~~EfferentGraph Pages: 1 -->
<svg id="sourcefilemodboundaryf90EfferentGraph" width="641pt" height="380pt"
 viewBox="0.00 0.00 641.00 379.99" xmlns="http://www.w3.org/2000/svg" xmlns:xlink="http://www.w3.org/1999/xlink">
<g id="sourcefile~~modboundary.f90~~EfferentGraph" class="graph" transform="scale(.9223 .9223) rotate(0) translate(4 408.0062)">
<title>sourcefile~~modboundary.f90~~EfferentGraph</title>
<polygon fill="#ffffff" stroke="transparent" points="-4,4 -4,-408.0062 691,-408.0062 691,4 -4,4"/>
<!-- sourcefile~modboundary.f90 -->
<g id="sourcefile~~modboundary.f90~~EfferentGraph_node1" class="node">
<title>sourcefile~modboundary.f90</title>
<polygon fill="none" stroke="#000000" points="687,-98.357 590,-98.357 590,-74.357 687,-74.357 687,-98.357"/>
<text text-anchor="middle" x="638.5" y="-83.957" font-family="Helvetica,sans-Serif" font-size="10.50" fill="#000000">modboundary.f90</text>
</g>
<!-- sourcefile~modinlet.f90 -->
<g id="sourcefile~~modboundary.f90~~EfferentGraph_node2" class="node">
<title>sourcefile~modinlet.f90</title>
<g id="a_sourcefile~~modboundary.f90~~EfferentGraph_node2"><a xlink:href=".././sourcefile/modinlet.f90.html" xlink:title="modinlet.f90">
<polygon fill="#f0ad4e" stroke="#f0ad4e" points="550,-225.357 479,-225.357 479,-201.357 550,-201.357 550,-225.357"/>
<text text-anchor="middle" x="514.5" y="-210.957" font-family="Helvetica,sans-Serif" font-size="10.50" fill="#ffffff">modinlet.f90</text>
</a>
</g>
</g>
<!-- sourcefile~modboundary.f90&#45;&gt;sourcefile~modinlet.f90 -->
<g id="sourcefile~~modboundary.f90~~EfferentGraph_edge2" class="edge">
<title>sourcefile~modboundary.f90&#45;&gt;sourcefile~modinlet.f90</title>
<path fill="none" stroke="#ff0000" stroke-dasharray="5,2" d="M626.6104,-98.5343C605.0935,-120.5717 559.5263,-167.2413 533.598,-193.7969"/>
<polygon fill="#ff0000" stroke="#ff0000" points="531.0176,-191.4297 526.5358,-201.03 536.0262,-196.32 531.0176,-191.4297"/>
</g>
<!-- sourcefile~modsubgriddata.f90 -->
<g id="sourcefile~~modboundary.f90~~EfferentGraph_node3" class="node">
<title>sourcefile~modsubgriddata.f90</title>
<g id="a_sourcefile~~modboundary.f90~~EfferentGraph_node3"><a xlink:href=".././sourcefile/modsubgriddata.f90.html" xlink:title="modsubgriddata.f90">
<polygon fill="#f0ad4e" stroke="#f0ad4e" points="329,-319.357 221,-319.357 221,-295.357 329,-295.357 329,-319.357"/>
<text text-anchor="middle" x="275" y="-304.957" font-family="Helvetica,sans-Serif" font-size="10.50" fill="#ffffff">modsubgriddata.f90</text>
</a>
</g>
</g>
<!-- sourcefile~modboundary.f90&#45;&gt;sourcefile~modsubgriddata.f90 -->
<g id="sourcefile~~modboundary.f90~~EfferentGraph_edge1" class="edge">
<title>sourcefile~modboundary.f90&#45;&gt;sourcefile~modsubgriddata.f90</title>
<path fill="none" stroke="#ff0000" stroke-dasharray="5,2" d="M402,-307.357C382.5491,-299.6106 360.0544,-297.6108 339.4502,-298.1604"/>
<polygon fill="#ff0000" stroke="#ff0000" points="339.0176,-294.6768 329.1927,-298.6418 339.3458,-301.6691 339.0176,-294.6768"/>
</g>
<!-- sourcefile~modsurfdata.f90 -->
<g id="sourcefile~~modboundary.f90~~EfferentGraph_node4" class="node">
<title>sourcefile~modsurfdata.f90</title>
<g id="a_sourcefile~~modboundary.f90~~EfferentGraph_node4"><a xlink:href=".././sourcefile/modsurfdata.f90.html" xlink:title="modsurfdata.f90">
<polygon fill="#f0ad4e" stroke="#f0ad4e" points="320.5,-361.357 229.5,-361.357 229.5,-337.357 320.5,-337.357 320.5,-361.357"/>
<text text-anchor="middle" x="275" y="-346.957" font-family="Helvetica,sans-Serif" font-size="10.50" fill="#ffffff">modsurfdata.f90</text>
</a>
</g>
</g>
<!-- sourcefile~modboundary.f90&#45;&gt;sourcefile~modsurfdata.f90 -->
<g id="sourcefile~~modboundary.f90~~EfferentGraph_edge3" class="edge">
<title>sourcefile~modboundary.f90&#45;&gt;sourcefile~modsurfdata.f90</title>
<path fill="none" stroke="#ff0000" stroke-dasharray="5,2" d="M514.5,-383.357C466.4147,-405.1064 453.5758,-334.1691 402,-345.357"/>
</g>
<!-- sourcefile~modinletdata.f90 -->
<g id="sourcefile~~modboundary.f90~~EfferentGraph_node5" class="node">
<title>sourcefile~modinletdata.f90</title>
<g id="a_sourcefile~~modboundary.f90~~EfferentGraph_node5"><a xlink:href=".././sourcefile/modinletdata.f90.html" xlink:title="modinletdata.f90">
<polygon fill="#f0ad4e" stroke="#f0ad4e" points="321,-277.357 229,-277.357 229,-253.357 321,-253.357 321,-277.357"/>
<text text-anchor="middle" x="275" y="-262.957" font-family="Helvetica,sans-Serif" font-size="10.50" fill="#ffffff">modinletdata.f90</text>
</a>
</g>
</g>
<!-- sourcefile~modboundary.f90&#45;&gt;sourcefile~modinletdata.f90 -->
<g id="sourcefile~~modboundary.f90~~EfferentGraph_edge4" class="edge">
<title>sourcefile~modboundary.f90&#45;&gt;sourcefile~modinletdata.f90</title>
<path fill="none" stroke="#ff0000" stroke-dasharray="5,2" d="M635.6795,-98.6103C623.2265,-151.3727 571.2653,-357.6816 514.5,-383.357"/>
<path fill="none" stroke="#ff0000" stroke-dasharray="5,2" d="M514.5,-383.357C477.3765,-400.1482 472.8725,-354.0011 439,-331.357 422.7049,-320.4635 420.21,-314.6092 402,-307.357"/>
<path fill="none" stroke="#ff0000" stroke-dasharray="5,2" d="M402,-307.357C377.0809,-297.4328 348.7957,-287.9143 325.2543,-280.4555"/>
<polygon fill="#ff0000" stroke="#ff0000" points="326.0684,-277.0428 315.4792,-277.3898 323.9736,-283.722 326.0684,-277.0428"/>
</g>
<!-- sourcefile~modfields.f90 -->
<g id="sourcefile~~modboundary.f90~~EfferentGraph_node6" class="node">
<title>sourcefile~modfields.f90</title>
<g id="a_sourcefile~~modboundary.f90~~EfferentGraph_node6"><a xlink:href=".././sourcefile/modfields.f90.html" xlink:title="modfields.f90">
<polygon fill="#f0ad4e" stroke="#f0ad4e" points="313,-75.357 237,-75.357 237,-51.357 313,-51.357 313,-75.357"/>
<text text-anchor="middle" x="275" y="-60.957" font-family="Helvetica,sans-Serif" font-size="10.50" fill="#ffffff">modfields.f90</text>
</a>
</g>
</g>
<!-- sourcefile~modboundary.f90&#45;&gt;sourcefile~modfields.f90 -->
<g id="sourcefile~~modboundary.f90~~EfferentGraph_edge6" class="edge">
<title>sourcefile~modboundary.f90&#45;&gt;sourcefile~modfields.f90</title>
<path fill="none" stroke="#ff0000" stroke-dasharray="5,2" d="M589.854,-83.279C520.2055,-78.8721 392.8302,-70.8125 323.3473,-66.4161"/>
<polygon fill="#ff0000" stroke="#ff0000" points="323.321,-62.9075 313.12,-65.769 322.879,-69.8936 323.321,-62.9075"/>
</g>
<!-- sourcefile~modglobal.f90 -->
<g id="sourcefile~~modboundary.f90~~EfferentGraph_node7" class="node">
<title>sourcefile~modglobal.f90</title>
<g id="a_sourcefile~~modboundary.f90~~EfferentGraph_node7"><a xlink:href=".././sourcefile/modglobal.f90.html" xlink:title="modglobal.f90">
<polygon fill="#f0ad4e" stroke="#f0ad4e" points="185,-95.357 105,-95.357 105,-71.357 185,-71.357 185,-95.357"/>
<text text-anchor="middle" x="145" y="-80.957" font-family="Helvetica,sans-Serif" font-size="10.50" fill="#ffffff">modglobal.f90</text>
</a>
</g>
</g>
<!-- sourcefile~modboundary.f90&#45;&gt;sourcefile~modglobal.f90 -->
<g id="sourcefile~~modboundary.f90~~EfferentGraph_edge7" class="edge">
<title>sourcefile~modboundary.f90&#45;&gt;sourcefile~modglobal.f90</title>
<path fill="none" stroke="#ff0000" stroke-dasharray="5,2" d="M626.9939,-74.348C611.8801,-59.5263 583.7494,-35.0909 554,-25.357 436.1451,13.2049 396.3219,2.2902 275,-23.357"/>
<path fill="none" stroke="#ff0000" stroke-dasharray="5,2" d="M275,-23.357C237.7922,-31.4524 198.5649,-51.3436 173.0579,-66.0149"/>
<polygon fill="#ff0000" stroke="#ff0000" points="171.1608,-63.07 164.3105,-71.1524 174.7059,-69.106 171.1608,-63.07"/>
</g>
<!-- sourcefile~moddriver.f90 -->
<g id="sourcefile~~modboundary.f90~~EfferentGraph_node8" class="node">
<title>sourcefile~moddriver.f90</title>
<g id="a_sourcefile~~modboundary.f90~~EfferentGraph_node8"><a xlink:href=".././sourcefile/moddriver.f90.html" xlink:title="moddriver.f90">
<polygon fill="#f0ad4e" stroke="#f0ad4e" points="554,-58.357 475,-58.357 475,-34.357 554,-34.357 554,-58.357"/>
<text text-anchor="middle" x="514.5" y="-43.957" font-family="Helvetica,sans-Serif" font-size="10.50" fill="#ffffff">moddriver.f90</text>
</a>
</g>
</g>
<!-- sourcefile~modboundary.f90&#45;&gt;sourcefile~moddriver.f90 -->
<g id="sourcefile~~modboundary.f90~~EfferentGraph_edge5" class="edge">
<title>sourcefile~modboundary.f90&#45;&gt;sourcefile~moddriver.f90</title>
<path fill="none" stroke="#ff0000" stroke-dasharray="5,2" d="M601.2959,-74.3557C588.9032,-70.358 574.928,-65.8499 561.8709,-61.6379"/>
<polygon fill="#ff0000" stroke="#ff0000" points="562.698,-58.2272 552.1064,-58.4881 560.549,-64.8892 562.698,-58.2272"/>
</g>
<!-- sourcefile~modmpi.f90 -->
<g id="sourcefile~~modboundary.f90~~EfferentGraph_node9" class="node">
<title>sourcefile~modmpi.f90</title>
<g id="a_sourcefile~~modboundary.f90~~EfferentGraph_node9"><a xlink:href=".././sourcefile/modmpi.f90.html" xlink:title="modmpi.f90">
<polygon fill="#f0ad4e" stroke="#f0ad4e" points="69,-95.357 0,-95.357 0,-71.357 69,-71.357 69,-95.357"/>
<text text-anchor="middle" x="34.5" y="-80.957" font-family="Helvetica,sans-Serif" font-size="10.50" fill="#ffffff">modmpi.f90</text>
</a>
</g>
</g>
<!-- sourcefile~modboundary.f90&#45;&gt;sourcefile~modmpi.f90 -->
<g id="sourcefile~~modboundary.f90~~EfferentGraph_edge8" class="edge">
<title>sourcefile~modboundary.f90&#45;&gt;sourcefile~modmpi.f90</title>
<path fill="none" stroke="#ff0000" stroke-dasharray="5,2" d="M514.5,-383.357C468.9434,-403.9626 449.215,-366.9028 402,-383.357"/>
</g>
<!-- sourcefile~modinlet.f90&#45;&gt;sourcefile~modsurfdata.f90 -->
<g id="sourcefile~~modboundary.f90~~EfferentGraph_edge9" class="edge">
<title>sourcefile~modinlet.f90&#45;&gt;sourcefile~modsurfdata.f90</title>
<path fill="none" stroke="#ff0000" stroke-dasharray="5,2" d="M510.0666,-225.4281C498.1759,-255.4982 462.3236,-332.2715 402,-345.357"/>
<path fill="none" stroke="#ff0000" stroke-dasharray="5,2" d="M402,-345.357C379.0052,-350.345 353.1247,-351.8709 330.7552,-351.9537"/>
<polygon fill="#ff0000" stroke="#ff0000" points="330.7669,-348.4538 320.7474,-351.8975 330.7275,-355.4537 330.7669,-348.4538"/>
</g>
<!-- sourcefile~modinlet.f90&#45;&gt;sourcefile~modinletdata.f90 -->
<g id="sourcefile~~modboundary.f90~~EfferentGraph_edge10" class="edge">
<title>sourcefile~modinlet.f90&#45;&gt;sourcefile~modinletdata.f90</title>
<path fill="none" stroke="#ff0000" stroke-dasharray="5,2" d="M478.7673,-204.7548C455.4404,-201.1228 425.1359,-200.3072 402,-213.357"/>
</g>
<!-- sourcefile~modinlet.f90&#45;&gt;sourcefile~modfields.f90 -->
<g id="sourcefile~~modboundary.f90~~EfferentGraph_edge11" class="edge">
<title>sourcefile~modinlet.f90&#45;&gt;sourcefile~modfields.f90</title>
<path fill="none" stroke="#ff0000" stroke-dasharray="5,2" d="M503.2083,-201.2483C484.1659,-181.517 443.6511,-142.4205 402,-120.357"/>
<path fill="none" stroke="#ff0000" stroke-dasharray="5,2" d="M402,-120.357C373.2158,-105.1094 339.5375,-90.1173 314.0972,-79.3382"/>
<polygon fill="#ff0000" stroke="#ff0000" points="315.3527,-76.0693 304.7777,-75.4215 312.6406,-82.5226 315.3527,-76.0693"/>
</g>
<!-- sourcefile~modinlet.f90&#45;&gt;sourcefile~modglobal.f90 -->
<g id="sourcefile~~modboundary.f90~~EfferentGraph_edge13" class="edge">
<title>sourcefile~modinlet.f90&#45;&gt;sourcefile~modglobal.f90</title>
<path fill="none" stroke="#ff0000" stroke-dasharray="5,2" d="M402,-120.357C351.6766,-93.6996 330.2977,-116.9668 275,-103.357"/>
<path fill="none" stroke="#ff0000" stroke-dasharray="5,2" d="M275,-103.357C249.0018,-96.9583 219.5481,-92.2255 195.2579,-88.9749"/>
<polygon fill="#ff0000" stroke="#ff0000" points="195.5556,-85.4843 185.1891,-87.672 194.6572,-92.4264 195.5556,-85.4843"/>
</g>
<!-- sourcefile~modinlet.f90&#45;&gt;sourcefile~modmpi.f90 -->
<g id="sourcefile~~modboundary.f90~~EfferentGraph_edge14" class="edge">
<title>sourcefile~modinlet.f90&#45;&gt;sourcefile~modmpi.f90</title>
<path fill="none" stroke="#ff0000" stroke-dasharray="5,2" d="M511.6779,-225.402C502.8189,-259.8754 471.8886,-358.0729 402,-383.357"/>
<path fill="none" stroke="#ff0000" stroke-dasharray="5,2" d="M402,-383.357C326.1589,-410.7946 288.4682,-414.5468 221,-370.357 160.1335,-330.4911 206.5669,-264.1325 145,-225.357"/>
</g>
<!-- sourcefile~modsave.f90 -->
<g id="sourcefile~~modboundary.f90~~EfferentGraph_node10" class="node">
<title>sourcefile~modsave.f90</title>
<g id="a_sourcefile~~modboundary.f90~~EfferentGraph_node10"><a xlink:href=".././sourcefile/modsave.f90.html" xlink:title="modsave.f90">
<polygon fill="#f0ad4e" stroke="#f0ad4e" points="439,-185.357 365,-185.357 365,-161.357 439,-161.357 439,-185.357"/>
<text text-anchor="middle" x="402" y="-170.957" font-family="Helvetica,sans-Serif" font-size="10.50" fill="#ffffff">modsave.f90</text>
</a>
</g>
</g>
<!-- sourcefile~modinlet.f90&#45;&gt;sourcefile~modsave.f90 -->
<g id="sourcefile~~modboundary.f90~~EfferentGraph_edge12" class="edge">
<title>sourcefile~modinlet.f90&#45;&gt;sourcefile~modsave.f90</title>
<path fill="none" stroke="#ff0000" stroke-dasharray="5,2" d="M480.7463,-201.3557C469.7234,-197.4364 457.3205,-193.0265 445.6754,-188.886"/>
<polygon fill="#ff0000" stroke="#ff0000" points="446.7134,-185.5405 436.1187,-185.4881 444.3683,-192.136 446.7134,-185.5405"/>
</g>
<!-- sourcefile~modfields.f90&#45;&gt;sourcefile~modglobal.f90 -->
<g id="sourcefile~~modboundary.f90~~EfferentGraph_edge15" class="edge">
<title>sourcefile~modfields.f90&#45;&gt;sourcefile~modglobal.f90</title>
<path fill="none" stroke="#00ffff" stroke-dasharray="5,2" d="M236.6988,-69.2495C223.8074,-71.2328 209.22,-73.477 195.534,-75.5825"/>
<polygon fill="#00ffff" stroke="#00ffff" points="194.6384,-72.179 185.2869,-77.159 195.7029,-79.0976 194.6384,-72.179"/>
</g>
<!-- sourcefile~modglobal.f90&#45;&gt;sourcefile~modmpi.f90 -->
<g id="sourcefile~~modboundary.f90~~EfferentGraph_edge16" class="edge">
<title>sourcefile~modglobal.f90&#45;&gt;sourcefile~modmpi.f90</title>
<path fill="none" stroke="#003fff" stroke-dasharray="5,2" d="M104.7944,-83.357C96.4589,-83.357 87.6289,-83.357 79.1455,-83.357"/>
<polygon fill="#003fff" stroke="#003fff" points="79.0261,-79.8571 69.0261,-83.357 79.0261,-86.8571 79.0261,-79.8571"/>
</g>
<!-- sourcefile~moddriver.f90&#45;&gt;sourcefile~modinletdata.f90 -->
<g id="sourcefile~~modboundary.f90~~EfferentGraph_edge17" class="edge">
<title>sourcefile~moddriver.f90&#45;&gt;sourcefile~modinletdata.f90</title>
<path fill="none" stroke="#7f00ff" stroke-dasharray="5,2" d="M511.0903,-58.6409C502.9044,-86.1544 479.7379,-153.5099 439,-194.357 425.946,-207.446 418.1012,-204.2751 402,-213.357"/>
<path fill="none" stroke="#7f00ff" stroke-dasharray="5,2" d="M402,-213.357C376.1689,-227.927 345.4318,-240.6222 320.6667,-249.8211"/>
<polygon fill="#7f00ff" stroke="#7f00ff" points="319.3397,-246.5795 311.1457,-253.2957 321.7396,-253.1553 319.3397,-246.5795"/>
</g>
<!-- sourcefile~moddriver.f90&#45;&gt;sourcefile~modfields.f90 -->
<g id="sourcefile~~modboundary.f90~~EfferentGraph_edge18" class="edge">
<title>sourcefile~moddriver.f90&#45;&gt;sourcefile~modfields.f90</title>
<path fill="none" stroke="#7f00ff" stroke-dasharray="5,2" d="M402,-44.357C375.7849,-44.0208 346.8553,-48.0028 323.2369,-52.4066"/>
<polygon fill="#7f00ff" stroke="#7f00ff" points="322.2725,-49.0287 313.1266,-54.3768 323.6114,-55.8994 322.2725,-49.0287"/>
</g>
<!-- sourcefile~moddriver.f90&#45;&gt;sourcefile~modglobal.f90 -->
<g id="sourcefile~~modboundary.f90~~EfferentGraph_edge20" class="edge">
<title>sourcefile~moddriver.f90&#45;&gt;sourcefile~modglobal.f90</title>
<path fill="none" stroke="#7f00ff" stroke-dasharray="5,2" d="M474.9327,-45.5579C453.3721,-45.1466 426.2206,-44.6676 402,-44.357"/>
<path fill="none" stroke="#7f00ff" stroke-dasharray="5,2" d="M402,-44.357C344.7938,-43.6233 330.9739,-11.5242 275,-23.357"/>
</g>
<!-- sourcefile~moddriver.f90&#45;&gt;sourcefile~modmpi.f90 -->
<g id="sourcefile~~modboundary.f90~~EfferentGraph_edge21" class="edge">
<title>sourcefile~moddriver.f90&#45;&gt;sourcefile~modmpi.f90</title>
<path fill="none" stroke="#7f00ff" stroke-dasharray="5,2" d="M477.6597,-34.3338C421.8197,-17.7695 312.5575,8.1436 221,-9.357 163.9944,-20.2532 102.1937,-48.3108 65.9855,-66.5763"/>
<polygon fill="#7f00ff" stroke="#7f00ff" points="64.2208,-63.5477 56.9134,-71.2192 67.4099,-69.779 64.2208,-63.5477"/>
</g>
<!-- sourcefile~moddriver.f90&#45;&gt;sourcefile~modsave.f90 -->
<g id="sourcefile~~modboundary.f90~~EfferentGraph_edge19" class="edge">
<title>sourcefile~moddriver.f90&#45;&gt;sourcefile~modsave.f90</title>
<path fill="none" stroke="#7f00ff" stroke-dasharray="5,2" d="M504.4293,-58.4781C490.1286,-75.6015 463.004,-107.7542 439,-134.357 433.197,-140.7882 426.7384,-147.6824 420.8624,-153.8585"/>
<polygon fill="#7f00ff" stroke="#7f00ff" points="418.2123,-151.5653 413.8241,-161.2087 423.2682,-156.4067 418.2123,-151.5653"/>
</g>
<!-- sourcefile~modsave.f90&#45;&gt;sourcefile~modsubgriddata.f90 -->
<g id="sourcefile~~modboundary.f90~~EfferentGraph_edge23" class="edge">
<title>sourcefile~modsave.f90&#45;&gt;sourcefile~modsubgriddata.f90</title>
<path fill="none" stroke="#ff0000" stroke-dasharray="5,2" d="M397.1101,-185.6998C387.4395,-208.6254 363.7539,-258.0188 329,-286.357 327.2581,-287.7773 325.4089,-289.1097 323.4845,-290.3586"/>
<polygon fill="#ff0000" stroke="#ff0000" points="321.6676,-287.3647 314.6637,-295.3143 325.0963,-293.4675 321.6676,-287.3647"/>
</g>
<!-- sourcefile~modsave.f90&#45;&gt;sourcefile~modsurfdata.f90 -->
<g id="sourcefile~~modboundary.f90~~EfferentGraph_edge24" class="edge">
<title>sourcefile~modsave.f90&#45;&gt;sourcefile~modsurfdata.f90</title>
<path fill="none" stroke="#ff0000" stroke-dasharray="5,2" d="M399.4902,-185.666C392.9849,-214.5584 372.9317,-287.3673 329,-328.357 327.7106,-329.56 326.3446,-330.6968 324.9185,-331.7707"/>
<polygon fill="#ff0000" stroke="#ff0000" points="322.8039,-328.9661 316.2086,-337.2579 326.5352,-334.8888 322.8039,-328.9661"/>
</g>
<!-- sourcefile~modsave.f90&#45;&gt;sourcefile~modinletdata.f90 -->
<g id="sourcefile~~modboundary.f90~~EfferentGraph_edge25" class="edge">
<title>sourcefile~modsave.f90&#45;&gt;sourcefile~modinletdata.f90</title>
<path fill="none" stroke="#ff0000" stroke-dasharray="5,2" d="M382.9369,-185.5338C376.9781,-189.6558 370.5226,-194.4617 365,-199.357 347.1018,-215.2222 348.1362,-225.0093 329,-239.357 324.5253,-242.712 319.5491,-245.8043 314.4793,-248.5963"/>
<polygon fill="#ff0000" stroke="#ff0000" points="312.6371,-245.6078 305.3406,-253.2896 315.835,-251.8346 312.6371,-245.6078"/>
</g>
<!-- sourcefile~modsave.f90&#45;&gt;sourcefile~modfields.f90 -->
<g id="sourcefile~~modboundary.f90~~EfferentGraph_edge26" class="edge">
<title>sourcefile~modsave.f90&#45;&gt;sourcefile~modfields.f90</title>
<path fill="none" stroke="#ff0000" stroke-dasharray="5,2" d="M390.0645,-161.3075C382.679,-153.7227 373.0948,-143.644 365,-134.357 348.171,-115.0493 349.0376,-105.3099 329,-89.357 324.7264,-85.9545 319.9345,-82.8541 315.0167,-80.075"/>
<polygon fill="#ff0000" stroke="#ff0000" points="316.5974,-76.952 306.1134,-75.4236 313.3561,-83.1563 316.5974,-76.952"/>
</g>
<!-- sourcefile~modsave.f90&#45;&gt;sourcefile~modglobal.f90 -->
<g id="sourcefile~~modboundary.f90~~EfferentGraph_edge28" class="edge">
<title>sourcefile~modsave.f90&#45;&gt;sourcefile~modglobal.f90</title>
<path fill="none" stroke="#ff0000" stroke-dasharray="5,2" d="M387.3811,-161.3461C373.1592,-150.1089 350.5957,-133.4375 329,-122.357 306.3635,-110.7424 299.705,-109.4373 275,-103.357"/>
</g>
<!-- sourcefile~modsave.f90&#45;&gt;sourcefile~modmpi.f90 -->
<g id="sourcefile~~modboundary.f90~~EfferentGraph_edge29" class="edge">
<title>sourcefile~modsave.f90&#45;&gt;sourcefile~modmpi.f90</title>
<path fill="none" stroke="#ff0000" stroke-dasharray="5,2" d="M383.5924,-185.4161C339.0535,-212.9317 223.3747,-274.3165 145,-225.357"/>
</g>
<!-- sourcefile~modibmdata.f90 -->
<g id="sourcefile~~modboundary.f90~~EfferentGraph_node11" class="node">
<title>sourcefile~modibmdata.f90</title>
<g id="a_sourcefile~~modboundary.f90~~EfferentGraph_node11"><a xlink:href=".././sourcefile/modibmdata.f90.html" xlink:title="modibmdata.f90">
<polygon fill="#f0ad4e" stroke="#f0ad4e" points="320,-197.357 230,-197.357 230,-173.357 320,-173.357 320,-197.357"/>
<text text-anchor="middle" x="275" y="-182.957" font-family="Helvetica,sans-Serif" font-size="10.50" fill="#ffffff">modibmdata.f90</text>
</a>
</g>
</g>
<!-- sourcefile~modsave.f90&#45;&gt;sourcefile~modibmdata.f90 -->
<g id="sourcefile~~modboundary.f90~~EfferentGraph_edge22" class="edge">
<title>sourcefile~modsave.f90&#45;&gt;sourcefile~modibmdata.f90</title>
<path fill="none" stroke="#ff0000" stroke-dasharray="5,2" d="M364.9249,-176.8601C354.1658,-177.8767 342.1749,-179.0097 330.5456,-180.1086"/>
<polygon fill="#ff0000" stroke="#ff0000" points="330.0854,-176.6364 320.459,-181.0616 330.7439,-183.6053 330.0854,-176.6364"/>
</g>
<!-- sourcefile~initfac.f90 -->
<g id="sourcefile~~modboundary.f90~~EfferentGraph_node12" class="node">
<title>sourcefile~initfac.f90</title>
<g id="a_sourcefile~~modboundary.f90~~EfferentGraph_node12"><a xlink:href=".././sourcefile/initfac.f90.html" xlink:title="initfac.f90">
<polygon fill="#f0ad4e" stroke="#f0ad4e" points="304,-155.357 246,-155.357 246,-131.357 304,-131.357 304,-155.357"/>
<text text-anchor="middle" x="275" y="-140.957" font-family="Helvetica,sans-Serif" font-size="10.50" fill="#ffffff">initfac.f90</text>
</a>
</g>
</g>
<!-- sourcefile~modsave.f90&#45;&gt;sourcefile~initfac.f90 -->
<g id="sourcefile~~modboundary.f90~~EfferentGraph_edge27" class="edge">
<title>sourcefile~modsave.f90&#45;&gt;sourcefile~initfac.f90</title>
<path fill="none" stroke="#ff0000" stroke-dasharray="5,2" d="M364.9249,-164.5991C349.0694,-160.8537 330.5387,-156.4764 314.4324,-152.6717"/>
<polygon fill="#ff0000" stroke="#ff0000" points="314.7878,-149.1594 304.251,-150.2667 313.1785,-155.9719 314.7878,-149.1594"/>
</g>
<!-- sourcefile~initfac.f90&#45;&gt;sourcefile~modglobal.f90 -->
<g id="sourcefile~~modboundary.f90~~EfferentGraph_edge30" class="edge">
<title>sourcefile~initfac.f90&#45;&gt;sourcefile~modglobal.f90</title>
<path fill="none" stroke="#00ffff" stroke-dasharray="5,2" d="M248.6926,-131.2151C229.0456,-122.1472 201.9833,-109.657 180.432,-99.7102"/>
<polygon fill="#00ffff" stroke="#00ffff" points="181.8146,-96.4936 171.2683,-95.4808 178.8812,-102.8493 181.8146,-96.4936"/>
</g>
<!-- sourcefile~initfac.f90&#45;&gt;sourcefile~modmpi.f90 -->
<g id="sourcefile~~modboundary.f90~~EfferentGraph_edge31" class="edge">
<title>sourcefile~initfac.f90&#45;&gt;sourcefile~modmpi.f90</title>
<path fill="none" stroke="#00ffff" stroke-dasharray="5,2" d="M245.9399,-152.7925C237.6419,-155.9785 228.753,-159.8806 221,-164.357 183.4909,-186.0138 181.7339,-248.3041 145,-225.357"/>
<path fill="none" stroke="#00ffff" stroke-dasharray="5,2" d="M145,-225.357C96.9491,-195.3402 61.5195,-136.5799 44.9463,-104.8712"/>
<polygon fill="#00ffff" stroke="#00ffff" points="47.8851,-102.9283 40.2358,-95.5975 41.644,-106.0984 47.8851,-102.9283"/>
</g>
</g>
</svg>
</div><script>var pansourcefilemodboundaryf90EfferentGraph = svgPanZoom('#sourcefilemodboundaryf90EfferentGraph', {zoomEnabled: true,controlIconsEnabled: true, fit: true, center: true,}); </script><div><a type="button" class="graph-help" data-toggle="modal" href="#graph-help-text">Help</a></div><div class="modal fade" id="graph-help-text" tabindex="-1" role="dialog"><div class="modal-dialog modal-lg" role="document"><div class="modal-content"><div class="modal-header"><button type="button" class="close" data-dismiss="modal" aria-label="Close"><span aria-hidden="true">&times;</span></button><h4 class="modal-title" id="-graph-help-label">Graph Key</h4></div><div class="modal-body">
    <p>Nodes of different colours represent the following: </p>
    <?xml version="1.0" encoding="UTF-8" standalone="no"?>
<!DOCTYPE svg PUBLIC "-//W3C//DTD SVG 1.1//EN"
 "http://www.w3.org/Graphics/SVG/1.1/DTD/svg11.dtd">
<!-- Generated by graphviz version 2.40.1 (20161225.0304)
 -->
<!-- Title: Graph Key Pages: 1 -->
<svg width="190pt" height="32pt"
 viewBox="0.00 0.00 190.00 32.00" xmlns="http://www.w3.org/2000/svg" xmlns:xlink="http://www.w3.org/1999/xlink">
<g id="graph0" class="graph" transform="scale(1 1) rotate(0) translate(4 28)">
<title>Graph Key</title>
<polygon fill="#ffffff" stroke="transparent" points="-4,4 -4,-28 186,-28 186,4 -4,4"/>
<!-- Source File -->
<g id="node1" class="node">
<title>Source File</title>
<polygon fill="#f0ad4e" stroke="#f0ad4e" points="67,-24 0,-24 0,0 67,0 67,-24"/>
<text text-anchor="middle" x="33.5" y="-9.6" font-family="Helvetica,sans-Serif" font-size="10.50" fill="#ffffff">Source File</text>
</g>
<!-- This Page&#39;s Entity -->
<g id="node2" class="node">
<title>This Page&#39;s Entity</title>
<polygon fill="none" stroke="#000000" points="182,-24 85,-24 85,0 182,0 182,-24"/>
<text text-anchor="middle" x="133.5" y="-9.6" font-family="Helvetica,sans-Serif" font-size="10.50" fill="#000000">This Page&#39;s Entity</text>
</g>
</g>
</svg>

    
    <p>Solid arrows point from a file to a file which it depends on. A file
    is dependent upon another if the latter must be compiled before the former
    can be. Where possible, edges connecting nodes are given different colours to make them easier to distinguish in large graphs.
    </p>
    </div></div></div></div>
      </div>
    </div>
    
      
    <div class="panel panel-default">
      <div class="panel-heading">
  <h3 class="panel-title">Files dependent on this one</h3>
      </div>
      <div class="panel-body">
  <div class="depgraph"><?xml version="1.0" encoding="UTF-8" standalone="no"?>
<!DOCTYPE svg PUBLIC "-//W3C//DTD SVG 1.1//EN"
 "http://www.w3.org/Graphics/SVG/1.1/DTD/svg11.dtd">
<!-- Generated by graphviz version 2.40.1 (20161225.0304)
 -->
<!-- Title: sourcefile~~modboundary.f90~~AfferentGraph Pages: 1 -->
<svg id="sourcefilemodboundaryf90AfferentGraph" width="472pt" height="168pt"
 viewBox="0.00 0.00 472.00 167.66" xmlns="http://www.w3.org/2000/svg" xmlns:xlink="http://www.w3.org/1999/xlink">
<g id="sourcefile~~modboundary.f90~~AfferentGraph" class="graph" transform="scale(1 1) rotate(0) translate(4 163.6639)">
<title>sourcefile~~modboundary.f90~~AfferentGraph</title>
<polygon fill="#ffffff" stroke="transparent" points="-4,4 -4,-163.6639 468,-163.6639 468,4 -4,4"/>
<!-- sourcefile~modboundary.f90 -->
<g id="sourcefile~~modboundary.f90~~AfferentGraph_node1" class="node">
<title>sourcefile~modboundary.f90</title>
<polygon fill="none" stroke="#000000" points="97,-104 0,-104 0,-80 97,-80 97,-104"/>
<text text-anchor="middle" x="48.5" y="-89.6" font-family="Helvetica,sans-Serif" font-size="10.50" fill="#000000">modboundary.f90</text>
</g>
<!-- sourcefile~modpois.f90 -->
<g id="sourcefile~~modboundary.f90~~AfferentGraph_node2" class="node">
<title>sourcefile~modpois.f90</title>
<g id="a_sourcefile~~modboundary.f90~~AfferentGraph_node2"><a xlink:href=".././sourcefile/modpois.f90.html" xlink:title="modpois.f90">
<polygon fill="#f0ad4e" stroke="#f0ad4e" points="212,-124 141,-124 141,-100 212,-100 212,-124"/>
<text text-anchor="middle" x="176.5" y="-109.6" font-family="Helvetica,sans-Serif" font-size="10.50" fill="#ffffff">modpois.f90</text>
</a>
</g>
</g>
<!-- sourcefile~modpois.f90&#45;&gt;sourcefile~modboundary.f90 -->
<g id="sourcefile~~modboundary.f90~~AfferentGraph_edge1" class="edge">
<title>sourcefile~modpois.f90&#45;&gt;sourcefile~modboundary.f90</title>
<path fill="none" stroke="#ff0000" stroke-dasharray="5,2" d="M140.8449,-106.4289C130.432,-104.8019 118.7647,-102.9789 107.3197,-101.1906"/>
<polygon fill="#ff0000" stroke="#ff0000" points="107.7769,-97.7196 97.3564,-99.6338 106.6962,-104.6357 107.7769,-97.7196"/>
</g>
<!-- sourcefile~modstartup.f90 -->
<g id="sourcefile~~modboundary.f90~~AfferentGraph_node3" class="node">
<title>sourcefile~modstartup.f90</title>
<g id="a_sourcefile~~modboundary.f90~~AfferentGraph_node3"><a xlink:href=".././sourcefile/modstartup.f90.html" xlink:title="modstartup.f90">
<polygon fill="#f0ad4e" stroke="#f0ad4e" points="349,-104 264,-104 264,-80 349,-80 349,-104"/>
<text text-anchor="middle" x="306.5" y="-89.6" font-family="Helvetica,sans-Serif" font-size="10.50" fill="#ffffff">modstartup.f90</text>
</a>
</g>
</g>
<!-- sourcefile~modstartup.f90&#45;&gt;sourcefile~modboundary.f90 -->
<g id="sourcefile~~modboundary.f90~~AfferentGraph_edge2" class="edge">
<title>sourcefile~modstartup.f90&#45;&gt;sourcefile~modboundary.f90</title>
<path fill="none" stroke="#ff0000" stroke-dasharray="5,2" d="M263.824,-91.4088C249.8574,-91.2414 234.2672,-91.0825 220,-91 181.334,-90.7765 171.666,-90.7712 133,-91 124.6697,-91.0493 115.8776,-91.1259 107.2385,-91.2153"/>
<polygon fill="#ff0000" stroke="#ff0000" points="107.1651,-87.7158 97.2041,-91.3253 107.2419,-94.7154 107.1651,-87.7158"/>
</g>
<!-- sourcefile~modstartup.f90&#45;&gt;sourcefile~modpois.f90 -->
<g id="sourcefile~~modboundary.f90~~AfferentGraph_edge5" class="edge">
<title>sourcefile~modstartup.f90&#45;&gt;sourcefile~modpois.f90</title>
<path fill="none" stroke="#ff0000" stroke-dasharray="5,2" d="M263.9331,-98.5487C250.5972,-100.6004 235.8254,-102.873 222.2777,-104.9573"/>
<polygon fill="#ff0000" stroke="#ff0000" points="221.5519,-101.5277 212.2004,-106.5076 222.6163,-108.4463 221.5519,-101.5277"/>
</g>
<!-- sourcefile~modsubgrid.f90 -->
<g id="sourcefile~~modboundary.f90~~AfferentGraph_node5" class="node">
<title>sourcefile~modsubgrid.f90</title>
<g id="a_sourcefile~~modboundary.f90~~AfferentGraph_node5"><a xlink:href=".././sourcefile/modsubgrid.f90.html" xlink:title="modsubgrid.f90">
<polygon fill="#f0ad4e" stroke="#f0ad4e" points="220,-44 133,-44 133,-20 220,-20 220,-44"/>
<text text-anchor="middle" x="176.5" y="-29.6" font-family="Helvetica,sans-Serif" font-size="10.50" fill="#ffffff">modsubgrid.f90</text>
</a>
</g>
</g>
<!-- sourcefile~modstartup.f90&#45;&gt;sourcefile~modsubgrid.f90 -->
<g id="sourcefile~~modboundary.f90~~AfferentGraph_edge9" class="edge">
<title>sourcefile~modstartup.f90&#45;&gt;sourcefile~modsubgrid.f90</title>
<path fill="none" stroke="#7f00ff" stroke-dasharray="5,2" d="M280.1926,-79.8581C260.5456,-70.7903 233.4833,-58.3 211.932,-48.3532"/>
<polygon fill="#7f00ff" stroke="#7f00ff" points="213.3146,-45.1366 202.7683,-44.1238 210.3812,-51.4923 213.3146,-45.1366"/>
</g>
<!-- sourcefile~program.f90 -->
<g id="sourcefile~~modboundary.f90~~AfferentGraph_node4" class="node">
<title>sourcefile~program.f90</title>
<g id="a_sourcefile~~modboundary.f90~~AfferentGraph_node4"><a xlink:href=".././sourcefile/program.f90.html" xlink:title="program.f90">
<polygon fill="#f0ad4e" stroke="#f0ad4e" points="464,-84 393,-84 393,-60 464,-60 464,-84"/>
<text text-anchor="middle" x="428.5" y="-69.6" font-family="Helvetica,sans-Serif" font-size="10.50" fill="#ffffff">program.f90</text>
</a>
</g>
</g>
<!-- sourcefile~program.f90&#45;&gt;sourcefile~modboundary.f90 -->
<g id="sourcefile~~modboundary.f90~~AfferentGraph_edge3" class="edge">
<title>sourcefile~program.f90&#45;&gt;sourcefile~modboundary.f90</title>
<path fill="none" stroke="#ff0000" stroke-dasharray="5,2" d="M306.5,-152C230.6953,-168.4645 207.5423,-154.468 133,-133 113.6146,-127.417 93.2307,-117.6545 77.341,-109.0561"/>
<polygon fill="#ff0000" stroke="#ff0000" points="78.9873,-105.9669 68.5463,-104.1684 75.5869,-112.0855 78.9873,-105.9669"/>
</g>
<!-- sourcefile~program.f90&#45;&gt;sourcefile~modpois.f90 -->
<g id="sourcefile~~modboundary.f90~~AfferentGraph_edge6" class="edge">
<title>sourcefile~program.f90&#45;&gt;sourcefile~modpois.f90</title>
<path fill="none" stroke="#ff0000" stroke-dasharray="5,2" d="M416.7762,-84.1115C396.5476,-103.8941 352.7846,-141.9472 306.5,-152"/>
<path fill="none" stroke="#ff0000" stroke-dasharray="5,2" d="M306.5,-152C270.5344,-159.8116 230.1755,-143.2846 204.104,-129.1595"/>
<polygon fill="#ff0000" stroke="#ff0000" points="205.6074,-125.9888 195.1798,-124.1137 202.1621,-132.0823 205.6074,-125.9888"/>
</g>
<!-- sourcefile~program.f90&#45;&gt;sourcefile~modstartup.f90 -->
<g id="sourcefile~~modboundary.f90~~AfferentGraph_edge7" class="edge">
<title>sourcefile~program.f90&#45;&gt;sourcefile~modstartup.f90</title>
<path fill="none" stroke="#7fff00" stroke-dasharray="5,2" d="M392.8846,-77.8386C382.4381,-79.5511 370.7827,-81.4619 359.499,-83.3116"/>
<polygon fill="#7fff00" stroke="#7fff00" points="358.5882,-79.9141 349.2862,-84.9859 359.7207,-86.8219 358.5882,-79.9141"/>
</g>
<!-- sourcefile~program.f90&#45;&gt;sourcefile~modsubgrid.f90 -->
<g id="sourcefile~~modboundary.f90~~AfferentGraph_edge8" class="edge">
<title>sourcefile~program.f90&#45;&gt;sourcefile~modsubgrid.f90</title>
<path fill="none" stroke="#7f00ff" stroke-dasharray="5,2" d="M392.929,-66.3538C350.6238,-59.6387 279.5726,-48.3607 230.4809,-40.5684"/>
<polygon fill="#7f00ff" stroke="#7f00ff" points="230.7819,-37.0724 220.3568,-38.9614 229.6844,-43.9859 230.7819,-37.0724"/>
</g>
<!-- sourcefile~modstatsdump.f90 -->
<g id="sourcefile~~modboundary.f90~~AfferentGraph_node6" class="node">
<title>sourcefile~modstatsdump.f90</title>
<g id="a_sourcefile~~modboundary.f90~~AfferentGraph_node6"><a xlink:href=".././sourcefile/modstatsdump.f90.html" xlink:title="modstatsdump.f90">
<polygon fill="#f0ad4e" stroke="#f0ad4e" points="357,-24 256,-24 256,0 357,0 357,-24"/>
<text text-anchor="middle" x="306.5" y="-9.6" font-family="Helvetica,sans-Serif" font-size="10.50" fill="#ffffff">modstatsdump.f90</text>
</a>
</g>
</g>
<!-- sourcefile~program.f90&#45;&gt;sourcefile~modstatsdump.f90 -->
<g id="sourcefile~~modboundary.f90~~AfferentGraph_edge11" class="edge">
<title>sourcefile~program.f90&#45;&gt;sourcefile~modstatsdump.f90</title>
<path fill="none" stroke="#ff0000" stroke-dasharray="5,2" d="M403.8115,-59.8581C385.5389,-50.8716 360.4316,-38.5237 340.297,-28.6215"/>
<polygon fill="#ff0000" stroke="#ff0000" points="341.67,-25.3964 331.1518,-24.1238 338.5807,-31.6778 341.67,-25.3964"/>
</g>
<!-- sourcefile~modsubgrid.f90&#45;&gt;sourcefile~modboundary.f90 -->
<g id="sourcefile~~modboundary.f90~~AfferentGraph_edge4" class="edge">
<title>sourcefile~modsubgrid.f90&#45;&gt;sourcefile~modboundary.f90</title>
<path fill="none" stroke="#ff0000" stroke-dasharray="5,2" d="M150.5973,-44.1419C131.3393,-53.1691 104.8454,-65.5881 83.6727,-75.5128"/>
<polygon fill="#ff0000" stroke="#ff0000" points="81.9332,-72.4627 74.3642,-79.8762 84.9043,-78.8009 81.9332,-72.4627"/>
</g>
<!-- sourcefile~modstatsdump.f90&#45;&gt;sourcefile~modsubgrid.f90 -->
<g id="sourcefile~~modboundary.f90~~AfferentGraph_edge10" class="edge">
<title>sourcefile~modstatsdump.f90&#45;&gt;sourcefile~modsubgrid.f90</title>
<path fill="none" stroke="#7f00ff" stroke-dasharray="5,2" d="M255.8664,-19.7898C247.3603,-21.0984 238.5086,-22.4602 229.9344,-23.7793"/>
<polygon fill="#7f00ff" stroke="#7f00ff" points="229.3853,-20.3225 220.0339,-25.3025 230.4498,-27.2411 229.3853,-20.3225"/>
</g>
</g>
</svg>
</div><div><a type="button" class="graph-help" data-toggle="modal" href="#graph-help-text">Help</a></div><div class="modal fade" id="graph-help-text" tabindex="-1" role="dialog"><div class="modal-dialog modal-lg" role="document"><div class="modal-content"><div class="modal-header"><button type="button" class="close" data-dismiss="modal" aria-label="Close"><span aria-hidden="true">&times;</span></button><h4 class="modal-title" id="-graph-help-label">Graph Key</h4></div><div class="modal-body">
    <p>Nodes of different colours represent the following: </p>
    <?xml version="1.0" encoding="UTF-8" standalone="no"?>
<!DOCTYPE svg PUBLIC "-//W3C//DTD SVG 1.1//EN"
 "http://www.w3.org/Graphics/SVG/1.1/DTD/svg11.dtd">
<!-- Generated by graphviz version 2.40.1 (20161225.0304)
 -->
<!-- Title: Graph Key Pages: 1 -->
<svg width="190pt" height="32pt"
 viewBox="0.00 0.00 190.00 32.00" xmlns="http://www.w3.org/2000/svg" xmlns:xlink="http://www.w3.org/1999/xlink">
<g id="graph0" class="graph" transform="scale(1 1) rotate(0) translate(4 28)">
<title>Graph Key</title>
<polygon fill="#ffffff" stroke="transparent" points="-4,4 -4,-28 186,-28 186,4 -4,4"/>
<!-- Source File -->
<g id="node1" class="node">
<title>Source File</title>
<polygon fill="#f0ad4e" stroke="#f0ad4e" points="67,-24 0,-24 0,0 67,0 67,-24"/>
<text text-anchor="middle" x="33.5" y="-9.6" font-family="Helvetica,sans-Serif" font-size="10.50" fill="#ffffff">Source File</text>
</g>
<!-- This Page&#39;s Entity -->
<g id="node2" class="node">
<title>This Page&#39;s Entity</title>
<polygon fill="none" stroke="#000000" points="182,-24 85,-24 85,0 182,0 182,-24"/>
<text text-anchor="middle" x="133.5" y="-9.6" font-family="Helvetica,sans-Serif" font-size="10.50" fill="#000000">This Page&#39;s Entity</text>
</g>
</g>
</svg>

    
    <p>Solid arrows point from a file to a file which it depends on. A file
    is dependent upon another if the latter must be compiled before the former
    can be. Where possible, edges connecting nodes are given different colours to make them easier to distinguish in large graphs.
    </p>
    </div></div></div></div>
      </div>
    </div>
      
      <br>

    <section class="visible-xs visible-sm hidden-md">
      
<h3>Contents</h3>
 







<div class="panel panel-primary">
  <div class="panel-heading text-left"><h3 class="panel-title"><a data-toggle="collapse" href="#mods-1">Modules</a></h3></div>
  <div id="mods-1" class="panel-collapse collapse">
    <div class="list-group">
      
      <a class="list-group-item" href="../module/modboundary.html">modboundary</a>
      
    </div>
  </div>
</div>
















<div class="panel panel-primary">
  <div class="panel-heading text-left"><h3 class="panel-title">Source Code</h3></div>
  <div class="list-group">
    <a class="list-group-item" href="../sourcefile/modboundary.f90.html#src">modboundary.f90</a>
  </div>
</div>



    </section>
    <br class="visible-xs visible-sm hidden-md">

    <section>
      <h2><span class="anchor" id="src"></span>Source Code</h2>
    <div class="hl"><pre><span></span><a name="ln-1"></a><span class="c">!&gt; \file modboundary.f90</span>
<a name="ln-2"></a><span class="c">!&gt;</span>
<a name="ln-3"></a><span class="c">!&gt;</span>
<a name="ln-4"></a><span class="c">!! \par Revision list</span>
<a name="ln-5"></a><span class="c">!! All boundary conditions are in this file, except for immersed boundaries.</span>
<a name="ln-6"></a><span class="c">!! \par Authors</span>
<a name="ln-7"></a><span class="c">!!</span>
<a name="ln-8"></a><span class="k">module </span><span class="n">modboundary</span>
<a name="ln-9"></a>
<a name="ln-10"></a>   <span class="k">implicit none</span>
<a name="ln-11"></a><span class="k">   save</span>
<a name="ln-12"></a><span class="k">   private</span>
<a name="ln-13"></a><span class="k">   public</span> <span class="kd">::</span> <span class="n">initboundary</span><span class="p">,</span> <span class="n">boundary</span><span class="p">,</span> <span class="n">grwdamp</span><span class="p">,</span> <span class="n">ksp</span><span class="p">,</span> <span class="n">tqaver</span><span class="p">,</span> <span class="p">&amp;</span>
<a name="ln-14"></a>             <span class="n">bcp</span><span class="p">,</span> <span class="n">bcpup</span><span class="p">,</span> <span class="n">closurebc</span>
<a name="ln-15"></a>   <span class="kt">integer</span> <span class="kd">::</span> <span class="n">ksp</span> <span class="o">=</span> <span class="o">-</span><span class="mi">1</span> <span class="c">!&lt;    lowest level of sponge layer</span>
<a name="ln-16"></a>   <span class="kt">real</span><span class="p">,</span> <span class="k">allocatable</span> <span class="kd">::</span> <span class="n">tsc</span><span class="p">(:)</span> <span class="c">!&lt;   damping coefficients to be used in grwdamp.</span>
<a name="ln-17"></a>   <span class="kt">real</span> <span class="kd">::</span> <span class="n">rnu0</span> <span class="o">=</span> <span class="mf">2.75e-3</span>
<a name="ln-18"></a><span class="k">contains</span>
<a name="ln-19"></a>   <span class="c">!&gt;</span>
<a name="ln-20"></a>   <span class="c">!! Initializing Boundary; specifically the sponge layer</span>
<a name="ln-21"></a>   <span class="c">!&gt;</span>
<a name="ln-22"></a>   <span class="k">subroutine </span><span class="n">initboundary</span>
<a name="ln-23"></a>      <span class="k">use </span><span class="n">modglobal</span><span class="p">,</span> <span class="n">only</span><span class="p">:</span><span class="n">ib</span><span class="p">,</span> <span class="n">kb</span><span class="p">,</span> <span class="n">ke</span><span class="p">,</span> <span class="n">kh</span><span class="p">,</span> <span class="n">kmax</span><span class="p">,</span> <span class="n">pi</span><span class="p">,</span> <span class="n">zf</span><span class="p">,</span> <span class="n">iplane</span>
<a name="ln-24"></a>      <span class="k">use </span><span class="n">modinletdata</span><span class="p">,</span> <span class="n">only</span><span class="p">:</span><span class="n">irecy</span><span class="p">,</span><span class="n">irecydriver</span>
<a name="ln-25"></a>      <span class="k">implicit none</span>
<a name="ln-26"></a>
<a name="ln-27"></a><span class="k">      </span><span class="kt">real</span>    <span class="kd">::</span> <span class="n">zspb</span><span class="p">,</span> <span class="n">zspt</span>
<a name="ln-28"></a>      <span class="kt">integer</span> <span class="kd">::</span> <span class="n">k</span>
<a name="ln-29"></a>      <span class="k">allocate</span> <span class="p">(</span><span class="n">tsc</span><span class="p">(</span><span class="n">kb</span><span class="p">:</span><span class="n">ke</span> <span class="o">+</span> <span class="n">kh</span><span class="p">))</span>
<a name="ln-30"></a>      <span class="c">! Sponge layer</span>
<a name="ln-31"></a>      <span class="k">if</span> <span class="p">(</span><span class="n">ksp</span> <span class="o">==</span> <span class="o">-</span><span class="mi">1</span><span class="p">)</span> <span class="k">then</span>
<a name="ln-32"></a>         <span class="c">!      ksp  = min(3*kmax/4,kmax - 15)</span>
<a name="ln-33"></a>         <span class="n">ksp</span> <span class="o">=</span> <span class="p">(</span><span class="n">kb</span> <span class="o">-</span> <span class="mi">1</span><span class="p">)</span> <span class="o">+</span> <span class="nb">max</span><span class="p">(</span><span class="nb">min</span><span class="p">(</span><span class="mi">3</span><span class="o">*</span><span class="n">kmax</span><span class="o">/</span><span class="mi">4</span><span class="p">,</span> <span class="n">kmax</span> <span class="o">-</span> <span class="mi">15</span><span class="p">),</span><span class="mi">1</span><span class="p">)</span>
<a name="ln-34"></a>      <span class="k">end if</span>
<a name="ln-35"></a>
<a name="ln-36"></a><span class="k">      </span><span class="n">zspb</span> <span class="o">=</span> <span class="n">zf</span><span class="p">(</span><span class="n">ksp</span><span class="p">)</span>
<a name="ln-37"></a>      <span class="n">zspt</span> <span class="o">=</span> <span class="n">zf</span><span class="p">(</span><span class="n">ke</span><span class="p">)</span>
<a name="ln-38"></a>
<a name="ln-39"></a>      <span class="n">tsc</span><span class="p">(</span><span class="n">kb</span><span class="p">:</span><span class="n">ksp</span> <span class="o">-</span> <span class="mi">1</span><span class="p">)</span> <span class="o">=</span> <span class="mf">0.0</span>
<a name="ln-40"></a>      <span class="k">do </span><span class="n">k</span> <span class="o">=</span> <span class="n">ksp</span><span class="p">,</span> <span class="n">ke</span>
<a name="ln-41"></a>         <span class="n">tsc</span><span class="p">(</span><span class="n">k</span><span class="p">)</span> <span class="o">=</span> <span class="n">rnu0</span><span class="o">*</span><span class="nb">sin</span><span class="p">(</span><span class="mf">0.5</span><span class="o">*</span><span class="n">pi</span><span class="o">*</span><span class="p">(</span><span class="n">zf</span><span class="p">(</span><span class="n">k</span><span class="p">)</span> <span class="o">-</span> <span class="n">zspb</span><span class="p">)</span><span class="o">/</span><span class="p">(</span><span class="n">zspt</span> <span class="o">-</span> <span class="n">zspb</span><span class="p">))</span><span class="o">**</span><span class="mi">2</span>
<a name="ln-42"></a>      <span class="k">end do</span>
<a name="ln-43"></a><span class="k">      </span><span class="n">tsc</span><span class="p">(</span><span class="n">ke</span> <span class="o">+</span> <span class="mi">1</span><span class="p">)</span> <span class="o">=</span> <span class="n">tsc</span><span class="p">(</span><span class="n">ke</span><span class="p">)</span>
<a name="ln-44"></a>      <span class="n">irecy</span> <span class="o">=</span> <span class="n">ib</span> <span class="o">+</span> <span class="n">iplane</span>
<a name="ln-45"></a>      <span class="n">irecydriver</span> <span class="o">=</span> <span class="n">iplane</span><span class="c">! + ib</span>
<a name="ln-46"></a>
<a name="ln-47"></a>   <span class="k">end subroutine </span><span class="n">initboundary</span>
<a name="ln-48"></a>
<a name="ln-49"></a>   <span class="c">!&gt;</span>
<a name="ln-50"></a>   <span class="c">!! Execute boundary conditions</span>
<a name="ln-51"></a>   <span class="k">subroutine </span><span class="n">boundary</span>
<a name="ln-52"></a>
<a name="ln-53"></a>      <span class="k">use </span><span class="n">modglobal</span><span class="p">,</span> <span class="n">only</span><span class="p">:</span><span class="n">ib</span><span class="p">,</span> <span class="n">ie</span><span class="p">,</span> <span class="n">ih</span><span class="p">,</span> <span class="n">jb</span><span class="p">,</span> <span class="n">je</span><span class="p">,</span> <span class="n">jgb</span><span class="p">,</span> <span class="n">jge</span><span class="p">,</span> <span class="n">jh</span><span class="p">,</span> <span class="n">kb</span><span class="p">,</span> <span class="n">ke</span><span class="p">,</span> <span class="n">kh</span><span class="p">,</span> <span class="n">linoutflow</span><span class="p">,</span> <span class="n">dzf</span><span class="p">,</span> <span class="n">zh</span><span class="p">,</span> <span class="n">dy</span><span class="p">,</span> <span class="p">&amp;</span>
<a name="ln-54"></a>         <span class="n">timee</span><span class="p">,</span> <span class="n">ltempeq</span><span class="p">,</span> <span class="n">lmoist</span><span class="p">,</span> <span class="n">BCxm</span><span class="p">,</span> <span class="n">BCym</span><span class="p">,</span> <span class="n">BCxT</span><span class="p">,</span> <span class="n">BCyT</span><span class="p">,</span> <span class="n">BCxq</span><span class="p">,</span> <span class="n">BCyq</span><span class="p">,</span> <span class="n">BCxs</span><span class="p">,</span> <span class="n">BCys</span><span class="p">,</span> <span class="n">BCtopm</span><span class="p">,</span> <span class="n">BCtopT</span><span class="p">,&amp;</span>
<a name="ln-55"></a>         <span class="n">BCtopq</span><span class="p">,</span> <span class="n">BCtops</span><span class="p">,</span> <span class="n">e12min</span><span class="p">,</span> <span class="n">idriver</span><span class="p">,</span> <span class="n">luvolflowr</span><span class="p">,</span> <span class="n">luoutflowr</span>
<a name="ln-56"></a>      <span class="k">use </span><span class="n">modfields</span><span class="p">,</span> <span class="n">only</span><span class="p">:</span><span class="n">u0</span><span class="p">,</span> <span class="n">v0</span><span class="p">,</span> <span class="n">w0</span><span class="p">,</span> <span class="n">um</span><span class="p">,</span> <span class="n">vm</span><span class="p">,</span> <span class="n">wm</span><span class="p">,</span> <span class="n">thl0</span><span class="p">,</span> <span class="n">thlm</span><span class="p">,</span> <span class="n">qt0</span><span class="p">,</span> <span class="n">qtm</span><span class="p">,</span> <span class="n">uout</span><span class="p">,</span> <span class="n">uouttot</span><span class="p">,</span> <span class="n">e120</span><span class="p">,</span> <span class="n">e12m</span><span class="p">,&amp;</span>
<a name="ln-57"></a>                          <span class="n">u0av</span>
<a name="ln-58"></a>      <span class="k">use </span><span class="n">modsubgriddata</span><span class="p">,</span> <span class="n">only</span><span class="p">:</span><span class="n">ekh</span><span class="p">,</span> <span class="n">ekm</span>
<a name="ln-59"></a>      <span class="k">use </span><span class="n">modsurfdata</span><span class="p">,</span> <span class="n">only</span><span class="p">:</span><span class="n">thl_top</span><span class="p">,</span> <span class="n">qt_top</span><span class="p">,</span> <span class="n">sv_top</span><span class="p">,</span> <span class="n">wttop</span><span class="p">,</span> <span class="n">wqtop</span><span class="p">,</span> <span class="n">wsvtop</span>
<a name="ln-60"></a>      <span class="k">use </span><span class="n">modmpi</span><span class="p">,</span> <span class="n">only</span><span class="p">:</span><span class="n">myid</span><span class="p">,</span> <span class="n">slabsum</span>
<a name="ln-61"></a>      <span class="k">use </span><span class="n">modinlet</span><span class="p">,</span> <span class="n">only</span><span class="p">:</span><span class="n">inletgen</span><span class="p">,</span> <span class="n">inletgennotemp</span>
<a name="ln-62"></a>      <span class="k">use </span><span class="n">moddriver</span><span class="p">,</span> <span class="n">only</span> <span class="p">:</span> <span class="n">drivergen</span>
<a name="ln-63"></a>      <span class="k">use </span><span class="n">modinletdata</span><span class="p">,</span> <span class="n">only</span><span class="p">:</span><span class="n">irecy</span><span class="p">,</span> <span class="n">ubulk</span><span class="p">,</span> <span class="n">iangle</span>
<a name="ln-64"></a><span class="c">!    use modsurface, only : getobl</span>
<a name="ln-65"></a>      <span class="k">implicit none</span>
<a name="ln-66"></a><span class="k">      </span><span class="kt">real</span><span class="p">,</span> <span class="k">dimension</span><span class="p">(</span><span class="n">kb</span><span class="p">:</span><span class="n">ke</span><span class="p">)</span> <span class="kd">::</span> <span class="n">uaverage</span>
<a name="ln-67"></a>      <span class="kt">integer </span><span class="n">i</span><span class="p">,</span> <span class="n">k</span>
<a name="ln-68"></a>
<a name="ln-69"></a>     <span class="c">! if not using massflowrate need to set outflow velocity</span>
<a name="ln-70"></a>     <span class="k">if</span> <span class="p">(</span><span class="n">luoutflowr</span><span class="p">)</span> <span class="k">then</span>
<a name="ln-71"></a>        <span class="c">! do nothing - calculated in modforces</span>
<a name="ln-72"></a>     <span class="n">elseif</span> <span class="p">(.</span><span class="nb">not</span><span class="p">.</span> <span class="n">luvolflowr</span><span class="p">)</span> <span class="k">then</span>
<a name="ln-73"></a>        <span class="c">!ubulk = sum(u0av)/(ke-kb+1)</span>
<a name="ln-74"></a>        <span class="k">do </span><span class="n">k</span> <span class="o">=</span> <span class="n">kb</span><span class="p">,</span> <span class="n">ke</span>
<a name="ln-75"></a>           <span class="n">uaverage</span><span class="p">(</span><span class="n">k</span><span class="p">)</span> <span class="o">=</span> <span class="n">u0av</span><span class="p">(</span><span class="n">k</span><span class="p">)</span><span class="o">*</span><span class="n">dzf</span><span class="p">(</span><span class="n">k</span><span class="p">)</span>                                                        
<a name="ln-76"></a>        <span class="k">end do</span>
<a name="ln-77"></a>        <span class="c">! need a method to know if we have all blocks at lowest cell kb</span>
<a name="ln-78"></a>        <span class="c">! assuming this for now (hence kb+1)</span>
<a name="ln-79"></a>        <span class="n">uouttot</span> <span class="o">=</span> <span class="nb">sum</span><span class="p">(</span><span class="n">uaverage</span><span class="p">(</span><span class="n">kb</span><span class="p">:</span><span class="n">ke</span><span class="p">))</span><span class="o">/</span><span class="p">(</span><span class="n">zh</span><span class="p">(</span><span class="n">ke</span> <span class="o">+</span> <span class="mi">1</span><span class="p">)</span> <span class="o">-</span> <span class="n">zh</span><span class="p">(</span><span class="n">kb</span><span class="o">+</span><span class="mi">1</span><span class="p">))</span> 
<a name="ln-80"></a>     <span class="k">else</span>
<a name="ln-81"></a><span class="k">        </span><span class="n">uouttot</span> <span class="o">=</span> <span class="n">ubulk</span>
<a name="ln-82"></a>     <span class="k">end if</span>
<a name="ln-83"></a>
<a name="ln-84"></a>     <span class="c">!BCxm!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!</span>
<a name="ln-85"></a>     <span class="c">!periodic or inflow/outflow conditions for momentum</span>
<a name="ln-86"></a>      <span class="k">if</span> <span class="p">(</span><span class="n">BCxm</span> <span class="p">.</span><span class="n">eq</span><span class="p">.</span> <span class="mi">1</span><span class="p">)</span> <span class="k">then</span>  <span class="c">!periodic</span>
<a name="ln-87"></a>         <span class="k">call </span><span class="n">cyclicmi</span>
<a name="ln-88"></a>
<a name="ln-89"></a>         <span class="k">if</span> <span class="p">(</span><span class="n">idriver</span> <span class="o">==</span> <span class="mi">1</span><span class="p">)</span> <span class="k">then</span> <span class="c">! write driver files</span>
<a name="ln-90"></a>           <span class="k">call </span><span class="n">drivergen</span>
<a name="ln-91"></a>         <span class="k">end if</span>
<a name="ln-92"></a>
<a name="ln-93"></a><span class="k">      else if</span> <span class="p">(</span><span class="n">BCxm</span> <span class="p">.</span><span class="n">eq</span><span class="p">.</span> <span class="mi">2</span><span class="p">)</span> <span class="k">then</span> <span class="c">!previously iinletgen 1</span>
<a name="ln-94"></a>         <span class="n">uouttot</span> <span class="o">=</span> <span class="nb">cos</span><span class="p">(</span><span class="n">iangle</span><span class="p">)</span><span class="o">*</span><span class="n">ubulk</span>
<a name="ln-95"></a>         <span class="k">if</span> <span class="p">(</span><span class="n">ltempeq</span><span class="p">)</span> <span class="k">then</span>
<a name="ln-96"></a><span class="k">            call </span><span class="n">inletgen</span>
<a name="ln-97"></a>         <span class="k">else</span>
<a name="ln-98"></a><span class="k">            call </span><span class="n">inletgennotemp</span>
<a name="ln-99"></a>         <span class="k">end if</span>
<a name="ln-100"></a>
<a name="ln-101"></a>         <span class="c">! iolet - called due to BCtopm = 3</span>
<a name="ln-102"></a>
<a name="ln-103"></a>      <span class="k">else if</span> <span class="p">(</span><span class="n">BCxm</span> <span class="p">.</span><span class="n">eq</span><span class="p">.</span> <span class="mi">3</span><span class="p">)</span> <span class="k">then</span> <span class="c">! previously iinletgen 2</span>
<a name="ln-104"></a>         <span class="n">uouttot</span> <span class="o">=</span> <span class="nb">cos</span><span class="p">(</span><span class="n">iangle</span><span class="p">)</span><span class="o">*</span><span class="n">ubulk</span>
<a name="ln-105"></a>         <span class="k">if</span> <span class="p">(</span><span class="n">ltempeq</span><span class="p">)</span> <span class="k">then</span>
<a name="ln-106"></a><span class="k">            call </span><span class="n">inletgen</span>
<a name="ln-107"></a>         <span class="k">else</span>
<a name="ln-108"></a><span class="k">            call </span><span class="n">inletgennotemp</span>
<a name="ln-109"></a>         <span class="k">end if</span>
<a name="ln-110"></a>
<a name="ln-111"></a>         <span class="c">! iolet - called due to BCtopm = 3</span>
<a name="ln-112"></a>
<a name="ln-113"></a>      <span class="k">else if</span> <span class="p">(</span><span class="n">BCxm</span> <span class="p">.</span><span class="n">eq</span><span class="p">.</span> <span class="mi">4</span><span class="p">)</span> <span class="k">then</span> <span class="c">!previously (inoutflow without iinlet)</span>
<a name="ln-114"></a>         <span class="n">uouttot</span> <span class="o">=</span> <span class="nb">cos</span><span class="p">(</span><span class="n">iangle</span><span class="p">)</span><span class="o">*</span><span class="n">ubulk</span>
<a name="ln-115"></a>         <span class="k">if</span> <span class="p">(</span><span class="n">ltempeq</span><span class="p">)</span> <span class="k">then</span>
<a name="ln-116"></a><span class="k">            call </span><span class="n">inletgen</span>
<a name="ln-117"></a>         <span class="k">else</span>
<a name="ln-118"></a><span class="k">            call </span><span class="n">inletgennotemp</span>
<a name="ln-119"></a>         <span class="k">end if</span>
<a name="ln-120"></a>
<a name="ln-121"></a>         <span class="c">! iolet - called due to BCtopm = 3</span>
<a name="ln-122"></a>
<a name="ln-123"></a>      <span class="k">else if</span> <span class="p">(</span><span class="n">BCxm</span> <span class="p">.</span><span class="n">eq</span><span class="p">.</span> <span class="mi">5</span><span class="p">)</span> <span class="k">then</span> <span class="c">! driver from drivergen (idriver == 2)</span>
<a name="ln-124"></a>
<a name="ln-125"></a>         <span class="n">uouttot</span> <span class="o">=</span> <span class="n">ubulk</span> <span class="c">! does this hold for all forcings of precursor simulations? tg3315</span>
<a name="ln-126"></a>
<a name="ln-127"></a>         <span class="k">call </span><span class="n">drivergen</span>
<a name="ln-128"></a>
<a name="ln-129"></a>         <span class="c">! iolet - called due to BCtopm = 3</span>
<a name="ln-130"></a>
<a name="ln-131"></a>      <span class="k">else</span>
<a name="ln-132"></a><span class="k">         write</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="o">*</span><span class="p">)</span> <span class="s2">&quot;ERROR: lateral boundary type for veloctiy in x-direciton undefined&quot;</span>
<a name="ln-133"></a>         <span class="k">stop </span><span class="mi">1</span>
<a name="ln-134"></a>      <span class="k">end if</span>
<a name="ln-135"></a>
<a name="ln-136"></a>      <span class="c">!BCym!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!</span>
<a name="ln-137"></a>      <span class="c">!currently BC in y is always periodic for momentum</span>
<a name="ln-138"></a>      <span class="k">if</span> <span class="p">(</span><span class="n">BCym</span> <span class="p">.</span><span class="n">eq</span><span class="p">.</span> <span class="mi">1</span><span class="p">)</span> <span class="k">then</span>
<a name="ln-139"></a><span class="k">         call </span><span class="n">cyclicmj</span>
<a name="ln-140"></a>      <span class="k">else</span>
<a name="ln-141"></a><span class="k">         write</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="o">*</span><span class="p">)</span> <span class="s2">&quot;ERROR: lateral boundary type for velocity in y-direction undefined&quot;</span>
<a name="ln-142"></a>         <span class="k">stop </span><span class="mi">1</span>
<a name="ln-143"></a>      <span class="k">end if</span>
<a name="ln-144"></a>
<a name="ln-145"></a>      <span class="c">!BCxT!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!</span>
<a name="ln-146"></a>      <span class="k">if</span> <span class="p">(</span><span class="n">BCxT</span> <span class="p">.</span><span class="n">eq</span><span class="p">.</span> <span class="mi">1</span><span class="p">)</span> <span class="k">then</span>
<a name="ln-147"></a><span class="k">         call </span><span class="n">cyclichi</span>
<a name="ln-148"></a>
<a name="ln-149"></a>      <span class="k">else if</span> <span class="p">(</span><span class="n">BCxT</span> <span class="p">.</span><span class="n">eq</span><span class="p">.</span> <span class="mi">2</span><span class="p">)</span> <span class="k">then</span> <span class="c">!inoutflow - will be overwritten unless BCxm == 1</span>
<a name="ln-150"></a>         <span class="k">call </span><span class="n">iohi</span>    <span class="c">! make sure uouttot is known and realistic</span>
<a name="ln-151"></a>      <span class="k">else if</span> <span class="p">(</span><span class="n">BCxT</span> <span class="p">.</span><span class="n">eq</span><span class="p">.</span> <span class="mi">3</span><span class="p">)</span> <span class="k">then</span>
<a name="ln-152"></a>         <span class="c">!do nothing, temperature is considered in iolet</span>
<a name="ln-153"></a>      <span class="k">else</span>
<a name="ln-154"></a><span class="k">         write</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="o">*</span><span class="p">)</span> <span class="s2">&quot;ERROR: lateral boundary type for temperature in x-direction undefined&quot;</span>
<a name="ln-155"></a>         <span class="k">stop </span><span class="mi">1</span>
<a name="ln-156"></a>      <span class="k">end if</span>
<a name="ln-157"></a>
<a name="ln-158"></a>      <span class="c">!BCyT!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!</span>
<a name="ln-159"></a>      <span class="k">if</span> <span class="p">(</span><span class="n">BCyT</span> <span class="p">.</span><span class="n">eq</span><span class="p">.</span> <span class="mi">1</span><span class="p">)</span> <span class="k">then</span>
<a name="ln-160"></a><span class="k">         call </span><span class="n">cyclichj</span>
<a name="ln-161"></a>      <span class="k">else</span>
<a name="ln-162"></a><span class="k">         write</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="o">*</span><span class="p">)</span> <span class="s2">&quot;ERROR: lateral boundary type for temperature in y-direction undefined&quot;</span>
<a name="ln-163"></a>         <span class="k">stop </span><span class="mi">1</span>
<a name="ln-164"></a>      <span class="k">end if</span>
<a name="ln-165"></a>
<a name="ln-166"></a>      <span class="c">!BCxq!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!</span>
<a name="ln-167"></a>      <span class="k">if</span> <span class="p">(</span><span class="n">BCxq</span> <span class="p">.</span><span class="n">eq</span><span class="p">.</span> <span class="mi">1</span><span class="p">)</span> <span class="k">then</span>
<a name="ln-168"></a><span class="k">         call </span><span class="n">cyclicqi</span>
<a name="ln-169"></a>      <span class="k">else if</span> <span class="p">(</span><span class="n">BCxq</span> <span class="p">.</span><span class="n">eq</span><span class="p">.</span> <span class="mi">2</span><span class="p">)</span> <span class="k">then</span> <span class="c">!inoutflow  - will be overwritten unless BCxm == 1</span>
<a name="ln-170"></a>        <span class="k">call </span><span class="n">ioqi</span> <span class="c">! tg3315 - make sure uouttot is known and realistic</span>
<a name="ln-171"></a>      <span class="n">elseif</span> <span class="p">(</span><span class="n">BCxq</span> <span class="p">.</span><span class="n">eq</span><span class="p">.</span> <span class="mi">3</span><span class="p">)</span> <span class="k">then</span> 
<a name="ln-172"></a>        <span class="c">!do nothing, temperature is considered in iolet</span>
<a name="ln-173"></a>      <span class="k">else</span>
<a name="ln-174"></a><span class="k">         write</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="o">*</span><span class="p">)</span> <span class="s2">&quot;ERROR: lateral boundary type for humidity in x-direction undefined&quot;</span>
<a name="ln-175"></a>         <span class="k">stop </span><span class="mi">1</span>
<a name="ln-176"></a>      <span class="k">end if</span>
<a name="ln-177"></a>
<a name="ln-178"></a>      <span class="c">!BCyq!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!</span>
<a name="ln-179"></a>      <span class="k">if</span> <span class="p">(</span><span class="n">BCyq</span> <span class="p">.</span><span class="n">eq</span><span class="p">.</span> <span class="mi">1</span><span class="p">)</span> <span class="k">then</span>
<a name="ln-180"></a><span class="k">         call </span><span class="n">cyclicqj</span>
<a name="ln-181"></a>      <span class="k">else</span>
<a name="ln-182"></a><span class="k">         write</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="o">*</span><span class="p">)</span> <span class="s2">&quot;ERROR: lateral boundary type for humidity in y-direction undefined&quot;</span>
<a name="ln-183"></a>         <span class="k">stop </span><span class="mi">1</span>
<a name="ln-184"></a>      <span class="k">end if</span>
<a name="ln-185"></a>
<a name="ln-186"></a>      <span class="c">!BCys!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!</span>
<a name="ln-187"></a>      <span class="k">if</span> <span class="p">(</span><span class="n">BCys</span> <span class="p">.</span><span class="n">eq</span><span class="p">.</span> <span class="mi">1</span><span class="p">)</span> <span class="k">then</span>
<a name="ln-188"></a><span class="k">         call </span><span class="n">cyclicsj</span>
<a name="ln-189"></a>      <span class="n">elseif</span> <span class="p">(</span><span class="n">BCys</span> <span class="p">.</span><span class="n">eq</span><span class="p">.</span> <span class="mi">5</span><span class="p">)</span> <span class="k">then</span>
<a name="ln-190"></a>         <span class="c">! done in scalSIRANE</span>
<a name="ln-191"></a>      <span class="k">else</span>
<a name="ln-192"></a><span class="k">         write</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="o">*</span><span class="p">)</span> <span class="s2">&quot;ERROR: lateral boundary type for scalars in y-direction undefined&quot;</span>
<a name="ln-193"></a>         <span class="k">stop </span><span class="mi">1</span>
<a name="ln-194"></a>      <span class="k">end if</span>
<a name="ln-195"></a>
<a name="ln-196"></a>      <span class="c">!BCxs!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!</span>
<a name="ln-197"></a>      <span class="k">if</span> <span class="p">(</span><span class="n">BCxs</span> <span class="p">.</span><span class="n">eq</span><span class="p">.</span> <span class="mi">1</span><span class="p">)</span> <span class="k">then</span>
<a name="ln-198"></a><span class="k">         call </span><span class="n">cyclicsi</span>
<a name="ln-199"></a>      <span class="k">else if</span> <span class="p">(</span><span class="n">BCxs</span> <span class="p">.</span><span class="n">eq</span><span class="p">.</span> <span class="mi">2</span><span class="p">)</span> <span class="k">then</span> <span class="c">!inoutflow  - will be overwritten unless BCxm == 1</span>
<a name="ln-200"></a>         <span class="k">call </span><span class="n">iosi</span> <span class="c">! make sure uouttot is known and correct for the running set-up</span>
<a name="ln-201"></a>      <span class="k">else if</span> <span class="p">(</span><span class="n">BCxs</span> <span class="p">.</span><span class="n">eq</span><span class="p">.</span> <span class="mi">3</span><span class="p">)</span> <span class="k">then</span>
<a name="ln-202"></a>         <span class="c">! do nothing - considered in iolet</span>
<a name="ln-203"></a>
<a name="ln-204"></a>      <span class="k">else if</span> <span class="p">(</span><span class="n">BCxs</span> <span class="p">.</span><span class="n">eq</span><span class="p">.</span> <span class="mi">4</span><span class="p">)</span> <span class="k">then</span> <span class="c">!scalrec - will be overwritten unless BCxm == 1</span>
<a name="ln-205"></a>         <span class="k">call </span><span class="n">scalrec</span>
<a name="ln-206"></a>
<a name="ln-207"></a>      <span class="k">else if</span> <span class="p">(</span><span class="n">BCxs</span> <span class="p">.</span><span class="n">eq</span><span class="p">.</span> <span class="mi">5</span><span class="p">)</span> <span class="k">then</span> <span class="c">!previously SIRANE - will be overwritten unless BCxm == 1</span>
<a name="ln-208"></a>         <span class="k">call </span><span class="n">scalSIRANE</span> <span class="c">!  make sure uouttot/ vouttot is known and realistic</span>
<a name="ln-209"></a>
<a name="ln-210"></a>      <span class="k">else</span>
<a name="ln-211"></a><span class="k">         write</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="o">*</span><span class="p">)</span> <span class="s2">&quot;ERROR: lateral boundary type for scalars in x-direction undefined&quot;</span>
<a name="ln-212"></a>         <span class="k">stop </span><span class="mi">1</span>
<a name="ln-213"></a>      <span class="k">end if</span>
<a name="ln-214"></a>
<a name="ln-215"></a>      <span class="c">!BCtopm!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!</span>
<a name="ln-216"></a>      <span class="k">if</span> <span class="p">(</span><span class="n">BCtopm</span> <span class="p">.</span><span class="n">eq</span><span class="p">.</span> <span class="mi">1</span><span class="p">)</span> <span class="k">then</span>
<a name="ln-217"></a>         <span class="c">!free-slip = zero-flux</span>
<a name="ln-218"></a>         <span class="k">call </span><span class="n">fluxtop</span><span class="p">(</span><span class="n">um</span><span class="p">,</span> <span class="n">ekm</span><span class="p">,</span> <span class="mf">0.0</span><span class="p">)</span>
<a name="ln-219"></a>         <span class="k">call </span><span class="n">fluxtop</span><span class="p">(</span><span class="n">u0</span><span class="p">,</span> <span class="n">ekm</span><span class="p">,</span> <span class="mf">0.0</span><span class="p">)</span>
<a name="ln-220"></a>         <span class="k">call </span><span class="n">fluxtop</span><span class="p">(</span><span class="n">vm</span><span class="p">,</span> <span class="n">ekm</span><span class="p">,</span> <span class="mf">0.0</span><span class="p">)</span>
<a name="ln-221"></a>         <span class="k">call </span><span class="n">fluxtop</span><span class="p">(</span><span class="n">v0</span><span class="p">,</span> <span class="n">ekm</span><span class="p">,</span> <span class="mf">0.0</span><span class="p">)</span>
<a name="ln-222"></a>         <span class="n">e120</span><span class="p">(:,</span> <span class="p">:,</span> <span class="n">ke</span> <span class="o">+</span> <span class="mi">1</span><span class="p">)</span> <span class="o">=</span> <span class="n">e12min</span> <span class="c">! free slip top wall</span>
<a name="ln-223"></a>         <span class="n">e12m</span><span class="p">(:,</span> <span class="p">:,</span> <span class="n">ke</span> <span class="o">+</span> <span class="mi">1</span><span class="p">)</span> <span class="o">=</span> <span class="n">e12min</span>
<a name="ln-224"></a>         <span class="n">w0</span><span class="p">(:,</span> <span class="p">:,</span> <span class="n">ke</span> <span class="o">+</span> <span class="mi">1</span><span class="p">)</span> <span class="o">=</span> <span class="mf">0.0</span>
<a name="ln-225"></a>         <span class="n">wm</span><span class="p">(:,</span> <span class="p">:,</span> <span class="n">ke</span> <span class="o">+</span> <span class="mi">1</span><span class="p">)</span> <span class="o">=</span> <span class="mf">0.0</span>
<a name="ln-226"></a>      <span class="k">else if</span> <span class="p">(</span><span class="n">BCtopm</span> <span class="p">.</span><span class="n">eq</span><span class="p">.</span> <span class="mi">2</span><span class="p">)</span> <span class="k">then</span>
<a name="ln-227"></a>         <span class="c">!no-slip = zero velocity at wall</span>
<a name="ln-228"></a>         <span class="k">call </span><span class="n">valuetop</span><span class="p">(</span><span class="n">um</span><span class="p">,</span> <span class="mf">0.0</span><span class="p">)</span>
<a name="ln-229"></a>         <span class="k">call </span><span class="n">valuetop</span><span class="p">(</span><span class="n">u0</span><span class="p">,</span> <span class="mf">0.0</span><span class="p">)</span>
<a name="ln-230"></a>         <span class="k">call </span><span class="n">valuetop</span><span class="p">(</span><span class="n">vm</span><span class="p">,</span> <span class="mf">0.0</span><span class="p">)</span>
<a name="ln-231"></a>         <span class="k">call </span><span class="n">valuetop</span><span class="p">(</span><span class="n">v0</span><span class="p">,</span> <span class="mf">0.0</span><span class="p">)</span>
<a name="ln-232"></a>         <span class="n">w0</span><span class="p">(:,</span> <span class="p">:,</span> <span class="n">ke</span> <span class="o">+</span> <span class="mi">1</span><span class="p">)</span> <span class="o">=</span> <span class="mf">0.0</span>
<a name="ln-233"></a>         <span class="n">wm</span><span class="p">(:,</span> <span class="p">:,</span> <span class="n">ke</span> <span class="o">+</span> <span class="mi">1</span><span class="p">)</span> <span class="o">=</span> <span class="mf">0.0</span>
<a name="ln-234"></a>      <span class="k">else if</span> <span class="p">(</span><span class="n">BCtopm</span> <span class="p">.</span><span class="n">eq</span><span class="p">.</span> <span class="mi">3</span><span class="p">)</span> <span class="k">then</span>
<a name="ln-235"></a><span class="k">         call </span><span class="n">fluxtop</span><span class="p">(</span><span class="n">um</span><span class="p">,</span> <span class="n">ekm</span><span class="p">,</span> <span class="mf">0.0</span><span class="p">)</span>
<a name="ln-236"></a>         <span class="k">call </span><span class="n">fluxtop</span><span class="p">(</span><span class="n">u0</span><span class="p">,</span> <span class="n">ekm</span><span class="p">,</span> <span class="mf">0.0</span><span class="p">)</span>
<a name="ln-237"></a>         <span class="k">call </span><span class="n">fluxtop</span><span class="p">(</span><span class="n">vm</span><span class="p">,</span> <span class="n">ekm</span><span class="p">,</span> <span class="mf">0.0</span><span class="p">)</span>
<a name="ln-238"></a>         <span class="k">call </span><span class="n">fluxtop</span><span class="p">(</span><span class="n">v0</span><span class="p">,</span> <span class="n">ekm</span><span class="p">,</span> <span class="mf">0.0</span><span class="p">)</span>
<a name="ln-239"></a>         <span class="n">e120</span><span class="p">(:,</span> <span class="p">:,</span> <span class="n">ke</span> <span class="o">+</span> <span class="mi">1</span><span class="p">)</span> <span class="o">=</span> <span class="n">e12min</span> <span class="c">! free slip top wall</span>
<a name="ln-240"></a>         <span class="n">e12m</span><span class="p">(:,</span> <span class="p">:,</span> <span class="n">ke</span> <span class="o">+</span> <span class="mi">1</span><span class="p">)</span> <span class="o">=</span> <span class="n">e12min</span>
<a name="ln-241"></a>         <span class="k">if</span> <span class="p">(</span><span class="n">idriver</span><span class="o">==</span><span class="mi">2</span><span class="p">)</span> <span class="k">then</span> <span class="c">! does not use ddispdx, Uinf etc.</span>
<a name="ln-242"></a>           <span class="n">w0</span><span class="p">(:,</span> <span class="p">:,</span> <span class="n">ke</span> <span class="o">+</span> <span class="mi">1</span><span class="p">)</span> <span class="o">=</span> <span class="mf">0.0</span>
<a name="ln-243"></a>           <span class="n">wm</span><span class="p">(:,</span> <span class="p">:,</span> <span class="n">ke</span> <span class="o">+</span> <span class="mi">1</span><span class="p">)</span> <span class="o">=</span> <span class="mf">0.0</span>
<a name="ln-244"></a>         <span class="k">else</span>
<a name="ln-245"></a><span class="k">           call </span><span class="n">inlettop</span> <span class="c">! for iinletgen...</span>
<a name="ln-246"></a>         <span class="k">end if</span>
<a name="ln-247"></a><span class="k">         call </span><span class="n">iolet</span>  <span class="c">!ils13, 13.8.18: iolet also deals with lateral boundaries!!</span>
<a name="ln-248"></a>      <span class="k">else</span>
<a name="ln-249"></a><span class="k">         write</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="o">*</span><span class="p">)</span> <span class="s2">&quot;ERROR: top boundary type for velocity undefined&quot;</span>
<a name="ln-250"></a>         <span class="k">stop </span><span class="mi">1</span>
<a name="ln-251"></a>      <span class="k">end if</span>
<a name="ln-252"></a>
<a name="ln-253"></a>      <span class="c">!BCtopT!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!</span>
<a name="ln-254"></a>      <span class="k">if</span> <span class="p">(</span><span class="n">BCtopT</span> <span class="p">.</span><span class="n">eq</span><span class="p">.</span> <span class="mi">1</span><span class="p">)</span> <span class="k">then</span>
<a name="ln-255"></a><span class="k">         call </span><span class="n">fluxtop</span><span class="p">(</span><span class="n">thlm</span><span class="p">,</span> <span class="n">ekh</span><span class="p">,</span> <span class="n">wttop</span><span class="p">)</span>
<a name="ln-256"></a>         <span class="k">call </span><span class="n">fluxtop</span><span class="p">(</span><span class="n">thl0</span><span class="p">,</span> <span class="n">ekh</span><span class="p">,</span> <span class="n">wttop</span><span class="p">)</span>
<a name="ln-257"></a>      <span class="k">else if</span> <span class="p">(</span><span class="n">BCtopT</span> <span class="p">.</span><span class="n">eq</span><span class="p">.</span> <span class="mi">2</span><span class="p">)</span> <span class="k">then</span>
<a name="ln-258"></a><span class="k">         call </span><span class="n">valuetop</span><span class="p">(</span><span class="n">thlm</span><span class="p">,</span> <span class="n">thl_top</span><span class="p">)</span>
<a name="ln-259"></a>         <span class="k">call </span><span class="n">valuetop</span><span class="p">(</span><span class="n">thl0</span><span class="p">,</span> <span class="n">thl_top</span><span class="p">)</span>
<a name="ln-260"></a>      <span class="k">else</span>
<a name="ln-261"></a><span class="k">         write</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="o">*</span><span class="p">)</span> <span class="s2">&quot;ERROR: top boundary type for temperature undefined&quot;</span>
<a name="ln-262"></a>         <span class="k">stop </span><span class="mi">1</span>
<a name="ln-263"></a>      <span class="k">end if</span>
<a name="ln-264"></a>
<a name="ln-265"></a>      <span class="c">!BCtopq!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!</span>
<a name="ln-266"></a>      <span class="k">if</span> <span class="p">(</span><span class="n">BCtopq</span> <span class="p">.</span><span class="n">eq</span><span class="p">.</span> <span class="mi">1</span><span class="p">)</span> <span class="k">then</span>
<a name="ln-267"></a><span class="k">         call </span><span class="n">fluxtop</span><span class="p">(</span><span class="n">qtm</span><span class="p">,</span> <span class="n">ekh</span><span class="p">,</span> <span class="n">wqtop</span><span class="p">)</span>
<a name="ln-268"></a>         <span class="k">call </span><span class="n">fluxtop</span><span class="p">(</span><span class="n">qt0</span><span class="p">,</span> <span class="n">ekh</span><span class="p">,</span> <span class="n">wqtop</span><span class="p">)</span>
<a name="ln-269"></a>      <span class="k">else if</span> <span class="p">(</span><span class="n">BCtopq</span> <span class="p">.</span><span class="n">eq</span><span class="p">.</span> <span class="mi">2</span><span class="p">)</span> <span class="k">then</span>
<a name="ln-270"></a><span class="k">         call </span><span class="n">valuetop</span><span class="p">(</span><span class="n">qtm</span><span class="p">,</span> <span class="n">qt_top</span><span class="p">)</span>
<a name="ln-271"></a>         <span class="k">call </span><span class="n">valuetop</span><span class="p">(</span><span class="n">qt0</span><span class="p">,</span> <span class="n">qt_top</span><span class="p">)</span>
<a name="ln-272"></a>      <span class="k">else</span>
<a name="ln-273"></a><span class="k">         write</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="o">*</span><span class="p">)</span> <span class="s2">&quot;ERROR: top boundary type for humidity undefined&quot;</span>
<a name="ln-274"></a>         <span class="k">stop </span><span class="mi">1</span>
<a name="ln-275"></a>      <span class="k">end if</span>
<a name="ln-276"></a>
<a name="ln-277"></a>      <span class="c">!BCtops!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!</span>
<a name="ln-278"></a>      <span class="k">if</span> <span class="p">(</span><span class="n">BCtops</span> <span class="p">.</span><span class="n">eq</span><span class="p">.</span> <span class="mi">1</span><span class="p">)</span> <span class="k">then</span>
<a name="ln-279"></a><span class="k">         call </span><span class="n">fluxtopscal</span><span class="p">(</span><span class="n">wsvtop</span><span class="p">)</span>
<a name="ln-280"></a>         <span class="k">call </span><span class="n">fluxtopscal</span><span class="p">(</span><span class="n">wsvtop</span><span class="p">)</span>
<a name="ln-281"></a>      <span class="k">else if</span> <span class="p">(</span><span class="n">BCtops</span> <span class="p">.</span><span class="n">eq</span><span class="p">.</span> <span class="mi">2</span><span class="p">)</span> <span class="k">then</span>
<a name="ln-282"></a><span class="k">         call </span><span class="n">valuetopscal</span><span class="p">(</span><span class="n">sv_top</span><span class="p">)</span>
<a name="ln-283"></a>         <span class="k">call </span><span class="n">valuetopscal</span><span class="p">(</span><span class="n">sv_top</span><span class="p">)</span>
<a name="ln-284"></a>      <span class="k">else</span>
<a name="ln-285"></a><span class="k">         write</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="o">*</span><span class="p">)</span> <span class="s2">&quot;ERROR: top boundary type for scalars undefined&quot;</span>
<a name="ln-286"></a>         <span class="k">stop </span><span class="mi">1</span>
<a name="ln-287"></a>      <span class="k">end if</span>
<a name="ln-288"></a>
<a name="ln-289"></a><span class="k">   end subroutine </span><span class="n">boundary</span>
<a name="ln-290"></a>
<a name="ln-291"></a>   <span class="k">subroutine </span><span class="n">closurebc</span>
<a name="ln-292"></a>      <span class="k">use </span><span class="n">modsubgriddata</span><span class="p">,</span> <span class="n">only</span><span class="p">:</span><span class="n">ekm</span><span class="p">,</span> <span class="n">ekh</span>
<a name="ln-293"></a>      <span class="k">use </span><span class="n">modglobal</span><span class="p">,</span> <span class="n">only</span><span class="p">:</span><span class="n">ib</span><span class="p">,</span> <span class="n">ie</span><span class="p">,</span> <span class="n">jb</span><span class="p">,</span> <span class="n">je</span><span class="p">,</span> <span class="n">kb</span><span class="p">,</span> <span class="n">ke</span><span class="p">,</span> <span class="n">ih</span><span class="p">,</span> <span class="n">jh</span><span class="p">,</span> <span class="n">kh</span><span class="p">,</span> <span class="n">numol</span><span class="p">,</span> <span class="n">prandtlmoli</span><span class="p">,</span> <span class="n">linoutflow</span><span class="p">,</span> <span class="n">BCtopm</span>
<a name="ln-294"></a>      <span class="k">use </span><span class="n">modmpi</span><span class="p">,</span> <span class="n">only</span><span class="p">:</span><span class="n">excjs</span>
<a name="ln-295"></a>      <span class="kt">integer </span><span class="n">i</span><span class="p">,</span> <span class="n">j</span>
<a name="ln-296"></a>
<a name="ln-297"></a>      <span class="c">! Top and bottom</span>
<a name="ln-298"></a>      <span class="c">! ils13, 13.8.18: what should it be for slip or mixed BCs ?</span>
<a name="ln-299"></a>      <span class="k">if</span> <span class="p">((</span><span class="n">BCtopm</span><span class="p">.</span><span class="n">eq</span><span class="p">.</span><span class="mi">1</span><span class="p">)</span> <span class="p">.</span><span class="nb">or</span><span class="p">.</span> <span class="p">(</span><span class="n">BCtopm</span><span class="p">.</span><span class="n">eq</span><span class="p">.</span><span class="mi">3</span><span class="p">))</span> <span class="k">then</span> <span class="c">!free-slip</span>
<a name="ln-300"></a>         <span class="k">do </span><span class="n">j</span> <span class="o">=</span> <span class="n">jb</span> <span class="o">-</span> <span class="mi">1</span><span class="p">,</span> <span class="n">je</span> <span class="o">+</span> <span class="mi">1</span>
<a name="ln-301"></a>            <span class="k">do </span><span class="n">i</span> <span class="o">=</span> <span class="n">ib</span> <span class="o">-</span> <span class="mi">1</span><span class="p">,</span> <span class="n">ie</span> <span class="o">+</span> <span class="mi">1</span>
<a name="ln-302"></a>               <span class="n">ekm</span><span class="p">(</span><span class="n">i</span><span class="p">,</span> <span class="n">j</span><span class="p">,</span> <span class="n">ke</span> <span class="o">+</span> <span class="mi">1</span><span class="p">)</span> <span class="o">=</span> <span class="n">ekm</span><span class="p">(</span><span class="n">i</span><span class="p">,</span> <span class="n">j</span><span class="p">,</span> <span class="n">ke</span><span class="p">)</span> <span class="c">! zero-gradient top wall</span>
<a name="ln-303"></a>               <span class="n">ekh</span><span class="p">(</span><span class="n">i</span><span class="p">,</span> <span class="n">j</span><span class="p">,</span> <span class="n">ke</span> <span class="o">+</span> <span class="mi">1</span><span class="p">)</span> <span class="o">=</span> <span class="n">ekh</span><span class="p">(</span><span class="n">i</span><span class="p">,</span> <span class="n">j</span><span class="p">,</span> <span class="n">ke</span><span class="p">)</span> <span class="c">! zero-gradient top wall</span>
<a name="ln-304"></a>               <span class="n">ekm</span><span class="p">(</span><span class="n">i</span><span class="p">,</span> <span class="n">j</span><span class="p">,</span> <span class="n">kb</span> <span class="o">-</span> <span class="mi">1</span><span class="p">)</span> <span class="o">=</span> <span class="mf">2.</span><span class="o">*</span><span class="n">numol</span> <span class="o">-</span> <span class="n">ekm</span><span class="p">(</span><span class="n">i</span><span class="p">,</span> <span class="n">j</span><span class="p">,</span> <span class="n">kb</span><span class="p">)</span> <span class="c">! no-slip lower wall</span>
<a name="ln-305"></a>               <span class="n">ekh</span><span class="p">(</span><span class="n">i</span><span class="p">,</span> <span class="n">j</span><span class="p">,</span> <span class="n">kb</span> <span class="o">-</span> <span class="mi">1</span><span class="p">)</span> <span class="o">=</span> <span class="p">(</span><span class="mf">2.</span><span class="o">*</span><span class="n">numol</span><span class="o">*</span><span class="n">prandtlmoli</span><span class="p">)</span> <span class="o">-</span> <span class="n">ekh</span><span class="p">(</span><span class="n">i</span><span class="p">,</span> <span class="n">j</span><span class="p">,</span> <span class="n">kb</span><span class="p">)</span> <span class="c">! no-slip lower wall</span>
<a name="ln-306"></a>            <span class="k">end do</span>
<a name="ln-307"></a><span class="k">         end do</span>
<a name="ln-308"></a><span class="k">      else if</span> <span class="p">(</span><span class="n">BCtopm</span><span class="p">.</span><span class="n">eq</span><span class="p">.</span><span class="mi">2</span><span class="p">)</span>  <span class="k">then</span> <span class="c">!no-slip</span>
<a name="ln-309"></a>         <span class="k">do </span><span class="n">j</span> <span class="o">=</span> <span class="n">jb</span> <span class="o">-</span> <span class="mi">1</span><span class="p">,</span> <span class="n">je</span> <span class="o">+</span> <span class="mi">1</span>
<a name="ln-310"></a>            <span class="k">do </span><span class="n">i</span> <span class="o">=</span> <span class="n">ib</span> <span class="o">-</span> <span class="mi">1</span><span class="p">,</span> <span class="n">ie</span> <span class="o">+</span> <span class="mi">1</span>
<a name="ln-311"></a>               <span class="n">ekm</span><span class="p">(</span><span class="n">i</span><span class="p">,</span> <span class="n">j</span><span class="p">,</span> <span class="n">ke</span> <span class="o">+</span> <span class="mi">1</span><span class="p">)</span> <span class="o">=</span> <span class="mf">2.</span><span class="o">*</span><span class="n">numol</span> <span class="o">-</span> <span class="n">ekm</span><span class="p">(</span><span class="n">i</span><span class="p">,</span> <span class="n">j</span><span class="p">,</span> <span class="n">ke</span><span class="p">)</span> <span class="c">! no-slip top wall</span>
<a name="ln-312"></a>               <span class="n">ekh</span><span class="p">(</span><span class="n">i</span><span class="p">,</span> <span class="n">j</span><span class="p">,</span> <span class="n">ke</span> <span class="o">+</span> <span class="mi">1</span><span class="p">)</span> <span class="o">=</span> <span class="p">(</span><span class="mf">2.</span><span class="o">*</span><span class="n">numol</span><span class="o">*</span><span class="n">prandtlmoli</span><span class="p">)</span> <span class="o">-</span> <span class="n">ekh</span><span class="p">(</span><span class="n">i</span><span class="p">,</span> <span class="n">j</span><span class="p">,</span> <span class="n">ke</span><span class="p">)</span> <span class="c">! no-slip top wall</span>
<a name="ln-313"></a>               <span class="n">ekm</span><span class="p">(</span><span class="n">i</span><span class="p">,</span> <span class="n">j</span><span class="p">,</span> <span class="n">kb</span> <span class="o">-</span> <span class="mi">1</span><span class="p">)</span> <span class="o">=</span> <span class="mf">2.</span><span class="o">*</span><span class="n">numol</span> <span class="o">-</span> <span class="n">ekm</span><span class="p">(</span><span class="n">i</span><span class="p">,</span> <span class="n">j</span><span class="p">,</span> <span class="n">kb</span><span class="p">)</span> <span class="c">! no-slip lower wall</span>
<a name="ln-314"></a>               <span class="n">ekh</span><span class="p">(</span><span class="n">i</span><span class="p">,</span> <span class="n">j</span><span class="p">,</span> <span class="n">kb</span> <span class="o">-</span> <span class="mi">1</span><span class="p">)</span> <span class="o">=</span> <span class="p">(</span><span class="mf">2.</span><span class="o">*</span><span class="n">numol</span><span class="o">*</span><span class="n">prandtlmoli</span><span class="p">)</span> <span class="o">-</span> <span class="n">ekh</span><span class="p">(</span><span class="n">i</span><span class="p">,</span> <span class="n">j</span><span class="p">,</span> <span class="n">kb</span><span class="p">)</span> <span class="c">! no-slip lower wall</span>
<a name="ln-315"></a>            <span class="k">end do</span>
<a name="ln-316"></a><span class="k">         end do</span>
<a name="ln-317"></a><span class="k">      end if</span>
<a name="ln-318"></a>
<a name="ln-319"></a>      <span class="c">! horizontal BC&#39;s</span>
<a name="ln-320"></a>      <span class="k">if</span> <span class="p">(</span><span class="n">linoutflow</span><span class="p">)</span> <span class="k">then</span> <span class="c">! inflow/outflow</span>
<a name="ln-321"></a>         <span class="n">ekm</span><span class="p">(</span><span class="n">ib</span> <span class="o">-</span> <span class="mi">1</span><span class="p">,</span> <span class="p">:,</span> <span class="p">:)</span> <span class="o">=</span> <span class="n">ekm</span><span class="p">(</span><span class="n">ib</span><span class="p">,</span> <span class="p">:,</span> <span class="p">:)</span>
<a name="ln-322"></a>         <span class="n">ekm</span><span class="p">(</span><span class="n">ie</span> <span class="o">+</span> <span class="mi">1</span><span class="p">,</span> <span class="p">:,</span> <span class="p">:)</span> <span class="o">=</span> <span class="n">ekm</span><span class="p">(</span><span class="n">ie</span><span class="p">,</span> <span class="p">:,</span> <span class="p">:)</span>
<a name="ln-323"></a>         <span class="n">ekh</span><span class="p">(</span><span class="n">ib</span> <span class="o">-</span> <span class="mi">1</span><span class="p">,</span> <span class="p">:,</span> <span class="p">:)</span> <span class="o">=</span> <span class="n">ekh</span><span class="p">(</span><span class="n">ib</span><span class="p">,</span> <span class="p">:,</span> <span class="p">:)</span>
<a name="ln-324"></a>         <span class="n">ekh</span><span class="p">(</span><span class="n">ie</span> <span class="o">+</span> <span class="mi">1</span><span class="p">,</span> <span class="p">:,</span> <span class="p">:)</span> <span class="o">=</span> <span class="n">ekh</span><span class="p">(</span><span class="n">ie</span><span class="p">,</span> <span class="p">:,</span> <span class="p">:)</span>
<a name="ln-325"></a>      <span class="k">else</span>
<a name="ln-326"></a><span class="k">         </span><span class="n">ekm</span><span class="p">(</span><span class="n">ib</span> <span class="o">-</span> <span class="mi">1</span><span class="p">,</span> <span class="p">:,</span> <span class="p">:)</span> <span class="o">=</span> <span class="n">ekm</span><span class="p">(</span><span class="n">ie</span><span class="p">,</span> <span class="p">:,</span> <span class="p">:)</span> <span class="c">! periodic</span>
<a name="ln-327"></a>         <span class="n">ekm</span><span class="p">(</span><span class="n">ie</span> <span class="o">+</span> <span class="mi">1</span><span class="p">,</span> <span class="p">:,</span> <span class="p">:)</span> <span class="o">=</span> <span class="n">ekm</span><span class="p">(</span><span class="n">ib</span><span class="p">,</span> <span class="p">:,</span> <span class="p">:)</span>
<a name="ln-328"></a>         <span class="n">ekh</span><span class="p">(</span><span class="n">ib</span> <span class="o">-</span> <span class="mi">1</span><span class="p">,</span> <span class="p">:,</span> <span class="p">:)</span> <span class="o">=</span> <span class="n">ekh</span><span class="p">(</span><span class="n">ie</span><span class="p">,</span> <span class="p">:,</span> <span class="p">:)</span>
<a name="ln-329"></a>         <span class="n">ekh</span><span class="p">(</span><span class="n">ie</span> <span class="o">+</span> <span class="mi">1</span><span class="p">,</span> <span class="p">:,</span> <span class="p">:)</span> <span class="o">=</span> <span class="n">ekh</span><span class="p">(</span><span class="n">ib</span><span class="p">,</span> <span class="p">:,</span> <span class="p">:)</span>
<a name="ln-330"></a>      <span class="k">end if</span>
<a name="ln-331"></a>
<a name="ln-332"></a><span class="k">      call </span><span class="n">excjs</span><span class="p">(</span><span class="n">ekm</span><span class="p">,</span> <span class="n">ib</span><span class="p">,</span> <span class="n">ie</span><span class="p">,</span> <span class="n">jb</span><span class="p">,</span> <span class="n">je</span><span class="p">,</span> <span class="n">kb</span> <span class="o">-</span> <span class="n">kh</span><span class="p">,</span> <span class="n">ke</span> <span class="o">+</span> <span class="n">kh</span><span class="p">,</span> <span class="n">ih</span><span class="p">,</span> <span class="n">jh</span><span class="p">)</span>
<a name="ln-333"></a>      <span class="k">call </span><span class="n">excjs</span><span class="p">(</span><span class="n">ekh</span><span class="p">,</span> <span class="n">ib</span><span class="p">,</span> <span class="n">ie</span><span class="p">,</span> <span class="n">jb</span><span class="p">,</span> <span class="n">je</span><span class="p">,</span> <span class="n">kb</span> <span class="o">-</span> <span class="n">kh</span><span class="p">,</span> <span class="n">ke</span> <span class="o">+</span> <span class="n">kh</span><span class="p">,</span> <span class="n">ih</span><span class="p">,</span> <span class="n">jh</span><span class="p">)</span>
<a name="ln-334"></a>
<a name="ln-335"></a>   <span class="k">end subroutine </span><span class="n">closurebc</span>
<a name="ln-336"></a>
<a name="ln-337"></a>
<a name="ln-338"></a>   <span class="c">!&gt; Sets lateral periodic boundary conditions for the scalars</span>
<a name="ln-339"></a>   <span class="k">subroutine </span><span class="n">iosi</span>
<a name="ln-340"></a>      <span class="k">use </span><span class="n">modglobal</span><span class="p">,</span> <span class="n">only</span><span class="p">:</span><span class="n">ib</span><span class="p">,</span> <span class="n">ie</span><span class="p">,</span> <span class="n">jb</span><span class="p">,</span> <span class="n">je</span><span class="p">,</span> <span class="n">ih</span><span class="p">,</span> <span class="n">jh</span><span class="p">,</span> <span class="n">kb</span><span class="p">,</span> <span class="n">ke</span><span class="p">,</span> <span class="n">kh</span><span class="p">,</span> <span class="n">nsv</span><span class="p">,</span> <span class="n">dt</span><span class="p">,</span> <span class="n">rk3step</span><span class="p">,</span> <span class="n">dxhi</span><span class="p">,</span> <span class="n">ltempeq</span><span class="p">,</span> <span class="p">&amp;</span>
<a name="ln-341"></a>         <span class="n">ihc</span><span class="p">,</span> <span class="n">jhc</span><span class="p">,</span> <span class="n">khc</span><span class="p">,</span> <span class="n">dy</span>
<a name="ln-342"></a>      <span class="k">use </span><span class="n">modfields</span><span class="p">,</span> <span class="n">only</span><span class="p">:</span><span class="n">sv0</span><span class="p">,</span> <span class="n">svm</span><span class="p">,</span> <span class="n">svprof</span><span class="p">,</span> <span class="n">uouttot</span>
<a name="ln-343"></a>      <span class="k">use </span><span class="n">modinletdata</span><span class="p">,</span> <span class="n">only</span><span class="p">:</span><span class="n">ubulk</span>
<a name="ln-344"></a>      <span class="kt">real </span><span class="n">rk3coef</span>
<a name="ln-345"></a>      <span class="kt">integer </span><span class="n">k</span><span class="p">,</span> <span class="n">n</span><span class="p">,</span> <span class="n">m</span>
<a name="ln-346"></a>
<a name="ln-347"></a>      <span class="n">rk3coef</span> <span class="o">=</span> <span class="n">dt</span><span class="o">/</span><span class="p">(</span><span class="mf">4.</span><span class="o">-</span><span class="nb">dble</span><span class="p">(</span><span class="n">rk3step</span><span class="p">))</span>
<a name="ln-348"></a>      <span class="k">do </span><span class="n">n</span> <span class="o">=</span> <span class="mi">1</span><span class="p">,</span> <span class="n">nsv</span>
<a name="ln-349"></a>         <span class="k">do </span><span class="n">k</span> <span class="o">=</span> <span class="n">kb</span><span class="p">,</span> <span class="n">ke</span> <span class="o">+</span> <span class="mi">1</span>
<a name="ln-350"></a>            <span class="n">sv0</span><span class="p">(</span><span class="n">ib</span> <span class="o">-</span> <span class="mi">1</span><span class="p">,</span> <span class="p">:,</span> <span class="n">k</span><span class="p">,</span> <span class="n">n</span><span class="p">)</span> <span class="o">=</span> <span class="mi">2</span><span class="o">*</span><span class="n">svprof</span><span class="p">(</span><span class="n">k</span><span class="p">,</span> <span class="n">n</span><span class="p">)</span> <span class="o">-</span> <span class="n">sv0</span><span class="p">(</span><span class="n">ib</span><span class="p">,</span> <span class="p">:,</span> <span class="n">k</span><span class="p">,</span> <span class="n">n</span><span class="p">)</span>
<a name="ln-351"></a>            <span class="n">svm</span><span class="p">(</span><span class="n">ib</span> <span class="o">-</span> <span class="mi">1</span><span class="p">,</span> <span class="p">:,</span> <span class="n">k</span><span class="p">,</span> <span class="n">n</span><span class="p">)</span> <span class="o">=</span> <span class="mi">2</span><span class="o">*</span><span class="n">svprof</span><span class="p">(</span><span class="n">k</span><span class="p">,</span> <span class="n">n</span><span class="p">)</span> <span class="o">-</span> <span class="n">svm</span><span class="p">(</span><span class="n">ib</span><span class="p">,</span> <span class="p">:,</span> <span class="n">k</span><span class="p">,</span> <span class="n">n</span><span class="p">)</span>
<a name="ln-352"></a>         <span class="k">end do</span>
<a name="ln-353"></a><span class="k">         </span><span class="n">sv0</span><span class="p">(</span><span class="n">ie</span> <span class="o">+</span> <span class="mi">1</span><span class="p">,</span> <span class="p">:,</span> <span class="p">:,</span> <span class="n">n</span><span class="p">)</span> <span class="o">=</span> <span class="n">sv0</span><span class="p">(</span><span class="n">ie</span><span class="p">,</span> <span class="p">:,</span> <span class="p">:,</span> <span class="n">n</span><span class="p">)</span> <span class="o">-</span> <span class="p">(</span><span class="n">sv0</span><span class="p">(</span><span class="n">ie</span> <span class="o">+</span> <span class="mi">1</span><span class="p">,</span> <span class="p">:,</span> <span class="p">:,</span> <span class="n">n</span><span class="p">)</span> <span class="o">-</span> <span class="n">sv0</span><span class="p">(</span><span class="n">ie</span><span class="p">,</span> <span class="p">:,</span> <span class="p">:,</span> <span class="n">n</span><span class="p">))</span><span class="o">*</span><span class="n">dxhi</span><span class="p">(</span><span class="n">ie</span> <span class="o">+</span> <span class="mi">1</span><span class="p">)</span><span class="o">*</span><span class="n">rk3coef</span><span class="o">*</span><span class="n">uouttot</span>  <span class="c">! tg3315 should be uouttot and will have to change depending on forcing</span>
<a name="ln-354"></a>         <span class="n">svm</span><span class="p">(</span><span class="n">ie</span> <span class="o">+</span> <span class="mi">1</span><span class="p">,</span> <span class="p">:,</span> <span class="p">:,</span> <span class="n">n</span><span class="p">)</span> <span class="o">=</span> <span class="n">svm</span><span class="p">(</span><span class="n">ie</span><span class="p">,</span> <span class="p">:,</span> <span class="p">:,</span> <span class="n">n</span><span class="p">)</span> <span class="o">-</span> <span class="p">(</span><span class="n">svm</span><span class="p">(</span><span class="n">ie</span> <span class="o">+</span> <span class="mi">1</span><span class="p">,</span> <span class="p">:,</span> <span class="p">:,</span> <span class="n">n</span><span class="p">)</span> <span class="o">-</span> <span class="n">svm</span><span class="p">(</span><span class="n">ie</span><span class="p">,</span> <span class="p">:,</span> <span class="p">:,</span> <span class="n">n</span><span class="p">))</span><span class="o">*</span><span class="n">dxhi</span><span class="p">(</span><span class="n">ie</span> <span class="o">+</span> <span class="mi">1</span><span class="p">)</span><span class="o">*</span><span class="n">rk3coef</span><span class="o">*</span><span class="n">uouttot</span>
<a name="ln-355"></a>      <span class="n">enddo</span>
<a name="ln-356"></a>
<a name="ln-357"></a>      <span class="k">return</span>
<a name="ln-358"></a><span class="k">   end subroutine </span><span class="n">iosi</span>
<a name="ln-359"></a>
<a name="ln-360"></a>   <span class="k">subroutine </span><span class="n">scalrec</span>
<a name="ln-361"></a>      <span class="k">use </span><span class="n">modglobal</span><span class="p">,</span> <span class="n">only</span><span class="p">:</span><span class="n">ib</span><span class="p">,</span> <span class="n">ie</span><span class="p">,</span> <span class="n">jb</span><span class="p">,</span> <span class="n">je</span><span class="p">,</span> <span class="n">ih</span><span class="p">,</span> <span class="n">jh</span><span class="p">,</span> <span class="n">kb</span><span class="p">,</span> <span class="n">ke</span><span class="p">,</span> <span class="n">kh</span><span class="p">,</span> <span class="n">nsv</span><span class="p">,</span> <span class="n">dt</span><span class="p">,</span> <span class="n">rk3step</span><span class="p">,</span> <span class="n">dxhi</span><span class="p">,</span> <span class="n">ltempeq</span><span class="p">,</span> <span class="p">&amp;</span>
<a name="ln-362"></a>         <span class="n">ihc</span><span class="p">,</span> <span class="n">jhc</span><span class="p">,</span> <span class="n">khc</span><span class="p">,</span> <span class="n">dy</span>
<a name="ln-363"></a>      <span class="k">use </span><span class="n">modfields</span><span class="p">,</span> <span class="n">only</span><span class="p">:</span><span class="n">sv0</span><span class="p">,</span> <span class="n">svm</span><span class="p">,</span> <span class="n">svprof</span><span class="p">,</span> <span class="n">uouttot</span><span class="p">,</span> <span class="n">um</span><span class="p">,</span> <span class="n">u0</span><span class="p">,</span> <span class="n">vm</span><span class="p">,</span> <span class="n">v0</span>
<a name="ln-364"></a>      <span class="k">use </span><span class="n">modinletdata</span><span class="p">,</span> <span class="n">only</span><span class="p">:</span><span class="n">ubulk</span>
<a name="ln-365"></a>      <span class="kt">real </span><span class="n">rk3coef</span>
<a name="ln-366"></a>      <span class="kt">integer </span><span class="n">k</span><span class="p">,</span> <span class="n">n</span><span class="p">,</span> <span class="n">m</span>
<a name="ln-367"></a>      <span class="c">! recycling method for scalar fields following Matheou and Bowman (2015)</span>
<a name="ln-368"></a>
<a name="ln-369"></a>      <span class="k">if</span> <span class="p">(</span><span class="n">nsv</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">)</span> <span class="k">then</span>
<a name="ln-370"></a><span class="k">         </span><span class="n">rk3coef</span> <span class="o">=</span> <span class="n">dt</span><span class="o">/</span><span class="p">(</span><span class="mf">4.</span><span class="o">-</span><span class="nb">dble</span><span class="p">(</span><span class="n">rk3step</span><span class="p">))</span>
<a name="ln-371"></a>         <span class="k">do </span><span class="n">m</span> <span class="o">=</span> <span class="mi">1</span><span class="p">,</span> <span class="n">ihc</span> <span class="c">! loop over virtual cells</span>
<a name="ln-372"></a>            <span class="k">do </span><span class="n">n</span> <span class="o">=</span> <span class="mi">1</span><span class="p">,</span> <span class="n">nsv</span> <span class="o">-</span> <span class="mi">1</span>
<a name="ln-373"></a>               <span class="n">sv0</span><span class="p">(</span><span class="n">ib</span> <span class="o">-</span> <span class="n">m</span><span class="p">,</span> <span class="p">:,</span> <span class="p">:,</span> <span class="n">n</span> <span class="o">+</span> <span class="mi">1</span><span class="p">)</span> <span class="o">=</span> <span class="n">sv0</span><span class="p">(</span><span class="n">ie</span> <span class="o">+</span> <span class="mi">1</span> <span class="o">-</span> <span class="n">m</span><span class="p">,</span> <span class="p">:,</span> <span class="p">:,</span> <span class="n">n</span><span class="p">)</span>
<a name="ln-374"></a>               <span class="n">sv0</span><span class="p">(</span><span class="n">ie</span> <span class="o">+</span> <span class="n">m</span><span class="p">,</span> <span class="p">:,</span> <span class="p">:,</span> <span class="n">n</span><span class="p">)</span> <span class="o">=</span> <span class="n">sv0</span><span class="p">(</span><span class="n">ib</span> <span class="o">-</span> <span class="mi">1</span> <span class="o">+</span> <span class="n">m</span><span class="p">,</span> <span class="p">:,</span> <span class="p">:,</span> <span class="n">n</span> <span class="o">+</span> <span class="mi">1</span><span class="p">)</span>
<a name="ln-375"></a>               <span class="n">svm</span><span class="p">(</span><span class="n">ib</span> <span class="o">-</span> <span class="n">m</span><span class="p">,</span> <span class="p">:,</span> <span class="p">:,</span> <span class="n">n</span> <span class="o">+</span> <span class="mi">1</span><span class="p">)</span> <span class="o">=</span> <span class="n">svm</span><span class="p">(</span><span class="n">ie</span> <span class="o">+</span> <span class="mi">1</span> <span class="o">-</span> <span class="n">m</span><span class="p">,</span> <span class="p">:,</span> <span class="p">:,</span> <span class="n">n</span><span class="p">)</span>
<a name="ln-376"></a>               <span class="n">svm</span><span class="p">(</span><span class="n">ie</span> <span class="o">+</span> <span class="n">m</span><span class="p">,</span> <span class="p">:,</span> <span class="p">:,</span> <span class="n">n</span><span class="p">)</span> <span class="o">=</span> <span class="n">svm</span><span class="p">(</span><span class="n">ib</span> <span class="o">-</span> <span class="mi">1</span> <span class="o">+</span> <span class="n">m</span><span class="p">,</span> <span class="p">:,</span> <span class="p">:,</span> <span class="n">n</span> <span class="o">+</span> <span class="mi">1</span><span class="p">)</span>
<a name="ln-377"></a>            <span class="k">end do</span>
<a name="ln-378"></a>
<a name="ln-379"></a>            <span class="c">! zero conc. on scalar 1 !tg3315 should be changed to as above in</span>
<a name="ln-380"></a>            <span class="n">sv0</span><span class="p">(</span><span class="n">ib</span> <span class="o">-</span> <span class="n">m</span><span class="p">,</span> <span class="p">:,</span> <span class="p">:,</span> <span class="mi">1</span><span class="p">)</span> <span class="o">=</span> <span class="mf">0.</span>
<a name="ln-381"></a>            <span class="n">svm</span><span class="p">(</span><span class="n">ib</span> <span class="o">-</span> <span class="n">m</span><span class="p">,</span> <span class="p">:,</span> <span class="p">:,</span> <span class="mi">1</span><span class="p">)</span> <span class="o">=</span> <span class="mf">0.</span>
<a name="ln-382"></a>
<a name="ln-383"></a>            <span class="c">! DIY outflow BC (advection step as linout) tg3315</span>
<a name="ln-384"></a>          <span class="n">sv0</span><span class="p">(</span><span class="n">ie</span><span class="o">+</span><span class="n">m</span><span class="p">,:,:,</span><span class="n">nsv</span><span class="p">)</span><span class="o">=</span><span class="n">sv0</span><span class="p">(</span><span class="n">ie</span><span class="o">+</span><span class="mi">1</span><span class="o">-</span><span class="n">m</span><span class="p">,:,:,</span><span class="n">nsv</span><span class="p">)</span><span class="o">-</span><span class="p">(</span><span class="n">sv0</span><span class="p">(</span><span class="n">ie</span><span class="o">+</span><span class="n">m</span><span class="p">,:,:,</span><span class="n">nsv</span><span class="p">)</span><span class="o">-</span><span class="n">sv0</span><span class="p">(</span><span class="n">ie</span><span class="o">+</span><span class="mi">1</span><span class="o">-</span><span class="n">m</span><span class="p">,:,:,</span><span class="n">nsv</span><span class="p">))</span><span class="o">*</span><span class="n">dxhi</span><span class="p">(</span><span class="n">ie</span><span class="o">+</span><span class="n">m</span><span class="p">)</span><span class="o">*</span><span class="n">rk3coef</span><span class="o">*</span><span class="n">uouttot</span>
<a name="ln-385"></a>          <span class="n">svm</span><span class="p">(</span><span class="n">ie</span><span class="o">+</span><span class="n">m</span><span class="p">,:,:,</span><span class="n">nsv</span><span class="p">)</span><span class="o">=</span><span class="n">svm</span><span class="p">(</span><span class="n">ie</span><span class="o">+</span><span class="mi">1</span><span class="o">-</span><span class="n">m</span><span class="p">,:,:,</span><span class="n">nsv</span><span class="p">)</span><span class="o">-</span><span class="p">(</span><span class="n">svm</span><span class="p">(</span><span class="n">ie</span><span class="o">+</span><span class="n">m</span><span class="p">,:,:,</span><span class="n">nsv</span><span class="p">)</span><span class="o">-</span><span class="n">svm</span><span class="p">(</span><span class="n">ie</span><span class="o">+</span><span class="mi">1</span><span class="o">-</span><span class="n">m</span><span class="p">,:,:,</span><span class="n">nsv</span><span class="p">))</span><span class="o">*</span><span class="n">dxhi</span><span class="p">(</span><span class="n">ie</span><span class="o">+</span><span class="n">m</span><span class="p">)</span><span class="o">*</span><span class="n">rk3coef</span><span class="o">*</span><span class="n">uouttot</span>
<a name="ln-386"></a>         <span class="k">end do</span>
<a name="ln-387"></a><span class="k">      end if</span>
<a name="ln-388"></a><span class="k">      return</span>
<a name="ln-389"></a><span class="k">   end subroutine </span><span class="n">scalrec</span>
<a name="ln-390"></a>
<a name="ln-391"></a>   <span class="k">subroutine </span><span class="n">scalSIRANE</span>
<a name="ln-392"></a>    <span class="k">use </span><span class="n">modglobal</span><span class="p">,</span> <span class="n">only</span> <span class="p">:</span> <span class="n">ib</span><span class="p">,</span><span class="n">ie</span><span class="p">,</span><span class="n">jb</span><span class="p">,</span><span class="n">je</span><span class="p">,</span><span class="n">ih</span><span class="p">,</span><span class="n">jh</span><span class="p">,</span><span class="n">kb</span><span class="p">,</span><span class="n">ke</span><span class="p">,</span><span class="n">kh</span><span class="p">,</span><span class="n">nsv</span><span class="p">,</span><span class="n">dt</span><span class="p">,</span><span class="n">lscalrec</span><span class="p">,</span><span class="n">lmoistinout</span><span class="p">,</span><span class="n">ltempinout</span><span class="p">,</span><span class="n">rk3step</span><span class="p">,</span><span class="n">dxhi</span><span class="p">,</span><span class="n">ltempeq</span><span class="p">,&amp;</span>
<a name="ln-393"></a>         <span class="n">ihc</span><span class="p">,</span> <span class="n">jhc</span><span class="p">,</span> <span class="n">khc</span><span class="p">,</span> <span class="n">lSIRANEinout</span><span class="p">,</span> <span class="n">dy</span>
<a name="ln-394"></a>      <span class="k">use </span><span class="n">modfields</span><span class="p">,</span> <span class="n">only</span><span class="p">:</span><span class="n">sv0</span><span class="p">,</span> <span class="n">svm</span><span class="p">,</span> <span class="n">svprof</span>
<a name="ln-395"></a>      <span class="k">use </span><span class="n">modinletdata</span><span class="p">,</span> <span class="n">only</span><span class="p">:</span><span class="n">ubulk</span>
<a name="ln-396"></a>      <span class="k">use </span><span class="n">modmpi</span><span class="p">,</span> <span class="n">only</span><span class="p">:</span><span class="n">myid</span><span class="p">,</span> <span class="n">nprocs</span>
<a name="ln-397"></a>      <span class="kt">real </span><span class="n">rk3coef</span>
<a name="ln-398"></a>      <span class="kt">integer </span><span class="n">k</span><span class="p">,</span> <span class="n">n</span><span class="p">,</span> <span class="n">m</span>
<a name="ln-399"></a>      <span class="k">if</span> <span class="p">(</span><span class="n">nsv</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">)</span> <span class="k">then</span>
<a name="ln-400"></a>         <span class="c">!rk3coef = dt / (4. - dble(rk3step))</span>
<a name="ln-401"></a>         <span class="k">do </span><span class="n">n</span> <span class="o">=</span> <span class="mi">1</span><span class="p">,</span> <span class="n">nsv</span>
<a name="ln-402"></a>            <span class="k">do </span><span class="n">m</span> <span class="o">=</span> <span class="mi">1</span><span class="p">,</span> <span class="n">ihc</span>
<a name="ln-403"></a>               <span class="k">do </span><span class="n">k</span> <span class="o">=</span> <span class="n">kb</span><span class="p">,</span> <span class="n">ke</span> <span class="o">+</span> <span class="mi">1</span>
<a name="ln-404"></a>                  <span class="n">sv0</span><span class="p">(</span><span class="n">ib</span> <span class="o">-</span> <span class="n">m</span><span class="p">,</span> <span class="p">:,</span> <span class="n">k</span><span class="p">,</span> <span class="n">n</span><span class="p">)</span> <span class="o">=</span> <span class="mi">2</span><span class="o">*</span><span class="n">svprof</span><span class="p">(</span><span class="n">k</span><span class="p">,</span> <span class="n">n</span><span class="p">)</span> <span class="o">-</span> <span class="n">sv0</span><span class="p">(</span><span class="n">ib</span> <span class="o">-</span> <span class="n">m</span> <span class="o">+</span> <span class="mi">1</span><span class="p">,</span> <span class="p">:,</span> <span class="n">k</span><span class="p">,</span> <span class="n">n</span><span class="p">)</span> <span class="c">!scalars have two ghost cells...???</span>
<a name="ln-405"></a>                  <span class="n">svm</span><span class="p">(</span><span class="n">ib</span> <span class="o">-</span> <span class="n">m</span><span class="p">,</span> <span class="p">:,</span> <span class="n">k</span><span class="p">,</span> <span class="n">n</span><span class="p">)</span> <span class="o">=</span> <span class="mi">2</span><span class="o">*</span><span class="n">svprof</span><span class="p">(</span><span class="n">k</span><span class="p">,</span> <span class="n">n</span><span class="p">)</span> <span class="o">-</span> <span class="n">svm</span><span class="p">(</span><span class="n">ib</span> <span class="o">-</span> <span class="n">m</span> <span class="o">+</span> <span class="mi">1</span><span class="p">,</span> <span class="p">:,</span> <span class="n">k</span><span class="p">,</span> <span class="n">n</span><span class="p">)</span>
<a name="ln-406"></a>               <span class="k">end do</span>
<a name="ln-407"></a><span class="c">!              sv0(ie+m,:,:,n)= sv0(ie+m-1,:,:,n) - (sv0(ie+m,:,:,n)-sv0(ie+m-1,:,:,n))*dxhi(ie+m)*rk3coef*ubulk</span>
<a name="ln-408"></a><span class="c">!              svm(ie+m,:,:,n)= svm(ie+m-1,:,:,n) - (svm(ie+m,:,:,n)-svm(ie+m-1,:,:,n))*dxhi(ie+m)*rk3coef*ubulk !changed from uouttot to ubulk here !tg3315 08/11/2017</span>
<a name="ln-409"></a><span class="c">!              sv0(ie+m,:,:,n)= sv0(ie+m-1,:,:,n) - (sv0(ie+m,:,:,n)-sv0(ie+m-1,:,:,n))*dxhi(ie+m)*rk3coef*u0(ie+m,:,:)</span>
<a name="ln-410"></a><span class="c">!              svm(ie+m,:,:,n)= svm(ie+m-1,:,:,n) - (svm(ie+m,:,:,n)-svm(ie+m-1,:,:,n))*dxhi(ie+m)*rk3coef*um(ie+m,:,:) !changed from uouttot to ubulk here !tg3315 08/11/2017</span>
<a name="ln-411"></a>               <span class="n">svm</span><span class="p">(</span><span class="n">ie</span> <span class="o">+</span> <span class="n">m</span><span class="p">,</span> <span class="p">:,</span> <span class="p">:,</span> <span class="n">n</span><span class="p">)</span> <span class="o">=</span> <span class="n">svm</span><span class="p">(</span><span class="n">ie</span> <span class="o">+</span> <span class="n">m</span> <span class="o">-</span> <span class="mi">1</span><span class="p">,</span> <span class="p">:,</span> <span class="p">:,</span> <span class="n">n</span><span class="p">)</span>
<a name="ln-412"></a>               <span class="n">sv0</span><span class="p">(</span><span class="n">ie</span> <span class="o">+</span> <span class="n">m</span><span class="p">,</span> <span class="p">:,</span> <span class="p">:,</span> <span class="n">n</span><span class="p">)</span> <span class="o">=</span> <span class="n">sv0</span><span class="p">(</span><span class="n">ie</span> <span class="o">+</span> <span class="n">m</span> <span class="o">-</span> <span class="mi">1</span><span class="p">,</span> <span class="p">:,</span> <span class="p">:,</span> <span class="n">n</span><span class="p">)</span>
<a name="ln-413"></a>            <span class="k">end do</span> <span class="c">!m, ihc</span>
<a name="ln-414"></a>         <span class="k">end do</span> <span class="c">!n, nsv</span>
<a name="ln-415"></a>
<a name="ln-416"></a>         <span class="k">do </span><span class="n">m</span> <span class="o">=</span> <span class="mi">1</span><span class="p">,</span> <span class="n">jhc</span>
<a name="ln-417"></a>            <span class="k">do </span><span class="n">n</span> <span class="o">=</span> <span class="mi">1</span><span class="p">,</span> <span class="n">nsv</span>
<a name="ln-418"></a>            <span class="k">if</span> <span class="p">(</span><span class="n">myid</span> <span class="o">==</span> <span class="mi">0</span><span class="p">)</span> <span class="k">then</span>
<a name="ln-419"></a><span class="k">               do </span><span class="n">k</span> <span class="o">=</span> <span class="n">kb</span><span class="p">,</span> <span class="n">ke</span> <span class="o">+</span> <span class="mi">1</span>
<a name="ln-420"></a>                  <span class="n">sv0</span><span class="p">(:,</span> <span class="n">jb</span> <span class="o">-</span> <span class="n">m</span><span class="p">,</span> <span class="n">k</span><span class="p">,</span> <span class="n">n</span><span class="p">)</span> <span class="o">=</span> <span class="mi">2</span><span class="o">*</span><span class="n">svprof</span><span class="p">(</span><span class="n">k</span><span class="p">,</span> <span class="n">n</span><span class="p">)</span> <span class="o">-</span> <span class="n">sv0</span><span class="p">(:,</span> <span class="n">jb</span> <span class="o">-</span> <span class="n">m</span> <span class="o">+</span> <span class="mi">1</span><span class="p">,</span> <span class="n">k</span><span class="p">,</span> <span class="n">n</span><span class="p">)</span>
<a name="ln-421"></a>                  <span class="n">svm</span><span class="p">(:,</span> <span class="n">jb</span> <span class="o">-</span> <span class="n">m</span><span class="p">,</span> <span class="n">k</span><span class="p">,</span> <span class="n">n</span><span class="p">)</span> <span class="o">=</span> <span class="mi">2</span><span class="o">*</span><span class="n">svprof</span><span class="p">(</span><span class="n">k</span><span class="p">,</span> <span class="n">n</span><span class="p">)</span> <span class="o">-</span> <span class="n">svm</span><span class="p">(:,</span> <span class="n">jb</span> <span class="o">-</span> <span class="n">m</span> <span class="o">+</span> <span class="mi">1</span><span class="p">,</span> <span class="n">k</span><span class="p">,</span> <span class="n">n</span><span class="p">)</span>
<a name="ln-422"></a>               <span class="k">end do</span>
<a name="ln-423"></a><span class="k">            end if</span>
<a name="ln-424"></a><span class="k">            if</span> <span class="p">(</span><span class="n">myid</span> <span class="o">==</span> <span class="n">nprocs</span> <span class="o">-</span> <span class="mi">1</span><span class="p">)</span> <span class="k">then</span>
<a name="ln-425"></a>               <span class="c">!sv0(:,je+m,:,n)= sv0(:,je+m-1,:,n) - (sv0(:,je+m,:,n)-sv0(:,je+m-1,:,n))*dy*rk3coef*ubulk</span>
<a name="ln-426"></a>               <span class="c">!svm(:,je+m,:,n)= svm(:,je+m-1,:,n) - (svm(:,je+m,:,n)-svm(:,je+m-1,:,n))*dy*rk3coef*ubulk !changed from uouttot to ubulk here !tg3315 08/11/2017</span>
<a name="ln-427"></a>               <span class="c">!      sv0(:,je+m,:,n)= sv0(:,je+m-1,:,n) - (sv0(:,je+m,:,n)-sv0(:,je+m-1,:,n))*dy*rk3coef*v0(:,je+m,:)</span>
<a name="ln-428"></a>               <span class="c">!      svm(:,je+m,:,n)= svm(:,je+m-1,:,n) - (svm(:,je+m,:,n)-svm(:,je+m-1,:,n))*dy*rk3coef*vm(:,je+m,:) !changed from uouttot to ubulk here !tg3315 08/11/2017</span>
<a name="ln-429"></a>               <span class="n">svm</span><span class="p">(:,</span> <span class="n">je</span> <span class="o">+</span> <span class="n">m</span><span class="p">,</span> <span class="p">:,</span> <span class="n">n</span><span class="p">)</span> <span class="o">=</span> <span class="n">svm</span><span class="p">(:,</span> <span class="n">je</span> <span class="o">+</span> <span class="n">m</span> <span class="o">-</span> <span class="mi">1</span><span class="p">,</span> <span class="p">:,</span> <span class="n">n</span><span class="p">)</span>
<a name="ln-430"></a>               <span class="n">sv0</span><span class="p">(:,</span> <span class="n">je</span> <span class="o">+</span> <span class="n">m</span><span class="p">,</span> <span class="p">:,</span> <span class="n">n</span><span class="p">)</span> <span class="o">=</span> <span class="n">sv0</span><span class="p">(:,</span> <span class="n">je</span> <span class="o">+</span> <span class="n">m</span> <span class="o">-</span> <span class="mi">1</span><span class="p">,</span> <span class="p">:,</span> <span class="n">n</span><span class="p">)</span>
<a name="ln-431"></a>            <span class="k">end if</span>
<a name="ln-432"></a><span class="k">            end do</span> <span class="c">!n, nsv</span>
<a name="ln-433"></a>         <span class="k">end do</span> <span class="c">!m, jhc</span>
<a name="ln-434"></a>
<a name="ln-435"></a>      <span class="k">end if</span> <span class="c">!nsv&gt;0</span>
<a name="ln-436"></a>      <span class="k">return</span>
<a name="ln-437"></a><span class="k">   end subroutine </span><span class="n">scalSIRANE</span>
<a name="ln-438"></a>
<a name="ln-439"></a>   <span class="c">!!!!!!!!!!! x/i periodic BC for scalars!!!!!!!!!!!</span>
<a name="ln-440"></a>   <span class="c">!&gt; Sets x/i periodic boundary conditions for the temperature</span>
<a name="ln-441"></a>   <span class="k">subroutine </span><span class="n">cyclichi</span>
<a name="ln-442"></a>      <span class="k">use </span><span class="n">modglobal</span><span class="p">,</span> <span class="n">only</span><span class="p">:</span><span class="n">ib</span><span class="p">,</span> <span class="n">ie</span><span class="p">,</span> <span class="n">jb</span><span class="p">,</span> <span class="n">je</span><span class="p">,</span> <span class="n">ih</span><span class="p">,</span> <span class="n">jh</span><span class="p">,</span> <span class="n">kb</span><span class="p">,</span> <span class="n">ke</span><span class="p">,</span> <span class="n">kh</span><span class="p">,</span> <span class="n">nsv</span><span class="p">,</span> <span class="n">dt</span><span class="p">,</span> <span class="n">rk3step</span><span class="p">,</span> <span class="n">dxhi</span><span class="p">,</span> <span class="n">ihc</span><span class="p">,</span> <span class="n">jhc</span><span class="p">,</span> <span class="n">khc</span><span class="p">,</span> <span class="n">dy</span>
<a name="ln-443"></a>      <span class="k">use </span><span class="n">modfields</span><span class="p">,</span> <span class="n">only</span><span class="p">:</span><span class="n">thl0</span><span class="p">,</span> <span class="n">thlm</span>
<a name="ln-444"></a>      <span class="kt">integer </span><span class="n">m</span>
<a name="ln-445"></a>
<a name="ln-446"></a>      <span class="k">do </span><span class="n">m</span> <span class="o">=</span> <span class="mi">1</span><span class="p">,</span> <span class="n">ih</span>
<a name="ln-447"></a>         <span class="n">thl0</span><span class="p">(</span><span class="n">ib</span> <span class="o">-</span> <span class="n">m</span><span class="p">,</span> <span class="p">:,</span> <span class="p">:)</span> <span class="o">=</span> <span class="n">thl0</span><span class="p">(</span><span class="n">ie</span> <span class="o">+</span> <span class="mi">1</span> <span class="o">-</span> <span class="n">m</span><span class="p">,</span> <span class="p">:,</span> <span class="p">:)</span>
<a name="ln-448"></a>         <span class="n">thl0</span><span class="p">(</span><span class="n">ie</span> <span class="o">+</span> <span class="n">m</span><span class="p">,</span> <span class="p">:,</span> <span class="p">:)</span> <span class="o">=</span> <span class="n">thl0</span><span class="p">(</span><span class="n">ib</span> <span class="o">-</span> <span class="mi">1</span> <span class="o">+</span> <span class="n">m</span><span class="p">,</span> <span class="p">:,</span> <span class="p">:)</span>
<a name="ln-449"></a>         <span class="n">thlm</span><span class="p">(</span><span class="n">ib</span> <span class="o">-</span> <span class="n">m</span><span class="p">,</span> <span class="p">:,</span> <span class="p">:)</span> <span class="o">=</span> <span class="n">thlm</span><span class="p">(</span><span class="n">ie</span> <span class="o">+</span> <span class="mi">1</span> <span class="o">-</span> <span class="n">m</span><span class="p">,</span> <span class="p">:,</span> <span class="p">:)</span>
<a name="ln-450"></a>         <span class="n">thlm</span><span class="p">(</span><span class="n">ie</span> <span class="o">+</span> <span class="n">m</span><span class="p">,</span> <span class="p">:,</span> <span class="p">:)</span> <span class="o">=</span> <span class="n">thlm</span><span class="p">(</span><span class="n">ib</span> <span class="o">-</span> <span class="mi">1</span> <span class="o">+</span> <span class="n">m</span><span class="p">,</span> <span class="p">:,</span> <span class="p">:)</span>
<a name="ln-451"></a>      <span class="k">end do</span>
<a name="ln-452"></a>
<a name="ln-453"></a><span class="k">      return</span>
<a name="ln-454"></a><span class="k">   end subroutine </span><span class="n">cyclichi</span>
<a name="ln-455"></a>
<a name="ln-456"></a>   <span class="c">!&gt; Sets x/i periodic boundary conditions for the humidity</span>
<a name="ln-457"></a>   <span class="k">subroutine </span><span class="n">cyclicqi</span>
<a name="ln-458"></a>      <span class="k">use </span><span class="n">modglobal</span><span class="p">,</span> <span class="n">only</span><span class="p">:</span><span class="n">ib</span><span class="p">,</span> <span class="n">ie</span><span class="p">,</span> <span class="n">jb</span><span class="p">,</span> <span class="n">je</span><span class="p">,</span> <span class="n">ih</span><span class="p">,</span> <span class="n">jh</span><span class="p">,</span> <span class="n">kb</span><span class="p">,</span> <span class="n">ke</span><span class="p">,</span> <span class="n">kh</span><span class="p">,</span> <span class="n">nsv</span><span class="p">,</span> <span class="n">dt</span><span class="p">,</span> <span class="n">rk3step</span><span class="p">,</span> <span class="n">dxhi</span><span class="p">,</span> <span class="n">ihc</span><span class="p">,</span> <span class="n">jhc</span><span class="p">,</span> <span class="n">khc</span><span class="p">,</span> <span class="n">dy</span>
<a name="ln-459"></a>      <span class="k">use </span><span class="n">modfields</span><span class="p">,</span> <span class="n">only</span><span class="p">:</span><span class="n">qt0</span><span class="p">,</span> <span class="n">qtm</span>
<a name="ln-460"></a>      <span class="kt">integer </span><span class="n">m</span>
<a name="ln-461"></a>
<a name="ln-462"></a>      <span class="k">do </span><span class="n">m</span> <span class="o">=</span> <span class="mi">1</span><span class="p">,</span> <span class="n">ih</span>
<a name="ln-463"></a>         <span class="n">qt0</span><span class="p">(</span><span class="n">ib</span> <span class="o">-</span> <span class="n">m</span><span class="p">,</span> <span class="p">:,</span> <span class="p">:)</span> <span class="o">=</span> <span class="n">qt0</span><span class="p">(</span><span class="n">ie</span> <span class="o">+</span> <span class="mi">1</span> <span class="o">-</span> <span class="n">m</span><span class="p">,</span> <span class="p">:,</span> <span class="p">:)</span>
<a name="ln-464"></a>         <span class="n">qt0</span><span class="p">(</span><span class="n">ie</span> <span class="o">+</span> <span class="n">m</span><span class="p">,</span> <span class="p">:,</span> <span class="p">:)</span> <span class="o">=</span> <span class="n">qt0</span><span class="p">(</span><span class="n">ib</span> <span class="o">-</span> <span class="mi">1</span> <span class="o">+</span> <span class="n">m</span><span class="p">,</span> <span class="p">:,</span> <span class="p">:)</span>
<a name="ln-465"></a>         <span class="n">qtm</span><span class="p">(</span><span class="n">ib</span> <span class="o">-</span> <span class="n">m</span><span class="p">,</span> <span class="p">:,</span> <span class="p">:)</span> <span class="o">=</span> <span class="n">qtm</span><span class="p">(</span><span class="n">ie</span> <span class="o">+</span> <span class="mi">1</span> <span class="o">-</span> <span class="n">m</span><span class="p">,</span> <span class="p">:,</span> <span class="p">:)</span>
<a name="ln-466"></a>         <span class="n">qtm</span><span class="p">(</span><span class="n">ie</span> <span class="o">+</span> <span class="n">m</span><span class="p">,</span> <span class="p">:,</span> <span class="p">:)</span> <span class="o">=</span> <span class="n">qtm</span><span class="p">(</span><span class="n">ib</span> <span class="o">-</span> <span class="mi">1</span> <span class="o">+</span> <span class="n">m</span><span class="p">,</span> <span class="p">:,</span> <span class="p">:)</span>
<a name="ln-467"></a>      <span class="k">end do</span>
<a name="ln-468"></a>
<a name="ln-469"></a><span class="k">      return</span>
<a name="ln-470"></a><span class="k">   end subroutine </span><span class="n">cyclicqi</span>
<a name="ln-471"></a>
<a name="ln-472"></a>   <span class="c">!&gt; Sets x/iperiodic boundary conditions for the scalars</span>
<a name="ln-473"></a>   <span class="k">subroutine </span><span class="n">cyclicsi</span>
<a name="ln-474"></a>      <span class="k">use </span><span class="n">modglobal</span><span class="p">,</span> <span class="n">only</span><span class="p">:</span><span class="n">ib</span><span class="p">,</span> <span class="n">ie</span><span class="p">,</span> <span class="n">jb</span><span class="p">,</span> <span class="n">je</span><span class="p">,</span> <span class="n">ih</span><span class="p">,</span> <span class="n">jh</span><span class="p">,</span> <span class="n">kb</span><span class="p">,</span> <span class="n">ke</span><span class="p">,</span> <span class="n">kh</span><span class="p">,</span> <span class="n">nsv</span><span class="p">,</span> <span class="n">dt</span><span class="p">,</span> <span class="n">rk3step</span><span class="p">,</span> <span class="n">dxhi</span><span class="p">,</span> <span class="n">ihc</span><span class="p">,</span> <span class="n">jhc</span><span class="p">,</span> <span class="n">khc</span><span class="p">,</span> <span class="n">dy</span>
<a name="ln-475"></a>      <span class="k">use </span><span class="n">modfields</span><span class="p">,</span> <span class="n">only</span><span class="p">:</span><span class="n">sv0</span><span class="p">,</span> <span class="n">svm</span>
<a name="ln-476"></a>      <span class="kt">integer </span><span class="n">m</span>
<a name="ln-477"></a>
<a name="ln-478"></a>      <span class="k">do </span><span class="n">m</span> <span class="o">=</span> <span class="mi">1</span><span class="p">,</span> <span class="n">ihc</span>
<a name="ln-479"></a>         <span class="n">sv0</span><span class="p">(</span><span class="n">ib</span> <span class="o">-</span> <span class="n">m</span><span class="p">,</span> <span class="p">:,</span> <span class="p">:,</span> <span class="p">:)</span> <span class="o">=</span> <span class="n">sv0</span><span class="p">(</span><span class="n">ie</span> <span class="o">+</span> <span class="mi">1</span> <span class="o">-</span> <span class="n">m</span><span class="p">,</span> <span class="p">:,</span> <span class="p">:,</span> <span class="p">:)</span>
<a name="ln-480"></a>         <span class="n">sv0</span><span class="p">(</span><span class="n">ie</span> <span class="o">+</span> <span class="n">m</span><span class="p">,</span> <span class="p">:,</span> <span class="p">:,</span> <span class="p">:)</span> <span class="o">=</span> <span class="n">sv0</span><span class="p">(</span><span class="n">ib</span> <span class="o">-</span> <span class="mi">1</span> <span class="o">+</span> <span class="n">m</span><span class="p">,</span> <span class="p">:,</span> <span class="p">:,</span> <span class="p">:)</span>
<a name="ln-481"></a>         <span class="n">svm</span><span class="p">(</span><span class="n">ib</span> <span class="o">-</span> <span class="n">m</span><span class="p">,</span> <span class="p">:,</span> <span class="p">:,</span> <span class="p">:)</span> <span class="o">=</span> <span class="n">svm</span><span class="p">(</span><span class="n">ie</span> <span class="o">+</span> <span class="mi">1</span> <span class="o">-</span> <span class="n">m</span><span class="p">,</span> <span class="p">:,</span> <span class="p">:,</span> <span class="p">:)</span>
<a name="ln-482"></a>         <span class="n">svm</span><span class="p">(</span><span class="n">ie</span> <span class="o">+</span> <span class="n">m</span><span class="p">,</span> <span class="p">:,</span> <span class="p">:,</span> <span class="p">:)</span> <span class="o">=</span> <span class="n">svm</span><span class="p">(</span><span class="n">ib</span> <span class="o">-</span> <span class="mi">1</span> <span class="o">+</span> <span class="n">m</span><span class="p">,</span> <span class="p">:,</span> <span class="p">:,</span> <span class="p">:)</span>
<a name="ln-483"></a>      <span class="k">end do</span>
<a name="ln-484"></a>
<a name="ln-485"></a><span class="k">      return</span>
<a name="ln-486"></a><span class="k">   end subroutine </span><span class="n">cyclicsi</span>
<a name="ln-487"></a>   <span class="c">!!!!!!!!!!!end x/i periodic BC for scalars!!!!!!!!</span>
<a name="ln-488"></a>
<a name="ln-489"></a>   <span class="c">!&gt; Sets x/inlet-outlet boundary conditions for moisture</span>
<a name="ln-490"></a>   <span class="k">subroutine </span><span class="n">ioqi</span>
<a name="ln-491"></a>     <span class="k">use </span><span class="n">modglobal</span><span class="p">,</span> <span class="n">only</span><span class="p">:</span> <span class="n">ib</span><span class="p">,</span> <span class="n">ie</span><span class="p">,</span> <span class="n">jb</span><span class="p">,</span> <span class="n">je</span><span class="p">,</span> <span class="n">ih</span><span class="p">,</span> <span class="n">jh</span><span class="p">,</span> <span class="n">kb</span><span class="p">,</span> <span class="n">ke</span><span class="p">,</span> <span class="n">kh</span><span class="p">,</span> <span class="n">dxhi</span><span class="p">,</span> <span class="n">rk3step</span><span class="p">,</span> <span class="n">dt</span>
<a name="ln-492"></a>     <span class="k">use </span><span class="n">modfields</span><span class="p">,</span> <span class="n">only</span><span class="p">:</span> <span class="n">qt0</span><span class="p">,</span> <span class="n">qtm</span><span class="p">,</span> <span class="n">qtprof</span><span class="p">,</span> <span class="n">uouttot</span>
<a name="ln-493"></a>     <span class="k">use </span><span class="n">modinletdata</span><span class="p">,</span> <span class="n">only</span><span class="p">:</span> <span class="n">ubulk</span>
<a name="ln-494"></a>     <span class="kt">integer </span><span class="n">k</span><span class="p">,</span><span class="n">j</span>
<a name="ln-495"></a>     <span class="kt">real </span><span class="n">rk3coef</span>                                                                                   
<a name="ln-496"></a>
<a name="ln-497"></a>     <span class="n">rk3coef</span> <span class="o">=</span> <span class="n">dt</span><span class="o">/</span><span class="p">(</span><span class="mf">4.</span><span class="o">-</span><span class="nb">dble</span><span class="p">(</span><span class="n">rk3step</span><span class="p">))</span>
<a name="ln-498"></a>
<a name="ln-499"></a>     <span class="k">do </span><span class="n">k</span> <span class="o">=</span> <span class="n">kb</span><span class="p">,</span> <span class="n">ke</span>
<a name="ln-500"></a>       <span class="k">do </span><span class="n">j</span> <span class="o">=</span> <span class="n">jb</span><span class="p">,</span> <span class="n">je</span>
<a name="ln-501"></a>         <span class="n">qt0</span><span class="p">(</span><span class="n">ib</span> <span class="o">-</span> <span class="mi">1</span><span class="p">,</span> <span class="n">j</span><span class="p">,</span> <span class="n">k</span><span class="p">)</span> <span class="o">=</span> <span class="mi">2</span><span class="o">*</span><span class="n">qtprof</span><span class="p">(</span><span class="n">k</span><span class="p">)</span> <span class="o">-</span> <span class="n">qt0</span><span class="p">(</span><span class="n">ib</span><span class="p">,</span> <span class="n">j</span><span class="p">,</span> <span class="n">k</span><span class="p">)</span> <span class="c">!watch!</span>
<a name="ln-502"></a>         <span class="n">qtm</span><span class="p">(</span><span class="n">ib</span> <span class="o">-</span> <span class="mi">1</span><span class="p">,</span> <span class="n">j</span><span class="p">,</span> <span class="n">k</span><span class="p">)</span> <span class="o">=</span> <span class="mi">2</span><span class="o">*</span><span class="n">qtprof</span><span class="p">(</span><span class="n">k</span><span class="p">)</span> <span class="o">-</span> <span class="n">qtm</span><span class="p">(</span><span class="n">ib</span><span class="p">,</span> <span class="n">j</span><span class="p">,</span> <span class="n">k</span><span class="p">)</span>
<a name="ln-503"></a>       <span class="k">end do</span>
<a name="ln-504"></a><span class="k">    end do</span>
<a name="ln-505"></a>    
<a name="ln-506"></a>    <span class="c">!uouttot is zero unless lmassflowr </span>
<a name="ln-507"></a>    <span class="n">qt0</span><span class="p">(</span><span class="n">ie</span> <span class="o">+</span> <span class="mi">1</span><span class="p">,</span> <span class="p">:,</span> <span class="p">:)</span> <span class="o">=</span> <span class="n">qt0</span><span class="p">(</span><span class="n">ie</span><span class="p">,</span> <span class="p">:,</span> <span class="p">:)</span> <span class="o">-</span> <span class="p">(</span><span class="n">qt0</span><span class="p">(</span><span class="n">ie</span> <span class="o">+</span> <span class="mi">1</span><span class="p">,</span> <span class="p">:,</span> <span class="p">:)</span> <span class="o">-</span> <span class="n">qt0</span><span class="p">(</span><span class="n">ie</span><span class="p">,</span> <span class="p">:,</span> <span class="p">:))</span><span class="o">*</span><span class="n">dxhi</span><span class="p">(</span><span class="n">ie</span> <span class="o">+</span> <span class="mi">1</span><span class="p">)</span><span class="o">*</span><span class="n">rk3coef</span><span class="o">*</span><span class="n">uouttot</span> <span class="c">! tg3315 should be uouttot and will have to change depending on forcing</span>
<a name="ln-508"></a>    <span class="n">qtm</span><span class="p">(</span><span class="n">ie</span> <span class="o">+</span> <span class="mi">1</span><span class="p">,</span> <span class="p">:,</span> <span class="p">:)</span> <span class="o">=</span> <span class="n">qtm</span><span class="p">(</span><span class="n">ie</span><span class="p">,</span> <span class="p">:,</span> <span class="p">:)</span> <span class="o">-</span> <span class="p">(</span><span class="n">qtm</span><span class="p">(</span><span class="n">ie</span> <span class="o">+</span> <span class="mi">1</span><span class="p">,</span> <span class="p">:,</span> <span class="p">:)</span> <span class="o">-</span> <span class="n">qtm</span><span class="p">(</span><span class="n">ie</span><span class="p">,</span> <span class="p">:,</span> <span class="p">:))</span><span class="o">*</span><span class="n">dxhi</span><span class="p">(</span><span class="n">ie</span> <span class="o">+</span> <span class="mi">1</span><span class="p">)</span><span class="o">*</span><span class="n">rk3coef</span><span class="o">*</span><span class="n">uouttot</span>
<a name="ln-509"></a>
<a name="ln-510"></a>   <span class="k">end subroutine </span><span class="n">ioqi</span>
<a name="ln-511"></a>   
<a name="ln-512"></a>   <span class="c">!&gt; Sets x/in;et-outlet boundary conditions for temperature</span>
<a name="ln-513"></a>   <span class="k">subroutine </span><span class="n">iohi</span>
<a name="ln-514"></a>     <span class="k">use </span><span class="n">modglobal</span><span class="p">,</span> <span class="n">only</span><span class="p">:</span> <span class="n">ib</span><span class="p">,</span> <span class="n">ie</span><span class="p">,</span> <span class="n">jb</span><span class="p">,</span> <span class="n">je</span><span class="p">,</span> <span class="n">ih</span><span class="p">,</span> <span class="n">jh</span><span class="p">,</span> <span class="n">kb</span><span class="p">,</span> <span class="n">ke</span><span class="p">,</span> <span class="n">kh</span><span class="p">,</span> <span class="n">dxhi</span><span class="p">,</span> <span class="n">rk3step</span><span class="p">,</span> <span class="n">dt</span>
<a name="ln-515"></a>     <span class="k">use </span><span class="n">modfields</span><span class="p">,</span> <span class="n">only</span><span class="p">:</span> <span class="n">thl0</span><span class="p">,</span> <span class="n">thlm</span><span class="p">,</span> <span class="n">thlprof</span><span class="p">,</span> <span class="n">uouttot</span>
<a name="ln-516"></a>     <span class="k">use </span><span class="n">modinletdata</span><span class="p">,</span> <span class="n">only</span><span class="p">:</span> <span class="n">ubulk</span>
<a name="ln-517"></a>     <span class="kt">integer </span><span class="n">k</span><span class="p">,</span><span class="n">j</span>   
<a name="ln-518"></a>     <span class="kt">real </span><span class="n">rk3coef</span>                                                                                  
<a name="ln-519"></a>
<a name="ln-520"></a>     <span class="n">rk3coef</span> <span class="o">=</span> <span class="n">dt</span><span class="o">/</span><span class="p">(</span><span class="mf">4.</span><span class="o">-</span><span class="nb">dble</span><span class="p">(</span><span class="n">rk3step</span><span class="p">))</span>
<a name="ln-521"></a>
<a name="ln-522"></a>     <span class="k">do </span><span class="n">k</span> <span class="o">=</span> <span class="n">kb</span><span class="p">,</span> <span class="n">ke</span>
<a name="ln-523"></a>       <span class="k">do </span><span class="n">j</span> <span class="o">=</span> <span class="n">jb</span><span class="p">,</span> <span class="n">je</span>
<a name="ln-524"></a>         <span class="n">thl0</span><span class="p">(</span><span class="n">ib</span> <span class="o">-</span> <span class="mi">1</span><span class="p">,</span> <span class="n">j</span><span class="p">,</span> <span class="n">k</span><span class="p">)</span> <span class="o">=</span> <span class="mi">2</span><span class="o">*</span><span class="n">thlprof</span><span class="p">(</span><span class="n">k</span><span class="p">)</span> <span class="o">-</span> <span class="n">thl0</span><span class="p">(</span><span class="n">ib</span><span class="p">,</span> <span class="n">j</span><span class="p">,</span> <span class="n">k</span><span class="p">)</span> <span class="c">!watch!</span>
<a name="ln-525"></a>         <span class="n">thlm</span><span class="p">(</span><span class="n">ib</span> <span class="o">-</span> <span class="mi">1</span><span class="p">,</span> <span class="n">j</span><span class="p">,</span> <span class="n">k</span><span class="p">)</span> <span class="o">=</span> <span class="mi">2</span><span class="o">*</span><span class="n">thlprof</span><span class="p">(</span><span class="n">k</span><span class="p">)</span> <span class="o">-</span> <span class="n">thlm</span><span class="p">(</span><span class="n">ib</span><span class="p">,</span> <span class="n">j</span><span class="p">,</span> <span class="n">k</span><span class="p">)</span>
<a name="ln-526"></a>       <span class="k">end do</span>
<a name="ln-527"></a><span class="k">    end do</span>
<a name="ln-528"></a>
<a name="ln-529"></a><span class="k">    </span><span class="n">thl0</span><span class="p">(</span><span class="n">ie</span> <span class="o">+</span> <span class="mi">1</span><span class="p">,</span> <span class="p">:,</span> <span class="p">:)</span> <span class="o">=</span> <span class="n">thl0</span><span class="p">(</span><span class="n">ie</span><span class="p">,</span> <span class="p">:,</span> <span class="p">:)</span> <span class="o">-</span> <span class="p">(</span><span class="n">thl0</span><span class="p">(</span><span class="n">ie</span> <span class="o">+</span> <span class="mi">1</span><span class="p">,</span> <span class="p">:,</span> <span class="p">:)</span> <span class="o">-</span> <span class="n">thl0</span><span class="p">(</span><span class="n">ie</span><span class="p">,</span> <span class="p">:,</span> <span class="p">:))</span><span class="o">*</span><span class="n">dxhi</span><span class="p">(</span><span class="n">ie</span> <span class="o">+</span> <span class="mi">1</span><span class="p">)</span><span class="o">*</span><span class="n">rk3coef</span><span class="o">*</span><span class="n">uouttot</span> <span class="c">! tg3315 should be uouttot and will have to change depending on forcing</span>
<a name="ln-530"></a>    <span class="n">thlm</span><span class="p">(</span><span class="n">ie</span> <span class="o">+</span> <span class="mi">1</span><span class="p">,</span> <span class="p">:,</span> <span class="p">:)</span> <span class="o">=</span> <span class="n">thlm</span><span class="p">(</span><span class="n">ie</span><span class="p">,</span> <span class="p">:,</span> <span class="p">:)</span> <span class="o">-</span> <span class="p">(</span><span class="n">thlm</span><span class="p">(</span><span class="n">ie</span> <span class="o">+</span> <span class="mi">1</span><span class="p">,</span> <span class="p">:,</span> <span class="p">:)</span> <span class="o">-</span> <span class="n">thlm</span><span class="p">(</span><span class="n">ie</span><span class="p">,</span> <span class="p">:,</span> <span class="p">:))</span><span class="o">*</span><span class="n">dxhi</span><span class="p">(</span><span class="n">ie</span> <span class="o">+</span> <span class="mi">1</span><span class="p">)</span><span class="o">*</span><span class="n">rk3coef</span><span class="o">*</span><span class="n">uouttot</span>
<a name="ln-531"></a>
<a name="ln-532"></a>   <span class="k">end subroutine </span><span class="n">iohi</span>
<a name="ln-533"></a>
<a name="ln-534"></a>   <span class="c">!!!!!!!!!!! y/j periodic BC for scalars!!!!!!!!!!!</span>
<a name="ln-535"></a>   <span class="c">!&gt; Sets y/j periodic boundary conditions for the temperature</span>
<a name="ln-536"></a>   <span class="k">subroutine </span><span class="n">cyclichj</span>
<a name="ln-537"></a>      <span class="k">use </span><span class="n">modglobal</span><span class="p">,</span> <span class="n">only</span><span class="p">:</span><span class="n">ib</span><span class="p">,</span> <span class="n">ie</span><span class="p">,</span> <span class="n">jb</span><span class="p">,</span> <span class="n">je</span><span class="p">,</span> <span class="n">ih</span><span class="p">,</span> <span class="n">jh</span><span class="p">,</span> <span class="n">kb</span><span class="p">,</span> <span class="n">ke</span><span class="p">,</span> <span class="n">kh</span><span class="p">,</span> <span class="n">nsv</span><span class="p">,</span> <span class="n">dt</span><span class="p">,</span> <span class="n">rk3step</span><span class="p">,</span> <span class="n">dxhi</span><span class="p">,</span> <span class="n">ihc</span><span class="p">,</span> <span class="n">jhc</span><span class="p">,</span> <span class="n">khc</span><span class="p">,</span> <span class="n">dy</span>
<a name="ln-538"></a>      <span class="k">use </span><span class="n">modfields</span><span class="p">,</span> <span class="n">only</span><span class="p">:</span><span class="n">thl0</span><span class="p">,</span> <span class="n">thlm</span>
<a name="ln-539"></a>      <span class="k">use </span><span class="n">modmpi</span><span class="p">,</span> <span class="n">only</span><span class="p">:</span><span class="n">excjs</span><span class="p">,</span> <span class="n">myid</span><span class="p">,</span> <span class="n">nprocs</span>
<a name="ln-540"></a>
<a name="ln-541"></a>      <span class="k">call </span><span class="n">excjs</span><span class="p">(</span><span class="n">thl0</span><span class="p">,</span> <span class="n">ib</span><span class="p">,</span> <span class="n">ie</span><span class="p">,</span> <span class="n">jb</span><span class="p">,</span> <span class="n">je</span><span class="p">,</span> <span class="n">kb</span><span class="p">,</span> <span class="n">ke</span> <span class="o">+</span> <span class="n">kh</span><span class="p">,</span> <span class="n">ih</span><span class="p">,</span> <span class="n">jh</span><span class="p">)</span>
<a name="ln-542"></a>      <span class="k">call </span><span class="n">excjs</span><span class="p">(</span><span class="n">thlm</span><span class="p">,</span> <span class="n">ib</span><span class="p">,</span> <span class="n">ie</span><span class="p">,</span> <span class="n">jb</span><span class="p">,</span> <span class="n">je</span><span class="p">,</span> <span class="n">kb</span><span class="p">,</span> <span class="n">ke</span> <span class="o">+</span> <span class="n">kh</span><span class="p">,</span> <span class="n">ih</span><span class="p">,</span> <span class="n">jh</span><span class="p">)</span>
<a name="ln-543"></a>
<a name="ln-544"></a>      <span class="k">return</span>
<a name="ln-545"></a><span class="k">   end subroutine </span><span class="n">cyclichj</span>
<a name="ln-546"></a>
<a name="ln-547"></a>   <span class="c">!&gt; Sets y/j periodic boundary conditions for the humidity</span>
<a name="ln-548"></a>   <span class="k">subroutine </span><span class="n">cyclicqj</span>
<a name="ln-549"></a>      <span class="k">use </span><span class="n">modglobal</span><span class="p">,</span> <span class="n">only</span><span class="p">:</span><span class="n">ib</span><span class="p">,</span> <span class="n">ie</span><span class="p">,</span> <span class="n">jb</span><span class="p">,</span> <span class="n">je</span><span class="p">,</span> <span class="n">ih</span><span class="p">,</span> <span class="n">jh</span><span class="p">,</span> <span class="n">kb</span><span class="p">,</span> <span class="n">ke</span><span class="p">,</span> <span class="n">kh</span><span class="p">,</span> <span class="n">nsv</span><span class="p">,</span> <span class="n">dt</span><span class="p">,</span> <span class="n">rk3step</span><span class="p">,</span> <span class="n">dxhi</span><span class="p">,</span> <span class="n">ihc</span><span class="p">,</span> <span class="n">jhc</span><span class="p">,</span> <span class="n">khc</span><span class="p">,</span> <span class="n">dy</span>
<a name="ln-550"></a>      <span class="k">use </span><span class="n">modfields</span><span class="p">,</span> <span class="n">only</span><span class="p">:</span><span class="n">qt0</span><span class="p">,</span> <span class="n">qtm</span>
<a name="ln-551"></a>      <span class="k">use </span><span class="n">modmpi</span><span class="p">,</span> <span class="n">only</span><span class="p">:</span><span class="n">excjs</span><span class="p">,</span> <span class="n">myid</span><span class="p">,</span> <span class="n">nprocs</span>
<a name="ln-552"></a>
<a name="ln-553"></a>      <span class="k">call </span><span class="n">excjs</span><span class="p">(</span><span class="n">qt0</span><span class="p">,</span> <span class="n">ib</span><span class="p">,</span> <span class="n">ie</span><span class="p">,</span> <span class="n">jb</span><span class="p">,</span> <span class="n">je</span><span class="p">,</span> <span class="n">kb</span><span class="p">,</span> <span class="n">ke</span> <span class="o">+</span> <span class="n">kh</span><span class="p">,</span> <span class="n">ih</span><span class="p">,</span> <span class="n">jh</span><span class="p">)</span>
<a name="ln-554"></a>      <span class="k">call </span><span class="n">excjs</span><span class="p">(</span><span class="n">qtm</span><span class="p">,</span> <span class="n">ib</span><span class="p">,</span> <span class="n">ie</span><span class="p">,</span> <span class="n">jb</span><span class="p">,</span> <span class="n">je</span><span class="p">,</span> <span class="n">kb</span><span class="p">,</span> <span class="n">ke</span> <span class="o">+</span> <span class="n">kh</span><span class="p">,</span> <span class="n">ih</span><span class="p">,</span> <span class="n">jh</span><span class="p">)</span>
<a name="ln-555"></a>
<a name="ln-556"></a>      <span class="k">return</span>
<a name="ln-557"></a><span class="k">   end subroutine </span><span class="n">cyclicqj</span>
<a name="ln-558"></a>
<a name="ln-559"></a>   <span class="c">!&gt; Sets y/j periodic boundary conditions for the scalars</span>
<a name="ln-560"></a>   <span class="k">subroutine </span><span class="n">cyclicsj</span>
<a name="ln-561"></a>      <span class="k">use </span><span class="n">modglobal</span><span class="p">,</span> <span class="n">only</span><span class="p">:</span><span class="n">ib</span><span class="p">,</span> <span class="n">ie</span><span class="p">,</span> <span class="n">jb</span><span class="p">,</span> <span class="n">je</span><span class="p">,</span> <span class="n">ih</span><span class="p">,</span> <span class="n">jh</span><span class="p">,</span> <span class="n">kb</span><span class="p">,</span> <span class="n">ke</span><span class="p">,</span> <span class="n">kh</span><span class="p">,</span> <span class="n">nsv</span><span class="p">,</span> <span class="n">dt</span><span class="p">,</span> <span class="n">rk3step</span><span class="p">,</span> <span class="n">dxhi</span><span class="p">,</span> <span class="n">ihc</span><span class="p">,</span> <span class="n">jhc</span><span class="p">,</span> <span class="n">khc</span><span class="p">,</span> <span class="n">dy</span>
<a name="ln-562"></a>      <span class="k">use </span><span class="n">modfields</span><span class="p">,</span> <span class="n">only</span><span class="p">:</span><span class="n">sv0</span><span class="p">,</span> <span class="n">svm</span>
<a name="ln-563"></a>      <span class="k">use </span><span class="n">modmpi</span><span class="p">,</span> <span class="n">only</span><span class="p">:</span><span class="n">excjs</span><span class="p">,</span> <span class="n">myid</span><span class="p">,</span> <span class="n">nprocs</span>
<a name="ln-564"></a>      <span class="kt">integer </span><span class="n">n</span>
<a name="ln-565"></a>
<a name="ln-566"></a>      <span class="k">do </span><span class="n">n</span> <span class="o">=</span> <span class="mi">1</span><span class="p">,</span> <span class="n">nsv</span>
<a name="ln-567"></a>         <span class="k">call </span><span class="n">excjs</span><span class="p">(</span><span class="n">sv0</span><span class="p">(:,</span> <span class="p">:,</span> <span class="p">:,</span> <span class="n">n</span><span class="p">),</span> <span class="n">ib</span><span class="p">,</span> <span class="n">ie</span><span class="p">,</span> <span class="n">jb</span><span class="p">,</span> <span class="n">je</span><span class="p">,</span> <span class="n">kb</span> <span class="o">-</span> <span class="n">khc</span><span class="p">,</span> <span class="n">ke</span> <span class="o">+</span> <span class="n">khc</span><span class="p">,</span> <span class="n">ihc</span><span class="p">,</span> <span class="n">jhc</span><span class="p">)</span>
<a name="ln-568"></a>         <span class="k">call </span><span class="n">excjs</span><span class="p">(</span><span class="n">svm</span><span class="p">(:,</span> <span class="p">:,</span> <span class="p">:,</span> <span class="n">n</span><span class="p">),</span> <span class="n">ib</span><span class="p">,</span> <span class="n">ie</span><span class="p">,</span> <span class="n">jb</span><span class="p">,</span> <span class="n">je</span><span class="p">,</span> <span class="n">kb</span> <span class="o">-</span> <span class="n">khc</span><span class="p">,</span> <span class="n">ke</span> <span class="o">+</span> <span class="n">khc</span><span class="p">,</span> <span class="n">ihc</span><span class="p">,</span> <span class="n">jhc</span><span class="p">)</span>
<a name="ln-569"></a>      <span class="n">enddo</span>
<a name="ln-570"></a>
<a name="ln-571"></a>      <span class="k">return</span>
<a name="ln-572"></a><span class="k">   end subroutine </span><span class="n">cyclicsj</span>
<a name="ln-573"></a>   <span class="c">!!!!!!!!!!!end y/j periodic BC for scalars!!!!!!!!</span>
<a name="ln-574"></a>
<a name="ln-575"></a>   <span class="c">!&gt;set lateral periodic boundary conditions for momentum in x/i direction</span>
<a name="ln-576"></a>   <span class="k">subroutine </span><span class="n">cyclicmi</span>
<a name="ln-577"></a>
<a name="ln-578"></a>      <span class="k">use </span><span class="n">modglobal</span><span class="p">,</span> <span class="n">only</span><span class="p">:</span><span class="n">ib</span><span class="p">,</span> <span class="n">ie</span><span class="p">,</span> <span class="n">jb</span><span class="p">,</span> <span class="n">je</span><span class="p">,</span> <span class="n">ih</span><span class="p">,</span> <span class="n">jh</span><span class="p">,</span> <span class="n">kb</span><span class="p">,</span> <span class="n">ke</span><span class="p">,</span> <span class="n">kh</span><span class="p">,</span> <span class="n">jmax</span>
<a name="ln-579"></a>      <span class="k">use </span><span class="n">modfields</span><span class="p">,</span> <span class="n">only</span><span class="p">:</span><span class="n">u0</span><span class="p">,</span> <span class="n">um</span><span class="p">,</span> <span class="n">v0</span><span class="p">,</span> <span class="n">vm</span><span class="p">,</span> <span class="n">w0</span><span class="p">,</span> <span class="n">wm</span><span class="p">,</span> <span class="n">e120</span><span class="p">,</span> <span class="n">e12m</span>
<a name="ln-580"></a>      <span class="k">use </span><span class="n">modsubgriddata</span><span class="p">,</span> <span class="n">only</span><span class="p">:</span><span class="n">loneeqn</span><span class="p">,</span> <span class="n">lsmagorinsky</span>
<a name="ln-581"></a>
<a name="ln-582"></a>      <span class="kt">integer </span><span class="n">n</span><span class="p">,</span> <span class="n">m</span>
<a name="ln-583"></a>
<a name="ln-584"></a>      <span class="k">do </span><span class="n">m</span> <span class="o">=</span> <span class="mi">1</span><span class="p">,</span> <span class="n">ih</span>
<a name="ln-585"></a>
<a name="ln-586"></a>         <span class="n">u0</span><span class="p">(</span><span class="n">ib</span> <span class="o">-</span> <span class="n">m</span><span class="p">,</span> <span class="p">:,</span> <span class="p">:)</span> <span class="o">=</span> <span class="n">u0</span><span class="p">(</span><span class="n">ie</span> <span class="o">+</span> <span class="mi">1</span> <span class="o">-</span> <span class="n">m</span><span class="p">,</span> <span class="p">:,</span> <span class="p">:)</span>
<a name="ln-587"></a>         <span class="n">u0</span><span class="p">(</span><span class="n">ie</span> <span class="o">+</span> <span class="n">m</span><span class="p">,</span> <span class="p">:,</span> <span class="p">:)</span> <span class="o">=</span> <span class="n">u0</span><span class="p">(</span><span class="n">ib</span> <span class="o">-</span> <span class="mi">1</span> <span class="o">+</span> <span class="n">m</span><span class="p">,</span> <span class="p">:,</span> <span class="p">:)</span>
<a name="ln-588"></a>         <span class="n">v0</span><span class="p">(</span><span class="n">ib</span> <span class="o">-</span> <span class="n">m</span><span class="p">,</span> <span class="p">:,</span> <span class="p">:)</span> <span class="o">=</span> <span class="n">v0</span><span class="p">(</span><span class="n">ie</span> <span class="o">+</span> <span class="mi">1</span> <span class="o">-</span> <span class="n">m</span><span class="p">,</span> <span class="p">:,</span> <span class="p">:)</span>
<a name="ln-589"></a>         <span class="n">v0</span><span class="p">(</span><span class="n">ie</span> <span class="o">+</span> <span class="n">m</span><span class="p">,</span> <span class="p">:,</span> <span class="p">:)</span> <span class="o">=</span> <span class="n">v0</span><span class="p">(</span><span class="n">ib</span> <span class="o">-</span> <span class="mi">1</span> <span class="o">+</span> <span class="n">m</span><span class="p">,</span> <span class="p">:,</span> <span class="p">:)</span>
<a name="ln-590"></a>         <span class="n">w0</span><span class="p">(</span><span class="n">ib</span> <span class="o">-</span> <span class="n">m</span><span class="p">,</span> <span class="p">:,</span> <span class="p">:)</span> <span class="o">=</span> <span class="n">w0</span><span class="p">(</span><span class="n">ie</span> <span class="o">+</span> <span class="mi">1</span> <span class="o">-</span> <span class="n">m</span><span class="p">,</span> <span class="p">:,</span> <span class="p">:)</span>
<a name="ln-591"></a>         <span class="n">w0</span><span class="p">(</span><span class="n">ie</span> <span class="o">+</span> <span class="n">m</span><span class="p">,</span> <span class="p">:,</span> <span class="p">:)</span> <span class="o">=</span> <span class="n">w0</span><span class="p">(</span><span class="n">ib</span> <span class="o">-</span> <span class="mi">1</span> <span class="o">+</span> <span class="n">m</span><span class="p">,</span> <span class="p">:,</span> <span class="p">:)</span>
<a name="ln-592"></a>         <span class="n">um</span><span class="p">(</span><span class="n">ib</span> <span class="o">-</span> <span class="n">m</span><span class="p">,</span> <span class="p">:,</span> <span class="p">:)</span> <span class="o">=</span> <span class="n">um</span><span class="p">(</span><span class="n">ie</span> <span class="o">+</span> <span class="mi">1</span> <span class="o">-</span> <span class="n">m</span><span class="p">,</span> <span class="p">:,</span> <span class="p">:)</span>
<a name="ln-593"></a>         <span class="n">um</span><span class="p">(</span><span class="n">ie</span> <span class="o">+</span> <span class="n">m</span><span class="p">,</span> <span class="p">:,</span> <span class="p">:)</span> <span class="o">=</span> <span class="n">um</span><span class="p">(</span><span class="n">ib</span> <span class="o">-</span> <span class="mi">1</span> <span class="o">+</span> <span class="n">m</span><span class="p">,</span> <span class="p">:,</span> <span class="p">:)</span>
<a name="ln-594"></a>         <span class="n">vm</span><span class="p">(</span><span class="n">ib</span> <span class="o">-</span> <span class="n">m</span><span class="p">,</span> <span class="p">:,</span> <span class="p">:)</span> <span class="o">=</span> <span class="n">vm</span><span class="p">(</span><span class="n">ie</span> <span class="o">+</span> <span class="mi">1</span> <span class="o">-</span> <span class="n">m</span><span class="p">,</span> <span class="p">:,</span> <span class="p">:)</span>
<a name="ln-595"></a>         <span class="n">vm</span><span class="p">(</span><span class="n">ie</span> <span class="o">+</span> <span class="n">m</span><span class="p">,</span> <span class="p">:,</span> <span class="p">:)</span> <span class="o">=</span> <span class="n">vm</span><span class="p">(</span><span class="n">ib</span> <span class="o">-</span> <span class="mi">1</span> <span class="o">+</span> <span class="n">m</span><span class="p">,</span> <span class="p">:,</span> <span class="p">:)</span>
<a name="ln-596"></a>         <span class="n">wm</span><span class="p">(</span><span class="n">ib</span> <span class="o">-</span> <span class="n">m</span><span class="p">,</span> <span class="p">:,</span> <span class="p">:)</span> <span class="o">=</span> <span class="n">wm</span><span class="p">(</span><span class="n">ie</span> <span class="o">+</span> <span class="mi">1</span> <span class="o">-</span> <span class="n">m</span><span class="p">,</span> <span class="p">:,</span> <span class="p">:)</span>
<a name="ln-597"></a>         <span class="n">wm</span><span class="p">(</span><span class="n">ie</span> <span class="o">+</span> <span class="n">m</span><span class="p">,</span> <span class="p">:,</span> <span class="p">:)</span> <span class="o">=</span> <span class="n">wm</span><span class="p">(</span><span class="n">ib</span> <span class="o">-</span> <span class="mi">1</span> <span class="o">+</span> <span class="n">m</span><span class="p">,</span> <span class="p">:,</span> <span class="p">:)</span>
<a name="ln-598"></a>
<a name="ln-599"></a>         <span class="n">e120</span><span class="p">(</span><span class="n">ib</span> <span class="o">-</span> <span class="n">m</span><span class="p">,</span> <span class="p">:,</span> <span class="p">:)</span> <span class="o">=</span> <span class="n">e120</span><span class="p">(</span><span class="n">ie</span> <span class="o">+</span> <span class="mi">1</span> <span class="o">-</span> <span class="n">m</span><span class="p">,</span> <span class="p">:,</span> <span class="p">:)</span>
<a name="ln-600"></a>         <span class="n">e120</span><span class="p">(</span><span class="n">ie</span> <span class="o">+</span> <span class="n">m</span><span class="p">,</span> <span class="p">:,</span> <span class="p">:)</span> <span class="o">=</span> <span class="n">e120</span><span class="p">(</span><span class="n">ib</span> <span class="o">-</span> <span class="mi">1</span> <span class="o">+</span> <span class="n">m</span><span class="p">,</span> <span class="p">:,</span> <span class="p">:)</span>
<a name="ln-601"></a>         <span class="n">e12m</span><span class="p">(</span><span class="n">ib</span> <span class="o">-</span> <span class="n">m</span><span class="p">,</span> <span class="p">:,</span> <span class="p">:)</span> <span class="o">=</span> <span class="n">e12m</span><span class="p">(</span><span class="n">ie</span> <span class="o">+</span> <span class="mi">1</span> <span class="o">-</span> <span class="n">m</span><span class="p">,</span> <span class="p">:,</span> <span class="p">:)</span>
<a name="ln-602"></a>         <span class="n">e12m</span><span class="p">(</span><span class="n">ie</span> <span class="o">+</span> <span class="n">m</span><span class="p">,</span> <span class="p">:,</span> <span class="p">:)</span> <span class="o">=</span> <span class="n">e12m</span><span class="p">(</span><span class="n">ib</span> <span class="o">-</span> <span class="mi">1</span> <span class="o">+</span> <span class="n">m</span><span class="p">,</span> <span class="p">:,</span> <span class="p">:)</span>
<a name="ln-603"></a>
<a name="ln-604"></a>      <span class="k">end do</span>
<a name="ln-605"></a>
<a name="ln-606"></a><span class="k">      if</span> <span class="p">(</span><span class="n">loneeqn</span><span class="p">)</span> <span class="k">then</span>
<a name="ln-607"></a><span class="k">         </span><span class="n">e120</span><span class="p">(</span><span class="n">ib</span> <span class="o">-</span> <span class="n">m</span><span class="p">,</span> <span class="p">:,</span> <span class="p">:)</span> <span class="o">=</span> <span class="n">e120</span><span class="p">(</span><span class="n">ie</span> <span class="o">+</span> <span class="mi">1</span> <span class="o">-</span> <span class="n">m</span><span class="p">,</span> <span class="p">:,</span> <span class="p">:)</span>
<a name="ln-608"></a>         <span class="n">e120</span><span class="p">(</span><span class="n">ie</span> <span class="o">+</span> <span class="n">m</span><span class="p">,</span> <span class="p">:,</span> <span class="p">:)</span> <span class="o">=</span> <span class="n">e120</span><span class="p">(</span><span class="n">ib</span> <span class="o">-</span> <span class="mi">1</span> <span class="o">+</span> <span class="n">m</span><span class="p">,</span> <span class="p">:,</span> <span class="p">:)</span>
<a name="ln-609"></a>         <span class="n">e12m</span><span class="p">(</span><span class="n">ib</span> <span class="o">-</span> <span class="n">m</span><span class="p">,</span> <span class="p">:,</span> <span class="p">:)</span> <span class="o">=</span> <span class="n">e12m</span><span class="p">(</span><span class="n">ie</span> <span class="o">+</span> <span class="mi">1</span> <span class="o">-</span> <span class="n">m</span><span class="p">,</span> <span class="p">:,</span> <span class="p">:)</span>
<a name="ln-610"></a>         <span class="n">e12m</span><span class="p">(</span><span class="n">ie</span> <span class="o">+</span> <span class="n">m</span><span class="p">,</span> <span class="p">:,</span> <span class="p">:)</span> <span class="o">=</span> <span class="n">e12m</span><span class="p">(</span><span class="n">ib</span> <span class="o">-</span> <span class="mi">1</span> <span class="o">+</span> <span class="n">m</span><span class="p">,</span> <span class="p">:,</span> <span class="p">:)</span>
<a name="ln-611"></a>      <span class="k">end if</span>
<a name="ln-612"></a>
<a name="ln-613"></a><span class="k">      return</span>
<a name="ln-614"></a><span class="k">   end subroutine </span><span class="n">cyclicmi</span>
<a name="ln-615"></a>
<a name="ln-616"></a>   <span class="c">!&gt;set lateral periodic boundary conditions for momentum in y/j direction</span>
<a name="ln-617"></a>   <span class="k">subroutine </span><span class="n">cyclicmj</span>
<a name="ln-618"></a>
<a name="ln-619"></a>      <span class="k">use </span><span class="n">modglobal</span><span class="p">,</span> <span class="n">only</span><span class="p">:</span><span class="n">ib</span><span class="p">,</span> <span class="n">ie</span><span class="p">,</span> <span class="n">jb</span><span class="p">,</span> <span class="n">je</span><span class="p">,</span> <span class="n">ih</span><span class="p">,</span> <span class="n">jh</span><span class="p">,</span> <span class="n">kb</span><span class="p">,</span> <span class="n">ke</span><span class="p">,</span> <span class="n">kh</span><span class="p">,</span> <span class="n">jmax</span>
<a name="ln-620"></a>      <span class="k">use </span><span class="n">modfields</span><span class="p">,</span> <span class="n">only</span><span class="p">:</span><span class="n">u0</span><span class="p">,</span> <span class="n">um</span><span class="p">,</span> <span class="n">v0</span><span class="p">,</span> <span class="n">vm</span><span class="p">,</span> <span class="n">w0</span><span class="p">,</span> <span class="n">wm</span><span class="p">,</span> <span class="n">e120</span><span class="p">,</span> <span class="n">e12m</span><span class="p">,</span> <span class="n">shear</span>
<a name="ln-621"></a>      <span class="k">use </span><span class="n">modsubgriddata</span><span class="p">,</span> <span class="n">only</span><span class="p">:</span><span class="n">loneeqn</span><span class="p">,</span> <span class="n">lsmagorinsky</span>
<a name="ln-622"></a>      <span class="k">use </span><span class="n">modmpi</span><span class="p">,</span> <span class="n">only</span><span class="p">:</span><span class="n">excjs</span>
<a name="ln-623"></a>
<a name="ln-624"></a>      <span class="kt">integer </span><span class="n">n</span><span class="p">,</span> <span class="n">m</span>
<a name="ln-625"></a>
<a name="ln-626"></a>      <span class="k">call </span><span class="n">excjs</span><span class="p">(</span><span class="n">u0</span><span class="p">,</span> <span class="n">ib</span><span class="p">,</span> <span class="n">ie</span><span class="p">,</span> <span class="n">jb</span><span class="p">,</span> <span class="n">je</span><span class="p">,</span> <span class="n">kb</span><span class="p">,</span> <span class="n">ke</span> <span class="o">+</span> <span class="n">kh</span><span class="p">,</span> <span class="n">ih</span><span class="p">,</span> <span class="n">jh</span><span class="p">)</span>
<a name="ln-627"></a>      <span class="k">call </span><span class="n">excjs</span><span class="p">(</span><span class="n">v0</span><span class="p">,</span> <span class="n">ib</span><span class="p">,</span> <span class="n">ie</span><span class="p">,</span> <span class="n">jb</span><span class="p">,</span> <span class="n">je</span><span class="p">,</span> <span class="n">kb</span><span class="p">,</span> <span class="n">ke</span> <span class="o">+</span> <span class="n">kh</span><span class="p">,</span> <span class="n">ih</span><span class="p">,</span> <span class="n">jh</span><span class="p">)</span>
<a name="ln-628"></a>      <span class="k">call </span><span class="n">excjs</span><span class="p">(</span><span class="n">w0</span><span class="p">,</span> <span class="n">ib</span><span class="p">,</span> <span class="n">ie</span><span class="p">,</span> <span class="n">jb</span><span class="p">,</span> <span class="n">je</span><span class="p">,</span> <span class="n">kb</span><span class="p">,</span> <span class="n">ke</span> <span class="o">+</span> <span class="n">kh</span><span class="p">,</span> <span class="n">ih</span><span class="p">,</span> <span class="n">jh</span><span class="p">)</span>
<a name="ln-629"></a>      <span class="k">call </span><span class="n">excjs</span><span class="p">(</span><span class="n">um</span><span class="p">,</span> <span class="n">ib</span><span class="p">,</span> <span class="n">ie</span><span class="p">,</span> <span class="n">jb</span><span class="p">,</span> <span class="n">je</span><span class="p">,</span> <span class="n">kb</span><span class="p">,</span> <span class="n">ke</span> <span class="o">+</span> <span class="n">kh</span><span class="p">,</span> <span class="n">ih</span><span class="p">,</span> <span class="n">jh</span><span class="p">)</span>
<a name="ln-630"></a>      <span class="k">call </span><span class="n">excjs</span><span class="p">(</span><span class="n">vm</span><span class="p">,</span> <span class="n">ib</span><span class="p">,</span> <span class="n">ie</span><span class="p">,</span> <span class="n">jb</span><span class="p">,</span> <span class="n">je</span><span class="p">,</span> <span class="n">kb</span><span class="p">,</span> <span class="n">ke</span> <span class="o">+</span> <span class="n">kh</span><span class="p">,</span> <span class="n">ih</span><span class="p">,</span> <span class="n">jh</span><span class="p">)</span>
<a name="ln-631"></a>      <span class="k">call </span><span class="n">excjs</span><span class="p">(</span><span class="n">wm</span><span class="p">,</span> <span class="n">ib</span><span class="p">,</span> <span class="n">ie</span><span class="p">,</span> <span class="n">jb</span><span class="p">,</span> <span class="n">je</span><span class="p">,</span> <span class="n">kb</span><span class="p">,</span> <span class="n">ke</span> <span class="o">+</span> <span class="n">kh</span><span class="p">,</span> <span class="n">ih</span><span class="p">,</span> <span class="n">jh</span><span class="p">)</span>
<a name="ln-632"></a>
<a name="ln-633"></a>      <span class="k">if</span> <span class="p">(</span><span class="n">loneeqn</span><span class="p">)</span> <span class="k">then</span>
<a name="ln-634"></a><span class="k">         call </span><span class="n">excjs</span><span class="p">(</span><span class="n">e120</span><span class="p">,</span> <span class="n">ib</span><span class="p">,</span> <span class="n">ie</span><span class="p">,</span> <span class="n">jb</span><span class="p">,</span> <span class="n">je</span><span class="p">,</span> <span class="n">kb</span><span class="p">,</span> <span class="n">ke</span> <span class="o">+</span> <span class="n">kh</span><span class="p">,</span> <span class="n">ih</span><span class="p">,</span> <span class="n">jh</span><span class="p">)</span>
<a name="ln-635"></a>         <span class="k">call </span><span class="n">excjs</span><span class="p">(</span><span class="n">e12m</span><span class="p">,</span> <span class="n">ib</span><span class="p">,</span> <span class="n">ie</span><span class="p">,</span> <span class="n">jb</span><span class="p">,</span> <span class="n">je</span><span class="p">,</span> <span class="n">kb</span><span class="p">,</span> <span class="n">ke</span> <span class="o">+</span> <span class="n">kh</span><span class="p">,</span> <span class="n">ih</span><span class="p">,</span> <span class="n">jh</span><span class="p">)</span>
<a name="ln-636"></a>         <span class="c">! exchange shear components between processors</span>
<a name="ln-637"></a>         <span class="k">do </span><span class="n">n</span> <span class="o">=</span> <span class="mi">1</span><span class="p">,</span> <span class="mi">12</span> <span class="c">! for all 12 components</span>
<a name="ln-638"></a>            <span class="k">call </span><span class="n">excjs</span><span class="p">(</span><span class="n">shear</span><span class="p">(:,</span> <span class="p">:,</span> <span class="p">:,</span> <span class="n">n</span><span class="p">),</span> <span class="n">ib</span><span class="p">,</span> <span class="n">ie</span><span class="p">,</span> <span class="n">jb</span><span class="p">,</span> <span class="n">je</span><span class="p">,</span> <span class="n">kb</span><span class="p">,</span> <span class="n">ke</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">1</span><span class="p">)</span>
<a name="ln-639"></a>         <span class="k">end do</span>
<a name="ln-640"></a><span class="k">      end if</span>
<a name="ln-641"></a>
<a name="ln-642"></a><span class="k">      if</span> <span class="p">(</span><span class="n">lsmagorinsky</span><span class="p">)</span> <span class="k">then</span>
<a name="ln-643"></a>         <span class="c">! exchange shear components between processors</span>
<a name="ln-644"></a>         <span class="k">do </span><span class="n">n</span> <span class="o">=</span> <span class="mi">1</span><span class="p">,</span> <span class="mi">12</span> <span class="c">! for all 12 components</span>
<a name="ln-645"></a>            <span class="k">call </span><span class="n">excjs</span><span class="p">(</span><span class="n">shear</span><span class="p">(:,</span> <span class="p">:,</span> <span class="p">:,</span> <span class="n">n</span><span class="p">),</span> <span class="n">ib</span><span class="p">,</span> <span class="n">ie</span><span class="p">,</span> <span class="n">jb</span><span class="p">,</span> <span class="n">je</span><span class="p">,</span> <span class="n">kb</span><span class="p">,</span> <span class="n">ke</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">1</span><span class="p">)</span>
<a name="ln-646"></a>         <span class="k">end do</span>
<a name="ln-647"></a><span class="k">      end if</span>
<a name="ln-648"></a>
<a name="ln-649"></a><span class="k">      return</span>
<a name="ln-650"></a><span class="k">   end subroutine </span><span class="n">cyclicmj</span>
<a name="ln-651"></a>
<a name="ln-652"></a>   <span class="c">!&gt;set inlet and outlet boundary conditions in i-direction</span>
<a name="ln-653"></a>   <span class="k">subroutine </span><span class="n">iolet</span>
<a name="ln-654"></a>
<a name="ln-655"></a>      <span class="k">use </span><span class="n">modglobal</span><span class="p">,</span> <span class="n">only</span><span class="p">:</span><span class="n">dxhi</span><span class="p">,</span> <span class="n">dxhci</span><span class="p">,</span> <span class="n">xh</span><span class="p">,</span> <span class="n">zh</span><span class="p">,</span> <span class="n">ib</span><span class="p">,</span> <span class="n">ie</span><span class="p">,</span> <span class="n">jb</span><span class="p">,</span> <span class="n">je</span><span class="p">,</span> <span class="n">ih</span><span class="p">,</span> <span class="n">jh</span><span class="p">,</span> <span class="n">kb</span><span class="p">,</span> <span class="n">ke</span><span class="p">,</span> <span class="n">kh</span><span class="p">,</span> <span class="n">nsv</span><span class="p">,</span> <span class="n">rk3step</span><span class="p">,</span> <span class="n">dt</span><span class="p">,</span> <span class="n">iinletgen</span><span class="p">,</span> <span class="n">ltempeq</span><span class="p">,</span> <span class="n">lmoist</span><span class="p">,</span> <span class="n">ihc</span><span class="p">,</span> <span class="n">idriver</span><span class="p">,</span> <span class="n">dy</span><span class="p">,</span> <span class="n">dzf</span><span class="p">,</span> <span class="n">jtot</span><span class="p">,</span> <span class="n">zh</span>
<a name="ln-656"></a>      <span class="k">use </span><span class="n">modfields</span><span class="p">,</span> <span class="n">only</span><span class="p">:</span><span class="n">u0</span><span class="p">,</span> <span class="n">um</span><span class="p">,</span> <span class="n">v0</span><span class="p">,</span> <span class="n">vm</span><span class="p">,</span> <span class="n">w0</span><span class="p">,</span> <span class="n">wm</span><span class="p">,</span> <span class="n">e120</span><span class="p">,</span> <span class="n">e12m</span><span class="p">,</span> <span class="n">thl0</span><span class="p">,</span> <span class="n">thlm</span><span class="p">,</span> <span class="n">qt0</span><span class="p">,</span> <span class="n">qtm</span><span class="p">,</span> <span class="n">sv0</span><span class="p">,</span> <span class="n">svm</span><span class="p">,</span> <span class="n">uprof</span><span class="p">,</span> <span class="n">vprof</span><span class="p">,</span> <span class="n">e12prof</span><span class="p">,</span> <span class="n">thlprof</span><span class="p">,</span> <span class="p">&amp;</span>
<a name="ln-657"></a>         <span class="n">qtprof</span><span class="p">,</span> <span class="n">svprof</span><span class="p">,</span> <span class="n">uouttot</span><span class="p">,</span> <span class="n">wouttot</span>
<a name="ln-658"></a>      <span class="k">use </span><span class="n">modmpi</span><span class="p">,</span> <span class="n">only</span><span class="p">:</span><span class="n">excjs</span><span class="p">,</span> <span class="n">myid</span><span class="p">,</span> <span class="n">slabsum</span>
<a name="ln-659"></a>      <span class="k">use </span><span class="n">modinletdata</span><span class="p">,</span> <span class="n">only</span><span class="p">:</span><span class="n">u0inletbcold</span><span class="p">,</span> <span class="n">v0inletbcold</span><span class="p">,</span> <span class="n">w0inletbcold</span><span class="p">,</span> <span class="n">uminletbc</span><span class="p">,</span> <span class="n">vminletbc</span><span class="p">,</span> <span class="n">wminletbc</span><span class="p">,</span> <span class="n">totaluold</span><span class="p">,</span> <span class="p">&amp;</span>
<a name="ln-660"></a>         <span class="n">t0inletbcold</span><span class="p">,</span> <span class="n">tminletbc</span><span class="p">,</span> <span class="n">u0driver</span><span class="p">,</span> <span class="n">v0driver</span><span class="p">,</span> <span class="n">w0driver</span><span class="p">,</span> <span class="n">e120driver</span><span class="p">,</span> <span class="n">thl0driver</span><span class="p">,</span> <span class="n">qt0driver</span><span class="p">,</span> <span class="n">umdriver</span><span class="p">,</span> <span class="n">vmdriver</span><span class="p">,</span> <span class="n">wmdriver</span><span class="p">,&amp;</span> 
<a name="ln-661"></a>         <span class="n">e12mdriver</span><span class="p">,</span> <span class="n">thlmdriver</span><span class="p">,</span> <span class="n">qtmdriver</span><span class="p">,</span> <span class="n">sv0driver</span><span class="p">,</span> <span class="n">svmdriver</span>
<a name="ln-662"></a>
<a name="ln-663"></a>      <span class="kt">real </span><span class="n">rk3coef</span>
<a name="ln-664"></a>      <span class="kt">real</span><span class="p">,</span> <span class="k">dimension</span><span class="p">(</span><span class="n">kb</span><span class="p">:</span><span class="n">ke</span><span class="p">)</span> <span class="kd">::</span> <span class="n">uin</span>
<a name="ln-665"></a>      <span class="kt">integer </span><span class="n">n</span><span class="p">,</span> <span class="n">i</span><span class="p">,</span> <span class="n">j</span><span class="p">,</span> <span class="n">k</span><span class="p">,</span> <span class="n">m</span>
<a name="ln-666"></a>
<a name="ln-667"></a>      <span class="n">rk3coef</span> <span class="o">=</span> <span class="n">dt</span><span class="o">/</span><span class="p">(</span><span class="mf">4.</span><span class="o">-</span><span class="nb">dble</span><span class="p">(</span><span class="n">rk3step</span><span class="p">))</span>
<a name="ln-668"></a>
<a name="ln-669"></a>      <span class="c">! Inlet boundary is located at ib (not ib-1)!</span>
<a name="ln-670"></a>
<a name="ln-671"></a>      <span class="c">! Inlet</span>
<a name="ln-672"></a>      <span class="k">if</span> <span class="p">((</span><span class="n">iinletgen</span> <span class="o">==</span> <span class="mi">1</span><span class="p">)</span> <span class="p">.</span><span class="nb">or</span><span class="p">.</span> <span class="p">(</span><span class="n">iinletgen</span> <span class="o">==</span> <span class="mi">2</span><span class="p">))</span> <span class="k">then</span>
<a name="ln-673"></a><span class="k">         do </span><span class="n">j</span> <span class="o">=</span> <span class="n">jb</span><span class="p">,</span> <span class="n">je</span>
<a name="ln-674"></a>            <span class="k">do </span><span class="n">k</span> <span class="o">=</span> <span class="n">kb</span><span class="p">,</span> <span class="n">ke</span>
<a name="ln-675"></a>               <span class="n">u0</span><span class="p">(</span><span class="n">ib</span><span class="p">,</span> <span class="n">j</span><span class="p">,</span> <span class="n">k</span><span class="p">)</span> <span class="o">=</span> <span class="n">u0inletbcold</span><span class="p">(</span><span class="n">j</span><span class="p">,</span> <span class="n">k</span><span class="p">)</span>
<a name="ln-676"></a>               <span class="n">um</span><span class="p">(</span><span class="n">ib</span><span class="p">,</span> <span class="n">j</span><span class="p">,</span> <span class="n">k</span><span class="p">)</span> <span class="o">=</span> <span class="n">uminletbc</span><span class="p">(</span><span class="n">j</span><span class="p">,</span> <span class="n">k</span><span class="p">)</span>
<a name="ln-677"></a>               <span class="n">u0</span><span class="p">(</span><span class="n">ib</span> <span class="o">-</span> <span class="mi">1</span><span class="p">,</span> <span class="n">j</span><span class="p">,</span> <span class="n">k</span><span class="p">)</span> <span class="o">=</span> <span class="mi">2</span><span class="o">*</span><span class="n">u0</span><span class="p">(</span><span class="n">ib</span><span class="p">,</span> <span class="n">j</span><span class="p">,</span> <span class="n">k</span><span class="p">)</span> <span class="o">-</span> <span class="n">u0</span><span class="p">(</span><span class="n">ib</span> <span class="o">+</span> <span class="mi">1</span><span class="p">,</span> <span class="n">j</span><span class="p">,</span> <span class="n">k</span><span class="p">)</span>
<a name="ln-678"></a>               <span class="n">um</span><span class="p">(</span><span class="n">ib</span> <span class="o">-</span> <span class="mi">1</span><span class="p">,</span> <span class="n">j</span><span class="p">,</span> <span class="n">k</span><span class="p">)</span> <span class="o">=</span> <span class="mi">2</span><span class="o">*</span><span class="n">um</span><span class="p">(</span><span class="n">ib</span><span class="p">,</span> <span class="n">j</span><span class="p">,</span> <span class="n">k</span><span class="p">)</span> <span class="o">-</span> <span class="n">um</span><span class="p">(</span><span class="n">ib</span> <span class="o">+</span> <span class="mi">1</span><span class="p">,</span> <span class="n">j</span><span class="p">,</span> <span class="n">k</span><span class="p">)</span>
<a name="ln-679"></a>
<a name="ln-680"></a>               <span class="n">v0</span><span class="p">(</span><span class="n">ib</span> <span class="o">-</span> <span class="mi">1</span><span class="p">,</span> <span class="n">j</span><span class="p">,</span> <span class="n">k</span><span class="p">)</span> <span class="o">=</span> <span class="n">v0inletbcold</span><span class="p">(</span><span class="n">j</span><span class="p">,</span> <span class="n">k</span><span class="p">)</span>
<a name="ln-681"></a>               <span class="n">vm</span><span class="p">(</span><span class="n">ib</span> <span class="o">-</span> <span class="mi">1</span><span class="p">,</span> <span class="n">j</span><span class="p">,</span> <span class="n">k</span><span class="p">)</span> <span class="o">=</span> <span class="n">vminletbc</span><span class="p">(</span><span class="n">j</span><span class="p">,</span> <span class="n">k</span><span class="p">)</span>
<a name="ln-682"></a>
<a name="ln-683"></a>               <span class="c">! to be changed in the future: e12 should be taken from recycle plane!</span>
<a name="ln-684"></a>               <span class="n">e120</span><span class="p">(</span><span class="n">ib</span> <span class="o">-</span> <span class="mi">1</span><span class="p">,</span> <span class="n">j</span><span class="p">,</span> <span class="n">k</span><span class="p">)</span> <span class="o">=</span> <span class="n">e120</span><span class="p">(</span><span class="n">ib</span><span class="p">,</span> <span class="n">j</span><span class="p">,</span> <span class="n">k</span><span class="p">)</span> <span class="c">! extrapolate e12 from interior</span>
<a name="ln-685"></a>               <span class="n">e12m</span><span class="p">(</span><span class="n">ib</span> <span class="o">-</span> <span class="mi">1</span><span class="p">,</span> <span class="n">j</span><span class="p">,</span> <span class="n">k</span><span class="p">)</span> <span class="o">=</span> <span class="n">e12m</span><span class="p">(</span><span class="n">ib</span><span class="p">,</span> <span class="n">j</span><span class="p">,</span> <span class="n">k</span><span class="p">)</span> <span class="c">! extrapolate e12 from interior</span>
<a name="ln-686"></a>
<a name="ln-687"></a>               <span class="k">do </span><span class="n">n</span> <span class="o">=</span> <span class="mi">1</span><span class="p">,</span> <span class="n">nsv</span>
<a name="ln-688"></a>                  <span class="k">do </span><span class="n">m</span> <span class="o">=</span> <span class="mi">1</span><span class="p">,</span> <span class="n">ihc</span>
<a name="ln-689"></a>                     <span class="n">sv0</span><span class="p">(</span><span class="n">ib</span> <span class="o">-</span> <span class="n">m</span><span class="p">,</span> <span class="n">j</span><span class="p">,</span> <span class="n">k</span><span class="p">,</span> <span class="n">n</span><span class="p">)</span> <span class="o">=</span> <span class="mi">2</span><span class="o">*</span><span class="n">svprof</span><span class="p">(</span><span class="n">k</span><span class="p">,</span> <span class="n">n</span><span class="p">)</span> <span class="o">-</span> <span class="n">sv0</span><span class="p">(</span><span class="n">ib</span> <span class="o">+</span> <span class="p">(</span><span class="n">m</span> <span class="o">-</span> <span class="mi">1</span><span class="p">),</span> <span class="n">j</span><span class="p">,</span> <span class="n">k</span><span class="p">,</span> <span class="n">n</span><span class="p">)</span>
<a name="ln-690"></a>                     <span class="n">svm</span><span class="p">(</span><span class="n">ib</span> <span class="o">-</span> <span class="n">m</span><span class="p">,</span> <span class="n">j</span><span class="p">,</span> <span class="n">k</span><span class="p">,</span> <span class="n">n</span><span class="p">)</span> <span class="o">=</span> <span class="mi">2</span><span class="o">*</span><span class="n">svprof</span><span class="p">(</span><span class="n">k</span><span class="p">,</span> <span class="n">n</span><span class="p">)</span> <span class="o">-</span> <span class="n">svm</span><span class="p">(</span><span class="n">ib</span> <span class="o">+</span> <span class="p">(</span><span class="n">m</span> <span class="o">-</span> <span class="mi">1</span><span class="p">),</span> <span class="n">j</span><span class="p">,</span> <span class="n">k</span><span class="p">,</span> <span class="n">n</span><span class="p">)</span>
<a name="ln-691"></a>                  <span class="n">enddo</span>
<a name="ln-692"></a>               <span class="n">enddo</span>
<a name="ln-693"></a>            <span class="k">end do</span>
<a name="ln-694"></a><span class="k">            do </span><span class="n">k</span> <span class="o">=</span> <span class="n">kb</span><span class="p">,</span> <span class="n">ke</span> <span class="o">+</span> <span class="mi">1</span>
<a name="ln-695"></a>               <span class="n">w0</span><span class="p">(</span><span class="n">ib</span> <span class="o">-</span> <span class="mi">1</span><span class="p">,</span> <span class="n">j</span><span class="p">,</span> <span class="n">k</span><span class="p">)</span> <span class="o">=</span> <span class="n">w0inletbcold</span><span class="p">(</span><span class="n">j</span><span class="p">,</span> <span class="n">k</span><span class="p">)</span>
<a name="ln-696"></a>               <span class="n">wm</span><span class="p">(</span><span class="n">ib</span> <span class="o">-</span> <span class="mi">1</span><span class="p">,</span> <span class="n">j</span><span class="p">,</span> <span class="n">k</span><span class="p">)</span> <span class="o">=</span> <span class="n">wminletbc</span><span class="p">(</span><span class="n">j</span><span class="p">,</span> <span class="n">k</span><span class="p">)</span>
<a name="ln-697"></a>            <span class="k">end do</span>
<a name="ln-698"></a><span class="k">         end do</span>
<a name="ln-699"></a>
<a name="ln-700"></a>         <span class="c">! Heat</span>
<a name="ln-701"></a>         <span class="k">if</span> <span class="p">(</span><span class="n">ltempeq</span><span class="p">)</span> <span class="k">then</span>
<a name="ln-702"></a><span class="k">            do </span><span class="n">k</span> <span class="o">=</span> <span class="n">kb</span><span class="p">,</span> <span class="n">ke</span>
<a name="ln-703"></a>               <span class="k">do </span><span class="n">j</span> <span class="o">=</span> <span class="n">jb</span><span class="p">,</span> <span class="n">je</span>
<a name="ln-704"></a>                  <span class="n">thl0</span><span class="p">(</span><span class="n">ib</span> <span class="o">-</span> <span class="mi">1</span><span class="p">,</span> <span class="n">j</span><span class="p">,</span> <span class="n">k</span><span class="p">)</span> <span class="o">=</span> <span class="n">t0inletbcold</span><span class="p">(</span><span class="n">j</span><span class="p">,</span> <span class="n">k</span><span class="p">)</span>
<a name="ln-705"></a>                  <span class="n">thlm</span><span class="p">(</span><span class="n">ib</span> <span class="o">-</span> <span class="mi">1</span><span class="p">,</span> <span class="n">j</span><span class="p">,</span> <span class="n">k</span><span class="p">)</span> <span class="o">=</span> <span class="n">tminletbc</span><span class="p">(</span><span class="n">j</span><span class="p">,</span> <span class="n">k</span><span class="p">)</span>
<a name="ln-706"></a>               <span class="k">end do</span>
<a name="ln-707"></a><span class="k">            end do</span>
<a name="ln-708"></a><span class="k">         end if</span>
<a name="ln-709"></a>
<a name="ln-710"></a><span class="k">         if</span> <span class="p">(</span><span class="n">lmoist</span><span class="p">)</span> <span class="k">then</span>
<a name="ln-711"></a><span class="k">            do </span><span class="n">k</span> <span class="o">=</span> <span class="n">kb</span><span class="p">,</span> <span class="n">ke</span>
<a name="ln-712"></a>               <span class="k">do </span><span class="n">j</span> <span class="o">=</span> <span class="n">jb</span><span class="p">,</span> <span class="n">je</span>
<a name="ln-713"></a>                  <span class="n">qt0</span><span class="p">(</span><span class="n">ib</span> <span class="o">-</span> <span class="mi">1</span><span class="p">,</span> <span class="n">j</span><span class="p">,</span> <span class="n">k</span><span class="p">)</span> <span class="o">=</span> <span class="mi">2</span><span class="o">*</span><span class="n">qtprof</span><span class="p">(</span><span class="n">k</span><span class="p">)</span> <span class="o">-</span> <span class="n">qt0</span><span class="p">(</span><span class="n">ib</span><span class="p">,</span> <span class="n">j</span><span class="p">,</span> <span class="n">k</span><span class="p">)</span> <span class="c">!watch!</span>
<a name="ln-714"></a>                  <span class="n">qtm</span><span class="p">(</span><span class="n">ib</span> <span class="o">-</span> <span class="mi">1</span><span class="p">,</span> <span class="n">j</span><span class="p">,</span> <span class="n">k</span><span class="p">)</span> <span class="o">=</span> <span class="mi">2</span><span class="o">*</span><span class="n">qtprof</span><span class="p">(</span><span class="n">k</span><span class="p">)</span> <span class="o">-</span> <span class="n">qtm</span><span class="p">(</span><span class="n">ib</span><span class="p">,</span> <span class="n">j</span><span class="p">,</span> <span class="n">k</span><span class="p">)</span>
<a name="ln-715"></a>               <span class="k">end do</span>
<a name="ln-716"></a><span class="k">            end do</span>
<a name="ln-717"></a><span class="k">         end if</span>
<a name="ln-718"></a>
<a name="ln-719"></a>    <span class="c">! Driver inlet</span>
<a name="ln-720"></a>    <span class="n">elseif</span> <span class="p">(</span><span class="n">idriver</span> <span class="o">==</span> <span class="mi">2</span><span class="p">)</span> <span class="k">then</span>
<a name="ln-721"></a><span class="k">       do </span><span class="n">j</span><span class="o">=</span><span class="n">jb</span><span class="o">-</span><span class="mi">1</span><span class="p">,</span><span class="n">je</span><span class="o">+</span><span class="mi">1</span>
<a name="ln-722"></a>         <span class="k">do </span><span class="n">k</span><span class="o">=</span><span class="n">kb</span><span class="p">,</span><span class="n">ke</span> <span class="c">!tg3315 removed +1 following above...</span>
<a name="ln-723"></a>           <span class="n">u0</span><span class="p">(</span><span class="n">ib</span><span class="p">,</span><span class="n">j</span><span class="p">,</span><span class="n">k</span><span class="p">)</span><span class="o">=</span><span class="n">u0driver</span><span class="p">(</span><span class="n">j</span><span class="p">,</span><span class="n">k</span><span class="p">)</span> <span class="c">!max(0.,u0driver(j,k))</span>
<a name="ln-724"></a>           <span class="n">um</span><span class="p">(</span><span class="n">ib</span><span class="p">,</span><span class="n">j</span><span class="p">,</span><span class="n">k</span><span class="p">)</span><span class="o">=</span><span class="n">umdriver</span><span class="p">(</span><span class="n">j</span><span class="p">,</span><span class="n">k</span><span class="p">)</span> <span class="c">!max(0.,umdriver(j,k))</span>
<a name="ln-725"></a>           <span class="n">u0</span><span class="p">(</span><span class="n">ib</span><span class="o">-</span><span class="mi">1</span><span class="p">,</span><span class="n">j</span><span class="p">,</span><span class="n">k</span><span class="p">)</span><span class="o">=</span> <span class="n">u0driver</span><span class="p">(</span><span class="n">j</span><span class="p">,</span><span class="n">k</span><span class="p">)</span> <span class="c">!max(0.,2.*u0(ib,j,k)-u0(ib+1,j,k))</span>
<a name="ln-726"></a>           <span class="n">um</span><span class="p">(</span><span class="n">ib</span><span class="o">-</span><span class="mi">1</span><span class="p">,</span><span class="n">j</span><span class="p">,</span><span class="n">k</span><span class="p">)</span><span class="o">=</span> <span class="n">umdriver</span><span class="p">(</span><span class="n">j</span><span class="p">,</span><span class="n">k</span><span class="p">)</span>  <span class="c">!max(0.,2.*um(ib,j,k)-um(ib+1,j,k))</span>
<a name="ln-727"></a>
<a name="ln-728"></a>           <span class="n">v0</span><span class="p">(</span><span class="n">ib</span><span class="p">,</span><span class="n">j</span><span class="p">,</span><span class="n">k</span><span class="p">)</span>   <span class="o">=</span> <span class="n">v0driver</span><span class="p">(</span><span class="n">j</span><span class="p">,</span><span class="n">k</span><span class="p">)</span> <span class="c">!max(0.,v0driver(j,k))</span>
<a name="ln-729"></a>           <span class="n">vm</span><span class="p">(</span><span class="n">ib</span><span class="p">,</span><span class="n">j</span><span class="p">,</span><span class="n">k</span><span class="p">)</span>   <span class="o">=</span> <span class="n">vmdriver</span><span class="p">(</span><span class="n">j</span><span class="p">,</span><span class="n">k</span><span class="p">)</span> <span class="c">!max(0.,vmdriver(j,k))</span>
<a name="ln-730"></a>           <span class="n">v0</span><span class="p">(</span><span class="n">ib</span><span class="o">-</span><span class="mi">1</span><span class="p">,</span><span class="n">j</span><span class="p">,</span><span class="n">k</span><span class="p">)</span>   <span class="o">=</span> <span class="n">v0driver</span><span class="p">(</span><span class="n">j</span><span class="p">,</span><span class="n">k</span><span class="p">)</span> <span class="c">!max(0.,v0driver(j,k))</span>
<a name="ln-731"></a>           <span class="n">vm</span><span class="p">(</span><span class="n">ib</span><span class="o">-</span><span class="mi">1</span><span class="p">,</span><span class="n">j</span><span class="p">,</span><span class="n">k</span><span class="p">)</span>   <span class="o">=</span> <span class="n">vmdriver</span><span class="p">(</span><span class="n">j</span><span class="p">,</span><span class="n">k</span><span class="p">)</span> <span class="c">!max(0.,vmdriver(j,k))</span>
<a name="ln-732"></a>
<a name="ln-733"></a>           <span class="c">! to be changed in the future: e12 should be taken from recycle plane!</span>
<a name="ln-734"></a>           <span class="c">!e120(ib-1,j,k) = e120driver(j,k)      ! extrapolate e12 from interior</span>
<a name="ln-735"></a>           <span class="c">!e12m(ib-1,j,k) = e12mdriver(j,k)      ! extrapolate e12 from interior</span>
<a name="ln-736"></a>             
<a name="ln-737"></a>           <span class="k">do </span><span class="n">n</span><span class="o">=</span><span class="mi">1</span><span class="p">,</span><span class="n">nsv</span>
<a name="ln-738"></a>              <span class="k">do </span><span class="n">m</span> <span class="o">=</span> <span class="mi">1</span><span class="p">,</span><span class="n">ihc</span>
<a name="ln-739"></a>                 <span class="n">sv0</span><span class="p">(</span><span class="n">ib</span><span class="o">-</span><span class="n">m</span><span class="p">,</span><span class="n">j</span><span class="p">,</span><span class="n">k</span><span class="p">,</span><span class="n">n</span><span class="p">)</span> <span class="o">=</span> <span class="n">sv0driver</span><span class="p">(</span><span class="n">j</span><span class="p">,</span><span class="n">k</span><span class="p">,</span><span class="n">n</span><span class="p">)</span>
<a name="ln-740"></a>                 <span class="n">svm</span><span class="p">(</span><span class="n">ib</span><span class="o">-</span><span class="n">m</span><span class="p">,</span><span class="n">j</span><span class="p">,</span><span class="n">k</span><span class="p">,</span><span class="n">n</span><span class="p">)</span> <span class="o">=</span> <span class="n">svmdriver</span><span class="p">(</span><span class="n">j</span><span class="p">,</span><span class="n">k</span><span class="p">,</span><span class="n">n</span><span class="p">)</span>
<a name="ln-741"></a>                 <span class="c">!sv0(ib-m,j,k,n) = 2*svprof(k,n) - sv0(ib+(m-1),j,k,n)</span>
<a name="ln-742"></a>                 <span class="c">!svm(ib-m,j,k,n) = 2*svprof(k,n) - svm(ib+(m-1),j,k,n)</span>
<a name="ln-743"></a>              <span class="n">enddo</span>
<a name="ln-744"></a>              <span class="n">sv0</span><span class="p">(</span><span class="n">ib</span><span class="p">,</span><span class="n">j</span><span class="p">,</span><span class="n">k</span><span class="p">,</span><span class="n">n</span><span class="p">)</span> <span class="o">=</span> <span class="n">sv0driver</span><span class="p">(</span><span class="n">j</span><span class="p">,</span><span class="n">k</span><span class="p">,</span><span class="n">n</span><span class="p">)</span>
<a name="ln-745"></a>              <span class="n">svm</span><span class="p">(</span><span class="n">ib</span><span class="p">,</span><span class="n">j</span><span class="p">,</span><span class="n">k</span><span class="p">,</span><span class="n">n</span><span class="p">)</span> <span class="o">=</span> <span class="n">svmdriver</span><span class="p">(</span><span class="n">j</span><span class="p">,</span><span class="n">k</span><span class="p">,</span><span class="n">n</span><span class="p">)</span>
<a name="ln-746"></a>           <span class="n">enddo</span>
<a name="ln-747"></a>         <span class="k">end do</span>
<a name="ln-748"></a><span class="k">         do </span><span class="n">k</span><span class="o">=</span><span class="n">kb</span><span class="p">,</span><span class="n">ke</span><span class="o">+</span><span class="mi">1</span>
<a name="ln-749"></a>           <span class="n">w0</span><span class="p">(</span><span class="n">ib</span><span class="o">-</span><span class="mi">1</span><span class="p">,</span><span class="n">j</span><span class="p">,</span><span class="n">k</span><span class="p">)</span>   <span class="o">=</span> <span class="n">w0driver</span><span class="p">(</span><span class="n">j</span><span class="p">,</span><span class="n">k</span><span class="p">)</span> <span class="c">!max(0.,w0driver(j,k))</span>
<a name="ln-750"></a>           <span class="n">wm</span><span class="p">(</span><span class="n">ib</span><span class="o">-</span><span class="mi">1</span><span class="p">,</span><span class="n">j</span><span class="p">,</span><span class="n">k</span><span class="p">)</span>   <span class="o">=</span> <span class="n">wmdriver</span><span class="p">(</span><span class="n">j</span><span class="p">,</span><span class="n">k</span><span class="p">)</span> <span class="c">!max(0.,wmdriver(j,k))</span>
<a name="ln-751"></a>           <span class="n">w0</span><span class="p">(</span><span class="n">ib</span><span class="p">,</span><span class="n">j</span><span class="p">,</span><span class="n">k</span><span class="p">)</span>   <span class="o">=</span> <span class="n">w0driver</span><span class="p">(</span><span class="n">j</span><span class="p">,</span><span class="n">k</span><span class="p">)</span> <span class="c">!max(0.,w0driver(j,k))</span>
<a name="ln-752"></a>           <span class="n">wm</span><span class="p">(</span><span class="n">ib</span><span class="p">,</span><span class="n">j</span><span class="p">,</span><span class="n">k</span><span class="p">)</span>   <span class="o">=</span> <span class="n">wmdriver</span><span class="p">(</span><span class="n">j</span><span class="p">,</span><span class="n">k</span><span class="p">)</span> <span class="c">!max(0.,wmdriver(j,k))</span>
<a name="ln-753"></a>         <span class="k">end do</span>
<a name="ln-754"></a><span class="k">       end do</span>
<a name="ln-755"></a>
<a name="ln-756"></a>       <span class="c">! Heat</span>
<a name="ln-757"></a>       <span class="k">if</span> <span class="p">(</span><span class="n">ltempeq</span> <span class="p">)</span> <span class="k">then</span>
<a name="ln-758"></a><span class="k">          do </span><span class="n">j</span><span class="o">=</span><span class="n">jb</span><span class="o">-</span><span class="mi">1</span><span class="p">,</span><span class="n">je</span><span class="o">+</span><span class="mi">1</span>
<a name="ln-759"></a>             <span class="k">do </span><span class="n">k</span><span class="o">=</span><span class="n">kb</span><span class="p">,</span><span class="n">ke</span><span class="o">+</span><span class="mi">1</span>
<a name="ln-760"></a>                <span class="n">thl0</span><span class="p">(</span><span class="n">ib</span><span class="p">,</span><span class="n">j</span><span class="p">,</span><span class="n">k</span><span class="p">)</span> <span class="o">=</span> <span class="n">thl0driver</span><span class="p">(</span><span class="n">j</span><span class="p">,</span><span class="n">k</span><span class="p">)</span>
<a name="ln-761"></a>                <span class="n">thlm</span><span class="p">(</span><span class="n">ib</span><span class="p">,</span><span class="n">j</span><span class="p">,</span><span class="n">k</span><span class="p">)</span> <span class="o">=</span> <span class="n">thlmdriver</span><span class="p">(</span><span class="n">j</span><span class="p">,</span><span class="n">k</span><span class="p">)</span>
<a name="ln-762"></a>                <span class="n">thl0</span><span class="p">(</span><span class="n">ib</span><span class="o">-</span><span class="mi">1</span><span class="p">,</span><span class="n">j</span><span class="p">,</span><span class="n">k</span><span class="p">)</span> <span class="o">=</span> <span class="n">thl0driver</span><span class="p">(</span><span class="n">j</span><span class="p">,</span><span class="n">k</span><span class="p">)</span>
<a name="ln-763"></a>                <span class="n">thlm</span><span class="p">(</span><span class="n">ib</span><span class="o">-</span><span class="mi">1</span><span class="p">,</span><span class="n">j</span><span class="p">,</span><span class="n">k</span><span class="p">)</span> <span class="o">=</span> <span class="n">thlmdriver</span><span class="p">(</span><span class="n">j</span><span class="p">,</span><span class="n">k</span><span class="p">)</span>
<a name="ln-764"></a>                <span class="c">!thlm(ib-1,j,k) = 2*thlm(ib,j,k) - thlm(ib+1,j,k)</span>
<a name="ln-765"></a>                <span class="c">!thl0(ib-1,j,k) = 2*thl0(ib,j,k) - thl0(ib+1,j,k)</span>
<a name="ln-766"></a>             <span class="k">end do</span>
<a name="ln-767"></a><span class="k">          end do</span>
<a name="ln-768"></a><span class="k">       end if</span>
<a name="ln-769"></a>
<a name="ln-770"></a><span class="k">       if</span> <span class="p">(</span><span class="n">lmoist</span> <span class="p">)</span> <span class="k">then</span>
<a name="ln-771"></a><span class="k">          do </span><span class="n">j</span><span class="o">=</span><span class="n">jb</span><span class="o">-</span><span class="mi">1</span><span class="p">,</span><span class="n">je</span><span class="o">+</span><span class="mi">1</span>
<a name="ln-772"></a>             <span class="k">do </span><span class="n">k</span><span class="o">=</span><span class="n">kb</span><span class="p">,</span><span class="n">ke</span><span class="o">+</span><span class="mi">1</span>
<a name="ln-773"></a>                <span class="n">qt0</span><span class="p">(</span><span class="n">ib</span><span class="p">,</span><span class="n">j</span><span class="p">,</span><span class="n">k</span><span class="p">)</span> <span class="o">=</span> <span class="n">qt0driver</span><span class="p">(</span><span class="n">j</span><span class="p">,</span><span class="n">k</span><span class="p">)</span>
<a name="ln-774"></a>                <span class="c">! qt0(ib-1,j,k) = 2*qtprof(k) - qt0(ib,j,k)</span>
<a name="ln-775"></a>                <span class="n">qtm</span><span class="p">(</span><span class="n">ib</span><span class="p">,</span><span class="n">j</span><span class="p">,</span><span class="n">k</span><span class="p">)</span> <span class="o">=</span> <span class="n">qtmdriver</span><span class="p">(</span><span class="n">j</span><span class="p">,</span><span class="n">k</span><span class="p">)</span>
<a name="ln-776"></a>                <span class="c">! qtm(ib-1,j,k) = 2*qtprof(k) - qtm(ib,j,k)</span>
<a name="ln-777"></a>                <span class="n">qt0</span><span class="p">(</span><span class="n">ib</span><span class="o">-</span><span class="mi">1</span><span class="p">,</span><span class="n">j</span><span class="p">,</span><span class="n">k</span><span class="p">)</span> <span class="o">=</span> <span class="n">qt0driver</span><span class="p">(</span><span class="n">j</span><span class="p">,</span><span class="n">k</span><span class="p">)</span>
<a name="ln-778"></a>                <span class="c">! qt0(ib-1,j,k) = 2*qtprof(k) - qt0(ib,j,k)  !watch!</span>
<a name="ln-779"></a>                <span class="n">qtm</span><span class="p">(</span><span class="n">ib</span><span class="o">-</span><span class="mi">1</span><span class="p">,</span><span class="n">j</span><span class="p">,</span><span class="n">k</span><span class="p">)</span> <span class="o">=</span> <span class="n">qtmdriver</span><span class="p">(</span><span class="n">j</span><span class="p">,</span><span class="n">k</span><span class="p">)</span>
<a name="ln-780"></a>                <span class="c">! qtm(ib-1,j,k) = 2*qtprof(k) - qtm(ib,j,k)</span>
<a name="ln-781"></a>                <span class="c">! qt0(ib-1,j,k) = 2*qt0(ib,j,k) - qt0(ib+1,j,k)</span>
<a name="ln-782"></a>                <span class="c">! qtm(ib-1,j,k) = 2*qtm(ib,j,k) - qtm(ib+1,j,k)</span>
<a name="ln-783"></a>             <span class="k">end do</span>
<a name="ln-784"></a><span class="k">          end do</span>
<a name="ln-785"></a><span class="k">       end if</span>
<a name="ln-786"></a>
<a name="ln-787"></a><span class="k">       else</span> <span class="c">! (if iinetgen==0)</span>
<a name="ln-788"></a>
<a name="ln-789"></a>         <span class="k">do </span><span class="n">j</span> <span class="o">=</span> <span class="n">jb</span> <span class="o">-</span> <span class="mi">1</span><span class="p">,</span> <span class="n">je</span> <span class="o">+</span> <span class="mi">1</span>
<a name="ln-790"></a>            <span class="k">do </span><span class="n">k</span> <span class="o">=</span> <span class="n">kb</span><span class="p">,</span> <span class="n">ke</span> <span class="o">+</span> <span class="mi">1</span>
<a name="ln-791"></a>               <span class="c">! Momentum</span>
<a name="ln-792"></a>               <span class="n">u0</span><span class="p">(</span><span class="n">ib</span><span class="p">,</span> <span class="n">j</span><span class="p">,</span> <span class="n">k</span><span class="p">)</span> <span class="o">=</span> <span class="n">uprof</span><span class="p">(</span><span class="n">k</span><span class="p">)</span>
<a name="ln-793"></a>               <span class="n">um</span><span class="p">(</span><span class="n">ib</span><span class="p">,</span> <span class="n">j</span><span class="p">,</span> <span class="n">k</span><span class="p">)</span> <span class="o">=</span> <span class="n">uprof</span><span class="p">(</span><span class="n">k</span><span class="p">)</span>
<a name="ln-794"></a>
<a name="ln-795"></a>               <span class="n">v0</span><span class="p">(</span><span class="n">ib</span> <span class="o">-</span> <span class="mi">1</span><span class="p">,</span> <span class="n">j</span><span class="p">,</span> <span class="n">k</span><span class="p">)</span> <span class="o">=</span> <span class="mi">2</span><span class="o">*</span><span class="n">vprof</span><span class="p">(</span><span class="n">k</span><span class="p">)</span> <span class="o">-</span> <span class="n">v0</span><span class="p">(</span><span class="n">ib</span><span class="p">,</span> <span class="n">j</span><span class="p">,</span> <span class="n">k</span><span class="p">)</span> <span class="c">! (v(ib)+v(ib-1))/2 = vprof</span>
<a name="ln-796"></a>               <span class="n">vm</span><span class="p">(</span><span class="n">ib</span> <span class="o">-</span> <span class="mi">1</span><span class="p">,</span> <span class="n">j</span><span class="p">,</span> <span class="n">k</span><span class="p">)</span> <span class="o">=</span> <span class="mi">2</span><span class="o">*</span><span class="n">vprof</span><span class="p">(</span><span class="n">k</span><span class="p">)</span> <span class="o">-</span> <span class="n">vm</span><span class="p">(</span><span class="n">ib</span><span class="p">,</span> <span class="n">j</span><span class="p">,</span> <span class="n">k</span><span class="p">)</span> <span class="c">! (v(ib)+v(ib-1))/2 = vprof</span>
<a name="ln-797"></a>
<a name="ln-798"></a>               <span class="n">e120</span><span class="p">(</span><span class="n">ib</span> <span class="o">-</span> <span class="mi">1</span><span class="p">,</span> <span class="n">j</span><span class="p">,</span> <span class="n">k</span><span class="p">)</span> <span class="o">=</span> <span class="mi">2</span><span class="o">*</span><span class="n">e12prof</span><span class="p">(</span><span class="n">k</span><span class="p">)</span> <span class="o">-</span> <span class="n">e120</span><span class="p">(</span><span class="n">ib</span><span class="p">,</span> <span class="n">j</span><span class="p">,</span> <span class="n">k</span><span class="p">)</span> <span class="c">! (e12(ib)+e12(ib-1))/2=e12prof</span>
<a name="ln-799"></a>               <span class="n">e12m</span><span class="p">(</span><span class="n">ib</span> <span class="o">-</span> <span class="mi">1</span><span class="p">,</span> <span class="n">j</span><span class="p">,</span> <span class="n">k</span><span class="p">)</span> <span class="o">=</span> <span class="mi">2</span><span class="o">*</span><span class="n">e12prof</span><span class="p">(</span><span class="n">k</span><span class="p">)</span> <span class="o">-</span> <span class="n">e12m</span><span class="p">(</span><span class="n">ib</span><span class="p">,</span> <span class="n">j</span><span class="p">,</span> <span class="n">k</span><span class="p">)</span> <span class="c">! (e12(ib)+e12(ib-1))/2=e12prof</span>
<a name="ln-800"></a>
<a name="ln-801"></a>               <span class="k">do </span><span class="n">n</span> <span class="o">=</span> <span class="mi">1</span><span class="p">,</span> <span class="n">nsv</span>
<a name="ln-802"></a>                  <span class="k">do </span><span class="n">m</span> <span class="o">=</span> <span class="mi">1</span><span class="p">,</span> <span class="n">ihc</span>
<a name="ln-803"></a>                     <span class="n">sv0</span><span class="p">(</span><span class="n">ib</span> <span class="o">-</span> <span class="n">m</span><span class="p">,</span> <span class="n">j</span><span class="p">,</span> <span class="n">k</span><span class="p">,</span> <span class="n">n</span><span class="p">)</span> <span class="o">=</span> <span class="mi">2</span><span class="o">*</span><span class="n">svprof</span><span class="p">(</span><span class="n">k</span><span class="p">,</span> <span class="n">n</span><span class="p">)</span> <span class="o">-</span> <span class="n">sv0</span><span class="p">(</span><span class="n">ib</span> <span class="o">+</span> <span class="p">(</span><span class="n">m</span> <span class="o">-</span> <span class="mi">1</span><span class="p">),</span> <span class="n">j</span><span class="p">,</span> <span class="n">k</span><span class="p">,</span> <span class="n">n</span><span class="p">)</span>
<a name="ln-804"></a>                     <span class="n">svm</span><span class="p">(</span><span class="n">ib</span> <span class="o">-</span> <span class="n">m</span><span class="p">,</span> <span class="n">j</span><span class="p">,</span> <span class="n">k</span><span class="p">,</span> <span class="n">n</span><span class="p">)</span> <span class="o">=</span> <span class="mi">2</span><span class="o">*</span><span class="n">svprof</span><span class="p">(</span><span class="n">k</span><span class="p">,</span> <span class="n">n</span><span class="p">)</span> <span class="o">-</span> <span class="n">svm</span><span class="p">(</span><span class="n">ib</span> <span class="o">+</span> <span class="p">(</span><span class="n">m</span> <span class="o">-</span> <span class="mi">1</span><span class="p">),</span> <span class="n">j</span><span class="p">,</span> <span class="n">k</span><span class="p">,</span> <span class="n">n</span><span class="p">)</span>
<a name="ln-805"></a>                  <span class="k">end do</span>
<a name="ln-806"></a><span class="k">               end do</span>
<a name="ln-807"></a>               <span class="c">!end if</span>
<a name="ln-808"></a>
<a name="ln-809"></a>            <span class="n">enddo</span>
<a name="ln-810"></a>         <span class="n">enddo</span>
<a name="ln-811"></a>
<a name="ln-812"></a>         <span class="c">! Heat</span>
<a name="ln-813"></a>         <span class="k">if</span> <span class="p">(</span><span class="n">ltempeq</span><span class="p">)</span> <span class="k">then</span>
<a name="ln-814"></a><span class="k">            do </span><span class="n">j</span> <span class="o">=</span> <span class="n">jb</span> <span class="o">-</span> <span class="mi">1</span><span class="p">,</span> <span class="n">je</span> <span class="o">+</span> <span class="mi">1</span>
<a name="ln-815"></a>               <span class="k">do </span><span class="n">k</span> <span class="o">=</span> <span class="n">kb</span><span class="p">,</span> <span class="n">ke</span> <span class="o">+</span> <span class="mi">1</span>
<a name="ln-816"></a>                  <span class="n">thl0</span><span class="p">(</span><span class="n">ib</span> <span class="o">-</span> <span class="mi">1</span><span class="p">,</span> <span class="n">j</span><span class="p">,</span> <span class="n">k</span><span class="p">)</span> <span class="o">=</span> <span class="mi">2</span><span class="o">*</span><span class="n">thlprof</span><span class="p">(</span><span class="n">k</span><span class="p">)</span> <span class="o">-</span> <span class="n">thl0</span><span class="p">(</span><span class="n">ib</span><span class="p">,</span> <span class="n">j</span><span class="p">,</span> <span class="n">k</span><span class="p">)</span>
<a name="ln-817"></a>                  <span class="n">thlm</span><span class="p">(</span><span class="n">ib</span> <span class="o">-</span> <span class="mi">1</span><span class="p">,</span> <span class="n">j</span><span class="p">,</span> <span class="n">k</span><span class="p">)</span> <span class="o">=</span> <span class="mi">2</span><span class="o">*</span><span class="n">thlprof</span><span class="p">(</span><span class="n">k</span><span class="p">)</span> <span class="o">-</span> <span class="n">thlm</span><span class="p">(</span><span class="n">ib</span><span class="p">,</span> <span class="n">j</span><span class="p">,</span> <span class="n">k</span><span class="p">)</span>
<a name="ln-818"></a>               <span class="k">end do</span>
<a name="ln-819"></a><span class="k">            end do</span>
<a name="ln-820"></a><span class="k">         end if</span>
<a name="ln-821"></a>
<a name="ln-822"></a><span class="k">         if</span> <span class="p">(</span><span class="n">lmoist</span><span class="p">)</span> <span class="k">then</span>
<a name="ln-823"></a><span class="k">            do </span><span class="n">j</span> <span class="o">=</span> <span class="n">jb</span> <span class="o">-</span> <span class="mi">1</span><span class="p">,</span> <span class="n">je</span> <span class="o">+</span> <span class="mi">1</span>
<a name="ln-824"></a>               <span class="k">do </span><span class="n">k</span> <span class="o">=</span> <span class="n">kb</span><span class="p">,</span> <span class="n">ke</span> <span class="o">+</span> <span class="mi">1</span>
<a name="ln-825"></a>                  <span class="n">qt0</span><span class="p">(</span><span class="n">ib</span> <span class="o">-</span> <span class="mi">1</span><span class="p">,</span> <span class="n">j</span><span class="p">,</span> <span class="n">k</span><span class="p">)</span> <span class="o">=</span> <span class="mi">2</span><span class="o">*</span><span class="n">qtprof</span><span class="p">(</span><span class="n">k</span><span class="p">)</span> <span class="o">-</span> <span class="n">qt0</span><span class="p">(</span><span class="n">ib</span><span class="p">,</span> <span class="n">j</span><span class="p">,</span> <span class="n">k</span><span class="p">)</span>
<a name="ln-826"></a>                  <span class="n">qtm</span><span class="p">(</span><span class="n">ib</span> <span class="o">-</span> <span class="mi">1</span><span class="p">,</span> <span class="n">j</span><span class="p">,</span> <span class="n">k</span><span class="p">)</span> <span class="o">=</span> <span class="mi">2</span><span class="o">*</span><span class="n">qtprof</span><span class="p">(</span><span class="n">k</span><span class="p">)</span> <span class="o">-</span> <span class="n">qtm</span><span class="p">(</span><span class="n">ib</span><span class="p">,</span> <span class="n">j</span><span class="p">,</span> <span class="n">k</span><span class="p">)</span>
<a name="ln-827"></a>               <span class="k">end do</span>
<a name="ln-828"></a><span class="k">            end do</span>
<a name="ln-829"></a><span class="k">         end if</span>
<a name="ln-830"></a>
<a name="ln-831"></a><span class="k">         </span><span class="n">u0</span><span class="p">(</span><span class="n">ib</span> <span class="o">-</span> <span class="mi">1</span><span class="p">,</span> <span class="p">:,</span> <span class="p">:)</span> <span class="o">=</span> <span class="mi">2</span><span class="o">*</span><span class="n">u0</span><span class="p">(</span><span class="n">ib</span><span class="p">,</span> <span class="p">:,</span> <span class="p">:)</span> <span class="o">-</span> <span class="n">u0</span><span class="p">(</span><span class="n">ib</span> <span class="o">+</span> <span class="mi">1</span><span class="p">,</span> <span class="p">:,</span> <span class="p">:)</span> <span class="c">! (u(ib+1)+u(ib-1))/2 = u(ib)</span>
<a name="ln-832"></a>         <span class="n">um</span><span class="p">(</span><span class="n">ib</span> <span class="o">-</span> <span class="mi">1</span><span class="p">,</span> <span class="p">:,</span> <span class="p">:)</span> <span class="o">=</span> <span class="mi">2</span><span class="o">*</span><span class="n">um</span><span class="p">(</span><span class="n">ib</span><span class="p">,</span> <span class="p">:,</span> <span class="p">:)</span> <span class="o">-</span> <span class="n">um</span><span class="p">(</span><span class="n">ib</span> <span class="o">+</span> <span class="mi">1</span><span class="p">,</span> <span class="p">:,</span> <span class="p">:)</span> <span class="c">! (u(ib+1)+u(ib-1))/2 = u(ib)</span>
<a name="ln-833"></a>         <span class="n">w0</span><span class="p">(</span><span class="n">ib</span> <span class="o">-</span> <span class="mi">1</span><span class="p">,</span> <span class="p">:,</span> <span class="p">:)</span> <span class="o">=</span> <span class="o">-</span><span class="n">w0</span><span class="p">(</span><span class="n">ib</span><span class="p">,</span> <span class="p">:,</span> <span class="p">:)</span> <span class="c">! (w(ib)+w(ib-1))/2 = 0</span>
<a name="ln-834"></a>         <span class="n">wm</span><span class="p">(</span><span class="n">ib</span> <span class="o">-</span> <span class="mi">1</span><span class="p">,</span> <span class="p">:,</span> <span class="p">:)</span> <span class="o">=</span> <span class="o">-</span><span class="n">wm</span><span class="p">(</span><span class="n">ib</span><span class="p">,</span> <span class="p">:,</span> <span class="p">:)</span>
<a name="ln-835"></a>      <span class="k">end if</span> <span class="c">! iinletgen==1 .or. iinletgen==2</span>
<a name="ln-836"></a>
<a name="ln-837"></a>      <span class="c">! tg3315 added to ensure that uouttot matches driven inflow regardless of forcing</span>
<a name="ln-838"></a>      <span class="c">! set up assuming we have a block at lowest cell kb</span>
<a name="ln-839"></a>      <span class="k">if</span> <span class="p">(</span><span class="n">idriver</span><span class="o">==</span><span class="mi">2</span><span class="p">)</span> <span class="k">then</span>
<a name="ln-840"></a><span class="k">         </span><span class="n">uin</span> <span class="o">=</span> <span class="mf">0.</span>
<a name="ln-841"></a>         <span class="n">uouttot</span> <span class="o">=</span> <span class="mf">0.</span>
<a name="ln-842"></a>         <span class="k">call </span><span class="n">slabsum</span><span class="p">(</span><span class="n">uin</span><span class="p">,</span><span class="n">kb</span><span class="p">,</span><span class="n">ke</span><span class="p">,</span><span class="n">um</span><span class="p">,</span><span class="n">ib</span><span class="o">-</span><span class="n">ih</span><span class="p">,</span><span class="n">ie</span><span class="o">+</span><span class="n">ih</span><span class="p">,</span><span class="n">jb</span><span class="o">-</span><span class="n">jh</span><span class="p">,</span><span class="n">je</span><span class="o">+</span><span class="n">jh</span><span class="p">,</span><span class="n">kb</span><span class="o">-</span><span class="n">kh</span><span class="p">,</span><span class="n">ke</span><span class="o">+</span><span class="n">kh</span><span class="p">,</span><span class="n">ie</span><span class="p">,</span><span class="n">ie</span><span class="p">,</span><span class="n">jb</span><span class="p">,</span><span class="n">je</span><span class="p">,</span><span class="n">kb</span><span class="p">,</span><span class="n">ke</span><span class="p">)</span> <span class="c">! determine horizontal (j) average outflow velocity old</span>
<a name="ln-843"></a>         <span class="k">do </span><span class="n">k</span><span class="o">=</span><span class="n">kb</span><span class="p">,</span><span class="n">ke</span>
<a name="ln-844"></a>            <span class="n">uin</span><span class="p">(</span><span class="n">k</span><span class="p">)</span> <span class="o">=</span> <span class="n">uin</span><span class="p">(</span><span class="n">k</span><span class="p">)</span><span class="o">*</span><span class="n">dzf</span><span class="p">(</span><span class="n">k</span><span class="p">)</span><span class="o">*</span><span class="n">dy</span>  <span class="c">! flow rate through each slab at ib</span>
<a name="ln-845"></a>         <span class="k">end do</span>
<a name="ln-846"></a><span class="k">         </span><span class="n">uouttot</span> <span class="o">=</span> <span class="nb">sum</span><span class="p">(</span><span class="n">uin</span><span class="p">(</span><span class="n">kb</span><span class="o">+</span><span class="mi">1</span><span class="p">:</span><span class="n">ke</span><span class="p">))</span><span class="o">/</span><span class="p">((</span><span class="n">zh</span><span class="p">(</span><span class="n">ke</span><span class="o">+</span><span class="mi">1</span><span class="p">)</span><span class="o">-</span><span class="n">zh</span><span class="p">(</span><span class="n">kb</span><span class="o">+</span><span class="mi">1</span><span class="p">))</span><span class="o">*</span><span class="n">jtot</span><span class="o">*</span><span class="n">dy</span><span class="p">)</span>     <span class="c">! convective outflow velocity</span>
<a name="ln-847"></a>      <span class="k">end if</span>
<a name="ln-848"></a>
<a name="ln-849"></a>      <span class="c">! Outlet</span>
<a name="ln-850"></a>      <span class="c">! Momentum</span>
<a name="ln-851"></a>      <span class="n">v0</span><span class="p">(</span><span class="n">ie</span> <span class="o">+</span> <span class="mi">1</span><span class="p">,</span> <span class="p">:,</span> <span class="p">:)</span> <span class="o">=</span> <span class="n">v0</span><span class="p">(</span><span class="n">ie</span><span class="p">,</span> <span class="p">:,</span> <span class="p">:)</span> <span class="o">-</span> <span class="p">(</span><span class="n">v0</span><span class="p">(</span><span class="n">ie</span> <span class="o">+</span> <span class="mi">1</span><span class="p">,</span> <span class="p">:,</span> <span class="p">:)</span> <span class="o">-</span> <span class="n">v0</span><span class="p">(</span><span class="n">ie</span><span class="p">,</span> <span class="p">:,</span> <span class="p">:))</span><span class="o">*</span><span class="n">dxhi</span><span class="p">(</span><span class="n">ie</span> <span class="o">+</span> <span class="mi">1</span><span class="p">)</span><span class="o">*</span><span class="n">rk3coef</span><span class="o">*</span><span class="n">uouttot</span>
<a name="ln-852"></a>      <span class="n">w0</span><span class="p">(</span><span class="n">ie</span> <span class="o">+</span> <span class="mi">1</span><span class="p">,</span> <span class="p">:,</span> <span class="p">:)</span> <span class="o">=</span> <span class="n">w0</span><span class="p">(</span><span class="n">ie</span><span class="p">,</span> <span class="p">:,</span> <span class="p">:)</span> <span class="o">-</span> <span class="p">(</span><span class="n">w0</span><span class="p">(</span><span class="n">ie</span> <span class="o">+</span> <span class="mi">1</span><span class="p">,</span> <span class="p">:,</span> <span class="p">:)</span> <span class="o">-</span> <span class="n">w0</span><span class="p">(</span><span class="n">ie</span><span class="p">,</span> <span class="p">:,</span> <span class="p">:))</span><span class="o">*</span><span class="n">dxhi</span><span class="p">(</span><span class="n">ie</span> <span class="o">+</span> <span class="mi">1</span><span class="p">)</span><span class="o">*</span><span class="n">rk3coef</span><span class="o">*</span><span class="n">uouttot</span>
<a name="ln-853"></a>      <span class="n">vm</span><span class="p">(</span><span class="n">ie</span> <span class="o">+</span> <span class="mi">1</span><span class="p">,</span> <span class="p">:,</span> <span class="p">:)</span> <span class="o">=</span> <span class="n">vm</span><span class="p">(</span><span class="n">ie</span><span class="p">,</span> <span class="p">:,</span> <span class="p">:)</span> <span class="o">-</span> <span class="p">(</span><span class="n">vm</span><span class="p">(</span><span class="n">ie</span> <span class="o">+</span> <span class="mi">1</span><span class="p">,</span> <span class="p">:,</span> <span class="p">:)</span> <span class="o">-</span> <span class="n">vm</span><span class="p">(</span><span class="n">ie</span><span class="p">,</span> <span class="p">:,</span> <span class="p">:))</span><span class="o">*</span><span class="n">dxhi</span><span class="p">(</span><span class="n">ie</span> <span class="o">+</span> <span class="mi">1</span><span class="p">)</span><span class="o">*</span><span class="n">rk3coef</span><span class="o">*</span><span class="n">uouttot</span>
<a name="ln-854"></a>      <span class="n">wm</span><span class="p">(</span><span class="n">ie</span> <span class="o">+</span> <span class="mi">1</span><span class="p">,</span> <span class="p">:,</span> <span class="p">:)</span> <span class="o">=</span> <span class="n">wm</span><span class="p">(</span><span class="n">ie</span><span class="p">,</span> <span class="p">:,</span> <span class="p">:)</span> <span class="o">-</span> <span class="p">(</span><span class="n">wm</span><span class="p">(</span><span class="n">ie</span> <span class="o">+</span> <span class="mi">1</span><span class="p">,</span> <span class="p">:,</span> <span class="p">:)</span> <span class="o">-</span> <span class="n">wm</span><span class="p">(</span><span class="n">ie</span><span class="p">,</span> <span class="p">:,</span> <span class="p">:))</span><span class="o">*</span><span class="n">dxhi</span><span class="p">(</span><span class="n">ie</span> <span class="o">+</span> <span class="mi">1</span><span class="p">)</span><span class="o">*</span><span class="n">rk3coef</span><span class="o">*</span><span class="n">uouttot</span>
<a name="ln-855"></a>      <span class="n">e120</span><span class="p">(</span><span class="n">ie</span> <span class="o">+</span> <span class="mi">1</span><span class="p">,</span> <span class="p">:,</span> <span class="p">:)</span> <span class="o">=</span> <span class="n">e120</span><span class="p">(</span><span class="n">ie</span><span class="p">,</span> <span class="p">:,</span> <span class="p">:)</span> <span class="o">-</span> <span class="p">(</span><span class="n">e120</span><span class="p">(</span><span class="n">ie</span> <span class="o">+</span> <span class="mi">1</span><span class="p">,</span> <span class="p">:,</span> <span class="p">:)</span> <span class="o">-</span> <span class="n">e120</span><span class="p">(</span><span class="n">ie</span><span class="p">,</span> <span class="p">:,</span> <span class="p">:))</span><span class="o">*</span><span class="n">dxhi</span><span class="p">(</span><span class="n">ie</span> <span class="o">+</span> <span class="mi">1</span><span class="p">)</span><span class="o">*</span><span class="n">rk3coef</span><span class="o">*</span><span class="n">uouttot</span>
<a name="ln-856"></a>      <span class="n">e12m</span><span class="p">(</span><span class="n">ie</span> <span class="o">+</span> <span class="mi">1</span><span class="p">,</span> <span class="p">:,</span> <span class="p">:)</span> <span class="o">=</span> <span class="n">e12m</span><span class="p">(</span><span class="n">ie</span><span class="p">,</span> <span class="p">:,</span> <span class="p">:)</span> <span class="o">-</span> <span class="p">(</span><span class="n">e12m</span><span class="p">(</span><span class="n">ie</span> <span class="o">+</span> <span class="mi">1</span><span class="p">,</span> <span class="p">:,</span> <span class="p">:)</span> <span class="o">-</span> <span class="n">e12m</span><span class="p">(</span><span class="n">ie</span><span class="p">,</span> <span class="p">:,</span> <span class="p">:))</span><span class="o">*</span><span class="n">dxhi</span><span class="p">(</span><span class="n">ie</span> <span class="o">+</span> <span class="mi">1</span><span class="p">)</span><span class="o">*</span><span class="n">rk3coef</span><span class="o">*</span><span class="n">uouttot</span>
<a name="ln-857"></a>
<a name="ln-858"></a>      <span class="c">! Heat</span>
<a name="ln-859"></a>      <span class="k">if</span> <span class="p">(</span><span class="n">ltempeq</span><span class="p">)</span> <span class="k">then</span>
<a name="ln-860"></a><span class="k">         </span><span class="n">thl0</span><span class="p">(</span><span class="n">ie</span> <span class="o">+</span> <span class="mi">1</span><span class="p">,</span> <span class="p">:,</span> <span class="p">:)</span> <span class="o">=</span> <span class="n">thl0</span><span class="p">(</span><span class="n">ie</span><span class="p">,</span> <span class="p">:,</span> <span class="p">:)</span> <span class="o">-</span> <span class="p">(</span><span class="n">thl0</span><span class="p">(</span><span class="n">ie</span> <span class="o">+</span> <span class="mi">1</span><span class="p">,</span> <span class="p">:,</span> <span class="p">:)</span> <span class="o">-</span> <span class="n">thl0</span><span class="p">(</span><span class="n">ie</span><span class="p">,</span> <span class="p">:,</span> <span class="p">:))</span><span class="o">*</span><span class="n">dxhi</span><span class="p">(</span><span class="n">ie</span> <span class="o">+</span> <span class="mi">1</span><span class="p">)</span><span class="o">*</span><span class="n">rk3coef</span><span class="o">*</span><span class="n">uouttot</span>
<a name="ln-861"></a>         <span class="n">thlm</span><span class="p">(</span><span class="n">ie</span> <span class="o">+</span> <span class="mi">1</span><span class="p">,</span> <span class="p">:,</span> <span class="p">:)</span> <span class="o">=</span> <span class="n">thlm</span><span class="p">(</span><span class="n">ie</span><span class="p">,</span> <span class="p">:,</span> <span class="p">:)</span> <span class="o">-</span> <span class="p">(</span><span class="n">thlm</span><span class="p">(</span><span class="n">ie</span> <span class="o">+</span> <span class="mi">1</span><span class="p">,</span> <span class="p">:,</span> <span class="p">:)</span> <span class="o">-</span> <span class="n">thlm</span><span class="p">(</span><span class="n">ie</span><span class="p">,</span> <span class="p">:,</span> <span class="p">:))</span><span class="o">*</span><span class="n">dxhi</span><span class="p">(</span><span class="n">ie</span> <span class="o">+</span> <span class="mi">1</span><span class="p">)</span><span class="o">*</span><span class="n">rk3coef</span><span class="o">*</span><span class="n">uouttot</span>
<a name="ln-862"></a>      <span class="k">end if</span>
<a name="ln-863"></a>
<a name="ln-864"></a><span class="k">      if</span> <span class="p">(</span><span class="n">lmoist</span><span class="p">)</span> <span class="k">then</span>
<a name="ln-865"></a><span class="k">         </span><span class="n">qt0</span><span class="p">(</span><span class="n">ie</span> <span class="o">+</span> <span class="mi">1</span><span class="p">,</span> <span class="p">:,</span> <span class="p">:)</span> <span class="o">=</span> <span class="n">qt0</span><span class="p">(</span><span class="n">ie</span><span class="p">,</span> <span class="p">:,</span> <span class="p">:)</span> <span class="o">-</span> <span class="p">(</span><span class="n">qt0</span><span class="p">(</span><span class="n">ie</span> <span class="o">+</span> <span class="mi">1</span><span class="p">,</span> <span class="p">:,</span> <span class="p">:)</span> <span class="o">-</span> <span class="n">qt0</span><span class="p">(</span><span class="n">ie</span><span class="p">,</span> <span class="p">:,</span> <span class="p">:))</span><span class="o">*</span><span class="n">dxhi</span><span class="p">(</span><span class="n">ie</span> <span class="o">+</span> <span class="mi">1</span><span class="p">)</span><span class="o">*</span><span class="n">rk3coef</span><span class="o">*</span><span class="n">uouttot</span>
<a name="ln-866"></a>         <span class="n">qtm</span><span class="p">(</span><span class="n">ie</span> <span class="o">+</span> <span class="mi">1</span><span class="p">,</span> <span class="p">:,</span> <span class="p">:)</span> <span class="o">=</span> <span class="n">qtm</span><span class="p">(</span><span class="n">ie</span><span class="p">,</span> <span class="p">:,</span> <span class="p">:)</span> <span class="o">-</span> <span class="p">(</span><span class="n">qtm</span><span class="p">(</span><span class="n">ie</span> <span class="o">+</span> <span class="mi">1</span><span class="p">,</span> <span class="p">:,</span> <span class="p">:)</span> <span class="o">-</span> <span class="n">qtm</span><span class="p">(</span><span class="n">ie</span><span class="p">,</span> <span class="p">:,</span> <span class="p">:))</span><span class="o">*</span><span class="n">dxhi</span><span class="p">(</span><span class="n">ie</span> <span class="o">+</span> <span class="mi">1</span><span class="p">)</span><span class="o">*</span><span class="n">rk3coef</span><span class="o">*</span><span class="n">uouttot</span>
<a name="ln-867"></a>      <span class="k">end if</span>
<a name="ln-868"></a>
<a name="ln-869"></a>      <span class="c">! tg3315 !changed dxhi to dxhci!?</span>
<a name="ln-870"></a>      <span class="k">do </span><span class="n">n</span> <span class="o">=</span> <span class="mi">1</span><span class="p">,</span> <span class="n">nsv</span>
<a name="ln-871"></a>         <span class="n">sv0</span><span class="p">(</span><span class="n">ie</span> <span class="o">+</span> <span class="mi">1</span><span class="p">,</span> <span class="p">:,</span> <span class="p">:,</span> <span class="n">n</span><span class="p">)</span> <span class="o">=</span> <span class="n">sv0</span><span class="p">(</span><span class="n">ie</span><span class="p">,</span> <span class="p">:,</span> <span class="p">:,</span> <span class="n">n</span><span class="p">)</span> <span class="o">-</span> <span class="p">(</span><span class="n">sv0</span><span class="p">(</span><span class="n">ie</span> <span class="o">+</span> <span class="mi">1</span><span class="p">,</span> <span class="p">:,</span> <span class="p">:,</span> <span class="n">n</span><span class="p">)</span> <span class="o">-</span> <span class="n">sv0</span><span class="p">(</span><span class="n">ie</span><span class="p">,</span> <span class="p">:,</span> <span class="p">:,</span> <span class="n">n</span><span class="p">))</span><span class="o">*</span><span class="n">dxhci</span><span class="p">(</span><span class="n">ie</span> <span class="o">+</span> <span class="mi">1</span><span class="p">)</span><span class="o">*</span><span class="n">rk3coef</span><span class="o">*</span><span class="n">uouttot</span>
<a name="ln-872"></a>         <span class="n">svm</span><span class="p">(</span><span class="n">ie</span> <span class="o">+</span> <span class="mi">1</span><span class="p">,</span> <span class="p">:,</span> <span class="p">:,</span> <span class="n">n</span><span class="p">)</span> <span class="o">=</span> <span class="n">svm</span><span class="p">(</span><span class="n">ie</span><span class="p">,</span> <span class="p">:,</span> <span class="p">:,</span> <span class="n">n</span><span class="p">)</span> <span class="o">-</span> <span class="p">(</span><span class="n">svm</span><span class="p">(</span><span class="n">ie</span> <span class="o">+</span> <span class="mi">1</span><span class="p">,</span> <span class="p">:,</span> <span class="p">:,</span> <span class="n">n</span><span class="p">)</span> <span class="o">-</span> <span class="n">svm</span><span class="p">(</span><span class="n">ie</span><span class="p">,</span> <span class="p">:,</span> <span class="p">:,</span> <span class="n">n</span><span class="p">))</span><span class="o">*</span><span class="n">dxhci</span><span class="p">(</span><span class="n">ie</span> <span class="o">+</span> <span class="mi">1</span><span class="p">)</span><span class="o">*</span><span class="n">rk3coef</span><span class="o">*</span><span class="n">uouttot</span>
<a name="ln-873"></a>      <span class="k">end do</span>
<a name="ln-874"></a>
<a name="ln-875"></a><span class="k">      return</span>
<a name="ln-876"></a>
<a name="ln-877"></a><span class="k">   end subroutine </span><span class="n">iolet</span>
<a name="ln-878"></a>
<a name="ln-879"></a>   <span class="c">!&gt;set boundary conditions pup,pvp,pwp in subroutine fillps in modpois.f90</span>
<a name="ln-880"></a>   <span class="k">subroutine </span><span class="n">bcpup</span><span class="p">(</span><span class="n">pup</span><span class="p">,</span> <span class="n">pvp</span><span class="p">,</span> <span class="n">pwp</span><span class="p">,</span> <span class="n">rk3coef</span><span class="p">)</span>
<a name="ln-881"></a>
<a name="ln-882"></a>      <span class="k">use </span><span class="n">modglobal</span><span class="p">,</span> <span class="n">only</span><span class="p">:</span><span class="n">ib</span><span class="p">,</span> <span class="n">ie</span><span class="p">,</span> <span class="n">jb</span><span class="p">,</span> <span class="n">je</span><span class="p">,</span> <span class="n">ih</span><span class="p">,</span> <span class="n">jh</span><span class="p">,</span> <span class="n">kb</span><span class="p">,</span> <span class="n">ke</span><span class="p">,</span> <span class="n">kh</span><span class="p">,</span> <span class="n">linoutflow</span><span class="p">,</span> <span class="n">dxfi</span><span class="p">,</span> <span class="n">iinletgen</span><span class="p">,</span> <span class="p">&amp;</span>
<a name="ln-883"></a>         <span class="n">Uinf</span><span class="p">,</span> <span class="n">libm</span><span class="p">,</span> <span class="n">jmax</span><span class="p">,</span> <span class="n">idriver</span>
<a name="ln-884"></a>      <span class="k">use </span><span class="n">modfields</span><span class="p">,</span> <span class="n">only</span><span class="p">:</span><span class="n">pres0</span><span class="p">,</span> <span class="n">up</span><span class="p">,</span> <span class="n">vp</span><span class="p">,</span> <span class="n">wp</span><span class="p">,</span> <span class="n">um</span><span class="p">,</span> <span class="n">w0</span><span class="p">,</span> <span class="n">u0</span><span class="p">,</span> <span class="n">uouttot</span>
<a name="ln-885"></a>      <span class="k">use </span><span class="n">modmpi</span><span class="p">,</span> <span class="n">only</span><span class="p">:</span><span class="n">excjs</span><span class="p">,</span> <span class="n">myid</span>
<a name="ln-886"></a>      <span class="k">use </span><span class="n">modinletdata</span><span class="p">,</span> <span class="n">only</span><span class="p">:</span><span class="n">irecy</span><span class="p">,</span> <span class="n">u0inletbc</span><span class="p">,</span> <span class="n">ddispdx</span><span class="p">,</span> <span class="n">u0driver</span> 
<a name="ln-887"></a>
<a name="ln-888"></a>      <span class="kt">real</span><span class="p">,</span> <span class="k">dimension</span><span class="p">(</span><span class="n">ib</span> <span class="o">-</span> <span class="n">ih</span><span class="p">:</span><span class="n">ie</span> <span class="o">+</span> <span class="n">ih</span><span class="p">,</span> <span class="n">jb</span> <span class="o">-</span> <span class="n">jh</span><span class="p">:</span><span class="n">je</span> <span class="o">+</span> <span class="n">jh</span><span class="p">,</span> <span class="n">kb</span><span class="p">:</span><span class="n">ke</span> <span class="o">+</span> <span class="n">kh</span><span class="p">),</span> <span class="k">intent</span><span class="p">(</span><span class="n">inout</span><span class="p">)</span> <span class="kd">::</span> <span class="n">pup</span>
<a name="ln-889"></a>      <span class="kt">real</span><span class="p">,</span> <span class="k">dimension</span><span class="p">(</span><span class="n">ib</span> <span class="o">-</span> <span class="n">ih</span><span class="p">:</span><span class="n">ie</span> <span class="o">+</span> <span class="n">ih</span><span class="p">,</span> <span class="n">jb</span> <span class="o">-</span> <span class="n">jh</span><span class="p">:</span><span class="n">je</span> <span class="o">+</span> <span class="n">jh</span><span class="p">,</span> <span class="n">kb</span><span class="p">:</span><span class="n">ke</span> <span class="o">+</span> <span class="n">kh</span><span class="p">),</span> <span class="k">intent</span><span class="p">(</span><span class="n">inout</span><span class="p">)</span> <span class="kd">::</span> <span class="n">pvp</span>
<a name="ln-890"></a>      <span class="kt">real</span><span class="p">,</span> <span class="k">dimension</span><span class="p">(</span><span class="n">ib</span> <span class="o">-</span> <span class="n">ih</span><span class="p">:</span><span class="n">ie</span> <span class="o">+</span> <span class="n">ih</span><span class="p">,</span> <span class="n">jb</span> <span class="o">-</span> <span class="n">jh</span><span class="p">:</span><span class="n">je</span> <span class="o">+</span> <span class="n">jh</span><span class="p">,</span> <span class="n">kb</span><span class="p">:</span><span class="n">ke</span> <span class="o">+</span> <span class="n">kh</span><span class="p">),</span> <span class="k">intent</span><span class="p">(</span><span class="n">inout</span><span class="p">)</span> <span class="kd">::</span> <span class="n">pwp</span>
<a name="ln-891"></a>
<a name="ln-892"></a>      <span class="kt">real</span><span class="p">,</span> <span class="k">intent</span><span class="p">(</span><span class="n">in</span><span class="p">)</span> <span class="kd">::</span> <span class="n">rk3coef</span>
<a name="ln-893"></a>      <span class="kt">real </span><span class="n">rk3coefi</span>
<a name="ln-894"></a>
<a name="ln-895"></a>      <span class="kt">integer </span><span class="n">i</span><span class="p">,</span> <span class="n">j</span><span class="p">,</span> <span class="n">k</span>
<a name="ln-896"></a>
<a name="ln-897"></a>      <span class="n">rk3coefi</span> <span class="o">=</span> <span class="mf">1.</span><span class="o">/</span><span class="n">rk3coef</span>
<a name="ln-898"></a>      <span class="k">if</span> <span class="p">(</span><span class="n">linoutflow</span><span class="p">)</span> <span class="k">then</span>
<a name="ln-899"></a><span class="k">         if</span> <span class="p">((</span><span class="n">iinletgen</span> <span class="o">==</span> <span class="mi">1</span><span class="p">)</span> <span class="p">.</span><span class="nb">or</span><span class="p">.</span> <span class="p">(</span><span class="n">iinletgen</span> <span class="o">==</span> <span class="mi">2</span><span class="p">))</span> <span class="k">then</span>
<a name="ln-900"></a><span class="k">            do </span><span class="n">j</span> <span class="o">=</span> <span class="n">jb</span><span class="p">,</span> <span class="n">je</span>
<a name="ln-901"></a>               <span class="k">do </span><span class="n">i</span> <span class="o">=</span> <span class="n">ib</span><span class="p">,</span> <span class="n">ie</span>
<a name="ln-902"></a>                  <span class="n">pwp</span><span class="p">(</span><span class="n">i</span><span class="p">,</span> <span class="n">j</span><span class="p">,</span> <span class="n">kb</span><span class="p">)</span> <span class="o">=</span> <span class="mf">0.</span>
<a name="ln-903"></a>                  <span class="n">pwp</span><span class="p">(</span><span class="n">i</span><span class="p">,</span> <span class="n">j</span><span class="p">,</span> <span class="n">ke</span> <span class="o">+</span> <span class="n">kh</span><span class="p">)</span> <span class="o">=</span> <span class="p">(</span><span class="n">Uinf</span><span class="o">*</span><span class="n">ddispdx</span><span class="p">)</span><span class="o">*</span><span class="n">rk3coefi</span>
<a name="ln-904"></a>               <span class="k">end do</span>
<a name="ln-905"></a><span class="k">            end do</span>
<a name="ln-906"></a><span class="k">            do </span><span class="n">k</span> <span class="o">=</span> <span class="n">kb</span><span class="p">,</span> <span class="n">ke</span>
<a name="ln-907"></a>               <span class="k">do </span><span class="n">j</span> <span class="o">=</span> <span class="n">jb</span><span class="p">,</span> <span class="n">je</span>
<a name="ln-908"></a>                  <span class="n">pup</span><span class="p">(</span><span class="n">ie</span> <span class="o">+</span> <span class="mi">1</span><span class="p">,</span> <span class="n">j</span><span class="p">,</span> <span class="n">k</span><span class="p">)</span> <span class="o">=</span> <span class="o">-</span><span class="p">(</span><span class="n">u0</span><span class="p">(</span><span class="n">ie</span> <span class="o">+</span> <span class="mi">1</span><span class="p">,</span> <span class="n">j</span><span class="p">,</span> <span class="n">k</span><span class="p">)</span> <span class="o">-</span> <span class="n">u0</span><span class="p">(</span><span class="n">ie</span><span class="p">,</span> <span class="n">j</span><span class="p">,</span> <span class="n">k</span><span class="p">))</span><span class="o">*</span><span class="n">dxfi</span><span class="p">(</span><span class="n">ie</span><span class="p">)</span><span class="o">*</span><span class="n">uouttot</span> <span class="o">+</span> <span class="n">um</span><span class="p">(</span><span class="n">ie</span> <span class="o">+</span> <span class="mi">1</span><span class="p">,</span> <span class="n">j</span><span class="p">,</span> <span class="n">k</span><span class="p">)</span><span class="o">*</span><span class="n">rk3coefi</span> <span class="c">! du/dt +u*du/dx=0 -&gt; pup(i)=um(i)/rk3coef -um(i)*(um(i)-um(i-1))/dxf(i-1)</span>
<a name="ln-909"></a>                  <span class="n">pup</span><span class="p">(</span><span class="n">ib</span><span class="p">,</span> <span class="n">j</span><span class="p">,</span> <span class="n">k</span><span class="p">)</span> <span class="o">=</span> <span class="n">u0inletbc</span><span class="p">(</span><span class="n">j</span><span class="p">,</span> <span class="n">k</span><span class="p">)</span><span class="o">*</span><span class="n">rk3coefi</span>
<a name="ln-910"></a>               <span class="k">end do</span>
<a name="ln-911"></a><span class="k">            end do</span>
<a name="ln-912"></a><span class="k">       </span><span class="n">elseif</span> <span class="p">(</span><span class="n">idriver</span> <span class="o">==</span> <span class="mi">2</span><span class="p">)</span> <span class="k">then</span>
<a name="ln-913"></a><span class="k">          do </span><span class="n">j</span><span class="o">=</span><span class="n">jb</span><span class="p">,</span><span class="n">je</span>
<a name="ln-914"></a>             <span class="k">do </span><span class="n">i</span><span class="o">=</span><span class="n">ib</span><span class="p">,</span><span class="n">ie</span>
<a name="ln-915"></a>                <span class="n">pwp</span><span class="p">(</span><span class="n">i</span><span class="p">,</span><span class="n">j</span><span class="p">,</span><span class="n">kb</span><span class="p">)</span>  <span class="o">=</span> <span class="mf">0.</span>
<a name="ln-916"></a>                <span class="n">pwp</span><span class="p">(</span><span class="n">i</span><span class="p">,</span><span class="n">j</span><span class="p">,</span><span class="n">ke</span><span class="o">+</span><span class="n">kh</span><span class="p">)</span><span class="o">=</span> <span class="mf">0.</span> <span class="c">!(Uinf*ddispdx ) *rk3coefi ! tg3315 - idriver does not use Uinf ddisp etc.</span>
<a name="ln-917"></a>             <span class="k">end do</span>
<a name="ln-918"></a><span class="k">          end do</span>
<a name="ln-919"></a><span class="k">          do </span><span class="n">k</span><span class="o">=</span><span class="n">kb</span><span class="p">,</span><span class="n">ke</span>
<a name="ln-920"></a>             <span class="k">do </span><span class="n">j</span><span class="o">=</span><span class="n">jb</span><span class="p">,</span><span class="n">je</span>
<a name="ln-921"></a>                <span class="n">pup</span><span class="p">(</span><span class="n">ie</span><span class="o">+</span><span class="mi">1</span><span class="p">,</span><span class="n">j</span><span class="p">,</span><span class="n">k</span><span class="p">)</span> <span class="o">=</span> <span class="o">-</span> <span class="p">(</span><span class="n">u0</span><span class="p">(</span><span class="n">ie</span><span class="o">+</span><span class="mi">1</span><span class="p">,</span><span class="n">j</span><span class="p">,</span><span class="n">k</span><span class="p">)</span><span class="o">-</span><span class="n">u0</span><span class="p">(</span><span class="n">ie</span><span class="p">,</span><span class="n">j</span><span class="p">,</span><span class="n">k</span><span class="p">))</span><span class="o">*</span><span class="n">dxfi</span><span class="p">(</span><span class="n">ie</span><span class="p">)</span><span class="o">*</span><span class="n">uouttot</span> <span class="o">+</span> <span class="n">um</span><span class="p">(</span><span class="n">ie</span><span class="o">+</span><span class="mi">1</span><span class="p">,</span><span class="n">j</span><span class="p">,</span><span class="n">k</span><span class="p">)</span><span class="o">*</span><span class="n">rk3coefi</span>   <span class="c">! du/dt +u*du/dx=0 -&gt; pup(i)=um(i)/rk3coef -um(i)*(um(i)-um(i-1))/dxf(i-1)</span>
<a name="ln-922"></a>                <span class="n">pup</span><span class="p">(</span><span class="n">ib</span><span class="p">,</span><span class="n">j</span><span class="p">,</span><span class="n">k</span><span class="p">)</span> <span class="o">=</span> <span class="n">u0driver</span><span class="p">(</span><span class="n">j</span><span class="p">,</span><span class="n">k</span><span class="p">)</span><span class="o">*</span><span class="n">rk3coefi</span>
<a name="ln-923"></a>             <span class="k">end do</span>
<a name="ln-924"></a><span class="k">          end do </span>
<a name="ln-925"></a><span class="k">         else</span> <span class="c">! if not iinletgen</span>
<a name="ln-926"></a>            <span class="k">do </span><span class="n">j</span> <span class="o">=</span> <span class="n">jb</span><span class="p">,</span> <span class="n">je</span>
<a name="ln-927"></a>               <span class="k">do </span><span class="n">i</span> <span class="o">=</span> <span class="n">ib</span><span class="p">,</span> <span class="n">ie</span>
<a name="ln-928"></a>                  <span class="n">pwp</span><span class="p">(</span><span class="n">i</span><span class="p">,</span> <span class="n">j</span><span class="p">,</span> <span class="n">kb</span><span class="p">)</span> <span class="o">=</span> <span class="mf">0.</span>
<a name="ln-929"></a>                  <span class="n">pwp</span><span class="p">(</span><span class="n">i</span><span class="p">,</span> <span class="n">j</span><span class="p">,</span> <span class="n">ke</span> <span class="o">+</span> <span class="n">kh</span><span class="p">)</span> <span class="o">=</span> <span class="mf">0.</span>
<a name="ln-930"></a>               <span class="k">end do</span>
<a name="ln-931"></a><span class="k">            end do</span>
<a name="ln-932"></a><span class="k">            do </span><span class="n">k</span> <span class="o">=</span> <span class="n">kb</span><span class="p">,</span> <span class="n">ke</span>
<a name="ln-933"></a>               <span class="k">do </span><span class="n">j</span> <span class="o">=</span> <span class="n">jb</span><span class="p">,</span> <span class="n">je</span>
<a name="ln-934"></a>                  <span class="n">pup</span><span class="p">(</span><span class="n">ie</span> <span class="o">+</span> <span class="mi">1</span><span class="p">,</span> <span class="n">j</span><span class="p">,</span> <span class="n">k</span><span class="p">)</span> <span class="o">=</span> <span class="o">-</span><span class="p">(</span><span class="n">u0</span><span class="p">(</span><span class="n">ie</span> <span class="o">+</span> <span class="mi">1</span><span class="p">,</span> <span class="n">j</span><span class="p">,</span> <span class="n">k</span><span class="p">)</span> <span class="o">-</span> <span class="n">u0</span><span class="p">(</span><span class="n">ie</span><span class="p">,</span> <span class="n">j</span><span class="p">,</span> <span class="n">k</span><span class="p">))</span><span class="o">*</span><span class="n">dxfi</span><span class="p">(</span><span class="n">ie</span><span class="p">)</span><span class="o">*</span><span class="n">uouttot</span> <span class="o">+</span> <span class="n">um</span><span class="p">(</span><span class="n">ie</span> <span class="o">+</span> <span class="mi">1</span><span class="p">,</span> <span class="n">j</span><span class="p">,</span> <span class="n">k</span><span class="p">)</span><span class="o">*</span><span class="n">rk3coefi</span> <span class="c">! du/dt +u*du/dx=0 -&gt; pup(i)=um(i)/rk3coef -um(i)*(um(i)-um(i-1))/dxf(i-1)</span>
<a name="ln-935"></a>                  <span class="n">pup</span><span class="p">(</span><span class="n">ib</span><span class="p">,</span> <span class="n">j</span><span class="p">,</span> <span class="n">k</span><span class="p">)</span> <span class="o">=</span> <span class="n">pup</span><span class="p">(</span><span class="n">ib</span><span class="p">,</span> <span class="n">j</span><span class="p">,</span> <span class="n">k</span><span class="p">)</span> <span class="o">-</span> <span class="n">up</span><span class="p">(</span><span class="n">ib</span><span class="p">,</span> <span class="n">j</span><span class="p">,</span> <span class="n">k</span><span class="p">)</span> <span class="c">! pup(ib)= up(ib) + um(ib)/rk3coef, where up should be zero!</span>
<a name="ln-936"></a>               <span class="k">end do</span>
<a name="ln-937"></a><span class="k">            end do</span>
<a name="ln-938"></a><span class="k">         end if</span> <span class="c">! inletgen</span>
<a name="ln-939"></a>      <span class="k">else</span> <span class="c">! if not linoutflow</span>
<a name="ln-940"></a>         <span class="k">do </span><span class="n">j</span> <span class="o">=</span> <span class="n">jb</span><span class="p">,</span> <span class="n">je</span>
<a name="ln-941"></a>            <span class="k">do </span><span class="n">i</span> <span class="o">=</span> <span class="n">ib</span><span class="p">,</span> <span class="n">ie</span>
<a name="ln-942"></a>               <span class="n">pwp</span><span class="p">(</span><span class="n">i</span><span class="p">,</span> <span class="n">j</span><span class="p">,</span> <span class="n">kb</span><span class="p">)</span> <span class="o">=</span> <span class="mf">0.</span>
<a name="ln-943"></a>               <span class="n">pwp</span><span class="p">(</span><span class="n">i</span><span class="p">,</span> <span class="n">j</span><span class="p">,</span> <span class="n">ke</span> <span class="o">+</span> <span class="n">kh</span><span class="p">)</span> <span class="o">=</span> <span class="mf">0.</span>
<a name="ln-944"></a>            <span class="k">end do</span>
<a name="ln-945"></a><span class="k">         end do</span>
<a name="ln-946"></a><span class="k">         do </span><span class="n">k</span> <span class="o">=</span> <span class="n">kb</span><span class="p">,</span> <span class="n">ke</span>
<a name="ln-947"></a>            <span class="k">do </span><span class="n">j</span> <span class="o">=</span> <span class="n">jb</span><span class="p">,</span> <span class="n">je</span>
<a name="ln-948"></a>               <span class="n">pup</span><span class="p">(</span><span class="n">ie</span> <span class="o">+</span> <span class="mi">1</span><span class="p">,</span> <span class="n">j</span><span class="p">,</span> <span class="n">k</span><span class="p">)</span> <span class="o">=</span> <span class="n">pup</span><span class="p">(</span><span class="n">ib</span><span class="p">,</span> <span class="n">j</span><span class="p">,</span> <span class="n">k</span><span class="p">)</span> <span class="c">! cyclic</span>
<a name="ln-949"></a>               <span class="c">!pup(ib - 1, j, k) = pup(ie, j, k) ! tg3315 is this condition not needed? Was not here before but I think exists in Dales4.0 in modpois...!?</span>
<a name="ln-950"></a>            <span class="k">end do</span>
<a name="ln-951"></a><span class="k">         end do</span>
<a name="ln-952"></a><span class="k">      </span><span class="n">endif</span>
<a name="ln-953"></a>
<a name="ln-954"></a>      <span class="k">call </span><span class="n">excjs</span><span class="p">(</span><span class="n">pup</span><span class="p">,</span> <span class="n">ib</span><span class="p">,</span> <span class="n">ie</span><span class="p">,</span> <span class="n">jb</span><span class="p">,</span> <span class="n">je</span><span class="p">,</span> <span class="n">kb</span><span class="p">,</span> <span class="n">ke</span> <span class="o">+</span> <span class="n">kh</span><span class="p">,</span> <span class="n">ih</span><span class="p">,</span> <span class="n">jh</span><span class="p">)</span> <span class="c">! cyclic</span>
<a name="ln-955"></a>      <span class="k">call </span><span class="n">excjs</span><span class="p">(</span><span class="n">pvp</span><span class="p">,</span> <span class="n">ib</span><span class="p">,</span> <span class="n">ie</span><span class="p">,</span> <span class="n">jb</span><span class="p">,</span> <span class="n">je</span><span class="p">,</span> <span class="n">kb</span><span class="p">,</span> <span class="n">ke</span> <span class="o">+</span> <span class="n">kh</span><span class="p">,</span> <span class="n">ih</span><span class="p">,</span> <span class="n">jh</span><span class="p">)</span> <span class="c">! cyclic</span>
<a name="ln-956"></a>      <span class="k">call </span><span class="n">excjs</span><span class="p">(</span><span class="n">pwp</span><span class="p">,</span> <span class="n">ib</span><span class="p">,</span> <span class="n">ie</span><span class="p">,</span> <span class="n">jb</span><span class="p">,</span> <span class="n">je</span><span class="p">,</span> <span class="n">kb</span><span class="p">,</span> <span class="n">ke</span> <span class="o">+</span> <span class="n">kh</span><span class="p">,</span> <span class="n">ih</span><span class="p">,</span> <span class="n">jh</span><span class="p">)</span> <span class="c">! cyclic</span>
<a name="ln-957"></a>
<a name="ln-958"></a>   <span class="k">end subroutine </span><span class="n">bcpup</span>
<a name="ln-959"></a>
<a name="ln-960"></a>   <span class="c">!&gt;set pressure boundary conditions</span>
<a name="ln-961"></a>   <span class="k">subroutine </span><span class="n">bcp</span><span class="p">(</span><span class="n">p</span><span class="p">)</span>
<a name="ln-962"></a>
<a name="ln-963"></a>      <span class="k">use </span><span class="n">modglobal</span><span class="p">,</span> <span class="n">only</span><span class="p">:</span><span class="n">ib</span><span class="p">,</span> <span class="n">ie</span><span class="p">,</span> <span class="n">jb</span><span class="p">,</span> <span class="n">je</span><span class="p">,</span> <span class="n">ih</span><span class="p">,</span> <span class="n">jh</span><span class="p">,</span> <span class="n">kb</span><span class="p">,</span> <span class="n">ke</span><span class="p">,</span> <span class="n">kh</span><span class="p">,</span> <span class="n">linoutflow</span><span class="p">,</span> <span class="n">dxfi</span>
<a name="ln-964"></a>      <span class="k">use </span><span class="n">modfields</span><span class="p">,</span> <span class="n">only</span><span class="p">:</span><span class="n">pres0</span><span class="p">,</span> <span class="n">up</span><span class="p">,</span> <span class="n">u0</span><span class="p">,</span> <span class="n">um</span><span class="p">,</span> <span class="n">uouttot</span>
<a name="ln-965"></a>      <span class="k">use </span><span class="n">modmpi</span><span class="p">,</span> <span class="n">only</span><span class="p">:</span><span class="n">excj</span>
<a name="ln-966"></a>
<a name="ln-967"></a>      <span class="kt">real</span><span class="p">,</span> <span class="k">dimension</span><span class="p">(</span><span class="n">ib</span> <span class="o">-</span> <span class="n">ih</span><span class="p">:</span><span class="n">ie</span> <span class="o">+</span> <span class="n">ih</span><span class="p">,</span> <span class="n">jb</span> <span class="o">-</span> <span class="n">jh</span><span class="p">:</span><span class="n">je</span> <span class="o">+</span> <span class="n">jh</span><span class="p">,</span> <span class="n">kb</span> <span class="o">-</span> <span class="n">kh</span><span class="p">:</span><span class="n">ke</span> <span class="o">+</span> <span class="n">kh</span><span class="p">),</span> <span class="k">intent</span><span class="p">(</span><span class="n">inout</span><span class="p">)</span> <span class="kd">::</span> <span class="n">p</span> <span class="c">!&lt; pressure</span>
<a name="ln-968"></a>      <span class="kt">integer </span><span class="n">i</span><span class="p">,</span> <span class="n">j</span><span class="p">,</span> <span class="n">k</span>
<a name="ln-969"></a>
<a name="ln-970"></a>      <span class="k">if</span> <span class="p">(</span><span class="n">linoutflow</span><span class="p">)</span> <span class="k">then</span>
<a name="ln-971"></a><span class="k">         do </span><span class="n">k</span> <span class="o">=</span> <span class="n">kb</span><span class="p">,</span> <span class="n">ke</span>
<a name="ln-972"></a>            <span class="k">do </span><span class="n">j</span> <span class="o">=</span> <span class="n">jb</span><span class="p">,</span> <span class="n">je</span>
<a name="ln-973"></a>               <span class="n">p</span><span class="p">(</span><span class="n">ib</span> <span class="o">-</span> <span class="mi">1</span><span class="p">,</span> <span class="n">j</span><span class="p">,</span> <span class="n">k</span><span class="p">)</span> <span class="o">=</span> <span class="n">p</span><span class="p">(</span><span class="n">ib</span><span class="p">,</span> <span class="n">j</span><span class="p">,</span> <span class="n">k</span><span class="p">)</span> <span class="c">! inflow:  dp/dn=0</span>
<a name="ln-974"></a>               <span class="n">pres0</span><span class="p">(</span><span class="n">ib</span> <span class="o">-</span> <span class="mi">1</span><span class="p">,</span> <span class="n">j</span><span class="p">,</span> <span class="n">k</span><span class="p">)</span> <span class="o">=</span> <span class="n">pres0</span><span class="p">(</span><span class="n">ib</span><span class="p">,</span> <span class="n">j</span><span class="p">,</span> <span class="n">k</span><span class="p">)</span> <span class="c">! inflow:  dp/dn=0</span>
<a name="ln-975"></a>               <span class="n">p</span><span class="p">(</span><span class="n">ie</span> <span class="o">+</span> <span class="mi">1</span><span class="p">,</span> <span class="n">j</span><span class="p">,</span> <span class="n">k</span><span class="p">)</span> <span class="o">=</span> <span class="o">-</span><span class="n">p</span><span class="p">(</span><span class="n">ie</span><span class="p">,</span> <span class="n">j</span><span class="p">,</span> <span class="n">k</span><span class="p">)</span> <span class="c">! outflow: p=0</span>
<a name="ln-976"></a>               <span class="n">pres0</span><span class="p">(</span><span class="n">ie</span> <span class="o">+</span> <span class="mi">1</span><span class="p">,</span> <span class="n">j</span><span class="p">,</span> <span class="n">k</span><span class="p">)</span> <span class="o">=</span> <span class="o">-</span><span class="n">pres0</span><span class="p">(</span><span class="n">ie</span><span class="p">,</span> <span class="n">j</span><span class="p">,</span> <span class="n">k</span><span class="p">)</span> <span class="c">! outflow: p=0</span>
<a name="ln-977"></a>               <span class="n">up</span><span class="p">(</span><span class="n">ie</span> <span class="o">+</span> <span class="mi">1</span><span class="p">,</span> <span class="n">j</span><span class="p">,</span> <span class="n">k</span><span class="p">)</span> <span class="o">=</span> <span class="o">-</span><span class="p">(</span><span class="n">u0</span><span class="p">(</span><span class="n">ie</span> <span class="o">+</span> <span class="mi">1</span><span class="p">,</span> <span class="n">j</span><span class="p">,</span> <span class="n">k</span><span class="p">)</span> <span class="o">-</span> <span class="n">u0</span><span class="p">(</span><span class="n">ie</span><span class="p">,</span> <span class="n">j</span><span class="p">,</span> <span class="n">k</span><span class="p">))</span><span class="o">*</span><span class="n">dxfi</span><span class="p">(</span><span class="n">ie</span><span class="p">)</span><span class="o">*</span><span class="n">uouttot</span>
<a name="ln-978"></a>            <span class="n">enddo</span>
<a name="ln-979"></a>         <span class="n">enddo</span>
<a name="ln-980"></a>      <span class="k">else</span>
<a name="ln-981"></a><span class="k">         do </span><span class="n">k</span> <span class="o">=</span> <span class="n">kb</span><span class="p">,</span> <span class="n">ke</span>
<a name="ln-982"></a>            <span class="k">do </span><span class="n">j</span> <span class="o">=</span> <span class="n">jb</span><span class="p">,</span> <span class="n">je</span>
<a name="ln-983"></a>               <span class="n">p</span><span class="p">(</span><span class="n">ib</span> <span class="o">-</span> <span class="mi">1</span><span class="p">,</span> <span class="n">j</span><span class="p">,</span> <span class="n">k</span><span class="p">)</span> <span class="o">=</span> <span class="n">p</span><span class="p">(</span><span class="n">ie</span><span class="p">,</span> <span class="n">j</span><span class="p">,</span> <span class="n">k</span><span class="p">)</span>
<a name="ln-984"></a>               <span class="n">p</span><span class="p">(</span><span class="n">ie</span> <span class="o">+</span> <span class="mi">1</span><span class="p">,</span> <span class="n">j</span><span class="p">,</span> <span class="n">k</span><span class="p">)</span> <span class="o">=</span> <span class="n">p</span><span class="p">(</span><span class="n">ib</span><span class="p">,</span> <span class="n">j</span><span class="p">,</span> <span class="n">k</span><span class="p">)</span>
<a name="ln-985"></a>            <span class="n">enddo</span>
<a name="ln-986"></a>         <span class="n">enddo</span>
<a name="ln-987"></a>      <span class="n">endif</span>
<a name="ln-988"></a>
<a name="ln-989"></a>      <span class="k">call </span><span class="n">excj</span><span class="p">(</span><span class="n">p</span><span class="p">,</span> <span class="n">ib</span> <span class="o">-</span> <span class="mi">1</span><span class="p">,</span> <span class="n">ie</span> <span class="o">+</span> <span class="mi">1</span><span class="p">,</span> <span class="n">jb</span> <span class="o">-</span> <span class="mi">1</span><span class="p">,</span> <span class="n">je</span> <span class="o">+</span> <span class="mi">1</span><span class="p">,</span> <span class="n">kb</span> <span class="o">-</span> <span class="mi">1</span><span class="p">,</span> <span class="n">ke</span> <span class="o">+</span> <span class="mi">1</span><span class="p">)</span> <span class="c">! cyclic</span>
<a name="ln-990"></a>      <span class="k">call </span><span class="n">excj</span><span class="p">(</span><span class="n">pres0</span><span class="p">,</span> <span class="n">ib</span> <span class="o">-</span> <span class="mi">1</span><span class="p">,</span> <span class="n">ie</span> <span class="o">+</span> <span class="mi">1</span><span class="p">,</span> <span class="n">jb</span> <span class="o">-</span> <span class="mi">1</span><span class="p">,</span> <span class="n">je</span> <span class="o">+</span> <span class="mi">1</span><span class="p">,</span> <span class="n">kb</span> <span class="o">-</span> <span class="mi">1</span><span class="p">,</span> <span class="n">ke</span> <span class="o">+</span> <span class="mi">1</span><span class="p">)</span> <span class="c">! cyclic</span>
<a name="ln-991"></a>
<a name="ln-992"></a>   <span class="k">end subroutine </span><span class="n">bcp</span>
<a name="ln-993"></a>
<a name="ln-994"></a>   <span class="c">!&gt;</span>
<a name="ln-995"></a>   <span class="c">!! grwdamp damps gravity waves in the upper part of the domain.</span>
<a name="ln-996"></a>   <span class="c">!&gt;</span>
<a name="ln-997"></a>   <span class="c">!! The lower limit of the damping region is set by ksp</span>
<a name="ln-998"></a>   <span class="c">!! Horizontal fluctuations at the top of the domain (for instance gravity waves)</span>
<a name="ln-999"></a>   <span class="c">!! are damped out by a sponge layer through an additional forcing/source term.</span>
<a name="ln-1000"></a>   <span class="c">!! \latexonly</span>
<a name="ln-1001"></a>   <span class="c">!! \begin{eqnarray}</span>
<a name="ln-1002"></a>   <span class="c">!! \force{i}{sp}(z) &amp;=&amp; -\frac{1}{t^{\mr{sp}}}\left(\xav{\fav{u_i}}-\fav{u_i}\right), \\\\</span>
<a name="ln-1003"></a>   <span class="c">!!  \source{\varphi}{sp}(z) &amp;=&amp; -\frac{1}{t^{\mr{sp}}}\left(\xav{\varphi}-\varphi\right),</span>
<a name="ln-1004"></a>   <span class="c">!! \end{eqnarray}</span>
<a name="ln-1005"></a>   <span class="c">!! with $t^{\mr{sp}}$ a relaxation time scale that goes from</span>
<a name="ln-1006"></a>   <span class="c">!! $t^{\mr{sp}}_0=1/(2.75\times10^{-3})\mr{s}\approx 6$min at the top of the domain</span>
<a name="ln-1007"></a>   <span class="c">!! to infinity at the bottom of the sponge layer.</span>
<a name="ln-1008"></a>   <span class="c">!! \endlatexonly</span>
<a name="ln-1009"></a>   <span class="k">subroutine </span><span class="n">grwdamp</span>
<a name="ln-1010"></a>      <span class="k">use </span><span class="n">modglobal</span><span class="p">,</span> <span class="n">only</span><span class="p">:</span><span class="n">ke</span><span class="p">,</span> <span class="n">kmax</span><span class="p">,</span> <span class="n">lcoriol</span><span class="p">,</span> <span class="n">igrw_damp</span><span class="p">,</span> <span class="n">geodamptime</span>
<a name="ln-1011"></a>      <span class="k">use </span><span class="n">modfields</span><span class="p">,</span> <span class="n">only</span><span class="p">:</span><span class="n">up</span><span class="p">,</span> <span class="n">vp</span><span class="p">,</span> <span class="n">wp</span><span class="p">,</span> <span class="n">thlp</span><span class="p">,</span> <span class="n">qtp</span><span class="p">,</span> <span class="n">u0</span><span class="p">,</span> <span class="n">v0</span><span class="p">,</span> <span class="n">w0</span><span class="p">,</span> <span class="n">thl0</span><span class="p">,</span> <span class="n">qt0</span><span class="p">,</span> <span class="n">ug</span><span class="p">,</span> <span class="n">vg</span><span class="p">,</span> <span class="n">thl0av</span><span class="p">,</span> <span class="n">qt0av</span><span class="p">,</span> <span class="n">u0av</span><span class="p">,</span> <span class="n">v0av</span>
<a name="ln-1012"></a>      <span class="k">use </span><span class="n">modmpi</span><span class="p">,</span> <span class="n">only</span><span class="p">:</span><span class="n">myid</span>
<a name="ln-1013"></a>      <span class="k">implicit none</span>
<a name="ln-1014"></a>
<a name="ln-1015"></a><span class="k">      </span><span class="kt">integer </span><span class="n">k</span>
<a name="ln-1016"></a>      <span class="k">select case</span> <span class="p">(</span><span class="n">igrw_damp</span><span class="p">)</span>
<a name="ln-1017"></a>      <span class="k">case</span> <span class="p">(</span><span class="mi">0</span><span class="p">)</span> <span class="c">!do nothing</span>
<a name="ln-1018"></a>      <span class="k">case</span> <span class="p">(</span><span class="mi">1</span><span class="p">)</span>
<a name="ln-1019"></a>         <span class="k">do </span><span class="n">k</span> <span class="o">=</span> <span class="n">ksp</span><span class="p">,</span> <span class="n">ke</span>
<a name="ln-1020"></a>            <span class="n">up</span><span class="p">(:,</span> <span class="p">:,</span> <span class="n">k</span><span class="p">)</span> <span class="o">=</span> <span class="n">up</span><span class="p">(:,</span> <span class="p">:,</span> <span class="n">k</span><span class="p">)</span> <span class="o">-</span> <span class="p">(</span><span class="n">u0</span><span class="p">(:,</span> <span class="p">:,</span> <span class="n">k</span><span class="p">)</span> <span class="o">-</span> <span class="n">u0av</span><span class="p">(</span><span class="n">k</span><span class="p">))</span><span class="o">*</span><span class="n">tsc</span><span class="p">(</span><span class="n">k</span><span class="p">)</span>
<a name="ln-1021"></a>            <span class="n">vp</span><span class="p">(:,</span> <span class="p">:,</span> <span class="n">k</span><span class="p">)</span> <span class="o">=</span> <span class="n">vp</span><span class="p">(:,</span> <span class="p">:,</span> <span class="n">k</span><span class="p">)</span> <span class="o">-</span> <span class="p">(</span><span class="n">v0</span><span class="p">(:,</span> <span class="p">:,</span> <span class="n">k</span><span class="p">)</span> <span class="o">-</span> <span class="n">v0av</span><span class="p">(</span><span class="n">k</span><span class="p">))</span><span class="o">*</span><span class="n">tsc</span><span class="p">(</span><span class="n">k</span><span class="p">)</span>
<a name="ln-1022"></a>            <span class="n">wp</span><span class="p">(:,</span> <span class="p">:,</span> <span class="n">k</span><span class="p">)</span> <span class="o">=</span> <span class="n">wp</span><span class="p">(:,</span> <span class="p">:,</span> <span class="n">k</span><span class="p">)</span> <span class="o">-</span> <span class="n">w0</span><span class="p">(:,</span> <span class="p">:,</span> <span class="n">k</span><span class="p">)</span><span class="o">*</span><span class="n">tsc</span><span class="p">(</span><span class="n">k</span><span class="p">)</span>
<a name="ln-1023"></a>            <span class="n">thlp</span><span class="p">(:,</span> <span class="p">:,</span> <span class="n">k</span><span class="p">)</span> <span class="o">=</span> <span class="n">thlp</span><span class="p">(:,</span> <span class="p">:,</span> <span class="n">k</span><span class="p">)</span> <span class="o">-</span> <span class="p">(</span><span class="n">thl0</span><span class="p">(:,</span> <span class="p">:,</span> <span class="n">k</span><span class="p">)</span> <span class="o">-</span> <span class="n">thl0av</span><span class="p">(</span><span class="n">k</span><span class="p">))</span><span class="o">*</span><span class="n">tsc</span><span class="p">(</span><span class="n">k</span><span class="p">)</span>
<a name="ln-1024"></a>            <span class="n">qtp</span><span class="p">(:,</span> <span class="p">:,</span> <span class="n">k</span><span class="p">)</span> <span class="o">=</span> <span class="n">qtp</span><span class="p">(:,</span> <span class="p">:,</span> <span class="n">k</span><span class="p">)</span> <span class="o">-</span> <span class="p">(</span><span class="n">qt0</span><span class="p">(:,</span> <span class="p">:,</span> <span class="n">k</span><span class="p">)</span> <span class="o">-</span> <span class="n">qt0av</span><span class="p">(</span><span class="n">k</span><span class="p">))</span><span class="o">*</span><span class="n">tsc</span><span class="p">(</span><span class="n">k</span><span class="p">)</span>
<a name="ln-1025"></a>         <span class="k">end do</span>
<a name="ln-1026"></a><span class="k">         if</span> <span class="p">(</span><span class="n">lcoriol</span><span class="p">)</span> <span class="k">then</span>
<a name="ln-1027"></a><span class="k">            do </span><span class="n">k</span> <span class="o">=</span> <span class="n">ksp</span><span class="p">,</span> <span class="n">ke</span>
<a name="ln-1028"></a>               <span class="n">up</span><span class="p">(:,</span> <span class="p">:,</span> <span class="n">k</span><span class="p">)</span> <span class="o">=</span> <span class="n">up</span><span class="p">(:,</span> <span class="p">:,</span> <span class="n">k</span><span class="p">)</span> <span class="o">-</span> <span class="p">(</span><span class="n">u0</span><span class="p">(:,</span> <span class="p">:,</span> <span class="n">k</span><span class="p">)</span> <span class="o">-</span> <span class="n">ug</span><span class="p">(</span><span class="n">k</span><span class="p">))</span><span class="o">*</span><span class="p">((</span><span class="mf">1.</span><span class="o">/</span><span class="p">(</span><span class="n">geodamptime</span><span class="o">*</span><span class="n">rnu0</span><span class="p">))</span><span class="o">*</span><span class="n">tsc</span><span class="p">(</span><span class="n">k</span><span class="p">))</span>
<a name="ln-1029"></a>               <span class="n">vp</span><span class="p">(:,</span> <span class="p">:,</span> <span class="n">k</span><span class="p">)</span> <span class="o">=</span> <span class="n">vp</span><span class="p">(:,</span> <span class="p">:,</span> <span class="n">k</span><span class="p">)</span> <span class="o">-</span> <span class="p">(</span><span class="n">v0</span><span class="p">(:,</span> <span class="p">:,</span> <span class="n">k</span><span class="p">)</span> <span class="o">-</span> <span class="n">vg</span><span class="p">(</span><span class="n">k</span><span class="p">))</span><span class="o">*</span><span class="p">((</span><span class="mf">1.</span><span class="o">/</span><span class="p">(</span><span class="n">geodamptime</span><span class="o">*</span><span class="n">rnu0</span><span class="p">))</span><span class="o">*</span><span class="n">tsc</span><span class="p">(</span><span class="n">k</span><span class="p">))</span>
<a name="ln-1030"></a>            <span class="k">end do</span>
<a name="ln-1031"></a><span class="k">         end if</span>
<a name="ln-1032"></a><span class="k">      case</span> <span class="p">(</span><span class="mi">2</span><span class="p">)</span>
<a name="ln-1033"></a>         <span class="k">do </span><span class="n">k</span> <span class="o">=</span> <span class="n">ksp</span><span class="p">,</span> <span class="n">ke</span>
<a name="ln-1034"></a>            <span class="n">up</span><span class="p">(:,</span> <span class="p">:,</span> <span class="n">k</span><span class="p">)</span> <span class="o">=</span> <span class="n">up</span><span class="p">(:,</span> <span class="p">:,</span> <span class="n">k</span><span class="p">)</span> <span class="o">-</span> <span class="p">(</span><span class="n">u0</span><span class="p">(:,</span> <span class="p">:,</span> <span class="n">k</span><span class="p">)</span> <span class="o">-</span> <span class="n">ug</span><span class="p">(</span><span class="n">k</span><span class="p">))</span><span class="o">*</span><span class="n">tsc</span><span class="p">(</span><span class="n">k</span><span class="p">)</span>
<a name="ln-1035"></a>            <span class="n">vp</span><span class="p">(:,</span> <span class="p">:,</span> <span class="n">k</span><span class="p">)</span> <span class="o">=</span> <span class="n">vp</span><span class="p">(:,</span> <span class="p">:,</span> <span class="n">k</span><span class="p">)</span> <span class="o">-</span> <span class="p">(</span><span class="n">v0</span><span class="p">(:,</span> <span class="p">:,</span> <span class="n">k</span><span class="p">)</span> <span class="o">-</span> <span class="n">vg</span><span class="p">(</span><span class="n">k</span><span class="p">))</span><span class="o">*</span><span class="n">tsc</span><span class="p">(</span><span class="n">k</span><span class="p">)</span>
<a name="ln-1036"></a>            <span class="n">wp</span><span class="p">(:,</span> <span class="p">:,</span> <span class="n">k</span><span class="p">)</span> <span class="o">=</span> <span class="n">wp</span><span class="p">(:,</span> <span class="p">:,</span> <span class="n">k</span><span class="p">)</span> <span class="o">-</span> <span class="n">w0</span><span class="p">(:,</span> <span class="p">:,</span> <span class="n">k</span><span class="p">)</span><span class="o">*</span><span class="n">tsc</span><span class="p">(</span><span class="n">k</span><span class="p">)</span>
<a name="ln-1037"></a>            <span class="n">thlp</span><span class="p">(:,</span> <span class="p">:,</span> <span class="n">k</span><span class="p">)</span> <span class="o">=</span> <span class="n">thlp</span><span class="p">(:,</span> <span class="p">:,</span> <span class="n">k</span><span class="p">)</span> <span class="o">-</span> <span class="p">(</span><span class="n">thl0</span><span class="p">(:,</span> <span class="p">:,</span> <span class="n">k</span><span class="p">)</span> <span class="o">-</span> <span class="n">thl0av</span><span class="p">(</span><span class="n">k</span><span class="p">))</span><span class="o">*</span><span class="n">tsc</span><span class="p">(</span><span class="n">k</span><span class="p">)</span>
<a name="ln-1038"></a>            <span class="n">qtp</span><span class="p">(:,</span> <span class="p">:,</span> <span class="n">k</span><span class="p">)</span> <span class="o">=</span> <span class="n">qtp</span><span class="p">(:,</span> <span class="p">:,</span> <span class="n">k</span><span class="p">)</span> <span class="o">-</span> <span class="p">(</span><span class="n">qt0</span><span class="p">(:,</span> <span class="p">:,</span> <span class="n">k</span><span class="p">)</span> <span class="o">-</span> <span class="n">qt0av</span><span class="p">(</span><span class="n">k</span><span class="p">))</span><span class="o">*</span><span class="n">tsc</span><span class="p">(</span><span class="n">k</span><span class="p">)</span>
<a name="ln-1039"></a>         <span class="k">end do</span>
<a name="ln-1040"></a><span class="k">      case</span> <span class="p">(</span><span class="mi">3</span><span class="p">)</span>
<a name="ln-1041"></a>         <span class="k">do </span><span class="n">k</span> <span class="o">=</span> <span class="n">ksp</span><span class="p">,</span> <span class="n">ke</span>
<a name="ln-1042"></a>            <span class="n">up</span><span class="p">(:,</span> <span class="p">:,</span> <span class="n">k</span><span class="p">)</span> <span class="o">=</span> <span class="n">up</span><span class="p">(:,</span> <span class="p">:,</span> <span class="n">k</span><span class="p">)</span> <span class="o">-</span> <span class="p">(</span><span class="n">u0</span><span class="p">(:,</span> <span class="p">:,</span> <span class="n">k</span><span class="p">)</span> <span class="o">-</span> <span class="n">u0av</span><span class="p">(</span><span class="n">k</span><span class="p">))</span><span class="o">*</span><span class="n">tsc</span><span class="p">(</span><span class="n">k</span><span class="p">)</span>
<a name="ln-1043"></a>            <span class="n">vp</span><span class="p">(:,</span> <span class="p">:,</span> <span class="n">k</span><span class="p">)</span> <span class="o">=</span> <span class="n">vp</span><span class="p">(:,</span> <span class="p">:,</span> <span class="n">k</span><span class="p">)</span> <span class="o">-</span> <span class="p">(</span><span class="n">v0</span><span class="p">(:,</span> <span class="p">:,</span> <span class="n">k</span><span class="p">)</span> <span class="o">-</span> <span class="n">v0av</span><span class="p">(</span><span class="n">k</span><span class="p">))</span><span class="o">*</span><span class="n">tsc</span><span class="p">(</span><span class="n">k</span><span class="p">)</span>
<a name="ln-1044"></a>            <span class="n">wp</span><span class="p">(:,</span> <span class="p">:,</span> <span class="n">k</span><span class="p">)</span> <span class="o">=</span> <span class="n">wp</span><span class="p">(:,</span> <span class="p">:,</span> <span class="n">k</span><span class="p">)</span> <span class="o">-</span> <span class="n">w0</span><span class="p">(:,</span> <span class="p">:,</span> <span class="n">k</span><span class="p">)</span><span class="o">*</span><span class="n">tsc</span><span class="p">(</span><span class="n">k</span><span class="p">)</span>
<a name="ln-1045"></a>            <span class="n">thlp</span><span class="p">(:,</span> <span class="p">:,</span> <span class="n">k</span><span class="p">)</span> <span class="o">=</span> <span class="n">thlp</span><span class="p">(:,</span> <span class="p">:,</span> <span class="n">k</span><span class="p">)</span> <span class="o">-</span> <span class="p">(</span><span class="n">thl0</span><span class="p">(:,</span> <span class="p">:,</span> <span class="n">k</span><span class="p">)</span> <span class="o">-</span> <span class="n">thl0av</span><span class="p">(</span><span class="n">k</span><span class="p">))</span><span class="o">*</span><span class="n">tsc</span><span class="p">(</span><span class="n">k</span><span class="p">)</span>
<a name="ln-1046"></a>            <span class="n">qtp</span><span class="p">(:,</span> <span class="p">:,</span> <span class="n">k</span><span class="p">)</span> <span class="o">=</span> <span class="n">qtp</span><span class="p">(:,</span> <span class="p">:,</span> <span class="n">k</span><span class="p">)</span> <span class="o">-</span> <span class="p">(</span><span class="n">qt0</span><span class="p">(:,</span> <span class="p">:,</span> <span class="n">k</span><span class="p">)</span> <span class="o">-</span> <span class="n">qt0av</span><span class="p">(</span><span class="n">k</span><span class="p">))</span><span class="o">*</span><span class="n">tsc</span><span class="p">(</span><span class="n">k</span><span class="p">)</span>
<a name="ln-1047"></a>         <span class="k">end do</span>
<a name="ln-1048"></a><span class="k">      case </span><span class="n">default</span>
<a name="ln-1049"></a>         <span class="k">write</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="o">*</span><span class="p">)</span> <span class="s2">&quot;ERROR: no gravity wave damping option selected&quot;</span>
<a name="ln-1050"></a>         <span class="k">stop </span><span class="mi">1</span>
<a name="ln-1051"></a>      <span class="k">end select</span>
<a name="ln-1052"></a>
<a name="ln-1053"></a><span class="k">      return</span>
<a name="ln-1054"></a><span class="k">   end subroutine </span><span class="n">grwdamp</span>
<a name="ln-1055"></a>
<a name="ln-1056"></a>
<a name="ln-1057"></a>   <span class="k">subroutine </span><span class="n">fluxtop</span><span class="p">(</span><span class="n">field</span><span class="p">,</span> <span class="n">ek</span><span class="p">,</span> <span class="n">flux</span><span class="p">)</span>
<a name="ln-1058"></a>      <span class="k">use </span><span class="n">modglobal</span><span class="p">,</span> <span class="n">only</span><span class="p">:</span><span class="n">ib</span><span class="p">,</span> <span class="n">ie</span><span class="p">,</span> <span class="n">ih</span><span class="p">,</span> <span class="n">jb</span><span class="p">,</span> <span class="n">je</span><span class="p">,</span> <span class="n">jh</span><span class="p">,</span> <span class="n">kb</span><span class="p">,</span> <span class="n">ke</span><span class="p">,</span> <span class="n">kh</span><span class="p">,</span> <span class="n">dzf</span><span class="p">,</span> <span class="n">dzh</span><span class="p">,</span> <span class="n">dzhi</span><span class="p">,</span> <span class="n">eps1</span>
<a name="ln-1059"></a>
<a name="ln-1060"></a>      <span class="kt">real</span><span class="p">,</span> <span class="k">intent</span><span class="p">(</span><span class="n">inout</span><span class="p">)</span> <span class="kd">::</span> <span class="n">field</span><span class="p">(</span><span class="n">ib</span> <span class="o">-</span> <span class="n">ih</span><span class="p">:</span><span class="n">ie</span> <span class="o">+</span> <span class="n">ih</span><span class="p">,</span> <span class="n">jb</span> <span class="o">-</span> <span class="n">jh</span><span class="p">:</span><span class="n">je</span> <span class="o">+</span> <span class="n">jh</span><span class="p">,</span> <span class="n">kb</span> <span class="o">-</span> <span class="n">kh</span><span class="p">:</span><span class="n">ke</span> <span class="o">+</span> <span class="n">kh</span><span class="p">)</span>
<a name="ln-1061"></a>      <span class="kt">real</span><span class="p">,</span> <span class="k">intent</span><span class="p">(</span><span class="n">in</span><span class="p">)</span>    <span class="kd">::</span>    <span class="n">ek</span><span class="p">(</span><span class="n">ib</span> <span class="o">-</span> <span class="n">ih</span><span class="p">:</span><span class="n">ie</span> <span class="o">+</span> <span class="n">ih</span><span class="p">,</span> <span class="n">jb</span> <span class="o">-</span> <span class="n">jh</span><span class="p">:</span><span class="n">je</span> <span class="o">+</span> <span class="n">jh</span><span class="p">,</span> <span class="n">kb</span> <span class="o">-</span> <span class="n">kh</span><span class="p">:</span><span class="n">ke</span> <span class="o">+</span> <span class="n">kh</span><span class="p">)</span>
<a name="ln-1062"></a>      <span class="kt">real</span><span class="p">,</span> <span class="k">intent</span><span class="p">(</span><span class="n">in</span><span class="p">)</span>    <span class="kd">::</span> <span class="n">flux</span>
<a name="ln-1063"></a>      <span class="c">!</span>
<a name="ln-1064"></a>      <span class="k">if</span> <span class="p">(</span><span class="nb">abs</span><span class="p">(</span><span class="n">flux</span><span class="p">)</span> <span class="p">.</span><span class="n">le</span><span class="p">.</span> <span class="n">eps1</span><span class="p">)</span> <span class="k">then</span> <span class="c">!it&#39;s zero-flux, we don&#39;t need to do the calculation</span>
<a name="ln-1065"></a>         <span class="n">field</span><span class="p">(:,</span> <span class="p">:,</span> <span class="n">ke</span> <span class="o">+</span> <span class="mi">1</span><span class="p">)</span> <span class="o">=</span> <span class="n">field</span><span class="p">(:,</span> <span class="p">:,</span> <span class="n">ke</span><span class="p">)</span>
<a name="ln-1066"></a>      <span class="k">else</span>
<a name="ln-1067"></a><span class="k"> </span><span class="n">field</span><span class="p">(:,</span> <span class="p">:,</span> <span class="n">ke</span> <span class="o">+</span> <span class="mi">1</span><span class="p">)</span> <span class="o">=</span> <span class="n">field</span><span class="p">(:,</span> <span class="p">:,</span> <span class="n">ke</span><span class="p">)</span> <span class="o">+</span> <span class="n">dzh</span><span class="p">(</span><span class="n">ke</span> <span class="o">+</span> <span class="mi">1</span><span class="p">)</span><span class="o">*</span><span class="n">flux</span><span class="o">/</span><span class="p">(</span><span class="n">dzhi</span><span class="p">(</span><span class="n">ke</span> <span class="o">+</span> <span class="mi">1</span><span class="p">)</span><span class="o">*</span><span class="p">(</span><span class="mf">0.5</span><span class="o">*</span><span class="p">(</span><span class="n">dzf</span><span class="p">(</span><span class="n">ke</span><span class="p">)</span><span class="o">*</span><span class="n">ek</span><span class="p">(:,</span> <span class="p">:,</span> <span class="n">ke</span> <span class="o">+</span> <span class="mi">1</span><span class="p">)</span> <span class="o">+</span> <span class="n">dzf</span><span class="p">(</span><span class="n">ke</span> <span class="o">+</span> <span class="mi">1</span><span class="p">)</span><span class="o">*</span><span class="n">ek</span><span class="p">(:,</span> <span class="p">:,</span> <span class="n">ke</span><span class="p">))))</span>
<a name="ln-1068"></a>      <span class="k">end if</span>
<a name="ln-1069"></a>      <span class="c">!</span>
<a name="ln-1070"></a>   <span class="k">end subroutine </span><span class="n">fluxtop</span>
<a name="ln-1071"></a>
<a name="ln-1072"></a>   <span class="k">subroutine </span><span class="n">valuetop</span><span class="p">(</span><span class="n">field</span><span class="p">,</span> <span class="n">val</span><span class="p">)</span>
<a name="ln-1073"></a>      <span class="k">use </span><span class="n">modglobal</span><span class="p">,</span> <span class="n">only</span><span class="p">:</span><span class="n">ib</span><span class="p">,</span> <span class="n">ie</span><span class="p">,</span> <span class="n">ih</span><span class="p">,</span> <span class="n">jb</span><span class="p">,</span> <span class="n">je</span><span class="p">,</span> <span class="n">jh</span><span class="p">,</span> <span class="n">kb</span><span class="p">,</span> <span class="n">ke</span><span class="p">,</span> <span class="n">kh</span><span class="p">,</span> <span class="n">eps1</span>
<a name="ln-1074"></a>      <span class="kt">real</span><span class="p">,</span> <span class="k">intent</span><span class="p">(</span><span class="n">inout</span><span class="p">)</span> <span class="kd">::</span> <span class="n">field</span><span class="p">(</span><span class="n">ib</span> <span class="o">-</span> <span class="n">ih</span><span class="p">:</span><span class="n">ie</span> <span class="o">+</span> <span class="n">ih</span><span class="p">,</span> <span class="n">jb</span> <span class="o">-</span> <span class="n">jh</span><span class="p">:</span><span class="n">je</span> <span class="o">+</span> <span class="n">jh</span><span class="p">,</span> <span class="n">kb</span> <span class="o">-</span> <span class="n">kh</span><span class="p">:</span><span class="n">ke</span> <span class="o">+</span> <span class="n">kh</span><span class="p">)</span>
<a name="ln-1075"></a>      <span class="kt">real</span><span class="p">,</span> <span class="k">intent</span><span class="p">(</span><span class="n">in</span><span class="p">)</span>    <span class="kd">::</span> <span class="n">val</span>
<a name="ln-1076"></a>      <span class="c">!</span>
<a name="ln-1077"></a>      <span class="n">field</span><span class="p">(:,</span> <span class="p">:,</span> <span class="n">ke</span> <span class="o">+</span> <span class="mi">1</span><span class="p">)</span> <span class="o">=</span> <span class="mi">2</span><span class="o">*</span><span class="n">val</span> <span class="o">-</span> <span class="n">field</span><span class="p">(:,</span> <span class="p">:,</span> <span class="n">ke</span><span class="p">)</span>
<a name="ln-1078"></a>      <span class="c">!</span>
<a name="ln-1079"></a>   <span class="k">end subroutine </span><span class="n">valuetop</span>
<a name="ln-1080"></a>
<a name="ln-1081"></a>   <span class="k">subroutine </span><span class="n">fluxtopscal</span><span class="p">(</span><span class="n">flux</span><span class="p">)</span>
<a name="ln-1082"></a>      <span class="k">use </span><span class="n">modglobal</span><span class="p">,</span> <span class="n">only</span><span class="p">:</span><span class="n">ib</span><span class="p">,</span> <span class="n">ie</span><span class="p">,</span> <span class="n">ih</span><span class="p">,</span> <span class="n">jb</span><span class="p">,</span> <span class="n">je</span><span class="p">,</span> <span class="n">jh</span><span class="p">,</span> <span class="n">kb</span><span class="p">,</span> <span class="n">ke</span><span class="p">,</span> <span class="n">kh</span><span class="p">,</span> <span class="n">dzf</span><span class="p">,</span> <span class="n">dzh</span><span class="p">,</span> <span class="n">dzhi</span><span class="p">,</span> <span class="n">nsv</span><span class="p">,</span> <span class="n">khc</span>
<a name="ln-1083"></a>      <span class="k">use </span><span class="n">modfields</span><span class="p">,</span> <span class="n">only</span><span class="p">:</span><span class="n">sv0</span><span class="p">,</span> <span class="n">svm</span>
<a name="ln-1084"></a>      <span class="k">use </span><span class="n">modsubgriddata</span><span class="p">,</span> <span class="n">only</span><span class="p">:</span><span class="n">ekh</span>
<a name="ln-1085"></a>
<a name="ln-1086"></a>      <span class="kt">real</span><span class="p">,</span> <span class="k">intent</span><span class="p">(</span><span class="n">in</span><span class="p">)</span>    <span class="kd">::</span> <span class="n">flux</span><span class="p">(</span><span class="mi">1</span><span class="p">:</span><span class="n">nsv</span><span class="p">)</span>
<a name="ln-1087"></a>      <span class="kt">integer</span> <span class="kd">::</span> <span class="n">m</span><span class="p">,</span> <span class="n">n</span>
<a name="ln-1088"></a>      <span class="c">!</span>
<a name="ln-1089"></a>      <span class="c">!all the ghost cells have the same value?</span>
<a name="ln-1090"></a>      <span class="k">do </span><span class="n">m</span> <span class="o">=</span> <span class="mi">1</span><span class="p">,</span> <span class="n">khc</span>
<a name="ln-1091"></a>      <span class="k">do </span><span class="n">n</span> <span class="o">=</span> <span class="mi">1</span><span class="p">,</span> <span class="n">nsv</span>
<a name="ln-1092"></a>  <span class="n">sv0</span><span class="p">(</span><span class="n">ib</span><span class="o">-</span><span class="n">ih</span><span class="p">:</span><span class="n">ie</span><span class="o">+</span><span class="n">ih</span><span class="p">,</span><span class="n">jb</span><span class="o">-</span><span class="n">jh</span><span class="p">:</span><span class="n">je</span><span class="o">+</span><span class="n">jh</span><span class="p">,</span><span class="n">ke</span><span class="o">+</span><span class="n">m</span><span class="p">,</span><span class="n">n</span><span class="p">)</span> <span class="o">=</span> <span class="n">sv0</span><span class="p">(</span><span class="n">ib</span><span class="o">-</span><span class="n">ih</span><span class="p">:</span><span class="n">ie</span><span class="o">+</span><span class="n">ih</span><span class="p">,</span><span class="n">jb</span><span class="o">-</span><span class="n">jh</span><span class="p">:</span><span class="n">je</span><span class="o">+</span><span class="n">jh</span><span class="p">,</span><span class="n">ke</span><span class="p">,</span><span class="n">n</span><span class="p">)</span> <span class="o">+</span> <span class="n">dzh</span><span class="p">(</span><span class="n">ke</span><span class="o">+</span><span class="mi">1</span><span class="p">)</span> <span class="o">*</span> <span class="n">flux</span><span class="p">(</span><span class="n">n</span><span class="p">)</span> <span class="o">/</span> <span class="p">(</span> <span class="n">dzhi</span><span class="p">(</span><span class="n">ke</span><span class="o">+</span><span class="mi">1</span><span class="p">)</span> <span class="o">*</span> <span class="p">(</span><span class="mf">0.5</span><span class="o">*</span><span class="p">(</span><span class="n">dzf</span><span class="p">(</span><span class="n">ke</span><span class="p">)</span><span class="o">*</span><span class="n">ekh</span><span class="p">(</span><span class="n">ib</span><span class="o">-</span><span class="n">ih</span><span class="p">:</span><span class="n">ie</span><span class="o">+</span><span class="n">ih</span><span class="p">,</span><span class="n">jb</span><span class="o">-</span><span class="n">jh</span><span class="p">:</span><span class="n">je</span><span class="o">+</span><span class="n">jh</span><span class="p">,</span><span class="n">ke</span><span class="o">+</span><span class="mi">1</span><span class="p">)</span><span class="o">+</span><span class="n">dzf</span><span class="p">(</span><span class="n">ke</span><span class="o">+</span><span class="mi">1</span><span class="p">)</span><span class="o">*</span><span class="n">ekh</span><span class="p">(</span><span class="n">ib</span><span class="o">-</span><span class="n">ih</span><span class="p">:</span><span class="n">ie</span><span class="o">+</span><span class="n">ih</span><span class="p">,</span><span class="n">jb</span><span class="o">-</span><span class="n">jh</span><span class="p">:</span><span class="n">je</span><span class="o">+</span><span class="n">jh</span><span class="p">,</span><span class="n">ke</span><span class="p">))))</span>
<a name="ln-1093"></a>  <span class="n">svm</span><span class="p">(</span><span class="n">ib</span><span class="o">-</span><span class="n">ih</span><span class="p">:</span><span class="n">ie</span><span class="o">+</span><span class="n">ih</span><span class="p">,</span><span class="n">jb</span><span class="o">-</span><span class="n">jh</span><span class="p">:</span><span class="n">je</span><span class="o">+</span><span class="n">jh</span><span class="p">,</span><span class="n">ke</span><span class="o">+</span><span class="n">m</span><span class="p">,</span><span class="n">n</span><span class="p">)</span> <span class="o">=</span> <span class="n">svm</span><span class="p">(</span><span class="n">ib</span><span class="o">-</span><span class="n">ih</span><span class="p">:</span><span class="n">ie</span><span class="o">+</span><span class="n">ih</span><span class="p">,</span><span class="n">jb</span><span class="o">-</span><span class="n">jh</span><span class="p">:</span><span class="n">je</span><span class="o">+</span><span class="n">jh</span><span class="p">,</span><span class="n">ke</span><span class="p">,</span><span class="n">n</span><span class="p">)</span> <span class="o">+</span> <span class="n">dzh</span><span class="p">(</span><span class="n">ke</span><span class="o">+</span><span class="mi">1</span><span class="p">)</span> <span class="o">*</span> <span class="n">flux</span><span class="p">(</span><span class="n">n</span><span class="p">)</span> <span class="o">/</span> <span class="p">(</span> <span class="n">dzhi</span><span class="p">(</span><span class="n">ke</span><span class="o">+</span><span class="mi">1</span><span class="p">)</span> <span class="o">*</span> <span class="p">(</span><span class="mf">0.5</span><span class="o">*</span><span class="p">(</span><span class="n">dzf</span><span class="p">(</span><span class="n">ke</span><span class="p">)</span><span class="o">*</span><span class="n">ekh</span><span class="p">(</span><span class="n">ib</span><span class="o">-</span><span class="n">ih</span><span class="p">:</span><span class="n">ie</span><span class="o">+</span><span class="n">ih</span><span class="p">,</span><span class="n">jb</span><span class="o">-</span><span class="n">jh</span><span class="p">:</span><span class="n">je</span><span class="o">+</span><span class="n">jh</span><span class="p">,</span><span class="n">ke</span><span class="o">+</span><span class="mi">1</span><span class="p">)</span><span class="o">+</span><span class="n">dzf</span><span class="p">(</span><span class="n">ke</span><span class="o">+</span><span class="mi">1</span><span class="p">)</span><span class="o">*</span><span class="n">ekh</span><span class="p">(</span><span class="n">ib</span><span class="o">-</span><span class="n">ih</span><span class="p">:</span><span class="n">ie</span><span class="o">+</span><span class="n">ih</span><span class="p">,</span><span class="n">jb</span><span class="o">-</span><span class="n">jh</span><span class="p">:</span><span class="n">je</span><span class="o">+</span><span class="n">jh</span><span class="p">,</span><span class="n">ke</span><span class="p">))))</span>
<a name="ln-1094"></a>      <span class="k">end do</span>
<a name="ln-1095"></a><span class="k">      end do</span>
<a name="ln-1096"></a>      <span class="c">!</span>
<a name="ln-1097"></a>   <span class="k">end subroutine </span><span class="n">fluxtopscal</span>
<a name="ln-1098"></a>
<a name="ln-1099"></a>   <span class="k">subroutine </span><span class="n">valuetopscal</span><span class="p">(</span><span class="n">val</span><span class="p">)</span>
<a name="ln-1100"></a>      <span class="k">use </span><span class="n">modglobal</span><span class="p">,</span> <span class="n">only</span><span class="p">:</span><span class="n">ib</span><span class="p">,</span> <span class="n">ie</span><span class="p">,</span> <span class="n">ih</span><span class="p">,</span> <span class="n">jb</span><span class="p">,</span> <span class="n">je</span><span class="p">,</span> <span class="n">jh</span><span class="p">,</span> <span class="n">kb</span><span class="p">,</span> <span class="n">ke</span><span class="p">,</span> <span class="n">kh</span><span class="p">,</span> <span class="n">eps1</span><span class="p">,</span> <span class="n">nsv</span><span class="p">,</span> <span class="n">khc</span>
<a name="ln-1101"></a>      <span class="k">use </span><span class="n">modfields</span><span class="p">,</span> <span class="n">only</span><span class="p">:</span><span class="n">sv0</span><span class="p">,</span> <span class="n">svm</span>
<a name="ln-1102"></a>      <span class="kt">real</span><span class="p">,</span> <span class="k">intent</span><span class="p">(</span><span class="n">in</span><span class="p">)</span>    <span class="kd">::</span> <span class="n">val</span><span class="p">(</span><span class="mi">1</span><span class="p">:</span><span class="n">nsv</span><span class="p">)</span>
<a name="ln-1103"></a>      <span class="kt">integer</span> <span class="kd">::</span> <span class="n">m</span><span class="p">,</span> <span class="n">n</span>
<a name="ln-1104"></a>      <span class="c">!</span>
<a name="ln-1105"></a>      <span class="c">! all the ghost cells have the same vlaue?</span>
<a name="ln-1106"></a>      <span class="k">do </span><span class="n">m</span> <span class="o">=</span> <span class="mi">1</span><span class="p">,</span> <span class="n">khc</span>
<a name="ln-1107"></a>      <span class="k">do </span><span class="n">n</span> <span class="o">=</span> <span class="mi">1</span><span class="p">,</span> <span class="n">nsv</span>
<a name="ln-1108"></a>         <span class="n">sv0</span><span class="p">(:</span> <span class="p">,</span> <span class="p">:</span> <span class="p">,</span> <span class="n">ke</span> <span class="o">+</span> <span class="n">m</span><span class="p">,</span> <span class="n">n</span><span class="p">)</span> <span class="o">=</span> <span class="mi">2</span><span class="o">*</span><span class="n">val</span><span class="p">(</span><span class="n">n</span><span class="p">)</span> <span class="o">-</span> <span class="n">sv0</span><span class="p">(:</span> <span class="p">,</span> <span class="p">:</span> <span class="p">,</span> <span class="n">ke</span><span class="p">,</span> <span class="n">n</span><span class="p">)</span>
<a name="ln-1109"></a>         <span class="n">svm</span><span class="p">(:</span> <span class="p">,</span> <span class="p">:</span> <span class="p">,</span> <span class="n">ke</span> <span class="o">+</span> <span class="n">m</span><span class="p">,</span> <span class="n">n</span><span class="p">)</span> <span class="o">=</span> <span class="mi">2</span><span class="o">*</span><span class="n">val</span><span class="p">(</span><span class="n">n</span><span class="p">)</span> <span class="o">-</span> <span class="n">svm</span><span class="p">(:</span> <span class="p">,</span> <span class="p">:</span> <span class="p">,</span> <span class="n">ke</span><span class="p">,</span> <span class="n">n</span><span class="p">)</span>
<a name="ln-1110"></a>      <span class="k">end do</span>
<a name="ln-1111"></a><span class="k">      end do</span>
<a name="ln-1112"></a>      <span class="c">!</span>
<a name="ln-1113"></a>   <span class="k">end subroutine </span><span class="n">valuetopscal</span>
<a name="ln-1114"></a>
<a name="ln-1115"></a>   <span class="c">!&gt; Sets top boundary conditions for momentum</span>
<a name="ln-1116"></a>   <span class="k">subroutine </span><span class="n">inlettop</span>
<a name="ln-1117"></a>
<a name="ln-1118"></a>      <span class="k">use </span><span class="n">modglobal</span><span class="p">,</span> <span class="n">only</span><span class="p">:</span><span class="n">ib</span><span class="p">,</span> <span class="n">ie</span><span class="p">,</span> <span class="n">jb</span><span class="p">,</span> <span class="n">je</span><span class="p">,</span> <span class="n">kb</span><span class="p">,</span> <span class="n">ke</span><span class="p">,</span> <span class="n">ih</span><span class="p">,</span> <span class="n">jh</span><span class="p">,</span> <span class="n">kh</span><span class="p">,</span> <span class="n">dzh</span><span class="p">,</span> <span class="n">dzf</span><span class="p">,</span> <span class="p">&amp;</span>
<a name="ln-1119"></a>         <span class="n">e12min</span><span class="p">,</span> <span class="n">dxfi</span><span class="p">,</span> <span class="n">dxf</span><span class="p">,</span> <span class="n">dxhi</span><span class="p">,</span> <span class="n">xh</span><span class="p">,</span> <span class="n">jgb</span><span class="p">,</span> <span class="n">jge</span><span class="p">,</span> <span class="n">Uinf</span><span class="p">,</span> <span class="n">dzfi</span>
<a name="ln-1120"></a>      <span class="k">use </span><span class="n">modfields</span><span class="p">,</span> <span class="n">only</span><span class="p">:</span><span class="n">w0</span><span class="p">,</span> <span class="n">wm</span><span class="p">,</span> <span class="n">wout</span><span class="p">,</span> <span class="n">wouttot</span>
<a name="ln-1121"></a>      <span class="k">use </span><span class="n">modinletdata</span><span class="p">,</span> <span class="n">only</span><span class="p">:</span><span class="n">Uinl</span><span class="p">,</span> <span class="n">ddispdxold</span>
<a name="ln-1122"></a>      <span class="k">use </span><span class="n">modmpi</span><span class="p">,</span> <span class="n">only</span><span class="p">:</span><span class="n">slabsumi</span><span class="p">,</span> <span class="n">myid</span>
<a name="ln-1123"></a>      <span class="k">implicit none</span>
<a name="ln-1124"></a><span class="k">      </span><span class="kt">integer</span> <span class="kd">::</span> <span class="n">i</span>
<a name="ln-1125"></a>      <span class="kt">real</span>    <span class="kd">::</span> <span class="n">nji</span>
<a name="ln-1126"></a>
<a name="ln-1127"></a>      <span class="k">do </span><span class="n">i</span> <span class="o">=</span> <span class="n">ib</span><span class="p">,</span> <span class="n">ie</span>
<a name="ln-1128"></a>         <span class="n">w0</span><span class="p">(</span><span class="n">i</span><span class="p">,</span> <span class="p">:,</span> <span class="n">ke</span> <span class="o">+</span> <span class="mi">1</span><span class="p">)</span> <span class="o">=</span> <span class="n">Uinf</span><span class="o">*</span><span class="n">ddispdxold</span>
<a name="ln-1129"></a>         <span class="n">wm</span><span class="p">(</span><span class="n">i</span><span class="p">,</span> <span class="p">:,</span> <span class="n">ke</span> <span class="o">+</span> <span class="mi">1</span><span class="p">)</span> <span class="o">=</span> <span class="n">Uinf</span><span class="o">*</span><span class="n">ddispdxold</span>
<a name="ln-1130"></a>      <span class="k">end do</span>
<a name="ln-1131"></a><span class="k">      call </span><span class="n">slabsumi</span><span class="p">(</span><span class="n">wout</span><span class="p">,</span> <span class="n">ib</span><span class="p">,</span> <span class="n">ie</span><span class="p">,</span> <span class="n">w0</span><span class="p">,</span> <span class="n">ib</span> <span class="o">-</span> <span class="n">ih</span><span class="p">,</span> <span class="n">ie</span> <span class="o">+</span> <span class="n">ih</span><span class="p">,</span> <span class="n">jb</span> <span class="o">-</span> <span class="n">jh</span><span class="p">,</span> <span class="n">je</span> <span class="o">+</span> <span class="n">jh</span><span class="p">,</span> <span class="n">kb</span> <span class="o">-</span> <span class="n">kh</span><span class="p">,</span> <span class="n">ke</span> <span class="o">+</span> <span class="n">kh</span><span class="p">,</span> <span class="n">ib</span><span class="p">,</span> <span class="n">ie</span><span class="p">,</span> <span class="n">jb</span><span class="p">,</span> <span class="n">je</span><span class="p">,</span> <span class="n">ke</span> <span class="o">+</span> <span class="mi">1</span><span class="p">,</span> <span class="n">ke</span> <span class="o">+</span> <span class="mi">1</span><span class="p">)</span> <span class="c">! determine vertical (j) average outflow velocity</span>
<a name="ln-1132"></a>      <span class="n">nji</span> <span class="o">=</span> <span class="mf">1.</span><span class="o">/</span><span class="p">(</span><span class="n">jge</span> <span class="o">-</span> <span class="n">jgb</span> <span class="o">+</span> <span class="mi">1</span><span class="p">)</span>
<a name="ln-1133"></a>      <span class="k">do </span><span class="n">i</span> <span class="o">=</span> <span class="n">ib</span><span class="p">,</span> <span class="n">ie</span>
<a name="ln-1134"></a>         <span class="n">wout</span><span class="p">(</span><span class="n">i</span><span class="p">)</span> <span class="o">=</span> <span class="n">wout</span><span class="p">(</span><span class="n">i</span><span class="p">)</span><span class="o">*</span><span class="n">dxf</span><span class="p">(</span><span class="n">i</span><span class="p">)</span><span class="o">*</span><span class="n">nji</span>
<a name="ln-1135"></a>      <span class="k">end do</span>
<a name="ln-1136"></a><span class="k">      </span><span class="n">wouttot</span> <span class="o">=</span> <span class="nb">sum</span><span class="p">(</span><span class="n">wout</span><span class="p">(</span><span class="n">ib</span><span class="p">:</span><span class="n">ie</span><span class="p">))</span><span class="o">/</span><span class="p">(</span><span class="n">xh</span><span class="p">(</span><span class="n">ie</span> <span class="o">+</span> <span class="mi">1</span><span class="p">)</span> <span class="o">-</span> <span class="n">xh</span><span class="p">(</span><span class="n">ib</span><span class="p">))</span> <span class="c">! Area-averaged outflow velocity</span>
<a name="ln-1137"></a>
<a name="ln-1138"></a>      <span class="k">return</span>
<a name="ln-1139"></a><span class="k">   end subroutine </span><span class="n">inlettop</span>
<a name="ln-1140"></a>
<a name="ln-1141"></a><span class="c">!&gt;Set thl, qt and sv(n) equal to slab average at level kmax</span>
<a name="ln-1142"></a>   <span class="k">subroutine </span><span class="n">tqaver</span>
<a name="ln-1143"></a>
<a name="ln-1144"></a>      <span class="k">use </span><span class="n">modmpi</span><span class="p">,</span> <span class="n">only</span><span class="p">:</span><span class="n">comm3d</span><span class="p">,</span> <span class="n">mpierr</span><span class="p">,</span> <span class="n">my_real</span><span class="p">,</span> <span class="n">mpi_sum</span>
<a name="ln-1145"></a>      <span class="k">use </span><span class="n">modglobal</span><span class="p">,</span> <span class="n">only</span><span class="p">:</span><span class="n">ib</span><span class="p">,</span> <span class="n">ie</span><span class="p">,</span> <span class="n">jb</span><span class="p">,</span> <span class="n">je</span><span class="p">,</span> <span class="n">ih</span><span class="p">,</span> <span class="n">jh</span><span class="p">,</span> <span class="n">kb</span><span class="p">,</span> <span class="n">ke</span><span class="p">,</span> <span class="n">nsv</span><span class="p">,</span> <span class="n">rslabs</span>
<a name="ln-1146"></a>      <span class="k">use </span><span class="n">modfields</span><span class="p">,</span> <span class="n">only</span><span class="p">:</span><span class="n">thl0</span><span class="p">,</span> <span class="n">qt0</span><span class="p">,</span> <span class="n">sv0</span>
<a name="ln-1147"></a>      <span class="k">implicit none</span>
<a name="ln-1148"></a>
<a name="ln-1149"></a><span class="k">      </span><span class="kt">real </span><span class="n">thl0a</span><span class="p">,</span> <span class="n">qt0a</span>
<a name="ln-1150"></a>      <span class="kt">real </span><span class="n">thl0al</span><span class="p">,</span> <span class="n">qt0al</span>
<a name="ln-1151"></a>      <span class="kt">integer </span><span class="n">n</span>
<a name="ln-1152"></a>      <span class="kt">real</span><span class="p">,</span> <span class="k">allocatable</span><span class="p">,</span> <span class="k">dimension</span><span class="p">(:)</span> <span class="kd">::</span> <span class="n">sv0al</span><span class="p">,</span> <span class="n">sv0a</span>
<a name="ln-1153"></a>      <span class="k">allocate</span> <span class="p">(</span><span class="n">sv0al</span><span class="p">(</span><span class="n">nsv</span><span class="p">),</span> <span class="n">sv0a</span><span class="p">(</span><span class="n">nsv</span><span class="p">))</span>
<a name="ln-1154"></a>
<a name="ln-1155"></a>      <span class="n">thl0al</span> <span class="o">=</span> <span class="nb">sum</span><span class="p">(</span><span class="n">thl0</span><span class="p">(</span><span class="n">ib</span><span class="p">:</span><span class="n">ie</span><span class="p">,</span> <span class="n">jb</span><span class="p">:</span><span class="n">je</span><span class="p">,</span> <span class="n">ke</span><span class="p">))</span>
<a name="ln-1156"></a>      <span class="n">qt0al</span> <span class="o">=</span> <span class="nb">sum</span><span class="p">(</span><span class="n">qt0</span><span class="p">(</span><span class="n">ib</span><span class="p">:</span><span class="n">ie</span><span class="p">,</span> <span class="n">jb</span><span class="p">:</span><span class="n">je</span><span class="p">,</span> <span class="n">ke</span><span class="p">))</span>
<a name="ln-1157"></a>
<a name="ln-1158"></a>      <span class="k">do </span><span class="n">n</span> <span class="o">=</span> <span class="mi">1</span><span class="p">,</span> <span class="n">nsv</span>
<a name="ln-1159"></a>         <span class="n">sv0al</span><span class="p">(</span><span class="n">n</span><span class="p">)</span> <span class="o">=</span> <span class="nb">sum</span><span class="p">(</span><span class="n">sv0</span><span class="p">(</span><span class="n">ib</span><span class="p">:</span><span class="n">ie</span><span class="p">,</span> <span class="n">jb</span><span class="p">:</span><span class="n">je</span><span class="p">,</span> <span class="n">ke</span><span class="p">,</span> <span class="n">n</span><span class="p">))</span>
<a name="ln-1160"></a>      <span class="n">enddo</span>
<a name="ln-1161"></a>
<a name="ln-1162"></a>      <span class="k">call </span><span class="n">MPI_ALLREDUCE</span><span class="p">(</span><span class="n">thl0al</span><span class="p">,</span> <span class="n">thl0a</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="n">MY_REAL</span><span class="p">,</span> <span class="p">&amp;</span>
<a name="ln-1163"></a>                         <span class="n">MPI_SUM</span><span class="p">,</span> <span class="n">comm3d</span><span class="p">,</span> <span class="n">mpierr</span><span class="p">)</span>
<a name="ln-1164"></a>      <span class="k">call </span><span class="n">MPI_ALLREDUCE</span><span class="p">(</span><span class="n">qt0al</span><span class="p">,</span> <span class="n">qt0a</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="n">MY_REAL</span><span class="p">,</span> <span class="p">&amp;</span>
<a name="ln-1165"></a>                         <span class="n">MPI_SUM</span><span class="p">,</span> <span class="n">comm3d</span><span class="p">,</span> <span class="n">mpierr</span><span class="p">)</span>
<a name="ln-1166"></a>      <span class="k">if</span> <span class="p">(</span><span class="n">nsv</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">)</span> <span class="k">then</span>
<a name="ln-1167"></a><span class="k">         call </span><span class="n">MPI_ALLREDUCE</span><span class="p">(</span><span class="n">sv0al</span><span class="p">,</span> <span class="n">sv0a</span><span class="p">,</span> <span class="n">nsv</span><span class="p">,</span> <span class="n">MY_REAL</span><span class="p">,</span> <span class="p">&amp;</span>
<a name="ln-1168"></a>                            <span class="n">MPI_SUM</span><span class="p">,</span> <span class="n">comm3d</span><span class="p">,</span> <span class="n">mpierr</span><span class="p">)</span>
<a name="ln-1169"></a>      <span class="k">end if</span>
<a name="ln-1170"></a>
<a name="ln-1171"></a><span class="k">      </span><span class="n">thl0a</span> <span class="o">=</span> <span class="n">thl0a</span><span class="o">/</span><span class="n">rslabs</span>
<a name="ln-1172"></a>      <span class="n">qt0a</span> <span class="o">=</span> <span class="n">qt0a</span><span class="o">/</span><span class="n">rslabs</span>
<a name="ln-1173"></a>      <span class="n">sv0a</span> <span class="o">=</span> <span class="n">sv0a</span><span class="o">/</span><span class="n">rslabs</span>
<a name="ln-1174"></a>
<a name="ln-1175"></a>      <span class="n">thl0</span><span class="p">(</span><span class="n">ib</span><span class="p">:</span><span class="n">ie</span><span class="p">,</span> <span class="n">jb</span><span class="p">:</span><span class="n">je</span><span class="p">,</span> <span class="n">ke</span><span class="p">)</span> <span class="o">=</span> <span class="n">thl0a</span>
<a name="ln-1176"></a>      <span class="n">qt0</span><span class="p">(</span><span class="n">ib</span><span class="p">:</span><span class="n">ie</span><span class="p">,</span> <span class="n">jb</span><span class="p">:</span><span class="n">je</span><span class="p">,</span> <span class="n">ke</span><span class="p">)</span> <span class="o">=</span> <span class="n">qt0a</span>
<a name="ln-1177"></a>      <span class="k">do </span><span class="n">n</span> <span class="o">=</span> <span class="mi">1</span><span class="p">,</span> <span class="n">nsv</span>
<a name="ln-1178"></a>         <span class="n">sv0</span><span class="p">(</span><span class="n">ib</span><span class="p">:</span><span class="n">ie</span><span class="p">,</span> <span class="n">jb</span><span class="p">:</span><span class="n">je</span><span class="p">,</span> <span class="n">ke</span><span class="p">,</span> <span class="n">n</span><span class="p">)</span> <span class="o">=</span> <span class="n">sv0a</span><span class="p">(</span><span class="n">n</span><span class="p">)</span>
<a name="ln-1179"></a>      <span class="n">enddo</span>
<a name="ln-1180"></a>      <span class="k">deallocate</span> <span class="p">(</span><span class="n">sv0al</span><span class="p">,</span> <span class="n">sv0a</span><span class="p">)</span>
<a name="ln-1181"></a>
<a name="ln-1182"></a>      <span class="k">return</span>
<a name="ln-1183"></a><span class="k">   end subroutine </span><span class="n">tqaver</span>
<a name="ln-1184"></a>
<a name="ln-1185"></a><span class="k">end module </span><span class="n">modboundary</span>
</pre></div>

    </section>
    </div>
  </div>

  
    <hr>    
    </div> <!-- /container -->
    <footer>
      <div class="container">
      <div class="row">
        <div class="col-xs-6 col-md-4"><p>&copy; 2021 
                                          </p></div>
        <div class="col-xs-6 col-md-4 col-md-push-4">
          <p class="text-right">
            Documentation generated by 
            <a href="https://github.com/cmacmackin/ford">FORD</a>
            
          </p>
        </div>
        <div class="col-xs-12 col-md-4 col-md-pull-4"><p class="text-center"> uDALES was developed by The uDALES Team</p></div>
      </div>
      <br>
      </div> <!-- /container -->    
    </footer>

    <!-- Bootstrap core JavaScript
    ================================================== -->
    <!-- Placed at the end of the document so the pages load faster -->
<!--
    <script src="https://ajax.googleapis.com/ajax/libs/jquery/1.11.1/jquery.min.js"></script>
-->
    <script src="../js/bootstrap.min.js"></script>
    <!-- IE10 viewport hack for Surface/desktop Windows 8 bug -->
    <script src="../js/ie10-viewport-bug-workaround.js"></script>

    <!-- MathJax JavaScript
    ================================================== -->
    <!-- Placed at the end of the document so the pages load faster -->
    <script type="text/x-mathjax-config">
      MathJax.Hub.Config({
        TeX: { extensions: ['AMSmath.js','AMSsymbols.js','noErrors.js','noUndefined.js'], equationNumbers: { autoNumber: 'AMS' } },
        jax: ['input/TeX','input/MathML','output/HTML-CSS'],
        extensions: ['tex2jax.js','mml2jax.js','MathMenu.js','MathZoom.js']
      });
    </script>
    
    <script src="https://cdnjs.cloudflare.com/ajax/libs/mathjax/2.7.1/MathJax.js?config=TeX-AMS-MML_HTMLorMML"></script>
    
    
    <script src="../tipuesearch/tipuesearch_content.js"></script>
    <script src="../tipuesearch/tipuesearch_set.js"></script>
    <script src="../tipuesearch/tipuesearch.js"></script>
    
    
  </body>
</html>