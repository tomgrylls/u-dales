<!DOCTYPE html>
<html lang="en">
  <head>
    <meta charset="utf-8">
    <meta http-equiv="X-UA-Compatible" content="IE=edge">
    <meta name="viewport" content="width=device-width, initial-scale=1">
   
    <meta name="description" content="Documentation for uDALES">
   
    <meta name="author" content="The uDALES Team" >
    <link rel="icon" href="../favicon.png">

    <title>modibm.f90 &ndash; uDALES</title>

    <link href="../css/bootstrap.min.css" rel="stylesheet">
    <link href="../css/pygments.css" rel="stylesheet">
    <link href="../css/font-awesome.min.css" rel="stylesheet">
    <link href="../css/local.css" rel="stylesheet">
    
    <link  href="../tipuesearch/tipuesearch.css" rel="stylesheet">
    
    

    <!-- HTML5 shim and Respond.js for IE8 support of HTML5 elements and media queries -->
    <!--[if lt IE 9]>
      <script src="https://oss.maxcdn.com/html5shiv/3.7.2/html5shiv.min.js"></script>
      <script src="https://oss.maxcdn.com/respond/1.4.2/respond.min.js"></script>
    <![endif]-->
    
    <script src="../js/jquery-2.1.3.min.js"></script>
    <script src="../js/svg-pan-zoom.min.js"></script>

  </head>

  <body>

    <!-- Fixed navbar -->
    <nav class="navbar navbar-inverse navbar-fixed-top">
      <div class="container">
        <div class="navbar-header">
          <button type="button" class="navbar-toggle collapsed" data-toggle="collapse" data-target="#navbar" aria-expanded="false" aria-controls="navbar">
            <span class="sr-only">Toggle navigation</span>
            <span class="icon-bar"></span>
            <span class="icon-bar"></span>
            <span class="icon-bar"></span>
          </button>
          <a class="navbar-brand" href="../index.html">uDALES </a>
        </div>
        <div id="navbar" class="navbar-collapse collapse">
          <ul class="nav navbar-nav">
        
            <li class="dropdown hidden-xs visible-sm visible-md hidden-lg">
              <a href="#" class="dropdown-toggle"
              data-toggle="dropdown" role="button"
              aria-haspopup="true"
     aria-expanded="false">Contents <span class="caret"></span></a>
        <ul class="dropdown-menu">
          
              
            <li><a href="../lists/files.html">Source Files</a></li>
        
        
        
            <li><a href="../lists/modules.html">Modules</a></li>
        
            
                                
            <li><a href="../lists/procedures.html">Procedures</a></li>
        
               
            <li><a href="../lists/types.html">Derived Types</a></li>
        
        
            <li><a href="../program/dalesurban.html">Program</a></li>
      
            </ul>
            </li>


<li class="visible-xs hidden-sm visible-lg"><a href="../lists/files.html">Source Files</a></li>



<li class="visible-xs hidden-sm visible-lg"><a href="../lists/modules.html">Modules</a></li>



<li class="visible-xs hidden-sm visible-lg"><a href="../lists/procedures.html">Procedures</a></li>

                             
<li class="visible-xs hidden-sm visible-lg"><a href="../lists/types.html">Derived Types</a></li>


<li class="visible-xs hidden-sm visible-lg"><a href="../program/dalesurban.html">Program</a></li>

          </ul>
        
        <form action="../search.html" class="navbar-form navbar-right" role="search">
        <div class="form-group">
          <input type="text" class="form-control" placeholder="Search" name="q" id="tipue_search_input" autocomplete="off" required>
        </div>
<!--
        <button type="submit" class="btn btn-default">Submit</button>
-->
        </form>
        
        </div><!--/.nav-collapse -->
      </div>
    </nav>

    <div class="container">
    
  
  <div class="row">
    <h1>modibm.f90
    <small>Source File</small>
    
    </h1>
    
<div class="row">
  <div class="col-lg-12">
<div class="well well-sm">
  <ul class="list-inline" style="margin-bottom:0px;display:inline">
     
     
     
     
    
    
     <li><i class="fa fa-list-ol"></i>
       <a data-toggle="tooltip"
    data-placement="bottom" data-html="true"
    title=" 6.3% of total for source files.">892 statements</a>
     </li> 
     
     
     
    <li><i class="fa fa-code"></i><a href="../src/modibm.f90"> Source File</a></li>
     
     
  </ul>
  <ol class="breadcrumb in-well text-right">
  
    
  
     <li class="active">modibm.f90</li>
  </ol>
</div>
</div>
</div>
<script>
  $(function () {
  $('[data-toggle="tooltip"]').tooltip()
  })
</script>

  </div>
  <div class="row">
    <div class="col-md-3 hidden-xs hidden-sm visible-md visible-lg">
    
<div id="sidebar">
  
<h3>Contents</h3>
 







<div class="panel panel-primary">
  <div class="panel-heading text-left"><h3 class="panel-title"><a data-toggle="collapse" href="#mods-0">Modules</a></h3></div>
  <div id="mods-0" class="panel-collapse collapse">
    <div class="list-group">
      
      <a class="list-group-item" href="../module/modibm.html">modibm</a>
      
    </div>
  </div>
</div>
















<div class="panel panel-primary">
  <div class="panel-heading text-left"><h3 class="panel-title">Source Code</h3></div>
  <div class="list-group">
    <a class="list-group-item" href="../sourcefile/modibm.f90.html#src">modibm.f90</a>
  </div>
</div>



</div>

    </div>
    <div class="col-md-9" id='text'>
      
      <br>
    
    <div class="panel panel-default">
      <div class="panel-heading">
  <h3 class="panel-title">This file depends on</h3>
      </div>
      <div class="panel-body">
  <div class="depgraph"><?xml version="1.0" encoding="UTF-8" standalone="no"?>
<!DOCTYPE svg PUBLIC "-//W3C//DTD SVG 1.1//EN"
 "http://www.w3.org/Graphics/SVG/1.1/DTD/svg11.dtd">
<!-- Generated by graphviz version 2.40.1 (20161225.0304)
 -->
<!-- Title: sourcefile~~modibm.f90~~EfferentGraph Pages: 1 -->
<svg id="sourcefilemodibmf90EfferentGraph" width="442pt" height="274pt"
 viewBox="0.00 0.00 442.00 273.93" xmlns="http://www.w3.org/2000/svg" xmlns:xlink="http://www.w3.org/1999/xlink">
<g id="sourcefile~~modibm.f90~~EfferentGraph" class="graph" transform="scale(1 1) rotate(0) translate(4 269.9318)">
<title>sourcefile~~modibm.f90~~EfferentGraph</title>
<polygon fill="#ffffff" stroke="transparent" points="-4,4 -4,-269.9318 438,-269.9318 438,4 -4,4"/>
<!-- sourcefile~modibm.f90 -->
<g id="sourcefile~~modibm.f90~~EfferentGraph_node1" class="node">
<title>sourcefile~modibm.f90</title>
<polygon fill="none" stroke="#000000" points="434,-139.9318 365,-139.9318 365,-115.9318 434,-115.9318 434,-139.9318"/>
<text text-anchor="middle" x="399.5" y="-125.5318" font-family="Helvetica,sans-Serif" font-size="10.50" fill="#000000">modibm.f90</text>
</g>
<!-- sourcefile~modibmdata.f90 -->
<g id="sourcefile~~modibm.f90~~EfferentGraph_node2" class="node">
<title>sourcefile~modibmdata.f90</title>
<g id="a_sourcefile~~modibm.f90~~EfferentGraph_node2"><a xlink:href=".././sourcefile/modibmdata.f90.html" xlink:title="modibmdata.f90">
<polygon fill="#f0ad4e" stroke="#f0ad4e" points="320,-265.9318 230,-265.9318 230,-241.9318 320,-241.9318 320,-265.9318"/>
<text text-anchor="middle" x="275" y="-251.5318" font-family="Helvetica,sans-Serif" font-size="10.50" fill="#ffffff">modibmdata.f90</text>
</a>
</g>
</g>
<!-- sourcefile~modibm.f90&#45;&gt;sourcefile~modibmdata.f90 -->
<g id="sourcefile~~modibm.f90~~EfferentGraph_edge7" class="edge">
<title>sourcefile~modibm.f90&#45;&gt;sourcefile~modibmdata.f90</title>
<path fill="none" stroke="#ff0000" stroke-dasharray="5,2" d="M394.3518,-140.0708C384.6255,-161.6478 361.5646,-206.8557 329,-232.9318 327.2456,-234.3366 325.3861,-235.6562 323.4532,-236.8947"/>
<polygon fill="#ff0000" stroke="#ff0000" points="321.6423,-233.897 314.6067,-241.8186 325.0466,-240.0134 321.6423,-233.897"/>
</g>
<!-- sourcefile~modsubgriddata.f90 -->
<g id="sourcefile~~modibm.f90~~EfferentGraph_node3" class="node">
<title>sourcefile~modsubgriddata.f90</title>
<g id="a_sourcefile~~modibm.f90~~EfferentGraph_node3"><a xlink:href=".././sourcefile/modsubgriddata.f90.html" xlink:title="modsubgriddata.f90">
<polygon fill="#f0ad4e" stroke="#f0ad4e" points="329,-223.9318 221,-223.9318 221,-199.9318 329,-199.9318 329,-223.9318"/>
<text text-anchor="middle" x="275" y="-209.5318" font-family="Helvetica,sans-Serif" font-size="10.50" fill="#ffffff">modsubgriddata.f90</text>
</a>
</g>
</g>
<!-- sourcefile~modibm.f90&#45;&gt;sourcefile~modsubgriddata.f90 -->
<g id="sourcefile~~modibm.f90~~EfferentGraph_edge1" class="edge">
<title>sourcefile~modibm.f90&#45;&gt;sourcefile~modsubgriddata.f90</title>
<path fill="none" stroke="#ff0000" stroke-dasharray="5,2" d="M388.5691,-140.0365C375.5238,-153.8891 352.5083,-176.516 329,-190.9318 326.3417,-192.5619 323.5354,-194.1051 320.6559,-195.5587"/>
<polygon fill="#ff0000" stroke="#ff0000" points="318.9039,-192.5129 311.3014,-199.8921 321.8463,-198.8645 318.9039,-192.5129"/>
</g>
<!-- sourcefile~modsurfdata.f90 -->
<g id="sourcefile~~modibm.f90~~EfferentGraph_node4" class="node">
<title>sourcefile~modsurfdata.f90</title>
<g id="a_sourcefile~~modibm.f90~~EfferentGraph_node4"><a xlink:href=".././sourcefile/modsurfdata.f90.html" xlink:title="modsurfdata.f90">
<polygon fill="#f0ad4e" stroke="#f0ad4e" points="320.5,-181.9318 229.5,-181.9318 229.5,-157.9318 320.5,-157.9318 320.5,-181.9318"/>
<text text-anchor="middle" x="275" y="-167.5318" font-family="Helvetica,sans-Serif" font-size="10.50" fill="#ffffff">modsurfdata.f90</text>
</a>
</g>
</g>
<!-- sourcefile~modibm.f90&#45;&gt;sourcefile~modsurfdata.f90 -->
<g id="sourcefile~~modibm.f90~~EfferentGraph_edge2" class="edge">
<title>sourcefile~modibm.f90&#45;&gt;sourcefile~modsurfdata.f90</title>
<path fill="none" stroke="#ff0000" stroke-dasharray="5,2" d="M364.8198,-139.6311C351.1403,-144.2459 335.2348,-149.6116 320.6428,-154.5342"/>
<polygon fill="#ff0000" stroke="#ff0000" points="319.1505,-151.3438 310.794,-157.8567 321.3881,-157.9765 319.1505,-151.3438"/>
</g>
<!-- sourcefile~modfields.f90 -->
<g id="sourcefile~~modibm.f90~~EfferentGraph_node5" class="node">
<title>sourcefile~modfields.f90</title>
<g id="a_sourcefile~~modibm.f90~~EfferentGraph_node5"><a xlink:href=".././sourcefile/modfields.f90.html" xlink:title="modfields.f90">
<polygon fill="#f0ad4e" stroke="#f0ad4e" points="313,-139.9318 237,-139.9318 237,-115.9318 313,-115.9318 313,-139.9318"/>
<text text-anchor="middle" x="275" y="-125.5318" font-family="Helvetica,sans-Serif" font-size="10.50" fill="#ffffff">modfields.f90</text>
</a>
</g>
</g>
<!-- sourcefile~modibm.f90&#45;&gt;sourcefile~modfields.f90 -->
<g id="sourcefile~~modibm.f90~~EfferentGraph_edge4" class="edge">
<title>sourcefile~modibm.f90&#45;&gt;sourcefile~modfields.f90</title>
<path fill="none" stroke="#ff0000" stroke-dasharray="5,2" d="M364.8198,-127.9318C352.0914,-127.9318 337.4357,-127.9318 323.7042,-127.9318"/>
<polygon fill="#ff0000" stroke="#ff0000" points="323.4311,-124.4319 313.431,-127.9318 323.431,-131.4319 323.4311,-124.4319"/>
</g>
<!-- sourcefile~initfac.f90 -->
<g id="sourcefile~~modibm.f90~~EfferentGraph_node6" class="node">
<title>sourcefile~initfac.f90</title>
<g id="a_sourcefile~~modibm.f90~~EfferentGraph_node6"><a xlink:href=".././sourcefile/initfac.f90.html" xlink:title="initfac.f90">
<polygon fill="#f0ad4e" stroke="#f0ad4e" points="304,-59.9318 246,-59.9318 246,-35.9318 304,-35.9318 304,-59.9318"/>
<text text-anchor="middle" x="275" y="-45.5318" font-family="Helvetica,sans-Serif" font-size="10.50" fill="#ffffff">initfac.f90</text>
</a>
</g>
</g>
<!-- sourcefile~modibm.f90&#45;&gt;sourcefile~initfac.f90 -->
<g id="sourcefile~~modibm.f90~~EfferentGraph_edge5" class="edge">
<title>sourcefile~modibm.f90&#45;&gt;sourcefile~initfac.f90</title>
<path fill="none" stroke="#ff0000" stroke-dasharray="5,2" d="M385.539,-115.8586C371.7432,-104.2685 349.7521,-86.6887 329,-73.9318 323.5901,-70.6061 317.6905,-67.3885 311.8422,-64.4163"/>
<polygon fill="#ff0000" stroke="#ff0000" points="313.2915,-61.2288 302.772,-59.9675 310.2089,-67.5136 313.2915,-61.2288"/>
</g>
<!-- sourcefile~modglobal.f90 -->
<g id="sourcefile~~modibm.f90~~EfferentGraph_node7" class="node">
<title>sourcefile~modglobal.f90</title>
<g id="a_sourcefile~~modibm.f90~~EfferentGraph_node7"><a xlink:href=".././sourcefile/modglobal.f90.html" xlink:title="modglobal.f90">
<polygon fill="#f0ad4e" stroke="#f0ad4e" points="185,-79.9318 105,-79.9318 105,-55.9318 185,-55.9318 185,-79.9318"/>
<text text-anchor="middle" x="145" y="-65.5318" font-family="Helvetica,sans-Serif" font-size="10.50" fill="#ffffff">modglobal.f90</text>
</a>
</g>
</g>
<!-- sourcefile~modibm.f90&#45;&gt;sourcefile~modglobal.f90 -->
<g id="sourcefile~~modibm.f90~~EfferentGraph_edge6" class="edge">
<title>sourcefile~modibm.f90&#45;&gt;sourcefile~modglobal.f90</title>
<path fill="none" stroke="#ff0000" stroke-dasharray="5,2" d="M364.8716,-117.0115C353.4977,-113.5871 340.7578,-109.9238 329,-106.9318 284.02,-95.4856 232.2659,-84.7272 195.1259,-77.4213"/>
<polygon fill="#ff0000" stroke="#ff0000" points="195.5414,-73.9364 185.0559,-75.4545 194.1995,-80.8066 195.5414,-73.9364"/>
</g>
<!-- sourcefile~modmpi.f90 -->
<g id="sourcefile~~modibm.f90~~EfferentGraph_node8" class="node">
<title>sourcefile~modmpi.f90</title>
<g id="a_sourcefile~~modibm.f90~~EfferentGraph_node8"><a xlink:href=".././sourcefile/modmpi.f90.html" xlink:title="modmpi.f90">
<polygon fill="#f0ad4e" stroke="#f0ad4e" points="69,-49.9318 0,-49.9318 0,-25.9318 69,-25.9318 69,-49.9318"/>
<text text-anchor="middle" x="34.5" y="-35.5318" font-family="Helvetica,sans-Serif" font-size="10.50" fill="#ffffff">modmpi.f90</text>
</a>
</g>
</g>
<!-- sourcefile~modibm.f90&#45;&gt;sourcefile~modmpi.f90 -->
<g id="sourcefile~~modibm.f90~~EfferentGraph_edge3" class="edge">
<title>sourcefile~modibm.f90&#45;&gt;sourcefile~modmpi.f90</title>
<path fill="none" stroke="#ff0000" stroke-dasharray="5,2" d="M394.9799,-115.7124C386.117,-93.6776 364.1955,-47.6551 329,-26.9318 258.1558,14.7817 227.0827,-3.3117 145,-7.9318"/>
<path fill="none" stroke="#ff0000" stroke-dasharray="5,2" d="M145,-7.9318C121.1079,-9.0076 95.2666,-15.6983 74.5853,-22.4887"/>
<polygon fill="#ff0000" stroke="#ff0000" points="73.2091,-19.2602 64.8783,-25.806 75.4729,-25.8841 73.2091,-19.2602"/>
</g>
<!-- sourcefile~modfields.f90&#45;&gt;sourcefile~modglobal.f90 -->
<g id="sourcefile~~modibm.f90~~EfferentGraph_edge8" class="edge">
<title>sourcefile~modfields.f90&#45;&gt;sourcefile~modglobal.f90</title>
<path fill="none" stroke="#00ff91" stroke-dasharray="5,2" d="M248.6926,-115.7899C229.0456,-106.722 201.9833,-94.2317 180.432,-84.285"/>
<polygon fill="#00ff91" stroke="#00ff91" points="181.8146,-81.0684 171.2683,-80.0556 178.8812,-87.4241 181.8146,-81.0684"/>
</g>
<!-- sourcefile~initfac.f90&#45;&gt;sourcefile~modglobal.f90 -->
<g id="sourcefile~~modibm.f90~~EfferentGraph_edge9" class="edge">
<title>sourcefile~initfac.f90&#45;&gt;sourcefile~modglobal.f90</title>
<path fill="none" stroke="#0091ff" stroke-dasharray="5,2" d="M245.8255,-52.4202C231.071,-54.6901 212.7351,-57.511 195.7615,-60.1223"/>
<polygon fill="#0091ff" stroke="#0091ff" points="194.7647,-56.7344 185.4133,-61.7144 195.8292,-63.653 194.7647,-56.7344"/>
</g>
<!-- sourcefile~initfac.f90&#45;&gt;sourcefile~modmpi.f90 -->
<g id="sourcefile~~modibm.f90~~EfferentGraph_edge10" class="edge">
<title>sourcefile~initfac.f90&#45;&gt;sourcefile~modmpi.f90</title>
<path fill="none" stroke="#0091ff" stroke-dasharray="5,2" d="M252.6064,-35.7596C227.1793,-23.2017 184.1367,-5.7289 145,-7.9318"/>
</g>
<!-- sourcefile~modglobal.f90&#45;&gt;sourcefile~modmpi.f90 -->
<g id="sourcefile~~modibm.f90~~EfferentGraph_edge11" class="edge">
<title>sourcefile~modglobal.f90&#45;&gt;sourcefile~modmpi.f90</title>
<path fill="none" stroke="#4800ff" stroke-dasharray="5,2" d="M104.7944,-57.0162C96.3673,-54.7283 87.4348,-52.3032 78.866,-49.9768"/>
<polygon fill="#4800ff" stroke="#4800ff" points="79.5938,-46.5478 69.0261,-47.3054 77.7597,-53.3033 79.5938,-46.5478"/>
</g>
</g>
</svg>
</div><div><a type="button" class="graph-help" data-toggle="modal" href="#graph-help-text">Help</a></div><div class="modal fade" id="graph-help-text" tabindex="-1" role="dialog"><div class="modal-dialog modal-lg" role="document"><div class="modal-content"><div class="modal-header"><button type="button" class="close" data-dismiss="modal" aria-label="Close"><span aria-hidden="true">&times;</span></button><h4 class="modal-title" id="-graph-help-label">Graph Key</h4></div><div class="modal-body">
    <p>Nodes of different colours represent the following: </p>
    <?xml version="1.0" encoding="UTF-8" standalone="no"?>
<!DOCTYPE svg PUBLIC "-//W3C//DTD SVG 1.1//EN"
 "http://www.w3.org/Graphics/SVG/1.1/DTD/svg11.dtd">
<!-- Generated by graphviz version 2.40.1 (20161225.0304)
 -->
<!-- Title: Graph Key Pages: 1 -->
<svg width="190pt" height="32pt"
 viewBox="0.00 0.00 190.00 32.00" xmlns="http://www.w3.org/2000/svg" xmlns:xlink="http://www.w3.org/1999/xlink">
<g id="graph0" class="graph" transform="scale(1 1) rotate(0) translate(4 28)">
<title>Graph Key</title>
<polygon fill="#ffffff" stroke="transparent" points="-4,4 -4,-28 186,-28 186,4 -4,4"/>
<!-- Source File -->
<g id="node1" class="node">
<title>Source File</title>
<polygon fill="#f0ad4e" stroke="#f0ad4e" points="67,-24 0,-24 0,0 67,0 67,-24"/>
<text text-anchor="middle" x="33.5" y="-9.6" font-family="Helvetica,sans-Serif" font-size="10.50" fill="#ffffff">Source File</text>
</g>
<!-- This Page&#39;s Entity -->
<g id="node2" class="node">
<title>This Page&#39;s Entity</title>
<polygon fill="none" stroke="#000000" points="182,-24 85,-24 85,0 182,0 182,-24"/>
<text text-anchor="middle" x="133.5" y="-9.6" font-family="Helvetica,sans-Serif" font-size="10.50" fill="#000000">This Page&#39;s Entity</text>
</g>
</g>
</svg>

    
    <p>Solid arrows point from a file to a file which it depends on. A file
    is dependent upon another if the latter must be compiled before the former
    can be. Where possible, edges connecting nodes are given different colours to make them easier to distinguish in large graphs.
    </p>
    </div></div></div></div>
      </div>
    </div>
    
      
    <div class="panel panel-default">
      <div class="panel-heading">
  <h3 class="panel-title">Files dependent on this one</h3>
      </div>
      <div class="panel-body">
  <div class="depgraph"><?xml version="1.0" encoding="UTF-8" standalone="no"?>
<!DOCTYPE svg PUBLIC "-//W3C//DTD SVG 1.1//EN"
 "http://www.w3.org/Graphics/SVG/1.1/DTD/svg11.dtd">
<!-- Generated by graphviz version 2.40.1 (20161225.0304)
 -->
<!-- Title: sourcefile~~modibm.f90~~AfferentGraph Pages: 1 -->
<svg id="sourcefilemodibmf90AfferentGraph" width="196pt" height="74pt"
 viewBox="0.00 0.00 196.00 74.00" xmlns="http://www.w3.org/2000/svg" xmlns:xlink="http://www.w3.org/1999/xlink">
<g id="sourcefile~~modibm.f90~~AfferentGraph" class="graph" transform="scale(1 1) rotate(0) translate(4 70)">
<title>sourcefile~~modibm.f90~~AfferentGraph</title>
<polygon fill="#ffffff" stroke="transparent" points="-4,4 -4,-70 192,-70 192,4 -4,4"/>
<!-- sourcefile~modibm.f90 -->
<g id="sourcefile~~modibm.f90~~AfferentGraph_node1" class="node">
<title>sourcefile~modibm.f90</title>
<polygon fill="none" stroke="#000000" points="69,-45 0,-45 0,-21 69,-21 69,-45"/>
<text text-anchor="middle" x="34.5" y="-30.6" font-family="Helvetica,sans-Serif" font-size="10.50" fill="#000000">modibm.f90</text>
</g>
<!-- sourcefile~advec_2nd.f90 -->
<g id="sourcefile~~modibm.f90~~AfferentGraph_node2" class="node">
<title>sourcefile~advec_2nd.f90</title>
<g id="a_sourcefile~~modibm.f90~~AfferentGraph_node2"><a xlink:href=".././sourcefile/advec_2nd.f90.html" xlink:title="advec_2nd.f90">
<polygon fill="#f0ad4e" stroke="#f0ad4e" points="188,-66 105,-66 105,-42 188,-42 188,-66"/>
<text text-anchor="middle" x="146.5" y="-51.6" font-family="Helvetica,sans-Serif" font-size="10.50" fill="#ffffff">advec_2nd.f90</text>
</a>
</g>
</g>
<!-- sourcefile~advec_2nd.f90&#45;&gt;sourcefile~modibm.f90 -->
<g id="sourcefile~~modibm.f90~~AfferentGraph_edge2" class="edge">
<title>sourcefile~advec_2nd.f90&#45;&gt;sourcefile~modibm.f90</title>
<path fill="none" stroke="#ff0000" stroke-dasharray="5,2" d="M104.7953,-46.1804C96.4828,-44.6218 87.7198,-42.9787 79.3081,-41.4015"/>
<polygon fill="#ff0000" stroke="#ff0000" points="79.7495,-37.9234 69.2757,-39.5204 78.4594,-44.8035 79.7495,-37.9234"/>
</g>
<!-- sourcefile~program.f90 -->
<g id="sourcefile~~modibm.f90~~AfferentGraph_node3" class="node">
<title>sourcefile~program.f90</title>
<g id="a_sourcefile~~modibm.f90~~AfferentGraph_node3"><a xlink:href=".././sourcefile/program.f90.html" xlink:title="program.f90">
<polygon fill="#f0ad4e" stroke="#f0ad4e" points="182,-24 111,-24 111,0 182,0 182,-24"/>
<text text-anchor="middle" x="146.5" y="-9.6" font-family="Helvetica,sans-Serif" font-size="10.50" fill="#ffffff">program.f90</text>
</a>
</g>
</g>
<!-- sourcefile~program.f90&#45;&gt;sourcefile~modibm.f90 -->
<g id="sourcefile~~modibm.f90~~AfferentGraph_edge1" class="edge">
<title>sourcefile~program.f90&#45;&gt;sourcefile~modibm.f90</title>
<path fill="none" stroke="#ff0000" stroke-dasharray="5,2" d="M110.7546,-18.7023C100.6636,-20.5943 89.5586,-22.6765 79.0203,-24.6524"/>
<polygon fill="#ff0000" stroke="#ff0000" points="78.3255,-21.2216 69.1418,-26.5047 79.6156,-28.1017 78.3255,-21.2216"/>
</g>
</g>
</svg>
</div><div><a type="button" class="graph-help" data-toggle="modal" href="#graph-help-text">Help</a></div><div class="modal fade" id="graph-help-text" tabindex="-1" role="dialog"><div class="modal-dialog modal-lg" role="document"><div class="modal-content"><div class="modal-header"><button type="button" class="close" data-dismiss="modal" aria-label="Close"><span aria-hidden="true">&times;</span></button><h4 class="modal-title" id="-graph-help-label">Graph Key</h4></div><div class="modal-body">
    <p>Nodes of different colours represent the following: </p>
    <?xml version="1.0" encoding="UTF-8" standalone="no"?>
<!DOCTYPE svg PUBLIC "-//W3C//DTD SVG 1.1//EN"
 "http://www.w3.org/Graphics/SVG/1.1/DTD/svg11.dtd">
<!-- Generated by graphviz version 2.40.1 (20161225.0304)
 -->
<!-- Title: Graph Key Pages: 1 -->
<svg width="190pt" height="32pt"
 viewBox="0.00 0.00 190.00 32.00" xmlns="http://www.w3.org/2000/svg" xmlns:xlink="http://www.w3.org/1999/xlink">
<g id="graph0" class="graph" transform="scale(1 1) rotate(0) translate(4 28)">
<title>Graph Key</title>
<polygon fill="#ffffff" stroke="transparent" points="-4,4 -4,-28 186,-28 186,4 -4,4"/>
<!-- Source File -->
<g id="node1" class="node">
<title>Source File</title>
<polygon fill="#f0ad4e" stroke="#f0ad4e" points="67,-24 0,-24 0,0 67,0 67,-24"/>
<text text-anchor="middle" x="33.5" y="-9.6" font-family="Helvetica,sans-Serif" font-size="10.50" fill="#ffffff">Source File</text>
</g>
<!-- This Page&#39;s Entity -->
<g id="node2" class="node">
<title>This Page&#39;s Entity</title>
<polygon fill="none" stroke="#000000" points="182,-24 85,-24 85,0 182,0 182,-24"/>
<text text-anchor="middle" x="133.5" y="-9.6" font-family="Helvetica,sans-Serif" font-size="10.50" fill="#000000">This Page&#39;s Entity</text>
</g>
</g>
</svg>

    
    <p>Solid arrows point from a file to a file which it depends on. A file
    is dependent upon another if the latter must be compiled before the former
    can be. Where possible, edges connecting nodes are given different colours to make them easier to distinguish in large graphs.
    </p>
    </div></div></div></div>
      </div>
    </div>
      
      <br>

    <section class="visible-xs visible-sm hidden-md">
      
<h3>Contents</h3>
 







<div class="panel panel-primary">
  <div class="panel-heading text-left"><h3 class="panel-title"><a data-toggle="collapse" href="#mods-1">Modules</a></h3></div>
  <div id="mods-1" class="panel-collapse collapse">
    <div class="list-group">
      
      <a class="list-group-item" href="../module/modibm.html">modibm</a>
      
    </div>
  </div>
</div>
















<div class="panel panel-primary">
  <div class="panel-heading text-left"><h3 class="panel-title">Source Code</h3></div>
  <div class="list-group">
    <a class="list-group-item" href="../sourcefile/modibm.f90.html#src">modibm.f90</a>
  </div>
</div>



    </section>
    <br class="visible-xs visible-sm hidden-md">

    <section>
      <h2><span class="anchor" id="src"></span>Source Code</h2>
    <div class="hl"><pre><span></span><a name="ln-1"></a><span class="c">!!&gt; \file modibm.f90</span>
<a name="ln-2"></a><span class="c">!!!  adds forcing terms for immersed boundaries</span>
<a name="ln-3"></a><span class="c">!</span>
<a name="ln-4"></a><span class="c">!&gt;</span>
<a name="ln-5"></a><span class="c">!!  \author Jasper Thomas TU Delft / Ivo Suter Imperial College London</span>
<a name="ln-6"></a><span class="c">!</span>
<a name="ln-7"></a><span class="c">!</span>
<a name="ln-8"></a><span class="k">module </span><span class="n">modibm</span>
<a name="ln-9"></a>   <span class="k">use </span><span class="n">modibmdata</span>
<a name="ln-10"></a>   <span class="c">!use wf_uno</span>
<a name="ln-11"></a>   <span class="k">implicit none</span>
<a name="ln-12"></a><span class="k">   save</span>
<a name="ln-13"></a><span class="k">   public</span> <span class="kd">::</span> <span class="n">createwalls</span><span class="p">,</span> <span class="n">ibmwallfun</span><span class="p">,</span> <span class="n">xwallfun</span><span class="p">,</span> <span class="n">ywallfunplus</span><span class="p">,</span> <span class="n">ywallfunmin</span><span class="p">,</span> <span class="p">&amp;</span>
<a name="ln-14"></a>             <span class="n">zwallfun</span><span class="p">,</span> <span class="n">ibmnorm</span><span class="p">,</span> <span class="n">nearwall</span><span class="p">,</span> <span class="n">bottom</span>
<a name="ln-15"></a>
<a name="ln-16"></a>   <span class="k">contains</span>
<a name="ln-17"></a><span class="k">   subroutine </span><span class="n">createwalls</span>
<a name="ln-18"></a>      <span class="k">use </span><span class="n">modglobal</span><span class="p">,</span> <span class="n">only</span><span class="p">:</span><span class="n">ib</span><span class="p">,</span> <span class="n">ie</span><span class="p">,</span> <span class="n">jb</span><span class="p">,</span> <span class="n">je</span><span class="p">,</span> <span class="n">jgb</span><span class="p">,</span> <span class="n">jge</span><span class="p">,</span> <span class="n">kb</span><span class="p">,</span> <span class="n">ke</span><span class="p">,</span> <span class="n">jmax</span><span class="p">,</span> <span class="n">nblocks</span><span class="p">,</span> <span class="p">&amp;</span>
<a name="ln-19"></a>         <span class="n">nsv</span><span class="p">,</span> <span class="n">cexpnr</span><span class="p">,</span> <span class="n">ifinput</span><span class="p">,</span> <span class="n">libm</span><span class="p">,</span> <span class="n">ih</span><span class="p">,</span> <span class="n">kh</span><span class="p">,</span> <span class="n">iwallmom</span><span class="p">,</span> <span class="n">iwalltemp</span><span class="p">,</span> <span class="n">iwallmoist</span><span class="p">,</span> <span class="n">rslabs</span><span class="p">,</span> <span class="n">bldT</span>
<a name="ln-20"></a>      <span class="k">use </span><span class="n">modsurfdata</span><span class="p">,</span> <span class="n">only</span><span class="p">:</span><span class="n">thls</span><span class="p">,</span> <span class="n">z0h</span><span class="p">,</span> <span class="n">z0</span><span class="p">,</span> <span class="n">thvs</span>
<a name="ln-21"></a>      <span class="k">use </span><span class="n">modfields</span><span class="p">,</span> <span class="n">only</span><span class="p">:</span><span class="n">sv0</span><span class="p">,</span> <span class="n">svm</span><span class="p">,</span> <span class="n">thl0</span><span class="p">,</span> <span class="n">thlm</span><span class="p">,</span> <span class="n">qtp</span><span class="p">,</span> <span class="n">qt0</span><span class="p">,</span> <span class="n">IIc</span><span class="p">,</span> <span class="n">IIu</span><span class="p">,</span> <span class="n">IIv</span><span class="p">,</span> <span class="n">IIw</span><span class="p">,</span> <span class="n">IIct</span><span class="p">,</span> <span class="n">IIwt</span><span class="p">,</span> <span class="n">IIcs</span><span class="p">,</span> <span class="n">IIus</span><span class="p">,</span> <span class="n">IIvs</span><span class="p">,</span> <span class="n">IIws</span>
<a name="ln-22"></a>      <span class="k">use </span><span class="n">modmpi</span><span class="p">,</span> <span class="n">only</span><span class="p">:</span><span class="n">myid</span><span class="p">,</span> <span class="n">comm3d</span><span class="p">,</span> <span class="n">mpierr</span><span class="p">,</span> <span class="n">MPI_INTEGER</span><span class="p">,</span> <span class="n">MPI_DOUBLE_PRECISION</span><span class="p">,</span> <span class="n">MY_REAL</span><span class="p">,</span> <span class="n">nprocs</span><span class="p">,</span> <span class="n">cmyid</span><span class="p">,</span> <span class="p">&amp;</span>
<a name="ln-23"></a>         <span class="n">MPI_REAL8</span><span class="p">,</span> <span class="n">MPI_REAL4</span><span class="p">,</span> <span class="n">MPI_SUM</span>
<a name="ln-24"></a>      <span class="k">use </span><span class="n">initfac</span><span class="p">,</span> <span class="n">only</span><span class="p">:</span><span class="k">block</span>
<a name="ln-25"></a><span class="k">      </span><span class="kt">integer </span><span class="n">n</span><span class="p">,</span> <span class="n">nn</span><span class="p">,</span> <span class="n">pn</span><span class="p">,</span> <span class="n">mn</span><span class="p">,</span> <span class="n">jbeg</span><span class="p">,</span> <span class="n">jend</span><span class="p">,</span> <span class="n">nxn</span><span class="p">,</span> <span class="n">nxs</span><span class="p">,</span> <span class="n">nyn</span><span class="p">,</span> <span class="n">nzn</span><span class="p">,</span> <span class="n">nzs</span><span class="p">,</span> <span class="n">iu</span><span class="p">,</span> <span class="n">il</span><span class="p">,</span> <span class="n">ju</span><span class="p">,</span> <span class="n">jl</span><span class="p">,</span> <span class="n">ku</span><span class="p">,</span> <span class="n">kl</span><span class="p">,</span> <span class="n">sc</span><span class="p">,</span> <span class="p">&amp;</span>
<a name="ln-26"></a>         <span class="n">i</span><span class="p">,</span> <span class="n">k</span><span class="p">,</span> <span class="n">dbi</span><span class="p">,</span> <span class="n">dbj</span><span class="p">,</span> <span class="n">dbk</span>
<a name="ln-27"></a>      <span class="kt">integer</span> <span class="kd">::</span> <span class="n">IIcl</span><span class="p">(</span><span class="n">kb</span><span class="p">:</span><span class="n">ke</span> <span class="o">+</span> <span class="n">kh</span><span class="p">),</span> <span class="n">IIul</span><span class="p">(</span><span class="n">kb</span><span class="p">:</span><span class="n">ke</span> <span class="o">+</span> <span class="n">kh</span><span class="p">),</span> <span class="n">IIvl</span><span class="p">(</span><span class="n">kb</span><span class="p">:</span><span class="n">ke</span> <span class="o">+</span> <span class="n">kh</span><span class="p">),</span> <span class="n">IIwl</span><span class="p">(</span><span class="n">kb</span><span class="p">:</span><span class="n">ke</span> <span class="o">+</span> <span class="n">kh</span><span class="p">)</span>
<a name="ln-28"></a>      <span class="kt">integer</span> <span class="kd">::</span> <span class="n">IIcd</span><span class="p">(</span><span class="n">ib</span> <span class="o">-</span> <span class="n">ih</span><span class="p">:</span><span class="n">ie</span> <span class="o">+</span> <span class="n">ih</span><span class="p">,</span> <span class="n">kb</span><span class="p">:</span><span class="n">ke</span> <span class="o">+</span> <span class="n">kh</span><span class="p">)</span>
<a name="ln-29"></a>      <span class="kt">integer</span> <span class="kd">::</span> <span class="n">IIwd</span><span class="p">(</span><span class="n">ib</span> <span class="o">-</span> <span class="n">ih</span><span class="p">:</span><span class="n">ie</span> <span class="o">+</span> <span class="n">ih</span><span class="p">,</span> <span class="n">kb</span><span class="p">:</span><span class="n">ke</span> <span class="o">+</span> <span class="n">kh</span><span class="p">)</span>
<a name="ln-30"></a>      <span class="kt">character</span><span class="p">(</span><span class="mi">80</span><span class="p">)</span> <span class="n">chmess</span><span class="p">,</span> <span class="n">name2</span>
<a name="ln-31"></a>
<a name="ln-32"></a>      <span class="k">if</span> <span class="p">(.</span><span class="nb">not</span><span class="p">.</span> <span class="n">libm</span><span class="p">)</span> <span class="k">return</span>
<a name="ln-33"></a>
<a name="ln-34"></a>      <span class="c">! check if walls are at least 2 cells in each dimension</span>
<a name="ln-35"></a>      <span class="k">do </span><span class="n">n</span> <span class="o">=</span> <span class="mi">1</span><span class="p">,</span> <span class="n">nblocks</span>
<a name="ln-36"></a>         <span class="n">dbi</span> <span class="o">=</span> <span class="k">block</span><span class="p">(</span><span class="n">n</span><span class="p">,</span> <span class="mi">2</span><span class="p">)</span> <span class="o">-</span> <span class="k">block</span><span class="p">(</span><span class="n">n</span><span class="p">,</span> <span class="mi">1</span><span class="p">)</span>
<a name="ln-37"></a>         <span class="n">dbj</span> <span class="o">=</span> <span class="k">block</span><span class="p">(</span><span class="n">n</span><span class="p">,</span> <span class="mi">4</span><span class="p">)</span> <span class="o">-</span> <span class="k">block</span><span class="p">(</span><span class="n">n</span><span class="p">,</span> <span class="mi">3</span><span class="p">)</span>
<a name="ln-38"></a>         <span class="n">dbk</span> <span class="o">=</span> <span class="k">block</span><span class="p">(</span><span class="n">n</span><span class="p">,</span> <span class="mi">6</span><span class="p">)</span> <span class="o">-</span> <span class="k">block</span><span class="p">(</span><span class="n">n</span><span class="p">,</span> <span class="mi">5</span><span class="p">)</span>
<a name="ln-39"></a>         <span class="k">if</span> <span class="p">(</span><span class="nb">any</span><span class="p">((</span><span class="o">/</span><span class="n">dbi</span><span class="p">,</span> <span class="n">dbj</span><span class="p">,</span> <span class="n">dbk</span><span class="o">/</span><span class="p">)</span> <span class="o">&lt;</span> <span class="mi">1</span><span class="p">))</span> <span class="k">then</span>
<a name="ln-40"></a><span class="k">            write</span><span class="p">(</span><span class="mi">6</span><span class="p">,</span> <span class="o">*</span><span class="p">)</span> <span class="s2">&quot;blocks not at least 2 cells in each dimension, or upper limit &lt; lower limit&quot;</span>
<a name="ln-41"></a>            <span class="c">!stop  !ils13 19.07.17, don&#39;t stop for now</span>
<a name="ln-42"></a>         <span class="k">end if</span>
<a name="ln-43"></a><span class="k">      end do</span>
<a name="ln-44"></a>
<a name="ln-45"></a>      <span class="c">! For all blocks set the internal concentrations to zero and internal</span>
<a name="ln-46"></a>      <span class="c">! temperature to building temperature</span>
<a name="ln-47"></a>      <span class="k">do </span><span class="n">n</span> <span class="o">=</span> <span class="mi">1</span><span class="p">,</span> <span class="n">nblocks</span>
<a name="ln-48"></a>         <span class="n">il</span> <span class="o">=</span> <span class="k">block</span><span class="p">(</span><span class="n">n</span><span class="p">,</span> <span class="mi">1</span><span class="p">)</span>
<a name="ln-49"></a>         <span class="n">iu</span> <span class="o">=</span> <span class="k">block</span><span class="p">(</span><span class="n">n</span><span class="p">,</span> <span class="mi">2</span><span class="p">)</span>
<a name="ln-50"></a>         <span class="n">kl</span> <span class="o">=</span> <span class="k">block</span><span class="p">(</span><span class="n">n</span><span class="p">,</span> <span class="mi">5</span><span class="p">)</span>
<a name="ln-51"></a>         <span class="n">ku</span> <span class="o">=</span> <span class="k">block</span><span class="p">(</span><span class="n">n</span><span class="p">,</span> <span class="mi">6</span><span class="p">)</span>
<a name="ln-52"></a>         <span class="n">jl</span> <span class="o">=</span> <span class="k">block</span><span class="p">(</span><span class="n">n</span><span class="p">,</span> <span class="mi">3</span><span class="p">)</span> <span class="o">-</span> <span class="n">myid</span><span class="o">*</span><span class="n">jmax</span>
<a name="ln-53"></a>         <span class="n">ju</span> <span class="o">=</span> <span class="k">block</span><span class="p">(</span><span class="n">n</span><span class="p">,</span> <span class="mi">4</span><span class="p">)</span> <span class="o">-</span> <span class="n">myid</span><span class="o">*</span><span class="n">jmax</span>
<a name="ln-54"></a>		 
<a name="ln-55"></a>         <span class="k">if</span> <span class="p">((</span><span class="n">ju</span> <span class="o">&lt;</span> <span class="n">jb</span> <span class="o">-</span> <span class="mi">1</span><span class="p">)</span> <span class="p">.</span><span class="nb">or</span><span class="p">.</span> <span class="p">(</span><span class="n">jl</span> <span class="o">&gt;</span> <span class="n">je</span> <span class="o">+</span> <span class="mi">1</span><span class="p">))</span> <span class="k">then</span> <span class="c">! The block is entirely out of this partition</span>
<a name="ln-56"></a>            <span class="k">cycle</span>
<a name="ln-57"></a><span class="k">         end if</span>
<a name="ln-58"></a><span class="k">         if</span> <span class="p">(</span><span class="n">ju</span> <span class="o">&gt;</span> <span class="n">je</span><span class="p">)</span> <span class="n">ju</span><span class="o">=</span><span class="n">je</span> <span class="c">!tg3315 and bss116 added 23.10.18 as bad allocation otherwise.</span>
<a name="ln-59"></a>         <span class="k">if</span> <span class="p">(</span><span class="n">jl</span> <span class="o">&lt;</span> <span class="n">jb</span><span class="p">)</span> <span class="n">jl</span><span class="o">=</span><span class="n">jb</span>
<a name="ln-60"></a>         <span class="k">do </span><span class="n">sc</span> <span class="o">=</span> <span class="mi">1</span><span class="p">,</span> <span class="n">nsv</span>
<a name="ln-61"></a>            <span class="c">!sv0(il:iu, jl:ju, kl:ku, sc) = svprof(kl:ku)  !internal ! tg3315 commented to avoid flux at startup</span>
<a name="ln-62"></a>            <span class="c">!svm(il:iu, jl:ju, kl:ku, sc) = svprof(kl:ku)  !internal</span>
<a name="ln-63"></a>         <span class="k">end do</span>
<a name="ln-64"></a><span class="k">         </span><span class="n">thl0</span><span class="p">(</span><span class="n">il</span><span class="p">:</span><span class="n">iu</span><span class="p">,</span> <span class="n">jl</span><span class="p">:</span><span class="n">ju</span><span class="p">,</span> <span class="n">kl</span><span class="p">:</span><span class="n">ku</span><span class="p">)</span> <span class="o">=</span> <span class="n">bldT</span> <span class="c">!internal ! make sure bldT is equal to init thl prof</span>
<a name="ln-65"></a>         <span class="n">thlm</span><span class="p">(</span><span class="n">il</span><span class="p">:</span><span class="n">iu</span><span class="p">,</span> <span class="n">jl</span><span class="p">:</span><span class="n">ju</span><span class="p">,</span> <span class="n">kl</span><span class="p">:</span><span class="n">ku</span><span class="p">)</span> <span class="o">=</span> <span class="n">bldT</span> <span class="c">!internal</span>
<a name="ln-66"></a>      <span class="k">end do</span>
<a name="ln-67"></a><span class="k">      </span>
<a name="ln-68"></a><span class="k">      </span><span class="n">nxwall</span> <span class="o">=</span> <span class="mi">0</span>
<a name="ln-69"></a>      <span class="k">do </span><span class="n">n</span> <span class="o">=</span> <span class="mi">1</span><span class="p">,</span> <span class="n">nblocks</span> <span class="c">! first x and z walls</span>
<a name="ln-70"></a>         <span class="k">if</span> <span class="p">(</span><span class="k">block</span><span class="p">(</span><span class="n">n</span><span class="p">,</span> <span class="mi">4</span><span class="p">)</span> <span class="o">&lt;</span> <span class="n">jb</span> <span class="o">+</span> <span class="n">myid</span><span class="o">*</span><span class="n">jmax</span><span class="p">)</span> <span class="k">then</span> <span class="c">! no x-wall/z-wall in the range of this proc</span>
<a name="ln-71"></a>            <span class="k">cycle</span>
<a name="ln-72"></a><span class="k">         </span><span class="n">elseif</span> <span class="p">(</span><span class="k">block</span><span class="p">(</span><span class="n">n</span><span class="p">,</span> <span class="mi">3</span><span class="p">)</span> <span class="o">&gt;</span> <span class="n">je</span> <span class="o">+</span> <span class="n">myid</span><span class="o">*</span><span class="n">jmax</span><span class="p">)</span> <span class="k">then</span> <span class="c">! no x-wall/z-wall in the range of this proc</span>
<a name="ln-73"></a>            <span class="k">cycle</span>
<a name="ln-74"></a><span class="k">         else</span> <span class="c">! x-wall/z-wall found on this proc</span>
<a name="ln-75"></a>            <span class="n">nxwall</span> <span class="o">=</span> <span class="n">nxwall</span> <span class="o">+</span> <span class="mi">1</span>
<a name="ln-76"></a>         <span class="k">end if</span>
<a name="ln-77"></a><span class="k">      end do</span>
<a name="ln-78"></a><span class="k">      allocate</span> <span class="p">(</span><span class="n">ixwall</span><span class="p">(</span><span class="n">nxwall</span><span class="p">))</span> <span class="c">!allocate the list that stores the indeces of the blocks on this cpu</span>
<a name="ln-79"></a>
<a name="ln-80"></a>      <span class="n">k</span> <span class="o">=</span> <span class="mi">1</span>
<a name="ln-81"></a>      <span class="k">do </span><span class="n">n</span> <span class="o">=</span> <span class="mi">1</span><span class="p">,</span> <span class="n">nblocks</span> <span class="c">! save indeces of the found x/z-walls by re-iterating</span>
<a name="ln-82"></a>         <span class="k">if</span> <span class="p">(</span><span class="k">block</span><span class="p">(</span><span class="n">n</span><span class="p">,</span> <span class="mi">4</span><span class="p">)</span> <span class="o">&lt;</span> <span class="n">jb</span> <span class="o">+</span> <span class="n">myid</span><span class="o">*</span><span class="n">jmax</span><span class="p">)</span> <span class="k">then</span> <span class="c">! no x-wall/z-wall in the range of this proc</span>
<a name="ln-83"></a>            <span class="k">cycle</span>
<a name="ln-84"></a><span class="k">         </span><span class="n">elseif</span> <span class="p">(</span><span class="k">block</span><span class="p">(</span><span class="n">n</span><span class="p">,</span> <span class="mi">3</span><span class="p">)</span> <span class="o">&gt;</span> <span class="n">je</span> <span class="o">+</span> <span class="n">myid</span><span class="o">*</span><span class="n">jmax</span><span class="p">)</span> <span class="k">then</span> <span class="c">! no x-wall/z-wall in the range of this proc</span>
<a name="ln-85"></a>            <span class="k">cycle</span>
<a name="ln-86"></a><span class="k">         else</span>
<a name="ln-87"></a><span class="k">            </span><span class="n">ixwall</span><span class="p">(</span><span class="n">k</span><span class="p">)</span> <span class="o">=</span> <span class="n">n</span> <span class="c">! save index of block which is on this processor</span>
<a name="ln-88"></a>            <span class="n">k</span> <span class="o">=</span> <span class="n">k</span> <span class="o">+</span> <span class="mi">1</span>
<a name="ln-89"></a>         <span class="k">end if</span>
<a name="ln-90"></a><span class="k">      end do</span>
<a name="ln-91"></a>
<a name="ln-92"></a>      <span class="c">!!new approach both y walls#################################################</span>
<a name="ln-93"></a>      <span class="c">!!store index of block and index of the wall (since block might not be on this cpu, but is needed for x and z coords)</span>
<a name="ln-94"></a>      <span class="c">!!check if wall is on next cpu but not on this</span>
<a name="ln-95"></a>      <span class="c">!!check if wall is on last cpu but not on first (periodicity in y)</span>
<a name="ln-96"></a>      <span class="c">!check if wall is on first cpu but not on last (periodicity in y)</span>
<a name="ln-97"></a>      <span class="c">!!check if wall is on this cpu and another one on the next (i.e. both blocks end at cpu boundary, but touch each other)</span>
<a name="ln-98"></a>
<a name="ln-99"></a>      <span class="n">nyminwall</span> <span class="o">=</span> <span class="mi">0</span>
<a name="ln-100"></a>      <span class="n">nypluswall</span> <span class="o">=</span> <span class="mi">0</span>
<a name="ln-101"></a>
<a name="ln-102"></a>      <span class="k">do </span><span class="n">n</span> <span class="o">=</span> <span class="mi">1</span><span class="p">,</span> <span class="n">nblocks</span>
<a name="ln-103"></a>
<a name="ln-104"></a>         <span class="n">jl</span> <span class="o">=</span> <span class="k">block</span><span class="p">(</span><span class="n">n</span><span class="p">,</span> <span class="mi">3</span><span class="p">)</span> <span class="o">-</span> <span class="n">myid</span><span class="o">*</span><span class="n">jmax</span>
<a name="ln-105"></a>         <span class="n">ju</span> <span class="o">=</span> <span class="k">block</span><span class="p">(</span><span class="n">n</span><span class="p">,</span> <span class="mi">4</span><span class="p">)</span> <span class="o">-</span> <span class="n">myid</span><span class="o">*</span><span class="n">jmax</span>
<a name="ln-106"></a>
<a name="ln-107"></a>         <span class="c">!IMPORTANT: THESE LINES OF CODE SHOULD BE HERE BUT CAUSE TROUBLE! MAKE SURE BLOCK DOES NOT TOUCH BOUNDARY (EXCECPT ALL FLOORS)</span>
<a name="ln-108"></a>         <span class="c">!SEE ALSO BELOW! (Like 40 lines or so)</span>
<a name="ln-109"></a>         <span class="k">if</span> <span class="p">((</span><span class="n">myid</span> <span class="o">==</span> <span class="mi">0</span><span class="p">)</span> <span class="p">.</span><span class="nb">and</span><span class="p">.</span> <span class="p">(</span><span class="k">block</span><span class="p">(</span><span class="n">n</span><span class="p">,</span> <span class="mi">4</span><span class="p">)</span> <span class="o">==</span> <span class="n">jge</span><span class="p">))</span> <span class="k">then</span> <span class="c">! periodicity!</span>
<a name="ln-110"></a>            <span class="n">nypluswall</span> <span class="o">=</span> <span class="n">nypluswall</span> <span class="o">+</span> <span class="mi">1</span>
<a name="ln-111"></a>         <span class="k">else if</span> <span class="p">((</span><span class="k">block</span><span class="p">(</span><span class="n">n</span><span class="p">,</span> <span class="mi">3</span><span class="p">)</span> <span class="o">==</span> <span class="n">jgb</span><span class="p">)</span> <span class="p">.</span><span class="nb">and</span><span class="p">.</span> <span class="p">(</span><span class="n">myid</span> <span class="o">==</span> <span class="p">(</span><span class="n">nprocs</span> <span class="o">-</span> <span class="mi">1</span><span class="p">)))</span> <span class="k">then</span> <span class="c">! periodicity!</span>
<a name="ln-112"></a>            <span class="n">nyminwall</span> <span class="o">=</span> <span class="n">nyminwall</span> <span class="o">+</span> <span class="mi">1</span>
<a name="ln-113"></a>         <span class="k">end if</span>
<a name="ln-114"></a>
<a name="ln-115"></a><span class="k">         if</span> <span class="p">((</span><span class="n">ju</span> <span class="o">&lt;</span> <span class="p">(</span><span class="n">jb</span> <span class="o">-</span> <span class="mi">1</span><span class="p">))</span> <span class="p">.</span><span class="nb">or</span><span class="p">.</span> <span class="p">(</span><span class="n">jl</span> <span class="o">&gt;</span> <span class="p">(</span><span class="n">je</span> <span class="o">+</span> <span class="mi">1</span><span class="p">)))</span> <span class="k">then</span>
<a name="ln-116"></a><span class="k">            cycle</span>
<a name="ln-117"></a><span class="k">         end if</span>
<a name="ln-118"></a>
<a name="ln-119"></a><span class="k">         if</span> <span class="p">(</span><span class="n">ju</span> <span class="o">==</span> <span class="p">(</span><span class="n">jb</span> <span class="o">-</span> <span class="mi">1</span><span class="p">))</span> <span class="k">then</span> <span class="c">!block on previous cpu, north wall on this</span>
<a name="ln-120"></a>            <span class="n">nypluswall</span> <span class="o">=</span> <span class="n">nypluswall</span> <span class="o">+</span> <span class="mi">1</span> <span class="c">!</span>
<a name="ln-121"></a>            <span class="k">cycle</span>
<a name="ln-122"></a><span class="k">         end if</span>
<a name="ln-123"></a>
<a name="ln-124"></a><span class="k">         if</span> <span class="p">(</span><span class="n">jl</span> <span class="o">==</span> <span class="p">(</span><span class="n">je</span> <span class="o">+</span> <span class="mi">1</span><span class="p">))</span> <span class="k">then</span>
<a name="ln-125"></a><span class="k">            </span><span class="n">nyminwall</span> <span class="o">=</span> <span class="n">nyminwall</span> <span class="o">+</span> <span class="mi">1</span> <span class="c">!block on next cpu, southwall on this</span>
<a name="ln-126"></a>            <span class="k">cycle</span>
<a name="ln-127"></a><span class="k">         end if</span>
<a name="ln-128"></a>
<a name="ln-129"></a><span class="k">         if</span> <span class="p">((</span><span class="n">ju</span> <span class="o">&lt;</span> <span class="n">je</span><span class="p">)</span> <span class="p">.</span><span class="nb">and</span><span class="p">.</span> <span class="p">(</span><span class="n">ju</span> <span class="o">&gt;=</span> <span class="n">jb</span><span class="p">))</span> <span class="k">then</span> <span class="c">!block &amp; northwall on this cpu</span>
<a name="ln-130"></a>            <span class="n">nypluswall</span> <span class="o">=</span> <span class="n">nypluswall</span> <span class="o">+</span> <span class="mi">1</span>
<a name="ln-131"></a>         <span class="k">end if</span>
<a name="ln-132"></a>
<a name="ln-133"></a><span class="k">         if</span> <span class="p">((</span><span class="n">jl</span> <span class="o">&gt;</span> <span class="n">jb</span><span class="p">)</span> <span class="p">.</span><span class="nb">and</span><span class="p">.</span> <span class="p">(</span><span class="n">jl</span> <span class="o">&lt;=</span> <span class="n">je</span><span class="p">))</span> <span class="k">then</span> <span class="c">!block &amp; southwall on this cpu</span>
<a name="ln-134"></a>            <span class="n">nyminwall</span> <span class="o">=</span> <span class="n">nyminwall</span> <span class="o">+</span> <span class="mi">1</span>
<a name="ln-135"></a>         <span class="k">end if</span>
<a name="ln-136"></a><span class="k">      end do</span>
<a name="ln-137"></a>
<a name="ln-138"></a><span class="k">      allocate</span> <span class="p">(</span><span class="n">iyminwall</span><span class="p">(</span><span class="mi">1</span><span class="p">:</span><span class="n">nyminwall</span><span class="p">,</span> <span class="mi">1</span><span class="p">:</span><span class="mi">2</span><span class="p">))</span> <span class="c">!two indeces to store wall index and block index</span>
<a name="ln-139"></a>      <span class="k">allocate</span> <span class="p">(</span><span class="n">iypluswall</span><span class="p">(</span><span class="mi">1</span><span class="p">:</span><span class="n">nypluswall</span><span class="p">,</span> <span class="mi">1</span><span class="p">:</span><span class="mi">2</span><span class="p">))</span>
<a name="ln-140"></a>      <span class="n">iyminwall</span><span class="p">(:,</span> <span class="mi">1</span><span class="p">)</span> <span class="o">=</span> <span class="mi">0</span>
<a name="ln-141"></a>      <span class="n">iyminwall</span><span class="p">(:,</span> <span class="mi">2</span><span class="p">)</span> <span class="o">=</span> <span class="mi">0</span>
<a name="ln-142"></a>      <span class="n">iypluswall</span><span class="p">(:,</span> <span class="mi">1</span><span class="p">)</span> <span class="o">=</span> <span class="mi">0</span>
<a name="ln-143"></a>      <span class="n">iypluswall</span><span class="p">(:,</span> <span class="mi">2</span><span class="p">)</span> <span class="o">=</span> <span class="mi">0</span>
<a name="ln-144"></a>      <span class="n">pn</span> <span class="o">=</span> <span class="mi">1</span>
<a name="ln-145"></a>      <span class="n">mn</span> <span class="o">=</span> <span class="mi">1</span>
<a name="ln-146"></a>
<a name="ln-147"></a>      <span class="k">do </span><span class="n">n</span> <span class="o">=</span> <span class="mi">1</span><span class="p">,</span> <span class="n">nblocks</span>
<a name="ln-148"></a>
<a name="ln-149"></a>         <span class="n">jl</span> <span class="o">=</span> <span class="k">block</span><span class="p">(</span><span class="n">n</span><span class="p">,</span> <span class="mi">3</span><span class="p">)</span> <span class="o">-</span> <span class="n">myid</span><span class="o">*</span><span class="n">jmax</span>
<a name="ln-150"></a>         <span class="n">ju</span> <span class="o">=</span> <span class="k">block</span><span class="p">(</span><span class="n">n</span><span class="p">,</span> <span class="mi">4</span><span class="p">)</span> <span class="o">-</span> <span class="n">myid</span><span class="o">*</span><span class="n">jmax</span>
<a name="ln-151"></a>
<a name="ln-152"></a>         <span class="c">!IMPORTANT: THESE LINES OF CODE SHOULD BE HERE BUT CAUSE TROUBLE! MAKE SURE BLOCK DOES NOT TOUCH BOUNDARY (EXCECPT ALL FLOORS)</span>
<a name="ln-153"></a>         <span class="k">if</span> <span class="p">((</span><span class="n">myid</span> <span class="o">==</span> <span class="mi">0</span><span class="p">)</span> <span class="p">.</span><span class="nb">and</span><span class="p">.</span> <span class="p">(</span><span class="k">block</span><span class="p">(</span><span class="n">n</span><span class="p">,</span> <span class="mi">4</span><span class="p">)</span> <span class="o">==</span> <span class="n">jge</span><span class="p">))</span> <span class="k">then</span> <span class="c">! periodicity!</span>
<a name="ln-154"></a>            <span class="n">iypluswall</span><span class="p">(</span><span class="n">pn</span><span class="p">,</span> <span class="mi">1</span><span class="p">)</span> <span class="o">=</span> <span class="n">n</span>
<a name="ln-155"></a>            <span class="n">iypluswall</span><span class="p">(</span><span class="n">pn</span><span class="p">,</span> <span class="mi">2</span><span class="p">)</span> <span class="o">=</span> <span class="n">jb</span>
<a name="ln-156"></a>            <span class="n">pn</span> <span class="o">=</span> <span class="n">pn</span> <span class="o">+</span> <span class="mi">1</span>
<a name="ln-157"></a>         <span class="k">else if</span> <span class="p">((</span><span class="k">block</span><span class="p">(</span><span class="n">n</span><span class="p">,</span> <span class="mi">3</span><span class="p">)</span> <span class="o">==</span> <span class="n">jgb</span><span class="p">)</span> <span class="p">.</span><span class="nb">and</span><span class="p">.</span> <span class="p">(</span><span class="n">myid</span> <span class="o">==</span> <span class="p">(</span><span class="n">nprocs</span> <span class="o">-</span> <span class="mi">1</span><span class="p">)))</span> <span class="k">then</span> <span class="c">! periodicity!</span>
<a name="ln-158"></a>            <span class="n">iyminwall</span><span class="p">(</span><span class="n">mn</span><span class="p">,</span> <span class="mi">1</span><span class="p">)</span> <span class="o">=</span> <span class="n">n</span>
<a name="ln-159"></a>            <span class="n">iyminwall</span><span class="p">(</span><span class="n">mn</span><span class="p">,</span> <span class="mi">2</span><span class="p">)</span> <span class="o">=</span> <span class="n">je</span>
<a name="ln-160"></a>            <span class="n">mn</span> <span class="o">=</span> <span class="n">mn</span> <span class="o">+</span> <span class="mi">1</span>
<a name="ln-161"></a>         <span class="k">end if</span>
<a name="ln-162"></a>
<a name="ln-163"></a><span class="k">         if</span> <span class="p">((</span><span class="n">ju</span> <span class="o">&lt;</span> <span class="p">(</span><span class="n">jb</span> <span class="o">-</span> <span class="mi">1</span><span class="p">))</span> <span class="p">.</span><span class="nb">or</span><span class="p">.</span> <span class="p">(</span><span class="n">jl</span> <span class="o">&gt;</span> <span class="p">(</span><span class="n">je</span> <span class="o">+</span> <span class="mi">1</span><span class="p">)))</span> <span class="k">then</span>
<a name="ln-164"></a><span class="k">            cycle</span>
<a name="ln-165"></a><span class="k">         end if</span>
<a name="ln-166"></a>
<a name="ln-167"></a><span class="k">         if</span> <span class="p">(</span><span class="n">ju</span> <span class="o">==</span> <span class="p">(</span><span class="n">jb</span> <span class="o">-</span> <span class="mi">1</span><span class="p">))</span> <span class="k">then</span> <span class="c">!block on previous cpu, north wall on this</span>
<a name="ln-168"></a>            <span class="n">iypluswall</span><span class="p">(</span><span class="n">pn</span><span class="p">,</span> <span class="mi">1</span><span class="p">)</span> <span class="o">=</span> <span class="n">n</span>
<a name="ln-169"></a>            <span class="n">iypluswall</span><span class="p">(</span><span class="n">pn</span><span class="p">,</span> <span class="mi">2</span><span class="p">)</span> <span class="o">=</span> <span class="n">jb</span>
<a name="ln-170"></a>            <span class="n">pn</span> <span class="o">=</span> <span class="n">pn</span> <span class="o">+</span> <span class="mi">1</span>
<a name="ln-171"></a>            <span class="k">cycle</span>
<a name="ln-172"></a><span class="k">         end if</span>
<a name="ln-173"></a>
<a name="ln-174"></a><span class="k">         if</span> <span class="p">(</span><span class="n">jl</span> <span class="o">==</span> <span class="p">(</span><span class="n">je</span> <span class="o">+</span> <span class="mi">1</span><span class="p">))</span> <span class="k">then</span> <span class="c">!block on next cpu, south wall on this</span>
<a name="ln-175"></a>            <span class="n">iyminwall</span><span class="p">(</span><span class="n">mn</span><span class="p">,</span> <span class="mi">1</span><span class="p">)</span> <span class="o">=</span> <span class="n">n</span>
<a name="ln-176"></a>            <span class="n">iyminwall</span><span class="p">(</span><span class="n">mn</span><span class="p">,</span> <span class="mi">2</span><span class="p">)</span> <span class="o">=</span> <span class="n">je</span>
<a name="ln-177"></a>            <span class="n">mn</span> <span class="o">=</span> <span class="n">mn</span> <span class="o">+</span> <span class="mi">1</span>
<a name="ln-178"></a>            <span class="k">cycle</span>
<a name="ln-179"></a><span class="k">         end if</span>
<a name="ln-180"></a>
<a name="ln-181"></a><span class="k">         if</span> <span class="p">((</span><span class="n">ju</span> <span class="o">&lt;</span> <span class="n">je</span><span class="p">)</span> <span class="p">.</span><span class="nb">and</span><span class="p">.</span> <span class="p">(</span><span class="n">ju</span> <span class="o">&gt;=</span> <span class="n">jb</span><span class="p">))</span> <span class="k">then</span> <span class="c">!block &amp; northwall on this cpu   !ILS13, 5.12.17 following Tom</span>
<a name="ln-182"></a>            <span class="n">iypluswall</span><span class="p">(</span><span class="n">pn</span><span class="p">,</span> <span class="mi">1</span><span class="p">)</span> <span class="o">=</span> <span class="n">n</span>
<a name="ln-183"></a>            <span class="n">iypluswall</span><span class="p">(</span><span class="n">pn</span><span class="p">,</span> <span class="mi">2</span><span class="p">)</span> <span class="o">=</span> <span class="n">ju</span> <span class="o">+</span> <span class="mi">1</span>
<a name="ln-184"></a>            <span class="n">pn</span> <span class="o">=</span> <span class="n">pn</span> <span class="o">+</span> <span class="mi">1</span>
<a name="ln-185"></a>         <span class="k">end if</span>
<a name="ln-186"></a>
<a name="ln-187"></a><span class="k">         if</span> <span class="p">((</span><span class="n">jl</span> <span class="o">&gt;</span> <span class="n">jb</span><span class="p">)</span> <span class="p">.</span><span class="nb">and</span><span class="p">.</span> <span class="p">(</span><span class="n">jl</span> <span class="o">&lt;=</span> <span class="n">je</span><span class="p">))</span> <span class="k">then</span> <span class="c">!block &amp; southwall on this cpu</span>
<a name="ln-188"></a>            <span class="n">iyminwall</span><span class="p">(</span><span class="n">mn</span><span class="p">,</span> <span class="mi">1</span><span class="p">)</span> <span class="o">=</span> <span class="n">n</span>
<a name="ln-189"></a>            <span class="n">iyminwall</span><span class="p">(</span><span class="n">mn</span><span class="p">,</span> <span class="mi">2</span><span class="p">)</span> <span class="o">=</span> <span class="n">jl</span> <span class="o">-</span> <span class="mi">1</span>
<a name="ln-190"></a>            <span class="n">mn</span> <span class="o">=</span> <span class="n">mn</span> <span class="o">+</span> <span class="mi">1</span>
<a name="ln-191"></a>         <span class="k">end if</span>
<a name="ln-192"></a><span class="k">      end do</span>
<a name="ln-193"></a>
<a name="ln-194"></a><span class="k">   end subroutine </span><span class="n">createwalls</span>
<a name="ln-195"></a>
<a name="ln-196"></a>   <span class="k">subroutine </span><span class="n">ibmwallfun</span>
<a name="ln-197"></a>      <span class="k">use </span><span class="n">modglobal</span><span class="p">,</span> <span class="n">only</span><span class="p">:</span><span class="n">libm</span>
<a name="ln-198"></a>      <span class="k">use </span><span class="n">modfields</span><span class="p">,</span> <span class="n">only</span><span class="p">:</span><span class="n">momfluxb</span><span class="p">,</span> <span class="n">tfluxb</span><span class="p">,</span> <span class="n">qfluxb</span>
<a name="ln-199"></a>
<a name="ln-200"></a>      <span class="k">if</span> <span class="p">(</span><span class="n">libm</span><span class="p">)</span> <span class="k">then</span>
<a name="ln-201"></a>         <span class="c">! compute fluxes at IBM</span>
<a name="ln-202"></a>         <span class="n">momfluxb</span> <span class="o">=</span> <span class="mf">0.</span>
<a name="ln-203"></a>         <span class="n">tfluxb</span> <span class="o">=</span> <span class="mf">0.</span>
<a name="ln-204"></a>         <span class="n">qfluxb</span> <span class="o">=</span> <span class="mf">0.</span>
<a name="ln-205"></a>
<a name="ln-206"></a>         <span class="k">call </span><span class="n">xwallfun</span>
<a name="ln-207"></a>         <span class="k">call </span><span class="n">ywallfunplus</span> <span class="c">! due to parallellisation differentiation between + and - side</span>
<a name="ln-208"></a>         <span class="k">call </span><span class="n">ywallfunmin</span> <span class="c">! due to parallellisation differentiation between + and - side</span>
<a name="ln-209"></a>         <span class="k">call </span><span class="n">zwallfun</span>
<a name="ln-210"></a>      <span class="k">end if</span>
<a name="ln-211"></a><span class="k">   end subroutine </span><span class="n">ibmwallfun</span>
<a name="ln-212"></a>
<a name="ln-213"></a>   <span class="k">subroutine </span><span class="n">xwallfun</span>
<a name="ln-214"></a>      <span class="k">use </span><span class="n">modglobal</span><span class="p">,</span> <span class="n">only</span><span class="p">:</span><span class="n">dzf</span><span class="p">,</span> <span class="n">dzhiq</span><span class="p">,</span> <span class="n">dzhi</span><span class="p">,</span> <span class="n">dxf</span><span class="p">,</span> <span class="n">dxfi</span><span class="p">,</span> <span class="n">dxhi</span><span class="p">,</span> <span class="n">dyi</span><span class="p">,</span> <span class="n">lles</span><span class="p">,</span> <span class="n">nsv</span><span class="p">,</span> <span class="n">numol</span><span class="p">,</span> <span class="n">ltempeq</span><span class="p">,</span> <span class="n">lmoist</span><span class="p">,</span> <span class="p">&amp;</span>
<a name="ln-215"></a>         <span class="n">ih</span><span class="p">,</span> <span class="n">jh</span><span class="p">,</span> <span class="n">kh</span><span class="p">,</span> <span class="n">ihc</span><span class="p">,</span> <span class="n">jhc</span><span class="p">,</span> <span class="n">khc</span><span class="p">,</span> <span class="n">dxh</span><span class="p">,</span> <span class="n">dy</span><span class="p">,</span> <span class="n">dt</span><span class="p">,</span> <span class="n">totavtime</span><span class="p">,</span> <span class="n">rk3step</span><span class="p">,</span> <span class="n">ib</span><span class="p">,</span> <span class="n">ie</span><span class="p">,</span> <span class="n">kb</span><span class="p">,</span> <span class="n">ke</span><span class="p">,</span> <span class="n">iwallmom</span><span class="p">,</span> <span class="n">iwalltemp</span><span class="p">,</span> <span class="n">iwallmoist</span><span class="p">,</span> <span class="n">iwallscal</span><span class="p">,</span> <span class="n">nblocks</span>
<a name="ln-216"></a>      <span class="k">use </span><span class="n">modfields</span><span class="p">,</span> <span class="n">only</span><span class="p">:</span><span class="n">um</span><span class="p">,</span> <span class="n">up</span><span class="p">,</span> <span class="n">v0</span><span class="p">,</span> <span class="n">w0</span><span class="p">,</span> <span class="n">vp</span><span class="p">,</span> <span class="n">wp</span><span class="p">,</span> <span class="n">shear</span><span class="p">,</span> <span class="n">thl0</span><span class="p">,</span> <span class="n">thlp</span><span class="p">,</span> <span class="n">qt0</span><span class="p">,</span> <span class="n">qtp</span><span class="p">,</span> <span class="n">sv0</span><span class="p">,</span> <span class="n">svp</span><span class="p">,</span> <span class="n">momfluxb</span><span class="p">,</span> <span class="n">tfluxb</span><span class="p">,</span> <span class="n">exnf</span><span class="p">,</span> <span class="n">cth</span><span class="p">,</span> <span class="n">qfluxb</span>
<a name="ln-217"></a>      <span class="k">use </span><span class="n">initfac</span><span class="p">,</span> <span class="n">only</span><span class="p">:</span><span class="n">fachf</span><span class="p">,</span> <span class="k">block</span><span class="p">,</span> <span class="n">faclGR</span><span class="p">,</span> <span class="n">facef</span><span class="p">,</span> <span class="n">facqsat</span><span class="p">,</span> <span class="n">fachurel</span><span class="p">,</span> <span class="n">facf</span><span class="p">,</span> <span class="n">facT</span><span class="p">,</span> <span class="n">facz0</span><span class="p">,</span><span class="n">facz0h</span>
<a name="ln-218"></a>      <span class="kt">integer </span><span class="n">i</span><span class="p">,</span> <span class="n">j</span><span class="p">,</span> <span class="n">k</span><span class="p">,</span> <span class="n">n</span><span class="p">,</span> <span class="n">nc</span><span class="p">,</span> <span class="n">jl</span><span class="p">,</span> <span class="n">ju</span><span class="p">,</span> <span class="n">kl</span><span class="p">,</span> <span class="n">ku</span><span class="p">,</span> <span class="n">im</span><span class="p">,</span> <span class="n">jm</span><span class="p">,</span> <span class="n">jp</span><span class="p">,</span> <span class="n">km</span><span class="p">,</span> <span class="n">m</span>
<a name="ln-219"></a>      <span class="k">if</span> <span class="p">(</span><span class="n">iwallmom</span> <span class="o">==</span> <span class="mi">1</span><span class="p">)</span> <span class="k">then</span> <span class="c">!fixed flux</span>
<a name="ln-220"></a>      <span class="c">!not implemented</span>
<a name="ln-221"></a>      <span class="k">else if</span> <span class="p">(</span><span class="n">iwallmom</span> <span class="o">==</span> <span class="mi">2</span><span class="p">)</span> <span class="k">then</span> <span class="c">!wall function</span>
<a name="ln-222"></a>         <span class="k">do </span><span class="n">n</span> <span class="o">=</span> <span class="mi">1</span><span class="p">,</span> <span class="n">nxwall</span>
<a name="ln-223"></a>            <span class="n">k</span> <span class="o">=</span> <span class="k">block</span><span class="p">(</span><span class="n">ixwall</span><span class="p">(</span><span class="n">n</span><span class="p">),</span> <span class="mi">8</span><span class="p">)</span> <span class="c">!west side</span>
<a name="ln-224"></a>            <span class="k">call </span><span class="n">wfuno</span><span class="p">(</span><span class="n">ih</span><span class="p">,</span> <span class="n">jh</span><span class="p">,</span> <span class="n">kh</span><span class="p">,</span> <span class="n">vp</span><span class="p">,</span> <span class="n">wp</span><span class="p">,</span> <span class="n">thlp</span><span class="p">,</span> <span class="n">momfluxb</span><span class="p">,</span> <span class="n">tfluxb</span><span class="p">,</span> <span class="n">cth</span><span class="p">,</span> <span class="n">bcTfluxA</span><span class="p">,</span> <span class="n">v0</span><span class="p">,</span> <span class="n">w0</span><span class="p">,</span> <span class="n">thl0</span><span class="p">,</span> <span class="n">facT</span><span class="p">(</span><span class="n">k</span><span class="p">,</span> <span class="mi">1</span><span class="p">),</span> <span class="n">facz0</span><span class="p">(</span><span class="n">k</span><span class="p">),</span> <span class="n">facz0h</span><span class="p">(</span><span class="n">k</span><span class="p">),</span> <span class="n">ixwall</span><span class="p">(</span><span class="n">n</span><span class="p">),</span> <span class="mi">1</span><span class="p">,</span> <span class="mi">11</span><span class="p">)</span>
<a name="ln-225"></a>            <span class="n">k</span> <span class="o">=</span> <span class="k">block</span><span class="p">(</span><span class="n">ixwall</span><span class="p">(</span><span class="n">n</span><span class="p">),</span> <span class="mi">9</span><span class="p">)</span> <span class="c">!east side</span>
<a name="ln-226"></a>            <span class="k">call </span><span class="n">wfuno</span><span class="p">(</span><span class="n">ih</span><span class="p">,</span> <span class="n">jh</span><span class="p">,</span> <span class="n">kh</span><span class="p">,</span> <span class="n">vp</span><span class="p">,</span> <span class="n">wp</span><span class="p">,</span> <span class="n">thlp</span><span class="p">,</span> <span class="n">momfluxb</span><span class="p">,</span> <span class="n">tfluxb</span><span class="p">,</span> <span class="n">cth</span><span class="p">,</span> <span class="n">bcTfluxA</span><span class="p">,</span> <span class="n">v0</span><span class="p">,</span> <span class="n">w0</span><span class="p">,</span> <span class="n">thl0</span><span class="p">,</span> <span class="n">facT</span><span class="p">(</span><span class="n">k</span><span class="p">,</span> <span class="mi">1</span><span class="p">),</span> <span class="n">facz0</span><span class="p">(</span><span class="n">k</span><span class="p">),</span> <span class="n">facz0h</span><span class="p">(</span><span class="n">k</span><span class="p">),</span> <span class="n">ixwall</span><span class="p">(</span><span class="n">n</span><span class="p">),</span> <span class="mi">1</span><span class="p">,</span> <span class="mi">21</span><span class="p">)</span>
<a name="ln-227"></a>         <span class="k">end do</span>
<a name="ln-228"></a><span class="k">      else if</span> <span class="p">(</span><span class="n">iwallmom</span> <span class="o">==</span> <span class="mi">3</span><span class="p">)</span> <span class="k">then</span>
<a name="ln-229"></a><span class="k">         do </span><span class="n">n</span> <span class="o">=</span> <span class="mi">1</span><span class="p">,</span> <span class="n">nxwall</span>
<a name="ln-230"></a>            <span class="n">k</span> <span class="o">=</span> <span class="k">block</span><span class="p">(</span><span class="n">ixwall</span><span class="p">(</span><span class="n">n</span><span class="p">),</span> <span class="mi">8</span><span class="p">)</span> <span class="c">!west side</span>
<a name="ln-231"></a>            <span class="k">call </span><span class="n">wfmneutral</span><span class="p">(</span><span class="n">ih</span><span class="p">,</span> <span class="n">jh</span><span class="p">,</span> <span class="n">kh</span><span class="p">,</span> <span class="n">vp</span><span class="p">,</span> <span class="n">wp</span><span class="p">,</span> <span class="n">momfluxb</span><span class="p">,</span> <span class="n">v0</span><span class="p">,</span> <span class="n">w0</span><span class="p">,</span> <span class="n">facz0</span><span class="p">(</span><span class="n">k</span><span class="p">),</span> <span class="n">ixwall</span><span class="p">(</span><span class="n">n</span><span class="p">),</span> <span class="mi">1</span><span class="p">,</span> <span class="mi">11</span><span class="p">)</span>
<a name="ln-232"></a>            <span class="n">k</span> <span class="o">=</span> <span class="k">block</span><span class="p">(</span><span class="n">ixwall</span><span class="p">(</span><span class="n">n</span><span class="p">),</span> <span class="mi">9</span><span class="p">)</span> <span class="c">!east side</span>
<a name="ln-233"></a>            <span class="k">call </span><span class="n">wfmneutral</span><span class="p">(</span><span class="n">ih</span><span class="p">,</span> <span class="n">jh</span><span class="p">,</span> <span class="n">kh</span><span class="p">,</span> <span class="n">vp</span><span class="p">,</span> <span class="n">wp</span><span class="p">,</span> <span class="n">momfluxb</span><span class="p">,</span> <span class="n">v0</span><span class="p">,</span> <span class="n">w0</span><span class="p">,</span> <span class="n">facz0</span><span class="p">(</span><span class="n">k</span><span class="p">),</span> <span class="n">ixwall</span><span class="p">(</span><span class="n">n</span><span class="p">),</span> <span class="mi">1</span><span class="p">,</span> <span class="mi">21</span><span class="p">)</span>
<a name="ln-234"></a>        <span class="k">end do</span>
<a name="ln-235"></a><span class="k">      end if</span>
<a name="ln-236"></a>
<a name="ln-237"></a><span class="k">      if</span> <span class="p">(</span><span class="n">ltempeq</span><span class="p">)</span> <span class="k">then</span>
<a name="ln-238"></a><span class="k">      if</span> <span class="p">(</span><span class="n">iwalltemp</span> <span class="o">==</span> <span class="mi">1</span><span class="p">)</span> <span class="k">then</span> <span class="c">!fixed flux</span>
<a name="ln-239"></a>         <span class="k">do </span><span class="n">n</span> <span class="o">=</span> <span class="mi">1</span><span class="p">,</span> <span class="n">nxwall</span> 
<a name="ln-240"></a>            <span class="k">call </span><span class="n">xwallscalar</span><span class="p">(</span><span class="n">ih</span><span class="p">,</span> <span class="n">jh</span><span class="p">,</span> <span class="n">kh</span><span class="p">,</span> <span class="n">thl0</span><span class="p">,</span> <span class="n">thlp</span><span class="p">,</span> <span class="n">bctfxm</span><span class="p">,</span> <span class="n">bctfxp</span><span class="p">,</span> <span class="n">ixwall</span><span class="p">(</span><span class="n">n</span><span class="p">))</span>
<a name="ln-241"></a>         <span class="k">end do</span>
<a name="ln-242"></a><span class="k">      else if</span> <span class="p">(</span><span class="n">iwalltemp</span> <span class="o">==</span> <span class="mi">2</span><span class="p">)</span> <span class="k">then</span>
<a name="ln-243"></a><span class="k">         do </span><span class="n">n</span> <span class="o">=</span> <span class="mi">1</span><span class="p">,</span> <span class="n">nxwall</span>
<a name="ln-244"></a>            <span class="n">k</span> <span class="o">=</span> <span class="k">block</span><span class="p">(</span><span class="n">ixwall</span><span class="p">(</span><span class="n">n</span><span class="p">),</span> <span class="mi">8</span><span class="p">)</span> <span class="c">!west side</span>
<a name="ln-245"></a>            <span class="k">call </span><span class="n">wfuno</span><span class="p">(</span><span class="n">ih</span><span class="p">,</span> <span class="n">jh</span><span class="p">,</span> <span class="n">kh</span><span class="p">,</span> <span class="n">vp</span><span class="p">,</span> <span class="n">wp</span><span class="p">,</span> <span class="n">thlp</span><span class="p">,</span> <span class="n">momfluxb</span><span class="p">,</span> <span class="n">tfluxb</span><span class="p">,</span> <span class="n">cth</span><span class="p">,</span> <span class="n">bcTfluxA</span><span class="p">,</span> <span class="n">v0</span><span class="p">,</span> <span class="n">w0</span><span class="p">,</span> <span class="n">thl0</span><span class="p">,</span> <span class="n">facT</span><span class="p">(</span><span class="n">k</span><span class="p">,</span> <span class="mi">1</span><span class="p">),</span> <span class="n">facz0</span><span class="p">(</span><span class="n">k</span><span class="p">),</span> <span class="n">facz0h</span><span class="p">(</span><span class="n">k</span><span class="p">),</span> <span class="n">ixwall</span><span class="p">(</span><span class="n">n</span><span class="p">),</span> <span class="mi">1</span><span class="p">,</span> <span class="mi">12</span><span class="p">)</span> <span class="c">!left wall</span>
<a name="ln-246"></a>            <span class="n">fachf</span><span class="p">(</span><span class="n">k</span><span class="p">)</span> <span class="o">=</span> <span class="n">fachf</span><span class="p">(</span><span class="n">k</span><span class="p">)</span> <span class="o">+</span> <span class="n">bcTfluxA</span> <span class="c">!accumulate flux from that facet (can be on multiple processors, will be MPI_ALLREDUCEd in modEB)</span>
<a name="ln-247"></a>
<a name="ln-248"></a>            <span class="n">k</span> <span class="o">=</span> <span class="k">block</span><span class="p">(</span><span class="n">ixwall</span><span class="p">(</span><span class="n">n</span><span class="p">),</span> <span class="mi">9</span><span class="p">)</span> <span class="c">!east side</span>
<a name="ln-249"></a>            <span class="k">call </span><span class="n">wfuno</span><span class="p">(</span><span class="n">ih</span><span class="p">,</span> <span class="n">jh</span><span class="p">,</span> <span class="n">kh</span><span class="p">,</span> <span class="n">vp</span><span class="p">,</span> <span class="n">wp</span><span class="p">,</span> <span class="n">thlp</span><span class="p">,</span> <span class="n">momfluxb</span><span class="p">,</span> <span class="n">tfluxb</span><span class="p">,</span> <span class="n">cth</span><span class="p">,</span> <span class="n">bcTfluxA</span><span class="p">,</span> <span class="n">v0</span><span class="p">,</span> <span class="n">w0</span><span class="p">,</span> <span class="n">thl0</span><span class="p">,</span> <span class="n">facT</span><span class="p">(</span><span class="n">k</span><span class="p">,</span> <span class="mi">1</span><span class="p">),</span> <span class="n">facz0</span><span class="p">(</span><span class="n">k</span><span class="p">),</span> <span class="n">facz0h</span><span class="p">(</span><span class="n">k</span><span class="p">),</span> <span class="n">ixwall</span><span class="p">(</span><span class="n">n</span><span class="p">),</span> <span class="mi">1</span><span class="p">,</span> <span class="mi">22</span><span class="p">)</span> <span class="c">!right wall</span>
<a name="ln-250"></a>            <span class="n">fachf</span><span class="p">(</span><span class="n">k</span><span class="p">)</span> <span class="o">=</span> <span class="n">fachf</span><span class="p">(</span><span class="n">k</span><span class="p">)</span> <span class="o">+</span> <span class="n">bcTfluxA</span>
<a name="ln-251"></a>         <span class="k">end do</span>
<a name="ln-252"></a><span class="k">      end if</span>
<a name="ln-253"></a><span class="k">      end if</span>
<a name="ln-254"></a>
<a name="ln-255"></a><span class="k">      if</span> <span class="p">(</span><span class="n">lmoist</span><span class="p">)</span> <span class="k">then</span>
<a name="ln-256"></a><span class="k">      if</span> <span class="p">(</span><span class="n">iwallmoist</span> <span class="o">==</span> <span class="mi">1</span><span class="p">)</span> <span class="k">then</span> <span class="c">!fixed flux</span>
<a name="ln-257"></a>         <span class="k">do </span><span class="n">n</span> <span class="o">=</span> <span class="mi">1</span><span class="p">,</span> <span class="n">nxwall</span> 
<a name="ln-258"></a>            <span class="k">call </span><span class="n">xwallscalar</span><span class="p">(</span><span class="n">ih</span><span class="p">,</span> <span class="n">jh</span><span class="p">,</span> <span class="n">kh</span><span class="p">,</span> <span class="n">qt0</span><span class="p">,</span> <span class="n">qtp</span><span class="p">,</span> <span class="n">bcqfxm</span><span class="p">,</span> <span class="n">bcqfxp</span><span class="p">,</span> <span class="n">ixwall</span><span class="p">(</span><span class="n">n</span><span class="p">))</span>
<a name="ln-259"></a>         <span class="k">end do</span>
<a name="ln-260"></a><span class="k">      end if</span>
<a name="ln-261"></a><span class="k">      if</span> <span class="p">((</span><span class="n">ltempeq</span><span class="p">)</span> <span class="p">.</span><span class="nb">and</span><span class="p">.</span> <span class="p">(</span><span class="n">iwallmoist</span> <span class="o">==</span> <span class="mi">2</span><span class="p">))</span> <span class="k">then</span>
<a name="ln-262"></a><span class="k">         do </span><span class="n">n</span> <span class="o">=</span> <span class="mi">1</span><span class="p">,</span> <span class="n">nxwall</span>
<a name="ln-263"></a>            <span class="n">k</span> <span class="o">=</span> <span class="k">block</span><span class="p">(</span><span class="n">ixwall</span><span class="p">(</span><span class="n">n</span><span class="p">),</span> <span class="mi">8</span><span class="p">)</span>
<a name="ln-264"></a>            <span class="k">if</span> <span class="p">(</span><span class="n">faclGR</span><span class="p">(</span><span class="n">k</span><span class="p">))</span> <span class="k">then</span> <span class="c">!only if it is a vegetated surface</span>
<a name="ln-265"></a>               <span class="k">call </span><span class="n">wfGR</span><span class="p">(</span><span class="n">ih</span><span class="p">,</span> <span class="n">jh</span><span class="p">,</span> <span class="n">kh</span><span class="p">,</span> <span class="n">qtp</span><span class="p">,</span> <span class="n">qfluxb</span><span class="p">,</span> <span class="n">cth</span><span class="p">,</span> <span class="n">bcqfluxA</span><span class="p">,</span> <span class="n">qt0</span><span class="p">(:,</span> <span class="p">:,</span> <span class="p">:),</span> <span class="n">facqsat</span><span class="p">(</span><span class="n">k</span><span class="p">),</span> <span class="n">fachurel</span><span class="p">(</span><span class="n">k</span><span class="p">),</span> <span class="n">facf</span><span class="p">(</span><span class="n">k</span><span class="p">,</span> <span class="mi">4</span><span class="p">),</span> <span class="n">facf</span><span class="p">(</span><span class="n">k</span><span class="p">,</span> <span class="mi">5</span><span class="p">),</span> <span class="n">ixwall</span><span class="p">(</span><span class="n">n</span><span class="p">),</span> <span class="mi">1</span><span class="p">,</span> <span class="mi">12</span><span class="p">)</span> <span class="c">!left wall</span>
<a name="ln-266"></a>               <span class="n">facef</span><span class="p">(</span><span class="n">k</span><span class="p">)</span> <span class="o">=</span> <span class="n">facef</span><span class="p">(</span><span class="n">k</span><span class="p">)</span> <span class="o">+</span> <span class="n">bcqfluxA</span>
<a name="ln-267"></a>            <span class="k">end if</span>
<a name="ln-268"></a><span class="k">            </span><span class="n">k</span> <span class="o">=</span> <span class="k">block</span><span class="p">(</span><span class="n">ixwall</span><span class="p">(</span><span class="n">n</span><span class="p">),</span> <span class="mi">9</span><span class="p">)</span>
<a name="ln-269"></a>            <span class="k">if</span> <span class="p">(</span><span class="n">faclGR</span><span class="p">(</span><span class="n">k</span><span class="p">))</span> <span class="k">then</span>
<a name="ln-270"></a><span class="k">               call </span><span class="n">wfGR</span><span class="p">(</span><span class="n">ih</span><span class="p">,</span> <span class="n">jh</span><span class="p">,</span> <span class="n">kh</span><span class="p">,</span> <span class="n">qtp</span><span class="p">,</span> <span class="n">qfluxb</span><span class="p">,</span> <span class="n">cth</span><span class="p">,</span> <span class="n">bcqfluxA</span><span class="p">,</span> <span class="n">qt0</span><span class="p">(:,</span> <span class="p">:,</span> <span class="p">:),</span> <span class="n">facqsat</span><span class="p">(</span><span class="n">k</span><span class="p">),</span> <span class="n">fachurel</span><span class="p">(</span><span class="n">k</span><span class="p">),</span> <span class="n">facf</span><span class="p">(</span><span class="n">k</span><span class="p">,</span> <span class="mi">4</span><span class="p">),</span> <span class="n">facf</span><span class="p">(</span><span class="n">k</span><span class="p">,</span> <span class="mi">5</span><span class="p">),</span> <span class="n">ixwall</span><span class="p">(</span><span class="n">n</span><span class="p">),</span> <span class="mi">1</span><span class="p">,</span> <span class="mi">22</span><span class="p">)</span> <span class="c">!right wall</span>
<a name="ln-271"></a>               <span class="n">facef</span><span class="p">(</span><span class="n">k</span><span class="p">)</span> <span class="o">=</span> <span class="n">facef</span><span class="p">(</span><span class="n">k</span><span class="p">)</span> <span class="o">+</span> <span class="n">bcqfluxA</span>
<a name="ln-272"></a>            <span class="k">end if</span>
<a name="ln-273"></a><span class="k">         end do</span>
<a name="ln-274"></a><span class="k">      end if</span>
<a name="ln-275"></a><span class="k">      end if</span>
<a name="ln-276"></a>
<a name="ln-277"></a><span class="k">      if</span> <span class="p">(</span><span class="n">nsv</span><span class="o">&gt;</span><span class="mi">0</span><span class="p">)</span> <span class="k">then</span>
<a name="ln-278"></a><span class="k">      if</span> <span class="p">(</span><span class="n">iwallscal</span> <span class="o">==</span> <span class="mi">1</span><span class="p">)</span> <span class="k">then</span> <span class="c">!fixed flux</span>
<a name="ln-279"></a>         <span class="k">do </span><span class="n">n</span> <span class="o">=</span> <span class="mi">1</span><span class="p">,</span> <span class="n">nxwall</span> 
<a name="ln-280"></a>            <span class="k">do </span><span class="n">m</span><span class="o">=</span> <span class="mi">1</span><span class="p">,</span> <span class="n">nsv</span>
<a name="ln-281"></a>               <span class="k">call </span><span class="n">xwallscalar</span><span class="p">(</span><span class="n">ihc</span><span class="p">,</span> <span class="n">jhc</span><span class="p">,</span> <span class="n">khc</span><span class="p">,</span> <span class="n">sv0</span><span class="p">(:,:,:,</span><span class="n">m</span><span class="p">),</span> <span class="n">svp</span><span class="p">(:,:,:,</span><span class="n">m</span><span class="p">),</span> <span class="mf">0.</span><span class="p">,</span> <span class="mf">0.</span><span class="p">,</span> <span class="n">ixwall</span><span class="p">(</span><span class="n">n</span><span class="p">))</span>
<a name="ln-282"></a>            <span class="k">end do</span>
<a name="ln-283"></a><span class="k">         end do</span>
<a name="ln-284"></a><span class="k">      end if</span>
<a name="ln-285"></a><span class="k">      end if</span>
<a name="ln-286"></a>
<a name="ln-287"></a><span class="k">   end subroutine </span><span class="n">xwallfun</span>
<a name="ln-288"></a>
<a name="ln-289"></a>   <span class="k">subroutine </span><span class="n">xwallscalar</span><span class="p">(</span><span class="n">hi</span><span class="p">,</span> <span class="n">hj</span><span class="p">,</span> <span class="n">hk</span><span class="p">,</span> <span class="n">putin</span><span class="p">,</span> <span class="n">putout</span><span class="p">,</span> <span class="n">bcvaluem</span><span class="p">,</span> <span class="n">bcvaluep</span><span class="p">,</span> <span class="n">n</span><span class="p">)</span>
<a name="ln-290"></a>      <span class="k">use </span><span class="n">modglobal</span><span class="p">,</span> <span class="n">only</span><span class="p">:</span><span class="n">jmax</span><span class="p">,</span> <span class="n">dxf</span><span class="p">,</span> <span class="n">dxfi</span><span class="p">,</span> <span class="n">dxfi5</span><span class="p">,</span> <span class="n">dxhi</span><span class="p">,</span> <span class="n">dxh2i</span><span class="p">,</span> <span class="n">nsv</span><span class="p">,</span> <span class="n">ib</span><span class="p">,</span> <span class="n">ie</span><span class="p">,</span> <span class="n">jb</span><span class="p">,</span> <span class="n">je</span><span class="p">,</span> <span class="n">kb</span><span class="p">,</span> <span class="n">ke</span><span class="p">,</span> <span class="n">prandtlmoli</span><span class="p">,</span> <span class="n">numol</span>
<a name="ln-291"></a>      <span class="k">use </span><span class="n">modfields</span><span class="p">,</span> <span class="n">only</span><span class="p">:</span><span class="n">u0</span>
<a name="ln-292"></a>      <span class="k">use </span><span class="n">modmpi</span><span class="p">,</span> <span class="n">only</span><span class="p">:</span><span class="n">myid</span>
<a name="ln-293"></a>      <span class="k">use </span><span class="n">modsubgriddata</span><span class="p">,</span> <span class="n">only</span><span class="p">:</span><span class="n">ekh</span>
<a name="ln-294"></a>      <span class="k">use </span><span class="n">initfac</span><span class="p">,</span> <span class="n">only</span><span class="p">:</span><span class="k">block</span>
<a name="ln-295"></a><span class="k">      </span><span class="kt">integer </span><span class="n">i</span><span class="p">,</span> <span class="n">j</span><span class="p">,</span> <span class="n">k</span><span class="p">,</span> <span class="n">jl</span><span class="p">,</span> <span class="n">ju</span><span class="p">,</span> <span class="n">kl</span><span class="p">,</span> <span class="n">ku</span><span class="p">,</span> <span class="n">iww</span><span class="p">,</span> <span class="n">iee</span>
<a name="ln-296"></a>
<a name="ln-297"></a>      <span class="kt">integer</span><span class="p">,</span> <span class="k">intent</span><span class="p">(</span><span class="n">in</span><span class="p">)</span> <span class="kd">::</span> <span class="n">hi</span> <span class="c">!&lt;size of halo in i</span>
<a name="ln-298"></a>      <span class="kt">integer</span><span class="p">,</span> <span class="k">intent</span><span class="p">(</span><span class="n">in</span><span class="p">)</span> <span class="kd">::</span> <span class="n">hj</span> <span class="c">!&lt;size of halo in j</span>
<a name="ln-299"></a>      <span class="kt">integer</span><span class="p">,</span> <span class="k">intent</span><span class="p">(</span><span class="n">in</span><span class="p">)</span> <span class="kd">::</span> <span class="n">hk</span> <span class="c">!&lt;size of halo in k</span>
<a name="ln-300"></a>      <span class="kt">real</span><span class="p">,</span> <span class="k">intent</span><span class="p">(</span><span class="n">in</span><span class="p">)</span>    <span class="kd">::</span> <span class="n">putin</span><span class="p">(</span><span class="n">ib</span> <span class="o">-</span> <span class="n">hi</span><span class="p">:</span><span class="n">ie</span> <span class="o">+</span> <span class="n">hi</span><span class="p">,</span> <span class="n">jb</span> <span class="o">-</span> <span class="n">hj</span><span class="p">:</span><span class="n">je</span> <span class="o">+</span> <span class="n">hj</span><span class="p">,</span> <span class="n">kb</span> <span class="o">-</span> <span class="n">hk</span><span class="p">:</span><span class="n">ke</span> <span class="o">+</span> <span class="n">hk</span><span class="p">)</span>
<a name="ln-301"></a>      <span class="kt">real</span><span class="p">,</span> <span class="k">intent</span><span class="p">(</span><span class="n">inout</span><span class="p">)</span> <span class="kd">::</span> <span class="n">putout</span><span class="p">(</span><span class="n">ib</span> <span class="o">-</span> <span class="n">hi</span><span class="p">:</span><span class="n">ie</span> <span class="o">+</span> <span class="n">hi</span><span class="p">,</span> <span class="n">jb</span> <span class="o">-</span> <span class="n">hj</span><span class="p">:</span><span class="n">je</span> <span class="o">+</span> <span class="n">hj</span><span class="p">,</span> <span class="n">kb</span><span class="p">:</span><span class="n">ke</span> <span class="o">+</span> <span class="n">hk</span><span class="p">)</span>
<a name="ln-302"></a>      <span class="kt">real</span><span class="p">,</span> <span class="k">intent</span><span class="p">(</span><span class="n">in</span><span class="p">)</span>    <span class="kd">::</span> <span class="n">bcvaluem</span><span class="p">,</span> <span class="n">bcvaluep</span>
<a name="ln-303"></a>      <span class="kt">integer</span><span class="p">,</span> <span class="k">intent</span><span class="p">(</span><span class="n">in</span><span class="p">)</span>    <span class="kd">::</span> <span class="n">n</span>
<a name="ln-304"></a>
<a name="ln-305"></a>      <span class="n">iww</span> <span class="o">=</span> <span class="k">block</span><span class="p">(</span><span class="n">n</span><span class="p">,</span> <span class="mi">1</span><span class="p">)</span> <span class="o">-</span> <span class="mi">1</span>
<a name="ln-306"></a>      <span class="n">iee</span> <span class="o">=</span> <span class="k">block</span><span class="p">(</span><span class="n">n</span><span class="p">,</span> <span class="mi">2</span><span class="p">)</span> <span class="o">+</span> <span class="mi">1</span>
<a name="ln-307"></a>
<a name="ln-308"></a>      <span class="n">jl</span> <span class="o">=</span> <span class="nb">MAX</span><span class="p">(</span><span class="k">block</span><span class="p">(</span><span class="n">n</span><span class="p">,</span> <span class="mi">3</span><span class="p">)</span> <span class="o">-</span> <span class="n">myid</span><span class="o">*</span><span class="n">jmax</span><span class="p">,</span> <span class="mi">1</span><span class="p">)</span> <span class="c">! starting j-index</span>
<a name="ln-309"></a>      <span class="n">ju</span> <span class="o">=</span> <span class="nb">MIN</span><span class="p">(</span><span class="k">block</span><span class="p">(</span><span class="n">n</span><span class="p">,</span> <span class="mi">4</span><span class="p">)</span> <span class="o">-</span> <span class="n">myid</span><span class="o">*</span><span class="n">jmax</span><span class="p">,</span> <span class="n">jmax</span><span class="p">)</span> <span class="c">! ending j-index</span>
<a name="ln-310"></a>      <span class="n">kl</span> <span class="o">=</span> <span class="k">block</span><span class="p">(</span><span class="n">n</span><span class="p">,</span> <span class="mi">5</span><span class="p">)</span> <span class="c">! starting k-index</span>
<a name="ln-311"></a>      <span class="n">ku</span> <span class="o">=</span> <span class="k">block</span><span class="p">(</span><span class="n">n</span><span class="p">,</span> <span class="mi">6</span><span class="p">)</span> <span class="c">! ending k-index</span>
<a name="ln-312"></a>
<a name="ln-313"></a>      <span class="c">!fixed flux</span>
<a name="ln-314"></a>      <span class="c">!remove standard diffusion term, add flux=bcvalue</span>
<a name="ln-315"></a>      <span class="k">do </span><span class="n">k</span> <span class="o">=</span> <span class="n">kl</span><span class="p">,</span> <span class="n">ku</span>
<a name="ln-316"></a>         <span class="k">do </span><span class="n">j</span> <span class="o">=</span> <span class="n">jl</span><span class="p">,</span> <span class="n">ju</span>
<a name="ln-317"></a>            <span class="n">putout</span><span class="p">(</span><span class="n">iee</span><span class="p">,</span> <span class="n">j</span><span class="p">,</span> <span class="n">k</span><span class="p">)</span> <span class="o">=</span> <span class="n">putout</span><span class="p">(</span><span class="n">iee</span><span class="p">,</span> <span class="n">j</span><span class="p">,</span> <span class="n">k</span><span class="p">)</span> <span class="o">+</span> <span class="p">(</span> <span class="p">&amp;</span>
<a name="ln-318"></a>                                <span class="mf">0.5</span><span class="o">*</span><span class="p">(</span><span class="n">ekh</span><span class="p">(</span><span class="n">iee</span><span class="p">,</span> <span class="n">j</span><span class="p">,</span> <span class="n">k</span><span class="p">)</span><span class="o">*</span><span class="n">dxf</span><span class="p">(</span><span class="n">iee</span> <span class="o">-</span> <span class="mi">1</span><span class="p">)</span> <span class="o">+</span> <span class="n">ekh</span><span class="p">(</span><span class="n">iee</span> <span class="o">-</span> <span class="mi">1</span><span class="p">,</span> <span class="n">j</span><span class="p">,</span> <span class="n">k</span><span class="p">)</span><span class="o">*</span><span class="n">dxf</span><span class="p">(</span><span class="n">iee</span><span class="p">))</span><span class="o">*</span> <span class="p">&amp;</span>
<a name="ln-319"></a>                                <span class="p">(</span><span class="n">putin</span><span class="p">(</span><span class="n">iee</span><span class="p">,</span> <span class="n">j</span><span class="p">,</span> <span class="n">k</span><span class="p">)</span> <span class="o">-</span> <span class="n">putin</span><span class="p">(</span><span class="n">iee</span> <span class="o">-</span> <span class="mi">1</span><span class="p">,</span> <span class="n">j</span><span class="p">,</span> <span class="n">k</span><span class="p">))</span><span class="o">*</span><span class="n">dxh2i</span><span class="p">(</span><span class="n">iee</span><span class="p">)</span> <span class="o">-</span> <span class="p">&amp;</span>
<a name="ln-320"></a>                                <span class="n">bcvaluep</span><span class="p">)</span><span class="o">*</span><span class="n">dxfi</span><span class="p">(</span><span class="n">iee</span><span class="p">)</span> <span class="c">!</span>
<a name="ln-321"></a>
<a name="ln-322"></a>            <span class="n">putout</span><span class="p">(</span><span class="n">iww</span><span class="p">,</span> <span class="n">j</span><span class="p">,</span> <span class="n">k</span><span class="p">)</span> <span class="o">=</span> <span class="n">putout</span><span class="p">(</span><span class="n">iww</span><span class="p">,</span> <span class="n">j</span><span class="p">,</span> <span class="n">k</span><span class="p">)</span> <span class="o">+</span> <span class="p">(</span> <span class="p">&amp;</span>
<a name="ln-323"></a>                                <span class="o">-</span><span class="mf">0.5</span><span class="o">*</span><span class="p">(</span><span class="n">ekh</span><span class="p">(</span><span class="n">iww</span> <span class="o">+</span> <span class="mi">1</span><span class="p">,</span> <span class="n">j</span><span class="p">,</span> <span class="n">k</span><span class="p">)</span><span class="o">*</span><span class="n">dxf</span><span class="p">(</span><span class="n">iww</span><span class="p">)</span> <span class="o">+</span> <span class="n">ekh</span><span class="p">(</span><span class="n">iww</span><span class="p">,</span> <span class="n">j</span><span class="p">,</span> <span class="n">k</span><span class="p">)</span><span class="o">*</span><span class="n">dxf</span><span class="p">(</span><span class="n">iww</span> <span class="o">+</span> <span class="mi">1</span><span class="p">))</span><span class="o">*</span> <span class="p">&amp;</span>
<a name="ln-324"></a>                                <span class="p">(</span><span class="n">putin</span><span class="p">(</span><span class="n">iww</span> <span class="o">+</span> <span class="mi">1</span><span class="p">,</span> <span class="n">j</span><span class="p">,</span> <span class="n">k</span><span class="p">)</span> <span class="o">-</span> <span class="n">putin</span><span class="p">(</span><span class="n">iww</span><span class="p">,</span> <span class="n">j</span><span class="p">,</span> <span class="n">k</span><span class="p">))</span><span class="o">*</span><span class="n">dxh2i</span><span class="p">(</span><span class="n">iww</span> <span class="o">+</span> <span class="mi">1</span><span class="p">)</span> <span class="o">-</span> <span class="p">&amp;</span>
<a name="ln-325"></a>                                <span class="n">bcvaluem</span><span class="p">)</span><span class="o">*</span><span class="n">dxfi</span><span class="p">(</span><span class="n">iww</span><span class="p">)</span> <span class="c">!</span>
<a name="ln-326"></a>         <span class="k">end do</span>
<a name="ln-327"></a><span class="k">      end do</span>
<a name="ln-328"></a>
<a name="ln-329"></a><span class="k">   end subroutine </span><span class="n">xwallscalar</span>
<a name="ln-330"></a>
<a name="ln-331"></a>   <span class="k">subroutine </span><span class="n">ywallfunplus</span>
<a name="ln-332"></a>      <span class="k">use </span><span class="n">modglobal</span><span class="p">,</span> <span class="n">only</span><span class="p">:</span><span class="n">dzf</span><span class="p">,</span> <span class="n">dzhiq</span><span class="p">,</span> <span class="n">dzhi</span><span class="p">,</span> <span class="n">dxf</span><span class="p">,</span> <span class="n">dxhi</span><span class="p">,</span> <span class="n">dy</span><span class="p">,</span> <span class="n">dyi</span><span class="p">,</span> <span class="n">nsv</span><span class="p">,</span> <span class="n">lles</span><span class="p">,</span> <span class="n">numol</span><span class="p">,</span> <span class="n">ltempeq</span><span class="p">,</span> <span class="n">lmoist</span><span class="p">,</span> <span class="p">&amp;</span>
<a name="ln-333"></a>         <span class="n">je</span><span class="p">,</span> <span class="n">jb</span><span class="p">,</span> <span class="n">ih</span><span class="p">,</span> <span class="n">jh</span><span class="p">,</span> <span class="n">kh</span><span class="p">,</span> <span class="n">ihc</span><span class="p">,</span> <span class="n">jhc</span><span class="p">,</span> <span class="n">khc</span><span class="p">,</span> <span class="n">iwallmom</span><span class="p">,</span> <span class="n">iwallmoist</span><span class="p">,</span> <span class="n">iwalltemp</span><span class="p">,</span> <span class="n">iwallscal</span><span class="p">,</span> <span class="n">nblocks</span>
<a name="ln-334"></a>      <span class="k">use </span><span class="n">modfields</span><span class="p">,</span> <span class="n">only</span><span class="p">:</span><span class="n">u0</span><span class="p">,</span> <span class="n">w0</span><span class="p">,</span> <span class="n">up</span><span class="p">,</span> <span class="n">wp</span><span class="p">,</span> <span class="n">shear</span><span class="p">,</span> <span class="n">thlp</span><span class="p">,</span> <span class="n">thl0</span><span class="p">,</span> <span class="n">qtp</span><span class="p">,</span> <span class="n">qt0</span><span class="p">,</span> <span class="n">sv0</span><span class="p">,</span> <span class="n">svp</span><span class="p">,</span> <span class="n">tfluxb</span><span class="p">,</span> <span class="n">momfluxb</span><span class="p">,</span> <span class="n">exnf</span><span class="p">,</span> <span class="n">cth</span><span class="p">,</span> <span class="n">qfluxb</span>
<a name="ln-335"></a>      <span class="k">use </span><span class="n">modsubgriddata</span><span class="p">,</span> <span class="n">only</span><span class="p">:</span><span class="n">ekm</span>
<a name="ln-336"></a>      <span class="k">use </span><span class="n">modmpi</span><span class="p">,</span> <span class="n">only</span><span class="p">:</span><span class="n">myid</span>
<a name="ln-337"></a>      <span class="k">use </span><span class="n">initfac</span><span class="p">,</span> <span class="n">only</span><span class="p">:</span><span class="n">fachf</span><span class="p">,</span> <span class="k">block</span><span class="p">,</span> <span class="n">faclGR</span><span class="p">,</span> <span class="n">facqsat</span><span class="p">,</span> <span class="n">facef</span><span class="p">,</span> <span class="n">fachurel</span><span class="p">,</span> <span class="n">facf</span><span class="p">,</span> <span class="n">facT</span><span class="p">,</span> <span class="n">facz0</span><span class="p">,</span> <span class="n">facz0h</span>
<a name="ln-338"></a>      <span class="kt">integer </span><span class="n">i</span><span class="p">,</span> <span class="n">j</span><span class="p">,</span> <span class="n">k</span><span class="p">,</span> <span class="n">n</span><span class="p">,</span> <span class="n">nc</span><span class="p">,</span> <span class="n">il</span><span class="p">,</span> <span class="n">iu</span><span class="p">,</span> <span class="n">kl</span><span class="p">,</span> <span class="n">ku</span><span class="p">,</span> <span class="n">im</span><span class="p">,</span> <span class="n">jm</span><span class="p">,</span> <span class="n">km</span><span class="p">,</span> <span class="n">m</span>
<a name="ln-339"></a>
<a name="ln-340"></a>      <span class="k">if</span> <span class="p">(</span><span class="n">iwallmom</span> <span class="o">==</span> <span class="mi">1</span><span class="p">)</span> <span class="k">then</span> <span class="c">!fixed flux</span>
<a name="ln-341"></a>      <span class="c">!not implemented</span>
<a name="ln-342"></a>      <span class="k">else if</span> <span class="p">(</span><span class="n">iwallmom</span> <span class="o">==</span> <span class="mi">2</span><span class="p">)</span> <span class="k">then</span>
<a name="ln-343"></a><span class="k">      do </span><span class="n">n</span> <span class="o">=</span> <span class="mi">1</span><span class="p">,</span> <span class="n">nypluswall</span>
<a name="ln-344"></a>         <span class="n">k</span> <span class="o">=</span> <span class="k">block</span><span class="p">(</span><span class="n">iypluswall</span><span class="p">(</span><span class="n">n</span><span class="p">,</span> <span class="mi">1</span><span class="p">),</span> <span class="mi">10</span><span class="p">)</span> <span class="c">!upper y wall = north wall</span>
<a name="ln-345"></a>         <span class="k">call </span><span class="n">wfuno</span><span class="p">(</span><span class="n">ih</span><span class="p">,</span> <span class="n">jh</span><span class="p">,</span> <span class="n">kh</span><span class="p">,</span> <span class="n">up</span><span class="p">,</span> <span class="n">wp</span><span class="p">,</span> <span class="n">thlp</span><span class="p">,</span> <span class="n">momfluxb</span><span class="p">,</span> <span class="n">tfluxb</span><span class="p">,</span> <span class="n">cth</span><span class="p">,</span> <span class="n">bcTfluxA</span><span class="p">,</span> <span class="n">u0</span><span class="p">,</span> <span class="n">w0</span><span class="p">,</span> <span class="n">thl0</span><span class="p">,</span> <span class="n">facT</span><span class="p">(</span><span class="n">k</span><span class="p">,</span><span class="mi">1</span><span class="p">),</span> <span class="n">facz0</span><span class="p">(</span><span class="n">k</span><span class="p">),</span> <span class="n">facz0h</span><span class="p">(</span><span class="n">k</span><span class="p">),</span> <span class="n">iypluswall</span><span class="p">(</span><span class="n">n</span><span class="p">,</span> <span class="mi">1</span><span class="p">),</span> <span class="n">iypluswall</span><span class="p">(</span><span class="n">n</span><span class="p">,</span> <span class="mi">2</span><span class="p">),</span> <span class="mi">31</span><span class="p">)</span>
<a name="ln-346"></a>      <span class="k">end do</span>
<a name="ln-347"></a><span class="k">      else if</span> <span class="p">(</span><span class="n">iwallmom</span> <span class="o">==</span> <span class="mi">3</span><span class="p">)</span> <span class="k">then</span>
<a name="ln-348"></a><span class="k">      do </span><span class="n">n</span> <span class="o">=</span> <span class="mi">1</span><span class="p">,</span> <span class="n">nypluswall</span>
<a name="ln-349"></a>         <span class="n">k</span> <span class="o">=</span> <span class="k">block</span><span class="p">(</span><span class="n">iypluswall</span><span class="p">(</span><span class="n">n</span><span class="p">,</span> <span class="mi">1</span><span class="p">),</span> <span class="mi">10</span><span class="p">)</span> <span class="c">!upper y wall = north wall</span>
<a name="ln-350"></a>         <span class="k">call </span><span class="n">wfmneutral</span><span class="p">(</span><span class="n">ih</span><span class="p">,</span> <span class="n">jh</span><span class="p">,</span> <span class="n">kh</span><span class="p">,</span> <span class="n">up</span><span class="p">,</span> <span class="n">wp</span><span class="p">,</span> <span class="n">momfluxb</span><span class="p">,</span> <span class="n">u0</span><span class="p">,</span> <span class="n">w0</span><span class="p">,</span> <span class="n">facz0</span><span class="p">(</span><span class="n">k</span><span class="p">),</span> <span class="n">iypluswall</span><span class="p">(</span><span class="n">n</span><span class="p">,</span> <span class="mi">1</span><span class="p">),</span> <span class="n">iypluswall</span><span class="p">(</span><span class="n">n</span><span class="p">,</span> <span class="mi">2</span><span class="p">),</span> <span class="mi">31</span><span class="p">)</span>
<a name="ln-351"></a>      <span class="k">end do</span>
<a name="ln-352"></a><span class="k">      end if</span>
<a name="ln-353"></a>
<a name="ln-354"></a><span class="k">      if</span> <span class="p">(</span><span class="n">ltempeq</span><span class="p">)</span> <span class="k">then</span>
<a name="ln-355"></a><span class="k">      if</span> <span class="p">(</span><span class="n">iwalltemp</span> <span class="o">==</span> <span class="mi">1</span><span class="p">)</span> <span class="k">then</span>
<a name="ln-356"></a><span class="k">         do </span><span class="n">n</span> <span class="o">=</span> <span class="mi">1</span><span class="p">,</span> <span class="n">nypluswall</span> <span class="c">! loop over all shear x-walls</span>
<a name="ln-357"></a>
<a name="ln-358"></a>            <span class="c">!write(*,*) &#39;shape(iypluswall), nypluswall&#39;, shape(iypluswall), nypluswall</span>
<a name="ln-359"></a>
<a name="ln-360"></a>            <span class="k">call </span><span class="n">ywallscalarplus</span><span class="p">(</span><span class="n">ih</span><span class="p">,</span> <span class="n">jh</span><span class="p">,</span> <span class="n">kh</span><span class="p">,</span> <span class="n">thl0</span><span class="p">,</span> <span class="n">thlp</span><span class="p">,</span> <span class="n">bctfyp</span><span class="p">,</span> <span class="n">n</span><span class="p">)</span>
<a name="ln-361"></a>         <span class="k">end do</span>
<a name="ln-362"></a><span class="k">      else if</span> <span class="p">(</span><span class="n">iwalltemp</span> <span class="o">==</span> <span class="mi">2</span><span class="p">)</span> <span class="k">then</span>
<a name="ln-363"></a><span class="k">         do </span><span class="n">n</span> <span class="o">=</span> <span class="mi">1</span><span class="p">,</span> <span class="n">nypluswall</span>
<a name="ln-364"></a>            <span class="n">k</span> <span class="o">=</span> <span class="k">block</span><span class="p">(</span><span class="n">iypluswall</span><span class="p">(</span><span class="n">n</span><span class="p">,</span> <span class="mi">1</span><span class="p">),</span> <span class="mi">10</span><span class="p">)</span>
<a name="ln-365"></a>            <span class="k">call </span><span class="n">wfuno</span><span class="p">(</span><span class="n">ih</span><span class="p">,</span> <span class="n">jh</span><span class="p">,</span> <span class="n">kh</span><span class="p">,</span> <span class="n">up</span><span class="p">,</span> <span class="n">wp</span><span class="p">,</span> <span class="n">thlp</span><span class="p">,</span> <span class="n">momfluxb</span><span class="p">,</span> <span class="n">tfluxb</span><span class="p">,</span> <span class="n">cth</span><span class="p">,</span> <span class="n">bcTfluxA</span><span class="p">,</span> <span class="n">u0</span><span class="p">,</span> <span class="n">w0</span><span class="p">,</span> <span class="n">thl0</span><span class="p">,</span> <span class="n">facT</span><span class="p">(</span><span class="n">k</span><span class="p">,</span><span class="mi">1</span><span class="p">),</span> <span class="n">facz0</span><span class="p">(</span><span class="n">k</span><span class="p">),</span> <span class="n">facz0h</span><span class="p">(</span><span class="n">k</span><span class="p">),</span> <span class="n">iypluswall</span><span class="p">(</span><span class="n">n</span><span class="p">,</span> <span class="mi">1</span><span class="p">),</span> <span class="n">iypluswall</span><span class="p">(</span><span class="n">n</span><span class="p">,</span> <span class="mi">2</span><span class="p">),</span> <span class="mi">32</span><span class="p">)</span>
<a name="ln-366"></a>            <span class="n">fachf</span><span class="p">(</span><span class="n">k</span><span class="p">)</span> <span class="o">=</span> <span class="n">fachf</span><span class="p">(</span><span class="n">k</span><span class="p">)</span> <span class="o">+</span> <span class="n">bcTfluxA</span>
<a name="ln-367"></a>         <span class="k">end do</span>
<a name="ln-368"></a><span class="k">      end if</span>
<a name="ln-369"></a><span class="k">      end if</span>
<a name="ln-370"></a>
<a name="ln-371"></a><span class="k">      if</span> <span class="p">(</span><span class="n">lmoist</span><span class="p">)</span> <span class="k">then</span>
<a name="ln-372"></a><span class="k">      if</span> <span class="p">(</span><span class="n">iwallmoist</span> <span class="o">==</span> <span class="mi">1</span><span class="p">)</span> <span class="k">then</span>
<a name="ln-373"></a><span class="k">         do </span><span class="n">n</span> <span class="o">=</span> <span class="mi">1</span><span class="p">,</span> <span class="n">nypluswall</span> <span class="c">! loop over all shear x-walls</span>
<a name="ln-374"></a>            <span class="k">call </span><span class="n">ywallscalarplus</span><span class="p">(</span><span class="n">ih</span><span class="p">,</span> <span class="n">jh</span><span class="p">,</span> <span class="n">kh</span><span class="p">,</span> <span class="n">qt0</span><span class="p">,</span> <span class="n">qtp</span><span class="p">,</span> <span class="n">bcqfyp</span><span class="p">,</span> <span class="n">n</span><span class="p">)</span>
<a name="ln-375"></a>         <span class="k">end do</span>
<a name="ln-376"></a><span class="k">      end if</span>
<a name="ln-377"></a><span class="k">      if</span> <span class="p">((</span><span class="n">ltempeq</span><span class="p">)</span> <span class="p">.</span><span class="nb">and</span><span class="p">.</span> <span class="p">(</span><span class="n">iwallmoist</span> <span class="o">==</span> <span class="mi">2</span><span class="p">))</span> <span class="k">then</span>
<a name="ln-378"></a><span class="k">         do </span><span class="n">n</span> <span class="o">=</span> <span class="mi">1</span><span class="p">,</span> <span class="n">nypluswall</span>
<a name="ln-379"></a>            <span class="n">k</span> <span class="o">=</span> <span class="k">block</span><span class="p">(</span><span class="n">iypluswall</span><span class="p">(</span><span class="n">n</span><span class="p">,</span> <span class="mi">1</span><span class="p">),</span> <span class="mi">10</span><span class="p">)</span>
<a name="ln-380"></a>            <span class="k">if</span> <span class="p">(</span><span class="n">faclGR</span><span class="p">(</span><span class="n">k</span><span class="p">))</span> <span class="k">then</span>
<a name="ln-381"></a><span class="k">            call </span><span class="n">wfGR</span><span class="p">(</span><span class="n">ih</span><span class="p">,</span><span class="n">jh</span><span class="p">,</span><span class="n">kh</span><span class="p">,</span><span class="n">qtp</span><span class="p">,</span><span class="n">qfluxb</span><span class="p">,</span><span class="n">cth</span><span class="p">,</span><span class="n">bcqfluxA</span><span class="p">,</span><span class="n">qt0</span><span class="p">,</span><span class="n">facqsat</span><span class="p">(</span><span class="n">k</span><span class="p">),</span><span class="n">fachurel</span><span class="p">(</span><span class="n">k</span><span class="p">),</span><span class="n">facf</span><span class="p">(</span><span class="n">k</span><span class="p">,</span><span class="mi">4</span><span class="p">),</span><span class="n">facf</span><span class="p">(</span><span class="n">k</span><span class="p">,</span><span class="mi">5</span><span class="p">),</span><span class="n">iypluswall</span><span class="p">(</span><span class="n">n</span><span class="p">,</span><span class="mi">1</span><span class="p">),</span><span class="n">iypluswall</span><span class="p">(</span><span class="n">n</span><span class="p">,</span><span class="mi">2</span><span class="p">),</span><span class="mi">32</span><span class="p">)</span>
<a name="ln-382"></a>            <span class="n">facef</span><span class="p">(</span><span class="n">k</span><span class="p">)</span> <span class="o">=</span> <span class="n">facef</span><span class="p">(</span><span class="n">k</span><span class="p">)</span> <span class="o">+</span> <span class="n">bcqfluxA</span>
<a name="ln-383"></a>            <span class="k">end if</span>
<a name="ln-384"></a><span class="k">         end do</span>
<a name="ln-385"></a><span class="k">      end if</span>
<a name="ln-386"></a><span class="k">      end if</span>
<a name="ln-387"></a>
<a name="ln-388"></a><span class="k">      if</span> <span class="p">(</span><span class="n">nsv</span><span class="o">&gt;</span><span class="mi">0</span><span class="p">)</span> <span class="k">then</span>
<a name="ln-389"></a><span class="k">      if</span> <span class="p">(</span><span class="n">iwallscal</span> <span class="o">==</span> <span class="mi">1</span><span class="p">)</span> <span class="k">then</span>
<a name="ln-390"></a><span class="k">         do </span><span class="n">n</span> <span class="o">=</span> <span class="mi">1</span><span class="p">,</span> <span class="n">nypluswall</span> <span class="c">! loop over all shear x-walls</span>
<a name="ln-391"></a>            <span class="k">do </span><span class="n">m</span> <span class="o">=</span> <span class="mi">1</span><span class="p">,</span> <span class="n">nsv</span>
<a name="ln-392"></a>               <span class="k">call </span><span class="n">ywallscalarplus</span><span class="p">(</span><span class="n">ihc</span><span class="p">,</span> <span class="n">jhc</span><span class="p">,</span> <span class="n">khc</span><span class="p">,</span> <span class="n">sv0</span><span class="p">(:,:,:,</span><span class="n">m</span><span class="p">),</span> <span class="n">svp</span><span class="p">(:,:,:,</span><span class="n">m</span><span class="p">),</span> <span class="mf">0.</span><span class="p">,</span> <span class="n">n</span><span class="p">)</span>
<a name="ln-393"></a>            <span class="k">end do</span>
<a name="ln-394"></a><span class="k">         end do</span>
<a name="ln-395"></a><span class="k">      end if</span>
<a name="ln-396"></a><span class="k">      end if</span>
<a name="ln-397"></a>
<a name="ln-398"></a><span class="k">   end subroutine </span><span class="n">ywallfunplus</span>
<a name="ln-399"></a>
<a name="ln-400"></a>   <span class="k">subroutine </span><span class="n">ywallscalarplus</span><span class="p">(</span><span class="n">hi</span><span class="p">,</span> <span class="n">hj</span><span class="p">,</span> <span class="n">hk</span><span class="p">,</span> <span class="n">putin</span><span class="p">,</span> <span class="n">putout</span><span class="p">,</span> <span class="n">bcvaluep</span><span class="p">,</span> <span class="n">n</span><span class="p">)</span>
<a name="ln-401"></a>      <span class="k">use </span><span class="n">modglobal</span><span class="p">,</span> <span class="n">only</span><span class="p">:</span><span class="n">dyi</span><span class="p">,</span> <span class="n">ib</span><span class="p">,</span> <span class="n">ie</span><span class="p">,</span> <span class="n">jb</span><span class="p">,</span> <span class="n">je</span><span class="p">,</span> <span class="n">kb</span><span class="p">,</span> <span class="n">ke</span><span class="p">,</span> <span class="n">numol</span><span class="p">,</span> <span class="n">prandtlmoli</span>
<a name="ln-402"></a>      <span class="k">use </span><span class="n">modsubgriddata</span><span class="p">,</span> <span class="n">only</span><span class="p">:</span><span class="n">ekh</span>
<a name="ln-403"></a>      <span class="k">use </span><span class="n">modmpi</span><span class="p">,</span> <span class="n">only</span><span class="p">:</span><span class="n">myid</span>
<a name="ln-404"></a>      <span class="k">use </span><span class="n">initfac</span><span class="p">,</span> <span class="n">only</span><span class="p">:</span><span class="k">block</span>
<a name="ln-405"></a><span class="k">      </span><span class="kt">integer </span><span class="n">i</span><span class="p">,</span> <span class="n">j</span><span class="p">,</span> <span class="n">k</span><span class="p">,</span> <span class="n">il</span><span class="p">,</span> <span class="n">iu</span><span class="p">,</span> <span class="n">kl</span><span class="p">,</span> <span class="n">ku</span><span class="p">,</span> <span class="n">m</span>
<a name="ln-406"></a>
<a name="ln-407"></a>      <span class="kt">integer</span><span class="p">,</span> <span class="k">intent</span><span class="p">(</span><span class="n">in</span><span class="p">)</span> <span class="kd">::</span> <span class="n">hi</span> <span class="c">!&lt;size of halo in i</span>
<a name="ln-408"></a>      <span class="kt">integer</span><span class="p">,</span> <span class="k">intent</span><span class="p">(</span><span class="n">in</span><span class="p">)</span> <span class="kd">::</span> <span class="n">hj</span> <span class="c">!&lt;size of halo in j</span>
<a name="ln-409"></a>      <span class="kt">integer</span><span class="p">,</span> <span class="k">intent</span><span class="p">(</span><span class="n">in</span><span class="p">)</span> <span class="kd">::</span> <span class="n">hk</span> <span class="c">!&lt;size of halo in k</span>
<a name="ln-410"></a>      <span class="kt">real</span><span class="p">,</span> <span class="k">intent</span><span class="p">(</span><span class="n">in</span><span class="p">)</span>    <span class="kd">::</span> <span class="n">putin</span><span class="p">(</span><span class="n">ib</span> <span class="o">-</span> <span class="n">hi</span><span class="p">:</span><span class="n">ie</span> <span class="o">+</span> <span class="n">hi</span><span class="p">,</span> <span class="n">jb</span> <span class="o">-</span> <span class="n">hj</span><span class="p">:</span><span class="n">je</span> <span class="o">+</span> <span class="n">hj</span><span class="p">,</span> <span class="n">kb</span> <span class="o">-</span> <span class="n">hk</span><span class="p">:</span><span class="n">ke</span> <span class="o">+</span> <span class="n">hk</span><span class="p">)</span>
<a name="ln-411"></a>      <span class="kt">real</span><span class="p">,</span> <span class="k">intent</span><span class="p">(</span><span class="n">inout</span><span class="p">)</span> <span class="kd">::</span> <span class="n">putout</span><span class="p">(</span><span class="n">ib</span> <span class="o">-</span> <span class="n">hi</span><span class="p">:</span><span class="n">ie</span> <span class="o">+</span> <span class="n">hi</span><span class="p">,</span> <span class="n">jb</span> <span class="o">-</span> <span class="n">hj</span><span class="p">:</span><span class="n">je</span> <span class="o">+</span> <span class="n">hj</span><span class="p">,</span> <span class="n">kb</span><span class="p">:</span><span class="n">ke</span> <span class="o">+</span> <span class="n">hk</span><span class="p">)</span>
<a name="ln-412"></a>      <span class="kt">real</span><span class="p">,</span> <span class="k">intent</span><span class="p">(</span><span class="n">in</span><span class="p">)</span>    <span class="kd">::</span> <span class="n">bcvaluep</span>
<a name="ln-413"></a>      <span class="kt">integer</span><span class="p">,</span> <span class="k">intent</span><span class="p">(</span><span class="n">in</span><span class="p">)</span>    <span class="kd">::</span> <span class="n">n</span>
<a name="ln-414"></a>      <span class="n">m</span> <span class="o">=</span> <span class="n">iypluswall</span><span class="p">(</span><span class="n">n</span><span class="p">,</span> <span class="mi">1</span><span class="p">)</span>
<a name="ln-415"></a>      <span class="n">j</span> <span class="o">=</span> <span class="n">iypluswall</span><span class="p">(</span><span class="n">n</span><span class="p">,</span> <span class="mi">2</span><span class="p">)</span>
<a name="ln-416"></a>      <span class="n">il</span> <span class="o">=</span> <span class="k">block</span><span class="p">(</span><span class="n">m</span><span class="p">,</span> <span class="mi">1</span><span class="p">)</span>
<a name="ln-417"></a>      <span class="n">iu</span> <span class="o">=</span> <span class="k">block</span><span class="p">(</span><span class="n">m</span><span class="p">,</span> <span class="mi">2</span><span class="p">)</span>
<a name="ln-418"></a>      <span class="n">kl</span> <span class="o">=</span> <span class="k">block</span><span class="p">(</span><span class="n">m</span><span class="p">,</span> <span class="mi">5</span><span class="p">)</span>
<a name="ln-419"></a>      <span class="n">ku</span> <span class="o">=</span> <span class="k">block</span><span class="p">(</span><span class="n">m</span><span class="p">,</span> <span class="mi">6</span><span class="p">)</span>
<a name="ln-420"></a>
<a name="ln-421"></a>      <span class="c">!fixed flux</span>
<a name="ln-422"></a>      <span class="k">do </span><span class="n">k</span> <span class="o">=</span> <span class="n">kl</span><span class="p">,</span> <span class="n">ku</span>
<a name="ln-423"></a>         <span class="k">do </span><span class="n">i</span> <span class="o">=</span> <span class="n">il</span><span class="p">,</span> <span class="n">iu</span>
<a name="ln-424"></a>            <span class="n">putout</span><span class="p">(</span><span class="n">i</span><span class="p">,</span> <span class="n">j</span><span class="p">,</span> <span class="n">k</span><span class="p">)</span> <span class="o">=</span> <span class="n">putout</span><span class="p">(</span><span class="n">i</span><span class="p">,</span> <span class="n">j</span><span class="p">,</span> <span class="n">k</span><span class="p">)</span> <span class="o">+</span> <span class="p">(</span><span class="mf">0.5</span><span class="o">*</span><span class="p">(</span><span class="n">ekh</span><span class="p">(</span><span class="n">i</span><span class="p">,</span> <span class="n">j</span><span class="p">,</span> <span class="n">k</span><span class="p">)</span> <span class="o">+</span> <span class="n">ekh</span><span class="p">(</span><span class="n">i</span><span class="p">,</span> <span class="n">j</span> <span class="o">-</span> <span class="mi">1</span><span class="p">,</span> <span class="n">k</span><span class="p">))</span><span class="o">*</span><span class="p">(</span><span class="n">putin</span><span class="p">(</span><span class="n">i</span><span class="p">,</span> <span class="n">j</span><span class="p">,</span> <span class="n">k</span><span class="p">)</span> <span class="o">-</span> <span class="n">putin</span><span class="p">(</span><span class="n">i</span><span class="p">,</span> <span class="n">j</span> <span class="o">-</span> <span class="mi">1</span><span class="p">,</span> <span class="n">k</span><span class="p">))</span><span class="o">*</span><span class="n">dyi</span> <span class="o">-</span> <span class="n">bcvaluep</span><span class="p">)</span><span class="o">*</span><span class="n">dyi</span>
<a name="ln-425"></a>         <span class="k">end do</span>
<a name="ln-426"></a><span class="k">      end do</span>
<a name="ln-427"></a><span class="k">   end subroutine </span><span class="n">ywallscalarplus</span>
<a name="ln-428"></a>
<a name="ln-429"></a>   <span class="k">subroutine </span><span class="n">ywallfunmin</span>
<a name="ln-430"></a>      <span class="k">use </span><span class="n">modglobal</span><span class="p">,</span> <span class="n">only</span><span class="p">:</span><span class="n">dxf</span><span class="p">,</span> <span class="n">dxhi</span><span class="p">,</span> <span class="n">dy</span><span class="p">,</span> <span class="n">dyi</span><span class="p">,</span> <span class="n">dzhiq</span><span class="p">,</span> <span class="n">dzf</span><span class="p">,</span> <span class="n">dzhi</span><span class="p">,</span> <span class="n">lles</span><span class="p">,</span> <span class="n">nsv</span><span class="p">,</span> <span class="n">numol</span><span class="p">,</span> <span class="n">ltempeq</span><span class="p">,</span> <span class="n">lmoist</span><span class="p">,</span> <span class="p">&amp;</span>
<a name="ln-431"></a>         <span class="n">ih</span><span class="p">,</span> <span class="n">jh</span><span class="p">,</span> <span class="n">kh</span><span class="p">,</span> <span class="n">ihc</span><span class="p">,</span> <span class="n">jhc</span><span class="p">,</span> <span class="n">khc</span><span class="p">,</span> <span class="n">iwallmom</span><span class="p">,</span> <span class="n">iwalltemp</span><span class="p">,</span> <span class="n">iwallmoist</span><span class="p">,</span> <span class="n">iwallscal</span><span class="p">,</span> <span class="n">nblocks</span>
<a name="ln-432"></a>      <span class="k">use </span><span class="n">modfields</span><span class="p">,</span> <span class="n">only</span><span class="p">:</span><span class="n">u0</span><span class="p">,</span> <span class="n">w0</span><span class="p">,</span> <span class="n">up</span><span class="p">,</span> <span class="n">wp</span><span class="p">,</span> <span class="n">shear</span><span class="p">,</span> <span class="n">thl0</span><span class="p">,</span> <span class="n">thlp</span><span class="p">,</span> <span class="n">qt0</span><span class="p">,</span> <span class="n">qtp</span><span class="p">,</span> <span class="n">sv0</span><span class="p">,</span> <span class="n">svp</span><span class="p">,</span> <span class="n">tfluxb</span><span class="p">,</span> <span class="n">momfluxb</span><span class="p">,</span> <span class="n">exnf</span><span class="p">,</span> <span class="n">cth</span><span class="p">,</span> <span class="n">qfluxb</span>
<a name="ln-433"></a>      <span class="k">use </span><span class="n">initfac</span><span class="p">,</span> <span class="n">only</span><span class="p">:</span><span class="n">fachf</span><span class="p">,</span> <span class="k">block</span><span class="p">,</span> <span class="n">faclGR</span><span class="p">,</span> <span class="n">facqsat</span><span class="p">,</span> <span class="n">facef</span><span class="p">,</span> <span class="n">fachurel</span><span class="p">,</span> <span class="n">facf</span><span class="p">,</span> <span class="n">facT</span><span class="p">,</span> <span class="n">facz0</span><span class="p">,</span> <span class="n">facz0h</span>
<a name="ln-434"></a>      <span class="c">!      use modsurfdata,     only : wtsurf</span>
<a name="ln-435"></a>      <span class="kt">integer </span><span class="n">i</span><span class="p">,</span> <span class="n">j</span><span class="p">,</span> <span class="n">k</span><span class="p">,</span> <span class="n">n</span><span class="p">,</span> <span class="n">nc</span><span class="p">,</span> <span class="n">il</span><span class="p">,</span> <span class="n">iu</span><span class="p">,</span> <span class="n">kl</span><span class="p">,</span> <span class="n">ku</span><span class="p">,</span> <span class="n">im</span><span class="p">,</span> <span class="n">jp</span><span class="p">,</span> <span class="n">km</span><span class="p">,</span> <span class="n">m</span>
<a name="ln-436"></a>
<a name="ln-437"></a>      <span class="k">if</span> <span class="p">(</span><span class="n">iwallmom</span> <span class="o">==</span> <span class="mi">1</span><span class="p">)</span> <span class="k">then</span>
<a name="ln-438"></a>      <span class="c">!fixed flux, not implemented</span>
<a name="ln-439"></a>      <span class="k">else if</span> <span class="p">(</span><span class="n">iwallmom</span> <span class="o">==</span> <span class="mi">2</span><span class="p">)</span> <span class="k">then</span>
<a name="ln-440"></a><span class="k">      do </span><span class="n">n</span> <span class="o">=</span> <span class="mi">1</span><span class="p">,</span> <span class="n">nyminwall</span>
<a name="ln-441"></a>      <span class="n">k</span> <span class="o">=</span> <span class="k">block</span><span class="p">(</span><span class="n">iyminwall</span><span class="p">(</span><span class="n">n</span><span class="p">,</span> <span class="mi">1</span><span class="p">),</span> <span class="mi">11</span><span class="p">)</span>
<a name="ln-442"></a>      <span class="k">call </span><span class="n">wfuno</span><span class="p">(</span><span class="n">ih</span><span class="p">,</span> <span class="n">jh</span><span class="p">,</span> <span class="n">kh</span><span class="p">,</span> <span class="n">up</span><span class="p">,</span> <span class="n">wp</span><span class="p">,</span> <span class="n">thlp</span><span class="p">,</span> <span class="n">momfluxb</span><span class="p">,</span> <span class="n">tfluxb</span><span class="p">,</span> <span class="n">cth</span><span class="p">,</span> <span class="n">bcTfluxA</span><span class="p">,</span> <span class="n">u0</span><span class="p">,</span> <span class="n">w0</span><span class="p">,</span> <span class="n">thl0</span><span class="p">,</span> <span class="n">facT</span><span class="p">(</span><span class="n">k</span><span class="p">,</span><span class="mi">1</span><span class="p">),</span> <span class="n">facz0</span><span class="p">(</span><span class="n">k</span><span class="p">),</span> <span class="n">facz0h</span><span class="p">(</span><span class="n">k</span><span class="p">),</span> <span class="n">iyminwall</span><span class="p">(</span><span class="n">n</span><span class="p">,</span> <span class="mi">1</span><span class="p">),</span> <span class="n">iyminwall</span><span class="p">(</span><span class="n">n</span><span class="p">,</span> <span class="mi">2</span><span class="p">),</span> <span class="mi">41</span><span class="p">)</span>
<a name="ln-443"></a>      <span class="k">end do</span>
<a name="ln-444"></a><span class="k">      else if</span> <span class="p">(</span><span class="n">iwallmom</span> <span class="o">==</span> <span class="mi">3</span><span class="p">)</span> <span class="k">then</span>
<a name="ln-445"></a><span class="k">      do </span><span class="n">n</span> <span class="o">=</span> <span class="mi">1</span><span class="p">,</span> <span class="n">nyminwall</span>
<a name="ln-446"></a>      <span class="n">k</span> <span class="o">=</span> <span class="k">block</span><span class="p">(</span><span class="n">iyminwall</span><span class="p">(</span><span class="n">n</span><span class="p">,</span> <span class="mi">1</span><span class="p">),</span> <span class="mi">11</span><span class="p">)</span>
<a name="ln-447"></a>      <span class="k">call </span><span class="n">wfmneutral</span><span class="p">(</span><span class="n">ih</span><span class="p">,</span> <span class="n">jh</span><span class="p">,</span> <span class="n">kh</span><span class="p">,</span> <span class="n">up</span><span class="p">,</span> <span class="n">wp</span><span class="p">,</span> <span class="n">momfluxb</span><span class="p">,</span> <span class="n">u0</span><span class="p">,</span> <span class="n">w0</span><span class="p">,</span> <span class="n">facz0</span><span class="p">(</span><span class="n">k</span><span class="p">),</span> <span class="n">iyminwall</span><span class="p">(</span><span class="n">n</span><span class="p">,</span> <span class="mi">1</span><span class="p">),</span> <span class="n">iyminwall</span><span class="p">(</span><span class="n">n</span><span class="p">,</span> <span class="mi">2</span><span class="p">),</span> <span class="mi">41</span><span class="p">)</span>
<a name="ln-448"></a>      <span class="k">end do</span>
<a name="ln-449"></a><span class="k">      end if</span> <span class="c">!</span>
<a name="ln-450"></a>
<a name="ln-451"></a>      <span class="k">if</span> <span class="p">(</span><span class="n">ltempeq</span><span class="p">)</span> <span class="k">then</span>
<a name="ln-452"></a><span class="k">      if</span> <span class="p">(</span><span class="n">iwalltemp</span> <span class="o">==</span> <span class="mi">1</span><span class="p">)</span> <span class="k">then</span>
<a name="ln-453"></a><span class="k">         do </span><span class="n">n</span> <span class="o">=</span> <span class="mi">1</span><span class="p">,</span> <span class="n">nyminwall</span> <span class="c">!</span>
<a name="ln-454"></a>            <span class="k">call </span><span class="n">ywallscalarmin</span><span class="p">(</span><span class="n">ih</span><span class="p">,</span> <span class="n">jh</span><span class="p">,</span> <span class="n">kh</span><span class="p">,</span> <span class="n">thl0</span><span class="p">,</span> <span class="n">thlp</span><span class="p">,</span> <span class="n">bctfym</span><span class="p">,</span> <span class="n">n</span><span class="p">)</span>
<a name="ln-455"></a>         <span class="k">end do</span>
<a name="ln-456"></a><span class="k">      else if</span> <span class="p">(</span><span class="n">iwalltemp</span> <span class="o">==</span> <span class="mi">2</span><span class="p">)</span> <span class="k">then</span>
<a name="ln-457"></a><span class="k">         do </span><span class="n">n</span> <span class="o">=</span> <span class="mi">1</span><span class="p">,</span> <span class="n">nyminwall</span>
<a name="ln-458"></a>            <span class="n">k</span> <span class="o">=</span> <span class="k">block</span><span class="p">(</span><span class="n">iyminwall</span><span class="p">(</span><span class="n">n</span><span class="p">,</span> <span class="mi">1</span><span class="p">),</span> <span class="mi">11</span><span class="p">)</span>
<a name="ln-459"></a>            <span class="k">call </span><span class="n">wfuno</span><span class="p">(</span><span class="n">ih</span><span class="p">,</span> <span class="n">jh</span><span class="p">,</span> <span class="n">kh</span><span class="p">,</span> <span class="n">up</span><span class="p">,</span> <span class="n">wp</span><span class="p">,</span> <span class="n">thlp</span><span class="p">,</span> <span class="n">momfluxb</span><span class="p">,</span> <span class="n">tfluxb</span><span class="p">,</span> <span class="n">cth</span><span class="p">,</span> <span class="n">bcTfluxA</span><span class="p">,</span> <span class="n">u0</span><span class="p">,</span> <span class="n">w0</span><span class="p">,</span> <span class="n">thl0</span><span class="p">,</span> <span class="n">facT</span><span class="p">(</span><span class="n">k</span><span class="p">,</span><span class="mi">1</span><span class="p">),</span> <span class="n">facz0</span><span class="p">(</span><span class="n">k</span><span class="p">),</span> <span class="n">facz0h</span><span class="p">(</span><span class="n">k</span><span class="p">),</span> <span class="n">iyminwall</span><span class="p">(</span><span class="n">n</span><span class="p">,</span> <span class="mi">1</span><span class="p">),</span> <span class="n">iyminwall</span><span class="p">(</span><span class="n">n</span><span class="p">,</span> <span class="mi">2</span><span class="p">),</span> <span class="mi">42</span><span class="p">)</span>
<a name="ln-460"></a>            <span class="n">fachf</span><span class="p">(</span><span class="n">k</span><span class="p">)</span> <span class="o">=</span> <span class="n">fachf</span><span class="p">(</span><span class="n">k</span><span class="p">)</span> <span class="o">+</span> <span class="n">bcTfluxA</span>
<a name="ln-461"></a>         <span class="k">end do</span>
<a name="ln-462"></a><span class="k">      end if</span>
<a name="ln-463"></a><span class="k">      end if</span>
<a name="ln-464"></a>
<a name="ln-465"></a><span class="k">      if</span> <span class="p">(</span><span class="n">lmoist</span><span class="p">)</span> <span class="k">then</span>
<a name="ln-466"></a><span class="k">      if</span> <span class="p">(</span><span class="n">iwallmoist</span> <span class="o">==</span> <span class="mi">1</span><span class="p">)</span> <span class="k">then</span>
<a name="ln-467"></a><span class="k">         do </span><span class="n">n</span> <span class="o">=</span> <span class="mi">1</span><span class="p">,</span> <span class="n">nyminwall</span> <span class="c">!</span>
<a name="ln-468"></a>            <span class="k">call </span><span class="n">ywallscalarmin</span><span class="p">(</span><span class="n">ih</span><span class="p">,</span> <span class="n">jh</span><span class="p">,</span> <span class="n">kh</span><span class="p">,</span> <span class="n">qt0</span><span class="p">,</span> <span class="n">qtp</span><span class="p">,</span> <span class="n">bcqfym</span><span class="p">,</span> <span class="n">n</span><span class="p">)</span>
<a name="ln-469"></a>         <span class="k">end do</span>
<a name="ln-470"></a><span class="k">      end if</span>
<a name="ln-471"></a><span class="k">      if</span> <span class="p">((</span><span class="n">ltempeq</span><span class="p">)</span> <span class="p">.</span><span class="nb">and</span><span class="p">.</span> <span class="p">(</span><span class="n">iwallmoist</span> <span class="o">==</span> <span class="mi">2</span><span class="p">))</span> <span class="k">then</span>
<a name="ln-472"></a><span class="k">         do </span><span class="n">n</span> <span class="o">=</span> <span class="mi">1</span><span class="p">,</span> <span class="n">nyminwall</span>
<a name="ln-473"></a>            <span class="n">k</span> <span class="o">=</span> <span class="k">block</span><span class="p">(</span><span class="n">iyminwall</span><span class="p">(</span><span class="n">n</span><span class="p">,</span> <span class="mi">1</span><span class="p">),</span> <span class="mi">11</span><span class="p">)</span>
<a name="ln-474"></a>            <span class="k">if</span> <span class="p">(</span><span class="n">faclGR</span><span class="p">(</span><span class="n">k</span><span class="p">))</span> <span class="k">then</span>
<a name="ln-475"></a><span class="k">            call </span><span class="n">wfGR</span><span class="p">(</span><span class="n">ih</span><span class="p">,</span> <span class="n">jh</span><span class="p">,</span> <span class="n">kh</span><span class="p">,</span> <span class="n">qtp</span><span class="p">,</span> <span class="n">qfluxb</span><span class="p">,</span> <span class="n">cth</span><span class="p">,</span> <span class="n">bcqfluxA</span><span class="p">,</span> <span class="n">qt0</span><span class="p">,</span> <span class="n">facqsat</span><span class="p">(</span><span class="n">k</span><span class="p">),</span><span class="n">fachurel</span><span class="p">(</span><span class="n">k</span><span class="p">),</span><span class="n">facf</span><span class="p">(</span><span class="n">k</span><span class="p">,</span><span class="mi">4</span><span class="p">),</span><span class="n">facf</span><span class="p">(</span><span class="n">k</span><span class="p">,</span><span class="mi">5</span><span class="p">),</span><span class="n">iyminwall</span><span class="p">(</span><span class="n">n</span><span class="p">,</span> <span class="mi">1</span><span class="p">),</span> <span class="n">iyminwall</span><span class="p">(</span><span class="n">n</span><span class="p">,</span> <span class="mi">2</span><span class="p">),</span> <span class="mi">42</span><span class="p">)</span>
<a name="ln-476"></a>               <span class="n">facef</span><span class="p">(</span><span class="n">k</span><span class="p">)</span> <span class="o">=</span> <span class="n">facef</span><span class="p">(</span><span class="n">k</span><span class="p">)</span> <span class="o">+</span> <span class="n">bcqfluxA</span>
<a name="ln-477"></a>            <span class="k">end if</span>
<a name="ln-478"></a><span class="k">         end do</span>
<a name="ln-479"></a><span class="k">      end if</span>
<a name="ln-480"></a><span class="k">      end if</span>
<a name="ln-481"></a>
<a name="ln-482"></a><span class="k">      if</span> <span class="p">(</span><span class="n">nsv</span><span class="o">&gt;</span><span class="mi">0</span><span class="p">)</span> <span class="k">then</span>
<a name="ln-483"></a><span class="k">      if</span> <span class="p">(</span><span class="n">iwallscal</span> <span class="o">==</span> <span class="mi">1</span><span class="p">)</span> <span class="k">then</span>
<a name="ln-484"></a><span class="k">         do </span><span class="n">n</span> <span class="o">=</span> <span class="mi">1</span><span class="p">,</span> <span class="n">nyminwall</span> <span class="c">!</span>
<a name="ln-485"></a>            <span class="k">do </span><span class="n">m</span> <span class="o">=</span> <span class="mi">1</span><span class="p">,</span> <span class="n">nsv</span>
<a name="ln-486"></a>               <span class="k">call </span><span class="n">ywallscalarmin</span><span class="p">(</span><span class="n">ihc</span><span class="p">,</span> <span class="n">jhc</span><span class="p">,</span> <span class="n">khc</span><span class="p">,</span> <span class="n">sv0</span><span class="p">(:,:,:,</span><span class="n">m</span><span class="p">),</span> <span class="n">svp</span><span class="p">(:,:,:,</span><span class="n">m</span><span class="p">),</span> <span class="mf">0.</span><span class="p">,</span> <span class="n">n</span><span class="p">)</span>
<a name="ln-487"></a>            <span class="k">end do</span>
<a name="ln-488"></a><span class="k">         end do</span>
<a name="ln-489"></a><span class="k">      end if</span>
<a name="ln-490"></a><span class="k">      end if</span>
<a name="ln-491"></a>
<a name="ln-492"></a><span class="k">   end subroutine </span><span class="n">ywallfunmin</span>
<a name="ln-493"></a>
<a name="ln-494"></a>   <span class="k">subroutine </span><span class="n">ywallscalarmin</span><span class="p">(</span><span class="n">hi</span><span class="p">,</span> <span class="n">hj</span><span class="p">,</span> <span class="n">hk</span><span class="p">,</span> <span class="n">putin</span><span class="p">,</span> <span class="n">putout</span><span class="p">,</span> <span class="n">bcvaluem</span><span class="p">,</span> <span class="n">n</span><span class="p">)</span>
<a name="ln-495"></a>      <span class="k">use </span><span class="n">modglobal</span><span class="p">,</span> <span class="n">only</span><span class="p">:</span><span class="n">dyi</span><span class="p">,</span> <span class="n">ib</span><span class="p">,</span> <span class="n">ie</span><span class="p">,</span> <span class="n">jb</span><span class="p">,</span> <span class="n">je</span><span class="p">,</span> <span class="n">kb</span><span class="p">,</span> <span class="n">ke</span><span class="p">,</span> <span class="n">prandtlmoli</span><span class="p">,</span> <span class="n">numol</span>
<a name="ln-496"></a>      <span class="k">use </span><span class="n">modsubgriddata</span><span class="p">,</span> <span class="n">only</span><span class="p">:</span><span class="n">ekh</span>
<a name="ln-497"></a>      <span class="k">use </span><span class="n">modmpi</span><span class="p">,</span> <span class="n">only</span><span class="p">:</span><span class="n">myid</span>
<a name="ln-498"></a>      <span class="k">use </span><span class="n">initfac</span><span class="p">,</span> <span class="n">only</span><span class="p">:</span><span class="k">block</span>
<a name="ln-499"></a><span class="k">      </span><span class="kt">integer </span><span class="n">i</span><span class="p">,</span> <span class="n">j</span><span class="p">,</span> <span class="n">k</span><span class="p">,</span> <span class="n">il</span><span class="p">,</span> <span class="n">iu</span><span class="p">,</span> <span class="n">kl</span><span class="p">,</span> <span class="n">ku</span><span class="p">,</span> <span class="n">m</span>
<a name="ln-500"></a>
<a name="ln-501"></a>      <span class="kt">integer</span><span class="p">,</span> <span class="k">intent</span><span class="p">(</span><span class="n">in</span><span class="p">)</span> <span class="kd">::</span> <span class="n">hi</span> <span class="c">!&lt;size of halo in i</span>
<a name="ln-502"></a>      <span class="kt">integer</span><span class="p">,</span> <span class="k">intent</span><span class="p">(</span><span class="n">in</span><span class="p">)</span> <span class="kd">::</span> <span class="n">hj</span> <span class="c">!&lt;size of halo in j</span>
<a name="ln-503"></a>      <span class="kt">integer</span><span class="p">,</span> <span class="k">intent</span><span class="p">(</span><span class="n">in</span><span class="p">)</span> <span class="kd">::</span> <span class="n">hk</span> <span class="c">!&lt;size of halo in k</span>
<a name="ln-504"></a>      <span class="kt">real</span><span class="p">,</span> <span class="k">intent</span><span class="p">(</span><span class="n">in</span><span class="p">)</span>    <span class="kd">::</span> <span class="n">putin</span><span class="p">(</span><span class="n">ib</span> <span class="o">-</span> <span class="n">hi</span><span class="p">:</span><span class="n">ie</span> <span class="o">+</span> <span class="n">hi</span><span class="p">,</span> <span class="n">jb</span> <span class="o">-</span> <span class="n">hj</span><span class="p">:</span><span class="n">je</span> <span class="o">+</span> <span class="n">hj</span><span class="p">,</span> <span class="n">kb</span> <span class="o">-</span> <span class="n">hk</span><span class="p">:</span><span class="n">ke</span> <span class="o">+</span> <span class="n">hk</span><span class="p">)</span>
<a name="ln-505"></a>      <span class="kt">real</span><span class="p">,</span> <span class="k">intent</span><span class="p">(</span><span class="n">inout</span><span class="p">)</span> <span class="kd">::</span> <span class="n">putout</span><span class="p">(</span><span class="n">ib</span> <span class="o">-</span> <span class="n">hi</span><span class="p">:</span><span class="n">ie</span> <span class="o">+</span> <span class="n">hi</span><span class="p">,</span> <span class="n">jb</span> <span class="o">-</span> <span class="n">hj</span><span class="p">:</span><span class="n">je</span> <span class="o">+</span> <span class="n">hj</span><span class="p">,</span> <span class="n">kb</span><span class="p">:</span><span class="n">ke</span> <span class="o">+</span> <span class="n">hk</span><span class="p">)</span>
<a name="ln-506"></a>      <span class="kt">real</span><span class="p">,</span> <span class="k">intent</span><span class="p">(</span><span class="n">in</span><span class="p">)</span>    <span class="kd">::</span> <span class="n">bcvaluem</span>
<a name="ln-507"></a>      <span class="kt">integer</span><span class="p">,</span> <span class="k">intent</span><span class="p">(</span><span class="n">in</span><span class="p">)</span>    <span class="kd">::</span> <span class="n">n</span>
<a name="ln-508"></a>
<a name="ln-509"></a>      <span class="n">j</span> <span class="o">=</span> <span class="n">iyminwall</span><span class="p">(</span><span class="n">n</span><span class="p">,</span> <span class="mi">2</span><span class="p">)</span>
<a name="ln-510"></a>      <span class="n">m</span> <span class="o">=</span> <span class="n">iyminwall</span><span class="p">(</span><span class="n">n</span><span class="p">,</span> <span class="mi">1</span><span class="p">)</span>
<a name="ln-511"></a>      <span class="n">il</span> <span class="o">=</span> <span class="k">block</span><span class="p">(</span><span class="n">m</span><span class="p">,</span> <span class="mi">1</span><span class="p">)</span>
<a name="ln-512"></a>      <span class="n">iu</span> <span class="o">=</span> <span class="k">block</span><span class="p">(</span><span class="n">m</span><span class="p">,</span> <span class="mi">2</span><span class="p">)</span>
<a name="ln-513"></a>      <span class="n">kl</span> <span class="o">=</span> <span class="k">block</span><span class="p">(</span><span class="n">m</span><span class="p">,</span> <span class="mi">5</span><span class="p">)</span>
<a name="ln-514"></a>      <span class="n">ku</span> <span class="o">=</span> <span class="k">block</span><span class="p">(</span><span class="n">m</span><span class="p">,</span> <span class="mi">6</span><span class="p">)</span>
<a name="ln-515"></a>
<a name="ln-516"></a>      <span class="k">do </span><span class="n">k</span> <span class="o">=</span> <span class="n">kl</span><span class="p">,</span> <span class="n">ku</span>
<a name="ln-517"></a>         <span class="k">do </span><span class="n">i</span> <span class="o">=</span> <span class="n">il</span><span class="p">,</span> <span class="n">iu</span>
<a name="ln-518"></a>            <span class="n">putout</span><span class="p">(</span><span class="n">i</span><span class="p">,</span> <span class="n">j</span><span class="p">,</span> <span class="n">k</span><span class="p">)</span> <span class="o">=</span> <span class="n">putout</span><span class="p">(</span><span class="n">i</span><span class="p">,</span> <span class="n">j</span><span class="p">,</span> <span class="n">k</span><span class="p">)</span> <span class="o">+</span> <span class="p">(</span> <span class="p">&amp;</span>
<a name="ln-519"></a>                              <span class="o">-</span><span class="mf">0.5</span><span class="o">*</span><span class="p">(</span><span class="n">ekh</span><span class="p">(</span><span class="n">i</span><span class="p">,</span> <span class="n">j</span><span class="p">,</span> <span class="n">k</span><span class="p">)</span> <span class="o">+</span> <span class="n">ekh</span><span class="p">(</span><span class="n">i</span><span class="p">,</span> <span class="n">j</span> <span class="o">+</span> <span class="mi">1</span><span class="p">,</span> <span class="n">k</span><span class="p">))</span><span class="o">*</span><span class="p">(</span><span class="n">putin</span><span class="p">(</span><span class="n">i</span><span class="p">,</span> <span class="n">j</span> <span class="o">+</span> <span class="mi">1</span><span class="p">,</span> <span class="n">k</span><span class="p">)</span> <span class="o">-</span> <span class="n">putin</span><span class="p">(</span><span class="n">i</span><span class="p">,</span> <span class="n">j</span><span class="p">,</span> <span class="n">k</span><span class="p">))</span><span class="o">*</span><span class="n">dyi</span> <span class="p">&amp;</span>
<a name="ln-520"></a>                              <span class="o">-</span> <span class="n">bcvaluem</span><span class="p">)</span><span class="o">*</span><span class="n">dyi</span>
<a name="ln-521"></a>         <span class="k">end do</span>
<a name="ln-522"></a><span class="k">      end do</span>
<a name="ln-523"></a>
<a name="ln-524"></a><span class="k">   end subroutine </span><span class="n">ywallscalarmin</span>
<a name="ln-525"></a>
<a name="ln-526"></a>   <span class="k">subroutine </span><span class="n">zwallfun</span>
<a name="ln-527"></a>      <span class="k">use </span><span class="n">modglobal</span><span class="p">,</span> <span class="n">only</span><span class="p">:</span><span class="n">dzf</span><span class="p">,</span> <span class="n">dzfi</span><span class="p">,</span> <span class="n">dzhi</span><span class="p">,</span> <span class="n">dzhiq</span><span class="p">,</span> <span class="n">dxf</span><span class="p">,</span> <span class="n">dxfi</span><span class="p">,</span> <span class="n">dxhi</span><span class="p">,</span> <span class="n">dyi</span><span class="p">,</span> <span class="n">nsv</span><span class="p">,</span> <span class="n">lles</span><span class="p">,</span> <span class="n">numol</span><span class="p">,</span> <span class="n">ltempeq</span><span class="p">,</span> <span class="n">lmoist</span><span class="p">,</span> <span class="p">&amp;</span>
<a name="ln-528"></a>         <span class="n">ih</span><span class="p">,</span> <span class="n">jh</span><span class="p">,</span> <span class="n">kh</span><span class="p">,</span> <span class="n">ihc</span><span class="p">,</span> <span class="n">jhc</span><span class="p">,</span> <span class="n">khc</span><span class="p">,</span> <span class="n">iwallmom</span><span class="p">,</span> <span class="n">iwalltemp</span><span class="p">,</span> <span class="n">iwallmoist</span><span class="p">,</span> <span class="n">iwallscal</span>
<a name="ln-529"></a>      <span class="k">use </span><span class="n">modfields</span><span class="p">,</span> <span class="n">only</span><span class="p">:</span><span class="n">u0</span><span class="p">,</span> <span class="n">v0</span><span class="p">,</span> <span class="n">up</span><span class="p">,</span> <span class="n">vp</span><span class="p">,</span> <span class="n">shear</span><span class="p">,</span> <span class="n">thl0</span><span class="p">,</span> <span class="n">thlp</span><span class="p">,</span> <span class="n">qt0</span><span class="p">,</span> <span class="n">qtp</span><span class="p">,</span> <span class="n">sv0</span><span class="p">,</span> <span class="n">svp</span><span class="p">,</span> <span class="n">tfluxb</span><span class="p">,</span> <span class="n">momfluxb</span><span class="p">,</span> <span class="n">exnf</span><span class="p">,</span> <span class="n">cth</span><span class="p">,</span> <span class="n">qfluxb</span>
<a name="ln-530"></a>      <span class="k">use </span><span class="n">modmpi</span><span class="p">,</span> <span class="n">only</span><span class="p">:</span><span class="n">myid</span>
<a name="ln-531"></a>      <span class="k">use </span><span class="n">initfac</span><span class="p">,</span> <span class="n">only</span><span class="p">:</span><span class="n">fachf</span><span class="p">,</span> <span class="k">block</span><span class="p">,</span> <span class="n">faclGR</span><span class="p">,</span> <span class="n">facef</span><span class="p">,</span> <span class="n">facqsat</span><span class="p">,</span> <span class="n">fachurel</span><span class="p">,</span> <span class="n">facf</span><span class="p">,</span> <span class="n">facT</span><span class="p">,</span> <span class="n">facz0</span><span class="p">,</span> <span class="n">facz0h</span>
<a name="ln-532"></a>      <span class="kt">integer </span><span class="n">i</span><span class="p">,</span> <span class="n">j</span><span class="p">,</span> <span class="n">k</span><span class="p">,</span> <span class="n">n</span><span class="p">,</span> <span class="n">nc</span><span class="p">,</span> <span class="n">il</span><span class="p">,</span> <span class="n">iu</span><span class="p">,</span> <span class="n">jl</span><span class="p">,</span> <span class="n">ju</span><span class="p">,</span> <span class="n">im</span><span class="p">,</span> <span class="n">jm</span><span class="p">,</span> <span class="n">km</span><span class="p">,</span> <span class="n">m</span>
<a name="ln-533"></a>
<a name="ln-534"></a>      <span class="k">if</span> <span class="p">(</span><span class="n">iwallmom</span> <span class="o">==</span> <span class="mi">1</span><span class="p">)</span> <span class="k">then</span>
<a name="ln-535"></a>      <span class="c">!fixed flux</span>
<a name="ln-536"></a>      <span class="k">else if</span> <span class="p">(</span><span class="n">iwallmom</span> <span class="o">==</span> <span class="mi">2</span><span class="p">)</span> <span class="k">then</span>
<a name="ln-537"></a><span class="k">         do </span><span class="n">n</span> <span class="o">=</span> <span class="mi">1</span><span class="p">,</span> <span class="n">nxwall</span>
<a name="ln-538"></a>            <span class="n">k</span> <span class="o">=</span> <span class="k">block</span><span class="p">(</span><span class="n">ixwall</span><span class="p">(</span><span class="n">n</span><span class="p">),</span> <span class="mi">7</span><span class="p">)</span>
<a name="ln-539"></a>            <span class="k">call </span><span class="n">wfuno</span><span class="p">(</span><span class="n">ih</span><span class="p">,</span> <span class="n">jh</span><span class="p">,</span> <span class="n">kh</span><span class="p">,</span> <span class="n">up</span><span class="p">,</span> <span class="n">vp</span><span class="p">,</span> <span class="n">thlp</span><span class="p">,</span> <span class="n">momfluxb</span><span class="p">,</span> <span class="n">tfluxb</span><span class="p">,</span> <span class="n">cth</span><span class="p">,</span> <span class="n">bcTfluxA</span><span class="p">,</span> <span class="n">u0</span><span class="p">,</span> <span class="n">v0</span><span class="p">,</span> <span class="n">thl0</span><span class="p">,</span> <span class="n">facT</span><span class="p">(</span><span class="n">k</span><span class="p">,</span> <span class="mi">1</span><span class="p">),</span> <span class="n">facz0</span><span class="p">(</span><span class="n">k</span><span class="p">),</span> <span class="n">facz0h</span><span class="p">(</span><span class="n">k</span><span class="p">),</span> <span class="n">ixwall</span><span class="p">(</span><span class="n">n</span><span class="p">),</span> <span class="mi">1</span><span class="p">,</span> <span class="mi">51</span><span class="p">)</span>
<a name="ln-540"></a>         <span class="k">end do</span>
<a name="ln-541"></a><span class="k">      else if</span> <span class="p">(</span><span class="n">iwallmom</span> <span class="o">==</span> <span class="mi">3</span><span class="p">)</span> <span class="k">then</span>
<a name="ln-542"></a><span class="k">         do </span><span class="n">n</span> <span class="o">=</span> <span class="mi">1</span><span class="p">,</span> <span class="n">nxwall</span>
<a name="ln-543"></a>            <span class="n">k</span> <span class="o">=</span> <span class="k">block</span><span class="p">(</span><span class="n">ixwall</span><span class="p">(</span><span class="n">n</span><span class="p">),</span> <span class="mi">7</span><span class="p">)</span>
<a name="ln-544"></a>            <span class="k">call </span><span class="n">wfmneutral</span><span class="p">(</span><span class="n">ih</span><span class="p">,</span> <span class="n">jh</span><span class="p">,</span> <span class="n">kh</span><span class="p">,</span> <span class="n">up</span><span class="p">,</span> <span class="n">vp</span><span class="p">,</span> <span class="n">momfluxb</span><span class="p">,</span> <span class="n">u0</span><span class="p">,</span> <span class="n">v0</span><span class="p">,</span> <span class="n">facz0</span><span class="p">(</span><span class="n">k</span><span class="p">),</span> <span class="n">ixwall</span><span class="p">(</span><span class="n">n</span><span class="p">),</span> <span class="mi">1</span><span class="p">,</span> <span class="mi">51</span><span class="p">)</span>
<a name="ln-545"></a>         <span class="k">end do</span>
<a name="ln-546"></a><span class="k">      end if</span>
<a name="ln-547"></a>
<a name="ln-548"></a><span class="k">      if</span> <span class="p">(</span><span class="n">ltempeq</span><span class="p">)</span> <span class="k">then</span>
<a name="ln-549"></a><span class="k">      if</span> <span class="p">(</span><span class="n">iwalltemp</span> <span class="o">==</span> <span class="mi">1</span><span class="p">)</span> <span class="k">then</span>
<a name="ln-550"></a><span class="k">         do </span><span class="n">n</span> <span class="o">=</span> <span class="mi">1</span><span class="p">,</span> <span class="n">nxwall</span> <span class="c">! loop over all shear x-walls</span>
<a name="ln-551"></a>            <span class="k">call </span><span class="n">zwallscalar</span><span class="p">(</span><span class="n">ih</span><span class="p">,</span> <span class="n">jh</span><span class="p">,</span> <span class="n">kh</span><span class="p">,</span> <span class="n">thl0</span><span class="p">,</span> <span class="n">thlp</span><span class="p">,</span> <span class="n">bctfz</span><span class="p">,</span> <span class="n">ixwall</span><span class="p">(</span><span class="n">n</span><span class="p">))</span>
<a name="ln-552"></a>         <span class="k">end do</span>
<a name="ln-553"></a><span class="k">      else if</span> <span class="p">(</span><span class="n">iwalltemp</span> <span class="o">==</span> <span class="mi">2</span><span class="p">)</span> <span class="k">then</span>
<a name="ln-554"></a><span class="k">         do </span><span class="n">n</span> <span class="o">=</span> <span class="mi">1</span><span class="p">,</span> <span class="n">nxwall</span>
<a name="ln-555"></a>            <span class="n">k</span> <span class="o">=</span> <span class="k">block</span><span class="p">(</span><span class="n">ixwall</span><span class="p">(</span><span class="n">n</span><span class="p">),</span> <span class="mi">7</span><span class="p">)</span>
<a name="ln-556"></a>            <span class="k">call </span><span class="n">wfuno</span><span class="p">(</span><span class="n">ih</span><span class="p">,</span> <span class="n">jh</span><span class="p">,</span> <span class="n">kh</span><span class="p">,</span> <span class="n">up</span><span class="p">,</span> <span class="n">vp</span><span class="p">,</span> <span class="n">thlp</span><span class="p">,</span> <span class="n">momfluxb</span><span class="p">,</span> <span class="n">tfluxb</span><span class="p">,</span> <span class="n">cth</span><span class="p">,</span> <span class="n">bcTfluxA</span><span class="p">,</span> <span class="n">u0</span><span class="p">,</span> <span class="n">v0</span><span class="p">,</span> <span class="n">thl0</span><span class="p">,</span> <span class="n">facT</span><span class="p">(</span><span class="n">k</span><span class="p">,</span> <span class="mi">1</span><span class="p">),</span> <span class="n">facz0</span><span class="p">(</span><span class="n">k</span><span class="p">),</span> <span class="n">facz0h</span><span class="p">(</span><span class="n">k</span><span class="p">),</span> <span class="n">ixwall</span><span class="p">(</span><span class="n">n</span><span class="p">),</span> <span class="mi">1</span><span class="p">,</span> <span class="mi">52</span><span class="p">)</span>
<a name="ln-557"></a>            <span class="n">fachf</span><span class="p">(</span><span class="n">k</span><span class="p">)</span> <span class="o">=</span> <span class="n">fachf</span><span class="p">(</span><span class="n">k</span><span class="p">)</span> <span class="o">+</span> <span class="n">bcTfluxA</span>
<a name="ln-558"></a>         <span class="k">end do</span>
<a name="ln-559"></a><span class="k">      end if</span>
<a name="ln-560"></a><span class="k">      end if</span>
<a name="ln-561"></a><span class="k">      if</span> <span class="p">(</span><span class="n">lmoist</span><span class="p">)</span> <span class="k">then</span>
<a name="ln-562"></a><span class="k">      if</span> <span class="p">(</span><span class="n">iwallmoist</span> <span class="o">==</span> <span class="mi">1</span><span class="p">)</span> <span class="k">then</span>
<a name="ln-563"></a><span class="k">         do </span><span class="n">n</span> <span class="o">=</span> <span class="mi">1</span><span class="p">,</span> <span class="n">nxwall</span> <span class="c">! loop over all shear x-walls</span>
<a name="ln-564"></a>            <span class="k">call </span><span class="n">zwallscalar</span><span class="p">(</span><span class="n">ih</span><span class="p">,</span> <span class="n">jh</span><span class="p">,</span> <span class="n">kh</span><span class="p">,</span> <span class="n">qt0</span><span class="p">,</span> <span class="n">qtp</span><span class="p">,</span> <span class="n">bcqfz</span><span class="p">,</span> <span class="n">ixwall</span><span class="p">(</span><span class="n">n</span><span class="p">))</span>
<a name="ln-565"></a>         <span class="k">end do</span>
<a name="ln-566"></a><span class="k">      end if</span>
<a name="ln-567"></a><span class="k">      if</span> <span class="p">((</span><span class="n">ltempeq</span><span class="p">)</span> <span class="p">.</span><span class="nb">and</span><span class="p">.</span> <span class="p">(</span><span class="n">iwallmoist</span> <span class="o">==</span> <span class="mi">2</span><span class="p">))</span> <span class="k">then</span>
<a name="ln-568"></a><span class="k">         do </span><span class="n">n</span> <span class="o">=</span> <span class="mi">1</span><span class="p">,</span> <span class="n">nxwall</span>
<a name="ln-569"></a>            <span class="n">k</span> <span class="o">=</span> <span class="k">block</span><span class="p">(</span><span class="n">ixwall</span><span class="p">(</span><span class="n">n</span><span class="p">),</span> <span class="mi">7</span><span class="p">)</span>
<a name="ln-570"></a>            <span class="k">if</span> <span class="p">(</span><span class="n">faclGR</span><span class="p">(</span><span class="n">k</span><span class="p">))</span> <span class="k">then</span>
<a name="ln-571"></a><span class="k">           call </span><span class="n">wfGR</span><span class="p">(</span><span class="n">ih</span><span class="p">,</span> <span class="n">jh</span><span class="p">,</span> <span class="n">kh</span><span class="p">,</span> <span class="n">qtp</span><span class="p">,</span> <span class="n">qfluxb</span><span class="p">,</span> <span class="n">cth</span><span class="p">,</span> <span class="n">bcqfluxA</span><span class="p">,</span> <span class="n">qt0</span><span class="p">,</span> <span class="n">facqsat</span><span class="p">(</span><span class="n">k</span><span class="p">),</span> <span class="n">fachurel</span><span class="p">(</span><span class="n">k</span><span class="p">),</span> <span class="n">facf</span><span class="p">(</span><span class="n">k</span><span class="p">,</span> <span class="mi">4</span><span class="p">),</span> <span class="n">facf</span><span class="p">(</span><span class="n">k</span><span class="p">,</span> <span class="mi">5</span><span class="p">),</span> <span class="n">ixwall</span><span class="p">(</span><span class="n">n</span><span class="p">),</span> <span class="mi">1</span><span class="p">,</span> <span class="mi">52</span><span class="p">)</span>
<a name="ln-572"></a>                <span class="n">facef</span><span class="p">(</span><span class="n">k</span><span class="p">)</span> <span class="o">=</span> <span class="n">facef</span><span class="p">(</span><span class="n">k</span><span class="p">)</span> <span class="o">+</span> <span class="n">bcqfluxA</span>
<a name="ln-573"></a>            <span class="k">end if</span>
<a name="ln-574"></a><span class="k">         end do</span>
<a name="ln-575"></a><span class="k">      end if</span>
<a name="ln-576"></a><span class="k">      end if</span>
<a name="ln-577"></a>
<a name="ln-578"></a><span class="k">      if</span> <span class="p">(</span><span class="n">nsv</span><span class="o">&gt;</span><span class="mi">0</span><span class="p">)</span> <span class="k">then</span>
<a name="ln-579"></a><span class="k">      if</span> <span class="p">(</span><span class="n">iwallscal</span> <span class="o">==</span> <span class="mi">1</span><span class="p">)</span> <span class="k">then</span>
<a name="ln-580"></a><span class="k">         do </span><span class="n">n</span> <span class="o">=</span> <span class="mi">1</span><span class="p">,</span> <span class="n">nxwall</span> <span class="c">! loop over all shear x-walls</span>
<a name="ln-581"></a>            <span class="k">do </span><span class="n">m</span> <span class="o">=</span> <span class="mi">1</span><span class="p">,</span> <span class="n">nsv</span>
<a name="ln-582"></a>               <span class="k">call </span><span class="n">zwallscalar</span><span class="p">(</span><span class="n">ihc</span><span class="p">,</span> <span class="n">jhc</span><span class="p">,</span> <span class="n">khc</span><span class="p">,</span> <span class="n">sv0</span><span class="p">(:,:,:,</span><span class="n">m</span><span class="p">),</span> <span class="n">svp</span><span class="p">(:,:,:,</span><span class="n">m</span><span class="p">),</span> <span class="mf">0.</span><span class="p">,</span> <span class="n">ixwall</span><span class="p">(</span><span class="n">n</span><span class="p">))</span>
<a name="ln-583"></a>            <span class="k">end do</span>
<a name="ln-584"></a><span class="k">         end do</span>
<a name="ln-585"></a><span class="k">      end if</span>
<a name="ln-586"></a><span class="k">      end if</span>
<a name="ln-587"></a>
<a name="ln-588"></a><span class="k">   end subroutine </span><span class="n">zwallfun</span>
<a name="ln-589"></a>
<a name="ln-590"></a>   <span class="k">subroutine </span><span class="n">zwallscalar</span><span class="p">(</span><span class="n">hi</span><span class="p">,</span> <span class="n">hj</span><span class="p">,</span> <span class="n">hk</span><span class="p">,</span> <span class="n">putin</span><span class="p">,</span> <span class="n">putout</span><span class="p">,</span> <span class="n">bcvalue</span><span class="p">,</span> <span class="n">n</span><span class="p">)</span>
<a name="ln-591"></a>      <span class="k">use </span><span class="n">modglobal</span><span class="p">,</span> <span class="n">only</span><span class="p">:</span><span class="n">jmax</span><span class="p">,</span> <span class="n">dzf</span><span class="p">,</span> <span class="n">dzfi</span><span class="p">,</span> <span class="n">dzhi</span><span class="p">,</span> <span class="n">dzh2i</span><span class="p">,</span> <span class="n">ib</span><span class="p">,</span> <span class="n">ie</span><span class="p">,</span> <span class="n">jb</span><span class="p">,</span> <span class="n">je</span><span class="p">,</span> <span class="n">kb</span><span class="p">,</span> <span class="n">ke</span><span class="p">,</span> <span class="n">prandtlmoli</span><span class="p">,</span> <span class="n">numol</span>
<a name="ln-592"></a>      <span class="k">use </span><span class="n">modsubgriddata</span><span class="p">,</span> <span class="n">only</span><span class="p">:</span><span class="n">ekh</span>
<a name="ln-593"></a>      <span class="k">use </span><span class="n">modmpi</span><span class="p">,</span> <span class="n">only</span><span class="p">:</span><span class="n">myid</span>
<a name="ln-594"></a>      <span class="k">use </span><span class="n">initfac</span><span class="p">,</span> <span class="n">only</span><span class="p">:</span><span class="k">block</span>
<a name="ln-595"></a><span class="k">      </span><span class="kt">integer </span><span class="n">i</span><span class="p">,</span> <span class="n">j</span><span class="p">,</span> <span class="n">k</span><span class="p">,</span> <span class="n">il</span><span class="p">,</span> <span class="n">iu</span><span class="p">,</span> <span class="n">jl</span><span class="p">,</span> <span class="n">ju</span><span class="p">,</span> <span class="n">km</span>
<a name="ln-596"></a>      <span class="kt">integer</span><span class="p">,</span> <span class="k">intent</span><span class="p">(</span><span class="n">in</span><span class="p">)</span> <span class="kd">::</span> <span class="n">hi</span> <span class="c">!&lt;size of halo in i</span>
<a name="ln-597"></a>      <span class="kt">integer</span><span class="p">,</span> <span class="k">intent</span><span class="p">(</span><span class="n">in</span><span class="p">)</span> <span class="kd">::</span> <span class="n">hj</span> <span class="c">!&lt;size of halo in j</span>
<a name="ln-598"></a>      <span class="kt">integer</span><span class="p">,</span> <span class="k">intent</span><span class="p">(</span><span class="n">in</span><span class="p">)</span> <span class="kd">::</span> <span class="n">hk</span> <span class="c">!&lt;size of halo in k</span>
<a name="ln-599"></a>      <span class="kt">real</span><span class="p">,</span> <span class="k">intent</span><span class="p">(</span><span class="n">in</span><span class="p">)</span>    <span class="kd">::</span> <span class="n">putin</span><span class="p">(</span><span class="n">ib</span> <span class="o">-</span> <span class="n">hi</span><span class="p">:</span><span class="n">ie</span> <span class="o">+</span> <span class="n">hi</span><span class="p">,</span> <span class="n">jb</span> <span class="o">-</span> <span class="n">hj</span><span class="p">:</span><span class="n">je</span> <span class="o">+</span> <span class="n">hj</span><span class="p">,</span> <span class="n">kb</span> <span class="o">-</span> <span class="n">hk</span><span class="p">:</span><span class="n">ke</span> <span class="o">+</span> <span class="n">hk</span><span class="p">)</span>
<a name="ln-600"></a>      <span class="kt">real</span><span class="p">,</span> <span class="k">intent</span><span class="p">(</span><span class="n">inout</span><span class="p">)</span> <span class="kd">::</span> <span class="n">putout</span><span class="p">(</span><span class="n">ib</span> <span class="o">-</span> <span class="n">hi</span><span class="p">:</span><span class="n">ie</span> <span class="o">+</span> <span class="n">hi</span><span class="p">,</span> <span class="n">jb</span> <span class="o">-</span> <span class="n">hj</span><span class="p">:</span><span class="n">je</span> <span class="o">+</span> <span class="n">hj</span><span class="p">,</span> <span class="n">kb</span><span class="p">:</span><span class="n">ke</span> <span class="o">+</span> <span class="n">hk</span><span class="p">)</span>
<a name="ln-601"></a>      <span class="kt">real</span><span class="p">,</span> <span class="k">intent</span><span class="p">(</span><span class="n">in</span><span class="p">)</span>    <span class="kd">::</span> <span class="n">bcvalue</span>
<a name="ln-602"></a>      <span class="kt">integer</span><span class="p">,</span> <span class="k">intent</span><span class="p">(</span><span class="n">in</span><span class="p">)</span>    <span class="kd">::</span> <span class="n">n</span>
<a name="ln-603"></a>
<a name="ln-604"></a>      <span class="n">k</span> <span class="o">=</span> <span class="k">block</span><span class="p">(</span><span class="n">n</span><span class="p">,</span> <span class="mi">6</span><span class="p">)</span> <span class="o">+</span> <span class="mi">1</span> <span class="c">!block location</span>
<a name="ln-605"></a>      <span class="n">km</span> <span class="o">=</span> <span class="n">k</span> <span class="o">-</span> <span class="mi">1</span> <span class="c">!</span>
<a name="ln-606"></a>      <span class="n">il</span> <span class="o">=</span> <span class="k">block</span><span class="p">(</span><span class="n">n</span><span class="p">,</span> <span class="mi">1</span><span class="p">)</span>
<a name="ln-607"></a>      <span class="n">iu</span> <span class="o">=</span> <span class="k">block</span><span class="p">(</span><span class="n">n</span><span class="p">,</span> <span class="mi">2</span><span class="p">)</span>
<a name="ln-608"></a>      <span class="n">jl</span> <span class="o">=</span> <span class="nb">MAX</span><span class="p">(</span><span class="k">block</span><span class="p">(</span><span class="n">n</span><span class="p">,</span> <span class="mi">3</span><span class="p">)</span> <span class="o">-</span> <span class="n">myid</span><span class="o">*</span><span class="n">jmax</span><span class="p">,</span> <span class="mi">1</span><span class="p">)</span>
<a name="ln-609"></a>      <span class="n">ju</span> <span class="o">=</span> <span class="nb">MIN</span><span class="p">(</span><span class="k">block</span><span class="p">(</span><span class="n">n</span><span class="p">,</span> <span class="mi">4</span><span class="p">)</span> <span class="o">-</span> <span class="n">myid</span><span class="o">*</span><span class="n">jmax</span><span class="p">,</span> <span class="n">jmax</span><span class="p">)</span>
<a name="ln-610"></a>
<a name="ln-611"></a>      <span class="c">!  delta=putout(3,1,2)</span>
<a name="ln-612"></a>      <span class="k">do </span><span class="n">j</span> <span class="o">=</span> <span class="n">jl</span><span class="p">,</span> <span class="n">ju</span>
<a name="ln-613"></a>         <span class="k">do </span><span class="n">i</span> <span class="o">=</span> <span class="n">il</span><span class="p">,</span> <span class="n">iu</span>
<a name="ln-614"></a>            <span class="n">putout</span><span class="p">(</span><span class="n">i</span><span class="p">,</span> <span class="n">j</span><span class="p">,</span> <span class="n">k</span><span class="p">)</span> <span class="o">=</span> <span class="n">putout</span><span class="p">(</span><span class="n">i</span><span class="p">,</span> <span class="n">j</span><span class="p">,</span> <span class="n">k</span><span class="p">)</span> <span class="o">+</span> <span class="p">(</span> <span class="p">&amp;</span>
<a name="ln-615"></a>                              <span class="mf">0.5</span><span class="o">*</span><span class="p">(</span><span class="n">dzf</span><span class="p">(</span><span class="n">km</span><span class="p">)</span><span class="o">*</span><span class="n">ekh</span><span class="p">(</span><span class="n">i</span><span class="p">,</span> <span class="n">j</span><span class="p">,</span> <span class="n">k</span><span class="p">)</span> <span class="o">+</span> <span class="n">dzf</span><span class="p">(</span><span class="n">k</span><span class="p">)</span><span class="o">*</span><span class="n">ekh</span><span class="p">(</span><span class="n">i</span><span class="p">,</span> <span class="n">j</span><span class="p">,</span> <span class="n">km</span><span class="p">))</span><span class="o">*</span> <span class="p">&amp;</span> <span class="c">! zero flux</span>
<a name="ln-616"></a>                              <span class="p">(</span><span class="n">putin</span><span class="p">(</span><span class="n">i</span><span class="p">,</span> <span class="n">j</span><span class="p">,</span> <span class="n">k</span><span class="p">)</span> <span class="o">-</span> <span class="n">putin</span><span class="p">(</span><span class="n">i</span><span class="p">,</span> <span class="n">j</span><span class="p">,</span> <span class="n">km</span><span class="p">))</span><span class="o">*</span><span class="n">dzh2i</span><span class="p">(</span><span class="n">k</span><span class="p">)</span> <span class="o">-</span> <span class="p">&amp;</span>
<a name="ln-617"></a>                              <span class="n">bcvalue</span><span class="p">)</span><span class="o">*</span><span class="n">dzfi</span><span class="p">(</span><span class="n">k</span><span class="p">)</span>
<a name="ln-618"></a>         <span class="k">end do</span>
<a name="ln-619"></a><span class="k">      end do</span>
<a name="ln-620"></a><span class="k">   end subroutine </span><span class="n">zwallscalar</span>
<a name="ln-621"></a>
<a name="ln-622"></a>   <span class="k">subroutine </span><span class="n">ibmnorm</span>
<a name="ln-623"></a>      <span class="k">use </span><span class="n">modglobal</span><span class="p">,</span> <span class="n">only</span><span class="p">:</span><span class="n">ib</span><span class="p">,</span> <span class="n">ie</span><span class="p">,</span> <span class="n">ih</span><span class="p">,</span> <span class="n">jb</span><span class="p">,</span> <span class="n">je</span><span class="p">,</span> <span class="n">jh</span><span class="p">,</span> <span class="n">kb</span><span class="p">,</span> <span class="n">ke</span><span class="p">,</span> <span class="n">kh</span><span class="p">,</span> <span class="n">rk3step</span><span class="p">,</span> <span class="n">dt</span><span class="p">,</span> <span class="n">libm</span><span class="p">,</span> <span class="n">jmax</span><span class="p">,</span> <span class="p">&amp;</span>
<a name="ln-624"></a>         <span class="n">nblocks</span><span class="p">,</span> <span class="n">nsv</span><span class="p">,</span> <span class="n">ltempeq</span><span class="p">,</span> <span class="n">lmoist</span><span class="p">,</span> <span class="n">rk3step</span><span class="p">,</span> <span class="n">ih</span><span class="p">,</span> <span class="n">kh</span><span class="p">,</span> <span class="n">dt</span><span class="p">,</span> <span class="n">totavtime</span><span class="p">,</span> <span class="p">&amp;</span>
<a name="ln-625"></a>         <span class="n">dxh</span><span class="p">,</span> <span class="n">dzf</span><span class="p">,</span> <span class="n">dy</span><span class="p">,</span> <span class="n">ih</span><span class="p">,</span> <span class="n">kh</span><span class="p">,</span> <span class="n">jh</span><span class="p">,</span> <span class="n">jge</span>
<a name="ln-626"></a>      <span class="k">use </span><span class="n">modfields</span><span class="p">,</span> <span class="n">only</span><span class="p">:</span><span class="n">up</span><span class="p">,</span> <span class="n">vp</span><span class="p">,</span> <span class="n">wp</span><span class="p">,</span> <span class="n">um</span><span class="p">,</span> <span class="n">vm</span><span class="p">,</span> <span class="n">wm</span><span class="p">,</span> <span class="n">u0</span><span class="p">,</span> <span class="n">v0</span><span class="p">,</span> <span class="n">w0</span><span class="p">,</span> <span class="n">thl0</span><span class="p">,</span> <span class="n">thlm</span><span class="p">,</span> <span class="n">svp</span><span class="p">,</span> <span class="n">svm</span><span class="p">,</span> <span class="n">thlp</span><span class="p">,</span> <span class="n">qtp</span><span class="p">,</span> <span class="n">qt0</span><span class="p">,</span> <span class="n">qtm</span>
<a name="ln-627"></a>      <span class="k">use </span><span class="n">modmpi</span><span class="p">,</span> <span class="n">only</span><span class="p">:</span><span class="n">myid</span><span class="p">,</span> <span class="n">nprocs</span>
<a name="ln-628"></a>      <span class="k">use </span><span class="n">initfac</span><span class="p">,</span> <span class="n">only</span><span class="p">:</span><span class="k">block</span>
<a name="ln-629"></a><span class="k">      </span><span class="kt">real</span><span class="p">,</span> <span class="k">dimension</span><span class="p">(</span><span class="n">ib</span> <span class="o">-</span> <span class="n">ih</span><span class="p">:</span><span class="n">ie</span> <span class="o">+</span> <span class="n">ih</span><span class="p">,</span> <span class="n">kb</span> <span class="o">-</span> <span class="n">kh</span><span class="p">:</span><span class="n">ke</span> <span class="o">+</span> <span class="n">kh</span><span class="p">)</span>          <span class="kd">::</span>  <span class="n">dummy</span>
<a name="ln-630"></a>      <span class="kt">real </span><span class="n">rk3coef</span><span class="p">,</span> <span class="n">rk3coefi</span><span class="p">,</span> <span class="n">timecomplibm</span><span class="p">,</span> <span class="n">timecomplibmplusdti</span>
<a name="ln-631"></a>      <span class="kt">integer </span><span class="n">n</span><span class="p">,</span> <span class="n">i</span><span class="p">,</span> <span class="n">j</span><span class="p">,</span> <span class="n">k</span><span class="p">,</span> <span class="n">il</span><span class="p">,</span> <span class="n">iu</span><span class="p">,</span> <span class="n">jl</span><span class="p">,</span> <span class="n">ju</span><span class="p">,</span> <span class="n">kl</span><span class="p">,</span> <span class="n">ku</span><span class="p">,</span> <span class="n">sc</span>
<a name="ln-632"></a>
<a name="ln-633"></a>      <span class="k">if</span> <span class="p">(</span><span class="n">libm</span><span class="p">)</span> <span class="k">then</span>
<a name="ln-634"></a><span class="k">         </span><span class="n">rk3coef</span> <span class="o">=</span> <span class="n">dt</span><span class="o">/</span><span class="p">(</span><span class="mf">4.</span><span class="o">-</span><span class="nb">dble</span><span class="p">(</span><span class="n">rk3step</span><span class="p">))</span>
<a name="ln-635"></a>         <span class="n">rk3coefi</span> <span class="o">=</span> <span class="mf">1.</span><span class="o">/</span><span class="n">rk3coef</span>
<a name="ln-636"></a>
<a name="ln-637"></a>         <span class="k">do </span><span class="n">n</span> <span class="o">=</span> <span class="mi">1</span><span class="p">,</span> <span class="n">nxwall</span>
<a name="ln-638"></a>
<a name="ln-639"></a>            <span class="n">il</span> <span class="o">=</span> <span class="k">block</span><span class="p">(</span><span class="n">ixwall</span><span class="p">(</span><span class="n">n</span><span class="p">),</span> <span class="mi">1</span><span class="p">)</span>
<a name="ln-640"></a>            <span class="n">iu</span> <span class="o">=</span> <span class="k">block</span><span class="p">(</span><span class="n">ixwall</span><span class="p">(</span><span class="n">n</span><span class="p">),</span> <span class="mi">2</span><span class="p">)</span> <span class="o">+</span> <span class="mi">1</span>
<a name="ln-641"></a>
<a name="ln-642"></a>            <span class="n">jl</span> <span class="o">=</span> <span class="nb">max</span><span class="p">(</span><span class="k">block</span><span class="p">(</span><span class="n">ixwall</span><span class="p">(</span><span class="n">n</span><span class="p">),</span> <span class="mi">3</span><span class="p">)</span> <span class="o">-</span> <span class="n">myid</span><span class="o">*</span><span class="n">jmax</span><span class="p">,</span> <span class="mi">1</span><span class="p">)</span> <span class="c">!</span>
<a name="ln-643"></a>            <span class="n">ju</span> <span class="o">=</span> <span class="nb">min</span><span class="p">(</span><span class="k">block</span><span class="p">(</span><span class="n">ixwall</span><span class="p">(</span><span class="n">n</span><span class="p">),</span> <span class="mi">4</span><span class="p">)</span> <span class="o">-</span> <span class="n">myid</span><span class="o">*</span><span class="n">jmax</span><span class="p">,</span> <span class="n">jmax</span><span class="p">)</span> <span class="c">!</span>
<a name="ln-644"></a>
<a name="ln-645"></a>            <span class="c">!kl = block(ixwall(n), 5)</span>
<a name="ln-646"></a>            <span class="n">kl</span> <span class="o">=</span> <span class="n">kb</span> 
<a name="ln-647"></a>            <span class="c">! tg3315 18.03.19 - use kb because for lEB buildings block starts at kb+1 but this leaves area underneath the buildings and horizontally between the roads where we have no block. Only leads to small velocities in these areas but this negates this issue. WARNING - for modelling overhangs this should be changed but this would also require another facade type etc. Similarly applied to y and z directions below.</span>
<a name="ln-648"></a>            <span class="n">ku</span> <span class="o">=</span> <span class="k">block</span><span class="p">(</span><span class="n">ixwall</span><span class="p">(</span><span class="n">n</span><span class="p">),</span> <span class="mi">6</span><span class="p">)</span>
<a name="ln-649"></a>
<a name="ln-650"></a>            <span class="c">!up(il:iu, jl:ju, kl:ku) = -um(il:iu, jl:ju, kl:ku)*rk3coefi</span>
<a name="ln-651"></a>            <span class="n">up</span><span class="p">(</span><span class="n">iu</span><span class="p">,</span> <span class="n">jl</span><span class="p">:</span><span class="n">ju</span><span class="p">,</span> <span class="n">kl</span><span class="p">:</span><span class="n">ku</span><span class="p">)</span> <span class="o">=</span> <span class="o">-</span><span class="n">um</span><span class="p">(</span><span class="n">iu</span><span class="p">,</span> <span class="n">jl</span><span class="p">:</span><span class="n">ju</span><span class="p">,</span> <span class="n">kl</span><span class="p">:</span><span class="n">ku</span><span class="p">)</span><span class="o">*</span><span class="n">rk3coefi</span>
<a name="ln-652"></a>            <span class="n">up</span><span class="p">(</span><span class="n">il</span><span class="p">,</span> <span class="n">jl</span><span class="p">:</span><span class="n">ju</span><span class="p">,</span> <span class="n">kl</span><span class="p">:</span><span class="n">ku</span><span class="p">)</span> <span class="o">=</span> <span class="o">-</span><span class="n">um</span><span class="p">(</span><span class="n">il</span><span class="p">,</span> <span class="n">jl</span><span class="p">:</span><span class="n">ju</span><span class="p">,</span> <span class="n">kl</span><span class="p">:</span><span class="n">ku</span><span class="p">)</span><span class="o">*</span><span class="n">rk3coefi</span>
<a name="ln-653"></a>
<a name="ln-654"></a>            <span class="n">up</span><span class="p">(</span><span class="n">il</span> <span class="o">+</span> <span class="mi">1</span><span class="p">:</span><span class="n">iu</span> <span class="o">-</span> <span class="mi">1</span><span class="p">,</span> <span class="n">jl</span><span class="p">:</span><span class="n">ju</span><span class="p">,</span> <span class="n">kl</span><span class="p">:</span><span class="n">ku</span><span class="p">)</span> <span class="o">=</span> <span class="mf">0.</span> <span class="c">!internal velocity don&#39;t change or</span>
<a name="ln-655"></a>            <span class="n">um</span><span class="p">(</span><span class="n">il</span> <span class="o">+</span> <span class="mi">1</span><span class="p">:</span><span class="n">iu</span> <span class="o">-</span> <span class="mi">1</span><span class="p">,</span> <span class="n">jl</span><span class="p">:</span><span class="n">ju</span><span class="p">,</span> <span class="n">kl</span><span class="p">:</span><span class="n">ku</span><span class="p">)</span> <span class="o">=</span> <span class="mf">0.</span> <span class="c">!internal velocity = 0    or both?</span>
<a name="ln-656"></a>
<a name="ln-657"></a>         <span class="k">end do</span> <span class="c">! 1,nxwallsnorm</span>
<a name="ln-658"></a>
<a name="ln-659"></a>         <span class="k">do </span><span class="n">n</span> <span class="o">=</span> <span class="mi">1</span><span class="p">,</span> <span class="n">nyminwall</span>
<a name="ln-660"></a>
<a name="ln-661"></a>            <span class="k">if</span> <span class="p">((</span><span class="n">myid</span> <span class="o">==</span> <span class="n">nprocs</span><span class="o">-</span><span class="mi">1</span> <span class="p">.</span><span class="nb">and</span><span class="p">.</span> <span class="k">block</span><span class="p">(</span><span class="n">iyminwall</span><span class="p">(</span><span class="n">n</span><span class="p">,</span> <span class="mi">1</span><span class="p">),</span> <span class="mi">3</span><span class="p">)</span> <span class="o">==</span> <span class="mi">1</span><span class="p">))</span> <span class="k">then </span>
<a name="ln-662"></a><span class="k">              </span><span class="n">jl</span> <span class="o">=</span> <span class="n">jmax</span><span class="o">+</span><span class="mi">1</span>
<a name="ln-663"></a>              <span class="n">ju</span> <span class="o">=</span> <span class="n">jmax</span><span class="o">+</span><span class="mi">1</span>
<a name="ln-664"></a>            <span class="k">else</span>
<a name="ln-665"></a><span class="k">              </span><span class="n">jl</span> <span class="o">=</span> <span class="nb">max</span><span class="p">(</span><span class="k">block</span><span class="p">(</span><span class="n">iyminwall</span><span class="p">(</span><span class="n">n</span><span class="p">,</span> <span class="mi">1</span><span class="p">),</span> <span class="mi">3</span><span class="p">)</span> <span class="o">-</span> <span class="n">myid</span><span class="o">*</span><span class="n">jmax</span><span class="p">,</span> <span class="mi">1</span><span class="p">)</span>
<a name="ln-666"></a>              <span class="n">ju</span> <span class="o">=</span> <span class="nb">min</span><span class="p">(</span><span class="k">block</span><span class="p">(</span><span class="n">iyminwall</span><span class="p">(</span><span class="n">n</span><span class="p">,</span> <span class="mi">1</span><span class="p">),</span> <span class="mi">4</span><span class="p">)</span> <span class="o">-</span> <span class="n">myid</span><span class="o">*</span><span class="n">jmax</span><span class="p">,</span> <span class="n">jmax</span><span class="p">)</span> <span class="o">+</span> <span class="mi">1</span>  
<a name="ln-667"></a>            <span class="k">end if</span>
<a name="ln-668"></a>
<a name="ln-669"></a><span class="k">            </span><span class="n">il</span> <span class="o">=</span> <span class="k">block</span><span class="p">(</span><span class="n">iyminwall</span><span class="p">(</span><span class="n">n</span><span class="p">,</span> <span class="mi">1</span><span class="p">),</span> <span class="mi">1</span><span class="p">)</span>
<a name="ln-670"></a>            <span class="n">iu</span> <span class="o">=</span> <span class="k">block</span><span class="p">(</span><span class="n">iyminwall</span><span class="p">(</span><span class="n">n</span><span class="p">,</span> <span class="mi">1</span><span class="p">),</span> <span class="mi">2</span><span class="p">)</span>
<a name="ln-671"></a>            <span class="c">!kl = block(iyminwall(n, 1), 5)</span>
<a name="ln-672"></a>            <span class="n">kl</span> <span class="o">=</span> <span class="n">kb</span> <span class="c">! tg3315 see comment for x-direction above</span>
<a name="ln-673"></a>            <span class="n">ku</span> <span class="o">=</span> <span class="k">block</span><span class="p">(</span><span class="n">iyminwall</span><span class="p">(</span><span class="n">n</span><span class="p">,</span> <span class="mi">1</span><span class="p">),</span> <span class="mi">6</span><span class="p">)</span>
<a name="ln-674"></a>
<a name="ln-675"></a>            <span class="c">! write(*,*) &#39;jl, ju, jmax, iyminwall(n,1)&#39;, jl, ju, jmax, iyminwall(n,1)</span>
<a name="ln-676"></a>
<a name="ln-677"></a>            <span class="c">! vp(il:iu, jl:ju, kl:ku) = -vm(il:iu, jl:ju, kl:ku)*rk3coefi</span>
<a name="ln-678"></a>            <span class="n">vp</span><span class="p">(</span><span class="n">il</span><span class="p">:</span><span class="n">iu</span><span class="p">,</span> <span class="n">jl</span><span class="p">,</span> <span class="n">kl</span><span class="p">:</span><span class="n">ku</span><span class="p">)</span> <span class="o">=</span> <span class="o">-</span><span class="n">vm</span><span class="p">(</span><span class="n">il</span><span class="p">:</span><span class="n">iu</span><span class="p">,</span> <span class="n">jl</span><span class="p">,</span> <span class="n">kl</span><span class="p">:</span><span class="n">ku</span><span class="p">)</span><span class="o">*</span><span class="n">rk3coefi</span>
<a name="ln-679"></a>            <span class="n">vp</span><span class="p">(</span><span class="n">il</span><span class="p">:</span><span class="n">iu</span><span class="p">,</span> <span class="n">ju</span><span class="p">,</span> <span class="n">kl</span><span class="p">:</span><span class="n">ku</span><span class="p">)</span> <span class="o">=</span> <span class="o">-</span><span class="n">vm</span><span class="p">(</span><span class="n">il</span><span class="p">:</span><span class="n">iu</span><span class="p">,</span> <span class="n">ju</span><span class="p">,</span> <span class="n">kl</span><span class="p">:</span><span class="n">ku</span><span class="p">)</span><span class="o">*</span><span class="n">rk3coefi</span>
<a name="ln-680"></a>
<a name="ln-681"></a>            <span class="n">vp</span><span class="p">(</span><span class="n">il</span><span class="p">:</span><span class="n">iu</span><span class="p">,</span> <span class="n">jl</span> <span class="o">+</span> <span class="mi">1</span><span class="p">:</span><span class="n">ju</span> <span class="o">-</span> <span class="mi">1</span><span class="p">,</span> <span class="n">kl</span><span class="p">:</span><span class="n">ku</span><span class="p">)</span> <span class="o">=</span> <span class="mf">0.0</span>
<a name="ln-682"></a>            <span class="n">vm</span><span class="p">(</span><span class="n">il</span><span class="p">:</span><span class="n">iu</span><span class="p">,</span> <span class="n">jl</span> <span class="o">+</span> <span class="mi">1</span><span class="p">:</span><span class="n">ju</span> <span class="o">-</span> <span class="mi">1</span><span class="p">,</span> <span class="n">kl</span><span class="p">:</span><span class="n">ku</span><span class="p">)</span> <span class="o">=</span> <span class="mf">0.0</span>
<a name="ln-683"></a>         <span class="k">end do</span>  <span class="c">!1,nyminwall</span>
<a name="ln-684"></a>
<a name="ln-685"></a>         <span class="k">do </span><span class="n">n</span> <span class="o">=</span> <span class="mi">1</span><span class="p">,</span> <span class="n">nypluswall</span>
<a name="ln-686"></a>
<a name="ln-687"></a>            <span class="k">if</span> <span class="p">(</span><span class="n">myid</span> <span class="o">==</span> <span class="mi">0</span> <span class="p">.</span><span class="nb">and</span><span class="p">.</span> <span class="k">block</span><span class="p">(</span><span class="n">iypluswall</span><span class="p">(</span><span class="n">n</span><span class="p">,</span> <span class="mi">1</span><span class="p">),</span> <span class="mi">4</span><span class="p">)</span> <span class="o">==</span> <span class="n">jge</span><span class="p">)</span> <span class="k">then</span>
<a name="ln-688"></a><span class="k">              </span><span class="n">jl</span> <span class="o">=</span> <span class="mi">1</span>
<a name="ln-689"></a>              <span class="n">ju</span> <span class="o">=</span> <span class="mi">1</span>
<a name="ln-690"></a>            <span class="k">else</span>
<a name="ln-691"></a><span class="k">              </span><span class="n">jl</span> <span class="o">=</span> <span class="nb">max</span><span class="p">(</span><span class="k">block</span><span class="p">(</span><span class="n">iypluswall</span><span class="p">(</span><span class="n">n</span><span class="p">,</span> <span class="mi">1</span><span class="p">),</span> <span class="mi">3</span><span class="p">)</span> <span class="o">-</span> <span class="n">myid</span><span class="o">*</span><span class="n">jmax</span><span class="p">,</span> <span class="mi">1</span><span class="p">)</span> <span class="c">! should this not be able to be zero?</span>
<a name="ln-692"></a>              <span class="n">ju</span> <span class="o">=</span> <span class="nb">min</span><span class="p">(</span><span class="k">block</span><span class="p">(</span><span class="n">iypluswall</span><span class="p">(</span><span class="n">n</span><span class="p">,</span> <span class="mi">1</span><span class="p">),</span> <span class="mi">4</span><span class="p">)</span> <span class="o">-</span> <span class="n">myid</span><span class="o">*</span><span class="n">jmax</span><span class="p">,</span> <span class="n">jmax</span><span class="p">)</span> <span class="o">+</span> <span class="mi">1</span> 
<a name="ln-693"></a>            <span class="k">end if</span>
<a name="ln-694"></a>
<a name="ln-695"></a><span class="k">            </span><span class="n">il</span> <span class="o">=</span> <span class="k">block</span><span class="p">(</span><span class="n">iypluswall</span><span class="p">(</span><span class="n">n</span><span class="p">,</span> <span class="mi">1</span><span class="p">),</span> <span class="mi">1</span><span class="p">)</span>
<a name="ln-696"></a>            <span class="n">iu</span> <span class="o">=</span> <span class="k">block</span><span class="p">(</span><span class="n">iypluswall</span><span class="p">(</span><span class="n">n</span><span class="p">,</span> <span class="mi">1</span><span class="p">),</span> <span class="mi">2</span><span class="p">)</span>
<a name="ln-697"></a>            <span class="c">!kl = block(iypluswall(n, 1), 5)</span>
<a name="ln-698"></a>            <span class="n">kl</span> <span class="o">=</span> <span class="n">kb</span> <span class="c">! tg3315 see comment for x-direction above</span>
<a name="ln-699"></a>            <span class="n">ku</span> <span class="o">=</span> <span class="k">block</span><span class="p">(</span><span class="n">iypluswall</span><span class="p">(</span><span class="n">n</span><span class="p">,</span> <span class="mi">1</span><span class="p">),</span> <span class="mi">6</span><span class="p">)</span>
<a name="ln-700"></a>
<a name="ln-701"></a>            <span class="c">!write(*,*) &#39;jl, ju, jmax, iypluswall(n,1)&#39;, jl, ju, jmax, iypluswall(n,1)</span>
<a name="ln-702"></a>
<a name="ln-703"></a>            <span class="c">!vp(il:iu, jl:ju, kl:ku) = -vm(il:iu, jl:ju, kl:ku)*rk3coefi</span>
<a name="ln-704"></a>            <span class="n">vp</span><span class="p">(</span><span class="n">il</span><span class="p">:</span><span class="n">iu</span><span class="p">,</span> <span class="n">jl</span><span class="p">,</span> <span class="n">kl</span><span class="p">:</span><span class="n">ku</span><span class="p">)</span> <span class="o">=</span> <span class="o">-</span><span class="n">vm</span><span class="p">(</span><span class="n">il</span><span class="p">:</span><span class="n">iu</span><span class="p">,</span> <span class="n">jl</span><span class="p">,</span> <span class="n">kl</span><span class="p">:</span><span class="n">ku</span><span class="p">)</span><span class="o">*</span><span class="n">rk3coefi</span>
<a name="ln-705"></a>            <span class="n">vp</span><span class="p">(</span><span class="n">il</span><span class="p">:</span><span class="n">iu</span><span class="p">,</span> <span class="n">ju</span><span class="p">,</span> <span class="n">kl</span><span class="p">:</span><span class="n">ku</span><span class="p">)</span> <span class="o">=</span> <span class="o">-</span><span class="n">vm</span><span class="p">(</span><span class="n">il</span><span class="p">:</span><span class="n">iu</span><span class="p">,</span> <span class="n">ju</span><span class="p">,</span> <span class="n">kl</span><span class="p">:</span><span class="n">ku</span><span class="p">)</span><span class="o">*</span><span class="n">rk3coefi</span>
<a name="ln-706"></a>
<a name="ln-707"></a>            <span class="n">vp</span><span class="p">(</span><span class="n">il</span><span class="p">:</span><span class="n">iu</span><span class="p">,</span> <span class="n">jl</span> <span class="o">+</span> <span class="mi">1</span><span class="p">:</span><span class="n">ju</span> <span class="o">-</span> <span class="mi">1</span><span class="p">,</span> <span class="n">kl</span><span class="p">:</span><span class="n">ku</span><span class="p">)</span> <span class="o">=</span> <span class="mf">0.0</span>
<a name="ln-708"></a>            <span class="n">vm</span><span class="p">(</span><span class="n">il</span><span class="p">:</span><span class="n">iu</span><span class="p">,</span> <span class="n">jl</span> <span class="o">+</span> <span class="mi">1</span><span class="p">:</span><span class="n">ju</span> <span class="o">-</span> <span class="mi">1</span><span class="p">,</span> <span class="n">kl</span><span class="p">:</span><span class="n">ku</span><span class="p">)</span> <span class="o">=</span> <span class="mf">0.0</span>
<a name="ln-709"></a>         <span class="k">end do</span> <span class="c">!1,nypluswall</span>
<a name="ln-710"></a>
<a name="ln-711"></a>         <span class="k">do </span><span class="n">n</span> <span class="o">=</span> <span class="mi">1</span><span class="p">,</span> <span class="n">nxwall</span>
<a name="ln-712"></a>            <span class="c">!kl = block(ixwall(n), 5)</span>
<a name="ln-713"></a>            <span class="n">kl</span> <span class="o">=</span> <span class="n">kb</span> <span class="c">! tg3315 see comment for x-direction above</span>
<a name="ln-714"></a>            <span class="n">ku</span> <span class="o">=</span> <span class="k">block</span><span class="p">(</span><span class="n">ixwall</span><span class="p">(</span><span class="n">n</span><span class="p">),</span> <span class="mi">6</span><span class="p">)</span> <span class="o">+</span> <span class="mi">1</span>
<a name="ln-715"></a>
<a name="ln-716"></a>            <span class="n">il</span> <span class="o">=</span> <span class="k">block</span><span class="p">(</span><span class="n">ixwall</span><span class="p">(</span><span class="n">n</span><span class="p">),</span> <span class="mi">1</span><span class="p">)</span>
<a name="ln-717"></a>            <span class="n">iu</span> <span class="o">=</span> <span class="k">block</span><span class="p">(</span><span class="n">ixwall</span><span class="p">(</span><span class="n">n</span><span class="p">),</span> <span class="mi">2</span><span class="p">)</span>
<a name="ln-718"></a>            <span class="n">jl</span> <span class="o">=</span> <span class="nb">max</span><span class="p">(</span><span class="k">block</span><span class="p">(</span><span class="n">ixwall</span><span class="p">(</span><span class="n">n</span><span class="p">),</span> <span class="mi">3</span><span class="p">)</span> <span class="o">-</span> <span class="n">myid</span><span class="o">*</span><span class="n">jmax</span><span class="p">,</span> <span class="mi">1</span><span class="p">)</span>
<a name="ln-719"></a>            <span class="n">ju</span> <span class="o">=</span> <span class="nb">min</span><span class="p">(</span><span class="k">block</span><span class="p">(</span><span class="n">ixwall</span><span class="p">(</span><span class="n">n</span><span class="p">),</span> <span class="mi">4</span><span class="p">)</span> <span class="o">-</span> <span class="n">myid</span><span class="o">*</span><span class="n">jmax</span><span class="p">,</span> <span class="n">jmax</span><span class="p">)</span>
<a name="ln-720"></a>
<a name="ln-721"></a>            <span class="c">!wp(il:iu, jl:ju, kl:ku) = -wm(il:iu, jl:ju, kl:ku)*rk3coefi</span>
<a name="ln-722"></a>            <span class="n">wp</span><span class="p">(</span><span class="n">il</span><span class="p">:</span><span class="n">iu</span><span class="p">,</span> <span class="n">jl</span><span class="p">:</span><span class="n">ju</span><span class="p">,</span> <span class="n">kl</span><span class="p">)</span> <span class="o">=</span> <span class="o">-</span><span class="n">wm</span><span class="p">(</span><span class="n">il</span><span class="p">:</span><span class="n">iu</span><span class="p">,</span> <span class="n">jl</span><span class="p">:</span><span class="n">ju</span><span class="p">,</span> <span class="n">kl</span><span class="p">)</span><span class="o">*</span><span class="n">rk3coefi</span>
<a name="ln-723"></a>            <span class="n">wp</span><span class="p">(</span><span class="n">il</span><span class="p">:</span><span class="n">iu</span><span class="p">,</span> <span class="n">jl</span><span class="p">:</span><span class="n">ju</span><span class="p">,</span> <span class="n">ku</span><span class="p">)</span> <span class="o">=</span> <span class="o">-</span><span class="n">wm</span><span class="p">(</span><span class="n">il</span><span class="p">:</span><span class="n">iu</span><span class="p">,</span> <span class="n">jl</span><span class="p">:</span><span class="n">ju</span><span class="p">,</span> <span class="n">ku</span><span class="p">)</span><span class="o">*</span><span class="n">rk3coefi</span>
<a name="ln-724"></a>
<a name="ln-725"></a>            <span class="n">wp</span><span class="p">(</span><span class="n">il</span><span class="p">:</span><span class="n">iu</span><span class="p">,</span> <span class="n">jl</span><span class="p">:</span><span class="n">ju</span><span class="p">,</span> <span class="n">kl</span> <span class="o">+</span> <span class="mi">1</span><span class="p">:</span><span class="n">ku</span> <span class="o">-</span> <span class="mi">1</span><span class="p">)</span> <span class="o">=</span> <span class="mf">0.</span>
<a name="ln-726"></a>            <span class="n">wm</span><span class="p">(</span><span class="n">il</span><span class="p">:</span><span class="n">iu</span><span class="p">,</span> <span class="n">jl</span><span class="p">:</span><span class="n">ju</span><span class="p">,</span> <span class="n">kl</span> <span class="o">+</span> <span class="mi">1</span><span class="p">:</span><span class="n">ku</span> <span class="o">-</span> <span class="mi">1</span><span class="p">)</span> <span class="o">=</span> <span class="mf">0.</span>
<a name="ln-727"></a>
<a name="ln-728"></a>         <span class="k">end do</span> <span class="c">!1,nxwall</span>
<a name="ln-729"></a>
<a name="ln-730"></a>         <span class="k">if</span> <span class="p">(</span><span class="n">ltempeq</span><span class="p">)</span> <span class="k">then</span>
<a name="ln-731"></a><span class="k">            do </span><span class="n">n</span> <span class="o">=</span> <span class="mi">1</span><span class="p">,</span> <span class="n">nblocks</span>
<a name="ln-732"></a>               <span class="n">il</span> <span class="o">=</span> <span class="k">block</span><span class="p">(</span><span class="n">n</span><span class="p">,</span> <span class="mi">1</span><span class="p">)</span>
<a name="ln-733"></a>               <span class="n">iu</span> <span class="o">=</span> <span class="k">block</span><span class="p">(</span><span class="n">n</span><span class="p">,</span> <span class="mi">2</span><span class="p">)</span>
<a name="ln-734"></a>               <span class="c">!kl = block(n, 5)</span>
<a name="ln-735"></a>               <span class="n">kl</span> <span class="o">=</span> <span class="n">kb</span> <span class="c">! tg3315 see comment for x-direction above</span>
<a name="ln-736"></a>               <span class="n">ku</span> <span class="o">=</span> <span class="k">block</span><span class="p">(</span><span class="n">n</span><span class="p">,</span> <span class="mi">6</span><span class="p">)</span>
<a name="ln-737"></a>               <span class="n">jl</span> <span class="o">=</span> <span class="k">block</span><span class="p">(</span><span class="n">n</span><span class="p">,</span> <span class="mi">3</span><span class="p">)</span> <span class="o">-</span> <span class="n">myid</span><span class="o">*</span><span class="n">jmax</span>
<a name="ln-738"></a>               <span class="n">ju</span> <span class="o">=</span> <span class="k">block</span><span class="p">(</span><span class="n">n</span><span class="p">,</span> <span class="mi">4</span><span class="p">)</span> <span class="o">-</span> <span class="n">myid</span><span class="o">*</span><span class="n">jmax</span>
<a name="ln-739"></a>               <span class="k">if</span> <span class="p">((</span><span class="n">ju</span> <span class="o">&lt;</span> <span class="n">jb</span><span class="p">)</span> <span class="p">.</span><span class="nb">or</span><span class="p">.</span> <span class="p">(</span><span class="n">jl</span> <span class="o">&gt;</span> <span class="n">je</span><span class="p">))</span> <span class="k">then</span>
<a name="ln-740"></a><span class="k">                  cycle</span>
<a name="ln-741"></a><span class="k">               else</span>
<a name="ln-742"></a><span class="k">                  if</span> <span class="p">(</span><span class="n">ju</span> <span class="o">&gt;</span> <span class="n">je</span><span class="p">)</span> <span class="n">ju</span> <span class="o">=</span> <span class="n">je</span>
<a name="ln-743"></a>                  <span class="k">if</span> <span class="p">(</span><span class="n">jl</span> <span class="o">&lt;</span> <span class="n">jb</span><span class="p">)</span> <span class="n">jl</span> <span class="o">=</span> <span class="n">jb</span>
<a name="ln-744"></a>                  <span class="n">thlp</span><span class="p">(</span><span class="n">il</span><span class="p">:</span><span class="n">iu</span><span class="p">,</span> <span class="n">jl</span><span class="p">:</span><span class="n">ju</span><span class="p">,</span> <span class="n">kl</span><span class="p">:</span><span class="n">ku</span><span class="p">)</span> <span class="o">=</span> <span class="mf">0.</span>
<a name="ln-745"></a>
<a name="ln-746"></a>                  <span class="c">!try setting internal T to fluid T</span>
<a name="ln-747"></a>                  <span class="n">thlm</span><span class="p">(</span><span class="n">il</span><span class="p">,</span> <span class="n">jl</span><span class="p">:</span><span class="n">ju</span><span class="p">,</span> <span class="n">kl</span><span class="p">:</span><span class="n">ku</span><span class="p">)</span> <span class="o">=</span> <span class="n">thlm</span><span class="p">(</span><span class="n">il</span> <span class="o">-</span> <span class="mi">1</span><span class="p">,</span> <span class="n">jl</span><span class="p">:</span><span class="n">ju</span><span class="p">,</span> <span class="n">kl</span><span class="p">:</span><span class="n">ku</span><span class="p">)</span>
<a name="ln-748"></a>                  <span class="n">thlm</span><span class="p">(</span><span class="n">iu</span><span class="p">,</span> <span class="n">jl</span><span class="p">:</span><span class="n">ju</span><span class="p">,</span> <span class="n">kl</span><span class="p">:</span><span class="n">ku</span><span class="p">)</span> <span class="o">=</span> <span class="n">thlm</span><span class="p">(</span><span class="n">iu</span> <span class="o">+</span> <span class="mi">1</span><span class="p">,</span> <span class="n">jl</span><span class="p">:</span><span class="n">ju</span><span class="p">,</span> <span class="n">kl</span><span class="p">:</span><span class="n">ku</span><span class="p">)</span>
<a name="ln-749"></a>                  <span class="n">thlm</span><span class="p">(</span><span class="n">il</span><span class="p">:</span><span class="n">iu</span><span class="p">,</span> <span class="n">jl</span><span class="p">,</span> <span class="n">kl</span><span class="p">:</span><span class="n">ku</span><span class="p">)</span> <span class="o">=</span> <span class="n">thlm</span><span class="p">(</span><span class="n">il</span><span class="p">:</span><span class="n">iu</span><span class="p">,</span> <span class="n">jl</span> <span class="o">-</span> <span class="mi">1</span><span class="p">,</span> <span class="n">kl</span><span class="p">:</span><span class="n">ku</span><span class="p">)</span>
<a name="ln-750"></a>                  <span class="n">thlm</span><span class="p">(</span><span class="n">il</span><span class="p">:</span><span class="n">iu</span><span class="p">,</span> <span class="n">ju</span><span class="p">,</span> <span class="n">kl</span><span class="p">:</span><span class="n">ku</span><span class="p">)</span> <span class="o">=</span> <span class="n">thlm</span><span class="p">(</span><span class="n">il</span><span class="p">:</span><span class="n">iu</span><span class="p">,</span> <span class="n">ju</span> <span class="o">+</span> <span class="mi">1</span><span class="p">,</span> <span class="n">kl</span><span class="p">:</span><span class="n">ku</span><span class="p">)</span>
<a name="ln-751"></a>                  <span class="n">thlm</span><span class="p">(</span><span class="n">il</span><span class="p">:</span><span class="n">iu</span><span class="p">,</span> <span class="n">jl</span><span class="p">:</span><span class="n">ju</span><span class="p">,</span> <span class="n">ku</span><span class="p">)</span> <span class="o">=</span> <span class="n">thlm</span><span class="p">(</span><span class="n">il</span><span class="p">:</span><span class="n">iu</span><span class="p">,</span> <span class="n">jl</span><span class="p">:</span><span class="n">ju</span><span class="p">,</span> <span class="n">ku</span> <span class="o">+</span> <span class="mi">1</span><span class="p">)</span>
<a name="ln-752"></a>               <span class="k">end if</span>
<a name="ln-753"></a><span class="k">            end do</span>
<a name="ln-754"></a><span class="k">         end if</span>
<a name="ln-755"></a>
<a name="ln-756"></a><span class="k">         if</span> <span class="p">(</span><span class="n">lmoist</span><span class="p">)</span> <span class="k">then</span>
<a name="ln-757"></a><span class="k">            do </span><span class="n">n</span> <span class="o">=</span> <span class="mi">1</span><span class="p">,</span> <span class="n">nblocks</span>
<a name="ln-758"></a>               <span class="n">il</span> <span class="o">=</span> <span class="k">block</span><span class="p">(</span><span class="n">n</span><span class="p">,</span> <span class="mi">1</span><span class="p">)</span>
<a name="ln-759"></a>               <span class="n">iu</span> <span class="o">=</span> <span class="k">block</span><span class="p">(</span><span class="n">n</span><span class="p">,</span> <span class="mi">2</span><span class="p">)</span>
<a name="ln-760"></a>               <span class="c">!kl = block(n, 5)</span>
<a name="ln-761"></a>               <span class="n">kl</span> <span class="o">=</span> <span class="n">kb</span> <span class="c">! tg3315 see comment for x-direction above</span>
<a name="ln-762"></a>               <span class="n">ku</span> <span class="o">=</span> <span class="k">block</span><span class="p">(</span><span class="n">n</span><span class="p">,</span> <span class="mi">6</span><span class="p">)</span>
<a name="ln-763"></a>               <span class="n">jl</span> <span class="o">=</span> <span class="k">block</span><span class="p">(</span><span class="n">n</span><span class="p">,</span> <span class="mi">3</span><span class="p">)</span> <span class="o">-</span> <span class="n">myid</span><span class="o">*</span><span class="n">jmax</span>
<a name="ln-764"></a>               <span class="n">ju</span> <span class="o">=</span> <span class="k">block</span><span class="p">(</span><span class="n">n</span><span class="p">,</span> <span class="mi">4</span><span class="p">)</span> <span class="o">-</span> <span class="n">myid</span><span class="o">*</span><span class="n">jmax</span>
<a name="ln-765"></a>               <span class="k">if</span> <span class="p">((</span><span class="n">ju</span> <span class="o">&lt;</span> <span class="n">jb</span><span class="p">)</span> <span class="p">.</span><span class="nb">or</span><span class="p">.</span> <span class="p">(</span><span class="n">jl</span> <span class="o">&gt;</span> <span class="n">je</span><span class="p">))</span> <span class="k">then</span>
<a name="ln-766"></a><span class="k">                  cycle</span>
<a name="ln-767"></a><span class="k">               else</span>
<a name="ln-768"></a><span class="k">                  if</span> <span class="p">(</span><span class="n">ju</span> <span class="o">&gt;</span> <span class="n">je</span><span class="p">)</span> <span class="n">ju</span> <span class="o">=</span> <span class="n">je</span>
<a name="ln-769"></a>                  <span class="k">if</span> <span class="p">(</span><span class="n">jl</span> <span class="o">&lt;</span> <span class="n">jb</span><span class="p">)</span> <span class="n">jl</span> <span class="o">=</span> <span class="n">jb</span>
<a name="ln-770"></a>                  <span class="n">qtp</span><span class="p">(</span><span class="n">il</span><span class="p">:</span><span class="n">iu</span><span class="p">,</span> <span class="n">jl</span><span class="p">:</span><span class="n">ju</span><span class="p">,</span> <span class="n">kl</span><span class="p">:</span><span class="n">ku</span><span class="p">)</span> <span class="o">=</span> <span class="mf">0.</span>
<a name="ln-771"></a>
<a name="ln-772"></a>                  <span class="n">qtm</span><span class="p">(</span><span class="n">il</span><span class="p">,</span> <span class="n">jl</span><span class="p">:</span><span class="n">ju</span><span class="p">,</span> <span class="n">kl</span><span class="p">:</span><span class="n">ku</span><span class="p">)</span> <span class="o">=</span> <span class="n">qtm</span><span class="p">(</span><span class="n">il</span> <span class="o">-</span> <span class="mi">1</span><span class="p">,</span> <span class="n">jl</span><span class="p">:</span><span class="n">ju</span><span class="p">,</span> <span class="n">kl</span><span class="p">:</span><span class="n">ku</span><span class="p">)</span>
<a name="ln-773"></a>                  <span class="n">qtm</span><span class="p">(</span><span class="n">iu</span><span class="p">,</span> <span class="n">jl</span><span class="p">:</span><span class="n">ju</span><span class="p">,</span> <span class="n">kl</span><span class="p">:</span><span class="n">ku</span><span class="p">)</span> <span class="o">=</span> <span class="n">qtm</span><span class="p">(</span><span class="n">iu</span> <span class="o">+</span> <span class="mi">1</span><span class="p">,</span> <span class="n">jl</span><span class="p">:</span><span class="n">ju</span><span class="p">,</span> <span class="n">kl</span><span class="p">:</span><span class="n">ku</span><span class="p">)</span>
<a name="ln-774"></a>                  <span class="n">qtm</span><span class="p">(</span><span class="n">il</span><span class="p">:</span><span class="n">iu</span><span class="p">,</span> <span class="n">jl</span><span class="p">,</span> <span class="n">kl</span><span class="p">:</span><span class="n">ku</span><span class="p">)</span> <span class="o">=</span> <span class="n">qtm</span><span class="p">(</span><span class="n">il</span><span class="p">:</span><span class="n">iu</span><span class="p">,</span> <span class="n">jl</span> <span class="o">-</span> <span class="mi">1</span><span class="p">,</span> <span class="n">kl</span><span class="p">:</span><span class="n">ku</span><span class="p">)</span>
<a name="ln-775"></a>                  <span class="n">qtm</span><span class="p">(</span><span class="n">il</span><span class="p">:</span><span class="n">iu</span><span class="p">,</span> <span class="n">ju</span><span class="p">,</span> <span class="n">kl</span><span class="p">:</span><span class="n">ku</span><span class="p">)</span> <span class="o">=</span> <span class="n">qtm</span><span class="p">(</span><span class="n">il</span><span class="p">:</span><span class="n">iu</span><span class="p">,</span> <span class="n">ju</span> <span class="o">+</span> <span class="mi">1</span><span class="p">,</span> <span class="n">kl</span><span class="p">:</span><span class="n">ku</span><span class="p">)</span>
<a name="ln-776"></a>                  <span class="n">qtm</span><span class="p">(</span><span class="n">il</span><span class="p">:</span><span class="n">iu</span><span class="p">,</span> <span class="n">jl</span><span class="p">:</span><span class="n">ju</span><span class="p">,</span> <span class="n">ku</span><span class="p">)</span> <span class="o">=</span> <span class="n">qtm</span><span class="p">(</span><span class="n">il</span><span class="p">:</span><span class="n">iu</span><span class="p">,</span> <span class="n">jl</span><span class="p">:</span><span class="n">ju</span><span class="p">,</span> <span class="n">ku</span> <span class="o">+</span> <span class="mi">1</span><span class="p">)</span>
<a name="ln-777"></a>
<a name="ln-778"></a>               <span class="k">end if</span>
<a name="ln-779"></a><span class="k">            end do</span>
<a name="ln-780"></a><span class="k">         end if</span>
<a name="ln-781"></a>
<a name="ln-782"></a><span class="k">         if</span> <span class="p">(</span><span class="n">nsv</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">)</span> <span class="k">then</span>
<a name="ln-783"></a><span class="k">            do </span><span class="n">n</span> <span class="o">=</span> <span class="mi">1</span><span class="p">,</span> <span class="n">nblocks</span>
<a name="ln-784"></a>               <span class="n">il</span> <span class="o">=</span> <span class="k">block</span><span class="p">(</span><span class="n">n</span><span class="p">,</span> <span class="mi">1</span><span class="p">)</span>
<a name="ln-785"></a>               <span class="n">iu</span> <span class="o">=</span> <span class="k">block</span><span class="p">(</span><span class="n">n</span><span class="p">,</span> <span class="mi">2</span><span class="p">)</span>
<a name="ln-786"></a>               <span class="c">!kl = block(n, 5)</span>
<a name="ln-787"></a>               <span class="n">kl</span> <span class="o">=</span> <span class="n">kb</span> <span class="c">! tg3315 see comment for x-direction above</span>
<a name="ln-788"></a>               <span class="n">ku</span> <span class="o">=</span> <span class="k">block</span><span class="p">(</span><span class="n">n</span><span class="p">,</span> <span class="mi">6</span><span class="p">)</span>
<a name="ln-789"></a>               <span class="n">jl</span> <span class="o">=</span> <span class="k">block</span><span class="p">(</span><span class="n">n</span><span class="p">,</span> <span class="mi">3</span><span class="p">)</span> <span class="o">-</span> <span class="n">myid</span><span class="o">*</span><span class="n">jmax</span>
<a name="ln-790"></a>               <span class="n">ju</span> <span class="o">=</span> <span class="k">block</span><span class="p">(</span><span class="n">n</span><span class="p">,</span> <span class="mi">4</span><span class="p">)</span> <span class="o">-</span> <span class="n">myid</span><span class="o">*</span><span class="n">jmax</span>
<a name="ln-791"></a>               <span class="k">if</span> <span class="p">((</span><span class="n">ju</span> <span class="o">&lt;</span> <span class="n">jb</span><span class="p">)</span> <span class="p">.</span><span class="nb">or</span><span class="p">.</span> <span class="p">(</span><span class="n">jl</span> <span class="o">&gt;</span> <span class="n">je</span><span class="p">))</span> <span class="k">then</span>
<a name="ln-792"></a><span class="k">                  cycle</span>
<a name="ln-793"></a><span class="k">               else</span>
<a name="ln-794"></a><span class="k">                  if</span> <span class="p">(</span><span class="n">ju</span> <span class="o">&gt;</span> <span class="n">je</span><span class="p">)</span> <span class="n">ju</span> <span class="o">=</span> <span class="n">je</span>
<a name="ln-795"></a>                  <span class="k">if</span> <span class="p">(</span><span class="n">jl</span> <span class="o">&lt;</span> <span class="n">jb</span><span class="p">)</span> <span class="n">jl</span> <span class="o">=</span> <span class="n">jb</span>
<a name="ln-796"></a>                  <span class="n">svp</span><span class="p">(</span><span class="n">il</span><span class="p">:</span><span class="n">iu</span><span class="p">,</span> <span class="n">jl</span><span class="p">:</span><span class="n">ju</span><span class="p">,</span> <span class="n">kl</span><span class="p">:</span><span class="n">ku</span><span class="p">,</span> <span class="p">:)</span> <span class="o">=</span> <span class="mf">0.</span>
<a name="ln-797"></a>
<a name="ln-798"></a>              <span class="n">svp</span><span class="p">(</span><span class="n">il</span><span class="p">:</span><span class="n">iu</span><span class="p">,</span><span class="n">jl</span><span class="p">:</span><span class="n">ju</span><span class="p">,</span><span class="n">kl</span><span class="p">:</span><span class="n">ku</span><span class="p">,:)</span> <span class="o">=</span> <span class="mf">0.</span>
<a name="ln-799"></a>              <span class="n">svm</span><span class="p">(</span><span class="n">il</span><span class="p">,</span> <span class="n">jl</span><span class="p">:</span><span class="n">ju</span><span class="p">,</span> <span class="n">kl</span><span class="p">:</span><span class="n">ku</span><span class="p">,</span> <span class="p">:)</span> <span class="o">=</span> <span class="n">svm</span><span class="p">(</span><span class="n">il</span> <span class="o">-</span> <span class="mi">1</span><span class="p">,</span> <span class="n">jl</span><span class="p">:</span><span class="n">ju</span><span class="p">,</span> <span class="n">kl</span><span class="p">:</span><span class="n">ku</span><span class="p">,:)</span> <span class="c">! tg3315 swapped these around with jl, ju as was getting values in buildings as blovks are split along x in real topology </span>
<a name="ln-800"></a>              <span class="n">svm</span><span class="p">(</span><span class="n">iu</span><span class="p">,</span> <span class="n">jl</span><span class="p">:</span><span class="n">ju</span><span class="p">,</span> <span class="n">kl</span><span class="p">:</span><span class="n">ku</span><span class="p">,</span> <span class="p">:)</span> <span class="o">=</span> <span class="n">svm</span><span class="p">(</span><span class="n">iu</span> <span class="o">+</span> <span class="mi">1</span><span class="p">,</span> <span class="n">jl</span><span class="p">:</span><span class="n">ju</span><span class="p">,</span> <span class="n">kl</span><span class="p">:</span><span class="n">ku</span><span class="p">,:)</span>
<a name="ln-801"></a>              <span class="n">svm</span><span class="p">(</span><span class="n">il</span><span class="p">:</span><span class="n">iu</span><span class="p">,</span> <span class="n">jl</span><span class="p">,</span> <span class="n">kl</span><span class="p">:</span><span class="n">ku</span><span class="p">,</span> <span class="p">:)</span> <span class="o">=</span> <span class="n">svm</span><span class="p">(</span><span class="n">il</span><span class="p">:</span><span class="n">iu</span><span class="p">,</span> <span class="n">jl</span> <span class="o">-</span> <span class="mi">1</span><span class="p">,</span> <span class="n">kl</span><span class="p">:</span><span class="n">ku</span><span class="p">,:)</span>
<a name="ln-802"></a>              <span class="n">svm</span><span class="p">(</span><span class="n">il</span><span class="p">:</span><span class="n">iu</span><span class="p">,</span> <span class="n">ju</span><span class="p">,</span> <span class="n">kl</span><span class="p">:</span><span class="n">ku</span><span class="p">,</span> <span class="p">:)</span> <span class="o">=</span> <span class="n">svm</span><span class="p">(</span><span class="n">il</span><span class="p">:</span><span class="n">iu</span><span class="p">,</span> <span class="n">ju</span> <span class="o">+</span> <span class="mi">1</span><span class="p">,</span> <span class="n">kl</span><span class="p">:</span><span class="n">ku</span><span class="p">,:)</span>
<a name="ln-803"></a>              <span class="n">svm</span><span class="p">(</span><span class="n">il</span><span class="p">:</span><span class="n">iu</span><span class="p">,</span> <span class="n">jl</span><span class="p">:</span><span class="n">ju</span><span class="p">,</span> <span class="n">ku</span><span class="p">,</span> <span class="p">:)</span> <span class="o">=</span> <span class="n">svm</span><span class="p">(</span><span class="n">il</span><span class="p">:</span><span class="n">iu</span><span class="p">,</span> <span class="n">jl</span><span class="p">:</span><span class="n">ju</span><span class="p">,</span> <span class="n">ku</span> <span class="o">+</span> <span class="mi">1</span><span class="p">,:)</span>
<a name="ln-804"></a>
<a name="ln-805"></a>               <span class="k">end if</span>
<a name="ln-806"></a><span class="k">            end do</span>
<a name="ln-807"></a><span class="k">         end if</span>
<a name="ln-808"></a>
<a name="ln-809"></a><span class="k">      end if</span> <span class="c">! libm</span>
<a name="ln-810"></a>
<a name="ln-811"></a>   <span class="k">end subroutine </span><span class="n">ibmnorm</span>
<a name="ln-812"></a>
<a name="ln-813"></a>   <span class="c">!&gt; Determines the distance to the nearest wall for each cell center (used in v. Driest damping function)</span>
<a name="ln-814"></a>   <span class="c">!&gt; Output is a field with minimal distance to wall for each cell center</span>
<a name="ln-815"></a>   <span class="c">!ILS13,10.07.17, not being called anymore</span>
<a name="ln-816"></a>   <span class="c">!only for smagorinsky</span>
<a name="ln-817"></a>   <span class="c">!indeces of walls are wrong (xwallsglobal etc don&#39;t exist anymore)</span>
<a name="ln-818"></a>   <span class="k">subroutine </span><span class="n">nearwall</span>
<a name="ln-819"></a>
<a name="ln-820"></a>      <span class="k">use </span><span class="n">modglobal</span><span class="p">,</span> <span class="n">only</span><span class="p">:</span><span class="n">ib</span><span class="p">,</span> <span class="n">ie</span><span class="p">,</span> <span class="n">jb</span><span class="p">,</span> <span class="n">je</span><span class="p">,</span> <span class="n">jgb</span><span class="p">,</span> <span class="n">jge</span><span class="p">,</span> <span class="n">jmax</span><span class="p">,</span> <span class="n">kb</span><span class="p">,</span> <span class="n">ke</span><span class="p">,</span> <span class="n">xh</span><span class="p">,</span> <span class="n">xf</span><span class="p">,</span> <span class="n">dy</span><span class="p">,</span> <span class="n">zh</span><span class="p">,</span> <span class="n">zf</span><span class="p">,</span> <span class="n">lwarmstart</span><span class="p">,</span> <span class="n">nblocks</span><span class="p">,</span> <span class="n">libm</span><span class="p">,</span> <span class="n">lzerogradtop</span><span class="p">,</span> <span class="n">lwalldist</span>
<a name="ln-821"></a>      <span class="k">use </span><span class="n">modsubgriddata</span><span class="p">,</span> <span class="n">only</span><span class="p">:</span><span class="n">lsmagorinsky</span><span class="p">,</span> <span class="n">loneeqn</span>
<a name="ln-822"></a>      <span class="k">use </span><span class="n">modfields</span><span class="p">,</span> <span class="n">only</span><span class="p">:</span><span class="n">mindist</span><span class="p">,</span> <span class="n">wall</span>
<a name="ln-823"></a>      <span class="k">use </span><span class="n">modibmdata</span><span class="p">,</span> <span class="n">only</span><span class="p">:</span><span class="n">xwallsglobal</span><span class="p">,</span> <span class="n">ywallsglobal</span><span class="p">,</span> <span class="n">zwallsglobal</span>
<a name="ln-824"></a>      <span class="k">use </span><span class="n">modmpi</span><span class="p">,</span> <span class="n">only</span><span class="p">:</span><span class="n">myid</span>
<a name="ln-825"></a>      <span class="k">use </span><span class="n">initfac</span><span class="p">,</span> <span class="n">only</span><span class="p">:</span><span class="k">block</span>
<a name="ln-826"></a><span class="k">      implicit none</span>
<a name="ln-827"></a>
<a name="ln-828"></a><span class="k">      </span><span class="kt">integer</span><span class="p">,</span> <span class="k">allocatable</span> <span class="kd">::</span> <span class="n">ux0all</span><span class="p">(:,</span> <span class="p">:,</span> <span class="p">:),</span> <span class="n">vy0all</span><span class="p">(:,</span> <span class="p">:,</span> <span class="p">:),</span> <span class="n">wz0all</span><span class="p">(:,</span> <span class="p">:,</span> <span class="p">:)</span>
<a name="ln-829"></a>      <span class="kt">real</span><span class="p">,</span> <span class="k">allocatable</span> <span class="kd">::</span> <span class="n">distxf</span><span class="p">(:,</span> <span class="p">:),</span> <span class="n">distxh</span><span class="p">(:,</span> <span class="p">:),</span> <span class="n">distyf</span><span class="p">(:,</span> <span class="p">:),</span> <span class="n">distyh</span><span class="p">(:,</span> <span class="p">:),</span> <span class="n">distzf</span><span class="p">(:,</span> <span class="p">:),</span> <span class="n">distzh</span><span class="p">(:,</span> <span class="p">:),</span> <span class="p">&amp;</span>
<a name="ln-830"></a>                           <span class="n">distxf2</span><span class="p">(:,</span> <span class="p">:),</span> <span class="n">distxh2</span><span class="p">(:,</span> <span class="p">:),</span> <span class="n">distyf2</span><span class="p">(:,</span> <span class="p">:),</span> <span class="n">distyh2</span><span class="p">(:,</span> <span class="p">:),</span> <span class="n">distzf2</span><span class="p">(:,</span> <span class="p">:),</span> <span class="n">distzh2</span><span class="p">(:,</span> <span class="p">:),</span> <span class="n">distance</span><span class="p">(:)</span>
<a name="ln-831"></a>      <span class="kt">real </span><span class="n">distx</span><span class="p">,</span> <span class="n">disty</span><span class="p">,</span> <span class="n">distz</span> <span class="c">! distx is the distance to nearest x-wall, etc.</span>
<a name="ln-832"></a>      <span class="c">! integer, allocatable :: optie(:)</span>
<a name="ln-833"></a>      <span class="kt">integer </span><span class="n">ic</span><span class="p">,</span> <span class="n">jc</span><span class="p">,</span> <span class="n">kc</span><span class="p">,</span> <span class="n">i</span><span class="p">,</span> <span class="n">j</span><span class="p">,</span> <span class="n">k</span><span class="p">,</span> <span class="n">optie</span><span class="p">,</span> <span class="n">il</span><span class="p">,</span> <span class="n">iu</span><span class="p">,</span> <span class="n">jl</span><span class="p">,</span> <span class="n">ju</span><span class="p">,</span> <span class="n">kl</span><span class="p">,</span> <span class="n">ku</span><span class="p">,</span> <span class="n">n</span>
<a name="ln-834"></a>
<a name="ln-835"></a>      <span class="c">! if (lwarmstart .or. lles.eqv..false. .or. lvreman) then</span>
<a name="ln-836"></a>      <span class="k">if</span> <span class="p">(((</span><span class="n">lsmagorinsky</span><span class="p">)</span> <span class="p">.</span><span class="nb">or</span><span class="p">.</span> <span class="p">(</span><span class="n">loneeqn</span><span class="p">))</span> <span class="p">.</span><span class="nb">and</span><span class="p">.</span> <span class="p">(</span><span class="n">lwalldist</span><span class="p">))</span> <span class="k">then</span>
<a name="ln-837"></a><span class="k">      if</span> <span class="p">(</span><span class="n">myid</span> <span class="o">==</span> <span class="mi">0</span><span class="p">)</span> <span class="k">then</span>
<a name="ln-838"></a><span class="k">         write</span> <span class="p">(</span><span class="mi">6</span><span class="p">,</span> <span class="o">*</span><span class="p">)</span> <span class="s1">&#39;Computing wall distances&#39;</span>
<a name="ln-839"></a>      <span class="k">end if</span>
<a name="ln-840"></a>      <span class="c">! if (lles.eqv..false. .or. lvreman) then</span>
<a name="ln-841"></a>      <span class="n">mindist</span> <span class="o">=</span> <span class="mf">1.0e10</span>
<a name="ln-842"></a>
<a name="ln-843"></a>      <span class="k">allocate</span> <span class="p">(</span><span class="n">ux0all</span><span class="p">(</span><span class="n">ib</span> <span class="o">-</span> <span class="mi">1</span><span class="p">:</span><span class="n">ie</span> <span class="o">+</span> <span class="mi">1</span><span class="p">,</span> <span class="n">jgb</span> <span class="o">-</span> <span class="mi">1</span><span class="p">:</span><span class="n">jge</span> <span class="o">+</span> <span class="mi">1</span><span class="p">,</span> <span class="n">kb</span> <span class="o">-</span> <span class="mi">1</span><span class="p">:</span><span class="n">ke</span> <span class="o">+</span> <span class="mi">1</span><span class="p">))</span> <span class="c">! This contains ux0 + the lower and (possibly) the upper wall</span>
<a name="ln-844"></a>      <span class="k">allocate</span> <span class="p">(</span><span class="n">vy0all</span><span class="p">(</span><span class="n">ib</span> <span class="o">-</span> <span class="mi">1</span><span class="p">:</span><span class="n">ie</span> <span class="o">+</span> <span class="mi">1</span><span class="p">,</span> <span class="n">jgb</span> <span class="o">-</span> <span class="mi">1</span><span class="p">:</span><span class="n">jge</span> <span class="o">+</span> <span class="mi">1</span><span class="p">,</span> <span class="n">kb</span> <span class="o">-</span> <span class="mi">1</span><span class="p">:</span><span class="n">ke</span> <span class="o">+</span> <span class="mi">1</span><span class="p">))</span> <span class="c">! This contains ux0 + the lower and (possibly) the upper wall</span>
<a name="ln-845"></a>      <span class="k">allocate</span> <span class="p">(</span><span class="n">wz0all</span><span class="p">(</span><span class="n">ib</span> <span class="o">-</span> <span class="mi">1</span><span class="p">:</span><span class="n">ie</span> <span class="o">+</span> <span class="mi">1</span><span class="p">,</span> <span class="n">jgb</span> <span class="o">-</span> <span class="mi">1</span><span class="p">:</span><span class="n">jge</span> <span class="o">+</span> <span class="mi">1</span><span class="p">,</span> <span class="n">kb</span> <span class="o">-</span> <span class="mi">1</span><span class="p">:</span><span class="n">ke</span> <span class="o">+</span> <span class="mi">1</span><span class="p">))</span> <span class="c">! This contains ux0 + the lower and (possibly) the upper wall</span>
<a name="ln-846"></a>      <span class="k">allocate</span> <span class="p">(</span><span class="n">distxh</span><span class="p">(</span><span class="n">ib</span><span class="p">:</span><span class="n">ie</span><span class="p">,</span> <span class="n">ib</span><span class="p">:</span><span class="n">ie</span> <span class="o">+</span> <span class="mi">1</span><span class="p">))</span>
<a name="ln-847"></a>      <span class="k">allocate</span> <span class="p">(</span><span class="n">distxf</span><span class="p">(</span><span class="n">ib</span><span class="p">:</span><span class="n">ie</span><span class="p">,</span> <span class="n">ib</span><span class="p">:</span><span class="n">ie</span> <span class="o">+</span> <span class="mi">1</span><span class="p">))</span>
<a name="ln-848"></a>      <span class="k">allocate</span> <span class="p">(</span><span class="n">distyh</span><span class="p">(</span><span class="n">jb</span><span class="p">:</span><span class="n">je</span><span class="p">,</span> <span class="n">jgb</span><span class="p">:</span><span class="n">jge</span> <span class="o">+</span> <span class="mi">1</span><span class="p">))</span>
<a name="ln-849"></a>      <span class="k">allocate</span> <span class="p">(</span><span class="n">distyf</span><span class="p">(</span><span class="n">jb</span><span class="p">:</span><span class="n">je</span><span class="p">,</span> <span class="n">jgb</span><span class="p">:</span><span class="n">jge</span> <span class="o">+</span> <span class="mi">1</span><span class="p">))</span>
<a name="ln-850"></a>      <span class="k">allocate</span> <span class="p">(</span><span class="n">distzh</span><span class="p">(</span><span class="n">kb</span><span class="p">:</span><span class="n">ke</span><span class="p">,</span> <span class="n">kb</span><span class="p">:</span><span class="n">ke</span> <span class="o">+</span> <span class="mi">1</span><span class="p">))</span>
<a name="ln-851"></a>      <span class="k">allocate</span> <span class="p">(</span><span class="n">distzf</span><span class="p">(</span><span class="n">kb</span><span class="p">:</span><span class="n">ke</span><span class="p">,</span> <span class="n">kb</span><span class="p">:</span><span class="n">ke</span> <span class="o">+</span> <span class="mi">1</span><span class="p">))</span>
<a name="ln-852"></a>      <span class="k">allocate</span> <span class="p">(</span><span class="n">distxh2</span><span class="p">(</span><span class="n">ib</span><span class="p">:</span><span class="n">ie</span><span class="p">,</span> <span class="n">ib</span><span class="p">:</span><span class="n">ie</span> <span class="o">+</span> <span class="mi">1</span><span class="p">))</span>
<a name="ln-853"></a>      <span class="k">allocate</span> <span class="p">(</span><span class="n">distxf2</span><span class="p">(</span><span class="n">ib</span><span class="p">:</span><span class="n">ie</span><span class="p">,</span> <span class="n">ib</span><span class="p">:</span><span class="n">ie</span> <span class="o">+</span> <span class="mi">1</span><span class="p">))</span>
<a name="ln-854"></a>      <span class="k">allocate</span> <span class="p">(</span><span class="n">distyh2</span><span class="p">(</span><span class="n">jb</span><span class="p">:</span><span class="n">je</span><span class="p">,</span> <span class="n">jgb</span><span class="p">:</span><span class="n">jge</span> <span class="o">+</span> <span class="mi">1</span><span class="p">))</span>
<a name="ln-855"></a>      <span class="k">allocate</span> <span class="p">(</span><span class="n">distyf2</span><span class="p">(</span><span class="n">jb</span><span class="p">:</span><span class="n">je</span><span class="p">,</span> <span class="n">jgb</span><span class="p">:</span><span class="n">jge</span> <span class="o">+</span> <span class="mi">1</span><span class="p">))</span>
<a name="ln-856"></a>      <span class="k">allocate</span> <span class="p">(</span><span class="n">distzh2</span><span class="p">(</span><span class="n">kb</span><span class="p">:</span><span class="n">ke</span><span class="p">,</span> <span class="n">kb</span><span class="p">:</span><span class="n">ke</span> <span class="o">+</span> <span class="mi">1</span><span class="p">))</span>
<a name="ln-857"></a>      <span class="k">allocate</span> <span class="p">(</span><span class="n">distzf2</span><span class="p">(</span><span class="n">kb</span><span class="p">:</span><span class="n">ke</span><span class="p">,</span> <span class="n">kb</span><span class="p">:</span><span class="n">ke</span> <span class="o">+</span> <span class="mi">1</span><span class="p">))</span>
<a name="ln-858"></a>      <span class="k">allocate</span> <span class="p">(</span><span class="n">distance</span><span class="p">(</span><span class="mi">4</span><span class="p">))</span>
<a name="ln-859"></a>
<a name="ln-860"></a>      <span class="c">! initialize wall indicators</span>
<a name="ln-861"></a>      <span class="n">ux0all</span> <span class="o">=</span> <span class="mi">0</span>
<a name="ln-862"></a>      <span class="n">vy0all</span> <span class="o">=</span> <span class="mi">0</span>
<a name="ln-863"></a>      <span class="n">wz0all</span> <span class="o">=</span> <span class="mi">0</span>
<a name="ln-864"></a>
<a name="ln-865"></a>      <span class="c">! Determine for each cell face if an x/y/z-wall is present</span>
<a name="ln-866"></a>      <span class="c">! from immersed boundaries</span>
<a name="ln-867"></a>
<a name="ln-868"></a>      <span class="k">if</span> <span class="p">(</span><span class="n">libm</span><span class="p">)</span> <span class="k">then</span>
<a name="ln-869"></a>         <span class="c">! do loop over blocks</span>
<a name="ln-870"></a>         <span class="k">do </span><span class="n">n</span> <span class="o">=</span> <span class="mi">1</span><span class="p">,</span> <span class="n">nblocks</span>
<a name="ln-871"></a>            <span class="n">il</span> <span class="o">=</span> <span class="k">block</span><span class="p">(</span><span class="n">n</span><span class="p">,</span> <span class="mi">1</span><span class="p">)</span>
<a name="ln-872"></a>            <span class="n">iu</span> <span class="o">=</span> <span class="k">block</span><span class="p">(</span><span class="n">n</span><span class="p">,</span> <span class="mi">2</span><span class="p">)</span>
<a name="ln-873"></a>            <span class="n">jl</span> <span class="o">=</span> <span class="k">block</span><span class="p">(</span><span class="n">n</span><span class="p">,</span> <span class="mi">3</span><span class="p">)</span>
<a name="ln-874"></a>            <span class="n">ju</span> <span class="o">=</span> <span class="k">block</span><span class="p">(</span><span class="n">n</span><span class="p">,</span> <span class="mi">4</span><span class="p">)</span>
<a name="ln-875"></a>            <span class="n">kl</span> <span class="o">=</span> <span class="k">block</span><span class="p">(</span><span class="n">n</span><span class="p">,</span> <span class="mi">5</span><span class="p">)</span>
<a name="ln-876"></a>            <span class="n">ku</span> <span class="o">=</span> <span class="k">block</span><span class="p">(</span><span class="n">n</span><span class="p">,</span> <span class="mi">6</span><span class="p">)</span>
<a name="ln-877"></a>            <span class="k">do </span><span class="n">k</span> <span class="o">=</span> <span class="n">kl</span><span class="p">,</span> <span class="n">ku</span>
<a name="ln-878"></a>               <span class="k">do </span><span class="n">j</span> <span class="o">=</span> <span class="n">jl</span><span class="p">,</span> <span class="n">ju</span>
<a name="ln-879"></a>                  <span class="n">ux0all</span><span class="p">(</span><span class="n">il</span><span class="p">,</span> <span class="n">j</span><span class="p">,</span> <span class="n">k</span><span class="p">)</span> <span class="o">=</span> <span class="mi">1</span> <span class="c">! lower x-wall</span>
<a name="ln-880"></a>                  <span class="n">ux0all</span><span class="p">(</span><span class="n">iu</span> <span class="o">+</span> <span class="mi">1</span><span class="p">,</span> <span class="n">j</span><span class="p">,</span> <span class="n">k</span><span class="p">)</span> <span class="o">=</span> <span class="mi">1</span> <span class="c">! upper x-wall</span>
<a name="ln-881"></a>               <span class="k">end do</span>
<a name="ln-882"></a><span class="k">            end do</span>
<a name="ln-883"></a><span class="k">            do </span><span class="n">k</span> <span class="o">=</span> <span class="n">kl</span><span class="p">,</span> <span class="n">ku</span>
<a name="ln-884"></a>               <span class="k">do </span><span class="n">i</span> <span class="o">=</span> <span class="n">il</span><span class="p">,</span> <span class="n">iu</span>
<a name="ln-885"></a>                  <span class="n">vy0all</span><span class="p">(</span><span class="n">i</span><span class="p">,</span> <span class="n">jl</span><span class="p">,</span> <span class="n">k</span><span class="p">)</span> <span class="o">=</span> <span class="mi">1</span> <span class="c">! lower y-wall</span>
<a name="ln-886"></a>                  <span class="n">vy0all</span><span class="p">(</span><span class="n">i</span><span class="p">,</span> <span class="n">ju</span> <span class="o">+</span> <span class="mi">1</span><span class="p">,</span> <span class="n">k</span><span class="p">)</span> <span class="o">=</span> <span class="mi">1</span> <span class="c">! upper y-wall</span>
<a name="ln-887"></a>               <span class="k">end do</span>
<a name="ln-888"></a><span class="k">            end do</span>
<a name="ln-889"></a><span class="k">            do </span><span class="n">j</span> <span class="o">=</span> <span class="n">jl</span><span class="p">,</span> <span class="n">ju</span>
<a name="ln-890"></a>               <span class="k">do </span><span class="n">i</span> <span class="o">=</span> <span class="n">il</span><span class="p">,</span> <span class="n">iu</span>
<a name="ln-891"></a>                  <span class="n">wz0all</span><span class="p">(</span><span class="n">i</span><span class="p">,</span> <span class="n">j</span><span class="p">,</span> <span class="n">kl</span><span class="p">)</span> <span class="o">=</span> <span class="mi">1</span> <span class="c">! lower z-wall</span>
<a name="ln-892"></a>                  <span class="n">wz0all</span><span class="p">(</span><span class="n">i</span><span class="p">,</span> <span class="n">j</span><span class="p">,</span> <span class="n">ku</span> <span class="o">+</span> <span class="mi">1</span><span class="p">)</span> <span class="o">=</span> <span class="mi">1</span> <span class="c">! upper z-wall</span>
<a name="ln-893"></a>               <span class="k">end do</span>
<a name="ln-894"></a><span class="k">            end do</span>
<a name="ln-895"></a><span class="k">         end do</span> <span class="c">! loop over nblocks</span>
<a name="ln-896"></a>
<a name="ln-897"></a>      <span class="k">end if</span> <span class="c">! libm = .true.</span>
<a name="ln-898"></a>
<a name="ln-899"></a>      <span class="c">! add the global walls (probably upper and lower wall, or only lower wall)</span>
<a name="ln-900"></a>      <span class="k">if</span> <span class="p">(</span><span class="n">lzerogradtop</span><span class="p">)</span> <span class="k">then</span>
<a name="ln-901"></a><span class="k">         do </span><span class="n">i</span> <span class="o">=</span> <span class="n">ib</span><span class="p">,</span> <span class="n">ie</span>
<a name="ln-902"></a>         <span class="k">do </span><span class="n">j</span> <span class="o">=</span> <span class="n">jgb</span><span class="p">,</span> <span class="n">jge</span>
<a name="ln-903"></a>            <span class="n">wz0all</span><span class="p">(</span><span class="n">i</span><span class="p">,</span> <span class="n">j</span><span class="p">,</span> <span class="n">kb</span><span class="p">)</span> <span class="o">=</span> <span class="mi">1</span> <span class="c">! ground wall</span>
<a name="ln-904"></a>         <span class="k">end do</span>
<a name="ln-905"></a><span class="k">         end do</span>
<a name="ln-906"></a><span class="k">      else</span>
<a name="ln-907"></a><span class="k">         do </span><span class="n">i</span> <span class="o">=</span> <span class="n">ib</span><span class="p">,</span> <span class="n">ie</span>
<a name="ln-908"></a>         <span class="k">do </span><span class="n">j</span> <span class="o">=</span> <span class="n">jgb</span><span class="p">,</span> <span class="n">jge</span>
<a name="ln-909"></a>            <span class="n">wz0all</span><span class="p">(</span><span class="n">i</span><span class="p">,</span> <span class="n">j</span><span class="p">,</span> <span class="n">kb</span><span class="p">)</span> <span class="o">=</span> <span class="mi">1</span> <span class="c">! ground wall</span>
<a name="ln-910"></a>            <span class="n">wz0all</span><span class="p">(</span><span class="n">i</span><span class="p">,</span> <span class="n">j</span><span class="p">,</span> <span class="n">ke</span> <span class="o">+</span> <span class="mi">1</span><span class="p">)</span> <span class="o">=</span> <span class="mi">1</span><span class="p">;</span> <span class="c">! top wall</span>
<a name="ln-911"></a>         <span class="k">end do</span>
<a name="ln-912"></a><span class="k">         end do</span>
<a name="ln-913"></a><span class="k">      end if</span>
<a name="ln-914"></a>
<a name="ln-915"></a><span class="k">      write</span> <span class="p">(</span><span class="mi">6</span><span class="p">,</span> <span class="o">*</span><span class="p">)</span> <span class="s1">&#39;Determing distance matrices, proc=&#39;</span><span class="p">,</span> <span class="n">myid</span>
<a name="ln-916"></a>      <span class="c">! Determine x-distance matrices:</span>
<a name="ln-917"></a>      <span class="k">do </span><span class="n">ic</span> <span class="o">=</span> <span class="n">ib</span><span class="p">,</span> <span class="n">ie</span> <span class="c">! cell-center index</span>
<a name="ln-918"></a>      <span class="k">do </span><span class="n">i</span> <span class="o">=</span> <span class="n">ib</span><span class="p">,</span> <span class="n">ie</span> <span class="o">+</span> <span class="mi">1</span> <span class="c">! vertex-index (1 more than cell centers)</span>
<a name="ln-919"></a>         <span class="n">distxh</span><span class="p">(</span><span class="n">ic</span><span class="p">,</span> <span class="n">i</span><span class="p">)</span> <span class="o">=</span> <span class="n">xf</span><span class="p">(</span><span class="n">ic</span><span class="p">)</span> <span class="o">-</span> <span class="n">xh</span><span class="p">(</span><span class="n">i</span><span class="p">)</span>
<a name="ln-920"></a>      <span class="k">end do</span>
<a name="ln-921"></a><span class="k">      end do</span>
<a name="ln-922"></a>
<a name="ln-923"></a><span class="k">      do </span><span class="n">ic</span> <span class="o">=</span> <span class="n">ib</span><span class="p">,</span> <span class="n">ie</span> <span class="c">! cell-center index</span>
<a name="ln-924"></a>      <span class="k">do </span><span class="n">i</span> <span class="o">=</span> <span class="n">ib</span><span class="p">,</span> <span class="n">ie</span> <span class="o">+</span> <span class="mi">1</span> <span class="c">! center -index</span>
<a name="ln-925"></a>         <span class="n">distxf</span><span class="p">(</span><span class="n">ic</span><span class="p">,</span> <span class="n">i</span><span class="p">)</span> <span class="o">=</span> <span class="n">xf</span><span class="p">(</span><span class="n">ic</span><span class="p">)</span> <span class="o">-</span> <span class="n">xf</span><span class="p">(</span><span class="n">i</span><span class="p">)</span>
<a name="ln-926"></a>      <span class="k">end do</span>
<a name="ln-927"></a><span class="k">      end do</span>
<a name="ln-928"></a>
<a name="ln-929"></a>      <span class="c">! Determine y-distance matrices:</span>
<a name="ln-930"></a>      <span class="k">do </span><span class="n">jc</span> <span class="o">=</span> <span class="n">jb</span><span class="p">,</span> <span class="n">je</span> <span class="c">! cell-center index</span>
<a name="ln-931"></a>      <span class="k">do </span><span class="n">j</span> <span class="o">=</span> <span class="n">jgb</span><span class="p">,</span> <span class="n">jge</span> <span class="o">+</span> <span class="mi">1</span> <span class="c">! vertex-index (1 more than cell centers) (global index to make sure distance to all cells is determined)</span>
<a name="ln-932"></a>         <span class="n">distyh</span><span class="p">(</span><span class="n">jc</span><span class="p">,</span> <span class="n">j</span><span class="p">)</span> <span class="o">=</span> <span class="p">(</span><span class="n">jc</span> <span class="o">+</span> <span class="n">myid</span><span class="o">*</span><span class="n">jmax</span> <span class="o">-</span> <span class="n">j</span><span class="p">)</span><span class="o">*</span><span class="n">dy</span> <span class="o">+</span> <span class="mf">0.5</span><span class="o">*</span><span class="n">dy</span>
<a name="ln-933"></a>      <span class="k">end do</span>
<a name="ln-934"></a><span class="k">      end do</span>
<a name="ln-935"></a>
<a name="ln-936"></a><span class="k">      do </span><span class="n">jc</span> <span class="o">=</span> <span class="n">jb</span><span class="p">,</span> <span class="n">je</span> <span class="c">! cell-center index</span>
<a name="ln-937"></a>      <span class="k">do </span><span class="n">j</span> <span class="o">=</span> <span class="n">jgb</span><span class="p">,</span> <span class="n">jge</span> <span class="o">+</span> <span class="mi">1</span> <span class="c">! center-index  (global index to make sure distance to all cells is determined)</span>
<a name="ln-938"></a>         <span class="n">distyf</span><span class="p">(</span><span class="n">jc</span><span class="p">,</span> <span class="n">j</span><span class="p">)</span> <span class="o">=</span> <span class="p">(</span><span class="n">jc</span> <span class="o">+</span> <span class="n">myid</span><span class="o">*</span><span class="n">jmax</span> <span class="o">-</span> <span class="n">j</span><span class="p">)</span><span class="o">*</span><span class="n">dy</span>
<a name="ln-939"></a>      <span class="k">end do</span>
<a name="ln-940"></a><span class="k">      end do</span>
<a name="ln-941"></a>
<a name="ln-942"></a>      <span class="c">! Determine z-distance matrices:</span>
<a name="ln-943"></a>      <span class="k">do </span><span class="n">kc</span> <span class="o">=</span> <span class="n">kb</span><span class="p">,</span> <span class="n">ke</span> <span class="c">! cell-center index</span>
<a name="ln-944"></a>      <span class="k">do </span><span class="n">k</span> <span class="o">=</span> <span class="n">kb</span><span class="p">,</span> <span class="n">ke</span> <span class="o">+</span> <span class="mi">1</span> <span class="c">! vertex-index (1 more than cell centers)</span>
<a name="ln-945"></a>         <span class="n">distzh</span><span class="p">(</span><span class="n">kc</span><span class="p">,</span> <span class="n">k</span><span class="p">)</span> <span class="o">=</span> <span class="n">zf</span><span class="p">(</span><span class="n">kc</span><span class="p">)</span> <span class="o">-</span> <span class="n">zh</span><span class="p">(</span><span class="n">k</span><span class="p">)</span>
<a name="ln-946"></a>      <span class="k">end do</span>
<a name="ln-947"></a><span class="k">      end do</span>
<a name="ln-948"></a>
<a name="ln-949"></a><span class="k">      do </span><span class="n">kc</span> <span class="o">=</span> <span class="n">kb</span><span class="p">,</span> <span class="n">ke</span> <span class="c">! cell-center index</span>
<a name="ln-950"></a>      <span class="k">do </span><span class="n">k</span> <span class="o">=</span> <span class="n">kb</span><span class="p">,</span> <span class="n">ke</span> <span class="o">+</span> <span class="mi">1</span> <span class="c">! vertex-index (1 more than cell centers)</span>
<a name="ln-951"></a>         <span class="n">distzf</span><span class="p">(</span><span class="n">kc</span><span class="p">,</span> <span class="n">k</span><span class="p">)</span> <span class="o">=</span> <span class="n">zf</span><span class="p">(</span><span class="n">kc</span><span class="p">)</span> <span class="o">-</span> <span class="n">zf</span><span class="p">(</span><span class="n">k</span><span class="p">)</span>
<a name="ln-952"></a>      <span class="k">end do</span>
<a name="ln-953"></a><span class="k">      end do</span>
<a name="ln-954"></a>
<a name="ln-955"></a><span class="k">      </span><span class="n">distxh2</span> <span class="o">=</span> <span class="n">distxh</span><span class="o">**</span><span class="mi">2</span>
<a name="ln-956"></a>      <span class="n">distyh2</span> <span class="o">=</span> <span class="n">distyh</span><span class="o">**</span><span class="mi">2</span>
<a name="ln-957"></a>      <span class="n">distzh2</span> <span class="o">=</span> <span class="n">distzh</span><span class="o">**</span><span class="mi">2</span>
<a name="ln-958"></a>      <span class="n">distxf2</span> <span class="o">=</span> <span class="n">distxf</span><span class="o">**</span><span class="mi">2</span>
<a name="ln-959"></a>      <span class="n">distyf2</span> <span class="o">=</span> <span class="n">distyf</span><span class="o">**</span><span class="mi">2</span>
<a name="ln-960"></a>      <span class="n">distzf2</span> <span class="o">=</span> <span class="n">distzf</span><span class="o">**</span><span class="mi">2</span>
<a name="ln-961"></a>
<a name="ln-962"></a>      <span class="k">write</span> <span class="p">(</span><span class="mi">6</span><span class="p">,</span> <span class="o">*</span><span class="p">)</span> <span class="s1">&#39;Finished determing distance matrices, proc=&#39;</span><span class="p">,</span> <span class="n">myid</span>
<a name="ln-963"></a>      <span class="k">write</span> <span class="p">(</span><span class="mi">6</span><span class="p">,</span> <span class="o">*</span><span class="p">)</span> <span class="s1">&#39;determing distance to nearest wall for each cell center, proc=&#39;</span><span class="p">,</span> <span class="n">myid</span>
<a name="ln-964"></a>
<a name="ln-965"></a>      <span class="c">! Loop over cells (ic,jc,kc) for which minimal wall-to-cell-center-distance needs to be determined</span>
<a name="ln-966"></a>      <span class="c">!  do jc=jgb,jge</span>
<a name="ln-967"></a>      <span class="k">do </span><span class="n">kc</span> <span class="o">=</span> <span class="n">kb</span><span class="p">,</span> <span class="n">ke</span>
<a name="ln-968"></a>      <span class="k">do </span><span class="n">jc</span> <span class="o">=</span> <span class="n">jb</span><span class="p">,</span> <span class="n">je</span>
<a name="ln-969"></a>      <span class="k">do </span><span class="n">ic</span> <span class="o">=</span> <span class="n">ib</span><span class="p">,</span> <span class="n">ie</span>
<a name="ln-970"></a>         <span class="c">! Determine distance between cc of cell (ic,jc,kc) and faces of all cells (i,j,k)</span>
<a name="ln-971"></a>         <span class="k">do </span><span class="n">k</span> <span class="o">=</span> <span class="n">kb</span><span class="p">,</span> <span class="n">ke</span> <span class="o">+</span> <span class="mi">1</span> <span class="c">! Level ke+1 is computed in a separate loop (only necessary with upper wall-&gt; global approach=faster)</span>
<a name="ln-972"></a>         <span class="k">do </span><span class="n">j</span> <span class="o">=</span> <span class="n">jgb</span><span class="p">,</span> <span class="n">jge</span> <span class="o">+</span> <span class="mi">1</span> <span class="c">! loop goes up to jge+1 because jge+1 contains the last vy0-wall</span>
<a name="ln-973"></a>         <span class="k">do </span><span class="n">i</span> <span class="o">=</span> <span class="n">ib</span><span class="p">,</span> <span class="n">ie</span> <span class="o">+</span> <span class="mi">1</span> <span class="c">! loop goes up to ie+1 because ie+1 contains the last ux0-wall</span>
<a name="ln-974"></a>            <span class="k">if</span> <span class="p">(</span><span class="n">ux0all</span><span class="p">(</span><span class="n">i</span><span class="p">,</span> <span class="n">j</span><span class="p">,</span> <span class="n">k</span><span class="p">)</span> <span class="o">==</span> <span class="mi">1</span> <span class="p">.</span><span class="nb">OR</span><span class="p">.</span> <span class="n">vy0all</span><span class="p">(</span><span class="n">i</span><span class="p">,</span> <span class="n">j</span><span class="p">,</span> <span class="n">k</span><span class="p">)</span> <span class="o">==</span> <span class="mi">1</span> <span class="p">.</span><span class="nb">OR</span><span class="p">.</span> <span class="n">wz0all</span><span class="p">(</span><span class="n">i</span><span class="p">,</span> <span class="n">j</span><span class="p">,</span> <span class="n">k</span><span class="p">)</span> <span class="o">==</span> <span class="mi">1</span><span class="p">)</span> <span class="k">then</span>
<a name="ln-975"></a><span class="k">               </span><span class="n">distx</span> <span class="o">=</span> <span class="mf">1.0e10</span> <span class="c">! make sure distx is very large when no x-wall is present</span>
<a name="ln-976"></a>               <span class="n">disty</span> <span class="o">=</span> <span class="mf">1.0e10</span> <span class="c">! make sure disty is very large when no y-wall is present</span>
<a name="ln-977"></a>               <span class="n">distz</span> <span class="o">=</span> <span class="mf">1.0e10</span> <span class="c">! make sure distz is very large when no z-wall is present</span>
<a name="ln-978"></a>               <span class="k">if</span> <span class="p">(</span><span class="n">ux0all</span><span class="p">(</span><span class="n">i</span><span class="p">,</span> <span class="n">j</span><span class="p">,</span> <span class="n">k</span><span class="p">)</span> <span class="o">==</span> <span class="mi">1</span><span class="p">)</span> <span class="k">then</span>
<a name="ln-979"></a><span class="k">                  </span><span class="n">distx</span> <span class="o">=</span> <span class="nb">sqrt</span><span class="p">(</span><span class="n">distxh2</span><span class="p">(</span><span class="n">ic</span><span class="p">,</span> <span class="n">i</span><span class="p">)</span> <span class="o">+</span> <span class="n">distyf2</span><span class="p">(</span><span class="n">jc</span><span class="p">,</span> <span class="n">j</span><span class="p">)</span> <span class="o">+</span> <span class="n">distzf2</span><span class="p">(</span><span class="n">kc</span><span class="p">,</span> <span class="n">k</span><span class="p">))</span>
<a name="ln-980"></a>               <span class="k">end if</span>
<a name="ln-981"></a><span class="k">               if</span> <span class="p">(</span><span class="n">vy0all</span><span class="p">(</span><span class="n">i</span><span class="p">,</span> <span class="n">j</span><span class="p">,</span> <span class="n">k</span><span class="p">)</span> <span class="o">==</span> <span class="mi">1</span><span class="p">)</span> <span class="k">then</span>
<a name="ln-982"></a><span class="k">                  </span><span class="n">disty</span> <span class="o">=</span> <span class="nb">sqrt</span><span class="p">(</span><span class="n">distxf2</span><span class="p">(</span><span class="n">ic</span><span class="p">,</span> <span class="n">i</span><span class="p">)</span> <span class="o">+</span> <span class="n">distyh2</span><span class="p">(</span><span class="n">jc</span><span class="p">,</span> <span class="n">j</span><span class="p">)</span> <span class="o">+</span> <span class="n">distzf2</span><span class="p">(</span><span class="n">kc</span><span class="p">,</span> <span class="n">k</span><span class="p">))</span>
<a name="ln-983"></a>               <span class="k">end if</span>
<a name="ln-984"></a><span class="k">               if</span> <span class="p">(</span><span class="n">wz0all</span><span class="p">(</span><span class="n">i</span><span class="p">,</span> <span class="n">j</span><span class="p">,</span> <span class="n">k</span><span class="p">)</span> <span class="o">==</span> <span class="mi">1</span><span class="p">)</span> <span class="k">then</span>
<a name="ln-985"></a><span class="k">                  </span><span class="n">distz</span> <span class="o">=</span> <span class="nb">sqrt</span><span class="p">(</span><span class="n">distxf2</span><span class="p">(</span><span class="n">ic</span><span class="p">,</span> <span class="n">i</span><span class="p">)</span> <span class="o">+</span> <span class="n">distyf2</span><span class="p">(</span><span class="n">jc</span><span class="p">,</span> <span class="n">j</span><span class="p">)</span> <span class="o">+</span> <span class="n">distzh2</span><span class="p">(</span><span class="n">kc</span><span class="p">,</span> <span class="n">k</span><span class="p">))</span>
<a name="ln-986"></a>               <span class="k">end if</span>
<a name="ln-987"></a><span class="k">            else</span> <span class="c">! no walls are present in cell (i,j,k) -&gt; distance does not need to be determined for this cell</span>
<a name="ln-988"></a>               <span class="k">cycle</span> <span class="c">! go to next cell (i,j,k)</span>
<a name="ln-989"></a>            <span class="k">end if</span>
<a name="ln-990"></a>            <span class="c">! determine minimal wall distance between cc of (ic,jc,kc) and faces of cell (i,j,k)</span>
<a name="ln-991"></a>            <span class="n">distance</span> <span class="o">=</span> <span class="p">(</span><span class="o">/</span><span class="n">mindist</span><span class="p">(</span><span class="n">ic</span><span class="p">,</span> <span class="n">jc</span><span class="p">,</span> <span class="n">kc</span><span class="p">),</span> <span class="n">distx</span><span class="p">,</span> <span class="n">disty</span><span class="p">,</span> <span class="n">distz</span><span class="o">/</span><span class="p">)</span>
<a name="ln-992"></a>            <span class="n">optie</span> <span class="o">=</span> <span class="nb">minloc</span><span class="p">(</span><span class="n">distance</span><span class="p">,</span> <span class="mi">1</span><span class="p">)</span>
<a name="ln-993"></a>            <span class="c">! write(6,*) &#39;optie=&#39;, optie</span>
<a name="ln-994"></a>
<a name="ln-995"></a>            <span class="k">if</span> <span class="p">(</span><span class="n">optie</span> <span class="o">==</span> <span class="mi">1</span><span class="p">)</span> <span class="k">then</span>
<a name="ln-996"></a><span class="k">               cycle</span>
<a name="ln-997"></a><span class="k">            else if</span> <span class="p">(</span><span class="n">optie</span> <span class="o">==</span> <span class="mi">2</span><span class="p">)</span> <span class="k">then</span>
<a name="ln-998"></a><span class="k">               </span><span class="n">mindist</span><span class="p">(</span><span class="n">ic</span><span class="p">,</span> <span class="n">jc</span><span class="p">,</span> <span class="n">kc</span><span class="p">)</span> <span class="o">=</span> <span class="n">distx</span>
<a name="ln-999"></a>               <span class="n">wall</span><span class="p">(</span><span class="n">ic</span><span class="p">,</span> <span class="n">jc</span><span class="p">,</span> <span class="n">kc</span><span class="p">,</span> <span class="mi">2</span><span class="p">)</span> <span class="o">=</span> <span class="n">j</span>
<a name="ln-1000"></a>               <span class="n">wall</span><span class="p">(</span><span class="n">ic</span><span class="p">,</span> <span class="n">jc</span><span class="p">,</span> <span class="n">kc</span><span class="p">,</span> <span class="mi">3</span><span class="p">)</span> <span class="o">=</span> <span class="n">k</span>
<a name="ln-1001"></a>               <span class="c">! wall(ic,jc,kc,4) = 1     ! This means the wall closest to the cc of (ic,jc,kc) is at an x-wall at (i,j,k)</span>
<a name="ln-1002"></a>               <span class="k">if</span> <span class="p">(</span><span class="n">ic</span> <span class="o">&gt;=</span> <span class="n">i</span><span class="p">)</span> <span class="k">then</span>
<a name="ln-1003"></a><span class="k">                  </span><span class="n">wall</span><span class="p">(</span><span class="n">ic</span><span class="p">,</span> <span class="n">jc</span><span class="p">,</span> <span class="n">kc</span><span class="p">,</span> <span class="mi">1</span><span class="p">)</span> <span class="o">=</span> <span class="n">i</span>
<a name="ln-1004"></a>                  <span class="n">wall</span><span class="p">(</span><span class="n">ic</span><span class="p">,</span> <span class="n">jc</span><span class="p">,</span> <span class="n">kc</span><span class="p">,</span> <span class="mi">4</span><span class="p">)</span> <span class="o">=</span> <span class="mi">5</span> <span class="c">! shear component index (variable: shear)</span>
<a name="ln-1005"></a>                  <span class="n">wall</span><span class="p">(</span><span class="n">ic</span><span class="p">,</span> <span class="n">jc</span><span class="p">,</span> <span class="n">kc</span><span class="p">,</span> <span class="mi">5</span><span class="p">)</span> <span class="o">=</span> <span class="mi">9</span> <span class="c">! shear component index (variable: shear)</span>
<a name="ln-1006"></a>               <span class="k">else</span>
<a name="ln-1007"></a><span class="k">                  </span><span class="n">wall</span><span class="p">(</span><span class="n">ic</span><span class="p">,</span> <span class="n">jc</span><span class="p">,</span> <span class="n">kc</span><span class="p">,</span> <span class="mi">1</span><span class="p">)</span> <span class="o">=</span> <span class="n">i</span> <span class="o">-</span> <span class="mi">1</span> <span class="c">! in the subgrid this stress is computed in the cell i-1</span>
<a name="ln-1008"></a>                  <span class="n">wall</span><span class="p">(</span><span class="n">ic</span><span class="p">,</span> <span class="n">jc</span><span class="p">,</span> <span class="n">kc</span><span class="p">,</span> <span class="mi">4</span><span class="p">)</span> <span class="o">=</span> <span class="mi">6</span> <span class="c">! shear component index (variable: shear)</span>
<a name="ln-1009"></a>                  <span class="n">wall</span><span class="p">(</span><span class="n">ic</span><span class="p">,</span> <span class="n">jc</span><span class="p">,</span> <span class="n">kc</span><span class="p">,</span> <span class="mi">5</span><span class="p">)</span> <span class="o">=</span> <span class="mi">10</span> <span class="c">! shear component index (variable: shear)</span>
<a name="ln-1010"></a>               <span class="k">end if</span>
<a name="ln-1011"></a><span class="k">            else if</span> <span class="p">(</span><span class="n">optie</span> <span class="o">==</span> <span class="mi">3</span><span class="p">)</span> <span class="k">then</span>
<a name="ln-1012"></a><span class="k">               </span><span class="n">mindist</span><span class="p">(</span><span class="n">ic</span><span class="p">,</span> <span class="n">jc</span><span class="p">,</span> <span class="n">kc</span><span class="p">)</span> <span class="o">=</span> <span class="n">disty</span>
<a name="ln-1013"></a>               <span class="n">wall</span><span class="p">(</span><span class="n">ic</span><span class="p">,</span> <span class="n">jc</span><span class="p">,</span> <span class="n">kc</span><span class="p">,</span> <span class="mi">1</span><span class="p">)</span> <span class="o">=</span> <span class="n">i</span>
<a name="ln-1014"></a>               <span class="n">wall</span><span class="p">(</span><span class="n">ic</span><span class="p">,</span> <span class="n">jc</span><span class="p">,</span> <span class="n">kc</span><span class="p">,</span> <span class="mi">3</span><span class="p">)</span> <span class="o">=</span> <span class="n">k</span>
<a name="ln-1015"></a>               <span class="c">! wall(ic,jc,kc,4) = 2     ! This means the wall closest to the cc of (ic,jc,kc) is at a y-wall at (i,j,k)</span>
<a name="ln-1016"></a>               <span class="k">if</span> <span class="p">(</span><span class="n">jc</span> <span class="o">+</span> <span class="n">myid</span><span class="o">*</span><span class="n">jmax</span> <span class="o">&gt;=</span> <span class="n">j</span><span class="p">)</span> <span class="k">then</span>
<a name="ln-1017"></a><span class="k">                  </span><span class="n">wall</span><span class="p">(</span><span class="n">ic</span><span class="p">,</span> <span class="n">jc</span><span class="p">,</span> <span class="n">kc</span><span class="p">,</span> <span class="mi">2</span><span class="p">)</span> <span class="o">=</span> <span class="n">j</span>
<a name="ln-1018"></a>                  <span class="n">wall</span><span class="p">(</span><span class="n">ic</span><span class="p">,</span> <span class="n">jc</span><span class="p">,</span> <span class="n">kc</span><span class="p">,</span> <span class="mi">4</span><span class="p">)</span> <span class="o">=</span> <span class="mi">1</span> <span class="c">! shear component index (variable: shear)</span>
<a name="ln-1019"></a>                  <span class="n">wall</span><span class="p">(</span><span class="n">ic</span><span class="p">,</span> <span class="n">jc</span><span class="p">,</span> <span class="n">kc</span><span class="p">,</span> <span class="mi">5</span><span class="p">)</span> <span class="o">=</span> <span class="mi">11</span> <span class="c">! shear component index (variable: shear)</span>
<a name="ln-1020"></a>               <span class="k">else</span>
<a name="ln-1021"></a><span class="k">                  </span><span class="n">wall</span><span class="p">(</span><span class="n">ic</span><span class="p">,</span> <span class="n">jc</span><span class="p">,</span> <span class="n">kc</span><span class="p">,</span> <span class="mi">2</span><span class="p">)</span> <span class="o">=</span> <span class="n">j</span> <span class="o">-</span> <span class="mi">1</span> <span class="c">! in the subgrid this stress is computed in the cell j-1</span>
<a name="ln-1022"></a>                  <span class="n">wall</span><span class="p">(</span><span class="n">ic</span><span class="p">,</span> <span class="n">jc</span><span class="p">,</span> <span class="n">kc</span><span class="p">,</span> <span class="mi">4</span><span class="p">)</span> <span class="o">=</span> <span class="mi">2</span> <span class="c">! shear component index (variable: shear)</span>
<a name="ln-1023"></a>                  <span class="n">wall</span><span class="p">(</span><span class="n">ic</span><span class="p">,</span> <span class="n">jc</span><span class="p">,</span> <span class="n">kc</span><span class="p">,</span> <span class="mi">5</span><span class="p">)</span> <span class="o">=</span> <span class="mi">12</span> <span class="c">! shear component index (variable: shear)</span>
<a name="ln-1024"></a>               <span class="k">end if</span>
<a name="ln-1025"></a><span class="k">            else if</span> <span class="p">(</span><span class="n">optie</span> <span class="o">==</span> <span class="mi">4</span><span class="p">)</span> <span class="k">then</span>
<a name="ln-1026"></a><span class="k">               </span><span class="n">mindist</span><span class="p">(</span><span class="n">ic</span><span class="p">,</span> <span class="n">jc</span><span class="p">,</span> <span class="n">kc</span><span class="p">)</span> <span class="o">=</span> <span class="n">distz</span>
<a name="ln-1027"></a>               <span class="n">wall</span><span class="p">(</span><span class="n">ic</span><span class="p">,</span> <span class="n">jc</span><span class="p">,</span> <span class="n">kc</span><span class="p">,</span> <span class="mi">1</span><span class="p">)</span> <span class="o">=</span> <span class="n">i</span>
<a name="ln-1028"></a>               <span class="n">wall</span><span class="p">(</span><span class="n">ic</span><span class="p">,</span> <span class="n">jc</span><span class="p">,</span> <span class="n">kc</span><span class="p">,</span> <span class="mi">2</span><span class="p">)</span> <span class="o">=</span> <span class="n">j</span>
<a name="ln-1029"></a>               <span class="c">! wall(ic,jc,kc,4) = 3     ! This means the wall closest to the cc of (ic,jc,kc) is at a z-wall at (i,j,k)</span>
<a name="ln-1030"></a>               <span class="k">if</span> <span class="p">(</span><span class="n">kc</span> <span class="o">&gt;=</span> <span class="n">k</span><span class="p">)</span> <span class="k">then</span>
<a name="ln-1031"></a><span class="k">                  </span><span class="n">wall</span><span class="p">(</span><span class="n">ic</span><span class="p">,</span> <span class="n">jc</span><span class="p">,</span> <span class="n">kc</span><span class="p">,</span> <span class="mi">3</span><span class="p">)</span> <span class="o">=</span> <span class="n">k</span>
<a name="ln-1032"></a>                  <span class="n">wall</span><span class="p">(</span><span class="n">ic</span><span class="p">,</span> <span class="n">jc</span><span class="p">,</span> <span class="n">kc</span><span class="p">,</span> <span class="mi">4</span><span class="p">)</span> <span class="o">=</span> <span class="mi">3</span> <span class="c">! shear component index (variable: shear)</span>
<a name="ln-1033"></a>                  <span class="n">wall</span><span class="p">(</span><span class="n">ic</span><span class="p">,</span> <span class="n">jc</span><span class="p">,</span> <span class="n">kc</span><span class="p">,</span> <span class="mi">5</span><span class="p">)</span> <span class="o">=</span> <span class="mi">7</span> <span class="c">! shear component index (variable: shear)</span>
<a name="ln-1034"></a>               <span class="k">else</span>
<a name="ln-1035"></a><span class="k">                  </span><span class="n">wall</span><span class="p">(</span><span class="n">ic</span><span class="p">,</span> <span class="n">jc</span><span class="p">,</span> <span class="n">kc</span><span class="p">,</span> <span class="mi">3</span><span class="p">)</span> <span class="o">=</span> <span class="n">k</span> <span class="o">-</span> <span class="mi">1</span> <span class="c">! in the subgrid this stress is computed in the cel k-1</span>
<a name="ln-1036"></a>                  <span class="n">wall</span><span class="p">(</span><span class="n">ic</span><span class="p">,</span> <span class="n">jc</span><span class="p">,</span> <span class="n">kc</span><span class="p">,</span> <span class="mi">4</span><span class="p">)</span> <span class="o">=</span> <span class="mi">4</span> <span class="c">! shear component index (variable: shear)</span>
<a name="ln-1037"></a>                  <span class="n">wall</span><span class="p">(</span><span class="n">ic</span><span class="p">,</span> <span class="n">jc</span><span class="p">,</span> <span class="n">kc</span><span class="p">,</span> <span class="mi">5</span><span class="p">)</span> <span class="o">=</span> <span class="mi">8</span> <span class="c">! shear component index (variable: shear)</span>
<a name="ln-1038"></a>               <span class="k">end if</span>
<a name="ln-1039"></a><span class="k">            end if</span>
<a name="ln-1040"></a>         <span class="c">! mindist(ic,jc+myid*jmax,kc)=min(mindist(ic,jc+myid*jmax,kc),distx,disty,distz)   ! global j index</span>
<a name="ln-1041"></a>         <span class="k">end do</span>
<a name="ln-1042"></a><span class="k">         end do</span>
<a name="ln-1043"></a><span class="k">         end do</span>
<a name="ln-1044"></a>      <span class="c">! if (myid==0) write(6,*) &#39;finished for cell (ic,jc,kc)=&#39;,ic,jc,kc</span>
<a name="ln-1045"></a>      <span class="k">end do</span>
<a name="ln-1046"></a><span class="k">      end do</span>
<a name="ln-1047"></a><span class="k">      end do</span>
<a name="ln-1048"></a>
<a name="ln-1049"></a><span class="k">      write</span> <span class="p">(</span><span class="mi">6</span><span class="p">,</span> <span class="o">*</span><span class="p">)</span> <span class="s1">&#39;Finished determing distance to nearest wall for each cell center, proc=&#39;</span><span class="p">,</span> <span class="n">myid</span>
<a name="ln-1050"></a>      <span class="c">! write(6,*) &#39;mindist(ib,jb+myid*jmax,kb),mindist(ib,je+myid*jmax,kb)&#39;,mindist(ib,jb+myid*jmax,kb),mindist(ib,je+myid*jmax,kb)</span>
<a name="ln-1051"></a>
<a name="ln-1052"></a>      <span class="k">else</span>
<a name="ln-1053"></a><span class="k">      return</span>
<a name="ln-1054"></a><span class="k">      end if</span> <span class="c">!(lwarmstart)</span>
<a name="ln-1055"></a>
<a name="ln-1056"></a>      <span class="k">deallocate</span> <span class="p">(</span><span class="n">ux0all</span><span class="p">,</span> <span class="n">vy0all</span><span class="p">,</span> <span class="n">wz0all</span><span class="p">)</span>
<a name="ln-1057"></a>      <span class="k">deallocate</span> <span class="p">(</span><span class="n">xwallsglobal</span><span class="p">,</span> <span class="n">ywallsglobal</span><span class="p">,</span> <span class="n">zwallsglobal</span><span class="p">,</span> <span class="k">block</span><span class="p">)</span> <span class="c">! used for determining boundaries</span>
<a name="ln-1058"></a>      <span class="k">return</span>
<a name="ln-1059"></a><span class="k">   end subroutine </span><span class="n">nearwall</span>
<a name="ln-1060"></a>
<a name="ln-1061"></a>   <span class="k">subroutine </span><span class="n">bottom</span> 
<a name="ln-1062"></a>      <span class="c">!kind of obsolete when road facets are being used</span>
<a name="ln-1063"></a>      <span class="c">!vegetated floor not added (could simply be copied from vegetated horizontal facets)</span>
<a name="ln-1064"></a>      <span class="k">use </span><span class="n">modglobal</span><span class="p">,</span> <span class="n">only</span><span class="p">:</span><span class="n">ib</span><span class="p">,</span> <span class="n">ie</span><span class="p">,</span> <span class="n">ih</span><span class="p">,</span> <span class="n">jh</span><span class="p">,</span> <span class="n">kh</span><span class="p">,</span> <span class="n">jb</span><span class="p">,</span> <span class="n">je</span><span class="p">,</span> <span class="n">kb</span><span class="p">,</span> <span class="n">numol</span><span class="p">,</span> <span class="n">prandtlmol</span><span class="p">,</span> <span class="n">dzh</span><span class="p">,</span> <span class="n">nsv</span><span class="p">,</span> <span class="p">&amp;</span>
<a name="ln-1065"></a>         <span class="n">dxf</span><span class="p">,</span> <span class="n">dxhi</span><span class="p">,</span> <span class="n">dzf</span><span class="p">,</span> <span class="n">dzfi</span><span class="p">,</span> <span class="n">numoli</span><span class="p">,</span> <span class="n">ltempeq</span><span class="p">,</span> <span class="n">khc</span><span class="p">,</span> <span class="n">lmoist</span><span class="p">,</span> <span class="n">BCbotT</span><span class="p">,</span> <span class="n">BCbotq</span><span class="p">,</span> <span class="n">BCbotm</span><span class="p">,</span> <span class="n">BCbots</span><span class="p">,</span> <span class="n">dzh2i</span>
<a name="ln-1066"></a>      <span class="k">use </span><span class="n">modfields</span><span class="p">,</span> <span class="n">only</span> <span class="p">:</span> <span class="n">u0</span><span class="p">,</span><span class="n">v0</span><span class="p">,</span><span class="n">e120</span><span class="p">,</span><span class="n">um</span><span class="p">,</span><span class="n">vm</span><span class="p">,</span><span class="n">w0</span><span class="p">,</span><span class="n">wm</span><span class="p">,</span><span class="n">e12m</span><span class="p">,</span><span class="n">thl0</span><span class="p">,</span><span class="n">qt0</span><span class="p">,</span><span class="n">sv0</span><span class="p">,</span><span class="n">thlm</span><span class="p">,</span><span class="n">qtm</span><span class="p">,</span><span class="n">svm</span><span class="p">,</span><span class="n">up</span><span class="p">,</span><span class="n">vp</span><span class="p">,</span><span class="n">thlp</span><span class="p">,</span><span class="n">qtp</span><span class="p">,</span><span class="n">svp</span><span class="p">,</span><span class="n">shear</span><span class="p">,</span><span class="n">momfluxb</span><span class="p">,</span><span class="n">tfluxb</span><span class="p">,</span><span class="n">cth</span>
<a name="ln-1067"></a>      <span class="k">use </span><span class="n">modsurfdata</span><span class="p">,</span> <span class="n">only</span><span class="p">:</span><span class="n">thlflux</span><span class="p">,</span> <span class="n">qtflux</span><span class="p">,</span> <span class="n">svflux</span><span class="p">,</span> <span class="n">ustar</span><span class="p">,</span> <span class="n">thvs</span><span class="p">,</span> <span class="n">wtsurf</span><span class="p">,</span> <span class="n">wqsurf</span><span class="p">,</span> <span class="n">thls</span><span class="p">,</span> <span class="n">z0</span><span class="p">,</span> <span class="n">z0h</span>
<a name="ln-1068"></a>      <span class="k">use </span><span class="n">modsubgriddata</span><span class="p">,</span> <span class="n">only</span><span class="p">:</span><span class="n">ekm</span><span class="p">,</span> <span class="n">ekh</span>
<a name="ln-1069"></a>      <span class="k">use </span><span class="n">modmpi</span><span class="p">,</span> <span class="n">only</span><span class="p">:</span><span class="n">myid</span>
<a name="ln-1070"></a>      <span class="k">implicit none</span>
<a name="ln-1071"></a><span class="k">      </span><span class="kt">integer</span> <span class="kd">::</span> <span class="n">i</span><span class="p">,</span> <span class="n">j</span><span class="p">,</span> <span class="n">jp</span><span class="p">,</span> <span class="n">jm</span><span class="p">,</span> <span class="n">m</span>
<a name="ln-1072"></a>      <span class="c">!momentum</span>
<a name="ln-1073"></a>      <span class="k">if</span> <span class="p">(</span><span class="n">BCbotm</span><span class="p">.</span><span class="n">eq</span><span class="p">.</span><span class="mi">2</span><span class="p">)</span> <span class="k">then</span>
<a name="ln-1074"></a><span class="k">      call </span><span class="n">wfuno</span><span class="p">(</span><span class="n">ih</span><span class="p">,</span> <span class="n">jh</span><span class="p">,</span> <span class="n">kh</span><span class="p">,</span> <span class="n">up</span><span class="p">,</span> <span class="n">vp</span><span class="p">,</span> <span class="n">thlp</span><span class="p">,</span> <span class="n">momfluxb</span><span class="p">,</span> <span class="n">tfluxb</span><span class="p">,</span> <span class="n">cth</span><span class="p">,</span> <span class="n">bcTfluxA</span><span class="p">,</span> <span class="n">u0</span><span class="p">,</span> <span class="n">v0</span><span class="p">,</span> <span class="n">thl0</span><span class="p">,</span> <span class="n">thls</span><span class="p">,</span> <span class="n">z0</span><span class="p">,</span> <span class="n">z0h</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="mi">91</span><span class="p">)</span>
<a name="ln-1075"></a>      <span class="n">elseif</span> <span class="p">(</span><span class="n">BCbotm</span><span class="p">.</span><span class="n">eq</span><span class="p">.</span><span class="mi">3</span><span class="p">)</span> <span class="k">then</span>
<a name="ln-1076"></a><span class="k">      call </span><span class="n">wfmneutral</span><span class="p">(</span><span class="n">ih</span><span class="p">,</span> <span class="n">jh</span><span class="p">,</span> <span class="n">kh</span><span class="p">,</span> <span class="n">up</span><span class="p">,</span> <span class="n">vp</span><span class="p">,</span> <span class="n">momfluxb</span><span class="p">,</span> <span class="n">u0</span><span class="p">,</span> <span class="n">v0</span><span class="p">,</span> <span class="n">z0</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="mi">91</span><span class="p">)</span>
<a name="ln-1077"></a>      <span class="k">else</span>
<a name="ln-1078"></a><span class="k">      write</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="o">*</span><span class="p">)</span> <span class="s2">&quot;ERROR: bottom boundary type for momentum undefined&quot;</span>
<a name="ln-1079"></a>      <span class="k">stop </span><span class="mi">1</span>
<a name="ln-1080"></a>      <span class="k">end if</span>
<a name="ln-1081"></a><span class="k"> </span>
<a name="ln-1082"></a><span class="k">      if</span> <span class="p">(</span><span class="n">ltempeq</span><span class="p">)</span> <span class="k">then</span>
<a name="ln-1083"></a><span class="k">         if</span> <span class="p">(</span><span class="n">BCbotT</span><span class="p">.</span><span class="n">eq</span><span class="p">.</span><span class="mi">1</span><span class="p">)</span> <span class="k">then</span> <span class="c">!neumann/fixed flux bc for temperature</span>
<a name="ln-1084"></a>            <span class="k">do </span><span class="n">j</span> <span class="o">=</span> <span class="n">jb</span><span class="p">,</span> <span class="n">je</span>
<a name="ln-1085"></a>               <span class="k">do </span><span class="n">i</span> <span class="o">=</span> <span class="n">ib</span><span class="p">,</span> <span class="n">ie</span>
<a name="ln-1086"></a>                  <span class="n">thlp</span><span class="p">(</span><span class="n">i</span><span class="p">,</span> <span class="n">j</span><span class="p">,</span> <span class="n">kb</span><span class="p">)</span> <span class="o">=</span> <span class="n">thlp</span><span class="p">(</span><span class="n">i</span><span class="p">,</span> <span class="n">j</span><span class="p">,</span> <span class="n">kb</span><span class="p">)</span> <span class="p">&amp;</span>
<a name="ln-1087"></a>                                   <span class="o">+</span> <span class="p">(</span> <span class="p">&amp;</span>
<a name="ln-1088"></a>                                   <span class="mf">0.5</span><span class="o">*</span><span class="p">(</span><span class="n">dzf</span><span class="p">(</span><span class="n">kb</span> <span class="o">-</span> <span class="mi">1</span><span class="p">)</span><span class="o">*</span><span class="n">ekh</span><span class="p">(</span><span class="n">i</span><span class="p">,</span> <span class="n">j</span><span class="p">,</span> <span class="n">kb</span><span class="p">)</span> <span class="o">+</span> <span class="n">dzf</span><span class="p">(</span><span class="n">kb</span><span class="p">)</span><span class="o">*</span><span class="n">ekh</span><span class="p">(</span><span class="n">i</span><span class="p">,</span> <span class="n">j</span><span class="p">,</span> <span class="n">kb</span> <span class="o">-</span> <span class="mi">1</span><span class="p">))</span> <span class="p">&amp;</span>
<a name="ln-1089"></a>                                   <span class="o">*</span><span class="p">(</span><span class="n">thl0</span><span class="p">(</span><span class="n">i</span><span class="p">,</span> <span class="n">j</span><span class="p">,</span> <span class="n">kb</span><span class="p">)</span> <span class="o">-</span> <span class="n">thl0</span><span class="p">(</span><span class="n">i</span><span class="p">,</span> <span class="n">j</span><span class="p">,</span> <span class="n">kb</span> <span class="o">-</span> <span class="mi">1</span><span class="p">))</span> <span class="p">&amp;</span>
<a name="ln-1090"></a>                                   <span class="o">*</span><span class="n">dzh2i</span><span class="p">(</span><span class="n">kb</span><span class="p">)</span> <span class="p">&amp;</span>
<a name="ln-1091"></a>                                   <span class="o">-</span> <span class="n">wtsurf</span> <span class="p">&amp;</span>
<a name="ln-1092"></a>                                   <span class="p">)</span><span class="o">*</span><span class="n">dzfi</span><span class="p">(</span><span class="n">kb</span><span class="p">)</span>
<a name="ln-1093"></a>               <span class="k">end do</span>
<a name="ln-1094"></a><span class="k">            end do</span>
<a name="ln-1095"></a><span class="k">         else if</span> <span class="p">(</span><span class="n">BCbotT</span><span class="p">.</span><span class="n">eq</span><span class="p">.</span><span class="mi">2</span><span class="p">)</span> <span class="k">then</span> <span class="c">!wall function bc for temperature (fixed temperature)</span>
<a name="ln-1096"></a>            <span class="k">call </span><span class="n">wfuno</span><span class="p">(</span><span class="n">ih</span><span class="p">,</span> <span class="n">jh</span><span class="p">,</span> <span class="n">kh</span><span class="p">,</span> <span class="n">up</span><span class="p">,</span> <span class="n">vp</span><span class="p">,</span> <span class="n">thlp</span><span class="p">,</span> <span class="n">momfluxb</span><span class="p">,</span> <span class="n">tfluxb</span><span class="p">,</span> <span class="n">cth</span><span class="p">,</span> <span class="n">bcTfluxA</span><span class="p">,</span> <span class="n">u0</span><span class="p">,</span> <span class="n">v0</span><span class="p">,</span> <span class="n">thl0</span><span class="p">,</span> <span class="n">thls</span><span class="p">,</span> <span class="n">z0</span><span class="p">,</span> <span class="n">z0h</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="mi">92</span><span class="p">)</span>
<a name="ln-1097"></a>         <span class="k">else</span>
<a name="ln-1098"></a><span class="k">         write</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="o">*</span><span class="p">)</span> <span class="s2">&quot;ERROR: bottom boundary type for temperature undefined&quot;</span>
<a name="ln-1099"></a>         <span class="k">stop </span><span class="mi">1</span>
<a name="ln-1100"></a>         <span class="k">end if</span>
<a name="ln-1101"></a><span class="k">      end if</span> <span class="c">! ltempeq</span>
<a name="ln-1102"></a>
<a name="ln-1103"></a>      <span class="k">if</span> <span class="p">(</span><span class="n">lmoist</span><span class="p">)</span> <span class="k">then</span>
<a name="ln-1104"></a><span class="k">         if</span> <span class="p">(</span><span class="n">BCbotq</span><span class="p">.</span><span class="n">eq</span><span class="p">.</span><span class="mi">1</span><span class="p">)</span> <span class="k">then</span> <span class="c">!neumann/fixed flux bc for moisture</span>
<a name="ln-1105"></a>            <span class="k">do </span><span class="n">j</span> <span class="o">=</span> <span class="n">jb</span><span class="p">,</span> <span class="n">je</span>
<a name="ln-1106"></a>               <span class="k">do </span><span class="n">i</span> <span class="o">=</span> <span class="n">ib</span><span class="p">,</span> <span class="n">ie</span>
<a name="ln-1107"></a>                  <span class="n">qtp</span><span class="p">(</span><span class="n">i</span><span class="p">,</span> <span class="n">j</span><span class="p">,</span> <span class="n">kb</span><span class="p">)</span> <span class="o">=</span> <span class="n">qtp</span><span class="p">(</span><span class="n">i</span><span class="p">,</span> <span class="n">j</span><span class="p">,</span> <span class="n">kb</span><span class="p">)</span> <span class="o">+</span> <span class="p">(</span> <span class="p">&amp;</span>
<a name="ln-1108"></a>                                  <span class="mf">0.5</span><span class="o">*</span><span class="p">(</span><span class="n">dzf</span><span class="p">(</span><span class="n">kb</span> <span class="o">-</span> <span class="mi">1</span><span class="p">)</span><span class="o">*</span><span class="n">ekh</span><span class="p">(</span><span class="n">i</span><span class="p">,</span> <span class="n">j</span><span class="p">,</span> <span class="n">kb</span><span class="p">)</span> <span class="o">+</span> <span class="n">dzf</span><span class="p">(</span><span class="n">kb</span><span class="p">)</span><span class="o">*</span><span class="n">ekh</span><span class="p">(</span><span class="n">i</span><span class="p">,</span> <span class="n">j</span><span class="p">,</span> <span class="n">kb</span> <span class="o">-</span> <span class="mi">1</span><span class="p">))</span> <span class="p">&amp;</span>
<a name="ln-1109"></a>                                  <span class="o">*</span><span class="p">(</span><span class="n">qt0</span><span class="p">(</span><span class="n">i</span><span class="p">,</span> <span class="n">j</span><span class="p">,</span> <span class="n">kb</span><span class="p">)</span> <span class="o">-</span> <span class="n">qt0</span><span class="p">(</span><span class="n">i</span><span class="p">,</span> <span class="n">j</span><span class="p">,</span> <span class="n">kb</span> <span class="o">-</span> <span class="mi">1</span><span class="p">))</span> <span class="p">&amp;</span>
<a name="ln-1110"></a>                                  <span class="o">*</span><span class="n">dzh2i</span><span class="p">(</span><span class="n">kb</span><span class="p">)</span> <span class="p">&amp;</span>
<a name="ln-1111"></a>                                  <span class="o">+</span> <span class="n">wqsurf</span> <span class="p">&amp;</span>
<a name="ln-1112"></a>                                  <span class="p">)</span><span class="o">*</span><span class="n">dzfi</span><span class="p">(</span><span class="n">kb</span><span class="p">)</span>
<a name="ln-1113"></a>               <span class="k">end do</span>
<a name="ln-1114"></a><span class="k">            end do</span>
<a name="ln-1115"></a><span class="k">         else</span>
<a name="ln-1116"></a><span class="k">          write</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="o">*</span><span class="p">)</span> <span class="s2">&quot;ERROR: bottom boundary type for moisture undefined&quot;</span>  
<a name="ln-1117"></a>          <span class="k">stop </span><span class="mi">1</span>
<a name="ln-1118"></a>         <span class="k">end if</span> <span class="c">!</span>
<a name="ln-1119"></a>      <span class="k">end if</span> <span class="c">!lmoist</span>
<a name="ln-1120"></a>
<a name="ln-1121"></a>      <span class="k">if</span> <span class="p">(</span><span class="n">nsv</span><span class="o">&gt;</span><span class="mi">0</span><span class="p">)</span> <span class="k">then</span>
<a name="ln-1122"></a><span class="k">         if</span> <span class="p">(</span><span class="n">BCbots</span><span class="p">.</span><span class="n">eq</span><span class="p">.</span><span class="mi">1</span><span class="p">)</span> <span class="k">then</span> <span class="c">!neumann/fixed flux bc for moisture</span>
<a name="ln-1123"></a>            <span class="k">do </span><span class="n">j</span> <span class="o">=</span> <span class="n">jb</span><span class="p">,</span> <span class="n">je</span>
<a name="ln-1124"></a>               <span class="k">do </span><span class="n">i</span> <span class="o">=</span> <span class="n">ib</span><span class="p">,</span> <span class="n">ie</span>
<a name="ln-1125"></a>                  <span class="k">do </span><span class="n">m</span> <span class="o">=</span> <span class="mi">1</span><span class="p">,</span> <span class="n">nsv</span>
<a name="ln-1126"></a>                      <span class="n">svp</span><span class="p">(</span><span class="n">i</span><span class="p">,</span> <span class="n">j</span><span class="p">,</span> <span class="n">kb</span><span class="p">,</span> <span class="n">m</span><span class="p">)</span> <span class="o">=</span> <span class="n">svp</span><span class="p">(</span><span class="n">i</span><span class="p">,</span> <span class="n">j</span><span class="p">,</span> <span class="n">kb</span><span class="p">,</span> <span class="n">m</span><span class="p">)</span> <span class="o">+</span> <span class="p">(</span> <span class="p">&amp;</span>
<a name="ln-1127"></a>                                      <span class="mf">0.5</span><span class="o">*</span><span class="p">(</span><span class="n">dzf</span><span class="p">(</span><span class="n">kb</span> <span class="o">-</span> <span class="mi">1</span><span class="p">)</span><span class="o">*</span><span class="n">ekh</span><span class="p">(</span><span class="n">i</span><span class="p">,</span> <span class="n">j</span><span class="p">,</span> <span class="n">kb</span><span class="p">)</span> <span class="o">+</span> <span class="n">dzf</span><span class="p">(</span><span class="n">kb</span><span class="p">)</span><span class="o">*</span><span class="n">ekh</span><span class="p">(</span><span class="n">i</span><span class="p">,</span> <span class="n">j</span><span class="p">,</span> <span class="n">kb</span> <span class="o">-</span> <span class="mi">1</span><span class="p">))</span> <span class="p">&amp;</span>
<a name="ln-1128"></a>                                     <span class="o">*</span><span class="p">(</span><span class="n">sv0</span><span class="p">(</span><span class="n">i</span><span class="p">,</span> <span class="n">j</span><span class="p">,</span> <span class="n">kb</span><span class="p">,</span> <span class="n">m</span><span class="p">)</span> <span class="o">-</span> <span class="n">sv0</span><span class="p">(</span><span class="n">i</span><span class="p">,</span> <span class="n">j</span><span class="p">,</span> <span class="n">kb</span> <span class="o">-</span> <span class="mi">1</span><span class="p">,</span> <span class="n">m</span><span class="p">))</span> <span class="p">&amp;</span>
<a name="ln-1129"></a>                                     <span class="o">*</span><span class="n">dzh2i</span><span class="p">(</span><span class="n">kb</span><span class="p">)</span> <span class="p">&amp;</span>
<a name="ln-1130"></a>                                     <span class="o">+</span> <span class="mf">0.</span> <span class="p">&amp;</span>
<a name="ln-1131"></a>                                     <span class="p">)</span><span class="o">*</span><span class="n">dzfi</span><span class="p">(</span><span class="n">kb</span><span class="p">)</span>
<a name="ln-1132"></a>                  <span class="k">end do</span>
<a name="ln-1133"></a><span class="k">               end do</span>
<a name="ln-1134"></a><span class="k">            end do</span>
<a name="ln-1135"></a><span class="k">         else</span>
<a name="ln-1136"></a><span class="k">          write</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="o">*</span><span class="p">)</span> <span class="s2">&quot;ERROR: bottom boundary type for scalars undefined&quot;</span>  
<a name="ln-1137"></a>          <span class="k">stop </span><span class="mi">1</span>
<a name="ln-1138"></a>         <span class="k">end if</span> <span class="c">!</span>
<a name="ln-1139"></a>      <span class="k">end if</span>
<a name="ln-1140"></a>
<a name="ln-1141"></a><span class="k">      </span><span class="n">e120</span><span class="p">(:,</span> <span class="p">:,</span> <span class="n">kb</span> <span class="o">-</span> <span class="mi">1</span><span class="p">)</span> <span class="o">=</span> <span class="n">e120</span><span class="p">(:,</span> <span class="p">:,</span> <span class="n">kb</span><span class="p">)</span>
<a name="ln-1142"></a>      <span class="n">e12m</span><span class="p">(:,</span> <span class="p">:,</span> <span class="n">kb</span> <span class="o">-</span> <span class="mi">1</span><span class="p">)</span> <span class="o">=</span> <span class="n">e12m</span><span class="p">(:,</span> <span class="p">:,</span> <span class="n">kb</span><span class="p">)</span>
<a name="ln-1143"></a>      <span class="n">wm</span><span class="p">(:,</span> <span class="p">:,</span> <span class="n">kb</span><span class="p">)</span> <span class="o">=</span> <span class="mf">0.</span>
<a name="ln-1144"></a>      <span class="n">w0</span><span class="p">(:,</span> <span class="p">:,</span> <span class="n">kb</span><span class="p">)</span> <span class="o">=</span> <span class="mf">0.</span>
<a name="ln-1145"></a>      <span class="k">return</span>
<a name="ln-1146"></a><span class="k">   end subroutine </span><span class="n">bottom</span>
<a name="ln-1147"></a>
<a name="ln-1148"></a><span class="k">end module </span><span class="n">modibm</span>
</pre></div>

    </section>
    </div>
  </div>

  
    <hr>    
    </div> <!-- /container -->
    <footer>
      <div class="container">
      <div class="row">
        <div class="col-xs-6 col-md-4"><p>&copy; 2021 
                                          </p></div>
        <div class="col-xs-6 col-md-4 col-md-push-4">
          <p class="text-right">
            Documentation generated by 
            <a href="https://github.com/cmacmackin/ford">FORD</a>
            
          </p>
        </div>
        <div class="col-xs-12 col-md-4 col-md-pull-4"><p class="text-center"> uDALES was developed by The uDALES Team</p></div>
      </div>
      <br>
      </div> <!-- /container -->    
    </footer>

    <!-- Bootstrap core JavaScript
    ================================================== -->
    <!-- Placed at the end of the document so the pages load faster -->
<!--
    <script src="https://ajax.googleapis.com/ajax/libs/jquery/1.11.1/jquery.min.js"></script>
-->
    <script src="../js/bootstrap.min.js"></script>
    <!-- IE10 viewport hack for Surface/desktop Windows 8 bug -->
    <script src="../js/ie10-viewport-bug-workaround.js"></script>

    <!-- MathJax JavaScript
    ================================================== -->
    <!-- Placed at the end of the document so the pages load faster -->
    <script type="text/x-mathjax-config">
      MathJax.Hub.Config({
        TeX: { extensions: ['AMSmath.js','AMSsymbols.js','noErrors.js','noUndefined.js'], equationNumbers: { autoNumber: 'AMS' } },
        jax: ['input/TeX','input/MathML','output/HTML-CSS'],
        extensions: ['tex2jax.js','mml2jax.js','MathMenu.js','MathZoom.js']
      });
    </script>
    
    <script src="https://cdnjs.cloudflare.com/ajax/libs/mathjax/2.7.1/MathJax.js?config=TeX-AMS-MML_HTMLorMML"></script>
    
    
    <script src="../tipuesearch/tipuesearch_content.js"></script>
    <script src="../tipuesearch/tipuesearch_set.js"></script>
    <script src="../tipuesearch/tipuesearch.js"></script>
    
    
  </body>
</html>