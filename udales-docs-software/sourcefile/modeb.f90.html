<!DOCTYPE html>
<html lang="en">
  <head>
    <meta charset="utf-8">
    <meta http-equiv="X-UA-Compatible" content="IE=edge">
    <meta name="viewport" content="width=device-width, initial-scale=1">
   
    <meta name="description" content="Documentation for uDALES">
   
    <meta name="author" content="The uDALES Team" >
    <link rel="icon" href="../favicon.png">

    <title>modEB.f90 &ndash; uDALES</title>

    <link href="../css/bootstrap.min.css" rel="stylesheet">
    <link href="../css/pygments.css" rel="stylesheet">
    <link href="../css/font-awesome.min.css" rel="stylesheet">
    <link href="../css/local.css" rel="stylesheet">
    
    <link  href="../tipuesearch/tipuesearch.css" rel="stylesheet">
    
    

    <!-- HTML5 shim and Respond.js for IE8 support of HTML5 elements and media queries -->
    <!--[if lt IE 9]>
      <script src="https://oss.maxcdn.com/html5shiv/3.7.2/html5shiv.min.js"></script>
      <script src="https://oss.maxcdn.com/respond/1.4.2/respond.min.js"></script>
    <![endif]-->
    
    <script src="../js/jquery-2.1.3.min.js"></script>
    <script src="../js/svg-pan-zoom.min.js"></script>

  </head>

  <body>

    <!-- Fixed navbar -->
    <nav class="navbar navbar-inverse navbar-fixed-top">
      <div class="container">
        <div class="navbar-header">
          <button type="button" class="navbar-toggle collapsed" data-toggle="collapse" data-target="#navbar" aria-expanded="false" aria-controls="navbar">
            <span class="sr-only">Toggle navigation</span>
            <span class="icon-bar"></span>
            <span class="icon-bar"></span>
            <span class="icon-bar"></span>
          </button>
          <a class="navbar-brand" href="../index.html">uDALES </a>
        </div>
        <div id="navbar" class="navbar-collapse collapse">
          <ul class="nav navbar-nav">
        
            <li class="dropdown hidden-xs visible-sm visible-md hidden-lg">
              <a href="#" class="dropdown-toggle"
              data-toggle="dropdown" role="button"
              aria-haspopup="true"
     aria-expanded="false">Contents <span class="caret"></span></a>
        <ul class="dropdown-menu">
          
              
            <li><a href="../lists/files.html">Source Files</a></li>
        
        
        
            <li><a href="../lists/modules.html">Modules</a></li>
        
            
                                
            <li><a href="../lists/procedures.html">Procedures</a></li>
        
               
            <li><a href="../lists/types.html">Derived Types</a></li>
        
        
            <li><a href="../program/dalesurban.html">Program</a></li>
      
            </ul>
            </li>


<li class="visible-xs hidden-sm visible-lg"><a href="../lists/files.html">Source Files</a></li>



<li class="visible-xs hidden-sm visible-lg"><a href="../lists/modules.html">Modules</a></li>



<li class="visible-xs hidden-sm visible-lg"><a href="../lists/procedures.html">Procedures</a></li>

                             
<li class="visible-xs hidden-sm visible-lg"><a href="../lists/types.html">Derived Types</a></li>


<li class="visible-xs hidden-sm visible-lg"><a href="../program/dalesurban.html">Program</a></li>

          </ul>
        
        <form action="../search.html" class="navbar-form navbar-right" role="search">
        <div class="form-group">
          <input type="text" class="form-control" placeholder="Search" name="q" id="tipue_search_input" autocomplete="off" required>
        </div>
<!--
        <button type="submit" class="btn btn-default">Submit</button>
-->
        </form>
        
        </div><!--/.nav-collapse -->
      </div>
    </nav>

    <div class="container">
    
  
  <div class="row">
    <h1>modEB.f90
    <small>Source File</small>
    
    </h1>
    
<div class="row">
  <div class="col-lg-12">
<div class="well well-sm">
  <ul class="list-inline" style="margin-bottom:0px;display:inline">
     
     
     
     
    
    
     <li><i class="fa fa-list-ol"></i>
       <a data-toggle="tooltip"
    data-placement="bottom" data-html="true"
    title=" 2.6% of total for source files.">367 statements</a>
     </li> 
     
     
     
    <li><i class="fa fa-code"></i><a href="../src/modEB.f90"> Source File</a></li>
     
     
  </ul>
  <ol class="breadcrumb in-well text-right">
  
    
  
     <li class="active">modEB.f90</li>
  </ol>
</div>
</div>
</div>
<script>
  $(function () {
  $('[data-toggle="tooltip"]').tooltip()
  })
</script>

  </div>
  <div class="row">
    <div class="col-md-3 hidden-xs hidden-sm visible-md visible-lg">
    
<div id="sidebar">
  
<h3>Contents</h3>
 







<div class="panel panel-primary">
  <div class="panel-heading text-left"><h3 class="panel-title"><a data-toggle="collapse" href="#mods-0">Modules</a></h3></div>
  <div id="mods-0" class="panel-collapse collapse">
    <div class="list-group">
      
      <a class="list-group-item" href="../module/modeb.html">modEB</a>
      
    </div>
  </div>
</div>
















<div class="panel panel-primary">
  <div class="panel-heading text-left"><h3 class="panel-title">Source Code</h3></div>
  <div class="list-group">
    <a class="list-group-item" href="../sourcefile/modeb.f90.html#src">modEB.f90</a>
  </div>
</div>



</div>

    </div>
    <div class="col-md-9" id='text'>
      
      <br>
    
    <div class="panel panel-default">
      <div class="panel-heading">
  <h3 class="panel-title">This file depends on</h3>
      </div>
      <div class="panel-body">
  <div class="depgraph"><?xml version="1.0" encoding="UTF-8" standalone="no"?>
<!DOCTYPE svg PUBLIC "-//W3C//DTD SVG 1.1//EN"
 "http://www.w3.org/Graphics/SVG/1.1/DTD/svg11.dtd">
<!-- Generated by graphviz version 2.40.1 (20161225.0304)
 -->
<!-- Title: sourcefile~~modeb.f90~~EfferentGraph Pages: 1 -->
<svg id="sourcefilemodebf90EfferentGraph" width="416pt" height="148pt"
 viewBox="0.00 0.00 416.00 148.11" xmlns="http://www.w3.org/2000/svg" xmlns:xlink="http://www.w3.org/1999/xlink">
<g id="sourcefile~~modeb.f90~~EfferentGraph" class="graph" transform="scale(1 1) rotate(0) translate(4 144.1085)">
<title>sourcefile~~modeb.f90~~EfferentGraph</title>
<polygon fill="#ffffff" stroke="transparent" points="-4,4 -4,-144.1085 412,-144.1085 412,4 -4,4"/>
<!-- sourcefile~modeb.f90 -->
<g id="sourcefile~~modeb.f90~~EfferentGraph_node1" class="node">
<title>sourcefile~modeb.f90</title>
<polygon fill="none" stroke="#000000" points="408,-84 343,-84 343,-60 408,-60 408,-84"/>
<text text-anchor="middle" x="375.5" y="-69.6" font-family="Helvetica,sans-Serif" font-size="10.50" fill="#000000">modEB.f90</text>
</g>
<!-- sourcefile~modglobal.f90 -->
<g id="sourcefile~~modeb.f90~~EfferentGraph_node2" class="node">
<title>sourcefile~modglobal.f90</title>
<g id="a_sourcefile~~modeb.f90~~EfferentGraph_node2"><a xlink:href=".././sourcefile/modglobal.f90.html" xlink:title="modglobal.f90">
<polygon fill="#f0ad4e" stroke="#f0ad4e" points="185,-64 105,-64 105,-40 185,-40 185,-64"/>
<text text-anchor="middle" x="145" y="-49.6" font-family="Helvetica,sans-Serif" font-size="10.50" fill="#ffffff">modglobal.f90</text>
</a>
</g>
</g>
<!-- sourcefile~modeb.f90&#45;&gt;sourcefile~modglobal.f90 -->
<g id="sourcefile~~modeb.f90~~EfferentGraph_edge1" class="edge">
<title>sourcefile~modeb.f90&#45;&gt;sourcefile~modglobal.f90</title>
<path fill="none" stroke="#ff0000" stroke-dasharray="5,2" d="M342.9639,-69.1769C304.5109,-65.8404 240.0935,-60.2511 195.2232,-56.3578"/>
<polygon fill="#ff0000" stroke="#ff0000" points="195.3802,-52.8583 185.1151,-55.4807 194.775,-59.8321 195.3802,-52.8583"/>
</g>
<!-- sourcefile~modmpi.f90 -->
<g id="sourcefile~~modeb.f90~~EfferentGraph_node3" class="node">
<title>sourcefile~modmpi.f90</title>
<g id="a_sourcefile~~modeb.f90~~EfferentGraph_node3"><a xlink:href=".././sourcefile/modmpi.f90.html" xlink:title="modmpi.f90">
<polygon fill="#f0ad4e" stroke="#f0ad4e" points="69,-64 0,-64 0,-40 69,-40 69,-64"/>
<text text-anchor="middle" x="34.5" y="-49.6" font-family="Helvetica,sans-Serif" font-size="10.50" fill="#ffffff">modmpi.f90</text>
</a>
</g>
</g>
<!-- sourcefile~modeb.f90&#45;&gt;sourcefile~modmpi.f90 -->
<g id="sourcefile~~modeb.f90~~EfferentGraph_edge2" class="edge">
<title>sourcefile~modeb.f90&#45;&gt;sourcefile~modmpi.f90</title>
<path fill="none" stroke="#ff0000" stroke-dasharray="5,2" d="M359.8491,-84.0132C346.5476,-93.5487 326.5499,-106.3463 307,-113 238.3723,-136.3571 215.5834,-148.5315 145,-132"/>
</g>
<!-- sourcefile~initfac.f90 -->
<g id="sourcefile~~modeb.f90~~EfferentGraph_node4" class="node">
<title>sourcefile~initfac.f90</title>
<g id="a_sourcefile~~modeb.f90~~EfferentGraph_node4"><a xlink:href=".././sourcefile/initfac.f90.html" xlink:title="initfac.f90">
<polygon fill="#f0ad4e" stroke="#f0ad4e" points="293,-104 235,-104 235,-80 293,-80 293,-104"/>
<text text-anchor="middle" x="264" y="-89.6" font-family="Helvetica,sans-Serif" font-size="10.50" fill="#ffffff">initfac.f90</text>
</a>
</g>
</g>
<!-- sourcefile~modeb.f90&#45;&gt;sourcefile~initfac.f90 -->
<g id="sourcefile~~modeb.f90~~EfferentGraph_edge3" class="edge">
<title>sourcefile~modeb.f90&#45;&gt;sourcefile~initfac.f90</title>
<path fill="none" stroke="#ff0000" stroke-dasharray="5,2" d="M342.9498,-77.8386C330.5742,-80.0584 316.3421,-82.6113 303.3997,-84.9328"/>
<polygon fill="#ff0000" stroke="#ff0000" points="302.5818,-81.5236 293.3568,-86.7342 303.8177,-88.4136 302.5818,-81.5236"/>
</g>
<!-- sourcefile~modstat_nc.f90 -->
<g id="sourcefile~~modeb.f90~~EfferentGraph_node5" class="node">
<title>sourcefile~modstat_nc.f90</title>
<g id="a_sourcefile~~modeb.f90~~EfferentGraph_node5"><a xlink:href=".././sourcefile/modstat_nc.f90.html" xlink:title="modstat_nc.f90">
<polygon fill="#f0ad4e" stroke="#f0ad4e" points="307,-24 221,-24 221,0 307,0 307,-24"/>
<text text-anchor="middle" x="264" y="-9.6" font-family="Helvetica,sans-Serif" font-size="10.50" fill="#ffffff">modstat_nc.f90</text>
</a>
</g>
</g>
<!-- sourcefile~modeb.f90&#45;&gt;sourcefile~modstat_nc.f90 -->
<g id="sourcefile~~modeb.f90~~EfferentGraph_edge4" class="edge">
<title>sourcefile~modeb.f90&#45;&gt;sourcefile~modstat_nc.f90</title>
<path fill="none" stroke="#ff0000" stroke-dasharray="5,2" d="M352.9363,-59.8581C336.3875,-50.9529 313.7048,-38.747 295.3889,-28.8909"/>
<polygon fill="#ff0000" stroke="#ff0000" points="296.9947,-25.7804 286.5301,-24.1238 293.6776,-31.9446 296.9947,-25.7804"/>
</g>
<!-- sourcefile~modglobal.f90&#45;&gt;sourcefile~modmpi.f90 -->
<g id="sourcefile~~modeb.f90~~EfferentGraph_edge5" class="edge">
<title>sourcefile~modglobal.f90&#45;&gt;sourcefile~modmpi.f90</title>
<path fill="none" stroke="#ff0000" stroke-dasharray="5,2" d="M104.7944,-52C96.4589,-52 87.6289,-52 79.1455,-52"/>
<polygon fill="#ff0000" stroke="#ff0000" points="79.0261,-48.5001 69.0261,-52 79.0261,-55.5001 79.0261,-48.5001"/>
</g>
<!-- sourcefile~initfac.f90&#45;&gt;sourcefile~modglobal.f90 -->
<g id="sourcefile~~modeb.f90~~EfferentGraph_edge6" class="edge">
<title>sourcefile~initfac.f90&#45;&gt;sourcefile~modglobal.f90</title>
<path fill="none" stroke="#00ffff" stroke-dasharray="5,2" d="M234.8893,-82.2149C221.5685,-77.7373 205.4698,-72.326 190.5984,-67.3272"/>
<polygon fill="#00ffff" stroke="#00ffff" points="191.6386,-63.9844 181.0445,-64.1158 189.4082,-70.6196 191.6386,-63.9844"/>
</g>
<!-- sourcefile~initfac.f90&#45;&gt;sourcefile~modmpi.f90 -->
<g id="sourcefile~~modeb.f90~~EfferentGraph_edge7" class="edge">
<title>sourcefile~initfac.f90&#45;&gt;sourcefile~modmpi.f90</title>
<path fill="none" stroke="#00ffff" stroke-dasharray="5,2" d="M238.5827,-104.057C209.3223,-117.3111 162.9851,-136.2123 145,-132"/>
<path fill="none" stroke="#00ffff" stroke-dasharray="5,2" d="M145,-132C106.7629,-123.0444 71.7004,-92.1269 51.742,-71.4551"/>
<polygon fill="#00ffff" stroke="#00ffff" points="54.2466,-69.0093 44.8571,-64.1013 49.1366,-73.7934 54.2466,-69.0093"/>
</g>
<!-- sourcefile~modstat_nc.f90&#45;&gt;sourcefile~modglobal.f90 -->
<g id="sourcefile~~modeb.f90~~EfferentGraph_edge8" class="edge">
<title>sourcefile~modstat_nc.f90&#45;&gt;sourcefile~modglobal.f90</title>
<path fill="none" stroke="#7f00ff" stroke-dasharray="5,2" d="M228.2961,-24.0013C216.5197,-27.9598 203.2542,-32.4187 190.8296,-36.5951"/>
<polygon fill="#7f00ff" stroke="#7f00ff" points="189.4537,-33.3651 181.09,-39.8689 191.684,-40.0003 189.4537,-33.3651"/>
</g>
<!-- sourcefile~modstat_nc.f90&#45;&gt;sourcefile~modmpi.f90 -->
<g id="sourcefile~~modeb.f90~~EfferentGraph_edge9" class="edge">
<title>sourcefile~modstat_nc.f90&#45;&gt;sourcefile~modmpi.f90</title>
<path fill="none" stroke="#7f00ff" stroke-dasharray="5,2" d="M220.8271,-15.1549C188.6641,-17.9888 143.7926,-22.9658 105,-31 96.5509,-32.7499 87.651,-35.0388 79.1268,-37.4603"/>
<polygon fill="#7f00ff" stroke="#7f00ff" points="77.9475,-34.1589 69.3423,-40.3396 79.9236,-40.8742 77.9475,-34.1589"/>
</g>
</g>
</svg>
</div><div><a type="button" class="graph-help" data-toggle="modal" href="#graph-help-text">Help</a></div><div class="modal fade" id="graph-help-text" tabindex="-1" role="dialog"><div class="modal-dialog modal-lg" role="document"><div class="modal-content"><div class="modal-header"><button type="button" class="close" data-dismiss="modal" aria-label="Close"><span aria-hidden="true">&times;</span></button><h4 class="modal-title" id="-graph-help-label">Graph Key</h4></div><div class="modal-body">
    <p>Nodes of different colours represent the following: </p>
    <?xml version="1.0" encoding="UTF-8" standalone="no"?>
<!DOCTYPE svg PUBLIC "-//W3C//DTD SVG 1.1//EN"
 "http://www.w3.org/Graphics/SVG/1.1/DTD/svg11.dtd">
<!-- Generated by graphviz version 2.40.1 (20161225.0304)
 -->
<!-- Title: Graph Key Pages: 1 -->
<svg width="190pt" height="32pt"
 viewBox="0.00 0.00 190.00 32.00" xmlns="http://www.w3.org/2000/svg" xmlns:xlink="http://www.w3.org/1999/xlink">
<g id="graph0" class="graph" transform="scale(1 1) rotate(0) translate(4 28)">
<title>Graph Key</title>
<polygon fill="#ffffff" stroke="transparent" points="-4,4 -4,-28 186,-28 186,4 -4,4"/>
<!-- Source File -->
<g id="node1" class="node">
<title>Source File</title>
<polygon fill="#f0ad4e" stroke="#f0ad4e" points="67,-24 0,-24 0,0 67,0 67,-24"/>
<text text-anchor="middle" x="33.5" y="-9.6" font-family="Helvetica,sans-Serif" font-size="10.50" fill="#ffffff">Source File</text>
</g>
<!-- This Page&#39;s Entity -->
<g id="node2" class="node">
<title>This Page&#39;s Entity</title>
<polygon fill="none" stroke="#000000" points="182,-24 85,-24 85,0 182,0 182,-24"/>
<text text-anchor="middle" x="133.5" y="-9.6" font-family="Helvetica,sans-Serif" font-size="10.50" fill="#000000">This Page&#39;s Entity</text>
</g>
</g>
</svg>

    
    <p>Solid arrows point from a file to a file which it depends on. A file
    is dependent upon another if the latter must be compiled before the former
    can be. Where possible, edges connecting nodes are given different colours to make them easier to distinguish in large graphs.
    </p>
    </div></div></div></div>
      </div>
    </div>
    
      
    <div class="panel panel-default">
      <div class="panel-heading">
  <h3 class="panel-title">Files dependent on this one</h3>
      </div>
      <div class="panel-body">
  <div class="depgraph"><?xml version="1.0" encoding="UTF-8" standalone="no"?>
<!DOCTYPE svg PUBLIC "-//W3C//DTD SVG 1.1//EN"
 "http://www.w3.org/Graphics/SVG/1.1/DTD/svg11.dtd">
<!-- Generated by graphviz version 2.40.1 (20161225.0304)
 -->
<!-- Title: sourcefile~~modeb.f90~~AfferentGraph Pages: 1 -->
<svg id="sourcefilemodebf90AfferentGraph" width="180pt" height="32pt"
 viewBox="0.00 0.00 180.00 32.00" xmlns="http://www.w3.org/2000/svg" xmlns:xlink="http://www.w3.org/1999/xlink">
<g id="sourcefile~~modeb.f90~~AfferentGraph" class="graph" transform="scale(1 1) rotate(0) translate(4 28)">
<title>sourcefile~~modeb.f90~~AfferentGraph</title>
<polygon fill="#ffffff" stroke="transparent" points="-4,4 -4,-28 176,-28 176,4 -4,4"/>
<!-- sourcefile~modeb.f90 -->
<g id="sourcefile~~modeb.f90~~AfferentGraph_node1" class="node">
<title>sourcefile~modeb.f90</title>
<polygon fill="none" stroke="#000000" points="65,-24 0,-24 0,0 65,0 65,-24"/>
<text text-anchor="middle" x="32.5" y="-9.6" font-family="Helvetica,sans-Serif" font-size="10.50" fill="#000000">modEB.f90</text>
</g>
<!-- sourcefile~program.f90 -->
<g id="sourcefile~~modeb.f90~~AfferentGraph_node2" class="node">
<title>sourcefile~program.f90</title>
<g id="a_sourcefile~~modeb.f90~~AfferentGraph_node2"><a xlink:href=".././sourcefile/program.f90.html" xlink:title="program.f90">
<polygon fill="#f0ad4e" stroke="#f0ad4e" points="172,-24 101,-24 101,0 172,0 172,-24"/>
<text text-anchor="middle" x="136.5" y="-9.6" font-family="Helvetica,sans-Serif" font-size="10.50" fill="#ffffff">program.f90</text>
</a>
</g>
</g>
<!-- sourcefile~program.f90&#45;&gt;sourcefile~modeb.f90 -->
<g id="sourcefile~~modeb.f90~~AfferentGraph_edge1" class="edge">
<title>sourcefile~program.f90&#45;&gt;sourcefile~modeb.f90</title>
<path fill="none" stroke="#ff0000" stroke-dasharray="5,2" d="M101,-12C92.7168,-12 83.8105,-12 75.2498,-12"/>
<polygon fill="#ff0000" stroke="#ff0000" points="75.0441,-8.5001 65.0441,-12 75.0441,-15.5001 75.0441,-8.5001"/>
</g>
</g>
</svg>
</div><div><a type="button" class="graph-help" data-toggle="modal" href="#graph-help-text">Help</a></div><div class="modal fade" id="graph-help-text" tabindex="-1" role="dialog"><div class="modal-dialog modal-lg" role="document"><div class="modal-content"><div class="modal-header"><button type="button" class="close" data-dismiss="modal" aria-label="Close"><span aria-hidden="true">&times;</span></button><h4 class="modal-title" id="-graph-help-label">Graph Key</h4></div><div class="modal-body">
    <p>Nodes of different colours represent the following: </p>
    <?xml version="1.0" encoding="UTF-8" standalone="no"?>
<!DOCTYPE svg PUBLIC "-//W3C//DTD SVG 1.1//EN"
 "http://www.w3.org/Graphics/SVG/1.1/DTD/svg11.dtd">
<!-- Generated by graphviz version 2.40.1 (20161225.0304)
 -->
<!-- Title: Graph Key Pages: 1 -->
<svg width="190pt" height="32pt"
 viewBox="0.00 0.00 190.00 32.00" xmlns="http://www.w3.org/2000/svg" xmlns:xlink="http://www.w3.org/1999/xlink">
<g id="graph0" class="graph" transform="scale(1 1) rotate(0) translate(4 28)">
<title>Graph Key</title>
<polygon fill="#ffffff" stroke="transparent" points="-4,4 -4,-28 186,-28 186,4 -4,4"/>
<!-- Source File -->
<g id="node1" class="node">
<title>Source File</title>
<polygon fill="#f0ad4e" stroke="#f0ad4e" points="67,-24 0,-24 0,0 67,0 67,-24"/>
<text text-anchor="middle" x="33.5" y="-9.6" font-family="Helvetica,sans-Serif" font-size="10.50" fill="#ffffff">Source File</text>
</g>
<!-- This Page&#39;s Entity -->
<g id="node2" class="node">
<title>This Page&#39;s Entity</title>
<polygon fill="none" stroke="#000000" points="182,-24 85,-24 85,0 182,0 182,-24"/>
<text text-anchor="middle" x="133.5" y="-9.6" font-family="Helvetica,sans-Serif" font-size="10.50" fill="#000000">This Page&#39;s Entity</text>
</g>
</g>
</svg>

    
    <p>Solid arrows point from a file to a file which it depends on. A file
    is dependent upon another if the latter must be compiled before the former
    can be. Where possible, edges connecting nodes are given different colours to make them easier to distinguish in large graphs.
    </p>
    </div></div></div></div>
      </div>
    </div>
      
      <br>

    <section class="visible-xs visible-sm hidden-md">
      
<h3>Contents</h3>
 







<div class="panel panel-primary">
  <div class="panel-heading text-left"><h3 class="panel-title"><a data-toggle="collapse" href="#mods-1">Modules</a></h3></div>
  <div id="mods-1" class="panel-collapse collapse">
    <div class="list-group">
      
      <a class="list-group-item" href="../module/modeb.html">modEB</a>
      
    </div>
  </div>
</div>
















<div class="panel panel-primary">
  <div class="panel-heading text-left"><h3 class="panel-title">Source Code</h3></div>
  <div class="list-group">
    <a class="list-group-item" href="../sourcefile/modeb.f90.html#src">modEB.f90</a>
  </div>
</div>



    </section>
    <br class="visible-xs visible-sm hidden-md">

    <section>
      <h2><span class="anchor" id="src"></span>Source Code</h2>
    <div class="hl"><pre><span></span><a name="ln-1"></a><span class="c">!!&gt; \file modEB.f90</span>
<a name="ln-2"></a><span class="c">!!!  Energy balance on facets</span>
<a name="ln-3"></a><span class="c">!</span>
<a name="ln-4"></a><span class="c">!&gt;</span>
<a name="ln-5"></a><span class="c">!!  \author Ivo Suter</span>
<a name="ln-6"></a><span class="c">!</span>
<a name="ln-7"></a><span class="c">!</span>
<a name="ln-8"></a><span class="k">module </span><span class="n">modEB</span>
<a name="ln-9"></a>   <span class="k">use </span><span class="n">modglobal</span>
<a name="ln-10"></a>
<a name="ln-11"></a>   <span class="k">implicit none</span>
<a name="ln-12"></a><span class="k">   public</span> <span class="kd">::</span> <span class="n">EB</span><span class="p">,</span> <span class="n">initEB</span><span class="p">,</span> <span class="n">intqH</span><span class="p">,</span> <span class="n">updateGR</span>
<a name="ln-13"></a>
<a name="ln-14"></a>   <span class="kt">integer</span> <span class="kd">::</span> <span class="n">nstatT</span><span class="o">=</span><span class="mi">2</span><span class="p">,</span> <span class="n">nstatEB</span><span class="o">=</span><span class="mi">5</span><span class="p">,</span> <span class="n">ncidT</span><span class="p">,</span> <span class="n">ncidEB</span><span class="p">,</span> <span class="n">nrecT</span><span class="o">=</span><span class="mi">0</span><span class="p">,</span> <span class="n">nrecEB</span><span class="o">=</span><span class="mi">0</span>
<a name="ln-15"></a>   <span class="kt">character</span><span class="p">(</span><span class="mi">80</span><span class="p">),</span> <span class="k">allocatable</span> <span class="kd">::</span> <span class="n">ncstatT</span><span class="p">(:,:),</span> <span class="n">ncstatEB</span><span class="p">(:,:)</span>
<a name="ln-16"></a>   <span class="kt">character</span><span class="p">(</span><span class="mi">80</span><span class="p">)</span> <span class="kd">::</span> <span class="n">Tname</span> <span class="o">=</span> <span class="s2">&quot;facT.xxx.nc&quot;</span><span class="p">,</span> <span class="n">EBname</span> <span class="o">=</span> <span class="s1">&#39;facEB.xxx.nc&#39;</span>
<a name="ln-17"></a>   <span class="kt">character</span><span class="p">(</span><span class="mi">80</span><span class="p">),</span><span class="k">dimension</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span><span class="mi">4</span><span class="p">)</span> <span class="kd">::</span> <span class="n">tncstatT</span><span class="p">,</span> <span class="n">tncstatEB</span>
<a name="ln-18"></a>   <span class="kt">real</span><span class="p">,</span> <span class="k">allocatable</span> <span class="kd">::</span> <span class="n">varsT</span><span class="p">(:,:,:),</span> <span class="n">varsEB</span><span class="p">(:,:)</span>
<a name="ln-19"></a>   
<a name="ln-20"></a>   <span class="k">save</span>
<a name="ln-21"></a>
<a name="ln-22"></a><span class="k">contains</span>
<a name="ln-23"></a><span class="c">!functions to invert matrices</span>
<a name="ln-24"></a>   <span class="k">pure function </span><span class="n">matinv3</span><span class="p">(</span><span class="n">A</span><span class="p">)</span> <span class="k">result</span><span class="p">(</span><span class="n">B</span><span class="p">)</span> <span class="c">!pure makes sure that no variable outside the function can possibly be changed</span>
<a name="ln-25"></a>      <span class="c">!! calculates the inverse of a 3×3 matrix.</span>
<a name="ln-26"></a>      <span class="kt">real</span><span class="p">,</span> <span class="k">intent</span><span class="p">(</span><span class="n">in</span><span class="p">)</span> <span class="kd">::</span> <span class="n">A</span><span class="p">(</span><span class="mi">3</span><span class="p">,</span> <span class="mi">3</span><span class="p">)</span> <span class="c">!! matrix</span>
<a name="ln-27"></a>      <span class="kt">real</span>             <span class="kd">::</span> <span class="n">B</span><span class="p">(</span><span class="mi">3</span><span class="p">,</span> <span class="mi">3</span><span class="p">)</span> <span class="c">!! inverse matrix</span>
<a name="ln-28"></a>      <span class="kt">real</span>             <span class="kd">::</span> <span class="n">detinv</span>
<a name="ln-29"></a>
<a name="ln-30"></a>      <span class="c">!inverse determinant of the matrix</span>
<a name="ln-31"></a>      <span class="n">detinv</span> <span class="o">=</span> <span class="mi">1</span><span class="o">/</span><span class="p">(</span><span class="n">A</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span> <span class="mi">1</span><span class="p">)</span><span class="o">*</span><span class="n">A</span><span class="p">(</span><span class="mi">2</span><span class="p">,</span> <span class="mi">2</span><span class="p">)</span><span class="o">*</span><span class="n">A</span><span class="p">(</span><span class="mi">3</span><span class="p">,</span> <span class="mi">3</span><span class="p">)</span> <span class="o">-</span> <span class="n">A</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span> <span class="mi">1</span><span class="p">)</span><span class="o">*</span><span class="n">A</span><span class="p">(</span><span class="mi">2</span><span class="p">,</span> <span class="mi">3</span><span class="p">)</span><span class="o">*</span><span class="n">A</span><span class="p">(</span><span class="mi">3</span><span class="p">,</span> <span class="mi">2</span><span class="p">)</span> <span class="p">&amp;</span>
<a name="ln-32"></a>                  <span class="o">-</span> <span class="n">A</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span> <span class="mi">2</span><span class="p">)</span><span class="o">*</span><span class="n">A</span><span class="p">(</span><span class="mi">2</span><span class="p">,</span> <span class="mi">1</span><span class="p">)</span><span class="o">*</span><span class="n">A</span><span class="p">(</span><span class="mi">3</span><span class="p">,</span> <span class="mi">3</span><span class="p">)</span> <span class="o">+</span> <span class="n">A</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span> <span class="mi">2</span><span class="p">)</span><span class="o">*</span><span class="n">A</span><span class="p">(</span><span class="mi">2</span><span class="p">,</span> <span class="mi">3</span><span class="p">)</span><span class="o">*</span><span class="n">A</span><span class="p">(</span><span class="mi">3</span><span class="p">,</span> <span class="mi">1</span><span class="p">)</span> <span class="p">&amp;</span>
<a name="ln-33"></a>                  <span class="o">+</span> <span class="n">A</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span> <span class="mi">3</span><span class="p">)</span><span class="o">*</span><span class="n">A</span><span class="p">(</span><span class="mi">2</span><span class="p">,</span> <span class="mi">1</span><span class="p">)</span><span class="o">*</span><span class="n">A</span><span class="p">(</span><span class="mi">3</span><span class="p">,</span> <span class="mi">2</span><span class="p">)</span> <span class="o">-</span> <span class="n">A</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span> <span class="mi">3</span><span class="p">)</span><span class="o">*</span><span class="n">A</span><span class="p">(</span><span class="mi">2</span><span class="p">,</span> <span class="mi">2</span><span class="p">)</span><span class="o">*</span><span class="n">A</span><span class="p">(</span><span class="mi">3</span><span class="p">,</span> <span class="mi">1</span><span class="p">))</span>
<a name="ln-34"></a>
<a name="ln-35"></a>      <span class="c">!inverse of the matrix</span>
<a name="ln-36"></a>      <span class="n">B</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span> <span class="mi">1</span><span class="p">)</span> <span class="o">=</span> <span class="o">+</span><span class="n">detinv</span><span class="o">*</span><span class="p">(</span><span class="n">A</span><span class="p">(</span><span class="mi">2</span><span class="p">,</span> <span class="mi">2</span><span class="p">)</span><span class="o">*</span><span class="n">A</span><span class="p">(</span><span class="mi">3</span><span class="p">,</span> <span class="mi">3</span><span class="p">)</span> <span class="o">-</span> <span class="n">A</span><span class="p">(</span><span class="mi">2</span><span class="p">,</span> <span class="mi">3</span><span class="p">)</span><span class="o">*</span><span class="n">A</span><span class="p">(</span><span class="mi">3</span><span class="p">,</span> <span class="mi">2</span><span class="p">))</span>
<a name="ln-37"></a>      <span class="n">B</span><span class="p">(</span><span class="mi">2</span><span class="p">,</span> <span class="mi">1</span><span class="p">)</span> <span class="o">=</span> <span class="o">-</span><span class="n">detinv</span><span class="o">*</span><span class="p">(</span><span class="n">A</span><span class="p">(</span><span class="mi">2</span><span class="p">,</span> <span class="mi">1</span><span class="p">)</span><span class="o">*</span><span class="n">A</span><span class="p">(</span><span class="mi">3</span><span class="p">,</span> <span class="mi">3</span><span class="p">)</span> <span class="o">-</span> <span class="n">A</span><span class="p">(</span><span class="mi">2</span><span class="p">,</span> <span class="mi">3</span><span class="p">)</span><span class="o">*</span><span class="n">A</span><span class="p">(</span><span class="mi">3</span><span class="p">,</span> <span class="mi">1</span><span class="p">))</span>
<a name="ln-38"></a>      <span class="n">B</span><span class="p">(</span><span class="mi">3</span><span class="p">,</span> <span class="mi">1</span><span class="p">)</span> <span class="o">=</span> <span class="o">+</span><span class="n">detinv</span><span class="o">*</span><span class="p">(</span><span class="n">A</span><span class="p">(</span><span class="mi">2</span><span class="p">,</span> <span class="mi">1</span><span class="p">)</span><span class="o">*</span><span class="n">A</span><span class="p">(</span><span class="mi">3</span><span class="p">,</span> <span class="mi">2</span><span class="p">)</span> <span class="o">-</span> <span class="n">A</span><span class="p">(</span><span class="mi">2</span><span class="p">,</span> <span class="mi">2</span><span class="p">)</span><span class="o">*</span><span class="n">A</span><span class="p">(</span><span class="mi">3</span><span class="p">,</span> <span class="mi">1</span><span class="p">))</span>
<a name="ln-39"></a>      <span class="n">B</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span> <span class="mi">2</span><span class="p">)</span> <span class="o">=</span> <span class="o">-</span><span class="n">detinv</span><span class="o">*</span><span class="p">(</span><span class="n">A</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span> <span class="mi">2</span><span class="p">)</span><span class="o">*</span><span class="n">A</span><span class="p">(</span><span class="mi">3</span><span class="p">,</span> <span class="mi">3</span><span class="p">)</span> <span class="o">-</span> <span class="n">A</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span> <span class="mi">3</span><span class="p">)</span><span class="o">*</span><span class="n">A</span><span class="p">(</span><span class="mi">3</span><span class="p">,</span> <span class="mi">2</span><span class="p">))</span>
<a name="ln-40"></a>      <span class="n">B</span><span class="p">(</span><span class="mi">2</span><span class="p">,</span> <span class="mi">2</span><span class="p">)</span> <span class="o">=</span> <span class="o">+</span><span class="n">detinv</span><span class="o">*</span><span class="p">(</span><span class="n">A</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span> <span class="mi">1</span><span class="p">)</span><span class="o">*</span><span class="n">A</span><span class="p">(</span><span class="mi">3</span><span class="p">,</span> <span class="mi">3</span><span class="p">)</span> <span class="o">-</span> <span class="n">A</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span> <span class="mi">3</span><span class="p">)</span><span class="o">*</span><span class="n">A</span><span class="p">(</span><span class="mi">3</span><span class="p">,</span> <span class="mi">1</span><span class="p">))</span>
<a name="ln-41"></a>      <span class="n">B</span><span class="p">(</span><span class="mi">3</span><span class="p">,</span> <span class="mi">2</span><span class="p">)</span> <span class="o">=</span> <span class="o">-</span><span class="n">detinv</span><span class="o">*</span><span class="p">(</span><span class="n">A</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span> <span class="mi">1</span><span class="p">)</span><span class="o">*</span><span class="n">A</span><span class="p">(</span><span class="mi">3</span><span class="p">,</span> <span class="mi">2</span><span class="p">)</span> <span class="o">-</span> <span class="n">A</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span> <span class="mi">2</span><span class="p">)</span><span class="o">*</span><span class="n">A</span><span class="p">(</span><span class="mi">3</span><span class="p">,</span> <span class="mi">1</span><span class="p">))</span>
<a name="ln-42"></a>      <span class="n">B</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span> <span class="mi">3</span><span class="p">)</span> <span class="o">=</span> <span class="o">+</span><span class="n">detinv</span><span class="o">*</span><span class="p">(</span><span class="n">A</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span> <span class="mi">2</span><span class="p">)</span><span class="o">*</span><span class="n">A</span><span class="p">(</span><span class="mi">2</span><span class="p">,</span> <span class="mi">3</span><span class="p">)</span> <span class="o">-</span> <span class="n">A</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span> <span class="mi">3</span><span class="p">)</span><span class="o">*</span><span class="n">A</span><span class="p">(</span><span class="mi">2</span><span class="p">,</span> <span class="mi">2</span><span class="p">))</span>
<a name="ln-43"></a>      <span class="n">B</span><span class="p">(</span><span class="mi">2</span><span class="p">,</span> <span class="mi">3</span><span class="p">)</span> <span class="o">=</span> <span class="o">-</span><span class="n">detinv</span><span class="o">*</span><span class="p">(</span><span class="n">A</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span> <span class="mi">1</span><span class="p">)</span><span class="o">*</span><span class="n">A</span><span class="p">(</span><span class="mi">2</span><span class="p">,</span> <span class="mi">3</span><span class="p">)</span> <span class="o">-</span> <span class="n">A</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span> <span class="mi">3</span><span class="p">)</span><span class="o">*</span><span class="n">A</span><span class="p">(</span><span class="mi">2</span><span class="p">,</span> <span class="mi">1</span><span class="p">))</span>
<a name="ln-44"></a>      <span class="n">B</span><span class="p">(</span><span class="mi">3</span><span class="p">,</span> <span class="mi">3</span><span class="p">)</span> <span class="o">=</span> <span class="o">+</span><span class="n">detinv</span><span class="o">*</span><span class="p">(</span><span class="n">A</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span> <span class="mi">1</span><span class="p">)</span><span class="o">*</span><span class="n">A</span><span class="p">(</span><span class="mi">2</span><span class="p">,</span> <span class="mi">2</span><span class="p">)</span> <span class="o">-</span> <span class="n">A</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span> <span class="mi">2</span><span class="p">)</span><span class="o">*</span><span class="n">A</span><span class="p">(</span><span class="mi">2</span><span class="p">,</span> <span class="mi">1</span><span class="p">))</span>
<a name="ln-45"></a>   <span class="k">end function</span>
<a name="ln-46"></a><span class="k">   pure function </span><span class="n">matinv4</span><span class="p">(</span><span class="n">A</span><span class="p">)</span> <span class="k">result</span><span class="p">(</span><span class="n">B</span><span class="p">)</span>
<a name="ln-47"></a>      <span class="c">!! calculates the inverse of a 4×4 matrix.</span>
<a name="ln-48"></a>      <span class="kt">real</span><span class="p">,</span> <span class="k">intent</span><span class="p">(</span><span class="n">in</span><span class="p">)</span> <span class="kd">::</span> <span class="n">A</span><span class="p">(</span><span class="mi">4</span><span class="p">,</span> <span class="mi">4</span><span class="p">)</span> <span class="c">!! matrix</span>
<a name="ln-49"></a>      <span class="kt">real</span>             <span class="kd">::</span> <span class="n">B</span><span class="p">(</span><span class="mi">4</span><span class="p">,</span> <span class="mi">4</span><span class="p">)</span> <span class="c">!! inverse matrix</span>
<a name="ln-50"></a>      <span class="kt">real</span>             <span class="kd">::</span> <span class="n">detinv</span>
<a name="ln-51"></a>
<a name="ln-52"></a>      <span class="c">!inverse determinant of the matrix</span>
<a name="ln-53"></a>      <span class="n">detinv</span> <span class="o">=</span> <span class="p">&amp;</span>
<a name="ln-54"></a>        <span class="mi">1</span><span class="o">/</span><span class="p">(</span><span class="n">A</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span><span class="mi">1</span><span class="p">)</span><span class="o">*</span><span class="p">(</span><span class="n">A</span><span class="p">(</span><span class="mi">2</span><span class="p">,</span><span class="mi">2</span><span class="p">)</span><span class="o">*</span><span class="p">(</span><span class="n">A</span><span class="p">(</span><span class="mi">3</span><span class="p">,</span><span class="mi">3</span><span class="p">)</span><span class="o">*</span><span class="n">A</span><span class="p">(</span><span class="mi">4</span><span class="p">,</span><span class="mi">4</span><span class="p">)</span><span class="o">-</span><span class="n">A</span><span class="p">(</span><span class="mi">3</span><span class="p">,</span><span class="mi">4</span><span class="p">)</span><span class="o">*</span><span class="n">A</span><span class="p">(</span><span class="mi">4</span><span class="p">,</span><span class="mi">3</span><span class="p">))</span><span class="o">+</span><span class="n">A</span><span class="p">(</span><span class="mi">2</span><span class="p">,</span><span class="mi">3</span><span class="p">)</span><span class="o">*</span><span class="p">(</span><span class="n">A</span><span class="p">(</span><span class="mi">3</span><span class="p">,</span><span class="mi">4</span><span class="p">)</span><span class="o">*</span><span class="n">A</span><span class="p">(</span><span class="mi">4</span><span class="p">,</span><span class="mi">2</span><span class="p">)</span><span class="o">-</span><span class="n">A</span><span class="p">(</span><span class="mi">3</span><span class="p">,</span><span class="mi">2</span><span class="p">)</span><span class="o">*</span><span class="n">A</span><span class="p">(</span><span class="mi">4</span><span class="p">,</span><span class="mi">4</span><span class="p">))</span><span class="o">+</span><span class="n">A</span><span class="p">(</span><span class="mi">2</span><span class="p">,</span><span class="mi">4</span><span class="p">)</span><span class="o">*</span><span class="p">(</span><span class="n">A</span><span class="p">(</span><span class="mi">3</span><span class="p">,</span><span class="mi">2</span><span class="p">)</span><span class="o">*</span><span class="n">A</span><span class="p">(</span><span class="mi">4</span><span class="p">,</span><span class="mi">3</span><span class="p">)</span><span class="o">-</span><span class="n">A</span><span class="p">(</span><span class="mi">3</span><span class="p">,</span><span class="mi">3</span><span class="p">)</span><span class="o">*</span><span class="n">A</span><span class="p">(</span><span class="mi">4</span><span class="p">,</span><span class="mi">2</span><span class="p">)))&amp;</span>
<a name="ln-55"></a>           <span class="o">-</span> <span class="n">A</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span><span class="mi">2</span><span class="p">)</span><span class="o">*</span><span class="p">(</span><span class="n">A</span><span class="p">(</span><span class="mi">2</span><span class="p">,</span><span class="mi">1</span><span class="p">)</span><span class="o">*</span><span class="p">(</span><span class="n">A</span><span class="p">(</span><span class="mi">3</span><span class="p">,</span><span class="mi">3</span><span class="p">)</span><span class="o">*</span><span class="n">A</span><span class="p">(</span><span class="mi">4</span><span class="p">,</span><span class="mi">4</span><span class="p">)</span><span class="o">-</span><span class="n">A</span><span class="p">(</span><span class="mi">3</span><span class="p">,</span><span class="mi">4</span><span class="p">)</span><span class="o">*</span><span class="n">A</span><span class="p">(</span><span class="mi">4</span><span class="p">,</span><span class="mi">3</span><span class="p">))</span><span class="o">+</span><span class="n">A</span><span class="p">(</span><span class="mi">2</span><span class="p">,</span><span class="mi">3</span><span class="p">)</span><span class="o">*</span><span class="p">(</span><span class="n">A</span><span class="p">(</span><span class="mi">3</span><span class="p">,</span><span class="mi">4</span><span class="p">)</span><span class="o">*</span><span class="n">A</span><span class="p">(</span><span class="mi">4</span><span class="p">,</span><span class="mi">1</span><span class="p">)</span><span class="o">-</span><span class="n">A</span><span class="p">(</span><span class="mi">3</span><span class="p">,</span><span class="mi">1</span><span class="p">)</span><span class="o">*</span><span class="n">A</span><span class="p">(</span><span class="mi">4</span><span class="p">,</span><span class="mi">4</span><span class="p">))</span><span class="o">+</span><span class="n">A</span><span class="p">(</span><span class="mi">2</span><span class="p">,</span><span class="mi">4</span><span class="p">)</span><span class="o">*</span><span class="p">(</span><span class="n">A</span><span class="p">(</span><span class="mi">3</span><span class="p">,</span><span class="mi">1</span><span class="p">)</span><span class="o">*</span><span class="n">A</span><span class="p">(</span><span class="mi">4</span><span class="p">,</span><span class="mi">3</span><span class="p">)</span><span class="o">-</span><span class="n">A</span><span class="p">(</span><span class="mi">3</span><span class="p">,</span><span class="mi">3</span><span class="p">)</span><span class="o">*</span><span class="n">A</span><span class="p">(</span><span class="mi">4</span><span class="p">,</span><span class="mi">1</span><span class="p">)))&amp;</span>
<a name="ln-56"></a>           <span class="o">+</span> <span class="n">A</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span><span class="mi">3</span><span class="p">)</span><span class="o">*</span><span class="p">(</span><span class="n">A</span><span class="p">(</span><span class="mi">2</span><span class="p">,</span><span class="mi">1</span><span class="p">)</span><span class="o">*</span><span class="p">(</span><span class="n">A</span><span class="p">(</span><span class="mi">3</span><span class="p">,</span><span class="mi">2</span><span class="p">)</span><span class="o">*</span><span class="n">A</span><span class="p">(</span><span class="mi">4</span><span class="p">,</span><span class="mi">4</span><span class="p">)</span><span class="o">-</span><span class="n">A</span><span class="p">(</span><span class="mi">3</span><span class="p">,</span><span class="mi">4</span><span class="p">)</span><span class="o">*</span><span class="n">A</span><span class="p">(</span><span class="mi">4</span><span class="p">,</span><span class="mi">2</span><span class="p">))</span><span class="o">+</span><span class="n">A</span><span class="p">(</span><span class="mi">2</span><span class="p">,</span><span class="mi">2</span><span class="p">)</span><span class="o">*</span><span class="p">(</span><span class="n">A</span><span class="p">(</span><span class="mi">3</span><span class="p">,</span><span class="mi">4</span><span class="p">)</span><span class="o">*</span><span class="n">A</span><span class="p">(</span><span class="mi">4</span><span class="p">,</span><span class="mi">1</span><span class="p">)</span><span class="o">-</span><span class="n">A</span><span class="p">(</span><span class="mi">3</span><span class="p">,</span><span class="mi">1</span><span class="p">)</span><span class="o">*</span><span class="n">A</span><span class="p">(</span><span class="mi">4</span><span class="p">,</span><span class="mi">4</span><span class="p">))</span><span class="o">+</span><span class="n">A</span><span class="p">(</span><span class="mi">2</span><span class="p">,</span><span class="mi">4</span><span class="p">)</span><span class="o">*</span><span class="p">(</span><span class="n">A</span><span class="p">(</span><span class="mi">3</span><span class="p">,</span><span class="mi">1</span><span class="p">)</span><span class="o">*</span><span class="n">A</span><span class="p">(</span><span class="mi">4</span><span class="p">,</span><span class="mi">2</span><span class="p">)</span><span class="o">-</span><span class="n">A</span><span class="p">(</span><span class="mi">3</span><span class="p">,</span><span class="mi">2</span><span class="p">)</span><span class="o">*</span><span class="n">A</span><span class="p">(</span><span class="mi">4</span><span class="p">,</span><span class="mi">1</span><span class="p">)))&amp;</span>
<a name="ln-57"></a>           <span class="o">-</span> <span class="n">A</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span><span class="mi">4</span><span class="p">)</span><span class="o">*</span><span class="p">(</span><span class="n">A</span><span class="p">(</span><span class="mi">2</span><span class="p">,</span><span class="mi">1</span><span class="p">)</span><span class="o">*</span><span class="p">(</span><span class="n">A</span><span class="p">(</span><span class="mi">3</span><span class="p">,</span><span class="mi">2</span><span class="p">)</span><span class="o">*</span><span class="n">A</span><span class="p">(</span><span class="mi">4</span><span class="p">,</span><span class="mi">3</span><span class="p">)</span><span class="o">-</span><span class="n">A</span><span class="p">(</span><span class="mi">3</span><span class="p">,</span><span class="mi">3</span><span class="p">)</span><span class="o">*</span><span class="n">A</span><span class="p">(</span><span class="mi">4</span><span class="p">,</span><span class="mi">2</span><span class="p">))</span><span class="o">+</span><span class="n">A</span><span class="p">(</span><span class="mi">2</span><span class="p">,</span><span class="mi">2</span><span class="p">)</span><span class="o">*</span><span class="p">(</span><span class="n">A</span><span class="p">(</span><span class="mi">3</span><span class="p">,</span><span class="mi">3</span><span class="p">)</span><span class="o">*</span><span class="n">A</span><span class="p">(</span><span class="mi">4</span><span class="p">,</span><span class="mi">1</span><span class="p">)</span><span class="o">-</span><span class="n">A</span><span class="p">(</span><span class="mi">3</span><span class="p">,</span><span class="mi">1</span><span class="p">)</span><span class="o">*</span><span class="n">A</span><span class="p">(</span><span class="mi">4</span><span class="p">,</span><span class="mi">3</span><span class="p">))</span><span class="o">+</span><span class="n">A</span><span class="p">(</span><span class="mi">2</span><span class="p">,</span><span class="mi">3</span><span class="p">)</span><span class="o">*</span><span class="p">(</span><span class="n">A</span><span class="p">(</span><span class="mi">3</span><span class="p">,</span><span class="mi">1</span><span class="p">)</span><span class="o">*</span><span class="n">A</span><span class="p">(</span><span class="mi">4</span><span class="p">,</span><span class="mi">2</span><span class="p">)</span><span class="o">-</span><span class="n">A</span><span class="p">(</span><span class="mi">3</span><span class="p">,</span><span class="mi">2</span><span class="p">)</span><span class="o">*</span><span class="n">A</span><span class="p">(</span><span class="mi">4</span><span class="p">,</span><span class="mi">1</span><span class="p">))))</span>
<a name="ln-58"></a>      <span class="c">!inverse of the matrix</span>
<a name="ln-59"></a>      <span class="n">B</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span><span class="mi">1</span><span class="p">)</span> <span class="o">=</span> <span class="n">detinv</span><span class="o">*</span><span class="p">(</span><span class="n">A</span><span class="p">(</span><span class="mi">2</span><span class="p">,</span><span class="mi">2</span><span class="p">)</span><span class="o">*</span><span class="p">(</span><span class="n">A</span><span class="p">(</span><span class="mi">3</span><span class="p">,</span><span class="mi">3</span><span class="p">)</span><span class="o">*</span><span class="n">A</span><span class="p">(</span><span class="mi">4</span><span class="p">,</span><span class="mi">4</span><span class="p">)</span><span class="o">-</span><span class="n">A</span><span class="p">(</span><span class="mi">3</span><span class="p">,</span><span class="mi">4</span><span class="p">)</span><span class="o">*</span><span class="n">A</span><span class="p">(</span><span class="mi">4</span><span class="p">,</span><span class="mi">3</span><span class="p">))</span><span class="o">+</span><span class="n">A</span><span class="p">(</span><span class="mi">2</span><span class="p">,</span><span class="mi">3</span><span class="p">)</span><span class="o">*</span><span class="p">(</span><span class="n">A</span><span class="p">(</span><span class="mi">3</span><span class="p">,</span><span class="mi">4</span><span class="p">)</span><span class="o">*</span><span class="n">A</span><span class="p">(</span><span class="mi">4</span><span class="p">,</span><span class="mi">2</span><span class="p">)</span><span class="o">-</span><span class="n">A</span><span class="p">(</span><span class="mi">3</span><span class="p">,</span><span class="mi">2</span><span class="p">)</span><span class="o">*</span><span class="n">A</span><span class="p">(</span><span class="mi">4</span><span class="p">,</span><span class="mi">4</span><span class="p">))</span><span class="o">+</span><span class="n">A</span><span class="p">(</span><span class="mi">2</span><span class="p">,</span><span class="mi">4</span><span class="p">)</span><span class="o">*</span><span class="p">(</span><span class="n">A</span><span class="p">(</span><span class="mi">3</span><span class="p">,</span><span class="mi">2</span><span class="p">)</span><span class="o">*</span><span class="n">A</span><span class="p">(</span><span class="mi">4</span><span class="p">,</span><span class="mi">3</span><span class="p">)</span><span class="o">-</span><span class="n">A</span><span class="p">(</span><span class="mi">3</span><span class="p">,</span><span class="mi">3</span><span class="p">)</span><span class="o">*</span><span class="n">A</span><span class="p">(</span><span class="mi">4</span><span class="p">,</span><span class="mi">2</span><span class="p">)))</span>
<a name="ln-60"></a>      <span class="n">B</span><span class="p">(</span><span class="mi">2</span><span class="p">,</span><span class="mi">1</span><span class="p">)</span> <span class="o">=</span> <span class="n">detinv</span><span class="o">*</span><span class="p">(</span><span class="n">A</span><span class="p">(</span><span class="mi">2</span><span class="p">,</span><span class="mi">1</span><span class="p">)</span><span class="o">*</span><span class="p">(</span><span class="n">A</span><span class="p">(</span><span class="mi">3</span><span class="p">,</span><span class="mi">4</span><span class="p">)</span><span class="o">*</span><span class="n">A</span><span class="p">(</span><span class="mi">4</span><span class="p">,</span><span class="mi">3</span><span class="p">)</span><span class="o">-</span><span class="n">A</span><span class="p">(</span><span class="mi">3</span><span class="p">,</span><span class="mi">3</span><span class="p">)</span><span class="o">*</span><span class="n">A</span><span class="p">(</span><span class="mi">4</span><span class="p">,</span><span class="mi">4</span><span class="p">))</span><span class="o">+</span><span class="n">A</span><span class="p">(</span><span class="mi">2</span><span class="p">,</span><span class="mi">3</span><span class="p">)</span><span class="o">*</span><span class="p">(</span><span class="n">A</span><span class="p">(</span><span class="mi">3</span><span class="p">,</span><span class="mi">1</span><span class="p">)</span><span class="o">*</span><span class="n">A</span><span class="p">(</span><span class="mi">4</span><span class="p">,</span><span class="mi">4</span><span class="p">)</span><span class="o">-</span><span class="n">A</span><span class="p">(</span><span class="mi">3</span><span class="p">,</span><span class="mi">4</span><span class="p">)</span><span class="o">*</span><span class="n">A</span><span class="p">(</span><span class="mi">4</span><span class="p">,</span><span class="mi">1</span><span class="p">))</span><span class="o">+</span><span class="n">A</span><span class="p">(</span><span class="mi">2</span><span class="p">,</span><span class="mi">4</span><span class="p">)</span><span class="o">*</span><span class="p">(</span><span class="n">A</span><span class="p">(</span><span class="mi">3</span><span class="p">,</span><span class="mi">3</span><span class="p">)</span><span class="o">*</span><span class="n">A</span><span class="p">(</span><span class="mi">4</span><span class="p">,</span><span class="mi">1</span><span class="p">)</span><span class="o">-</span><span class="n">A</span><span class="p">(</span><span class="mi">3</span><span class="p">,</span><span class="mi">1</span><span class="p">)</span><span class="o">*</span><span class="n">A</span><span class="p">(</span><span class="mi">4</span><span class="p">,</span><span class="mi">3</span><span class="p">)))</span>
<a name="ln-61"></a>      <span class="n">B</span><span class="p">(</span><span class="mi">3</span><span class="p">,</span><span class="mi">1</span><span class="p">)</span> <span class="o">=</span> <span class="n">detinv</span><span class="o">*</span><span class="p">(</span><span class="n">A</span><span class="p">(</span><span class="mi">2</span><span class="p">,</span><span class="mi">1</span><span class="p">)</span><span class="o">*</span><span class="p">(</span><span class="n">A</span><span class="p">(</span><span class="mi">3</span><span class="p">,</span><span class="mi">2</span><span class="p">)</span><span class="o">*</span><span class="n">A</span><span class="p">(</span><span class="mi">4</span><span class="p">,</span><span class="mi">4</span><span class="p">)</span><span class="o">-</span><span class="n">A</span><span class="p">(</span><span class="mi">3</span><span class="p">,</span><span class="mi">4</span><span class="p">)</span><span class="o">*</span><span class="n">A</span><span class="p">(</span><span class="mi">4</span><span class="p">,</span><span class="mi">2</span><span class="p">))</span><span class="o">+</span><span class="n">A</span><span class="p">(</span><span class="mi">2</span><span class="p">,</span><span class="mi">2</span><span class="p">)</span><span class="o">*</span><span class="p">(</span><span class="n">A</span><span class="p">(</span><span class="mi">3</span><span class="p">,</span><span class="mi">4</span><span class="p">)</span><span class="o">*</span><span class="n">A</span><span class="p">(</span><span class="mi">4</span><span class="p">,</span><span class="mi">1</span><span class="p">)</span><span class="o">-</span><span class="n">A</span><span class="p">(</span><span class="mi">3</span><span class="p">,</span><span class="mi">1</span><span class="p">)</span><span class="o">*</span><span class="n">A</span><span class="p">(</span><span class="mi">4</span><span class="p">,</span><span class="mi">4</span><span class="p">))</span><span class="o">+</span><span class="n">A</span><span class="p">(</span><span class="mi">2</span><span class="p">,</span><span class="mi">4</span><span class="p">)</span><span class="o">*</span><span class="p">(</span><span class="n">A</span><span class="p">(</span><span class="mi">3</span><span class="p">,</span><span class="mi">1</span><span class="p">)</span><span class="o">*</span><span class="n">A</span><span class="p">(</span><span class="mi">4</span><span class="p">,</span><span class="mi">2</span><span class="p">)</span><span class="o">-</span><span class="n">A</span><span class="p">(</span><span class="mi">3</span><span class="p">,</span><span class="mi">2</span><span class="p">)</span><span class="o">*</span><span class="n">A</span><span class="p">(</span><span class="mi">4</span><span class="p">,</span><span class="mi">1</span><span class="p">)))</span>
<a name="ln-62"></a>      <span class="n">B</span><span class="p">(</span><span class="mi">4</span><span class="p">,</span><span class="mi">1</span><span class="p">)</span> <span class="o">=</span> <span class="n">detinv</span><span class="o">*</span><span class="p">(</span><span class="n">A</span><span class="p">(</span><span class="mi">2</span><span class="p">,</span><span class="mi">1</span><span class="p">)</span><span class="o">*</span><span class="p">(</span><span class="n">A</span><span class="p">(</span><span class="mi">3</span><span class="p">,</span><span class="mi">3</span><span class="p">)</span><span class="o">*</span><span class="n">A</span><span class="p">(</span><span class="mi">4</span><span class="p">,</span><span class="mi">2</span><span class="p">)</span><span class="o">-</span><span class="n">A</span><span class="p">(</span><span class="mi">3</span><span class="p">,</span><span class="mi">2</span><span class="p">)</span><span class="o">*</span><span class="n">A</span><span class="p">(</span><span class="mi">4</span><span class="p">,</span><span class="mi">3</span><span class="p">))</span><span class="o">+</span><span class="n">A</span><span class="p">(</span><span class="mi">2</span><span class="p">,</span><span class="mi">2</span><span class="p">)</span><span class="o">*</span><span class="p">(</span><span class="n">A</span><span class="p">(</span><span class="mi">3</span><span class="p">,</span><span class="mi">1</span><span class="p">)</span><span class="o">*</span><span class="n">A</span><span class="p">(</span><span class="mi">4</span><span class="p">,</span><span class="mi">3</span><span class="p">)</span><span class="o">-</span><span class="n">A</span><span class="p">(</span><span class="mi">3</span><span class="p">,</span><span class="mi">3</span><span class="p">)</span><span class="o">*</span><span class="n">A</span><span class="p">(</span><span class="mi">4</span><span class="p">,</span><span class="mi">1</span><span class="p">))</span><span class="o">+</span><span class="n">A</span><span class="p">(</span><span class="mi">2</span><span class="p">,</span><span class="mi">3</span><span class="p">)</span><span class="o">*</span><span class="p">(</span><span class="n">A</span><span class="p">(</span><span class="mi">3</span><span class="p">,</span><span class="mi">2</span><span class="p">)</span><span class="o">*</span><span class="n">A</span><span class="p">(</span><span class="mi">4</span><span class="p">,</span><span class="mi">1</span><span class="p">)</span><span class="o">-</span><span class="n">A</span><span class="p">(</span><span class="mi">3</span><span class="p">,</span><span class="mi">1</span><span class="p">)</span><span class="o">*</span><span class="n">A</span><span class="p">(</span><span class="mi">4</span><span class="p">,</span><span class="mi">2</span><span class="p">)))</span>
<a name="ln-63"></a>      <span class="n">B</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span><span class="mi">2</span><span class="p">)</span> <span class="o">=</span> <span class="n">detinv</span><span class="o">*</span><span class="p">(</span><span class="n">A</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span><span class="mi">2</span><span class="p">)</span><span class="o">*</span><span class="p">(</span><span class="n">A</span><span class="p">(</span><span class="mi">3</span><span class="p">,</span><span class="mi">4</span><span class="p">)</span><span class="o">*</span><span class="n">A</span><span class="p">(</span><span class="mi">4</span><span class="p">,</span><span class="mi">3</span><span class="p">)</span><span class="o">-</span><span class="n">A</span><span class="p">(</span><span class="mi">3</span><span class="p">,</span><span class="mi">3</span><span class="p">)</span><span class="o">*</span><span class="n">A</span><span class="p">(</span><span class="mi">4</span><span class="p">,</span><span class="mi">4</span><span class="p">))</span><span class="o">+</span><span class="n">A</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span><span class="mi">3</span><span class="p">)</span><span class="o">*</span><span class="p">(</span><span class="n">A</span><span class="p">(</span><span class="mi">3</span><span class="p">,</span><span class="mi">2</span><span class="p">)</span><span class="o">*</span><span class="n">A</span><span class="p">(</span><span class="mi">4</span><span class="p">,</span><span class="mi">4</span><span class="p">)</span><span class="o">-</span><span class="n">A</span><span class="p">(</span><span class="mi">3</span><span class="p">,</span><span class="mi">4</span><span class="p">)</span><span class="o">*</span><span class="n">A</span><span class="p">(</span><span class="mi">4</span><span class="p">,</span><span class="mi">2</span><span class="p">))</span><span class="o">+</span><span class="n">A</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span><span class="mi">4</span><span class="p">)</span><span class="o">*</span><span class="p">(</span><span class="n">A</span><span class="p">(</span><span class="mi">3</span><span class="p">,</span><span class="mi">3</span><span class="p">)</span><span class="o">*</span><span class="n">A</span><span class="p">(</span><span class="mi">4</span><span class="p">,</span><span class="mi">2</span><span class="p">)</span><span class="o">-</span><span class="n">A</span><span class="p">(</span><span class="mi">3</span><span class="p">,</span><span class="mi">2</span><span class="p">)</span><span class="o">*</span><span class="n">A</span><span class="p">(</span><span class="mi">4</span><span class="p">,</span><span class="mi">3</span><span class="p">)))</span>
<a name="ln-64"></a>      <span class="n">B</span><span class="p">(</span><span class="mi">2</span><span class="p">,</span><span class="mi">2</span><span class="p">)</span> <span class="o">=</span> <span class="n">detinv</span><span class="o">*</span><span class="p">(</span><span class="n">A</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span><span class="mi">1</span><span class="p">)</span><span class="o">*</span><span class="p">(</span><span class="n">A</span><span class="p">(</span><span class="mi">3</span><span class="p">,</span><span class="mi">3</span><span class="p">)</span><span class="o">*</span><span class="n">A</span><span class="p">(</span><span class="mi">4</span><span class="p">,</span><span class="mi">4</span><span class="p">)</span><span class="o">-</span><span class="n">A</span><span class="p">(</span><span class="mi">3</span><span class="p">,</span><span class="mi">4</span><span class="p">)</span><span class="o">*</span><span class="n">A</span><span class="p">(</span><span class="mi">4</span><span class="p">,</span><span class="mi">3</span><span class="p">))</span><span class="o">+</span><span class="n">A</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span><span class="mi">3</span><span class="p">)</span><span class="o">*</span><span class="p">(</span><span class="n">A</span><span class="p">(</span><span class="mi">3</span><span class="p">,</span><span class="mi">4</span><span class="p">)</span><span class="o">*</span><span class="n">A</span><span class="p">(</span><span class="mi">4</span><span class="p">,</span><span class="mi">1</span><span class="p">)</span><span class="o">-</span><span class="n">A</span><span class="p">(</span><span class="mi">3</span><span class="p">,</span><span class="mi">1</span><span class="p">)</span><span class="o">*</span><span class="n">A</span><span class="p">(</span><span class="mi">4</span><span class="p">,</span><span class="mi">4</span><span class="p">))</span><span class="o">+</span><span class="n">A</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span><span class="mi">4</span><span class="p">)</span><span class="o">*</span><span class="p">(</span><span class="n">A</span><span class="p">(</span><span class="mi">3</span><span class="p">,</span><span class="mi">1</span><span class="p">)</span><span class="o">*</span><span class="n">A</span><span class="p">(</span><span class="mi">4</span><span class="p">,</span><span class="mi">3</span><span class="p">)</span><span class="o">-</span><span class="n">A</span><span class="p">(</span><span class="mi">3</span><span class="p">,</span><span class="mi">3</span><span class="p">)</span><span class="o">*</span><span class="n">A</span><span class="p">(</span><span class="mi">4</span><span class="p">,</span><span class="mi">1</span><span class="p">)))</span>
<a name="ln-65"></a>      <span class="n">B</span><span class="p">(</span><span class="mi">3</span><span class="p">,</span><span class="mi">2</span><span class="p">)</span> <span class="o">=</span> <span class="n">detinv</span><span class="o">*</span><span class="p">(</span><span class="n">A</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span><span class="mi">1</span><span class="p">)</span><span class="o">*</span><span class="p">(</span><span class="n">A</span><span class="p">(</span><span class="mi">3</span><span class="p">,</span><span class="mi">4</span><span class="p">)</span><span class="o">*</span><span class="n">A</span><span class="p">(</span><span class="mi">4</span><span class="p">,</span><span class="mi">2</span><span class="p">)</span><span class="o">-</span><span class="n">A</span><span class="p">(</span><span class="mi">3</span><span class="p">,</span><span class="mi">2</span><span class="p">)</span><span class="o">*</span><span class="n">A</span><span class="p">(</span><span class="mi">4</span><span class="p">,</span><span class="mi">4</span><span class="p">))</span><span class="o">+</span><span class="n">A</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span><span class="mi">2</span><span class="p">)</span><span class="o">*</span><span class="p">(</span><span class="n">A</span><span class="p">(</span><span class="mi">3</span><span class="p">,</span><span class="mi">1</span><span class="p">)</span><span class="o">*</span><span class="n">A</span><span class="p">(</span><span class="mi">4</span><span class="p">,</span><span class="mi">4</span><span class="p">)</span><span class="o">-</span><span class="n">A</span><span class="p">(</span><span class="mi">3</span><span class="p">,</span><span class="mi">4</span><span class="p">)</span><span class="o">*</span><span class="n">A</span><span class="p">(</span><span class="mi">4</span><span class="p">,</span><span class="mi">1</span><span class="p">))</span><span class="o">+</span><span class="n">A</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span><span class="mi">4</span><span class="p">)</span><span class="o">*</span><span class="p">(</span><span class="n">A</span><span class="p">(</span><span class="mi">3</span><span class="p">,</span><span class="mi">2</span><span class="p">)</span><span class="o">*</span><span class="n">A</span><span class="p">(</span><span class="mi">4</span><span class="p">,</span><span class="mi">1</span><span class="p">)</span><span class="o">-</span><span class="n">A</span><span class="p">(</span><span class="mi">3</span><span class="p">,</span><span class="mi">1</span><span class="p">)</span><span class="o">*</span><span class="n">A</span><span class="p">(</span><span class="mi">4</span><span class="p">,</span><span class="mi">2</span><span class="p">)))</span>
<a name="ln-66"></a>      <span class="n">B</span><span class="p">(</span><span class="mi">4</span><span class="p">,</span><span class="mi">2</span><span class="p">)</span> <span class="o">=</span> <span class="n">detinv</span><span class="o">*</span><span class="p">(</span><span class="n">A</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span><span class="mi">1</span><span class="p">)</span><span class="o">*</span><span class="p">(</span><span class="n">A</span><span class="p">(</span><span class="mi">3</span><span class="p">,</span><span class="mi">2</span><span class="p">)</span><span class="o">*</span><span class="n">A</span><span class="p">(</span><span class="mi">4</span><span class="p">,</span><span class="mi">3</span><span class="p">)</span><span class="o">-</span><span class="n">A</span><span class="p">(</span><span class="mi">3</span><span class="p">,</span><span class="mi">3</span><span class="p">)</span><span class="o">*</span><span class="n">A</span><span class="p">(</span><span class="mi">4</span><span class="p">,</span><span class="mi">2</span><span class="p">))</span><span class="o">+</span><span class="n">A</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span><span class="mi">2</span><span class="p">)</span><span class="o">*</span><span class="p">(</span><span class="n">A</span><span class="p">(</span><span class="mi">3</span><span class="p">,</span><span class="mi">3</span><span class="p">)</span><span class="o">*</span><span class="n">A</span><span class="p">(</span><span class="mi">4</span><span class="p">,</span><span class="mi">1</span><span class="p">)</span><span class="o">-</span><span class="n">A</span><span class="p">(</span><span class="mi">3</span><span class="p">,</span><span class="mi">1</span><span class="p">)</span><span class="o">*</span><span class="n">A</span><span class="p">(</span><span class="mi">4</span><span class="p">,</span><span class="mi">3</span><span class="p">))</span><span class="o">+</span><span class="n">A</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span><span class="mi">3</span><span class="p">)</span><span class="o">*</span><span class="p">(</span><span class="n">A</span><span class="p">(</span><span class="mi">3</span><span class="p">,</span><span class="mi">1</span><span class="p">)</span><span class="o">*</span><span class="n">A</span><span class="p">(</span><span class="mi">4</span><span class="p">,</span><span class="mi">2</span><span class="p">)</span><span class="o">-</span><span class="n">A</span><span class="p">(</span><span class="mi">3</span><span class="p">,</span><span class="mi">2</span><span class="p">)</span><span class="o">*</span><span class="n">A</span><span class="p">(</span><span class="mi">4</span><span class="p">,</span><span class="mi">1</span><span class="p">)))</span>
<a name="ln-67"></a>      <span class="n">B</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span><span class="mi">3</span><span class="p">)</span> <span class="o">=</span> <span class="n">detinv</span><span class="o">*</span><span class="p">(</span><span class="n">A</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span><span class="mi">2</span><span class="p">)</span><span class="o">*</span><span class="p">(</span><span class="n">A</span><span class="p">(</span><span class="mi">2</span><span class="p">,</span><span class="mi">3</span><span class="p">)</span><span class="o">*</span><span class="n">A</span><span class="p">(</span><span class="mi">4</span><span class="p">,</span><span class="mi">4</span><span class="p">)</span><span class="o">-</span><span class="n">A</span><span class="p">(</span><span class="mi">2</span><span class="p">,</span><span class="mi">4</span><span class="p">)</span><span class="o">*</span><span class="n">A</span><span class="p">(</span><span class="mi">4</span><span class="p">,</span><span class="mi">3</span><span class="p">))</span><span class="o">+</span><span class="n">A</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span><span class="mi">3</span><span class="p">)</span><span class="o">*</span><span class="p">(</span><span class="n">A</span><span class="p">(</span><span class="mi">2</span><span class="p">,</span><span class="mi">4</span><span class="p">)</span><span class="o">*</span><span class="n">A</span><span class="p">(</span><span class="mi">4</span><span class="p">,</span><span class="mi">2</span><span class="p">)</span><span class="o">-</span><span class="n">A</span><span class="p">(</span><span class="mi">2</span><span class="p">,</span><span class="mi">2</span><span class="p">)</span><span class="o">*</span><span class="n">A</span><span class="p">(</span><span class="mi">4</span><span class="p">,</span><span class="mi">4</span><span class="p">))</span><span class="o">+</span><span class="n">A</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span><span class="mi">4</span><span class="p">)</span><span class="o">*</span><span class="p">(</span><span class="n">A</span><span class="p">(</span><span class="mi">2</span><span class="p">,</span><span class="mi">2</span><span class="p">)</span><span class="o">*</span><span class="n">A</span><span class="p">(</span><span class="mi">4</span><span class="p">,</span><span class="mi">3</span><span class="p">)</span><span class="o">-</span><span class="n">A</span><span class="p">(</span><span class="mi">2</span><span class="p">,</span><span class="mi">3</span><span class="p">)</span><span class="o">*</span><span class="n">A</span><span class="p">(</span><span class="mi">4</span><span class="p">,</span><span class="mi">2</span><span class="p">)))</span>
<a name="ln-68"></a>      <span class="n">B</span><span class="p">(</span><span class="mi">2</span><span class="p">,</span><span class="mi">3</span><span class="p">)</span> <span class="o">=</span> <span class="n">detinv</span><span class="o">*</span><span class="p">(</span><span class="n">A</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span><span class="mi">1</span><span class="p">)</span><span class="o">*</span><span class="p">(</span><span class="n">A</span><span class="p">(</span><span class="mi">2</span><span class="p">,</span><span class="mi">4</span><span class="p">)</span><span class="o">*</span><span class="n">A</span><span class="p">(</span><span class="mi">4</span><span class="p">,</span><span class="mi">3</span><span class="p">)</span><span class="o">-</span><span class="n">A</span><span class="p">(</span><span class="mi">2</span><span class="p">,</span><span class="mi">3</span><span class="p">)</span><span class="o">*</span><span class="n">A</span><span class="p">(</span><span class="mi">4</span><span class="p">,</span><span class="mi">4</span><span class="p">))</span><span class="o">+</span><span class="n">A</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span><span class="mi">3</span><span class="p">)</span><span class="o">*</span><span class="p">(</span><span class="n">A</span><span class="p">(</span><span class="mi">2</span><span class="p">,</span><span class="mi">1</span><span class="p">)</span><span class="o">*</span><span class="n">A</span><span class="p">(</span><span class="mi">4</span><span class="p">,</span><span class="mi">4</span><span class="p">)</span><span class="o">-</span><span class="n">A</span><span class="p">(</span><span class="mi">2</span><span class="p">,</span><span class="mi">4</span><span class="p">)</span><span class="o">*</span><span class="n">A</span><span class="p">(</span><span class="mi">4</span><span class="p">,</span><span class="mi">1</span><span class="p">))</span><span class="o">+</span><span class="n">A</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span><span class="mi">4</span><span class="p">)</span><span class="o">*</span><span class="p">(</span><span class="n">A</span><span class="p">(</span><span class="mi">2</span><span class="p">,</span><span class="mi">3</span><span class="p">)</span><span class="o">*</span><span class="n">A</span><span class="p">(</span><span class="mi">4</span><span class="p">,</span><span class="mi">1</span><span class="p">)</span><span class="o">-</span><span class="n">A</span><span class="p">(</span><span class="mi">2</span><span class="p">,</span><span class="mi">1</span><span class="p">)</span><span class="o">*</span><span class="n">A</span><span class="p">(</span><span class="mi">4</span><span class="p">,</span><span class="mi">3</span><span class="p">)))</span>
<a name="ln-69"></a>      <span class="n">B</span><span class="p">(</span><span class="mi">3</span><span class="p">,</span><span class="mi">3</span><span class="p">)</span> <span class="o">=</span> <span class="n">detinv</span><span class="o">*</span><span class="p">(</span><span class="n">A</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span><span class="mi">1</span><span class="p">)</span><span class="o">*</span><span class="p">(</span><span class="n">A</span><span class="p">(</span><span class="mi">2</span><span class="p">,</span><span class="mi">2</span><span class="p">)</span><span class="o">*</span><span class="n">A</span><span class="p">(</span><span class="mi">4</span><span class="p">,</span><span class="mi">4</span><span class="p">)</span><span class="o">-</span><span class="n">A</span><span class="p">(</span><span class="mi">2</span><span class="p">,</span><span class="mi">4</span><span class="p">)</span><span class="o">*</span><span class="n">A</span><span class="p">(</span><span class="mi">4</span><span class="p">,</span><span class="mi">2</span><span class="p">))</span><span class="o">+</span><span class="n">A</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span><span class="mi">2</span><span class="p">)</span><span class="o">*</span><span class="p">(</span><span class="n">A</span><span class="p">(</span><span class="mi">2</span><span class="p">,</span><span class="mi">4</span><span class="p">)</span><span class="o">*</span><span class="n">A</span><span class="p">(</span><span class="mi">4</span><span class="p">,</span><span class="mi">1</span><span class="p">)</span><span class="o">-</span><span class="n">A</span><span class="p">(</span><span class="mi">2</span><span class="p">,</span><span class="mi">1</span><span class="p">)</span><span class="o">*</span><span class="n">A</span><span class="p">(</span><span class="mi">4</span><span class="p">,</span><span class="mi">4</span><span class="p">))</span><span class="o">+</span><span class="n">A</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span><span class="mi">4</span><span class="p">)</span><span class="o">*</span><span class="p">(</span><span class="n">A</span><span class="p">(</span><span class="mi">2</span><span class="p">,</span><span class="mi">1</span><span class="p">)</span><span class="o">*</span><span class="n">A</span><span class="p">(</span><span class="mi">4</span><span class="p">,</span><span class="mi">2</span><span class="p">)</span><span class="o">-</span><span class="n">A</span><span class="p">(</span><span class="mi">2</span><span class="p">,</span><span class="mi">2</span><span class="p">)</span><span class="o">*</span><span class="n">A</span><span class="p">(</span><span class="mi">4</span><span class="p">,</span><span class="mi">1</span><span class="p">)))</span>
<a name="ln-70"></a>      <span class="n">B</span><span class="p">(</span><span class="mi">4</span><span class="p">,</span><span class="mi">3</span><span class="p">)</span> <span class="o">=</span> <span class="n">detinv</span><span class="o">*</span><span class="p">(</span><span class="n">A</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span><span class="mi">1</span><span class="p">)</span><span class="o">*</span><span class="p">(</span><span class="n">A</span><span class="p">(</span><span class="mi">2</span><span class="p">,</span><span class="mi">3</span><span class="p">)</span><span class="o">*</span><span class="n">A</span><span class="p">(</span><span class="mi">4</span><span class="p">,</span><span class="mi">2</span><span class="p">)</span><span class="o">-</span><span class="n">A</span><span class="p">(</span><span class="mi">2</span><span class="p">,</span><span class="mi">2</span><span class="p">)</span><span class="o">*</span><span class="n">A</span><span class="p">(</span><span class="mi">4</span><span class="p">,</span><span class="mi">3</span><span class="p">))</span><span class="o">+</span><span class="n">A</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span><span class="mi">2</span><span class="p">)</span><span class="o">*</span><span class="p">(</span><span class="n">A</span><span class="p">(</span><span class="mi">2</span><span class="p">,</span><span class="mi">1</span><span class="p">)</span><span class="o">*</span><span class="n">A</span><span class="p">(</span><span class="mi">4</span><span class="p">,</span><span class="mi">3</span><span class="p">)</span><span class="o">-</span><span class="n">A</span><span class="p">(</span><span class="mi">2</span><span class="p">,</span><span class="mi">3</span><span class="p">)</span><span class="o">*</span><span class="n">A</span><span class="p">(</span><span class="mi">4</span><span class="p">,</span><span class="mi">1</span><span class="p">))</span><span class="o">+</span><span class="n">A</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span><span class="mi">3</span><span class="p">)</span><span class="o">*</span><span class="p">(</span><span class="n">A</span><span class="p">(</span><span class="mi">2</span><span class="p">,</span><span class="mi">2</span><span class="p">)</span><span class="o">*</span><span class="n">A</span><span class="p">(</span><span class="mi">4</span><span class="p">,</span><span class="mi">1</span><span class="p">)</span><span class="o">-</span><span class="n">A</span><span class="p">(</span><span class="mi">2</span><span class="p">,</span><span class="mi">1</span><span class="p">)</span><span class="o">*</span><span class="n">A</span><span class="p">(</span><span class="mi">4</span><span class="p">,</span><span class="mi">2</span><span class="p">)))</span>
<a name="ln-71"></a>      <span class="n">B</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span><span class="mi">4</span><span class="p">)</span> <span class="o">=</span> <span class="n">detinv</span><span class="o">*</span><span class="p">(</span><span class="n">A</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span><span class="mi">2</span><span class="p">)</span><span class="o">*</span><span class="p">(</span><span class="n">A</span><span class="p">(</span><span class="mi">2</span><span class="p">,</span><span class="mi">4</span><span class="p">)</span><span class="o">*</span><span class="n">A</span><span class="p">(</span><span class="mi">3</span><span class="p">,</span><span class="mi">3</span><span class="p">)</span><span class="o">-</span><span class="n">A</span><span class="p">(</span><span class="mi">2</span><span class="p">,</span><span class="mi">3</span><span class="p">)</span><span class="o">*</span><span class="n">A</span><span class="p">(</span><span class="mi">3</span><span class="p">,</span><span class="mi">4</span><span class="p">))</span><span class="o">+</span><span class="n">A</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span><span class="mi">3</span><span class="p">)</span><span class="o">*</span><span class="p">(</span><span class="n">A</span><span class="p">(</span><span class="mi">2</span><span class="p">,</span><span class="mi">2</span><span class="p">)</span><span class="o">*</span><span class="n">A</span><span class="p">(</span><span class="mi">3</span><span class="p">,</span><span class="mi">4</span><span class="p">)</span><span class="o">-</span><span class="n">A</span><span class="p">(</span><span class="mi">2</span><span class="p">,</span><span class="mi">4</span><span class="p">)</span><span class="o">*</span><span class="n">A</span><span class="p">(</span><span class="mi">3</span><span class="p">,</span><span class="mi">2</span><span class="p">))</span><span class="o">+</span><span class="n">A</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span><span class="mi">4</span><span class="p">)</span><span class="o">*</span><span class="p">(</span><span class="n">A</span><span class="p">(</span><span class="mi">2</span><span class="p">,</span><span class="mi">3</span><span class="p">)</span><span class="o">*</span><span class="n">A</span><span class="p">(</span><span class="mi">3</span><span class="p">,</span><span class="mi">2</span><span class="p">)</span><span class="o">-</span><span class="n">A</span><span class="p">(</span><span class="mi">2</span><span class="p">,</span><span class="mi">2</span><span class="p">)</span><span class="o">*</span><span class="n">A</span><span class="p">(</span><span class="mi">3</span><span class="p">,</span><span class="mi">3</span><span class="p">)))</span>
<a name="ln-72"></a>      <span class="n">B</span><span class="p">(</span><span class="mi">2</span><span class="p">,</span><span class="mi">4</span><span class="p">)</span> <span class="o">=</span> <span class="n">detinv</span><span class="o">*</span><span class="p">(</span><span class="n">A</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span><span class="mi">1</span><span class="p">)</span><span class="o">*</span><span class="p">(</span><span class="n">A</span><span class="p">(</span><span class="mi">2</span><span class="p">,</span><span class="mi">3</span><span class="p">)</span><span class="o">*</span><span class="n">A</span><span class="p">(</span><span class="mi">3</span><span class="p">,</span><span class="mi">4</span><span class="p">)</span><span class="o">-</span><span class="n">A</span><span class="p">(</span><span class="mi">2</span><span class="p">,</span><span class="mi">4</span><span class="p">)</span><span class="o">*</span><span class="n">A</span><span class="p">(</span><span class="mi">3</span><span class="p">,</span><span class="mi">3</span><span class="p">))</span><span class="o">+</span><span class="n">A</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span><span class="mi">3</span><span class="p">)</span><span class="o">*</span><span class="p">(</span><span class="n">A</span><span class="p">(</span><span class="mi">2</span><span class="p">,</span><span class="mi">4</span><span class="p">)</span><span class="o">*</span><span class="n">A</span><span class="p">(</span><span class="mi">3</span><span class="p">,</span><span class="mi">1</span><span class="p">)</span><span class="o">-</span><span class="n">A</span><span class="p">(</span><span class="mi">2</span><span class="p">,</span><span class="mi">1</span><span class="p">)</span><span class="o">*</span><span class="n">A</span><span class="p">(</span><span class="mi">3</span><span class="p">,</span><span class="mi">4</span><span class="p">))</span><span class="o">+</span><span class="n">A</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span><span class="mi">4</span><span class="p">)</span><span class="o">*</span><span class="p">(</span><span class="n">A</span><span class="p">(</span><span class="mi">2</span><span class="p">,</span><span class="mi">1</span><span class="p">)</span><span class="o">*</span><span class="n">A</span><span class="p">(</span><span class="mi">3</span><span class="p">,</span><span class="mi">3</span><span class="p">)</span><span class="o">-</span><span class="n">A</span><span class="p">(</span><span class="mi">2</span><span class="p">,</span><span class="mi">3</span><span class="p">)</span><span class="o">*</span><span class="n">A</span><span class="p">(</span><span class="mi">3</span><span class="p">,</span><span class="mi">1</span><span class="p">)))</span>
<a name="ln-73"></a>      <span class="n">B</span><span class="p">(</span><span class="mi">3</span><span class="p">,</span><span class="mi">4</span><span class="p">)</span> <span class="o">=</span> <span class="n">detinv</span><span class="o">*</span><span class="p">(</span><span class="n">A</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span><span class="mi">1</span><span class="p">)</span><span class="o">*</span><span class="p">(</span><span class="n">A</span><span class="p">(</span><span class="mi">2</span><span class="p">,</span><span class="mi">4</span><span class="p">)</span><span class="o">*</span><span class="n">A</span><span class="p">(</span><span class="mi">3</span><span class="p">,</span><span class="mi">2</span><span class="p">)</span><span class="o">-</span><span class="n">A</span><span class="p">(</span><span class="mi">2</span><span class="p">,</span><span class="mi">2</span><span class="p">)</span><span class="o">*</span><span class="n">A</span><span class="p">(</span><span class="mi">3</span><span class="p">,</span><span class="mi">4</span><span class="p">))</span><span class="o">+</span><span class="n">A</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span><span class="mi">2</span><span class="p">)</span><span class="o">*</span><span class="p">(</span><span class="n">A</span><span class="p">(</span><span class="mi">2</span><span class="p">,</span><span class="mi">1</span><span class="p">)</span><span class="o">*</span><span class="n">A</span><span class="p">(</span><span class="mi">3</span><span class="p">,</span><span class="mi">4</span><span class="p">)</span><span class="o">-</span><span class="n">A</span><span class="p">(</span><span class="mi">2</span><span class="p">,</span><span class="mi">4</span><span class="p">)</span><span class="o">*</span><span class="n">A</span><span class="p">(</span><span class="mi">3</span><span class="p">,</span><span class="mi">1</span><span class="p">))</span><span class="o">+</span><span class="n">A</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span><span class="mi">4</span><span class="p">)</span><span class="o">*</span><span class="p">(</span><span class="n">A</span><span class="p">(</span><span class="mi">2</span><span class="p">,</span><span class="mi">2</span><span class="p">)</span><span class="o">*</span><span class="n">A</span><span class="p">(</span><span class="mi">3</span><span class="p">,</span><span class="mi">1</span><span class="p">)</span><span class="o">-</span><span class="n">A</span><span class="p">(</span><span class="mi">2</span><span class="p">,</span><span class="mi">1</span><span class="p">)</span><span class="o">*</span><span class="n">A</span><span class="p">(</span><span class="mi">3</span><span class="p">,</span><span class="mi">2</span><span class="p">)))</span>
<a name="ln-74"></a>      <span class="n">B</span><span class="p">(</span><span class="mi">4</span><span class="p">,</span><span class="mi">4</span><span class="p">)</span> <span class="o">=</span> <span class="n">detinv</span><span class="o">*</span><span class="p">(</span><span class="n">A</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span><span class="mi">1</span><span class="p">)</span><span class="o">*</span><span class="p">(</span><span class="n">A</span><span class="p">(</span><span class="mi">2</span><span class="p">,</span><span class="mi">2</span><span class="p">)</span><span class="o">*</span><span class="n">A</span><span class="p">(</span><span class="mi">3</span><span class="p">,</span><span class="mi">3</span><span class="p">)</span><span class="o">-</span><span class="n">A</span><span class="p">(</span><span class="mi">2</span><span class="p">,</span><span class="mi">3</span><span class="p">)</span><span class="o">*</span><span class="n">A</span><span class="p">(</span><span class="mi">3</span><span class="p">,</span><span class="mi">2</span><span class="p">))</span><span class="o">+</span><span class="n">A</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span><span class="mi">2</span><span class="p">)</span><span class="o">*</span><span class="p">(</span><span class="n">A</span><span class="p">(</span><span class="mi">2</span><span class="p">,</span><span class="mi">3</span><span class="p">)</span><span class="o">*</span><span class="n">A</span><span class="p">(</span><span class="mi">3</span><span class="p">,</span><span class="mi">1</span><span class="p">)</span><span class="o">-</span><span class="n">A</span><span class="p">(</span><span class="mi">2</span><span class="p">,</span><span class="mi">1</span><span class="p">)</span><span class="o">*</span><span class="n">A</span><span class="p">(</span><span class="mi">3</span><span class="p">,</span><span class="mi">3</span><span class="p">))</span><span class="o">+</span><span class="n">A</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span><span class="mi">3</span><span class="p">)</span><span class="o">*</span><span class="p">(</span><span class="n">A</span><span class="p">(</span><span class="mi">2</span><span class="p">,</span><span class="mi">1</span><span class="p">)</span><span class="o">*</span><span class="n">A</span><span class="p">(</span><span class="mi">3</span><span class="p">,</span><span class="mi">2</span><span class="p">)</span><span class="o">-</span><span class="n">A</span><span class="p">(</span><span class="mi">2</span><span class="p">,</span><span class="mi">2</span><span class="p">)</span><span class="o">*</span><span class="n">A</span><span class="p">(</span><span class="mi">3</span><span class="p">,</span><span class="mi">1</span><span class="p">)))</span>
<a name="ln-75"></a>   <span class="k">end function</span>
<a name="ln-76"></a>
<a name="ln-77"></a><span class="k">function </span><span class="n">gaussji</span><span class="p">(</span><span class="n">c</span><span class="p">,</span><span class="n">d</span><span class="p">,</span><span class="n">n</span><span class="p">)</span> <span class="k">result</span><span class="p">(</span><span class="n">a</span><span class="p">)</span>
<a name="ln-78"></a><span class="c">!Linear equation solution by Gauss-Jordan elimination, used to find inverse of matrix c.</span>
<a name="ln-79"></a><span class="c">!possibly slow for large &quot;c&quot; (LAPACK better?)</span>
<a name="ln-80"></a><span class="c">!c needs to be square and have dimension n</span>
<a name="ln-81"></a><span class="c">!c(1:n,1:n) is an input matrix stored in an array of physical dimensions n by n.</span>
<a name="ln-82"></a><span class="c">!d(1:n,1:n) is an input matrix containing the n by n identity matrix.</span>
<a name="ln-83"></a><span class="c">!On  output, a(1:n,1:n) (and b(1:n,1:n)) are the inverse of c</span>
<a name="ln-84"></a><span class="c">!Parameter: NMAX is  the  largest  anticipated  value  of n.</span>
<a name="ln-85"></a>
<a name="ln-86"></a>      <span class="kt">INTEGER</span> <span class="kd">::</span> <span class="n">n</span>
<a name="ln-87"></a>      <span class="kt">real</span><span class="p">,</span> <span class="k">intent</span><span class="p">(</span><span class="n">in</span><span class="p">)</span> <span class="kd">::</span> <span class="n">c</span><span class="p">(</span><span class="n">n</span><span class="p">,</span><span class="n">n</span><span class="p">)</span> <span class="c">!WILL BE OVERWRITTEN!!</span>
<a name="ln-88"></a>      <span class="kt">real</span><span class="p">,</span> <span class="k">intent</span><span class="p">(</span><span class="n">in</span><span class="p">)</span> <span class="kd">::</span> <span class="n">d</span><span class="p">(</span><span class="n">n</span><span class="p">,</span> <span class="n">n</span><span class="p">)</span>
<a name="ln-89"></a>      <span class="kt">real</span> <span class="kd">::</span> <span class="n">a</span><span class="p">(</span><span class="n">n</span><span class="p">,</span><span class="n">n</span><span class="p">),</span><span class="n">b</span><span class="p">(</span><span class="n">n</span><span class="p">,</span><span class="n">n</span><span class="p">)</span>
<a name="ln-90"></a>      <span class="kt">INTEGER</span><span class="p">,</span> <span class="k">PARAMETER</span> <span class="kd">::</span> <span class="n">NMAX</span> <span class="o">=</span> <span class="mi">50</span>
<a name="ln-91"></a>      <span class="kt">INTEGER</span> <span class="kd">::</span> <span class="n">m</span><span class="p">,</span> <span class="n">i</span><span class="p">,</span> <span class="n">icol</span><span class="p">,</span> <span class="n">irow</span><span class="p">,</span> <span class="n">j</span><span class="p">,</span> <span class="n">k</span><span class="p">,</span> <span class="n">l</span><span class="p">,</span> <span class="n">ll</span><span class="p">,</span> <span class="n">indxc</span><span class="p">(</span><span class="n">NMAX</span><span class="p">),</span> <span class="n">indxr</span><span class="p">(</span><span class="n">NMAX</span><span class="p">),</span> <span class="n">ipiv</span><span class="p">(</span><span class="n">NMAX</span><span class="p">)</span>
<a name="ln-92"></a><span class="c">!The integer arrays ipiv, indxr, and indxc are  used for bookkeeping  on the pivoting.</span>
<a name="ln-93"></a>      <span class="kt">REAL</span> <span class="kd">::</span> <span class="n">big</span><span class="p">,</span> <span class="n">dum</span><span class="p">,</span> <span class="n">pivinv</span>
<a name="ln-94"></a>      <span class="n">a</span><span class="o">=</span><span class="n">c</span>
<a name="ln-95"></a>      <span class="n">b</span><span class="o">=</span><span class="n">d</span>
<a name="ln-96"></a>      <span class="n">m</span><span class="o">=</span><span class="n">n</span>
<a name="ln-97"></a>      <span class="k">do </span><span class="n">j</span> <span class="o">=</span> <span class="mi">1</span><span class="p">,</span> <span class="n">n</span>
<a name="ln-98"></a>         <span class="n">ipiv</span><span class="p">(</span><span class="n">j</span><span class="p">)</span> <span class="o">=</span> <span class="mi">0</span>
<a name="ln-99"></a>      <span class="k">end do</span>
<a name="ln-100"></a><span class="k">      do </span><span class="n">i</span> <span class="o">=</span> <span class="mi">1</span><span class="p">,</span> <span class="n">n</span> <span class="c">!This  is  the  main  loop  over  the  columns  to  be  reduced.</span>
<a name="ln-101"></a>         <span class="n">big</span> <span class="o">=</span> <span class="mf">0.</span>
<a name="ln-102"></a>         <span class="k">do </span><span class="n">j</span> <span class="o">=</span> <span class="mi">1</span><span class="p">,</span> <span class="n">n</span> <span class="c">!This  is  the  outer  loop  of  the  search  for  a  pivot  element.</span>
<a name="ln-103"></a>         <span class="k">if</span> <span class="p">(</span><span class="n">ipiv</span><span class="p">(</span><span class="n">j</span><span class="p">)</span> <span class="p">.</span><span class="n">ne</span><span class="p">.</span> <span class="mi">1</span><span class="p">)</span> <span class="k">then</span>
<a name="ln-104"></a><span class="k">         do </span><span class="n">k</span> <span class="o">=</span> <span class="mi">1</span><span class="p">,</span> <span class="n">n</span>
<a name="ln-105"></a>         <span class="k">if</span> <span class="p">(</span><span class="n">ipiv</span><span class="p">(</span><span class="n">k</span><span class="p">)</span> <span class="p">.</span><span class="n">eq</span><span class="p">.</span> <span class="mi">0</span><span class="p">)</span> <span class="k">then</span>
<a name="ln-106"></a><span class="k">         if</span> <span class="p">(</span><span class="nb">abs</span><span class="p">(</span><span class="n">a</span><span class="p">(</span><span class="n">j</span><span class="p">,</span> <span class="n">k</span><span class="p">))</span> <span class="p">.</span><span class="n">ge</span><span class="p">.</span> <span class="n">big</span><span class="p">)</span> <span class="k">then</span>
<a name="ln-107"></a><span class="k">            </span><span class="n">big</span> <span class="o">=</span> <span class="nb">abs</span><span class="p">(</span><span class="n">a</span><span class="p">(</span><span class="n">j</span><span class="p">,</span> <span class="n">k</span><span class="p">))</span>
<a name="ln-108"></a>            <span class="n">irow</span> <span class="o">=</span> <span class="n">j</span>
<a name="ln-109"></a>            <span class="n">icol</span> <span class="o">=</span> <span class="n">k</span>
<a name="ln-110"></a>         <span class="n">endif</span>
<a name="ln-111"></a><span class="c">!else if (ipiv(k).gt.1) then</span>
<a name="ln-112"></a><span class="c">!pause &#39;singular matrix in gaussj&#39;</span>
<a name="ln-113"></a>         <span class="k">end if</span>
<a name="ln-114"></a><span class="k">         end do</span>
<a name="ln-115"></a><span class="k">         end if</span>
<a name="ln-116"></a><span class="k">         end do</span>
<a name="ln-117"></a><span class="k">         </span><span class="n">ipiv</span><span class="p">(</span><span class="n">icol</span><span class="p">)</span> <span class="o">=</span> <span class="n">ipiv</span><span class="p">(</span><span class="n">icol</span><span class="p">)</span> <span class="o">+</span> <span class="mi">1</span>
<a name="ln-118"></a><span class="c">!We  now  have  the  pivot  element,  so  we  interchange  rows,  if  needed,  to  put  the  pivot</span>
<a name="ln-119"></a><span class="c">!element  on  the  diagonal.  The  columns  are  not  physically  interchanged,  only  relabeled:</span>
<a name="ln-120"></a><span class="c">!indxc(i), the column of the ith pivot element, is the ith column that is reduced, while</span>
<a name="ln-121"></a><span class="c">!indxr(i) is  the  row in  which  that  pivot  element  was  originally  located.  If</span>
<a name="ln-122"></a><span class="c">!indxr(i) /= indxc(i) there  is  an  implied  column  interchange.  With  this  form  of  bookkeeping,  the</span>
<a name="ln-123"></a><span class="c">!solution b&#39;s  will  end  up  in  the  correct  order,  and  the  inverse  matrix  will  be  scrambled by  columns</span>
<a name="ln-124"></a>         <span class="k">if</span> <span class="p">(</span><span class="n">irow</span> <span class="p">.</span><span class="n">ne</span><span class="p">.</span> <span class="n">icol</span><span class="p">)</span> <span class="k">then</span>
<a name="ln-125"></a><span class="k">         do </span><span class="n">l</span> <span class="o">=</span> <span class="mi">1</span><span class="p">,</span> <span class="n">n</span>
<a name="ln-126"></a>            <span class="n">dum</span> <span class="o">=</span> <span class="n">a</span><span class="p">(</span><span class="n">irow</span><span class="p">,</span> <span class="n">l</span><span class="p">)</span>
<a name="ln-127"></a>            <span class="n">a</span><span class="p">(</span><span class="n">irow</span><span class="p">,</span> <span class="n">l</span><span class="p">)</span> <span class="o">=</span> <span class="n">a</span><span class="p">(</span><span class="n">icol</span><span class="p">,</span> <span class="n">l</span><span class="p">)</span>
<a name="ln-128"></a>            <span class="n">a</span><span class="p">(</span><span class="n">icol</span><span class="p">,</span> <span class="n">l</span><span class="p">)</span> <span class="o">=</span> <span class="n">dum</span>
<a name="ln-129"></a>         <span class="k">end do</span>
<a name="ln-130"></a><span class="k">         do </span><span class="n">l</span> <span class="o">=</span> <span class="mi">1</span><span class="p">,</span> <span class="n">m</span>
<a name="ln-131"></a>            <span class="n">dum</span> <span class="o">=</span> <span class="n">b</span><span class="p">(</span><span class="n">irow</span><span class="p">,</span> <span class="n">l</span><span class="p">)</span>
<a name="ln-132"></a>            <span class="n">b</span><span class="p">(</span><span class="n">irow</span><span class="p">,</span> <span class="n">l</span><span class="p">)</span> <span class="o">=</span> <span class="n">b</span><span class="p">(</span><span class="n">icol</span><span class="p">,</span> <span class="n">l</span><span class="p">)</span>
<a name="ln-133"></a>            <span class="n">b</span><span class="p">(</span><span class="n">icol</span><span class="p">,</span> <span class="n">l</span><span class="p">)</span> <span class="o">=</span> <span class="n">dum</span>
<a name="ln-134"></a>         <span class="n">enddo</span>
<a name="ln-135"></a>         <span class="n">endif</span>
<a name="ln-136"></a><span class="c">!We are now ready to divide the pivot row by the pivot element, located at irow and icol.</span>
<a name="ln-137"></a>         <span class="n">indxr</span><span class="p">(</span><span class="n">i</span><span class="p">)</span> <span class="o">=</span> <span class="n">irow</span>
<a name="ln-138"></a>         <span class="n">indxc</span><span class="p">(</span><span class="n">i</span><span class="p">)</span> <span class="o">=</span> <span class="n">icol</span>
<a name="ln-139"></a><span class="c">!if (a(icol,icol).eq.0.) pause &#39;singular matrix in gaussj&#39;</span>
<a name="ln-140"></a>         <span class="n">pivinv</span> <span class="o">=</span> <span class="mf">1.</span><span class="o">/</span><span class="n">a</span><span class="p">(</span><span class="n">icol</span><span class="p">,</span> <span class="n">icol</span><span class="p">)</span>
<a name="ln-141"></a>         <span class="n">a</span><span class="p">(</span><span class="n">icol</span><span class="p">,</span> <span class="n">icol</span><span class="p">)</span> <span class="o">=</span> <span class="mf">1.</span>
<a name="ln-142"></a>         <span class="k">do </span><span class="n">l</span> <span class="o">=</span> <span class="mi">1</span><span class="p">,</span> <span class="n">n</span>
<a name="ln-143"></a>            <span class="n">a</span><span class="p">(</span><span class="n">icol</span><span class="p">,</span> <span class="n">l</span><span class="p">)</span> <span class="o">=</span> <span class="n">a</span><span class="p">(</span><span class="n">icol</span><span class="p">,</span> <span class="n">l</span><span class="p">)</span><span class="o">*</span><span class="n">pivinv</span>
<a name="ln-144"></a>         <span class="k">end do</span>
<a name="ln-145"></a><span class="k">         do </span><span class="n">l</span> <span class="o">=</span> <span class="mi">1</span><span class="p">,</span> <span class="n">m</span>
<a name="ln-146"></a>            <span class="n">b</span><span class="p">(</span><span class="n">icol</span><span class="p">,</span> <span class="n">l</span><span class="p">)</span> <span class="o">=</span> <span class="n">b</span><span class="p">(</span><span class="n">icol</span><span class="p">,</span> <span class="n">l</span><span class="p">)</span><span class="o">*</span><span class="n">pivinv</span>
<a name="ln-147"></a>         <span class="k">end do</span>
<a name="ln-148"></a><span class="k">         do </span><span class="n">ll</span> <span class="o">=</span> <span class="mi">1</span><span class="p">,</span> <span class="n">n</span>
<a name="ln-149"></a><span class="c">!Next,  we  reduce  the  rows, except for the  pivot  one, of course.</span>
<a name="ln-150"></a>            <span class="k">if</span> <span class="p">(</span><span class="n">ll</span> <span class="p">.</span><span class="n">ne</span><span class="p">.</span> <span class="n">icol</span><span class="p">)</span> <span class="k">then</span>
<a name="ln-151"></a><span class="k">               </span><span class="n">dum</span> <span class="o">=</span> <span class="n">a</span><span class="p">(</span><span class="n">ll</span><span class="p">,</span> <span class="n">icol</span><span class="p">)</span>
<a name="ln-152"></a>               <span class="n">a</span><span class="p">(</span><span class="n">ll</span><span class="p">,</span> <span class="n">icol</span><span class="p">)</span> <span class="o">=</span> <span class="mf">0.</span>
<a name="ln-153"></a>               <span class="k">do </span><span class="n">l</span> <span class="o">=</span> <span class="mi">1</span><span class="p">,</span> <span class="n">n</span>
<a name="ln-154"></a>                  <span class="n">a</span><span class="p">(</span><span class="n">ll</span><span class="p">,</span> <span class="n">l</span><span class="p">)</span> <span class="o">=</span> <span class="n">a</span><span class="p">(</span><span class="n">ll</span><span class="p">,</span> <span class="n">l</span><span class="p">)</span> <span class="o">-</span> <span class="n">a</span><span class="p">(</span><span class="n">icol</span><span class="p">,</span> <span class="n">l</span><span class="p">)</span><span class="o">*</span><span class="n">dum</span>
<a name="ln-155"></a>               <span class="k">end do</span>
<a name="ln-156"></a><span class="k">               do </span><span class="n">l</span> <span class="o">=</span> <span class="mi">1</span><span class="p">,</span> <span class="n">m</span>
<a name="ln-157"></a>                  <span class="n">b</span><span class="p">(</span><span class="n">ll</span><span class="p">,</span> <span class="n">l</span><span class="p">)</span> <span class="o">=</span> <span class="n">b</span><span class="p">(</span><span class="n">ll</span><span class="p">,</span> <span class="n">l</span><span class="p">)</span> <span class="o">-</span> <span class="n">b</span><span class="p">(</span><span class="n">icol</span><span class="p">,</span> <span class="n">l</span><span class="p">)</span><span class="o">*</span><span class="n">dum</span>
<a name="ln-158"></a>               <span class="k">end do</span>
<a name="ln-159"></a><span class="k">            end if</span>
<a name="ln-160"></a><span class="k">         end do</span>
<a name="ln-161"></a><span class="k">      end do</span>
<a name="ln-162"></a><span class="c">!This is the end of the main loop over columns of the reduction.</span>
<a name="ln-163"></a>      <span class="k">do </span><span class="n">l</span> <span class="o">=</span> <span class="n">n</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="o">-</span><span class="mi">1</span>
<a name="ln-164"></a><span class="c">!It  only  remains  to  unscramble  the  solution  in  view</span>
<a name="ln-165"></a><span class="c">!of  the  column  interchanges.  We  do  this  by  in-</span>
<a name="ln-166"></a><span class="c">!terchanging pairs of columns in the reverse order</span>
<a name="ln-167"></a><span class="c">!that the permutation was built  up.</span>
<a name="ln-168"></a>         <span class="k">if</span> <span class="p">(</span><span class="n">indxr</span><span class="p">(</span><span class="n">l</span><span class="p">)</span> <span class="p">.</span><span class="n">ne</span><span class="p">.</span> <span class="n">indxc</span><span class="p">(</span><span class="n">l</span><span class="p">))</span> <span class="k">then</span>
<a name="ln-169"></a><span class="k">         do </span><span class="n">k</span> <span class="o">=</span> <span class="mi">1</span><span class="p">,</span> <span class="n">n</span>
<a name="ln-170"></a>            <span class="n">dum</span> <span class="o">=</span> <span class="n">a</span><span class="p">(</span><span class="n">k</span><span class="p">,</span> <span class="n">indxr</span><span class="p">(</span><span class="n">l</span><span class="p">))</span>
<a name="ln-171"></a>            <span class="n">a</span><span class="p">(</span><span class="n">k</span><span class="p">,</span> <span class="n">indxr</span><span class="p">(</span><span class="n">l</span><span class="p">))</span> <span class="o">=</span> <span class="n">a</span><span class="p">(</span><span class="n">k</span><span class="p">,</span> <span class="n">indxc</span><span class="p">(</span><span class="n">l</span><span class="p">))</span>
<a name="ln-172"></a>            <span class="n">a</span><span class="p">(</span><span class="n">k</span><span class="p">,</span> <span class="n">indxc</span><span class="p">(</span><span class="n">l</span><span class="p">))</span> <span class="o">=</span> <span class="n">dum</span>
<a name="ln-173"></a>         <span class="k">end do</span>
<a name="ln-174"></a><span class="k">         end if</span>
<a name="ln-175"></a><span class="k">      end do</span>
<a name="ln-176"></a><span class="k">      return</span>
<a name="ln-177"></a><span class="c">!And  we  are  done.</span>
<a name="ln-178"></a>   <span class="k">END function </span><span class="n">gaussji</span>
<a name="ln-179"></a>
<a name="ln-180"></a>   <span class="k">subroutine </span><span class="n">intqH</span> <span class="c">!time integration of heat and latent heat from facets</span>
<a name="ln-181"></a>      <span class="k">use </span><span class="n">modglobal</span><span class="p">,</span> <span class="n">only</span><span class="p">:</span><span class="n">nfcts</span><span class="p">,</span> <span class="n">dt</span><span class="p">,</span> <span class="n">rk3step</span><span class="p">,</span> <span class="n">lEB</span>
<a name="ln-182"></a>      <span class="k">use </span><span class="n">initfac</span><span class="p">,</span> <span class="n">only</span><span class="p">:</span><span class="n">faccth</span><span class="p">,</span> <span class="n">fachfsum</span><span class="p">,</span> <span class="n">fachf</span><span class="p">,</span> <span class="n">fachfi</span><span class="p">,</span> <span class="n">facef</span><span class="p">,</span> <span class="n">facefi</span><span class="p">,</span> <span class="n">facefsum</span>
<a name="ln-183"></a>      <span class="k">use </span><span class="n">modmpi</span><span class="p">,</span> <span class="n">only</span><span class="p">:</span><span class="n">nprocs</span><span class="p">,</span> <span class="n">myid</span><span class="p">,</span> <span class="n">comm3d</span><span class="p">,</span> <span class="n">mpierr</span><span class="p">,</span> <span class="n">mpi_sum</span><span class="p">,</span> <span class="n">my_real</span>
<a name="ln-184"></a>      <span class="kt">real</span> <span class="kd">::</span> <span class="n">dummy</span>
<a name="ln-185"></a>      <span class="kt">integer</span> <span class="kd">::</span> <span class="n">n</span>
<a name="ln-186"></a>      <span class="k">if</span> <span class="p">(.</span><span class="nb">not</span><span class="p">.</span> <span class="n">lEB</span><span class="p">)</span> <span class="k">return</span>
<a name="ln-187"></a><span class="k">      if</span> <span class="p">(</span><span class="n">rk3step</span> <span class="p">.</span><span class="n">eq</span><span class="p">.</span> <span class="mi">3</span><span class="p">)</span> <span class="k">then</span>
<a name="ln-188"></a>         <span class="c">!sum over all processors since a facet can be split onto more than one processor</span>
<a name="ln-189"></a>         <span class="n">fachfsum</span> <span class="o">=</span> <span class="mf">0.</span>
<a name="ln-190"></a>         <span class="n">facefsum</span> <span class="o">=</span> <span class="mf">0.</span>
<a name="ln-191"></a>         <span class="k">call </span><span class="n">MPI_ALLREDUCE</span><span class="p">(</span><span class="n">fachf</span><span class="p">(</span><span class="mi">1</span><span class="p">:</span><span class="n">nfcts</span><span class="p">),</span> <span class="n">fachfsum</span><span class="p">(</span><span class="mi">1</span><span class="p">:</span><span class="n">nfcts</span><span class="p">),</span> <span class="n">nfcts</span><span class="p">,</span> <span class="n">MY_REAL</span><span class="p">,</span> <span class="n">MPI_SUM</span><span class="p">,</span> <span class="n">comm3d</span><span class="p">,</span> <span class="n">mpierr</span><span class="p">)</span>
<a name="ln-192"></a>         <span class="k">call </span><span class="n">MPI_ALLREDUCE</span><span class="p">(</span><span class="n">facef</span><span class="p">(</span><span class="mi">1</span><span class="p">:</span><span class="n">nfcts</span><span class="p">),</span> <span class="n">facefsum</span><span class="p">(</span><span class="mi">1</span><span class="p">:</span><span class="n">nfcts</span><span class="p">),</span> <span class="n">nfcts</span><span class="p">,</span> <span class="n">MY_REAL</span><span class="p">,</span> <span class="n">MPI_SUM</span><span class="p">,</span> <span class="n">comm3d</span><span class="p">,</span> <span class="n">mpierr</span><span class="p">)</span>
<a name="ln-193"></a>
<a name="ln-194"></a>         <span class="k">if</span> <span class="p">(</span><span class="n">myid</span> <span class="o">==</span> <span class="mi">0</span><span class="p">)</span> <span class="k">then</span>
<a name="ln-195"></a>            <span class="c">!time summation of total facet heatlux (will be divided by dtEB in EB to get time mean flux)</span>
<a name="ln-196"></a>            <span class="k">do </span><span class="n">n</span> <span class="o">=</span> <span class="mi">1</span><span class="p">,</span> <span class="n">nfcts</span>
<a name="ln-197"></a>               <span class="n">fachfi</span><span class="p">(</span><span class="n">n</span><span class="p">)</span> <span class="o">=</span> <span class="n">fachfi</span><span class="p">(</span><span class="n">n</span><span class="p">)</span> <span class="o">+</span> <span class="n">dt</span><span class="o">*</span><span class="n">fachfsum</span><span class="p">(</span><span class="n">n</span><span class="p">)</span> <span class="c">!sum up the fluxes over time</span>
<a name="ln-198"></a>               <span class="n">facefi</span><span class="p">(</span><span class="n">n</span><span class="p">)</span> <span class="o">=</span> <span class="n">facefi</span><span class="p">(</span><span class="n">n</span><span class="p">)</span> <span class="o">+</span> <span class="n">dt</span><span class="o">*</span><span class="n">facefsum</span><span class="p">(</span><span class="n">n</span><span class="p">)</span>
<a name="ln-199"></a>            <span class="k">end do</span>
<a name="ln-200"></a><span class="k">         end if</span>
<a name="ln-201"></a><span class="k">      end if</span>
<a name="ln-202"></a><span class="k">      </span><span class="n">fachf</span> <span class="o">=</span> <span class="mf">0.</span>
<a name="ln-203"></a>      <span class="n">fachfsum</span> <span class="o">=</span> <span class="mf">0.</span>
<a name="ln-204"></a>      <span class="n">facefsum</span> <span class="o">=</span> <span class="mf">0.</span>
<a name="ln-205"></a>      <span class="n">facef</span> <span class="o">=</span> <span class="mf">0.</span>
<a name="ln-206"></a>   <span class="k">end subroutine </span><span class="n">intqH</span>
<a name="ln-207"></a>
<a name="ln-208"></a>   <span class="k">subroutine </span><span class="n">initEB</span>
<a name="ln-209"></a>      <span class="c">!initialise everything necessary to calculate the energy balance</span>
<a name="ln-210"></a>      <span class="k">use </span><span class="n">modglobal</span><span class="p">,</span> <span class="n">only</span><span class="p">:</span><span class="n">AM</span><span class="p">,</span> <span class="n">BM</span><span class="p">,</span><span class="n">CM</span><span class="p">,</span><span class="n">DM</span><span class="p">,</span><span class="n">EM</span><span class="p">,</span><span class="n">FM</span><span class="p">,</span><span class="n">GM</span><span class="p">,</span> <span class="n">HM</span><span class="p">,</span> <span class="n">IDM</span><span class="p">,</span> <span class="n">inAM</span><span class="p">,</span> <span class="n">bb</span><span class="p">,</span><span class="n">w</span><span class="p">,</span><span class="n">dumv</span><span class="p">,</span><span class="n">Tdash</span><span class="p">,</span> <span class="n">bldT</span><span class="p">,</span> <span class="n">nfcts</span><span class="p">,</span><span class="n">nwalllayers</span>
<a name="ln-211"></a>      <span class="k">use </span><span class="n">initfac</span><span class="p">,</span> <span class="n">only</span><span class="p">:</span><span class="n">facdi</span><span class="p">,</span> <span class="n">faccp</span><span class="p">,</span> <span class="n">faclami</span><span class="p">,</span> <span class="n">fackappa</span><span class="p">,</span> <span class="n">netsw</span><span class="p">,</span> <span class="n">facem</span><span class="p">,</span> <span class="n">fachf</span><span class="p">,</span> <span class="n">facef</span><span class="p">,</span> <span class="n">fachfi</span><span class="p">,</span> <span class="n">facT</span><span class="p">,</span> <span class="n">facLWin</span><span class="p">,</span> <span class="n">facain</span><span class="p">,</span><span class="n">facefi</span><span class="p">,</span><span class="n">facwsoil</span><span class="p">,</span><span class="n">facf</span><span class="p">,</span><span class="n">facets</span><span class="p">,</span><span class="n">facTdash</span><span class="p">,</span><span class="n">facqsat</span><span class="p">,</span><span class="n">facf</span><span class="p">,</span><span class="n">fachurel</span>  
<a name="ln-212"></a>      <span class="k">use </span><span class="n">modmpi</span><span class="p">,</span> <span class="n">only</span><span class="p">:</span><span class="n">myid</span><span class="p">,</span> <span class="n">comm3d</span><span class="p">,</span> <span class="n">mpierr</span><span class="p">,</span> <span class="n">MPI_INTEGER</span><span class="p">,</span> <span class="n">MPI_DOUBLE_PRECISION</span><span class="p">,</span> <span class="n">MY_REAL</span><span class="p">,</span> <span class="n">nprocs</span><span class="p">,</span> <span class="n">cmyid</span><span class="p">,</span> <span class="n">MPI_REAL8</span><span class="p">,</span> <span class="n">MPI_REAL4</span><span class="p">,</span> <span class="n">MPI_SUM</span>
<a name="ln-213"></a>      <span class="k">use </span><span class="n">modstat_nc</span><span class="p">,</span><span class="n">only</span><span class="p">:</span> <span class="n">open_nc</span><span class="p">,</span> <span class="n">define_nc</span><span class="p">,</span><span class="n">ncinfo</span><span class="p">,</span><span class="n">writestat_dims_nc</span>
<a name="ln-214"></a>      <span class="kt">integer</span> <span class="kd">::</span> <span class="n">i</span><span class="p">,</span><span class="n">j</span><span class="p">,</span><span class="n">k</span><span class="p">,</span><span class="n">l</span><span class="p">,</span><span class="n">m</span><span class="p">,</span><span class="n">n</span>
<a name="ln-215"></a>      <span class="kt">real</span> <span class="kd">::</span> <span class="n">dum</span>
<a name="ln-216"></a>      <span class="k">allocate</span><span class="p">(</span><span class="n">AM</span><span class="p">(</span><span class="mi">1</span><span class="p">:</span><span class="n">nwalllayers</span><span class="o">+</span><span class="mi">1</span><span class="p">,</span><span class="mi">1</span><span class="p">:</span><span class="n">nwalllayers</span><span class="o">+</span><span class="mi">1</span><span class="p">))</span>
<a name="ln-217"></a>      <span class="k">allocate</span><span class="p">(</span><span class="n">inAM</span><span class="p">(</span><span class="mi">1</span><span class="p">:</span><span class="n">nwalllayers</span><span class="o">+</span><span class="mi">1</span><span class="p">,</span><span class="mi">1</span><span class="p">:</span><span class="n">nwalllayers</span><span class="o">+</span><span class="mi">1</span><span class="p">))</span>
<a name="ln-218"></a>      <span class="k">allocate</span><span class="p">(</span><span class="n">CM</span><span class="p">(</span><span class="mi">1</span><span class="p">:</span><span class="n">nwalllayers</span><span class="o">+</span><span class="mi">1</span><span class="p">,</span><span class="mi">1</span><span class="p">:</span><span class="n">nwalllayers</span><span class="o">+</span><span class="mi">1</span><span class="p">))</span>
<a name="ln-219"></a>      <span class="k">allocate</span><span class="p">(</span><span class="n">bb</span><span class="p">(</span><span class="mi">1</span><span class="p">:</span><span class="n">nwalllayers</span><span class="o">+</span><span class="mi">1</span><span class="p">))</span>      
<a name="ln-220"></a>      <span class="k">allocate</span><span class="p">(</span><span class="n">BM</span><span class="p">(</span><span class="mi">1</span><span class="p">:</span><span class="n">nwalllayers</span><span class="o">+</span><span class="mi">1</span><span class="p">,</span><span class="mi">1</span><span class="p">:</span><span class="n">nwalllayers</span><span class="o">+</span><span class="mi">1</span><span class="p">))</span>
<a name="ln-221"></a>      <span class="k">allocate</span><span class="p">(</span><span class="n">DM</span><span class="p">(</span><span class="mi">1</span><span class="p">:</span><span class="n">nwalllayers</span><span class="o">+</span><span class="mi">1</span><span class="p">,</span><span class="mi">1</span><span class="p">:</span><span class="n">nwalllayers</span><span class="o">+</span><span class="mi">1</span><span class="p">))</span>
<a name="ln-222"></a>      <span class="k">allocate</span><span class="p">(</span><span class="n">EM</span><span class="p">(</span><span class="mi">1</span><span class="p">:</span><span class="n">nwalllayers</span><span class="o">+</span><span class="mi">1</span><span class="p">,</span><span class="mi">1</span><span class="p">:</span><span class="n">nwalllayers</span><span class="o">+</span><span class="mi">1</span><span class="p">))</span>
<a name="ln-223"></a>      <span class="k">allocate</span><span class="p">(</span><span class="n">FM</span><span class="p">(</span><span class="mi">1</span><span class="p">:</span><span class="n">nwalllayers</span><span class="o">+</span><span class="mi">1</span><span class="p">,</span><span class="mi">1</span><span class="p">:</span><span class="n">nwalllayers</span><span class="o">+</span><span class="mi">1</span><span class="p">))</span>
<a name="ln-224"></a>      <span class="k">allocate</span><span class="p">(</span><span class="n">GM</span><span class="p">(</span><span class="mi">1</span><span class="p">:</span><span class="n">nwalllayers</span><span class="o">+</span><span class="mi">1</span><span class="p">,</span><span class="mi">1</span><span class="p">:</span><span class="n">nwalllayers</span><span class="o">+</span><span class="mi">1</span><span class="p">))</span>
<a name="ln-225"></a>      <span class="k">allocate</span><span class="p">(</span><span class="n">HM</span><span class="p">(</span><span class="mi">1</span><span class="p">:</span><span class="n">nwalllayers</span><span class="o">+</span><span class="mi">1</span><span class="p">,</span><span class="mi">1</span><span class="p">:</span><span class="n">nwalllayers</span><span class="o">+</span><span class="mi">1</span><span class="p">))</span>
<a name="ln-226"></a>      <span class="k">allocate</span><span class="p">(</span><span class="n">IDM</span><span class="p">(</span><span class="mi">1</span><span class="p">:</span><span class="n">nwalllayers</span><span class="o">+</span><span class="mi">1</span><span class="p">,</span><span class="mi">1</span><span class="p">:</span><span class="n">nwalllayers</span><span class="o">+</span><span class="mi">1</span><span class="p">))</span>
<a name="ln-227"></a>      <span class="k">allocate</span><span class="p">(</span><span class="n">w</span><span class="p">(</span><span class="mi">1</span><span class="p">:</span><span class="n">nwalllayers</span><span class="o">+</span><span class="mi">1</span><span class="p">))</span>
<a name="ln-228"></a>      <span class="k">allocate</span><span class="p">(</span><span class="n">dumv</span><span class="p">(</span><span class="mi">1</span><span class="p">:</span><span class="n">nwalllayers</span><span class="o">+</span><span class="mi">1</span><span class="p">))</span>
<a name="ln-229"></a>      <span class="k">allocate</span><span class="p">(</span><span class="n">Tdash</span><span class="p">(</span><span class="mi">1</span><span class="p">:</span><span class="n">nwalllayers</span><span class="o">+</span><span class="mi">1</span><span class="p">))</span>
<a name="ln-230"></a>      <span class="k">write</span><span class="p">(</span><span class="o">*</span><span class="p">,</span><span class="o">*</span><span class="p">)</span> <span class="s2">&quot;nwalllayers&quot;</span><span class="p">,</span><span class="n">nwalllayers</span>
<a name="ln-231"></a>      <span class="n">BM</span><span class="o">=</span><span class="mf">0.</span><span class="p">;</span><span class="n">DM</span><span class="o">=</span><span class="mf">0.</span><span class="p">;</span><span class="n">EM</span><span class="o">=</span><span class="mf">0.</span><span class="p">;</span><span class="n">FM</span><span class="o">=</span><span class="mf">0.</span><span class="p">;</span><span class="n">GM</span><span class="o">=</span><span class="mf">0.</span><span class="p">;</span><span class="n">HM</span><span class="o">=</span><span class="mf">0.</span><span class="p">;</span><span class="n">w</span><span class="o">=</span><span class="mf">0.</span><span class="p">;</span><span class="n">dumv</span><span class="o">=</span><span class="mf">0.</span><span class="p">;</span><span class="n">Tdash</span><span class="o">=</span><span class="mf">0.</span><span class="p">;</span>
<a name="ln-232"></a>      <span class="n">AM</span><span class="o">=</span><span class="mf">0.</span><span class="p">;</span><span class="n">inAM</span><span class="o">=</span><span class="mf">0.</span><span class="p">;</span><span class="n">CM</span><span class="o">=</span><span class="mf">0.</span><span class="p">;</span><span class="n">IDM</span><span class="o">=</span><span class="mf">0.</span><span class="p">;</span><span class="n">bb</span><span class="o">=</span><span class="mf">0.</span>
<a name="ln-233"></a>      <span class="k">do </span><span class="n">j</span><span class="o">=</span><span class="mi">1</span><span class="p">,</span><span class="n">nwalllayers</span><span class="o">+</span><span class="mi">1</span>
<a name="ln-234"></a>      <span class="n">IDM</span><span class="p">(</span><span class="n">j</span><span class="p">,</span><span class="n">j</span><span class="p">)</span><span class="o">=</span><span class="mf">1.0</span>
<a name="ln-235"></a>      <span class="k">end do</span>
<a name="ln-236"></a>      <span class="c">!Fortran is column major, i.e. left dimensions should be iterated first</span>
<a name="ln-237"></a>      <span class="c">! e.g.  (1,1)-&gt;(2,1)-&gt;(3,1)-&gt;(1,2)-&gt;... since they are next to each other on memory</span>
<a name="ln-238"></a>      <span class="c">!first index moves &quot;up and down&quot; second &quot;left and right&quot; (as always)</span>
<a name="ln-239"></a>      <span class="n">m</span><span class="o">=</span><span class="mi">1</span><span class="p">;</span> <span class="c">!position along columns</span>
<a name="ln-240"></a>      <span class="k">do </span><span class="n">j</span><span class="o">=</span><span class="mi">2</span><span class="p">,</span><span class="n">nwalllayers</span><span class="o">+</span><span class="mi">1</span>
<a name="ln-241"></a>      <span class="n">AM</span><span class="p">(</span><span class="n">j</span><span class="p">,</span><span class="n">m</span><span class="p">)</span><span class="o">=</span><span class="mf">0.5</span>
<a name="ln-242"></a>      <span class="n">AM</span><span class="p">(</span><span class="n">j</span><span class="p">,</span><span class="n">m</span><span class="o">+</span><span class="mi">1</span><span class="p">)</span><span class="o">=</span><span class="mf">0.5</span>
<a name="ln-243"></a>      <span class="n">m</span><span class="o">=</span><span class="n">m</span><span class="o">+</span><span class="mi">1</span>
<a name="ln-244"></a>      <span class="k">end do</span>
<a name="ln-245"></a><span class="k">      </span><span class="n">AM</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span><span class="mi">1</span><span class="p">)</span><span class="o">=</span><span class="mf">1.0</span>
<a name="ln-246"></a>      <span class="k">if</span> <span class="p">(</span><span class="n">nwalllayers</span> <span class="o">==</span> <span class="mi">3</span><span class="p">)</span> <span class="k">then</span>
<a name="ln-247"></a><span class="k">        </span><span class="n">inAM</span> <span class="o">=</span> <span class="n">matinv4</span><span class="p">(</span><span class="n">AM</span><span class="p">)</span>
<a name="ln-248"></a>      <span class="c">!!alternatively</span>
<a name="ln-249"></a>      <span class="c">!inAM=matinv3(AM)</span>
<a name="ln-250"></a>      <span class="c">!!or</span>
<a name="ln-251"></a>      <span class="k">else</span>
<a name="ln-252"></a><span class="k">        </span><span class="n">inAM</span><span class="o">=</span><span class="n">gaussji</span><span class="p">(</span><span class="n">AM</span><span class="p">,</span><span class="n">IDM</span><span class="p">,</span><span class="n">nwalllayers</span><span class="o">+</span><span class="mi">1</span><span class="p">)</span>
<a name="ln-253"></a>      <span class="k">end if</span>
<a name="ln-254"></a>
<a name="ln-255"></a>      <span class="c">! write facet temperatures to facT.xxx.nc, and energies to facEB.xxx.nc</span>
<a name="ln-256"></a>      <span class="k">if</span> <span class="p">(</span><span class="n">lwriteEBfiles</span><span class="p">)</span> <span class="k">then</span>
<a name="ln-257"></a><span class="k">		</span><span class="n">Tname</span><span class="p">(</span><span class="mi">6</span><span class="p">:</span><span class="mi">8</span><span class="p">)</span> <span class="o">=</span> <span class="n">cexpnr</span>
<a name="ln-258"></a>		<span class="n">EBname</span><span class="p">(</span><span class="mi">7</span><span class="p">:</span><span class="mi">9</span><span class="p">)</span> <span class="o">=</span> <span class="n">cexpnr</span>
<a name="ln-259"></a>	
<a name="ln-260"></a>		<span class="k">allocate</span><span class="p">(</span><span class="n">ncstatT</span><span class="p">(</span><span class="n">nstatT</span><span class="p">,</span><span class="mi">4</span><span class="p">))</span>
<a name="ln-261"></a>		<span class="k">call </span><span class="n">ncinfo</span><span class="p">(</span><span class="n">tncstatT</span><span class="p">(</span><span class="mi">1</span><span class="p">,:),</span><span class="s1">&#39;t&#39;</span><span class="p">,</span> <span class="s1">&#39;Time&#39;</span><span class="p">,</span> <span class="s1">&#39;s&#39;</span><span class="p">,</span> <span class="s1">&#39;time&#39;</span><span class="p">)</span>
<a name="ln-262"></a>		<span class="k">call </span><span class="n">ncinfo</span><span class="p">(</span><span class="n">ncstatT</span><span class="p">(</span> <span class="mi">1</span><span class="p">,:),</span><span class="s1">&#39;T&#39;</span> <span class="p">,</span><span class="s1">&#39;Temperature&#39;</span><span class="p">,</span> <span class="s1">&#39;K&#39;</span><span class="p">,</span><span class="s1">&#39;flt&#39;</span><span class="p">)</span>
<a name="ln-263"></a>    <span class="k">call </span><span class="n">ncinfo</span><span class="p">(</span><span class="n">ncstatT</span><span class="p">(</span> <span class="mi">2</span><span class="p">,:),</span><span class="s1">&#39;dTdz&#39;</span><span class="p">,</span><span class="s1">&#39;Temperature gradient&#39;</span><span class="p">,</span><span class="s1">&#39;K/m&#39;</span><span class="p">,</span><span class="s1">&#39;flt&#39;</span> <span class="p">)</span>
<a name="ln-264"></a>
<a name="ln-265"></a>		<span class="k">allocate</span><span class="p">(</span><span class="n">ncstatEB</span><span class="p">(</span><span class="n">nstatEB</span><span class="p">,</span><span class="mi">4</span><span class="p">))</span>
<a name="ln-266"></a>		<span class="k">call </span><span class="n">ncinfo</span><span class="p">(</span><span class="n">tncstatEB</span><span class="p">(</span><span class="mi">1</span><span class="p">,:),</span><span class="s1">&#39;t&#39;</span><span class="p">,</span> <span class="s1">&#39;Time&#39;</span><span class="p">,</span> <span class="s1">&#39;s&#39;</span><span class="p">,</span> <span class="s1">&#39;time&#39;</span><span class="p">)</span>
<a name="ln-267"></a>		<span class="k">call </span><span class="n">ncinfo</span><span class="p">(</span><span class="n">ncstatEB</span><span class="p">(</span> <span class="mi">1</span><span class="p">,:),</span><span class="s1">&#39;netsw&#39;</span><span class="p">,</span> <span class="s1">&#39;Shortwave radiation&#39;</span><span class="p">,</span> <span class="s1">&#39;W&#39;</span><span class="p">,</span><span class="s1">&#39;ft&#39;</span><span class="p">)</span>
<a name="ln-268"></a>		<span class="k">call </span><span class="n">ncinfo</span><span class="p">(</span><span class="n">ncstatEB</span><span class="p">(</span> <span class="mi">2</span><span class="p">,:),</span><span class="s1">&#39;LWin&#39;</span><span class="p">,</span> <span class="s1">&#39;Longwave radiation&#39;</span><span class="p">,</span> <span class="s1">&#39;W&#39;</span><span class="p">,</span><span class="s1">&#39;ft&#39;</span><span class="p">)</span>
<a name="ln-269"></a>		<span class="k">call </span><span class="n">ncinfo</span><span class="p">(</span><span class="n">ncstatEB</span><span class="p">(</span> <span class="mi">3</span><span class="p">,:),</span><span class="s1">&#39;hf&#39;</span><span class="p">,</span> <span class="s1">&#39;Sensible heat flux&#39;</span><span class="p">,</span> <span class="s1">&#39;W&#39;</span><span class="p">,</span><span class="s1">&#39;ft&#39;</span><span class="p">)</span>
<a name="ln-270"></a>		<span class="k">call </span><span class="n">ncinfo</span><span class="p">(</span><span class="n">ncstatEB</span><span class="p">(</span> <span class="mi">4</span><span class="p">,:),</span><span class="s1">&#39;ef&#39;</span><span class="p">,</span> <span class="s1">&#39;Latent heat flux&#39;</span><span class="p">,</span> <span class="s1">&#39;W&#39;</span><span class="p">,</span><span class="s1">&#39;ft&#39;</span><span class="p">)</span>
<a name="ln-271"></a>		<span class="k">call </span><span class="n">ncinfo</span><span class="p">(</span><span class="n">ncstatEB</span><span class="p">(</span> <span class="mi">5</span><span class="p">,:),</span><span class="s1">&#39;WGR&#39;</span><span class="p">,</span><span class="s1">&#39;Moisture?&#39;</span><span class="p">,</span> <span class="s1">&#39;W&#39;</span><span class="p">,</span><span class="s1">&#39;ft&#39;</span><span class="p">)</span>
<a name="ln-272"></a>
<a name="ln-273"></a>
<a name="ln-274"></a>		<span class="k">if</span> <span class="p">(</span><span class="n">myid</span><span class="o">==</span><span class="mi">0</span><span class="p">)</span> <span class="k">then</span>
<a name="ln-275"></a><span class="k">			call </span><span class="n">open_nc</span><span class="p">(</span><span class="n">Tname</span><span class="p">,</span> <span class="n">ncidT</span><span class="p">,</span> <span class="n">nrecT</span><span class="p">,</span> <span class="n">nfcts</span><span class="o">=</span><span class="n">nfcts</span><span class="p">,</span> <span class="n">nlyrs</span><span class="o">=</span><span class="n">nwalllayers</span><span class="o">+</span><span class="mi">1</span><span class="p">)</span>
<a name="ln-276"></a>			<span class="k">call </span><span class="n">open_nc</span><span class="p">(</span><span class="n">EBname</span><span class="p">,</span> <span class="n">ncidEB</span><span class="p">,</span> <span class="n">nrecEB</span><span class="p">,</span> <span class="n">nfcts</span><span class="o">=</span><span class="n">nfcts</span><span class="p">)</span>
<a name="ln-277"></a>			<span class="k">if</span> <span class="p">(</span><span class="n">nrecT</span><span class="o">==</span><span class="mi">0</span><span class="p">)</span> <span class="k">then</span>
<a name="ln-278"></a><span class="k">				call </span><span class="n">define_nc</span><span class="p">(</span> <span class="n">ncidT</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="n">tncstatT</span><span class="p">)</span>
<a name="ln-279"></a>				<span class="k">call </span><span class="n">writestat_dims_nc</span><span class="p">(</span><span class="n">ncidT</span><span class="p">)</span>
<a name="ln-280"></a>			<span class="k">end if</span>
<a name="ln-281"></a><span class="k">			if</span> <span class="p">(</span><span class="n">nrecT</span><span class="o">==</span><span class="mi">0</span><span class="p">)</span> <span class="k">then</span>
<a name="ln-282"></a><span class="k">				call </span><span class="n">define_nc</span><span class="p">(</span> <span class="n">ncidEB</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="n">tncstatEB</span><span class="p">)</span>
<a name="ln-283"></a>				<span class="k">call </span><span class="n">writestat_dims_nc</span><span class="p">(</span><span class="n">ncidEB</span><span class="p">)</span>
<a name="ln-284"></a>			<span class="k">end if</span>
<a name="ln-285"></a><span class="k">			call </span><span class="n">define_nc</span><span class="p">(</span> <span class="n">ncidT</span><span class="p">,</span> <span class="n">nstatT</span><span class="p">,</span> <span class="n">ncstatT</span><span class="p">)</span>
<a name="ln-286"></a>			<span class="k">call </span><span class="n">define_nc</span><span class="p">(</span> <span class="n">ncidEB</span><span class="p">,</span> <span class="n">nstatEB</span><span class="p">,</span> <span class="n">ncstatEB</span><span class="p">)</span>
<a name="ln-287"></a>		<span class="n">endif</span> <span class="c">!myid==0</span>
<a name="ln-288"></a>	<span class="k">end if</span>
<a name="ln-289"></a>
<a name="ln-290"></a><span class="k">   end subroutine </span><span class="n">initEB</span>
<a name="ln-291"></a>
<a name="ln-292"></a>   <span class="k">subroutine </span><span class="n">calclw</span>
<a name="ln-293"></a>      <span class="c">!calculate the longwave exchange between facets</span>
<a name="ln-294"></a>      <span class="k">use </span><span class="n">modglobal</span><span class="p">,</span> <span class="n">only</span><span class="p">:</span><span class="n">nfcts</span><span class="p">,</span> <span class="n">boltz</span><span class="p">,</span> <span class="n">skyLW</span>
<a name="ln-295"></a>      <span class="k">use </span><span class="n">initfac</span><span class="p">,</span> <span class="n">only</span><span class="p">:</span><span class="n">facem</span><span class="p">,</span> <span class="n">vf</span><span class="p">,</span> <span class="n">svf</span><span class="p">,</span> <span class="n">faca</span><span class="p">,</span> <span class="n">facT</span><span class="p">,</span> <span class="n">facLWin</span><span class="p">,</span> <span class="n">facets</span>
<a name="ln-296"></a>      <span class="kt">integer</span> <span class="kd">::</span> <span class="n">n</span><span class="p">,</span> <span class="n">m</span>
<a name="ln-297"></a>      <span class="kt">real</span> <span class="kd">::</span> <span class="n">ltemp</span> <span class="o">=</span> <span class="mf">0.</span>
<a name="ln-298"></a>
<a name="ln-299"></a>      <span class="k">do </span><span class="n">n</span> <span class="o">=</span> <span class="mi">1</span><span class="p">,</span> <span class="n">nfcts</span>
<a name="ln-300"></a>         <span class="k">if</span> <span class="p">(</span><span class="n">facets</span><span class="p">(</span><span class="n">n</span><span class="p">,</span> <span class="mi">2</span><span class="p">)</span> <span class="o">&lt;</span> <span class="o">-</span><span class="mi">100</span><span class="p">)</span> <span class="k">then</span> <span class="c">!it&#39;s a bounding wall, no need to update incoming longwave</span>
<a name="ln-301"></a>            <span class="k">cycle</span>
<a name="ln-302"></a><span class="k">         else</span>
<a name="ln-303"></a><span class="k">            </span><span class="n">ltemp</span> <span class="o">=</span> <span class="mf">0.</span>
<a name="ln-304"></a>            <span class="k">do </span><span class="n">m</span> <span class="o">=</span> <span class="mi">1</span><span class="p">,</span> <span class="n">nfcts</span>  <span class="c">!for n, sum over all other m facets </span>
<a name="ln-305"></a>               <span class="n">ltemp</span> <span class="o">=</span> <span class="n">ltemp</span> <span class="o">+</span> <span class="n">vf</span><span class="p">(</span><span class="n">m</span><span class="p">,</span> <span class="n">n</span><span class="p">)</span><span class="o">*</span><span class="n">faca</span><span class="p">(</span><span class="n">m</span><span class="p">)</span><span class="o">/</span><span class="n">faca</span><span class="p">(</span><span class="n">n</span><span class="p">)</span><span class="o">*</span><span class="n">facem</span><span class="p">(</span><span class="n">m</span><span class="p">)</span><span class="o">*</span><span class="n">boltz</span><span class="o">*</span><span class="n">facT</span><span class="p">(</span><span class="n">m</span><span class="p">,</span> <span class="mi">1</span><span class="p">)</span><span class="o">**</span><span class="mi">4</span> <span class="c">![W/m2]</span>
<a name="ln-306"></a>            <span class="k">end do</span>
<a name="ln-307"></a><span class="k">            </span><span class="n">facLWin</span><span class="p">(</span><span class="n">n</span><span class="p">)</span> <span class="o">=</span> <span class="p">(</span><span class="n">ltemp</span> <span class="o">+</span> <span class="n">svf</span><span class="p">(</span><span class="n">n</span><span class="p">)</span><span class="o">*</span><span class="n">skyLW</span><span class="p">)</span><span class="o">*</span><span class="n">facem</span><span class="p">(</span><span class="n">n</span><span class="p">)</span>
<a name="ln-308"></a>         <span class="k">end if</span>
<a name="ln-309"></a><span class="k">      end do</span>
<a name="ln-310"></a><span class="k">   end subroutine </span><span class="n">calclw</span>
<a name="ln-311"></a>
<a name="ln-312"></a>
<a name="ln-313"></a>   <span class="k">subroutine </span><span class="n">updateGR</span>
<a name="ln-314"></a><span class="c">!updates soil and vegetation resistance to evaporation</span>
<a name="ln-315"></a><span class="c">!updates soil moisture</span>
<a name="ln-316"></a><span class="c">!</span>
<a name="ln-317"></a><span class="c">! based on ERA40 surface scheme</span>
<a name="ln-318"></a><span class="c">! van den Hurk 2000</span>
<a name="ln-319"></a><span class="c">! plants</span>
<a name="ln-320"></a><span class="c">! E = max(0,vegetation% * rhoa * (qa-qsat(TGR)) * 1/(rc+ra)) !no dew!!</span>
<a name="ln-321"></a><span class="c">! rc=rsmin/LAI*f1(K)*f2(WGS)*f3(D)*f4(T)</span>
<a name="ln-322"></a><span class="c">! ra,qa,qsat</span>
<a name="ln-323"></a><span class="c">! f3(D) is 1 for small plants</span>
<a name="ln-324"></a><span class="c">! bare soil</span>
<a name="ln-325"></a><span class="c">! E = max(0,(1-vegetation%) * rhoa * (qa-qsat(TGR)*hu) * (1/(rs+ra))</span>
<a name="ln-326"></a>
<a name="ln-327"></a>      <span class="k">use </span><span class="n">modglobal</span><span class="p">,</span> <span class="n">only</span><span class="p">:</span><span class="n">nfcts</span><span class="p">,</span> <span class="n">rlv</span><span class="p">,</span> <span class="n">rlvi</span><span class="p">,</span> <span class="n">rhoa</span><span class="p">,</span> <span class="n">cp</span><span class="p">,</span> <span class="n">wfc</span><span class="p">,</span> <span class="n">wwilt</span><span class="p">,</span> <span class="n">wsoil</span><span class="p">,</span> <span class="n">rsmin</span><span class="p">,</span> <span class="n">GRLAI</span><span class="p">,</span> <span class="n">tEB</span><span class="p">,</span> <span class="n">rsmax</span><span class="p">,</span> <span class="n">lconstW</span>
<a name="ln-328"></a>      <span class="k">use </span><span class="n">initfac</span><span class="p">,</span> <span class="n">only</span><span class="p">:</span><span class="n">netSW</span><span class="p">,</span> <span class="n">faccth</span><span class="p">,</span> <span class="n">fachurel</span><span class="p">,</span> <span class="n">faclGR</span><span class="p">,</span> <span class="n">facwsoil</span><span class="p">,</span> <span class="n">facf</span><span class="p">,</span> <span class="n">facef</span><span class="p">,</span> <span class="n">facT</span><span class="p">,</span> <span class="n">facefi</span><span class="p">,</span> <span class="n">facqsat</span><span class="p">,</span> <span class="n">facdi</span><span class="p">,</span> <span class="n">facain</span><span class="p">,</span> <span class="n">qsat</span>
<a name="ln-329"></a>
<a name="ln-330"></a>      <span class="kt">integer</span> <span class="kd">::</span> <span class="n">n</span>
<a name="ln-331"></a>      <span class="kt">real</span> <span class="kd">::</span> <span class="n">vfraction</span> <span class="o">=</span> <span class="mf">0.8</span> <span class="c">!fraction of GR covered in vegetation, should be made into a proper model parameter (-&gt; modglobal)</span>
<a name="ln-332"></a>      <span class="kt">real</span> <span class="kd">::</span> <span class="n">dum</span>
<a name="ln-333"></a>      <span class="k">do </span><span class="n">n</span> <span class="o">=</span> <span class="mi">1</span><span class="p">,</span> <span class="n">nfcts</span>
<a name="ln-334"></a>
<a name="ln-335"></a>         <span class="k">if</span> <span class="p">(</span><span class="n">faclGR</span><span class="p">(</span><span class="n">n</span><span class="p">))</span> <span class="k">then</span>
<a name="ln-336"></a>             <span class="c">!facefi is actually the accumulated moisture flux, has to be converted to energy flux to calculate temperature</span>
<a name="ln-337"></a>             <span class="c">!yet actually the moisture flux is needed for water budget, i.e. currently many operations cancel each other e.g. X*Lv/Lv  </span>
<a name="ln-338"></a>             <span class="c">!facefi is the sum over all gridcells of a facet, thus has to be averaged by dividing by number of cells in that facet</span>
<a name="ln-339"></a>             <span class="c">!units of facefi are kgW/kgA*m/s </span>
<a name="ln-340"></a>             <span class="n">facefi</span><span class="p">(</span><span class="n">n</span><span class="p">)</span> <span class="o">=</span> <span class="n">facefi</span><span class="p">(</span><span class="n">n</span><span class="p">)</span><span class="o">/</span><span class="n">tEB</span><span class="o">/</span><span class="n">facain</span><span class="p">(</span><span class="n">n</span><span class="p">)</span><span class="o">*</span><span class="n">rhoa</span><span class="o">*</span><span class="n">rlv</span> <span class="c">!mean heat flux since last EB calculation (time average)</span>
<a name="ln-341"></a>
<a name="ln-342"></a>            <span class="k">if</span> <span class="p">(.</span><span class="nb">not</span><span class="p">.</span> <span class="n">lconstW</span><span class="p">)</span> <span class="k">then</span> <span class="c">!remove water from soil</span>
<a name="ln-343"></a>               <span class="n">facwsoil</span><span class="p">(</span><span class="n">n</span><span class="p">)</span> <span class="o">=</span> <span class="nb">max</span><span class="p">(</span><span class="n">facwsoil</span><span class="p">(</span><span class="n">n</span><span class="p">)</span> <span class="o">+</span> <span class="n">facefi</span><span class="p">(</span><span class="n">n</span><span class="p">)</span><span class="o">*</span><span class="n">tEB</span><span class="o">*</span><span class="n">rlvi</span><span class="o">*</span><span class="n">facdi</span><span class="p">(</span><span class="n">n</span><span class="p">,</span> <span class="mi">1</span><span class="p">),</span> <span class="mf">0.</span><span class="p">)</span> <span class="c">!ils13, careful this assumes water only being present in the first layer!!!</span>
<a name="ln-344"></a>            <span class="k">end if</span>
<a name="ln-345"></a>            
<a name="ln-346"></a>            <span class="c">!update canopy resistance used in wf_gr</span>
<a name="ln-347"></a>            <span class="n">fachurel</span><span class="p">(</span><span class="n">n</span><span class="p">)</span> <span class="o">=</span> <span class="nb">max</span><span class="p">(</span><span class="nb">min</span><span class="p">(</span><span class="mf">1.0</span><span class="p">,</span> <span class="mf">0.5</span><span class="o">*</span><span class="p">(</span><span class="mf">1.0</span> <span class="o">-</span> <span class="nb">cos</span><span class="p">(</span><span class="mf">3.14159</span><span class="o">*</span><span class="n">facwsoil</span><span class="p">(</span><span class="n">n</span><span class="p">)</span><span class="o">/</span><span class="n">wfc</span><span class="p">))),</span> <span class="mf">0.</span><span class="p">)</span> <span class="c">!relative humidity above soil</span>
<a name="ln-348"></a>            <span class="n">facf</span><span class="p">(</span><span class="n">n</span><span class="p">,</span> <span class="mi">1</span><span class="p">)</span> <span class="o">=</span> <span class="mf">1.</span><span class="o">/</span><span class="nb">min</span><span class="p">(</span><span class="mf">1.0</span><span class="p">,</span> <span class="p">(</span><span class="mf">0.004</span><span class="o">*</span><span class="n">netSW</span><span class="p">(</span><span class="n">n</span><span class="p">)</span> <span class="o">+</span> <span class="mf">0.05</span><span class="p">)</span><span class="o">/</span><span class="p">(</span><span class="mf">0.81</span><span class="o">*</span><span class="p">(</span><span class="mf">0.004</span><span class="o">*</span><span class="n">netSW</span><span class="p">(</span><span class="n">n</span><span class="p">)</span> <span class="o">+</span> <span class="mi">1</span><span class="p">)))</span> <span class="c">!f1</span>
<a name="ln-349"></a>            <span class="n">facf</span><span class="p">(</span><span class="n">n</span><span class="p">,</span> <span class="mi">2</span><span class="p">)</span> <span class="o">=</span> <span class="mf">1.</span><span class="o">/</span><span class="nb">min</span><span class="p">(</span><span class="nb">max</span><span class="p">(</span><span class="mf">0.001</span><span class="p">,</span> <span class="p">(</span><span class="n">facwsoil</span><span class="p">(</span><span class="n">n</span><span class="p">)</span> <span class="o">-</span> <span class="n">wwilt</span><span class="p">)</span><span class="o">/</span><span class="p">(</span><span class="n">wfc</span> <span class="o">-</span> <span class="n">wwilt</span><span class="p">)),</span> <span class="mf">1.0</span><span class="p">)</span> <span class="c">!f2</span>
<a name="ln-350"></a>            <span class="c">!f3 drops out because it is for high vegetation only</span>
<a name="ln-351"></a>            <span class="n">facf</span><span class="p">(</span><span class="n">n</span><span class="p">,</span> <span class="mi">3</span><span class="p">)</span> <span class="o">=</span> <span class="mf">1.</span><span class="o">/</span><span class="nb">max</span><span class="p">((</span><span class="mi">1</span> <span class="o">-</span> <span class="mf">0.0016</span><span class="o">*</span><span class="p">(</span><span class="mi">298</span><span class="o">-</span><span class="n">facT</span><span class="p">(</span><span class="n">n</span><span class="p">,</span> <span class="mi">1</span><span class="p">))</span><span class="o">**</span><span class="mi">2</span><span class="p">),</span> <span class="mf">0.001</span><span class="p">)</span> <span class="c">!f4</span>
<a name="ln-352"></a>            <span class="c">!store resistance for plants</span>
<a name="ln-353"></a>            <span class="n">facf</span><span class="p">(</span><span class="n">n</span><span class="p">,</span> <span class="mi">4</span><span class="p">)</span> <span class="o">=</span> <span class="nb">min</span><span class="p">(</span><span class="n">rsmin</span><span class="o">/</span><span class="n">GRLAI</span><span class="o">*</span><span class="n">facf</span><span class="p">(</span><span class="n">n</span><span class="p">,</span> <span class="mi">1</span><span class="p">)</span><span class="o">*</span><span class="n">facf</span><span class="p">(</span><span class="n">n</span><span class="p">,</span> <span class="mi">2</span><span class="p">)</span><span class="o">*</span><span class="n">facf</span><span class="p">(</span><span class="n">n</span><span class="p">,</span> <span class="mi">3</span><span class="p">),</span> <span class="n">rsmax</span><span class="p">)</span>
<a name="ln-354"></a>            <span class="c">!store resistance for soil</span>
<a name="ln-355"></a>            <span class="n">facf</span><span class="p">(</span><span class="n">n</span><span class="p">,</span> <span class="mi">5</span><span class="p">)</span> <span class="o">=</span> <span class="nb">min</span><span class="p">(</span><span class="n">rsmin</span><span class="o">*</span><span class="n">facf</span><span class="p">(</span><span class="n">n</span><span class="p">,</span> <span class="mi">2</span><span class="p">),</span> <span class="n">rsmax</span><span class="p">)</span>
<a name="ln-356"></a>            <span class="n">dum</span> <span class="o">=</span> <span class="n">facT</span><span class="p">(</span><span class="n">n</span><span class="p">,</span> <span class="mi">1</span><span class="p">)</span>
<a name="ln-357"></a>            <span class="n">facqsat</span><span class="p">(</span><span class="n">n</span><span class="p">)</span> <span class="o">=</span> <span class="n">qsat</span><span class="p">(</span><span class="n">dum</span><span class="p">)</span>
<a name="ln-358"></a>         <span class="k">end if</span>
<a name="ln-359"></a><span class="k">      end do</span>
<a name="ln-360"></a>
<a name="ln-361"></a><span class="k">   end subroutine </span><span class="n">updateGR</span>
<a name="ln-362"></a>
<a name="ln-363"></a>   <span class="k">subroutine </span><span class="n">EB</span>
<a name="ln-364"></a>    <span class="c">!calculates the energy balance for every facet</span>
<a name="ln-365"></a>     <span class="k">use </span><span class="n">modglobal</span><span class="p">,</span> <span class="n">only</span><span class="p">:</span> <span class="n">nfcts</span><span class="p">,</span> <span class="n">boltz</span><span class="p">,</span> <span class="n">tEB</span><span class="p">,</span> <span class="n">AM</span><span class="p">,</span> <span class="n">BM</span><span class="p">,</span><span class="n">CM</span><span class="p">,</span><span class="n">DM</span><span class="p">,</span><span class="n">EM</span><span class="p">,</span><span class="n">FM</span><span class="p">,</span><span class="n">GM</span><span class="p">,</span><span class="n">HM</span><span class="p">,</span> <span class="n">inAM</span><span class="p">,</span> <span class="n">bb</span><span class="p">,</span><span class="n">w</span><span class="p">,</span> <span class="n">dumv</span><span class="p">,</span><span class="n">Tdash</span><span class="p">,</span> <span class="n">timee</span><span class="p">,</span> <span class="n">tnextEB</span><span class="p">,</span> <span class="n">rk3step</span><span class="p">,</span> <span class="n">rhoa</span><span class="p">,</span> <span class="n">cp</span><span class="p">,</span> <span class="n">lEB</span><span class="p">,</span> <span class="n">ntrun</span><span class="p">,</span> <span class="n">lwriteEBfiles</span><span class="p">,</span><span class="n">nwalllayers</span>
<a name="ln-366"></a>     <span class="k">use </span><span class="n">initfac</span><span class="p">,</span> <span class="n">only</span><span class="p">:</span> <span class="n">faclami</span><span class="p">,</span> <span class="n">netsw</span><span class="p">,</span> <span class="n">facem</span><span class="p">,</span> <span class="n">fachf</span><span class="p">,</span> <span class="n">facef</span><span class="p">,</span> <span class="n">fachfi</span><span class="p">,</span> <span class="n">facT</span><span class="p">,</span> <span class="n">facLWin</span><span class="p">,</span> <span class="n">facain</span><span class="p">,</span><span class="n">facefi</span><span class="p">,</span><span class="n">facf</span><span class="p">,</span><span class="n">facets</span><span class="p">,</span><span class="n">facTdash</span><span class="p">,</span><span class="n">facqsat</span><span class="p">,</span><span class="n">facwsoil</span><span class="p">,</span><span class="n">facf</span><span class="p">,</span><span class="n">fachurel</span><span class="p">,</span><span class="n">facd</span><span class="p">,</span><span class="n">facdi</span><span class="p">,</span><span class="n">fackappa</span>
<a name="ln-367"></a>     <span class="k">use </span><span class="n">modmpi</span><span class="p">,</span> <span class="n">only</span><span class="p">:</span> <span class="n">myid</span><span class="p">,</span> <span class="n">comm3d</span><span class="p">,</span> <span class="n">mpierr</span><span class="p">,</span> <span class="n">MPI_INTEGER</span><span class="p">,</span> <span class="n">MPI_DOUBLE_PRECISION</span><span class="p">,</span> <span class="n">MY_REAL</span><span class="p">,</span> <span class="n">nprocs</span><span class="p">,</span> <span class="n">cmyid</span><span class="p">,</span> <span class="n">MPI_REAL8</span><span class="p">,</span> <span class="n">MPI_REAL4</span><span class="p">,</span> <span class="n">MPI_SUM</span>
<a name="ln-368"></a>     <span class="k">use </span><span class="n">modstat_nc</span><span class="p">,</span> <span class="n">only</span> <span class="p">:</span> <span class="n">writestat_nc</span><span class="p">,</span> <span class="n">writestat_1D_nc</span><span class="p">,</span> <span class="n">writestat_2D_nc</span>
<a name="ln-369"></a>      <span class="kt">real</span>  <span class="kd">::</span> <span class="n">ca</span> <span class="o">=</span> <span class="mf">0.</span><span class="p">,</span> <span class="n">cb</span> <span class="o">=</span> <span class="mf">0.</span><span class="p">,</span> <span class="n">cc</span> <span class="o">=</span> <span class="mf">0.</span><span class="p">,</span> <span class="n">cd</span> <span class="o">=</span> <span class="mf">0.</span><span class="p">,</span> <span class="n">ce</span> <span class="o">=</span> <span class="mf">0.</span><span class="p">,</span> <span class="n">cf</span> <span class="o">=</span> <span class="mf">0.</span>
<a name="ln-370"></a>      <span class="kt">real</span>  <span class="kd">::</span> <span class="n">ab</span> <span class="o">=</span> <span class="mf">0.</span>
<a name="ln-371"></a>      <span class="kt">integer</span> <span class="kd">::</span> <span class="n">l</span><span class="p">,</span> <span class="n">n</span><span class="p">,</span> <span class="n">m</span><span class="p">,</span><span class="n">i</span><span class="p">,</span><span class="n">j</span>
<a name="ln-372"></a>      <span class="kt">character</span><span class="p">(</span><span class="mi">19</span><span class="p">)</span> <span class="n">name</span>
<a name="ln-373"></a>
<a name="ln-374"></a>      <span class="k">if</span> <span class="p">(.</span><span class="nb">not</span><span class="p">.</span> <span class="p">(</span><span class="n">lEB</span><span class="p">))</span> <span class="k">return</span>
<a name="ln-375"></a>      <span class="c">!calculate latent heat flux from vegetation and soil</span>
<a name="ln-376"></a>      <span class="k">call </span><span class="n">intqH</span> 
<a name="ln-377"></a>      <span class="c">!calculate energy balance, update facet temperature and soil moisture</span>
<a name="ln-378"></a>      <span class="k">if</span> <span class="p">((</span><span class="n">rk3step</span> <span class="p">.</span><span class="n">eq</span><span class="p">.</span> <span class="mi">3</span><span class="p">)</span> <span class="p">.</span><span class="nb">and</span><span class="p">.</span> <span class="p">(</span><span class="n">timee</span> <span class="p">.</span><span class="n">ge</span><span class="p">.</span> <span class="n">tnextEB</span><span class="p">))</span> <span class="k">then</span>
<a name="ln-379"></a>
<a name="ln-380"></a><span class="k">         if</span> <span class="p">(</span><span class="n">myid</span> <span class="p">.</span><span class="n">eq</span><span class="p">.</span> <span class="mi">0</span><span class="p">)</span> <span class="k">then</span>
<a name="ln-381"></a><span class="k">            </span><span class="n">tEB</span> <span class="o">=</span> <span class="n">timee</span> <span class="o">-</span> <span class="n">tEB</span> <span class="c">!time since last calculation of energy balance</span>
<a name="ln-382"></a>            <span class="k">write</span> <span class="p">(</span><span class="o">*</span><span class="p">,</span> <span class="o">*</span><span class="p">)</span> <span class="s2">&quot;doing EB, time since last EB:&quot;</span><span class="p">,</span> <span class="n">tEB</span>
<a name="ln-383"></a>
<a name="ln-384"></a>            <span class="c">!calculate time mean, facet area mean latent heat flux and update green roof</span>
<a name="ln-385"></a>            <span class="c">!ILS13 02.05.18 ABOUT updateGR: convert latent heatflux E properly should be done before temperature calculatation. BUT the rest of updateGR should be done after!</span>
<a name="ln-386"></a>            <span class="c">!update green roof  </span>
<a name="ln-387"></a>            <span class="k">call </span><span class="n">updateGR</span>
<a name="ln-388"></a>
<a name="ln-389"></a>            <span class="c">!get longwave fluxes for all facets</span>
<a name="ln-390"></a>            <span class="k">call </span><span class="n">calclw</span>
<a name="ln-391"></a>
<a name="ln-392"></a>            <span class="c">!get time mean, facet area mean sensible heat flux</span>
<a name="ln-393"></a>            <span class="k">do </span><span class="n">n</span> <span class="o">=</span> <span class="mi">1</span><span class="p">,</span> <span class="n">nfcts</span>
<a name="ln-394"></a>               <span class="n">fachfi</span><span class="p">(</span><span class="n">n</span><span class="p">)</span> <span class="o">=</span> <span class="n">fachfi</span><span class="p">(</span><span class="n">n</span><span class="p">)</span><span class="o">/</span><span class="n">tEB</span><span class="o">/</span><span class="n">facain</span><span class="p">(</span><span class="n">n</span><span class="p">)</span><span class="o">*</span><span class="n">rhoa</span><span class="o">*</span><span class="n">cp</span> <span class="c">!mean heat flux since last EB calculation (time average)</span>
<a name="ln-395"></a>               <span class="c">!since fachf is the sum over all cells making up a facet we need to divide by the number of cells, assuming a given density to convert to W/m2</span>
<a name="ln-396"></a>            <span class="k">end do</span>
<a name="ln-397"></a>
<a name="ln-398"></a><span class="c">!solve the system:</span>
<a name="ln-399"></a><span class="c">!see Suter 2018</span>
<a name="ln-400"></a><span class="c">!A * T&#39;= bb + B * T,   where T&#39; = dT/dz</span>
<a name="ln-401"></a><span class="c">!C * d/dtT + D d/dtT&#39;= e * T&#39;</span>
<a name="ln-402"></a><span class="c">!</span>
<a name="ln-403"></a><span class="c">!-&gt; T(n+1)=(F-G*dt)^-1*(F*T+w*dt)</span>
<a name="ln-404"></a><span class="c">!where F=(C + D*A^-1*B), G=(E*A^-1*B), w=(E*A^-1*bb)</span>
<a name="ln-405"></a>
<a name="ln-406"></a>
<a name="ln-407"></a>            <span class="k">do </span><span class="n">n</span> <span class="o">=</span> <span class="mi">1</span><span class="p">,</span> <span class="n">nfcts</span>
<a name="ln-408"></a>               <span class="k">if</span> <span class="p">(</span><span class="n">facets</span><span class="p">(</span><span class="n">n</span><span class="p">,</span> <span class="mi">2</span><span class="p">)</span> <span class="o">&lt;</span> <span class="o">-</span><span class="mi">100</span><span class="p">)</span> <span class="k">then</span> <span class="c">!it&#39;s a bounding wall, no reason to do energy balance</span>
<a name="ln-409"></a>                  <span class="k">cycle</span>
<a name="ln-410"></a><span class="k">               else</span>
<a name="ln-411"></a><span class="c">!calculate wallflux and update surface temperature</span>
<a name="ln-412"></a><span class="c">!! define time dependent fluxes</span>
<a name="ln-413"></a>                  <span class="n">ab</span> <span class="o">=</span> <span class="n">faclami</span><span class="p">(</span><span class="n">n</span><span class="p">,</span> <span class="mi">1</span><span class="p">)</span><span class="o">*</span><span class="n">boltz</span><span class="o">*</span><span class="n">facem</span><span class="p">(</span><span class="n">n</span><span class="p">)</span><span class="o">*</span><span class="p">(</span><span class="n">facT</span><span class="p">(</span><span class="n">n</span><span class="p">,</span> <span class="mi">1</span><span class="p">)</span><span class="o">**</span><span class="mi">3</span><span class="p">)</span> <span class="c">! ab*T is the Stefan-Boltzman law</span>
<a name="ln-414"></a>                  <span class="n">bb</span><span class="p">(</span><span class="mi">1</span><span class="p">)</span> <span class="o">=</span> <span class="o">-</span><span class="n">faclami</span><span class="p">(</span><span class="n">n</span><span class="p">,</span> <span class="mi">1</span><span class="p">)</span><span class="o">*</span><span class="p">(</span><span class="n">netsw</span><span class="p">(</span><span class="n">n</span><span class="p">)</span> <span class="o">+</span> <span class="n">facLWin</span><span class="p">(</span><span class="n">n</span><span class="p">)</span> <span class="o">+</span> <span class="n">fachfi</span><span class="p">(</span><span class="n">n</span><span class="p">)</span> <span class="o">+</span> <span class="n">facefi</span><span class="p">(</span><span class="n">n</span><span class="p">))</span> <span class="c">!net surface flux</span>
<a name="ln-415"></a>
<a name="ln-416"></a><span class="c">!!define the matrices to solve wall heat flux</span>
<a name="ln-417"></a><span class="c">!! CREATE MATRICES BASED ON WALL PROPERTIES</span>
<a name="ln-418"></a>      <span class="n">i</span><span class="o">=</span><span class="mi">1</span><span class="p">;</span><span class="n">m</span><span class="o">=</span><span class="mi">0</span><span class="p">;</span> <span class="c">!position along columns, placeholder for layerindex since only 3 layers implemented (initfac.f90)</span>
<a name="ln-419"></a>      <span class="k">do </span><span class="n">j</span><span class="o">=</span><span class="mi">1</span><span class="p">,</span><span class="n">nwalllayers</span>
<a name="ln-420"></a>      <span class="n">m</span><span class="o">=</span><span class="nb">min</span><span class="p">(</span><span class="n">j</span><span class="p">,</span><span class="mi">3</span><span class="p">)</span>  <span class="c">!!CARE!!! ONLY 3 LAYERS ARE CURRENTLY BEING READ FROM INPUT FILES. PROPERTIES OF LAYER 3 ARE USED FOR SUBSEQUENT LAYERS!!!</span>
<a name="ln-421"></a>      <span class="n">ca</span><span class="o">=</span><span class="n">facdi</span><span class="p">(</span><span class="n">n</span><span class="p">,</span><span class="n">m</span><span class="p">)</span>
<a name="ln-422"></a>      <span class="n">BM</span><span class="p">(</span><span class="n">j</span><span class="o">+</span><span class="mi">1</span><span class="p">,</span><span class="n">i</span><span class="p">)</span><span class="o">=-</span><span class="n">ca</span>
<a name="ln-423"></a>      <span class="n">BM</span><span class="p">(</span><span class="n">j</span><span class="o">+</span><span class="mi">1</span><span class="p">,</span><span class="n">i</span><span class="o">+</span><span class="mi">1</span><span class="p">)</span><span class="o">=</span><span class="n">ca</span>
<a name="ln-424"></a>      <span class="n">EM</span><span class="p">(</span><span class="n">j</span><span class="p">,</span><span class="n">i</span><span class="p">)</span><span class="o">=-</span><span class="n">fackappa</span><span class="p">(</span><span class="n">n</span><span class="p">,</span><span class="n">m</span><span class="p">)</span>
<a name="ln-425"></a>      <span class="n">EM</span><span class="p">(</span><span class="n">j</span><span class="p">,</span><span class="n">i</span><span class="o">+</span><span class="mi">1</span><span class="p">)</span><span class="o">=</span><span class="n">fackappa</span><span class="p">(</span><span class="n">n</span><span class="p">,</span><span class="n">m</span><span class="o">+</span><span class="mi">1</span><span class="p">)</span>
<a name="ln-426"></a>      <span class="n">cb</span><span class="o">=</span><span class="n">facd</span><span class="p">(</span><span class="n">n</span><span class="p">,</span><span class="n">m</span><span class="p">)</span><span class="o">/</span><span class="mi">2</span>
<a name="ln-427"></a>      <span class="n">CM</span><span class="p">(</span><span class="n">j</span><span class="p">,</span><span class="n">i</span><span class="p">)</span><span class="o">=</span><span class="n">cb</span>
<a name="ln-428"></a>      <span class="n">CM</span><span class="p">(</span><span class="n">j</span><span class="p">,</span><span class="n">i</span><span class="o">+</span><span class="mi">1</span><span class="p">)</span><span class="o">=</span><span class="n">cb</span>
<a name="ln-429"></a>      <span class="n">ca</span><span class="o">=</span><span class="n">cb</span><span class="o">**</span><span class="mi">2</span><span class="o">*</span><span class="mf">0.33333333</span>
<a name="ln-430"></a>      <span class="n">DM</span><span class="p">(</span><span class="n">j</span><span class="p">,</span><span class="n">i</span><span class="p">)</span><span class="o">=</span><span class="n">ca</span>
<a name="ln-431"></a>      <span class="n">DM</span><span class="p">(</span><span class="n">j</span><span class="p">,</span><span class="n">i</span><span class="o">+</span><span class="mi">1</span><span class="p">)</span><span class="o">=-</span><span class="n">ca</span>
<a name="ln-432"></a>      <span class="n">i</span><span class="o">=</span><span class="n">i</span><span class="o">+</span><span class="mi">1</span>
<a name="ln-433"></a>      <span class="k">end do</span>
<a name="ln-434"></a><span class="k">      </span><span class="n">CM</span><span class="p">(</span><span class="n">nwalllayers</span><span class="o">+</span><span class="mi">1</span><span class="p">,</span><span class="n">nwalllayers</span><span class="o">+</span><span class="mi">1</span><span class="p">)</span><span class="o">=</span><span class="mf">1.0</span>
<a name="ln-435"></a>      <span class="n">BM</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span><span class="mi">1</span><span class="p">)</span><span class="o">=</span><span class="n">ab</span>
<a name="ln-436"></a>
<a name="ln-437"></a>
<a name="ln-438"></a>                  <span class="n">w</span> <span class="o">=</span> <span class="nb">matmul</span><span class="p">(</span><span class="n">EM</span><span class="p">,</span> <span class="nb">matmul</span><span class="p">(</span><span class="n">inAM</span><span class="p">,</span><span class="n">bb</span><span class="p">))</span><span class="o">*</span><span class="n">tEB</span> <span class="c">!easier than loop and sum</span>
<a name="ln-439"></a>                  <span class="n">HM</span> <span class="o">=</span> <span class="nb">matmul</span><span class="p">(</span><span class="n">inAM</span><span class="p">,</span><span class="n">BM</span><span class="p">)</span>
<a name="ln-440"></a>                  <span class="n">FM</span> <span class="o">=</span> <span class="n">CM</span> <span class="o">+</span> <span class="nb">matmul</span><span class="p">(</span><span class="n">DM</span><span class="p">,</span><span class="n">HM</span><span class="p">)</span>
<a name="ln-441"></a>                  <span class="n">GM</span> <span class="o">=</span> <span class="nb">matmul</span><span class="p">(</span><span class="n">EM</span><span class="p">,</span><span class="n">HM</span><span class="p">)</span>
<a name="ln-442"></a>                  <span class="n">HM</span> <span class="o">=</span> <span class="n">FM</span><span class="o">-</span><span class="n">GM</span><span class="o">*</span><span class="n">tEB</span>
<a name="ln-443"></a>                  <span class="k">if</span> <span class="p">(</span><span class="n">nwalllayers</span> <span class="o">==</span> <span class="mi">3</span><span class="p">)</span> <span class="k">then</span>
<a name="ln-444"></a><span class="k">                     </span><span class="n">GM</span> <span class="o">=</span> <span class="n">matinv4</span><span class="p">(</span><span class="n">HM</span><span class="p">)</span>
<a name="ln-445"></a>                  <span class="k">else</span>
<a name="ln-446"></a><span class="k">                     </span><span class="n">GM</span> <span class="o">=</span> <span class="n">gaussji</span><span class="p">(</span><span class="n">HM</span><span class="p">,</span><span class="n">IDM</span><span class="p">,</span><span class="n">nwalllayers</span><span class="o">+</span><span class="mi">1</span><span class="p">)</span>
<a name="ln-447"></a>                  <span class="k">end if</span>
<a name="ln-448"></a>                 <span class="c">!instead of inverting matrix HM and multiplying by GM (=HM^-1) it would be waster to do a  left matrix division HM\x is faster than (HM^-1)*x</span>
<a name="ln-449"></a>                  <span class="n">dumv</span> <span class="o">=</span> <span class="nb">matmul</span><span class="p">(</span><span class="n">GM</span><span class="p">,</span> <span class="p">(</span><span class="nb">matmul</span><span class="p">(</span><span class="n">FM</span><span class="p">,</span><span class="n">facT</span><span class="p">(</span><span class="n">n</span><span class="p">,:))</span><span class="o">+</span><span class="n">w</span><span class="p">))</span>
<a name="ln-450"></a>
<a name="ln-451"></a>                  <span class="n">facT</span><span class="p">(</span><span class="n">n</span><span class="p">,</span> <span class="p">:)</span> <span class="o">=</span> <span class="n">dumv</span>
<a name="ln-452"></a>                  <span class="c">!calculate Temperature gradient dT/dz=&gt;Tdash so we can output it</span>
<a name="ln-453"></a>                  <span class="c">!ground heat flux = lambda dT/dz</span>
<a name="ln-454"></a>                  <span class="n">w</span> <span class="o">=</span> <span class="nb">matmul</span><span class="p">(</span><span class="n">BM</span><span class="p">,</span> <span class="n">dumv</span><span class="p">)</span>
<a name="ln-455"></a>                  <span class="n">facTdash</span><span class="p">(</span><span class="n">n</span><span class="p">,</span> <span class="p">:)</span> <span class="o">=</span> <span class="nb">matmul</span><span class="p">(</span><span class="n">inAM</span><span class="p">,</span> <span class="p">(</span><span class="n">bb</span> <span class="o">+</span> <span class="n">w</span><span class="p">))</span>
<a name="ln-456"></a>
<a name="ln-457"></a>               <span class="k">end if</span>
<a name="ln-458"></a><span class="k">            end do</span>
<a name="ln-459"></a>
<a name="ln-460"></a><span class="k">          if</span> <span class="p">(</span><span class="n">lwriteEBfiles</span><span class="p">)</span> <span class="k">then</span>
<a name="ln-461"></a><span class="k">			if</span> <span class="p">(</span><span class="n">myid</span> <span class="o">==</span> <span class="mi">0</span><span class="p">)</span> <span class="k">then</span>
<a name="ln-462"></a><span class="k">				allocate</span><span class="p">(</span><span class="n">varsT</span><span class="p">(</span><span class="n">nfcts</span><span class="p">,</span><span class="n">nwalllayers</span><span class="o">+</span><span class="mi">1</span><span class="p">,</span><span class="n">nstatT</span><span class="p">))</span>
<a name="ln-463"></a>				<span class="n">varsT</span><span class="p">(:,:,</span><span class="mi">1</span><span class="p">)</span> <span class="o">=</span> <span class="n">facT</span><span class="p">(</span><span class="mi">1</span><span class="p">:</span><span class="n">nfcts</span><span class="p">,</span><span class="mi">1</span><span class="p">:</span><span class="n">nwalllayers</span><span class="o">+</span><span class="mi">1</span><span class="p">)</span>
<a name="ln-464"></a>        <span class="n">varsT</span><span class="p">(:,:,</span><span class="mi">2</span><span class="p">)</span> <span class="o">=</span> <span class="n">facTdash</span><span class="p">(</span><span class="mi">1</span><span class="p">:</span><span class="n">nfcts</span><span class="p">,</span><span class="mi">1</span><span class="p">:</span><span class="n">nwalllayers</span><span class="o">+</span><span class="mi">1</span><span class="p">)</span>
<a name="ln-465"></a>				<span class="k">call </span><span class="n">writestat_nc</span><span class="p">(</span><span class="n">ncidT</span><span class="p">,</span><span class="mi">1</span><span class="p">,</span><span class="n">tncstatT</span><span class="p">,(</span><span class="o">/</span><span class="n">timee</span><span class="o">/</span><span class="p">),</span><span class="n">nrecT</span><span class="p">,.</span><span class="n">true</span><span class="p">.)</span>
<a name="ln-466"></a>				<span class="k">call </span><span class="n">writestat_2D_nc</span><span class="p">(</span><span class="n">ncidT</span><span class="p">,</span><span class="n">nstatT</span><span class="p">,</span><span class="n">ncstatT</span><span class="p">,</span><span class="n">varsT</span><span class="p">,</span><span class="n">nrecT</span><span class="p">,</span><span class="n">nfcts</span><span class="p">,</span><span class="n">nwalllayers</span><span class="o">+</span><span class="mi">1</span><span class="p">)</span>
<a name="ln-467"></a>				<span class="k">deallocate</span><span class="p">(</span><span class="n">varsT</span><span class="p">)</span>
<a name="ln-468"></a>				
<a name="ln-469"></a>				<span class="k">allocate</span><span class="p">(</span><span class="n">varsEB</span><span class="p">(</span><span class="n">nfcts</span><span class="p">,</span><span class="n">nstatEB</span><span class="p">))</span>
<a name="ln-470"></a>				<span class="n">varsEB</span><span class="p">(:,</span><span class="mi">1</span><span class="p">)</span> <span class="o">=</span> <span class="n">netsw</span><span class="p">(</span><span class="mi">1</span><span class="p">:</span><span class="n">nfcts</span><span class="p">)</span>
<a name="ln-471"></a>				<span class="n">varsEB</span><span class="p">(:,</span><span class="mi">2</span><span class="p">)</span> <span class="o">=</span> <span class="n">facLWin</span><span class="p">(</span><span class="mi">1</span><span class="p">:</span><span class="n">nfcts</span><span class="p">)</span>
<a name="ln-472"></a>				<span class="n">varsEB</span><span class="p">(:,</span><span class="mi">3</span><span class="p">)</span> <span class="o">=</span> <span class="n">fachfi</span><span class="p">(</span><span class="mi">1</span><span class="p">:</span><span class="n">nfcts</span><span class="p">)</span>
<a name="ln-473"></a>				<span class="n">varsEB</span><span class="p">(:,</span><span class="mi">4</span><span class="p">)</span> <span class="o">=</span> <span class="n">facefi</span><span class="p">(</span><span class="mi">1</span><span class="p">:</span><span class="n">nfcts</span><span class="p">)</span>
<a name="ln-474"></a>				<span class="n">varsEB</span><span class="p">(:,</span><span class="mi">5</span><span class="p">)</span> <span class="o">=</span> <span class="n">facwsoil</span><span class="p">(</span><span class="mi">1</span><span class="p">:</span><span class="n">nfcts</span><span class="p">)</span>
<a name="ln-475"></a>				<span class="k">call </span><span class="n">writestat_nc</span><span class="p">(</span><span class="n">ncidEB</span><span class="p">,</span><span class="mi">1</span><span class="p">,</span><span class="n">tncstatEB</span><span class="p">,(</span><span class="o">/</span><span class="n">timee</span><span class="o">/</span><span class="p">),</span><span class="n">nrecEB</span><span class="p">,.</span><span class="n">true</span><span class="p">.)</span>
<a name="ln-476"></a>				<span class="k">call </span><span class="n">writestat_1D_nc</span><span class="p">(</span><span class="n">ncidEB</span><span class="p">,</span><span class="n">nstatEB</span><span class="p">,</span><span class="n">ncstatEB</span><span class="p">,</span><span class="n">varsEB</span><span class="p">,</span><span class="n">nrecEB</span><span class="p">,</span><span class="n">nfcts</span><span class="p">)</span>
<a name="ln-477"></a>				<span class="k">deallocate</span><span class="p">(</span><span class="n">varsEB</span><span class="p">)</span>
<a name="ln-478"></a>
<a name="ln-479"></a>			  <span class="n">endif</span> <span class="c">!myid</span>
<a name="ln-480"></a>
<a name="ln-481"></a><span class="c">!            if (lwriteEBfiles) then</span>
<a name="ln-482"></a><span class="c">!               name = &#39;tEB____________.txt&#39;</span>
<a name="ln-483"></a><span class="c">!               open (unit=11, file=name, position=&#39;append&#39;)</span>
<a name="ln-484"></a><span class="c">!               write (11, &#39;(1(F10.4,:,&quot;,&quot;))&#39;) tEB</span>
<a name="ln-485"></a><span class="c">!               close (11)</span>
<a name="ln-486"></a>
<a name="ln-487"></a><span class="c">!               name = &#39;dummy__________.csv&#39;</span>
<a name="ln-488"></a><span class="c">!               write (name(6:15), &#39;(F10.4)&#39;) timee</span>
<a name="ln-489"></a>
<a name="ln-490"></a><span class="c">!               write (name(1:5), &#39;(A5)&#39;) &#39;netsw&#39;</span>
<a name="ln-491"></a><span class="c">!               open (unit=11, file=name, position=&#39;append&#39;)</span>
<a name="ln-492"></a><span class="c">!               write (11, &#39;(249(F10.4,:,&quot;,&quot;))&#39;) netsw(1:nfcts)</span>
<a name="ln-493"></a><span class="c">!               close (11)</span>
<a name="ln-494"></a><span class="c">!               write (name(1:5), &#39;(A5)&#39;) &#39;LWin_&#39;</span>
<a name="ln-495"></a><span class="c">!               open (unit=11, file=name, position=&#39;append&#39;)</span>
<a name="ln-496"></a><span class="c">!               write (11, &#39;(249(F10.4,:,&quot;,&quot;))&#39;) facLWin(1:nfcts)</span>
<a name="ln-497"></a><span class="c">!               close (11)</span>
<a name="ln-498"></a><span class="c">!               write (name(1:5), &#39;(A5)&#39;) &#39;hf___&#39;</span>
<a name="ln-499"></a><span class="c">!               open (unit=11, file=name, position=&#39;append&#39;)</span>
<a name="ln-500"></a><span class="c">!               write (11, &#39;(249(F10.4,:,&quot;,&quot;))&#39;) fachfi(1:nfcts)</span>
<a name="ln-501"></a><span class="c">!               close (11)</span>
<a name="ln-502"></a><span class="c">!               write (name(1:5), &#39;(A5)&#39;) &#39;ef___&#39;</span>
<a name="ln-503"></a><span class="c">!               open (unit=11, file=name, position=&#39;append&#39;)</span>
<a name="ln-504"></a><span class="c">!               write (11, &#39;(249(F10.4,:,&quot;,&quot;))&#39;) facefi(1:nfcts)</span>
<a name="ln-505"></a><span class="c">!               close (11)</span>
<a name="ln-506"></a><span class="c">!               write (name(1:5), &#39;(A5)&#39;) &#39;WGR__&#39;</span>
<a name="ln-507"></a><span class="c">!               open (unit=11, file=name, position=&#39;append&#39;)</span>
<a name="ln-508"></a><span class="c">!               write (11, &#39;(249(F10.4,:,&quot;,&quot;))&#39;) facwsoil(1:nfcts)</span>
<a name="ln-509"></a><span class="c">!               close (11)</span>
<a name="ln-510"></a><span class="c">!               write (name(1:5), &#39;(A5)&#39;) &#39;facT1&#39;</span>
<a name="ln-511"></a><span class="c">!               open (unit=11, file=name, position=&#39;append&#39;)</span>
<a name="ln-512"></a><span class="c">!               write (11, &#39;(249(F10.4,:,&quot;,&quot;))&#39;) facT(1:nfcts, 1)</span>
<a name="ln-513"></a><span class="c">!               close (11)</span>
<a name="ln-514"></a><span class="c">!               write (name(1:5), &#39;(A5)&#39;) &#39;facT2&#39;</span>
<a name="ln-515"></a><span class="c">!               open (unit=11, file=name, position=&#39;append&#39;)</span>
<a name="ln-516"></a><span class="c">!               write (11, &#39;(249(F10.4,:,&quot;,&quot;))&#39;) facT(1:nfcts, 2)</span>
<a name="ln-517"></a><span class="c">!               close (11)</span>
<a name="ln-518"></a><span class="c">!               write (name(1:5), &#39;(A5)&#39;) &#39;facT3&#39;</span>
<a name="ln-519"></a><span class="c">!               open (unit=11, file=name, position=&#39;append&#39;)</span>
<a name="ln-520"></a><span class="c">!               write (11, &#39;(249(F10.4,:,&quot;,&quot;))&#39;) facT(1:nfcts, 3)</span>
<a name="ln-521"></a><span class="c">!               close (11)</span>
<a name="ln-522"></a><span class="c">!               write (name(1:5), &#39;(A5)&#39;) &#39;faTd1&#39;</span>
<a name="ln-523"></a><span class="c">!               open (unit=11, file=name, position=&#39;append&#39;)</span>
<a name="ln-524"></a><span class="c">!               write (11, &#39;(249(F10.4,:,&quot;,&quot;))&#39;) facTdash(1:nfcts, 1)</span>
<a name="ln-525"></a><span class="c">!               write (name(1:5), &#39;(A5)&#39;) &#39;faTd2&#39;</span>
<a name="ln-526"></a><span class="c">!               open (unit=11, file=name, position=&#39;append&#39;)</span>
<a name="ln-527"></a><span class="c">!               write (11, &#39;(249(F10.4,:,&quot;,&quot;))&#39;) facTdash(1:nfcts, 2)</span>
<a name="ln-528"></a><span class="c">!               write (name(1:5), &#39;(A5)&#39;) &#39;faTd3&#39;</span>
<a name="ln-529"></a><span class="c">!               open (unit=11, file=name, position=&#39;append&#39;)</span>
<a name="ln-530"></a><span class="c">!               write (11, &#39;(249(F10.4,:,&quot;,&quot;))&#39;) facTdash(1:nfcts, 3)</span>
<a name="ln-531"></a><span class="c">!               close (11)</span>
<a name="ln-532"></a><span class="c">!               write (name(1:5), &#39;(A5)&#39;) &#39;faTd4&#39;</span>
<a name="ln-533"></a><span class="c">!               open (unit=11, file=name, position=&#39;append&#39;)</span>
<a name="ln-534"></a><span class="c">!               write (11, &#39;(249(F10.4,:,&quot;,&quot;))&#39;) facTdash(1:nfcts, 4)</span>
<a name="ln-535"></a><span class="c">!               close (11)</span>
<a name="ln-536"></a>            <span class="k">end if</span>
<a name="ln-537"></a>
<a name="ln-538"></a><span class="k">            </span><span class="n">tEB</span> <span class="o">=</span> <span class="n">timee</span> <span class="c">!set time of last calculation of energy balance to current time</span>
<a name="ln-539"></a>            <span class="n">tnextEB</span> <span class="o">=</span> <span class="nb">NINT</span><span class="p">((</span><span class="n">timee</span> <span class="o">+</span> <span class="n">dtEB</span><span class="p">))</span><span class="o">*</span><span class="mf">1.0</span>  <span class="c">!rounded to nearest integer  (e.g. if current time is 10.013s and dtEb=10s, then the next energy balance will be calculated at t&gt;=20s)</span>
<a name="ln-540"></a>            <span class="k">write</span> <span class="p">(</span><span class="o">*</span><span class="p">,</span> <span class="o">*</span><span class="p">)</span> <span class="s2">&quot;time, time next EB&quot;</span><span class="p">,</span> <span class="n">timee</span><span class="p">,</span> <span class="n">tnextEB</span>
<a name="ln-541"></a>
<a name="ln-542"></a>            <span class="k">do </span><span class="n">n</span> <span class="o">=</span> <span class="mi">1</span><span class="p">,</span> <span class="n">nfcts</span>
<a name="ln-543"></a>               <span class="n">fachfi</span><span class="p">(</span><span class="n">n</span><span class="p">)</span> <span class="o">=</span> <span class="mf">0.</span>
<a name="ln-544"></a>               <span class="n">facefi</span><span class="p">(</span><span class="n">n</span><span class="p">)</span> <span class="o">=</span> <span class="mf">0.</span>
<a name="ln-545"></a>            <span class="k">end do</span>
<a name="ln-546"></a><span class="k">         end if</span> <span class="c">!myid==0</span>
<a name="ln-547"></a>         <span class="k">write</span> <span class="p">(</span><span class="o">*</span><span class="p">,</span> <span class="o">*</span><span class="p">)</span> <span class="s2">&quot;bcasting facT&quot;</span>
<a name="ln-548"></a>         <span class="k">call </span><span class="n">MPI_BCAST</span><span class="p">(</span><span class="n">facT</span><span class="p">(</span><span class="mi">0</span><span class="p">:</span><span class="n">nfcts</span><span class="p">,</span> <span class="mi">1</span><span class="p">:</span><span class="n">nwalllayers</span><span class="o">+</span><span class="mi">1</span><span class="p">),</span> <span class="p">(</span><span class="n">nwalllayers</span><span class="o">+</span><span class="mi">1</span><span class="p">)</span><span class="o">*</span><span class="p">(</span><span class="n">nfcts</span> <span class="o">+</span> <span class="mi">1</span><span class="p">),</span> <span class="n">MY_REAL</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="n">comm3d</span><span class="p">,</span> <span class="n">mpierr</span><span class="p">)</span>
<a name="ln-549"></a>         <span class="k">call </span><span class="n">MPI_BCAST</span><span class="p">(</span><span class="n">tnextEB</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="n">MY_REAL</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="n">comm3d</span><span class="p">,</span> <span class="n">mpierr</span><span class="p">)</span>
<a name="ln-550"></a>         <span class="k">call </span><span class="n">MPI_BCAST</span><span class="p">(</span><span class="n">facqsat</span><span class="p">(</span><span class="mi">0</span><span class="p">:</span><span class="n">nfcts</span><span class="p">),</span> <span class="n">nfcts</span> <span class="o">+</span> <span class="mi">1</span><span class="p">,</span> <span class="n">MY_REAL</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="n">comm3d</span><span class="p">,</span> <span class="n">mpierr</span><span class="p">)</span>
<a name="ln-551"></a>         <span class="k">call </span><span class="n">MPI_BCAST</span><span class="p">(</span><span class="n">facf</span><span class="p">(</span><span class="mi">0</span><span class="p">:</span><span class="n">nfcts</span><span class="p">,</span> <span class="mi">1</span><span class="p">:</span><span class="mi">5</span><span class="p">),</span> <span class="p">(</span><span class="n">nfcts</span> <span class="o">+</span> <span class="mi">1</span><span class="p">)</span><span class="o">*</span><span class="mi">5</span><span class="p">,</span> <span class="n">MY_REAL</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="n">comm3d</span><span class="p">,</span> <span class="n">mpierr</span><span class="p">)</span>
<a name="ln-552"></a>         <span class="k">call </span><span class="n">MPI_BCAST</span><span class="p">(</span><span class="n">fachurel</span><span class="p">(</span><span class="mi">0</span><span class="p">:</span><span class="n">nfcts</span><span class="p">),</span> <span class="n">nfcts</span> <span class="o">+</span> <span class="mi">1</span><span class="p">,</span> <span class="n">MY_REAL</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="n">comm3d</span><span class="p">,</span> <span class="n">mpierr</span><span class="p">)</span>
<a name="ln-553"></a>         <span class="k">call </span><span class="n">MPI_BCAST</span><span class="p">(</span><span class="n">facwsoil</span><span class="p">(</span><span class="mi">0</span><span class="p">:</span><span class="n">nfcts</span><span class="p">),</span> <span class="n">nfcts</span> <span class="o">+</span> <span class="mi">1</span><span class="p">,</span> <span class="n">MY_REAL</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="n">comm3d</span><span class="p">,</span> <span class="n">mpierr</span><span class="p">)</span>
<a name="ln-554"></a>         <span class="k">end if</span> <span class="c">!time&gt;tnextEB</span>
<a name="ln-555"></a>
<a name="ln-556"></a>   <span class="k">end subroutine </span><span class="n">EB</span>
<a name="ln-557"></a>
<a name="ln-558"></a><span class="k">end module </span><span class="n">modEB</span>
</pre></div>

    </section>
    </div>
  </div>

  
    <hr>    
    </div> <!-- /container -->
    <footer>
      <div class="container">
      <div class="row">
        <div class="col-xs-6 col-md-4"><p>&copy; 2021 
                                          </p></div>
        <div class="col-xs-6 col-md-4 col-md-push-4">
          <p class="text-right">
            Documentation generated by 
            <a href="https://github.com/cmacmackin/ford">FORD</a>
            
          </p>
        </div>
        <div class="col-xs-12 col-md-4 col-md-pull-4"><p class="text-center"> uDALES was developed by The uDALES Team</p></div>
      </div>
      <br>
      </div> <!-- /container -->    
    </footer>

    <!-- Bootstrap core JavaScript
    ================================================== -->
    <!-- Placed at the end of the document so the pages load faster -->
<!--
    <script src="https://ajax.googleapis.com/ajax/libs/jquery/1.11.1/jquery.min.js"></script>
-->
    <script src="../js/bootstrap.min.js"></script>
    <!-- IE10 viewport hack for Surface/desktop Windows 8 bug -->
    <script src="../js/ie10-viewport-bug-workaround.js"></script>

    <!-- MathJax JavaScript
    ================================================== -->
    <!-- Placed at the end of the document so the pages load faster -->
    <script type="text/x-mathjax-config">
      MathJax.Hub.Config({
        TeX: { extensions: ['AMSmath.js','AMSsymbols.js','noErrors.js','noUndefined.js'], equationNumbers: { autoNumber: 'AMS' } },
        jax: ['input/TeX','input/MathML','output/HTML-CSS'],
        extensions: ['tex2jax.js','mml2jax.js','MathMenu.js','MathZoom.js']
      });
    </script>
    
    <script src="https://cdnjs.cloudflare.com/ajax/libs/mathjax/2.7.1/MathJax.js?config=TeX-AMS-MML_HTMLorMML"></script>
    
    
    <script src="../tipuesearch/tipuesearch_content.js"></script>
    <script src="../tipuesearch/tipuesearch_set.js"></script>
    <script src="../tipuesearch/tipuesearch.js"></script>
    
    
  </body>
</html>