<!DOCTYPE html>
<html lang="en">
  <head>
    <meta charset="utf-8">
    <meta http-equiv="X-UA-Compatible" content="IE=edge">
    <meta name="viewport" content="width=device-width, initial-scale=1">
   
    <meta name="description" content="Documentation for uDALES">
   
    <meta name="author" content="The uDALES Team" >
    <link rel="icon" href="../favicon.png">

    <title>modforces.f90 &ndash; uDALES</title>

    <link href="../css/bootstrap.min.css" rel="stylesheet">
    <link href="../css/pygments.css" rel="stylesheet">
    <link href="../css/font-awesome.min.css" rel="stylesheet">
    <link href="../css/local.css" rel="stylesheet">
    
    <link  href="../tipuesearch/tipuesearch.css" rel="stylesheet">
    
    

    <!-- HTML5 shim and Respond.js for IE8 support of HTML5 elements and media queries -->
    <!--[if lt IE 9]>
      <script src="https://oss.maxcdn.com/html5shiv/3.7.2/html5shiv.min.js"></script>
      <script src="https://oss.maxcdn.com/respond/1.4.2/respond.min.js"></script>
    <![endif]-->
    
    <script src="../js/jquery-2.1.3.min.js"></script>
    <script src="../js/svg-pan-zoom.min.js"></script>

  </head>

  <body>

    <!-- Fixed navbar -->
    <nav class="navbar navbar-inverse navbar-fixed-top">
      <div class="container">
        <div class="navbar-header">
          <button type="button" class="navbar-toggle collapsed" data-toggle="collapse" data-target="#navbar" aria-expanded="false" aria-controls="navbar">
            <span class="sr-only">Toggle navigation</span>
            <span class="icon-bar"></span>
            <span class="icon-bar"></span>
            <span class="icon-bar"></span>
          </button>
          <a class="navbar-brand" href="../index.html">uDALES </a>
        </div>
        <div id="navbar" class="navbar-collapse collapse">
          <ul class="nav navbar-nav">
        
            <li class="dropdown hidden-xs visible-sm visible-md hidden-lg">
              <a href="#" class="dropdown-toggle"
              data-toggle="dropdown" role="button"
              aria-haspopup="true"
     aria-expanded="false">Contents <span class="caret"></span></a>
        <ul class="dropdown-menu">
          
              
            <li><a href="../lists/files.html">Source Files</a></li>
        
        
        
            <li><a href="../lists/modules.html">Modules</a></li>
        
            
                                
            <li><a href="../lists/procedures.html">Procedures</a></li>
        
               
            <li><a href="../lists/types.html">Derived Types</a></li>
        
        
            <li><a href="../program/dalesurban.html">Program</a></li>
      
            </ul>
            </li>


<li class="visible-xs hidden-sm visible-lg"><a href="../lists/files.html">Source Files</a></li>



<li class="visible-xs hidden-sm visible-lg"><a href="../lists/modules.html">Modules</a></li>



<li class="visible-xs hidden-sm visible-lg"><a href="../lists/procedures.html">Procedures</a></li>

                             
<li class="visible-xs hidden-sm visible-lg"><a href="../lists/types.html">Derived Types</a></li>


<li class="visible-xs hidden-sm visible-lg"><a href="../program/dalesurban.html">Program</a></li>

          </ul>
        
        <form action="../search.html" class="navbar-form navbar-right" role="search">
        <div class="form-group">
          <input type="text" class="form-control" placeholder="Search" name="q" id="tipue_search_input" autocomplete="off" required>
        </div>
<!--
        <button type="submit" class="btn btn-default">Submit</button>
-->
        </form>
        
        </div><!--/.nav-collapse -->
      </div>
    </nav>

    <div class="container">
    
  
  <div class="row">
    <h1>modforces.f90
    <small>Source File</small>
    
    </h1>
    
<div class="row">
  <div class="col-lg-12">
<div class="well well-sm">
  <ul class="list-inline" style="margin-bottom:0px;display:inline">
     
     
     
     
    
    
     <li><i class="fa fa-list-ol"></i>
       <a data-toggle="tooltip"
    data-placement="bottom" data-html="true"
    title=" 3.5% of total for source files.">489 statements</a>
     </li> 
     
     
     
    <li><i class="fa fa-code"></i><a href="../src/modforces.f90"> Source File</a></li>
     
     
  </ul>
  <ol class="breadcrumb in-well text-right">
  
    
  
     <li class="active">modforces.f90</li>
  </ol>
</div>
</div>
</div>
<script>
  $(function () {
  $('[data-toggle="tooltip"]').tooltip()
  })
</script>

  </div>
  <div class="row">
    <div class="col-md-3 hidden-xs hidden-sm visible-md visible-lg">
    
<div id="sidebar">
  
<h3>Contents</h3>
 







<div class="panel panel-primary">
  <div class="panel-heading text-left"><h3 class="panel-title"><a data-toggle="collapse" href="#mods-0">Modules</a></h3></div>
  <div id="mods-0" class="panel-collapse collapse">
    <div class="list-group">
      
      <a class="list-group-item" href="../module/modforces.html">modforces</a>
      
    </div>
  </div>
</div>
















<div class="panel panel-primary">
  <div class="panel-heading text-left"><h3 class="panel-title">Source Code</h3></div>
  <div class="list-group">
    <a class="list-group-item" href="../sourcefile/modforces.f90.html#src">modforces.f90</a>
  </div>
</div>



</div>

    </div>
    <div class="col-md-9" id='text'>
      
      <br>
    
    <div class="panel panel-default">
      <div class="panel-heading">
  <h3 class="panel-title">This file depends on</h3>
      </div>
      <div class="panel-body">
  <div class="depgraph"><?xml version="1.0" encoding="UTF-8" standalone="no"?>
<!DOCTYPE svg PUBLIC "-//W3C//DTD SVG 1.1//EN"
 "http://www.w3.org/Graphics/SVG/1.1/DTD/svg11.dtd">
<!-- Generated by graphviz version 2.40.1 (20161225.0304)
 -->
<!-- Title: sourcefile~~modforces.f90~~EfferentGraph Pages: 1 -->
<svg id="sourcefilemodforcesf90EfferentGraph" width="437pt" height="148pt"
 viewBox="0.00 0.00 437.00 148.11" xmlns="http://www.w3.org/2000/svg" xmlns:xlink="http://www.w3.org/1999/xlink">
<g id="sourcefile~~modforces.f90~~EfferentGraph" class="graph" transform="scale(1 1) rotate(0) translate(4 144.1074)">
<title>sourcefile~~modforces.f90~~EfferentGraph</title>
<polygon fill="#ffffff" stroke="transparent" points="-4,4 -4,-144.1074 433,-144.1074 433,4 -4,4"/>
<!-- sourcefile~modforces.f90 -->
<g id="sourcefile~~modforces.f90~~EfferentGraph_node1" class="node">
<title>sourcefile~modforces.f90</title>
<polygon fill="none" stroke="#000000" points="429,-77.1074 348,-77.1074 348,-53.1074 429,-53.1074 429,-77.1074"/>
<text text-anchor="middle" x="388.5" y="-62.7074" font-family="Helvetica,sans-Serif" font-size="10.50" fill="#000000">modforces.f90</text>
</g>
<!-- sourcefile~modibmdata.f90 -->
<g id="sourcefile~~modforces.f90~~EfferentGraph_node2" class="node">
<title>sourcefile~modibmdata.f90</title>
<g id="a_sourcefile~~modforces.f90~~EfferentGraph_node2"><a xlink:href=".././sourcefile/modibmdata.f90.html" xlink:title="modibmdata.f90">
<polygon fill="#f0ad4e" stroke="#f0ad4e" points="311.5,-140.1074 221.5,-140.1074 221.5,-116.1074 311.5,-116.1074 311.5,-140.1074"/>
<text text-anchor="middle" x="266.5" y="-125.7074" font-family="Helvetica,sans-Serif" font-size="10.50" fill="#ffffff">modibmdata.f90</text>
</a>
</g>
</g>
<!-- sourcefile~modforces.f90&#45;&gt;sourcefile~modibmdata.f90 -->
<g id="sourcefile~~modforces.f90~~EfferentGraph_edge5" class="edge">
<title>sourcefile~modforces.f90&#45;&gt;sourcefile~modibmdata.f90</title>
<path fill="none" stroke="#ff0000" stroke-dasharray="5,2" d="M367.2784,-77.2777C352.0416,-85.8876 330.9381,-97.5529 312,-107.1074 309.0483,-108.5965 305.9704,-110.1063 302.8688,-111.5977"/>
<polygon fill="#ff0000" stroke="#ff0000" points="301.1423,-108.5424 293.5951,-115.9782 304.132,-114.8718 301.1423,-108.5424"/>
</g>
<!-- sourcefile~modsurfdata.f90 -->
<g id="sourcefile~~modforces.f90~~EfferentGraph_node3" class="node">
<title>sourcefile~modsurfdata.f90</title>
<g id="a_sourcefile~~modforces.f90~~EfferentGraph_node3"><a xlink:href=".././sourcefile/modsurfdata.f90.html" xlink:title="modsurfdata.f90">
<polygon fill="#f0ad4e" stroke="#f0ad4e" points="312,-98.1074 221,-98.1074 221,-74.1074 312,-74.1074 312,-98.1074"/>
<text text-anchor="middle" x="266.5" y="-83.7074" font-family="Helvetica,sans-Serif" font-size="10.50" fill="#ffffff">modsurfdata.f90</text>
</a>
</g>
</g>
<!-- sourcefile~modforces.f90&#45;&gt;sourcefile~modsurfdata.f90 -->
<g id="sourcefile~~modforces.f90~~EfferentGraph_edge1" class="edge">
<title>sourcefile~modforces.f90&#45;&gt;sourcefile~modsurfdata.f90</title>
<path fill="none" stroke="#ff0000" stroke-dasharray="5,2" d="M347.8758,-72.1001C339.7051,-73.5065 330.9835,-75.0078 322.3976,-76.4857"/>
<polygon fill="#ff0000" stroke="#ff0000" points="321.6833,-73.0571 312.422,-78.2028 322.8708,-79.9556 321.6833,-73.0571"/>
</g>
<!-- sourcefile~modfields.f90 -->
<g id="sourcefile~~modforces.f90~~EfferentGraph_node4" class="node">
<title>sourcefile~modfields.f90</title>
<g id="a_sourcefile~~modforces.f90~~EfferentGraph_node4"><a xlink:href=".././sourcefile/modfields.f90.html" xlink:title="modfields.f90">
<polygon fill="#f0ad4e" stroke="#f0ad4e" points="304.5,-56.1074 228.5,-56.1074 228.5,-32.1074 304.5,-32.1074 304.5,-56.1074"/>
<text text-anchor="middle" x="266.5" y="-41.7074" font-family="Helvetica,sans-Serif" font-size="10.50" fill="#ffffff">modfields.f90</text>
</a>
</g>
</g>
<!-- sourcefile~modforces.f90&#45;&gt;sourcefile~modfields.f90 -->
<g id="sourcefile~~modforces.f90~~EfferentGraph_edge3" class="edge">
<title>sourcefile~modforces.f90&#45;&gt;sourcefile~modfields.f90</title>
<path fill="none" stroke="#ff0000" stroke-dasharray="5,2" d="M347.8758,-58.1147C337.2617,-56.2877 325.7178,-54.3006 314.7496,-52.4126"/>
<polygon fill="#ff0000" stroke="#ff0000" points="315.3306,-48.9613 304.8818,-50.7141 314.1431,-55.8598 315.3306,-48.9613"/>
</g>
<!-- sourcefile~modglobal.f90 -->
<g id="sourcefile~~modforces.f90~~EfferentGraph_node5" class="node">
<title>sourcefile~modglobal.f90</title>
<g id="a_sourcefile~~modforces.f90~~EfferentGraph_node5"><a xlink:href=".././sourcefile/modglobal.f90.html" xlink:title="modglobal.f90">
<polygon fill="#f0ad4e" stroke="#f0ad4e" points="185,-56.1074 105,-56.1074 105,-32.1074 185,-32.1074 185,-56.1074"/>
<text text-anchor="middle" x="145" y="-41.7074" font-family="Helvetica,sans-Serif" font-size="10.50" fill="#ffffff">modglobal.f90</text>
</a>
</g>
</g>
<!-- sourcefile~modforces.f90&#45;&gt;sourcefile~modglobal.f90 -->
<g id="sourcefile~~modforces.f90~~EfferentGraph_edge4" class="edge">
<title>sourcefile~modforces.f90&#45;&gt;sourcefile~modglobal.f90</title>
<path fill="none" stroke="#ff0000" stroke-dasharray="5,2" d="M266.5,-4.1074C233.3531,.9108 197.0492,-13.8988 172.8379,-26.8966"/>
<polygon fill="#ff0000" stroke="#ff0000" points="170.8805,-23.9815 163.8712,-31.9264 174.3051,-30.0867 170.8805,-23.9815"/>
</g>
<!-- sourcefile~modmpi.f90 -->
<g id="sourcefile~~modforces.f90~~EfferentGraph_node6" class="node">
<title>sourcefile~modmpi.f90</title>
<g id="a_sourcefile~~modforces.f90~~EfferentGraph_node6"><a xlink:href=".././sourcefile/modmpi.f90.html" xlink:title="modmpi.f90">
<polygon fill="#f0ad4e" stroke="#f0ad4e" points="69,-36.1074 0,-36.1074 0,-12.1074 69,-12.1074 69,-36.1074"/>
<text text-anchor="middle" x="34.5" y="-21.7074" font-family="Helvetica,sans-Serif" font-size="10.50" fill="#ffffff">modmpi.f90</text>
</a>
</g>
</g>
<!-- sourcefile~modforces.f90&#45;&gt;sourcefile~modmpi.f90 -->
<g id="sourcefile~~modforces.f90~~EfferentGraph_edge2" class="edge">
<title>sourcefile~modforces.f90&#45;&gt;sourcefile~modmpi.f90</title>
<path fill="none" stroke="#ff0000" stroke-dasharray="5,2" d="M372.656,-53.058C350.3989,-37.1402 307.9424,-10.3814 266.5,-4.1074"/>
<path fill="none" stroke="#ff0000" stroke-dasharray="5,2" d="M266.5,-4.1074C201.7037,5.7023 125.9428,-4.931 79.085,-14.0506"/>
<polygon fill="#ff0000" stroke="#ff0000" points="78.3682,-10.6246 69.253,-16.025 79.7464,-17.4876 78.3682,-10.6246"/>
</g>
<!-- sourcefile~modfields.f90&#45;&gt;sourcefile~modglobal.f90 -->
<g id="sourcefile~~modforces.f90~~EfferentGraph_edge6" class="edge">
<title>sourcefile~modfields.f90&#45;&gt;sourcefile~modglobal.f90</title>
<path fill="none" stroke="#00ff66" stroke-dasharray="5,2" d="M228.39,-44.1074C217.84,-44.1074 206.227,-44.1074 195.1054,-44.1074"/>
<polygon fill="#00ff66" stroke="#00ff66" points="195.0743,-40.6075 185.0743,-44.1074 195.0743,-47.6075 195.0743,-40.6075"/>
</g>
<!-- sourcefile~modglobal.f90&#45;&gt;sourcefile~modmpi.f90 -->
<g id="sourcefile~~modforces.f90~~EfferentGraph_edge7" class="edge">
<title>sourcefile~modglobal.f90&#45;&gt;sourcefile~modmpi.f90</title>
<path fill="none" stroke="#0066ff" stroke-dasharray="5,2" d="M104.7944,-36.8303C96.4589,-35.3217 87.6289,-33.7235 79.1455,-32.188"/>
<polygon fill="#0066ff" stroke="#0066ff" points="79.4896,-28.6935 69.0261,-30.3564 78.2428,-35.5816 79.4896,-28.6935"/>
</g>
</g>
</svg>
</div><div><a type="button" class="graph-help" data-toggle="modal" href="#graph-help-text">Help</a></div><div class="modal fade" id="graph-help-text" tabindex="-1" role="dialog"><div class="modal-dialog modal-lg" role="document"><div class="modal-content"><div class="modal-header"><button type="button" class="close" data-dismiss="modal" aria-label="Close"><span aria-hidden="true">&times;</span></button><h4 class="modal-title" id="-graph-help-label">Graph Key</h4></div><div class="modal-body">
    <p>Nodes of different colours represent the following: </p>
    <?xml version="1.0" encoding="UTF-8" standalone="no"?>
<!DOCTYPE svg PUBLIC "-//W3C//DTD SVG 1.1//EN"
 "http://www.w3.org/Graphics/SVG/1.1/DTD/svg11.dtd">
<!-- Generated by graphviz version 2.40.1 (20161225.0304)
 -->
<!-- Title: Graph Key Pages: 1 -->
<svg width="190pt" height="32pt"
 viewBox="0.00 0.00 190.00 32.00" xmlns="http://www.w3.org/2000/svg" xmlns:xlink="http://www.w3.org/1999/xlink">
<g id="graph0" class="graph" transform="scale(1 1) rotate(0) translate(4 28)">
<title>Graph Key</title>
<polygon fill="#ffffff" stroke="transparent" points="-4,4 -4,-28 186,-28 186,4 -4,4"/>
<!-- Source File -->
<g id="node1" class="node">
<title>Source File</title>
<polygon fill="#f0ad4e" stroke="#f0ad4e" points="67,-24 0,-24 0,0 67,0 67,-24"/>
<text text-anchor="middle" x="33.5" y="-9.6" font-family="Helvetica,sans-Serif" font-size="10.50" fill="#ffffff">Source File</text>
</g>
<!-- This Page&#39;s Entity -->
<g id="node2" class="node">
<title>This Page&#39;s Entity</title>
<polygon fill="none" stroke="#000000" points="182,-24 85,-24 85,0 182,0 182,-24"/>
<text text-anchor="middle" x="133.5" y="-9.6" font-family="Helvetica,sans-Serif" font-size="10.50" fill="#000000">This Page&#39;s Entity</text>
</g>
</g>
</svg>

    
    <p>Solid arrows point from a file to a file which it depends on. A file
    is dependent upon another if the latter must be compiled before the former
    can be. Where possible, edges connecting nodes are given different colours to make them easier to distinguish in large graphs.
    </p>
    </div></div></div></div>
      </div>
    </div>
    
      
    <div class="panel panel-default">
      <div class="panel-heading">
  <h3 class="panel-title">Files dependent on this one</h3>
      </div>
      <div class="panel-body">
  <div class="depgraph"><?xml version="1.0" encoding="UTF-8" standalone="no"?>
<!DOCTYPE svg PUBLIC "-//W3C//DTD SVG 1.1//EN"
 "http://www.w3.org/Graphics/SVG/1.1/DTD/svg11.dtd">
<!-- Generated by graphviz version 2.40.1 (20161225.0304)
 -->
<!-- Title: sourcefile~~modforces.f90~~AfferentGraph Pages: 1 -->
<svg id="sourcefilemodforcesf90AfferentGraph" width="317pt" height="52pt"
 viewBox="0.00 0.00 317.00 52.00" xmlns="http://www.w3.org/2000/svg" xmlns:xlink="http://www.w3.org/1999/xlink">
<g id="sourcefile~~modforces.f90~~AfferentGraph" class="graph" transform="scale(1 1) rotate(0) translate(4 48)">
<title>sourcefile~~modforces.f90~~AfferentGraph</title>
<polygon fill="#ffffff" stroke="transparent" points="-4,4 -4,-48 313,-48 313,4 -4,4"/>
<!-- sourcefile~modforces.f90 -->
<g id="sourcefile~~modforces.f90~~AfferentGraph_node1" class="node">
<title>sourcefile~modforces.f90</title>
<polygon fill="none" stroke="#000000" points="81,-44 0,-44 0,-20 81,-20 81,-44"/>
<text text-anchor="middle" x="40.5" y="-29.6" font-family="Helvetica,sans-Serif" font-size="10.50" fill="#000000">modforces.f90</text>
</g>
<!-- sourcefile~modstartup.f90 -->
<g id="sourcefile~~modforces.f90~~AfferentGraph_node2" class="node">
<title>sourcefile~modstartup.f90</title>
<g id="a_sourcefile~~modforces.f90~~AfferentGraph_node2"><a xlink:href=".././sourcefile/modstartup.f90.html" xlink:title="modstartup.f90">
<polygon fill="#f0ad4e" stroke="#f0ad4e" points="202,-24 117,-24 117,0 202,0 202,-24"/>
<text text-anchor="middle" x="159.5" y="-9.6" font-family="Helvetica,sans-Serif" font-size="10.50" fill="#ffffff">modstartup.f90</text>
</a>
</g>
</g>
<!-- sourcefile~modstartup.f90&#45;&gt;sourcefile~modforces.f90 -->
<g id="sourcefile~~modforces.f90~~AfferentGraph_edge1" class="edge">
<title>sourcefile~modstartup.f90&#45;&gt;sourcefile~modforces.f90</title>
<path fill="none" stroke="#ff0000" stroke-dasharray="5,2" d="M116.8744,-19.164C108.5338,-20.5657 99.711,-22.0486 91.1392,-23.4892"/>
<polygon fill="#ff0000" stroke="#ff0000" points="90.5174,-20.0445 81.2359,-25.1536 91.6777,-26.9477 90.5174,-20.0445"/>
</g>
<!-- sourcefile~program.f90 -->
<g id="sourcefile~~modforces.f90~~AfferentGraph_node3" class="node">
<title>sourcefile~program.f90</title>
<g id="a_sourcefile~~modforces.f90~~AfferentGraph_node3"><a xlink:href=".././sourcefile/program.f90.html" xlink:title="program.f90">
<polygon fill="#f0ad4e" stroke="#f0ad4e" points="309,-44 238,-44 238,-20 309,-20 309,-44"/>
<text text-anchor="middle" x="273.5" y="-29.6" font-family="Helvetica,sans-Serif" font-size="10.50" fill="#ffffff">program.f90</text>
</a>
</g>
</g>
<!-- sourcefile~program.f90&#45;&gt;sourcefile~modforces.f90 -->
<g id="sourcefile~~modforces.f90~~AfferentGraph_edge2" class="edge">
<title>sourcefile~program.f90&#45;&gt;sourcefile~modforces.f90</title>
<path fill="none" stroke="#ff0000" stroke-dasharray="5,2" d="M237.8598,-32.5965C226.409,-32.7619 213.6693,-32.9184 202,-33 164.2231,-33.2642 154.777,-33.2469 117,-33 108.7848,-32.9463 100.0737,-32.8602 91.5859,-32.7604"/>
<polygon fill="#ff0000" stroke="#ff0000" points="91.4345,-29.2584 81.3916,-32.6333 91.3472,-36.2578 91.4345,-29.2584"/>
</g>
<!-- sourcefile~program.f90&#45;&gt;sourcefile~modstartup.f90 -->
<g id="sourcefile~~modforces.f90~~AfferentGraph_edge3" class="edge">
<title>sourcefile~program.f90&#45;&gt;sourcefile~modstartup.f90</title>
<path fill="none" stroke="#ff0000" stroke-dasharray="5,2" d="M237.7425,-25.7267C229.67,-24.3105 220.9343,-22.7779 212.3262,-21.2677"/>
<polygon fill="#ff0000" stroke="#ff0000" points="212.7814,-17.7942 202.327,-19.5135 211.5717,-24.6889 212.7814,-17.7942"/>
</g>
</g>
</svg>
</div><div><a type="button" class="graph-help" data-toggle="modal" href="#graph-help-text">Help</a></div><div class="modal fade" id="graph-help-text" tabindex="-1" role="dialog"><div class="modal-dialog modal-lg" role="document"><div class="modal-content"><div class="modal-header"><button type="button" class="close" data-dismiss="modal" aria-label="Close"><span aria-hidden="true">&times;</span></button><h4 class="modal-title" id="-graph-help-label">Graph Key</h4></div><div class="modal-body">
    <p>Nodes of different colours represent the following: </p>
    <?xml version="1.0" encoding="UTF-8" standalone="no"?>
<!DOCTYPE svg PUBLIC "-//W3C//DTD SVG 1.1//EN"
 "http://www.w3.org/Graphics/SVG/1.1/DTD/svg11.dtd">
<!-- Generated by graphviz version 2.40.1 (20161225.0304)
 -->
<!-- Title: Graph Key Pages: 1 -->
<svg width="190pt" height="32pt"
 viewBox="0.00 0.00 190.00 32.00" xmlns="http://www.w3.org/2000/svg" xmlns:xlink="http://www.w3.org/1999/xlink">
<g id="graph0" class="graph" transform="scale(1 1) rotate(0) translate(4 28)">
<title>Graph Key</title>
<polygon fill="#ffffff" stroke="transparent" points="-4,4 -4,-28 186,-28 186,4 -4,4"/>
<!-- Source File -->
<g id="node1" class="node">
<title>Source File</title>
<polygon fill="#f0ad4e" stroke="#f0ad4e" points="67,-24 0,-24 0,0 67,0 67,-24"/>
<text text-anchor="middle" x="33.5" y="-9.6" font-family="Helvetica,sans-Serif" font-size="10.50" fill="#ffffff">Source File</text>
</g>
<!-- This Page&#39;s Entity -->
<g id="node2" class="node">
<title>This Page&#39;s Entity</title>
<polygon fill="none" stroke="#000000" points="182,-24 85,-24 85,0 182,0 182,-24"/>
<text text-anchor="middle" x="133.5" y="-9.6" font-family="Helvetica,sans-Serif" font-size="10.50" fill="#000000">This Page&#39;s Entity</text>
</g>
</g>
</svg>

    
    <p>Solid arrows point from a file to a file which it depends on. A file
    is dependent upon another if the latter must be compiled before the former
    can be. Where possible, edges connecting nodes are given different colours to make them easier to distinguish in large graphs.
    </p>
    </div></div></div></div>
      </div>
    </div>
      
      <br>

    <section class="visible-xs visible-sm hidden-md">
      
<h3>Contents</h3>
 







<div class="panel panel-primary">
  <div class="panel-heading text-left"><h3 class="panel-title"><a data-toggle="collapse" href="#mods-1">Modules</a></h3></div>
  <div id="mods-1" class="panel-collapse collapse">
    <div class="list-group">
      
      <a class="list-group-item" href="../module/modforces.html">modforces</a>
      
    </div>
  </div>
</div>
















<div class="panel panel-primary">
  <div class="panel-heading text-left"><h3 class="panel-title">Source Code</h3></div>
  <div class="list-group">
    <a class="list-group-item" href="../sourcefile/modforces.f90.html#src">modforces.f90</a>
  </div>
</div>



    </section>
    <br class="visible-xs visible-sm hidden-md">

    <section>
      <h2><span class="anchor" id="src"></span>Source Code</h2>
    <div class="hl"><pre><span></span><a name="ln-1"></a><span class="c">!&gt; \file modforces.f90</span>
<a name="ln-2"></a><span class="c">!!  Calculates the other forces and sources in the equations.</span>
<a name="ln-3"></a>
<a name="ln-4"></a><span class="c">!&gt;</span>
<a name="ln-5"></a><span class="c">!!  Calculates the other forces and sources in the equations.</span>
<a name="ln-6"></a><span class="c">!&gt;</span>
<a name="ln-7"></a><span class="c">!!  This includes the large scale forcings, the coriolis and the subsidence</span>
<a name="ln-8"></a><span class="c">!!  \author Jasper Tomas, TU Delft  March 31 2014</span>
<a name="ln-9"></a><span class="c">!!  \author Pier Siebesma, K.N.M.I.</span>
<a name="ln-10"></a><span class="c">!!  \author Stephan de Roode,TU Delft</span>
<a name="ln-11"></a><span class="c">!!  \author Chiel van Heerwaarden, Wageningen U.R.</span>
<a name="ln-12"></a><span class="c">!!  \author Thijs Heus,MPI-M</span>
<a name="ln-13"></a><span class="c">!!  \par Revision list</span>
<a name="ln-14"></a><span class="c">!!  Only the routine &#39;forces&#39; is used</span>
<a name="ln-15"></a><span class="c">!!  \todo Documentation</span>
<a name="ln-16"></a><span class="c">!  This file is part of DALES.</span>
<a name="ln-17"></a><span class="c">!</span>
<a name="ln-18"></a><span class="c">! DALES is free software; you can redistribute it and/or modify</span>
<a name="ln-19"></a><span class="c">! it under the terms of the GNU General Public License as published by</span>
<a name="ln-20"></a><span class="c">! the Free Software Foundation; either version 3 of the License, or</span>
<a name="ln-21"></a><span class="c">! (at your option) any later version.</span>
<a name="ln-22"></a><span class="c">!</span>
<a name="ln-23"></a><span class="c">! DALES is distributed in the hope that it will be useful,</span>
<a name="ln-24"></a><span class="c">! but WITHOUT ANY WARRANTY; without even the implied warranty of</span>
<a name="ln-25"></a><span class="c">! MERCHANTABILITY or FITNESS FOR A PARTICULAR PURPOSE.  See the</span>
<a name="ln-26"></a><span class="c">! GNU General Public License for more details.</span>
<a name="ln-27"></a><span class="c">!</span>
<a name="ln-28"></a><span class="c">! You should have received a copy of the GNU General Public License</span>
<a name="ln-29"></a><span class="c">! along with this program.  If not, see &lt;http://www.gnu.org/licenses/&gt;.</span>
<a name="ln-30"></a><span class="c">!</span>
<a name="ln-31"></a><span class="c">!  Copyright 1993-2009 Delft University of Technology, Wageningen University, Utrecht University, KNMI</span>
<a name="ln-32"></a><span class="c">!</span>
<a name="ln-33"></a>
<a name="ln-34"></a>
<a name="ln-35"></a>
<a name="ln-36"></a><span class="k">module </span><span class="n">modforces</span>
<a name="ln-37"></a>  <span class="c">!Calculates additional forces and large scale tendencies</span>
<a name="ln-38"></a>  <span class="k">implicit none</span>
<a name="ln-39"></a><span class="k">  save</span>
<a name="ln-40"></a><span class="k">  private</span>
<a name="ln-41"></a><span class="k">  public</span> <span class="kd">::</span> <span class="n">forces</span><span class="p">,</span> <span class="n">coriolis</span><span class="p">,</span> <span class="n">lstend</span><span class="p">,</span><span class="n">fixuinf1</span><span class="p">,</span><span class="n">fixuinf2</span><span class="p">,</span><span class="n">fixthetainf</span><span class="p">,&amp;</span>
<a name="ln-42"></a>            <span class="n">detfreestream</span><span class="p">,</span><span class="n">detfreestrtmp</span><span class="p">,</span><span class="n">nudge</span><span class="p">,&amp;</span>
<a name="ln-43"></a>            <span class="n">masscorr</span><span class="p">,</span><span class="n">uoutletarea</span><span class="p">,</span><span class="n">voutletarea</span><span class="p">,</span><span class="n">fluidvolume</span><span class="p">,</span><span class="n">calcfluidvolumes</span>
<a name="ln-44"></a>  <span class="k">contains</span>
<a name="ln-45"></a>
<a name="ln-46"></a><span class="k">  subroutine </span><span class="n">forces</span>
<a name="ln-47"></a>
<a name="ln-48"></a>    <span class="c">!-----------------------------------------------------------------|</span>
<a name="ln-49"></a>    <span class="c">!                                                                 |</span>
<a name="ln-50"></a>    <span class="c">!      Hans Cuijpers   I.M.A.U.                                   |</span>
<a name="ln-51"></a>    <span class="c">!      Pier Siebesma   K.N.M.I.     06/01/1995                    |</span>
<a name="ln-52"></a>    <span class="c">!                                                                 |</span>
<a name="ln-53"></a>    <span class="c">!     purpose.                                                    |</span>
<a name="ln-54"></a>    <span class="c">!     --------                                                    |</span>
<a name="ln-55"></a>    <span class="c">!                                                                 |</span>
<a name="ln-56"></a>    <span class="c">!      Calculates all other terms in the N-S equation,            |</span>
<a name="ln-57"></a>    <span class="c">!      except for the diffusion and advection terms.              |</span>
<a name="ln-58"></a>    <span class="c">!                                                                 |</span>
<a name="ln-59"></a>    <span class="c">!**   interface.                                                  |</span>
<a name="ln-60"></a>    <span class="c">!     ----------                                                  |</span>
<a name="ln-61"></a>    <span class="c">!                                                                 |</span>
<a name="ln-62"></a>    <span class="c">!     *forces* is called from *program*.                          |</span>
<a name="ln-63"></a>    <span class="c">!                                                                 |</span>
<a name="ln-64"></a>    <span class="c">!-----------------------------------------------------------------|</span>
<a name="ln-65"></a>
<a name="ln-66"></a>    <span class="c">!  use modglobal, only : i1,j1,kmax,dzh,dzf,grav</span>
<a name="ln-67"></a>    <span class="k">use </span><span class="n">modglobal</span><span class="p">,</span> <span class="n">only</span> <span class="p">:</span> <span class="n">ib</span><span class="p">,</span><span class="n">ie</span><span class="p">,</span><span class="n">jb</span><span class="p">,</span><span class="n">je</span><span class="p">,</span><span class="n">kb</span><span class="p">,</span><span class="n">ke</span><span class="p">,</span><span class="n">kh</span><span class="p">,</span><span class="n">dzhi</span><span class="p">,</span><span class="n">dzf</span><span class="p">,</span><span class="n">grav</span><span class="p">,</span><span class="n">lbuoyancy</span>
<a name="ln-68"></a>    <span class="k">use </span><span class="n">modfields</span><span class="p">,</span> <span class="n">only</span> <span class="p">:</span> <span class="n">u0</span><span class="p">,</span><span class="n">v0</span><span class="p">,</span><span class="n">w0</span><span class="p">,</span><span class="n">up</span><span class="p">,</span><span class="n">vp</span><span class="p">,</span><span class="n">wp</span><span class="p">,</span><span class="n">thv0h</span><span class="p">,</span><span class="n">dpdxl</span><span class="p">,</span><span class="n">dpdyl</span><span class="p">,</span><span class="n">thlp</span><span class="p">,</span><span class="n">thlpcar</span><span class="p">,</span><span class="n">thvh</span>
<a name="ln-69"></a>    <span class="k">use </span><span class="n">modibmdata</span><span class="p">,</span> <span class="n">only</span> <span class="p">:</span> <span class="n">nxwallsnorm</span><span class="p">,</span> <span class="n">xwallsnorm</span>
<a name="ln-70"></a>    <span class="k">use </span><span class="n">modsurfdata</span><span class="p">,</span><span class="n">only</span> <span class="p">:</span> <span class="n">thvs</span>
<a name="ln-71"></a>    <span class="k">use </span><span class="n">modmpi</span><span class="p">,</span> <span class="n">only</span> <span class="p">:</span> <span class="n">myid</span>
<a name="ln-72"></a>    <span class="k">implicit none</span>
<a name="ln-73"></a>
<a name="ln-74"></a><span class="k">    </span><span class="kt">real </span><span class="n">thvsi</span>
<a name="ln-75"></a>    <span class="kt">integer </span><span class="n">i</span><span class="p">,</span> <span class="n">j</span><span class="p">,</span> <span class="n">k</span><span class="p">,</span> <span class="n">n</span><span class="p">,</span> <span class="n">jm</span><span class="p">,</span> <span class="n">jp</span><span class="p">,</span> <span class="n">km</span><span class="p">,</span> <span class="n">kp</span>
<a name="ln-76"></a>
<a name="ln-77"></a>
<a name="ln-78"></a>    <span class="k">if</span> <span class="p">(</span><span class="n">lbuoyancy</span> <span class="p">)</span> <span class="k">then</span>
<a name="ln-79"></a>    <span class="c">!ILS13 replace thvsi by thvh</span>
<a name="ln-80"></a>    <span class="c">! thvsi = 1./thvsi</span>
<a name="ln-81"></a>
<a name="ln-82"></a> 
<a name="ln-83"></a>       <span class="c">!write(*,*) &#39;thvh&#39;,thvh</span>
<a name="ln-84"></a>       <span class="k">do </span><span class="n">k</span><span class="o">=</span><span class="n">kb</span><span class="o">+</span><span class="mi">1</span><span class="p">,</span><span class="n">ke</span>
<a name="ln-85"></a>          <span class="k">do </span><span class="n">j</span><span class="o">=</span><span class="n">jb</span><span class="p">,</span><span class="n">je</span>
<a name="ln-86"></a>             <span class="k">do </span><span class="n">i</span><span class="o">=</span><span class="n">ib</span><span class="p">,</span><span class="n">ie</span>
<a name="ln-87"></a>                <span class="n">up</span><span class="p">(</span><span class="n">i</span><span class="p">,</span><span class="n">j</span><span class="p">,</span><span class="n">k</span><span class="p">)</span> <span class="o">=</span> <span class="n">up</span><span class="p">(</span><span class="n">i</span><span class="p">,</span><span class="n">j</span><span class="p">,</span><span class="n">k</span><span class="p">)</span> <span class="o">-</span> <span class="n">dpdxl</span><span class="p">(</span><span class="n">k</span><span class="p">)</span>
<a name="ln-88"></a>                <span class="n">vp</span><span class="p">(</span><span class="n">i</span><span class="p">,</span><span class="n">j</span><span class="p">,</span><span class="n">k</span><span class="p">)</span> <span class="o">=</span> <span class="n">vp</span><span class="p">(</span><span class="n">i</span><span class="p">,</span><span class="n">j</span><span class="p">,</span><span class="n">k</span><span class="p">)</span> <span class="o">-</span> <span class="n">dpdyl</span><span class="p">(</span><span class="n">k</span><span class="p">)</span>
<a name="ln-89"></a>                <span class="n">wp</span><span class="p">(</span><span class="n">i</span><span class="p">,</span><span class="n">j</span><span class="p">,</span><span class="n">k</span><span class="p">)</span> <span class="o">=</span> <span class="n">wp</span><span class="p">(</span><span class="n">i</span><span class="p">,</span><span class="n">j</span><span class="p">,</span><span class="n">k</span><span class="p">)</span> <span class="o">+</span> <span class="n">grav</span> <span class="o">*</span> <span class="p">(</span><span class="n">thv0h</span><span class="p">(</span><span class="n">i</span><span class="p">,</span><span class="n">j</span><span class="p">,</span><span class="n">k</span><span class="p">)</span><span class="o">-</span><span class="n">thvh</span><span class="p">(</span><span class="n">k</span><span class="p">))</span><span class="o">/</span><span class="n">thvh</span><span class="p">(</span><span class="n">k</span><span class="p">)</span>
<a name="ln-90"></a>             <span class="k">end do</span>
<a name="ln-91"></a><span class="k">          end do</span>
<a name="ln-92"></a><span class="k">       end do</span>
<a name="ln-93"></a>
<a name="ln-94"></a><span class="k">    else</span>
<a name="ln-95"></a>
<a name="ln-96"></a><span class="k">       do </span><span class="n">k</span><span class="o">=</span><span class="n">kb</span><span class="o">+</span><span class="mi">1</span><span class="p">,</span><span class="n">ke</span>
<a name="ln-97"></a>          <span class="k">do </span><span class="n">j</span><span class="o">=</span><span class="n">jb</span><span class="p">,</span><span class="n">je</span>
<a name="ln-98"></a>             <span class="k">do </span><span class="n">i</span><span class="o">=</span><span class="n">ib</span><span class="p">,</span><span class="n">ie</span>
<a name="ln-99"></a>                <span class="n">up</span><span class="p">(</span><span class="n">i</span><span class="p">,</span><span class="n">j</span><span class="p">,</span><span class="n">k</span><span class="p">)</span> <span class="o">=</span> <span class="n">up</span><span class="p">(</span><span class="n">i</span><span class="p">,</span><span class="n">j</span><span class="p">,</span><span class="n">k</span><span class="p">)</span> <span class="o">-</span> <span class="n">dpdxl</span><span class="p">(</span><span class="n">k</span><span class="p">)</span>
<a name="ln-100"></a>                <span class="n">vp</span><span class="p">(</span><span class="n">i</span><span class="p">,</span><span class="n">j</span><span class="p">,</span><span class="n">k</span><span class="p">)</span> <span class="o">=</span> <span class="n">vp</span><span class="p">(</span><span class="n">i</span><span class="p">,</span><span class="n">j</span><span class="p">,</span><span class="n">k</span><span class="p">)</span> <span class="o">-</span> <span class="n">dpdyl</span><span class="p">(</span><span class="n">k</span><span class="p">)</span>
<a name="ln-101"></a>                <span class="c">! IS+HJ      wp(i,j,k) = wp(i,j,k)</span>
<a name="ln-102"></a>             <span class="k">end do</span>
<a name="ln-103"></a><span class="k">          end do</span>
<a name="ln-104"></a><span class="k">       end do</span>
<a name="ln-105"></a><span class="k">    end if</span>
<a name="ln-106"></a>
<a name="ln-107"></a>    <span class="c">!     ----------------------------------------------</span>
<a name="ln-108"></a>    <span class="c">!     add radiative heating to potential temperature</span>
<a name="ln-109"></a>    <span class="c">!     ----------------------------------------------</span>
<a name="ln-110"></a>    <span class="k">do </span><span class="n">k</span><span class="o">=</span><span class="n">kb</span><span class="p">,</span><span class="n">ke</span>
<a name="ln-111"></a>       <span class="k">do </span><span class="n">j</span><span class="o">=</span><span class="n">jb</span><span class="p">,</span><span class="n">je</span>
<a name="ln-112"></a>          <span class="k">do </span><span class="n">i</span><span class="o">=</span><span class="n">ib</span><span class="p">,</span><span class="n">ie</span>
<a name="ln-113"></a>             <span class="n">thlp</span><span class="p">(</span><span class="n">i</span><span class="p">,</span><span class="n">j</span><span class="p">,</span><span class="n">k</span><span class="p">)</span> <span class="o">=</span> <span class="n">thlp</span><span class="p">(</span><span class="n">i</span><span class="p">,</span><span class="n">j</span><span class="p">,</span><span class="n">k</span><span class="p">)</span><span class="o">+</span><span class="n">thlpcar</span><span class="p">(</span><span class="n">k</span><span class="p">)</span>
<a name="ln-114"></a>          <span class="k">end do</span>
<a name="ln-115"></a><span class="k">       end do</span>
<a name="ln-116"></a><span class="k">    end do</span>
<a name="ln-117"></a>
<a name="ln-118"></a>    <span class="c">!     --------------------------------------------</span>
<a name="ln-119"></a>    <span class="c">!     special treatment for lowest full level: k=1</span>
<a name="ln-120"></a>    <span class="c">!     --------------------------------------------</span>
<a name="ln-121"></a>
<a name="ln-122"></a>    <span class="k">do </span><span class="n">j</span><span class="o">=</span><span class="n">jb</span><span class="p">,</span><span class="n">je</span>
<a name="ln-123"></a>       <span class="n">jp</span> <span class="o">=</span> <span class="n">j</span><span class="o">+</span><span class="mi">1</span>
<a name="ln-124"></a>       <span class="n">jm</span> <span class="o">=</span> <span class="n">j</span><span class="o">-</span><span class="mi">1</span>
<a name="ln-125"></a>       <span class="k">do </span><span class="n">i</span><span class="o">=</span><span class="n">ib</span><span class="p">,</span><span class="n">ie</span>
<a name="ln-126"></a>
<a name="ln-127"></a>          <span class="n">up</span><span class="p">(</span><span class="n">i</span><span class="p">,</span><span class="n">j</span><span class="p">,</span><span class="n">kb</span><span class="p">)</span> <span class="o">=</span> <span class="n">up</span><span class="p">(</span><span class="n">i</span><span class="p">,</span><span class="n">j</span><span class="p">,</span><span class="n">kb</span><span class="p">)</span> <span class="o">-</span> <span class="n">dpdxl</span><span class="p">(</span><span class="n">kb</span><span class="p">)</span>
<a name="ln-128"></a>
<a name="ln-129"></a>          <span class="n">vp</span><span class="p">(</span><span class="n">i</span><span class="p">,</span><span class="n">j</span><span class="p">,</span><span class="n">kb</span><span class="p">)</span> <span class="o">=</span> <span class="n">vp</span><span class="p">(</span><span class="n">i</span><span class="p">,</span><span class="n">j</span><span class="p">,</span><span class="n">kb</span><span class="p">)</span> <span class="o">-</span> <span class="n">dpdyl</span><span class="p">(</span><span class="n">kb</span><span class="p">)</span>
<a name="ln-130"></a>
<a name="ln-131"></a>          <span class="n">wp</span><span class="p">(</span><span class="n">i</span><span class="p">,</span><span class="n">j</span><span class="p">,</span><span class="n">kb</span><span class="p">)</span> <span class="o">=</span> <span class="mf">0.0</span>
<a name="ln-132"></a>
<a name="ln-133"></a>       <span class="k">end do</span>
<a name="ln-134"></a><span class="k">    end do</span>
<a name="ln-135"></a>    <span class="c">!     ----------------------------------------------end i,j-loop</span>
<a name="ln-136"></a>
<a name="ln-137"></a>
<a name="ln-138"></a>    <span class="k">return</span>
<a name="ln-139"></a><span class="k">  end subroutine </span><span class="n">forces</span>
<a name="ln-140"></a>
<a name="ln-141"></a>  <span class="k">subroutine </span><span class="n">detfreestream</span><span class="p">(</span><span class="n">freestream</span><span class="p">)</span>
<a name="ln-142"></a>    <span class="k">use </span><span class="n">modglobal</span><span class="p">,</span> <span class="n">only</span> <span class="p">:</span> <span class="n">ib</span><span class="p">,</span><span class="n">ie</span><span class="p">,</span><span class="n">jb</span><span class="p">,</span><span class="n">je</span><span class="p">,</span><span class="n">kb</span><span class="p">,</span><span class="n">ke</span><span class="p">,</span><span class="n">kh</span><span class="p">,</span><span class="n">dxf</span><span class="p">,</span><span class="n">xh</span><span class="p">,</span><span class="n">dt</span><span class="p">,&amp;</span>
<a name="ln-143"></a>                          <span class="n">Uinf</span><span class="p">,</span><span class="n">lvinf</span><span class="p">,</span><span class="n">dy</span>
<a name="ln-144"></a>    <span class="k">use </span><span class="n">modfields</span><span class="p">,</span> <span class="n">only</span> <span class="p">:</span> <span class="n">u0</span><span class="p">,</span><span class="n">dpdxl</span><span class="p">,</span><span class="n">dgdt</span><span class="p">,</span><span class="n">dpdx</span><span class="p">,</span><span class="n">v0</span>
<a name="ln-145"></a>    <span class="k">use </span><span class="n">modmpi</span><span class="p">,</span> <span class="n">only</span>    <span class="p">:</span> <span class="n">myid</span><span class="p">,</span><span class="n">comm3d</span><span class="p">,</span><span class="n">mpierr</span><span class="p">,</span><span class="n">mpi_sum</span><span class="p">,</span><span class="n">my_real</span><span class="p">,</span><span class="n">nprocs</span>
<a name="ln-146"></a>    <span class="k">implicit none</span>
<a name="ln-147"></a><span class="k">    </span><span class="kt">real</span><span class="p">,</span> <span class="k">intent</span><span class="p">(</span><span class="n">out</span><span class="p">)</span> <span class="kd">::</span> <span class="n">freestream</span>
<a name="ln-148"></a>
<a name="ln-149"></a>    <span class="kt">real  </span><span class="n">utop</span><span class="p">,</span><span class="n">vtop</span><span class="p">,</span><span class="n">dum</span>
<a name="ln-150"></a>    <span class="kt">integer </span><span class="n">i</span><span class="p">,</span><span class="n">j</span>
<a name="ln-151"></a>
<a name="ln-152"></a>    <span class="k">if</span> <span class="p">(</span><span class="n">lvinf</span><span class="p">)</span> <span class="k">then</span>
<a name="ln-153"></a><span class="k">        </span><span class="n">vtop</span> <span class="o">=</span> <span class="mf">0.</span>
<a name="ln-154"></a>        <span class="k">do </span><span class="n">j</span> <span class="o">=</span><span class="n">jb</span><span class="p">,</span><span class="n">je</span>
<a name="ln-155"></a>          <span class="k">do </span><span class="n">i</span> <span class="o">=</span><span class="n">ib</span><span class="p">,</span><span class="n">ie</span>
<a name="ln-156"></a>            <span class="n">vtop</span> <span class="o">=</span> <span class="n">vtop</span> <span class="o">+</span> <span class="mf">0.5</span><span class="o">*</span><span class="p">(</span><span class="n">v0</span><span class="p">(</span><span class="n">i</span><span class="p">,</span><span class="n">j</span><span class="p">,</span><span class="n">ke</span><span class="p">)</span><span class="o">+</span><span class="n">u0</span><span class="p">(</span><span class="n">i</span><span class="p">,</span><span class="n">j</span><span class="o">+</span><span class="mi">1</span><span class="p">,</span><span class="n">ke</span><span class="p">))</span><span class="o">*</span><span class="n">dy</span>
<a name="ln-157"></a>          <span class="k">end do</span>
<a name="ln-158"></a><span class="k">        end do</span>
<a name="ln-159"></a><span class="k">        </span><span class="n">vtop</span> <span class="o">=</span> <span class="n">vtop</span> <span class="o">/</span> <span class="p">(</span> <span class="p">(</span><span class="n">je</span><span class="o">-</span><span class="n">jb</span><span class="o">+</span><span class="mi">1</span><span class="p">)</span><span class="o">*</span><span class="p">(</span><span class="n">xh</span><span class="p">(</span><span class="n">ie</span><span class="o">+</span><span class="mi">1</span><span class="p">)</span><span class="o">-</span><span class="n">xh</span><span class="p">(</span><span class="n">ib</span><span class="p">)</span> <span class="p">)</span> <span class="p">)</span>
<a name="ln-160"></a>        <span class="k">call </span><span class="n">MPI_ALLREDUCE</span><span class="p">(</span><span class="n">vtop</span><span class="p">,</span>   <span class="n">dum</span><span class="p">,</span><span class="mi">1</span><span class="p">,</span><span class="n">MY_REAL</span><span class="p">,</span><span class="n">MPI_SUM</span><span class="p">,</span><span class="n">comm3d</span><span class="p">,</span><span class="n">mpierr</span><span class="p">)</span>
<a name="ln-161"></a>        <span class="n">freestream</span> <span class="o">=</span> <span class="n">dum</span> <span class="o">/</span> <span class="n">nprocs</span>
<a name="ln-162"></a>    <span class="k">else</span>
<a name="ln-163"></a><span class="k">        </span><span class="n">utop</span> <span class="o">=</span> <span class="mf">0.</span>
<a name="ln-164"></a>        <span class="k">do </span><span class="n">j</span> <span class="o">=</span><span class="n">jb</span><span class="p">,</span><span class="n">je</span>
<a name="ln-165"></a>          <span class="k">do </span><span class="n">i</span> <span class="o">=</span><span class="n">ib</span><span class="p">,</span><span class="n">ie</span>
<a name="ln-166"></a>            <span class="c">!dum=0.5*(u0(i,j,ke)+u0(i+1,j,ke))*dxf(i)</span>
<a name="ln-167"></a>            <span class="c">!utop = utop + dum</span>
<a name="ln-168"></a>            <span class="n">utop</span> <span class="o">=</span> <span class="n">utop</span> <span class="o">+</span> <span class="mf">0.5</span><span class="o">*</span><span class="p">(</span><span class="n">u0</span><span class="p">(</span><span class="n">i</span><span class="p">,</span><span class="n">j</span><span class="p">,</span><span class="n">ke</span><span class="p">)</span><span class="o">+</span><span class="n">u0</span><span class="p">(</span><span class="n">i</span><span class="o">+</span><span class="mi">1</span><span class="p">,</span><span class="n">j</span><span class="p">,</span><span class="n">ke</span><span class="p">))</span><span class="o">*</span><span class="n">dxf</span><span class="p">(</span><span class="n">i</span><span class="p">)</span>
<a name="ln-169"></a>          <span class="k">end do</span>
<a name="ln-170"></a><span class="k">        end do</span>
<a name="ln-171"></a><span class="k">        </span><span class="n">utop</span> <span class="o">=</span> <span class="n">utop</span> <span class="o">/</span> <span class="p">(</span> <span class="p">(</span><span class="n">je</span><span class="o">-</span><span class="n">jb</span><span class="o">+</span><span class="mi">1</span><span class="p">)</span><span class="o">*</span><span class="p">(</span><span class="n">xh</span><span class="p">(</span><span class="n">ie</span><span class="o">+</span><span class="mi">1</span><span class="p">)</span><span class="o">-</span><span class="n">xh</span><span class="p">(</span><span class="n">ib</span><span class="p">)</span> <span class="p">)</span> <span class="p">)</span>
<a name="ln-172"></a>        <span class="k">call </span><span class="n">MPI_ALLREDUCE</span><span class="p">(</span><span class="n">utop</span><span class="p">,</span>   <span class="n">dum</span><span class="p">,</span><span class="mi">1</span><span class="p">,</span><span class="n">MY_REAL</span><span class="p">,</span><span class="n">MPI_SUM</span><span class="p">,</span><span class="n">comm3d</span><span class="p">,</span><span class="n">mpierr</span><span class="p">)</span>
<a name="ln-173"></a>        <span class="n">freestream</span> <span class="o">=</span> <span class="n">dum</span> <span class="o">/</span> <span class="n">nprocs</span>
<a name="ln-174"></a>    <span class="c">!write(*,*) &quot;myid,utop,dum,freestream&quot;,myid,utop,dum,freestream</span>
<a name="ln-175"></a>    <span class="k">end if</span>
<a name="ln-176"></a>
<a name="ln-177"></a><span class="k">  end subroutine </span><span class="n">detfreestream</span>
<a name="ln-178"></a>
<a name="ln-179"></a>  <span class="k">subroutine </span><span class="n">detfreestrtmp</span><span class="p">(</span><span class="n">freestrtmp</span><span class="p">)</span>
<a name="ln-180"></a>    <span class="k">use </span><span class="n">modglobal</span><span class="p">,</span> <span class="n">only</span> <span class="p">:</span> <span class="n">ib</span><span class="p">,</span><span class="n">ie</span><span class="p">,</span><span class="n">jb</span><span class="p">,</span><span class="n">je</span><span class="p">,</span><span class="n">kb</span><span class="p">,</span><span class="n">ke</span><span class="p">,</span><span class="n">kh</span><span class="p">,</span><span class="n">dxf</span><span class="p">,</span><span class="n">xh</span><span class="p">,</span><span class="n">dt</span><span class="p">,&amp;</span>
<a name="ln-181"></a>                          <span class="n">Uinf</span>
<a name="ln-182"></a>    <span class="k">use </span><span class="n">modfields</span><span class="p">,</span> <span class="n">only</span> <span class="p">:</span> <span class="n">thl0</span><span class="p">,</span><span class="n">dpdxl</span><span class="p">,</span><span class="n">dgdt</span><span class="p">,</span><span class="n">dpdx</span>
<a name="ln-183"></a>    <span class="k">use </span><span class="n">modmpi</span><span class="p">,</span> <span class="n">only</span>    <span class="p">:</span> <span class="n">myid</span><span class="p">,</span><span class="n">comm3d</span><span class="p">,</span><span class="n">mpierr</span><span class="p">,</span><span class="n">mpi_sum</span><span class="p">,</span><span class="n">my_real</span><span class="p">,</span><span class="n">nprocs</span>
<a name="ln-184"></a>    <span class="k">implicit none</span>
<a name="ln-185"></a>
<a name="ln-186"></a><span class="k">    </span><span class="kt">real</span><span class="p">,</span> <span class="k">intent</span><span class="p">(</span><span class="n">out</span><span class="p">)</span> <span class="kd">::</span> <span class="n">freestrtmp</span>
<a name="ln-187"></a>
<a name="ln-188"></a>    <span class="kt">real  </span><span class="n">ttop</span>
<a name="ln-189"></a>    <span class="kt">integer </span><span class="n">i</span><span class="p">,</span><span class="n">j</span>
<a name="ln-190"></a>
<a name="ln-191"></a>    <span class="n">ttop</span> <span class="o">=</span> <span class="mf">0.</span>
<a name="ln-192"></a>
<a name="ln-193"></a>    <span class="k">do </span><span class="n">j</span> <span class="o">=</span><span class="n">jb</span><span class="p">,</span><span class="n">je</span>
<a name="ln-194"></a>      <span class="k">do </span><span class="n">i</span> <span class="o">=</span><span class="n">ib</span><span class="p">,</span><span class="n">ie</span>
<a name="ln-195"></a>        <span class="n">ttop</span> <span class="o">=</span> <span class="n">ttop</span> <span class="o">+</span> <span class="n">thl0</span><span class="p">(</span><span class="n">i</span><span class="p">,</span><span class="n">j</span><span class="p">,</span><span class="n">ke</span><span class="p">)</span><span class="o">*</span><span class="n">dxf</span><span class="p">(</span><span class="n">i</span><span class="p">)</span>
<a name="ln-196"></a>      <span class="k">end do</span>
<a name="ln-197"></a><span class="k">    end do</span>
<a name="ln-198"></a><span class="k">    </span><span class="n">ttop</span> <span class="o">=</span> <span class="n">ttop</span> <span class="o">/</span> <span class="p">(</span> <span class="p">(</span><span class="n">je</span><span class="o">-</span><span class="n">jb</span><span class="o">+</span><span class="mi">1</span><span class="p">)</span><span class="o">*</span><span class="p">(</span><span class="n">xh</span><span class="p">(</span><span class="n">ie</span><span class="o">+</span><span class="mi">1</span><span class="p">)</span><span class="o">-</span><span class="n">xh</span><span class="p">(</span><span class="n">ib</span><span class="p">)</span> <span class="p">)</span> <span class="p">)</span>
<a name="ln-199"></a>    <span class="k">call </span><span class="n">MPI_ALLREDUCE</span><span class="p">(</span><span class="n">ttop</span><span class="p">,</span>    <span class="n">freestrtmp</span><span class="p">,</span><span class="mi">1</span><span class="p">,</span><span class="n">MY_REAL</span><span class="p">,</span><span class="n">MPI_SUM</span><span class="p">,</span><span class="n">comm3d</span><span class="p">,</span><span class="n">mpierr</span><span class="p">)</span>
<a name="ln-200"></a>    <span class="n">freestrtmp</span> <span class="o">=</span> <span class="n">freestrtmp</span> <span class="o">/</span> <span class="n">nprocs</span>
<a name="ln-201"></a>
<a name="ln-202"></a>  <span class="k">end subroutine </span><span class="n">detfreestrtmp</span>
<a name="ln-203"></a>
<a name="ln-204"></a>  <span class="k">subroutine </span><span class="n">fixuinf2</span>
<a name="ln-205"></a>    <span class="k">use </span><span class="n">modglobal</span><span class="p">,</span> <span class="n">only</span> <span class="p">:</span> <span class="n">ib</span><span class="p">,</span><span class="n">ie</span><span class="p">,</span><span class="n">jb</span><span class="p">,</span><span class="n">je</span><span class="p">,</span><span class="n">kb</span><span class="p">,</span><span class="n">ke</span><span class="p">,</span><span class="n">kh</span><span class="p">,</span><span class="n">dxf</span><span class="p">,</span><span class="n">xh</span><span class="p">,</span><span class="n">dt</span><span class="p">,&amp;</span>
<a name="ln-206"></a>                          <span class="n">Uinf</span><span class="p">,</span><span class="n">ifixuinf</span><span class="p">,</span><span class="n">tscale</span><span class="p">,</span><span class="n">timee</span><span class="p">,</span><span class="n">rk3step</span><span class="p">,</span><span class="n">inletav</span><span class="p">,&amp;</span>
<a name="ln-207"></a>                          <span class="n">freestreamav</span><span class="p">,</span><span class="n">freestrtmpav</span><span class="p">,</span><span class="n">ltempeq</span>
<a name="ln-208"></a>    <span class="k">use </span><span class="n">modsurfdata</span><span class="p">,</span><span class="n">only</span><span class="p">:</span> <span class="n">thl_top</span>
<a name="ln-209"></a>    <span class="k">use </span><span class="n">modfields</span><span class="p">,</span> <span class="n">only</span> <span class="p">:</span> <span class="n">u0</span><span class="p">,</span><span class="n">thl0</span><span class="p">,</span><span class="n">dpdxl</span><span class="p">,</span><span class="n">dgdt</span><span class="p">,</span><span class="n">dpdx</span><span class="p">,</span><span class="n">thlsrcdt</span>
<a name="ln-210"></a>    <span class="k">use </span><span class="n">modmpi</span><span class="p">,</span> <span class="n">only</span>    <span class="p">:</span> <span class="n">myid</span><span class="p">,</span><span class="n">comm3d</span><span class="p">,</span><span class="n">mpierr</span><span class="p">,</span><span class="n">mpi_sum</span><span class="p">,</span><span class="n">my_real</span><span class="p">,</span><span class="n">nprocs</span>
<a name="ln-211"></a>    <span class="k">implicit none</span>
<a name="ln-212"></a>
<a name="ln-213"></a><span class="k">    </span><span class="kt">real  </span><span class="n">utop</span><span class="p">,</span><span class="n">freestream</span><span class="p">,</span><span class="n">freestrtmp</span><span class="p">,</span><span class="n">rk3coef</span>
<a name="ln-214"></a>    <span class="kt">integer </span><span class="n">i</span><span class="p">,</span><span class="n">j</span>
<a name="ln-215"></a>
<a name="ln-216"></a>    <span class="n">utop</span> <span class="o">=</span> <span class="mf">0.</span>
<a name="ln-217"></a>
<a name="ln-218"></a>    <span class="k">if</span> <span class="p">((</span><span class="n">ifixuinf</span><span class="o">==</span><span class="mi">2</span><span class="p">)</span> <span class="p">.</span><span class="nb">and</span><span class="p">.</span> <span class="p">(</span><span class="n">rk3step</span><span class="o">==</span><span class="mi">3</span><span class="p">))</span> <span class="k">then</span>
<a name="ln-219"></a><span class="k">      call </span><span class="n">detfreestream</span><span class="p">(</span><span class="n">freestream</span><span class="p">)</span>
<a name="ln-220"></a>
<a name="ln-221"></a>      <span class="n">freestreamav</span><span class="o">=</span>  <span class="n">freestream</span><span class="o">*</span><span class="n">dt</span><span class="o">/</span><span class="n">inletav</span> <span class="o">+</span> <span class="p">(</span><span class="mf">1.</span><span class="o">-</span><span class="n">dt</span><span class="o">/</span><span class="n">inletav</span><span class="p">)</span><span class="o">*</span><span class="n">freestreamav</span>
<a name="ln-222"></a>
<a name="ln-223"></a>      <span class="c">! Write some statistics to monitoring file</span>
<a name="ln-224"></a>      <span class="c">! if (myid==0) then</span>
<a name="ln-225"></a>      <span class="c">!   open(unit=11,file=&#39;freestr.txt&#39;,position=&#39;append&#39;)</span>
<a name="ln-226"></a>      <span class="c">!   write(11,3002) timee,freestream,freestreamav</span>
<a name="ln-227"></a>      <span class="c">!   3002      format (13(6e14.6))</span>
<a name="ln-228"></a>      <span class="c">!   close(11)</span>
<a name="ln-229"></a>      <span class="c">! endif</span>
<a name="ln-230"></a>
<a name="ln-231"></a>
<a name="ln-232"></a>      <span class="c">!    dgdt =  (1./tscale) * (freestream - Uinf)</span>
<a name="ln-233"></a>      <span class="c">!    dgdt =  (1./dt) * (freestreamav - Uinf)</span>
<a name="ln-234"></a>          <span class="n">dgdt</span> <span class="o">=</span>  <span class="p">(</span><span class="mf">1.</span><span class="o">/</span><span class="n">tscale</span><span class="p">)</span> <span class="o">*</span> <span class="p">(</span><span class="n">freestreamav</span> <span class="o">-</span> <span class="n">Uinf</span><span class="p">)</span>            <span class="c">! plus sign because dpdx is SUBTRACTED from Navier-Stokes eqs</span>
<a name="ln-235"></a>      <span class="c">!    dgdt =  (1./inletav) * (freestreamav - Uinf)</span>
<a name="ln-236"></a>
<a name="ln-237"></a>      <span class="c">!    if (ltempeq) then  !tg3315 commented</span>
<a name="ln-238"></a>      <span class="c">!      call detfreestrtmp(freestrtmp)</span>
<a name="ln-239"></a>      <span class="c">!      freestrtmpav=  freestrtmp*dt/inletav + (1.-dt/inletav)*freestrtmpav</span>
<a name="ln-240"></a>      <span class="c">!      thlsrcdt = -(1./tscale) * (freestrtmpav - thl_top)   ! minus sign because thlsr is ADDED to Navier-Stokes eqs.</span>
<a name="ln-241"></a>
<a name="ln-242"></a>      <span class="c">!      if (myid==0) then</span>
<a name="ln-243"></a>      <span class="c">!        open(unit=11,file=&#39;theta_top.txt&#39;,position=&#39;append&#39;)</span>
<a name="ln-244"></a>      <span class="c">!        write(11,3009) timee,freestrtmp,freestrtmpav</span>
<a name="ln-245"></a>      <span class="c">!3009    format (13(6e20.12))</span>
<a name="ln-246"></a>      <span class="c">!        close(11)</span>
<a name="ln-247"></a>      <span class="c">!      endif</span>
<a name="ln-248"></a>      <span class="c">!    end if</span>
<a name="ln-249"></a>
<a name="ln-250"></a>    <span class="k">end if</span>
<a name="ln-251"></a><span class="k">  end subroutine </span><span class="n">fixuinf2</span>
<a name="ln-252"></a>
<a name="ln-253"></a>  <span class="k">subroutine </span><span class="n">fixuinf1</span>
<a name="ln-254"></a>    <span class="k">use </span><span class="n">modglobal</span><span class="p">,</span> <span class="n">only</span> <span class="p">:</span> <span class="n">ib</span><span class="p">,</span><span class="n">ie</span><span class="p">,</span><span class="n">jb</span><span class="p">,</span><span class="n">je</span><span class="p">,</span><span class="n">kb</span><span class="p">,</span><span class="n">ke</span><span class="p">,</span><span class="n">kh</span><span class="p">,</span><span class="n">dxf</span><span class="p">,</span><span class="n">xh</span><span class="p">,</span><span class="n">dt</span><span class="p">,&amp;</span>
<a name="ln-255"></a>                          <span class="n">Uinf</span><span class="p">,</span><span class="n">Vinf</span><span class="p">,</span><span class="n">ifixuinf</span><span class="p">,</span><span class="n">tscale</span><span class="p">,</span><span class="n">timee</span><span class="p">,</span><span class="n">rk3step</span><span class="p">,</span><span class="n">inletav</span><span class="p">,&amp;</span>
<a name="ln-256"></a>                          <span class="n">freestreamav</span><span class="p">,</span><span class="n">lvinf</span>
<a name="ln-257"></a>    <span class="k">use </span><span class="n">modfields</span><span class="p">,</span> <span class="n">only</span> <span class="p">:</span> <span class="n">u0</span><span class="p">,</span><span class="n">dpdxl</span><span class="p">,</span><span class="n">dgdt</span><span class="p">,</span><span class="n">dpdx</span><span class="p">,</span><span class="n">up</span><span class="p">,</span><span class="n">vp</span>
<a name="ln-258"></a>    <span class="k">use </span><span class="n">modmpi</span><span class="p">,</span> <span class="n">only</span>    <span class="p">:</span> <span class="n">myid</span><span class="p">,</span><span class="n">comm3d</span><span class="p">,</span><span class="n">mpierr</span><span class="p">,</span><span class="n">mpi_sum</span><span class="p">,</span><span class="n">my_real</span><span class="p">,</span><span class="n">nprocs</span>
<a name="ln-259"></a>    <span class="k">implicit none</span>
<a name="ln-260"></a>
<a name="ln-261"></a><span class="k">    </span><span class="kt">real  </span><span class="n">utop</span><span class="p">,</span><span class="n">freestream</span><span class="p">,</span><span class="n">rk3coef</span>
<a name="ln-262"></a>    <span class="kt">integer </span><span class="n">i</span><span class="p">,</span><span class="n">j</span><span class="p">,</span><span class="n">k</span>
<a name="ln-263"></a>
<a name="ln-264"></a>    <span class="n">utop</span> <span class="o">=</span> <span class="mf">0.</span>
<a name="ln-265"></a>
<a name="ln-266"></a>
<a name="ln-267"></a>    <span class="k">if</span> <span class="p">((</span><span class="n">ifixuinf</span><span class="o">==</span><span class="mi">1</span><span class="p">)</span> <span class="p">.</span><span class="nb">and</span><span class="p">.</span> <span class="p">(</span><span class="n">rk3step</span><span class="o">==</span><span class="mi">3</span><span class="p">))</span> <span class="k">then</span>
<a name="ln-268"></a>
<a name="ln-269"></a>      <span class="c">! rk3coef = dt / (4. - dble(rk3step))</span>
<a name="ln-270"></a>
<a name="ln-271"></a>      <span class="c">! do j =jb,je</span>
<a name="ln-272"></a>      <span class="c">!   do i =ib,ie</span>
<a name="ln-273"></a>      <span class="c">!     utop = utop + 0.5*(u0(i,j,ke)+u0(i+1,j,ke))*dxf(i)</span>
<a name="ln-274"></a>      <span class="c">!   end do</span>
<a name="ln-275"></a>      <span class="c">! end do</span>
<a name="ln-276"></a>      <span class="c">! utop = utop / ( (je-jb+1)*(xh(ie+1)-xh(ib) ) )</span>
<a name="ln-277"></a>      <span class="c">! call MPI_ALLREDUCE(utop,    freestream,1,MY_REAL,MPI_SUM,comm3d,mpierr)</span>
<a name="ln-278"></a>      <span class="c">! freestream = freestream / nprocs</span>
<a name="ln-279"></a>
<a name="ln-280"></a>      <span class="c">! Write some statistics to monitoring file</span>
<a name="ln-281"></a>      <span class="c">! if (myid==0 .and. rk3step==3) then</span>
<a name="ln-282"></a>
<a name="ln-283"></a>
<a name="ln-284"></a>      <span class="c">! ! dpdxl(:) = dpdx + (1./rk3coef) * (freestream - Uinf)</span>
<a name="ln-285"></a>      <span class="c">! dpdxl(:) = dpdx + (1./dt) * (freestream - Uinf)</span>
<a name="ln-286"></a>      <span class="k">call </span><span class="n">detfreestream</span><span class="p">(</span><span class="n">freestream</span><span class="p">)</span>
<a name="ln-287"></a>      <span class="c">! write(*,*) &quot;freestream&quot;,freestream</span>
<a name="ln-288"></a>      <span class="k">if</span> <span class="p">(</span><span class="n">lvinf</span><span class="p">)</span> <span class="k">then</span>
<a name="ln-289"></a><span class="k">        do </span><span class="n">k</span><span class="o">=</span><span class="n">kb</span><span class="p">,</span><span class="n">ke</span>
<a name="ln-290"></a>          <span class="k">do </span><span class="n">i</span><span class="o">=</span><span class="n">ib</span><span class="p">,</span><span class="n">ie</span>
<a name="ln-291"></a>            <span class="k">do </span><span class="n">j</span><span class="o">=</span><span class="n">jb</span><span class="p">,</span><span class="n">je</span>
<a name="ln-292"></a>              <span class="n">vp</span><span class="p">(</span><span class="n">i</span><span class="p">,</span><span class="n">j</span><span class="p">,</span><span class="n">k</span><span class="p">)</span> <span class="o">=</span> <span class="n">vp</span><span class="p">(</span><span class="n">i</span><span class="p">,</span><span class="n">j</span><span class="p">,</span><span class="n">k</span><span class="p">)</span> <span class="o">-</span> <span class="p">(</span><span class="mf">1.</span><span class="o">/</span><span class="n">dt</span><span class="p">)</span> <span class="o">*</span> <span class="p">(</span><span class="n">freestream</span> <span class="o">-</span> <span class="n">Vinf</span><span class="p">)</span>
<a name="ln-293"></a>            <span class="n">enddo</span>
<a name="ln-294"></a>          <span class="n">enddo</span>
<a name="ln-295"></a>        <span class="n">enddo</span>
<a name="ln-296"></a>      <span class="k">else</span>
<a name="ln-297"></a><span class="k">        do </span><span class="n">k</span><span class="o">=</span><span class="n">kb</span><span class="p">,</span><span class="n">ke</span>
<a name="ln-298"></a>          <span class="k">do </span><span class="n">j</span><span class="o">=</span><span class="n">jb</span><span class="p">,</span><span class="n">je</span>
<a name="ln-299"></a>            <span class="k">do </span><span class="n">i</span><span class="o">=</span><span class="n">ib</span><span class="p">,</span><span class="n">ie</span>
<a name="ln-300"></a>              <span class="n">up</span><span class="p">(</span><span class="n">i</span><span class="p">,</span><span class="n">j</span><span class="p">,</span><span class="n">k</span><span class="p">)</span> <span class="o">=</span> <span class="n">up</span><span class="p">(</span><span class="n">i</span><span class="p">,</span><span class="n">j</span><span class="p">,</span><span class="n">k</span><span class="p">)</span> <span class="o">-</span> <span class="p">(</span><span class="mf">1.</span><span class="o">/</span><span class="n">dt</span><span class="p">)</span> <span class="o">*</span> <span class="p">(</span><span class="n">freestream</span> <span class="o">-</span> <span class="n">Uinf</span><span class="p">)</span>
<a name="ln-301"></a>            <span class="n">enddo</span>
<a name="ln-302"></a>          <span class="n">enddo</span>
<a name="ln-303"></a>        <span class="n">enddo</span>
<a name="ln-304"></a>      <span class="n">endif</span>
<a name="ln-305"></a>      <span class="c">! if (myid==0) then</span>
<a name="ln-306"></a>      <span class="c">!   write(*,*), &quot;freestream&quot;, freestream</span>
<a name="ln-307"></a>      <span class="c">!   write(*,*), &quot;Uinf&quot;, Uinf</span>
<a name="ln-308"></a>      <span class="c">!   open(unit=11,file=&#39;freestr.txt&#39;,position=&#39;append&#39;)</span>
<a name="ln-309"></a>      <span class="c">!   write(11,3003) timee,freestream</span>
<a name="ln-310"></a>      <span class="c">!   3003    format (13(6e20.12))</span>
<a name="ln-311"></a>      <span class="c">!   close(11)</span>
<a name="ln-312"></a>
<a name="ln-313"></a>      <span class="c">!   open(unit=11,file=&#39;dpdx___.txt&#39;,position=&#39;append&#39;)</span>
<a name="ln-314"></a>      <span class="c">!   write(11,3002) timee,dpdxl(kb),dpdxl(kb)-dpdx</span>
<a name="ln-315"></a>      <span class="c">!   3002    format (13(6e20.12))</span>
<a name="ln-316"></a>      <span class="c">!   close(11)</span>
<a name="ln-317"></a>      <span class="c">! endif</span>
<a name="ln-318"></a> 
<a name="ln-319"></a>    <span class="k">end if</span>
<a name="ln-320"></a>
<a name="ln-321"></a><span class="k">  end subroutine </span><span class="n">fixuinf1</span>
<a name="ln-322"></a>
<a name="ln-323"></a>  <span class="k">subroutine </span><span class="n">fixthetainf</span>
<a name="ln-324"></a>    <span class="k">use </span><span class="n">modglobal</span><span class="p">,</span> <span class="n">only</span> <span class="p">:</span> <span class="n">ib</span><span class="p">,</span><span class="n">ie</span><span class="p">,</span><span class="n">jb</span><span class="p">,</span><span class="n">je</span><span class="p">,</span><span class="n">kb</span><span class="p">,</span><span class="n">ke</span><span class="p">,</span><span class="n">kh</span><span class="p">,</span><span class="n">dxf</span><span class="p">,</span><span class="n">xh</span><span class="p">,</span><span class="n">dt</span><span class="p">,&amp;</span>
<a name="ln-325"></a>                          <span class="n">Uinf</span><span class="p">,</span><span class="n">ifixuinf</span><span class="p">,</span><span class="n">tscale</span><span class="p">,</span><span class="n">timee</span><span class="p">,</span><span class="n">rk3step</span><span class="p">,</span><span class="n">inletav</span><span class="p">,&amp;</span>
<a name="ln-326"></a>                          <span class="n">freestreamav</span><span class="p">,</span><span class="n">thlsrc</span><span class="p">,</span><span class="n">ltempeq</span>
<a name="ln-327"></a>    <span class="k">use </span><span class="n">modfields</span><span class="p">,</span> <span class="n">only</span> <span class="p">:</span> <span class="n">thl0</span>
<a name="ln-328"></a>    <span class="k">use </span><span class="n">modmpi</span><span class="p">,</span> <span class="n">only</span>    <span class="p">:</span> <span class="n">myid</span><span class="p">,</span><span class="n">comm3d</span><span class="p">,</span><span class="n">mpierr</span><span class="p">,</span><span class="n">mpi_sum</span><span class="p">,</span><span class="n">my_real</span><span class="p">,</span><span class="n">nprocs</span>
<a name="ln-329"></a>    <span class="k">use </span><span class="n">modsurfdata</span><span class="p">,</span> <span class="n">only</span><span class="p">:</span> <span class="n">thl_top</span>
<a name="ln-330"></a>    <span class="k">implicit none</span>
<a name="ln-331"></a>
<a name="ln-332"></a><span class="k">    </span><span class="kt">real  </span><span class="n">ttop</span><span class="p">,</span><span class="n">freestreamtheta</span><span class="p">,</span><span class="n">rk3coef</span>
<a name="ln-333"></a>    <span class="kt">integer </span><span class="n">i</span><span class="p">,</span><span class="n">j</span>
<a name="ln-334"></a>
<a name="ln-335"></a>    <span class="n">ttop</span> <span class="o">=</span> <span class="mf">0.</span>
<a name="ln-336"></a>
<a name="ln-337"></a>    <span class="c">! if (ifixuinf==1 .and. rk3step==3 .and. ltempeq) then !tg3315 commented</span>
<a name="ln-338"></a>
<a name="ln-339"></a>    <span class="c">!   rk3coef = dt / (4. - dble(rk3step))</span>
<a name="ln-340"></a>
<a name="ln-341"></a>    <span class="c">!   do j =jb,je</span>
<a name="ln-342"></a>    <span class="c">!     do i =ib,ie</span>
<a name="ln-343"></a>    <span class="c">!       ttop = ttop + thl0(i,j,ke)*dxf(i)</span>
<a name="ln-344"></a>    <span class="c">!     end do</span>
<a name="ln-345"></a>    <span class="c">!   end do</span>
<a name="ln-346"></a>    <span class="c">!   ttop = ttop / ( (je-jb+1)*(xh(ie+1)-xh(ib) ) )</span>
<a name="ln-347"></a>    <span class="c">!   call MPI_ALLREDUCE(ttop,    freestreamtheta,1,MY_REAL,MPI_SUM,comm3d,mpierr)</span>
<a name="ln-348"></a>    <span class="c">!   freestreamtheta = freestreamtheta / nprocs</span>
<a name="ln-349"></a>
<a name="ln-350"></a>
<a name="ln-351"></a>    <span class="c">!   thlsrc = -(1./dt) * (freestreamtheta - thl_top)</span>
<a name="ln-352"></a>    <span class="c">!     if (myid==0) then</span>
<a name="ln-353"></a>    <span class="c">!       open(unit=11,file=&#39;theta_top.txt&#39;,position=&#39;append&#39;)</span>
<a name="ln-354"></a>    <span class="c">!       write(11,3003) timee,freestreamtheta</span>
<a name="ln-355"></a>    <span class="c">!       3003    format (13(6e20.12))</span>
<a name="ln-356"></a>    <span class="c">!       close(11)</span>
<a name="ln-357"></a>
<a name="ln-358"></a>    <span class="c">!       open(unit=11,file=&#39;thlsrc.txt&#39;,position=&#39;append&#39;)</span>
<a name="ln-359"></a>    <span class="c">!       write(11,3002) timee,thlsrc</span>
<a name="ln-360"></a>    <span class="c">!       3002    format (13(6e20.12))</span>
<a name="ln-361"></a>    <span class="c">!       close(11)</span>
<a name="ln-362"></a>    <span class="c">!     endif</span>
<a name="ln-363"></a>
<a name="ln-364"></a>    <span class="c">! end if</span>
<a name="ln-365"></a>
<a name="ln-366"></a>  <span class="k">end subroutine </span><span class="n">fixthetainf</span>
<a name="ln-367"></a>
<a name="ln-368"></a>  <span class="k">subroutine </span><span class="n">masscorr</span>
<a name="ln-369"></a>    <span class="c">!&gt; correct the velocities to get prescribed flow rate</span>
<a name="ln-370"></a>
<a name="ln-371"></a>    <span class="k">use </span><span class="n">modglobal</span><span class="p">,</span> <span class="n">only</span> <span class="p">:</span> <span class="n">ib</span><span class="p">,</span><span class="n">ie</span><span class="p">,</span><span class="n">jb</span><span class="p">,</span><span class="n">je</span><span class="p">,</span><span class="n">ih</span><span class="p">,</span><span class="n">jh</span><span class="p">,</span><span class="n">kb</span><span class="p">,</span><span class="n">ke</span><span class="p">,</span><span class="n">dzf</span><span class="p">,</span><span class="n">dxf</span><span class="p">,</span><span class="n">dy</span><span class="p">,</span><span class="n">dt</span><span class="p">,</span><span class="n">rk3step</span><span class="p">,&amp;</span>
<a name="ln-372"></a>                          <span class="n">uflowrate</span><span class="p">,</span><span class="n">vflowrate</span><span class="p">,</span><span class="n">linoutflow</span><span class="p">,&amp;</span>
<a name="ln-373"></a>                          <span class="n">luoutflowr</span><span class="p">,</span><span class="n">lvoutflowr</span><span class="p">,</span><span class="n">luvolflowr</span><span class="p">,</span><span class="n">lvvolflowr</span>
<a name="ln-374"></a>    <span class="k">use </span><span class="n">modfields</span><span class="p">,</span> <span class="n">only</span> <span class="p">:</span> <span class="n">um</span><span class="p">,</span><span class="n">up</span><span class="p">,</span><span class="n">vm</span><span class="p">,</span><span class="n">vp</span><span class="p">,</span><span class="n">uout</span><span class="p">,</span><span class="n">uouttot</span><span class="p">,</span><span class="n">udef</span><span class="p">,</span><span class="n">vout</span><span class="p">,</span><span class="n">vouttot</span><span class="p">,</span><span class="n">vdef</span><span class="p">,&amp;</span>
<a name="ln-375"></a>                          <span class="n">uoutarea</span><span class="p">,</span><span class="n">voutarea</span><span class="p">,</span><span class="n">fluidvol</span><span class="p">,</span><span class="n">IIu</span><span class="p">,</span><span class="n">IIv</span>
<a name="ln-376"></a>    <span class="k">use </span><span class="n">modmpi</span><span class="p">,</span>    <span class="n">only</span> <span class="p">:</span> <span class="n">myid</span><span class="p">,</span><span class="n">comm3d</span><span class="p">,</span><span class="n">mpierr</span><span class="p">,</span><span class="n">nprocs</span><span class="p">,</span><span class="n">MY_REAL</span><span class="p">,</span><span class="n">sumy_ibm</span>
<a name="ln-377"></a>
<a name="ln-378"></a>    <span class="kt">real</span><span class="p">,</span> <span class="k">dimension</span><span class="p">(</span><span class="n">ib</span><span class="p">:</span><span class="n">ie</span><span class="p">,</span> <span class="n">kb</span><span class="p">:</span><span class="n">ke</span><span class="p">)</span> <span class="kd">::</span> <span class="n">uvol</span>
<a name="ln-379"></a>    <span class="kt">real</span><span class="p">,</span> <span class="k">dimension</span><span class="p">(</span><span class="n">ib</span><span class="p">:</span><span class="n">ie</span><span class="p">,</span> <span class="n">kb</span><span class="p">:</span><span class="n">ke</span><span class="p">)</span> <span class="kd">::</span> <span class="n">uvolold</span>
<a name="ln-380"></a>    <span class="kt">real</span><span class="p">,</span> <span class="k">dimension</span><span class="p">(</span><span class="n">ib</span><span class="p">:</span><span class="n">ie</span><span class="p">,</span> <span class="n">kb</span><span class="p">:</span><span class="n">ke</span><span class="p">)</span> <span class="kd">::</span> <span class="n">vvol</span>
<a name="ln-381"></a>    <span class="kt">real</span><span class="p">,</span> <span class="k">dimension</span><span class="p">(</span><span class="n">ib</span><span class="p">:</span><span class="n">ie</span><span class="p">,</span> <span class="n">kb</span><span class="p">:</span><span class="n">ke</span><span class="p">)</span> <span class="kd">::</span> <span class="n">vvolold</span>
<a name="ln-382"></a>    <span class="kt">real</span><span class="p">,</span> <span class="k">dimension</span><span class="p">(</span><span class="n">kb</span><span class="p">:</span><span class="n">ke</span><span class="p">)</span>        <span class="kd">::</span> <span class="n">uoutold</span>
<a name="ln-383"></a>    <span class="kt">real</span><span class="p">,</span> <span class="k">dimension</span><span class="p">(</span><span class="n">kb</span><span class="p">:</span><span class="n">ke</span><span class="p">)</span>        <span class="kd">::</span> <span class="n">voutold</span>
<a name="ln-384"></a>    <span class="kt">real                          </span><span class="n">rk3coef</span><span class="p">,</span><span class="n">rk3coefi</span><span class="p">,&amp;</span>
<a name="ln-385"></a>                                  <span class="n">uoutflow</span><span class="p">,</span><span class="n">voutflow</span><span class="p">,&amp;</span>
<a name="ln-386"></a>                                  <span class="n">uflowrateold</span><span class="p">,</span><span class="n">vflowrateold</span>
<a name="ln-387"></a>    <span class="kt">integer                       </span><span class="n">i</span><span class="p">,</span><span class="n">j</span><span class="p">,</span><span class="n">k</span>
<a name="ln-388"></a>
<a name="ln-389"></a>    <span class="k">if</span> <span class="p">((.</span><span class="nb">not</span><span class="p">.</span><span class="n">linoutflow</span><span class="p">)</span> <span class="p">.</span><span class="nb">and</span><span class="p">.</span> <span class="p">(</span><span class="n">luoutflowr</span><span class="p">))</span> <span class="k">then</span>
<a name="ln-390"></a><span class="k">      </span><span class="n">rk3coef</span> <span class="o">=</span> <span class="n">dt</span> <span class="o">/</span> <span class="p">(</span><span class="mf">4.</span> <span class="o">-</span> <span class="nb">dble</span><span class="p">(</span><span class="n">rk3step</span><span class="p">))</span>
<a name="ln-391"></a>      <span class="n">rk3coefi</span> <span class="o">=</span> <span class="mi">1</span> <span class="o">/</span> <span class="n">rk3coef</span>
<a name="ln-392"></a>
<a name="ln-393"></a>      <span class="n">udef</span> <span class="o">=</span> <span class="mf">0.</span>
<a name="ln-394"></a>      <span class="n">uout</span> <span class="o">=</span> <span class="mf">0.</span>
<a name="ln-395"></a>      <span class="n">uoutflow</span> <span class="o">=</span> <span class="mf">0.</span>
<a name="ln-396"></a>      <span class="n">uoutold</span> <span class="o">=</span> <span class="mf">0.</span>
<a name="ln-397"></a>
<a name="ln-398"></a>      <span class="c">! integrate u fixed at outlet ie along y</span>
<a name="ln-399"></a>      <span class="k">call </span><span class="n">sumy_ibm</span><span class="p">(</span><span class="n">uout</span><span class="p">,</span><span class="n">up</span><span class="p">(</span><span class="n">ie</span><span class="p">,</span><span class="n">jb</span><span class="p">:</span><span class="n">je</span><span class="p">,</span><span class="n">kb</span><span class="p">:</span><span class="n">ke</span><span class="p">)</span><span class="o">*</span><span class="n">dy</span><span class="p">,</span><span class="n">ie</span><span class="p">,</span><span class="n">ie</span><span class="p">,</span><span class="n">jb</span><span class="p">,</span><span class="n">je</span><span class="p">,</span><span class="n">kb</span><span class="p">,</span><span class="n">ke</span><span class="p">,</span><span class="n">IIu</span><span class="p">(</span><span class="n">ie</span><span class="p">,</span><span class="n">jb</span><span class="p">:</span><span class="n">je</span><span class="p">,</span><span class="n">kb</span><span class="p">:</span><span class="n">ke</span><span class="p">))</span>  <span class="c">! u tendency at previous time step</span>
<a name="ln-400"></a>      <span class="k">call </span><span class="n">sumy_ibm</span><span class="p">(</span><span class="n">uoutold</span><span class="p">,</span><span class="n">um</span><span class="p">(</span><span class="n">ie</span><span class="p">,</span><span class="n">jb</span><span class="p">:</span><span class="n">je</span><span class="p">,</span><span class="n">kb</span><span class="p">:</span><span class="n">ke</span><span class="p">)</span><span class="o">*</span><span class="n">dy</span><span class="p">,</span><span class="n">ie</span><span class="p">,</span><span class="n">ie</span><span class="p">,</span><span class="n">jb</span><span class="p">,</span><span class="n">je</span><span class="p">,</span><span class="n">kb</span><span class="p">,</span><span class="n">ke</span><span class="p">,</span><span class="n">IIu</span><span class="p">(</span><span class="n">ie</span><span class="p">,</span><span class="n">jb</span><span class="p">:</span><span class="n">je</span><span class="p">,</span><span class="n">kb</span><span class="p">:</span><span class="n">ke</span><span class="p">))</span>  <span class="c">! u at previous time step</span>
<a name="ln-401"></a>
<a name="ln-402"></a>      <span class="c">! integrate u in z</span>
<a name="ln-403"></a>      <span class="k">do </span><span class="n">k</span><span class="o">=</span><span class="n">kb</span><span class="p">,</span><span class="n">ke</span>
<a name="ln-404"></a>        <span class="n">uout</span><span class="p">(</span><span class="n">k</span><span class="p">)</span> <span class="o">=</span> <span class="n">rk3coef</span><span class="o">*</span><span class="n">uout</span><span class="p">(</span><span class="n">k</span><span class="p">)</span><span class="o">*</span><span class="n">dzf</span><span class="p">(</span><span class="n">k</span><span class="p">)</span>
<a name="ln-405"></a>        <span class="n">uoutold</span><span class="p">(</span><span class="n">k</span><span class="p">)</span> <span class="o">=</span> <span class="n">uoutold</span><span class="p">(</span><span class="n">k</span><span class="p">)</span><span class="o">*</span><span class="n">dzf</span><span class="p">(</span><span class="n">k</span><span class="p">)</span>
<a name="ln-406"></a>      <span class="k">end do</span>
<a name="ln-407"></a><span class="k">      </span><span class="n">uoutflow</span> <span class="o">=</span> <span class="nb">sum</span><span class="p">(</span><span class="n">uout</span><span class="p">(</span><span class="n">kb</span><span class="p">:</span><span class="n">ke</span><span class="p">))</span>
<a name="ln-408"></a>      <span class="n">uflowrateold</span> <span class="o">=</span> <span class="nb">sum</span><span class="p">(</span><span class="n">uoutold</span><span class="p">(</span><span class="n">kb</span><span class="p">:</span><span class="n">ke</span><span class="p">))</span>
<a name="ln-409"></a>
<a name="ln-410"></a>      <span class="c">! average over outflow area</span>
<a name="ln-411"></a>      <span class="n">uoutflow</span> <span class="o">=</span> <span class="n">uoutflow</span><span class="o">/</span><span class="n">uoutarea</span>
<a name="ln-412"></a>      <span class="n">uflowrateold</span> <span class="o">=</span> <span class="n">uflowrateold</span><span class="o">/</span><span class="n">uoutarea</span>
<a name="ln-413"></a>
<a name="ln-414"></a>      <span class="c">! flow correction to match outflow rate</span>
<a name="ln-415"></a>      <span class="n">udef</span> <span class="o">=</span> <span class="n">uflowrate</span> <span class="o">-</span> <span class="p">(</span><span class="n">uoutflow</span> <span class="o">+</span> <span class="n">uflowrateold</span><span class="p">)</span>
<a name="ln-416"></a>      <span class="k">do </span><span class="n">k</span> <span class="o">=</span> <span class="n">kb</span><span class="p">,</span><span class="n">ke</span>
<a name="ln-417"></a>        <span class="k">do </span><span class="n">j</span> <span class="o">=</span> <span class="n">jb</span><span class="p">,</span><span class="n">je</span>
<a name="ln-418"></a>            <span class="k">do </span><span class="n">i</span> <span class="o">=</span> <span class="n">ib</span><span class="p">,</span><span class="n">ie</span>
<a name="ln-419"></a>              <span class="n">up</span><span class="p">(</span><span class="n">i</span><span class="p">,</span><span class="n">j</span><span class="p">,</span><span class="n">k</span><span class="p">)</span> <span class="o">=</span> <span class="n">up</span><span class="p">(</span><span class="n">i</span><span class="p">,</span><span class="n">j</span><span class="p">,</span><span class="n">k</span><span class="p">)</span> <span class="o">+</span> <span class="n">udef</span><span class="o">*</span><span class="n">rk3coefi</span>
<a name="ln-420"></a>            <span class="k">end do</span>
<a name="ln-421"></a><span class="k">        end do</span>
<a name="ln-422"></a><span class="k">      end do</span>
<a name="ln-423"></a>
<a name="ln-424"></a>      <span class="c">! bss116 calculate uouttot which is used in modboundary.</span>
<a name="ln-425"></a>      <span class="c">! this really should be in the routine directly!</span>
<a name="ln-426"></a>      <span class="n">uouttot</span> <span class="o">=</span> <span class="nb">sum</span><span class="p">(</span><span class="n">uout</span><span class="p">(</span><span class="n">kb</span><span class="p">:</span><span class="n">ke</span><span class="p">))</span>  <span class="c">! mass flow rate at outlet</span>
<a name="ln-427"></a>
<a name="ln-428"></a>    <span class="n">elseif</span> <span class="p">((.</span><span class="nb">not</span><span class="p">.</span><span class="n">linoutflow</span><span class="p">)</span> <span class="p">.</span><span class="nb">and</span><span class="p">.</span> <span class="p">(</span><span class="n">luvolflowr</span><span class="p">))</span> <span class="k">then</span>
<a name="ln-429"></a><span class="k">      </span><span class="n">rk3coef</span> <span class="o">=</span> <span class="n">dt</span> <span class="o">/</span> <span class="p">(</span><span class="mf">4.</span> <span class="o">-</span> <span class="nb">dble</span><span class="p">(</span><span class="n">rk3step</span><span class="p">))</span>
<a name="ln-430"></a>      <span class="n">rk3coefi</span> <span class="o">=</span> <span class="mi">1</span> <span class="o">/</span> <span class="n">rk3coef</span>
<a name="ln-431"></a>
<a name="ln-432"></a>      <span class="n">udef</span> <span class="o">=</span> <span class="mf">0.</span>
<a name="ln-433"></a>      <span class="n">uout</span> <span class="o">=</span> <span class="mf">0.</span>
<a name="ln-434"></a>      <span class="n">uoutflow</span> <span class="o">=</span> <span class="mf">0.</span>
<a name="ln-435"></a>      <span class="n">uoutold</span> <span class="o">=</span> <span class="mf">0.</span>
<a name="ln-436"></a>      <span class="n">uvol</span> <span class="o">=</span> <span class="mf">0.</span>
<a name="ln-437"></a>      <span class="n">uvolold</span> <span class="o">=</span> <span class="mf">0.</span>
<a name="ln-438"></a>
<a name="ln-439"></a>      <span class="c">! integrate u in y</span>
<a name="ln-440"></a>      <span class="k">call </span><span class="n">sumy_ibm</span><span class="p">(</span><span class="n">uvol</span><span class="p">,</span><span class="n">up</span><span class="p">(</span><span class="n">ib</span><span class="p">:</span><span class="n">ie</span><span class="p">,</span><span class="n">jb</span><span class="p">:</span><span class="n">je</span><span class="p">,</span><span class="n">kb</span><span class="p">:</span><span class="n">ke</span><span class="p">)</span><span class="o">*</span><span class="n">dy</span><span class="p">,</span><span class="n">ib</span><span class="p">,</span><span class="n">ie</span><span class="p">,</span><span class="n">jb</span><span class="p">,</span><span class="n">je</span><span class="p">,</span><span class="n">kb</span><span class="p">,</span><span class="n">ke</span><span class="p">,</span><span class="n">IIu</span><span class="p">(</span><span class="n">ib</span><span class="p">:</span><span class="n">ie</span><span class="p">,</span><span class="n">jb</span><span class="p">:</span><span class="n">je</span><span class="p">,</span><span class="n">kb</span><span class="p">:</span><span class="n">ke</span><span class="p">))</span>  <span class="c">! u tendency at previous time step</span>
<a name="ln-441"></a>      <span class="k">call </span><span class="n">sumy_ibm</span><span class="p">(</span><span class="n">uvolold</span><span class="p">,</span><span class="n">um</span><span class="p">(</span><span class="n">ib</span><span class="p">:</span><span class="n">ie</span><span class="p">,</span><span class="n">jb</span><span class="p">:</span><span class="n">je</span><span class="p">,</span><span class="n">kb</span><span class="p">:</span><span class="n">ke</span><span class="p">)</span><span class="o">*</span><span class="n">dy</span><span class="p">,</span><span class="n">ib</span><span class="p">,</span><span class="n">ie</span><span class="p">,</span><span class="n">jb</span><span class="p">,</span><span class="n">je</span><span class="p">,</span><span class="n">kb</span><span class="p">,</span><span class="n">ke</span><span class="p">,</span><span class="n">IIu</span><span class="p">(</span><span class="n">ib</span><span class="p">:</span><span class="n">ie</span><span class="p">,</span><span class="n">jb</span><span class="p">:</span><span class="n">je</span><span class="p">,</span><span class="n">kb</span><span class="p">:</span><span class="n">ke</span><span class="p">))</span>  <span class="c">! u at previous time step</span>
<a name="ln-442"></a>
<a name="ln-443"></a>      <span class="c">! integrate u in x</span>
<a name="ln-444"></a>      <span class="k">do </span><span class="n">k</span><span class="o">=</span><span class="n">kb</span><span class="p">,</span><span class="n">ke</span>
<a name="ln-445"></a>        <span class="n">uout</span><span class="p">(</span><span class="n">k</span><span class="p">)</span> <span class="o">=</span> <span class="nb">sum</span><span class="p">(</span><span class="n">uvol</span><span class="p">(</span><span class="n">ib</span><span class="p">:</span><span class="n">ie</span><span class="p">,</span><span class="n">k</span><span class="p">)</span><span class="o">*</span><span class="n">dxf</span><span class="p">(</span><span class="n">ib</span><span class="p">:</span><span class="n">ie</span><span class="p">))</span>
<a name="ln-446"></a>        <span class="n">uoutold</span><span class="p">(</span><span class="n">k</span><span class="p">)</span> <span class="o">=</span> <span class="nb">sum</span><span class="p">(</span><span class="n">uvolold</span><span class="p">(</span><span class="n">ib</span><span class="p">:</span><span class="n">ie</span><span class="p">,</span><span class="n">k</span><span class="p">)</span><span class="o">*</span><span class="n">dxf</span><span class="p">(</span><span class="n">ib</span><span class="p">:</span><span class="n">ie</span><span class="p">))</span>
<a name="ln-447"></a>      <span class="k">end do</span>
<a name="ln-448"></a>
<a name="ln-449"></a>      <span class="c">! integrate u in z</span>
<a name="ln-450"></a>      <span class="k">do </span><span class="n">k</span><span class="o">=</span><span class="n">kb</span><span class="p">,</span><span class="n">ke</span>
<a name="ln-451"></a>        <span class="n">uout</span><span class="p">(</span><span class="n">k</span><span class="p">)</span> <span class="o">=</span> <span class="n">rk3coef</span><span class="o">*</span><span class="n">uout</span><span class="p">(</span><span class="n">k</span><span class="p">)</span><span class="o">*</span><span class="n">dzf</span><span class="p">(</span><span class="n">k</span><span class="p">)</span>
<a name="ln-452"></a>        <span class="n">uoutold</span><span class="p">(</span><span class="n">k</span><span class="p">)</span> <span class="o">=</span> <span class="n">uoutold</span><span class="p">(</span><span class="n">k</span><span class="p">)</span><span class="o">*</span><span class="n">dzf</span><span class="p">(</span><span class="n">k</span><span class="p">)</span>
<a name="ln-453"></a>      <span class="k">end do</span>
<a name="ln-454"></a><span class="k">      </span><span class="n">uoutflow</span> <span class="o">=</span> <span class="nb">sum</span><span class="p">(</span><span class="n">uout</span><span class="p">(</span><span class="n">kb</span><span class="p">:</span><span class="n">ke</span><span class="p">))</span>
<a name="ln-455"></a>      <span class="n">uflowrateold</span> <span class="o">=</span> <span class="nb">sum</span><span class="p">(</span><span class="n">uoutold</span><span class="p">(</span><span class="n">kb</span><span class="p">:</span><span class="n">ke</span><span class="p">))</span>
<a name="ln-456"></a>
<a name="ln-457"></a>      <span class="c">! average over fluid volume</span>
<a name="ln-458"></a>      <span class="n">uoutflow</span> <span class="o">=</span> <span class="n">uoutflow</span><span class="o">/</span><span class="n">fluidvol</span>
<a name="ln-459"></a>      <span class="n">uflowrateold</span> <span class="o">=</span> <span class="n">uflowrateold</span><span class="o">/</span><span class="n">fluidvol</span>
<a name="ln-460"></a>
<a name="ln-461"></a>      <span class="c">! flow correction to match outflow rate</span>
<a name="ln-462"></a>      <span class="n">udef</span> <span class="o">=</span> <span class="n">uflowrate</span> <span class="o">-</span> <span class="p">(</span><span class="n">uoutflow</span> <span class="o">+</span> <span class="n">uflowrateold</span><span class="p">)</span>
<a name="ln-463"></a>
<a name="ln-464"></a>      <span class="k">do </span><span class="n">k</span> <span class="o">=</span> <span class="n">kb</span><span class="p">,</span><span class="n">ke</span>
<a name="ln-465"></a>        <span class="k">do </span><span class="n">j</span> <span class="o">=</span> <span class="n">jb</span><span class="p">,</span><span class="n">je</span>
<a name="ln-466"></a>            <span class="k">do </span><span class="n">i</span> <span class="o">=</span> <span class="n">ib</span><span class="p">,</span><span class="n">ie</span>
<a name="ln-467"></a>              <span class="n">up</span><span class="p">(</span><span class="n">i</span><span class="p">,</span><span class="n">j</span><span class="p">,</span><span class="n">k</span><span class="p">)</span> <span class="o">=</span> <span class="n">up</span><span class="p">(</span><span class="n">i</span><span class="p">,</span><span class="n">j</span><span class="p">,</span><span class="n">k</span><span class="p">)</span> <span class="o">+</span> <span class="n">udef</span><span class="o">*</span><span class="n">rk3coefi</span>
<a name="ln-468"></a>            <span class="k">end do</span>
<a name="ln-469"></a><span class="k">        end do</span>
<a name="ln-470"></a><span class="k">      end do</span>
<a name="ln-471"></a>
<a name="ln-472"></a><span class="k">    end if</span>
<a name="ln-473"></a>
<a name="ln-474"></a><span class="k">    if</span> <span class="p">((.</span><span class="nb">not</span><span class="p">.</span><span class="n">linoutflow</span><span class="p">)</span> <span class="p">.</span><span class="nb">and</span><span class="p">.</span> <span class="p">(</span><span class="n">lvoutflowr</span><span class="p">))</span> <span class="k">then</span>
<a name="ln-475"></a><span class="k">      </span><span class="n">rk3coef</span> <span class="o">=</span> <span class="n">dt</span> <span class="o">/</span> <span class="p">(</span><span class="mf">4.</span> <span class="o">-</span> <span class="nb">dble</span><span class="p">(</span><span class="n">rk3step</span><span class="p">))</span>
<a name="ln-476"></a>      <span class="n">rk3coefi</span> <span class="o">=</span> <span class="mi">1</span> <span class="o">/</span> <span class="n">rk3coef</span>
<a name="ln-477"></a>
<a name="ln-478"></a>      <span class="n">vdef</span> <span class="o">=</span> <span class="mf">0.</span>
<a name="ln-479"></a>      <span class="n">vout</span> <span class="o">=</span> <span class="mf">0.</span>
<a name="ln-480"></a>      <span class="n">voutflow</span> <span class="o">=</span> <span class="mf">0.</span>
<a name="ln-481"></a>      <span class="n">voutold</span> <span class="o">=</span> <span class="mf">0.</span>
<a name="ln-482"></a>
<a name="ln-483"></a>      <span class="c">! integrate v fixed at outlet je along x</span>
<a name="ln-484"></a>      <span class="k">if</span> <span class="p">(</span><span class="n">myid</span><span class="o">==</span><span class="n">nprocs</span><span class="o">-</span><span class="mi">1</span><span class="p">)</span> <span class="k">then</span>
<a name="ln-485"></a><span class="k">        do </span><span class="n">k</span><span class="o">=</span><span class="n">kb</span><span class="p">,</span><span class="n">ke</span>
<a name="ln-486"></a>          <span class="n">vout</span><span class="p">(</span><span class="n">k</span><span class="p">)</span> <span class="o">=</span> <span class="nb">sum</span><span class="p">(</span><span class="n">vp</span><span class="p">(</span><span class="n">ib</span><span class="p">:</span><span class="n">ie</span><span class="p">,</span><span class="n">je</span><span class="p">,</span><span class="n">k</span><span class="p">)</span><span class="o">*</span><span class="n">IIv</span><span class="p">(</span><span class="n">ib</span><span class="p">:</span><span class="n">ie</span><span class="p">,</span><span class="n">je</span><span class="p">,</span><span class="n">k</span><span class="p">)</span><span class="o">*</span><span class="n">dxf</span><span class="p">(</span><span class="n">ib</span><span class="p">:</span><span class="n">ie</span><span class="p">))</span>  <span class="c">! v tendency at previous time step</span>
<a name="ln-487"></a>          <span class="n">voutold</span><span class="p">(</span><span class="n">k</span><span class="p">)</span> <span class="o">=</span> <span class="nb">sum</span><span class="p">(</span><span class="n">vm</span><span class="p">(</span><span class="n">ib</span><span class="p">:</span><span class="n">ie</span><span class="p">,</span><span class="n">je</span><span class="p">,</span><span class="n">k</span><span class="p">)</span><span class="o">*</span><span class="n">IIv</span><span class="p">(</span><span class="n">ib</span><span class="p">:</span><span class="n">ie</span><span class="p">,</span><span class="n">je</span><span class="p">,</span><span class="n">k</span><span class="p">)</span><span class="o">*</span><span class="n">dxf</span><span class="p">(</span><span class="n">ib</span><span class="p">:</span><span class="n">ie</span><span class="p">))</span>  <span class="c">! v at previous time step</span>
<a name="ln-488"></a>        <span class="k">end do</span>
<a name="ln-489"></a><span class="k">      end if</span>
<a name="ln-490"></a>
<a name="ln-491"></a><span class="k">      call </span><span class="n">MPI_BCAST</span><span class="p">(</span><span class="n">vout</span><span class="p">,</span><span class="n">ke</span><span class="o">-</span><span class="n">kb</span><span class="o">+</span><span class="mi">1</span><span class="p">,</span><span class="n">MY_REAL</span> <span class="p">,</span><span class="n">nprocs</span><span class="o">-</span><span class="mi">1</span><span class="p">,</span><span class="n">comm3d</span><span class="p">,</span><span class="n">mpierr</span><span class="p">)</span>
<a name="ln-492"></a>      <span class="k">call </span><span class="n">MPI_BCAST</span><span class="p">(</span><span class="n">voutold</span><span class="p">,</span><span class="n">ke</span><span class="o">-</span><span class="n">kb</span><span class="o">+</span><span class="mi">1</span><span class="p">,</span><span class="n">MY_REAL</span> <span class="p">,</span><span class="n">nprocs</span><span class="o">-</span><span class="mi">1</span><span class="p">,</span><span class="n">comm3d</span><span class="p">,</span><span class="n">mpierr</span><span class="p">)</span>
<a name="ln-493"></a>
<a name="ln-494"></a>      <span class="c">! integrate v in z</span>
<a name="ln-495"></a>      <span class="k">do </span><span class="n">k</span><span class="o">=</span><span class="n">kb</span><span class="p">,</span><span class="n">ke</span>
<a name="ln-496"></a>        <span class="n">vout</span><span class="p">(</span><span class="n">k</span><span class="p">)</span> <span class="o">=</span> <span class="n">rk3coef</span><span class="o">*</span><span class="n">vout</span><span class="p">(</span><span class="n">k</span><span class="p">)</span><span class="o">*</span><span class="n">dzf</span><span class="p">(</span><span class="n">k</span><span class="p">)</span>
<a name="ln-497"></a>        <span class="n">voutold</span><span class="p">(</span><span class="n">k</span><span class="p">)</span> <span class="o">=</span> <span class="n">voutold</span><span class="p">(</span><span class="n">k</span><span class="p">)</span><span class="o">*</span><span class="n">dzf</span><span class="p">(</span><span class="n">k</span><span class="p">)</span>
<a name="ln-498"></a>      <span class="k">end do</span>
<a name="ln-499"></a><span class="k">      </span><span class="n">voutflow</span> <span class="o">=</span> <span class="nb">sum</span><span class="p">(</span><span class="n">vout</span><span class="p">(</span><span class="n">kb</span><span class="p">:</span><span class="n">ke</span><span class="p">))</span>
<a name="ln-500"></a>      <span class="n">vflowrateold</span> <span class="o">=</span> <span class="nb">sum</span><span class="p">(</span><span class="n">voutold</span><span class="p">(</span><span class="n">kb</span><span class="p">:</span><span class="n">ke</span><span class="p">))</span>
<a name="ln-501"></a>
<a name="ln-502"></a>      <span class="c">! average over outflow area</span>
<a name="ln-503"></a>      <span class="n">voutflow</span> <span class="o">=</span> <span class="n">voutflow</span><span class="o">/</span><span class="n">voutarea</span>
<a name="ln-504"></a>      <span class="n">vflowrateold</span> <span class="o">=</span> <span class="n">vflowrateold</span><span class="o">/</span><span class="n">voutarea</span>
<a name="ln-505"></a>
<a name="ln-506"></a>      <span class="c">! flow correction to match outflow rate</span>
<a name="ln-507"></a>      <span class="n">vdef</span> <span class="o">=</span> <span class="n">vflowrate</span> <span class="o">-</span> <span class="p">(</span><span class="n">voutflow</span> <span class="o">+</span> <span class="n">vflowrateold</span><span class="p">)</span>
<a name="ln-508"></a>      <span class="k">do </span><span class="n">k</span> <span class="o">=</span> <span class="n">kb</span><span class="p">,</span><span class="n">ke</span>
<a name="ln-509"></a>        <span class="k">do </span><span class="n">j</span> <span class="o">=</span> <span class="n">jb</span><span class="p">,</span><span class="n">je</span>
<a name="ln-510"></a>            <span class="k">do </span><span class="n">i</span> <span class="o">=</span> <span class="n">ib</span><span class="p">,</span><span class="n">ie</span>
<a name="ln-511"></a>              <span class="n">vp</span><span class="p">(</span><span class="n">i</span><span class="p">,</span><span class="n">j</span><span class="p">,</span><span class="n">k</span><span class="p">)</span> <span class="o">=</span> <span class="n">vp</span><span class="p">(</span><span class="n">i</span><span class="p">,</span><span class="n">j</span><span class="p">,</span><span class="n">k</span><span class="p">)</span> <span class="o">+</span> <span class="n">vdef</span><span class="o">*</span><span class="n">rk3coefi</span>
<a name="ln-512"></a>            <span class="k">end do</span>
<a name="ln-513"></a><span class="k">        end do</span>
<a name="ln-514"></a><span class="k">      end do</span>
<a name="ln-515"></a>
<a name="ln-516"></a><span class="k">    </span><span class="n">elseif</span> <span class="p">((.</span><span class="nb">not</span><span class="p">.</span><span class="n">linoutflow</span><span class="p">)</span> <span class="p">.</span><span class="nb">and</span><span class="p">.</span> <span class="p">(</span><span class="n">lvvolflowr</span><span class="p">))</span> <span class="k">then</span>
<a name="ln-517"></a><span class="k">      </span><span class="n">rk3coef</span> <span class="o">=</span> <span class="n">dt</span> <span class="o">/</span> <span class="p">(</span><span class="mf">4.</span> <span class="o">-</span> <span class="nb">dble</span><span class="p">(</span><span class="n">rk3step</span><span class="p">))</span>
<a name="ln-518"></a>      <span class="n">rk3coefi</span> <span class="o">=</span> <span class="mi">1</span> <span class="o">/</span> <span class="n">rk3coef</span>
<a name="ln-519"></a>
<a name="ln-520"></a>      <span class="n">vdef</span> <span class="o">=</span> <span class="mf">0.</span>
<a name="ln-521"></a>      <span class="n">vout</span> <span class="o">=</span> <span class="mf">0.</span>
<a name="ln-522"></a>      <span class="n">voutflow</span> <span class="o">=</span> <span class="mf">0.</span>
<a name="ln-523"></a>      <span class="n">voutold</span> <span class="o">=</span> <span class="mf">0.</span>
<a name="ln-524"></a>      <span class="n">vvol</span> <span class="o">=</span> <span class="mf">0.</span>
<a name="ln-525"></a>      <span class="n">vvolold</span> <span class="o">=</span> <span class="mf">0.</span>
<a name="ln-526"></a>
<a name="ln-527"></a>      <span class="c">! integrate v in y</span>
<a name="ln-528"></a>      <span class="k">call </span><span class="n">sumy_ibm</span><span class="p">(</span><span class="n">vvol</span><span class="p">,</span><span class="n">vp</span><span class="p">(</span><span class="n">ib</span><span class="p">:</span><span class="n">ie</span><span class="p">,</span><span class="n">jb</span><span class="p">:</span><span class="n">je</span><span class="p">,</span><span class="n">kb</span><span class="p">:</span><span class="n">ke</span><span class="p">)</span><span class="o">*</span><span class="n">dy</span><span class="p">,</span><span class="n">ib</span><span class="p">,</span><span class="n">ie</span><span class="p">,</span><span class="n">jb</span><span class="p">,</span><span class="n">je</span><span class="p">,</span><span class="n">kb</span><span class="p">,</span><span class="n">ke</span><span class="p">,</span><span class="n">IIv</span><span class="p">(</span><span class="n">ib</span><span class="p">:</span><span class="n">ie</span><span class="p">,</span><span class="n">jb</span><span class="p">:</span><span class="n">je</span><span class="p">,</span><span class="n">kb</span><span class="p">:</span><span class="n">ke</span><span class="p">))</span>  <span class="c">! v tendency at previous time step</span>
<a name="ln-529"></a>      <span class="k">call </span><span class="n">sumy_ibm</span><span class="p">(</span><span class="n">vvolold</span><span class="p">,</span><span class="n">vm</span><span class="p">(</span><span class="n">ib</span><span class="p">:</span><span class="n">ie</span><span class="p">,</span><span class="n">jb</span><span class="p">:</span><span class="n">je</span><span class="p">,</span><span class="n">kb</span><span class="p">:</span><span class="n">ke</span><span class="p">)</span><span class="o">*</span><span class="n">dy</span><span class="p">,</span><span class="n">ib</span><span class="p">,</span><span class="n">ie</span><span class="p">,</span><span class="n">jb</span><span class="p">,</span><span class="n">je</span><span class="p">,</span><span class="n">kb</span><span class="p">,</span><span class="n">ke</span><span class="p">,</span><span class="n">IIv</span><span class="p">(</span><span class="n">ib</span><span class="p">:</span><span class="n">ie</span><span class="p">,</span><span class="n">jb</span><span class="p">:</span><span class="n">je</span><span class="p">,</span><span class="n">kb</span><span class="p">:</span><span class="n">ke</span><span class="p">))</span>  <span class="c">! v at previous time step</span>
<a name="ln-530"></a>
<a name="ln-531"></a>      <span class="c">! integrate v in x</span>
<a name="ln-532"></a>      <span class="k">do </span><span class="n">k</span><span class="o">=</span><span class="n">kb</span><span class="p">,</span><span class="n">ke</span>
<a name="ln-533"></a>        <span class="n">vout</span><span class="p">(</span><span class="n">k</span><span class="p">)</span> <span class="o">=</span> <span class="nb">sum</span><span class="p">(</span><span class="n">vvol</span><span class="p">(</span><span class="n">ib</span><span class="p">:</span><span class="n">ie</span><span class="p">,</span><span class="n">k</span><span class="p">)</span><span class="o">*</span><span class="n">dxf</span><span class="p">(</span><span class="n">ib</span><span class="p">:</span><span class="n">ie</span><span class="p">))</span>
<a name="ln-534"></a>        <span class="n">voutold</span><span class="p">(</span><span class="n">k</span><span class="p">)</span> <span class="o">=</span> <span class="nb">sum</span><span class="p">(</span><span class="n">vvolold</span><span class="p">(</span><span class="n">ib</span><span class="p">:</span><span class="n">ie</span><span class="p">,</span><span class="n">k</span><span class="p">)</span><span class="o">*</span><span class="n">dxf</span><span class="p">(</span><span class="n">ib</span><span class="p">:</span><span class="n">ie</span><span class="p">))</span>
<a name="ln-535"></a>      <span class="k">end do</span>
<a name="ln-536"></a>
<a name="ln-537"></a>      <span class="c">! integrate v in z</span>
<a name="ln-538"></a>      <span class="k">do </span><span class="n">k</span><span class="o">=</span><span class="n">kb</span><span class="p">,</span><span class="n">ke</span>
<a name="ln-539"></a>        <span class="n">vout</span><span class="p">(</span><span class="n">k</span><span class="p">)</span> <span class="o">=</span> <span class="n">rk3coef</span><span class="o">*</span><span class="n">vout</span><span class="p">(</span><span class="n">k</span><span class="p">)</span><span class="o">*</span><span class="n">dzf</span><span class="p">(</span><span class="n">k</span><span class="p">)</span>
<a name="ln-540"></a>        <span class="n">voutold</span><span class="p">(</span><span class="n">k</span><span class="p">)</span> <span class="o">=</span> <span class="n">voutold</span><span class="p">(</span><span class="n">k</span><span class="p">)</span><span class="o">*</span><span class="n">dzf</span><span class="p">(</span><span class="n">k</span><span class="p">)</span>
<a name="ln-541"></a>      <span class="k">end do</span>
<a name="ln-542"></a><span class="k">      </span><span class="n">voutflow</span> <span class="o">=</span> <span class="nb">sum</span><span class="p">(</span><span class="n">vout</span><span class="p">(</span><span class="n">kb</span><span class="p">:</span><span class="n">ke</span><span class="p">))</span>
<a name="ln-543"></a>      <span class="n">vflowrateold</span> <span class="o">=</span> <span class="nb">sum</span><span class="p">(</span><span class="n">voutold</span><span class="p">(</span><span class="n">kb</span><span class="p">:</span><span class="n">ke</span><span class="p">))</span>
<a name="ln-544"></a>
<a name="ln-545"></a>      <span class="c">! average over fluid volume</span>
<a name="ln-546"></a>      <span class="n">voutflow</span> <span class="o">=</span> <span class="n">voutflow</span><span class="o">/</span><span class="n">fluidvol</span>
<a name="ln-547"></a>      <span class="n">vflowrateold</span> <span class="o">=</span> <span class="n">vflowrateold</span><span class="o">/</span><span class="n">fluidvol</span>
<a name="ln-548"></a>
<a name="ln-549"></a>      <span class="c">! flow correction to match outflow rate</span>
<a name="ln-550"></a>      <span class="n">vdef</span> <span class="o">=</span> <span class="n">vflowrate</span> <span class="o">-</span> <span class="p">(</span><span class="n">voutflow</span> <span class="o">+</span> <span class="n">vflowrateold</span><span class="p">)</span>
<a name="ln-551"></a>      <span class="k">do </span><span class="n">k</span> <span class="o">=</span> <span class="n">kb</span><span class="p">,</span><span class="n">ke</span>
<a name="ln-552"></a>        <span class="k">do </span><span class="n">j</span> <span class="o">=</span> <span class="n">jb</span><span class="p">,</span><span class="n">je</span>
<a name="ln-553"></a>            <span class="k">do </span><span class="n">i</span> <span class="o">=</span> <span class="n">ib</span><span class="p">,</span><span class="n">ie</span>
<a name="ln-554"></a>              <span class="n">vp</span><span class="p">(</span><span class="n">i</span><span class="p">,</span><span class="n">j</span><span class="p">,</span><span class="n">k</span><span class="p">)</span> <span class="o">=</span> <span class="n">vp</span><span class="p">(</span><span class="n">i</span><span class="p">,</span><span class="n">j</span><span class="p">,</span><span class="n">k</span><span class="p">)</span> <span class="o">+</span> <span class="n">vdef</span><span class="o">*</span><span class="n">rk3coefi</span>
<a name="ln-555"></a>            <span class="k">end do</span>
<a name="ln-556"></a><span class="k">        end do</span>
<a name="ln-557"></a><span class="k">      end do</span>
<a name="ln-558"></a>
<a name="ln-559"></a><span class="k">    end if</span>
<a name="ln-560"></a>
<a name="ln-561"></a><span class="k">  end subroutine </span><span class="n">masscorr</span>
<a name="ln-562"></a>
<a name="ln-563"></a>  <span class="k">subroutine </span><span class="n">uoutletarea</span><span class="p">(</span><span class="n">area</span><span class="p">)</span>
<a name="ln-564"></a>    <span class="c">! calculates outlet area of domain for u-velocity excluding blocks</span>
<a name="ln-565"></a>
<a name="ln-566"></a>    <span class="k">use </span><span class="n">modglobal</span><span class="p">,</span> <span class="n">only</span>   <span class="p">:</span> <span class="n">ib</span><span class="p">,</span><span class="n">ie</span><span class="p">,</span><span class="n">jb</span><span class="p">,</span><span class="n">je</span><span class="p">,</span><span class="n">kb</span><span class="p">,</span><span class="n">ke</span><span class="p">,</span><span class="n">dy</span><span class="p">,</span><span class="n">dzf</span>
<a name="ln-567"></a>    <span class="k">use </span><span class="n">modfields</span><span class="p">,</span> <span class="n">only</span>   <span class="p">:</span> <span class="n">IIc</span>
<a name="ln-568"></a>    <span class="k">use </span><span class="n">modmpi</span><span class="p">,</span> <span class="n">only</span>      <span class="p">:</span> <span class="n">sumy_ibm</span>
<a name="ln-569"></a>
<a name="ln-570"></a>    <span class="k">implicit none</span>
<a name="ln-571"></a><span class="k">    </span><span class="kt">real</span><span class="p">,</span> <span class="k">intent</span><span class="p">(</span><span class="n">out</span><span class="p">)</span>       <span class="kd">::</span> <span class="n">area</span>
<a name="ln-572"></a>    <span class="kt">real</span><span class="p">,</span> <span class="k">dimension</span><span class="p">(</span><span class="n">kb</span><span class="p">:</span><span class="n">ke</span><span class="p">)</span>  <span class="kd">::</span> <span class="n">sumy</span>
<a name="ln-573"></a>    <span class="kt">integer                    </span><span class="n">k</span>
<a name="ln-574"></a>
<a name="ln-575"></a>    <span class="n">sumy</span> <span class="o">=</span> <span class="mf">0.</span>
<a name="ln-576"></a>    <span class="c">! integrate fluid area at outflow plane in y</span>
<a name="ln-577"></a>    <span class="k">call </span><span class="n">sumy_ibm</span><span class="p">(</span><span class="n">sumy</span><span class="p">,</span><span class="n">IIc</span><span class="p">(</span><span class="n">ie</span><span class="p">,</span><span class="n">jb</span><span class="p">:</span><span class="n">je</span><span class="p">,</span><span class="n">kb</span><span class="p">:</span><span class="n">ke</span><span class="p">)</span><span class="o">*</span><span class="n">dy</span><span class="p">,</span><span class="n">ie</span><span class="p">,</span><span class="n">ie</span><span class="p">,</span><span class="n">jb</span><span class="p">,</span><span class="n">je</span><span class="p">,</span><span class="n">kb</span><span class="p">,</span><span class="n">ke</span><span class="p">,</span><span class="n">IIc</span><span class="p">(</span><span class="n">ie</span><span class="p">,</span><span class="n">jb</span><span class="p">:</span><span class="n">je</span><span class="p">,</span><span class="n">kb</span><span class="p">:</span><span class="n">ke</span><span class="p">))</span>
<a name="ln-578"></a>
<a name="ln-579"></a>    <span class="c">! integrate fluid area at outflow plane in z</span>
<a name="ln-580"></a>    <span class="k">do </span><span class="n">k</span><span class="o">=</span><span class="n">kb</span><span class="p">,</span><span class="n">ke</span>
<a name="ln-581"></a>      <span class="n">sumy</span><span class="p">(</span><span class="n">k</span><span class="p">)</span> <span class="o">=</span> <span class="n">sumy</span><span class="p">(</span><span class="n">k</span><span class="p">)</span><span class="o">*</span><span class="n">dzf</span><span class="p">(</span><span class="n">k</span><span class="p">)</span>
<a name="ln-582"></a>    <span class="k">end do</span>
<a name="ln-583"></a><span class="k">    </span><span class="n">area</span> <span class="o">=</span> <span class="nb">sum</span><span class="p">(</span><span class="n">sumy</span><span class="p">(</span><span class="n">kb</span><span class="p">:</span><span class="n">ke</span><span class="p">))</span>
<a name="ln-584"></a>
<a name="ln-585"></a>  <span class="k">end subroutine </span><span class="n">uoutletarea</span>
<a name="ln-586"></a>
<a name="ln-587"></a>  <span class="k">subroutine </span><span class="n">voutletarea</span><span class="p">(</span><span class="n">area</span><span class="p">)</span>
<a name="ln-588"></a>    <span class="c">! calculates outlet area of domain for v-velocity excluding blocks</span>
<a name="ln-589"></a>
<a name="ln-590"></a>    <span class="k">use </span><span class="n">modglobal</span><span class="p">,</span> <span class="n">only</span> <span class="p">:</span> <span class="n">ib</span><span class="p">,</span><span class="n">ie</span><span class="p">,</span><span class="n">jb</span><span class="p">,</span><span class="n">je</span><span class="p">,</span><span class="n">kb</span><span class="p">,</span><span class="n">ke</span><span class="p">,</span><span class="n">dxf</span><span class="p">,</span><span class="n">dzf</span>
<a name="ln-591"></a>    <span class="k">use </span><span class="n">modfields</span><span class="p">,</span> <span class="n">only</span> <span class="p">:</span> <span class="n">IIc</span>
<a name="ln-592"></a>    <span class="k">use </span><span class="n">modmpi</span><span class="p">,</span>    <span class="n">only</span> <span class="p">:</span> <span class="n">myid</span><span class="p">,</span><span class="n">comm3d</span><span class="p">,</span><span class="n">mpierr</span><span class="p">,</span><span class="n">nprocs</span><span class="p">,</span><span class="n">MY_REAL</span>
<a name="ln-593"></a>
<a name="ln-594"></a>    <span class="k">implicit none</span>
<a name="ln-595"></a><span class="k">    </span><span class="kt">real</span><span class="p">,</span> <span class="k">intent</span><span class="p">(</span><span class="n">out</span><span class="p">)</span>       <span class="kd">::</span> <span class="n">area</span>
<a name="ln-596"></a>    <span class="kt">real</span><span class="p">,</span> <span class="k">dimension</span><span class="p">(</span><span class="n">kb</span><span class="p">:</span><span class="n">ke</span><span class="p">)</span>  <span class="kd">::</span> <span class="n">sumx</span>
<a name="ln-597"></a>    <span class="kt">integer                    </span><span class="n">k</span>
<a name="ln-598"></a>
<a name="ln-599"></a>    <span class="n">sumx</span> <span class="o">=</span> <span class="mf">0.</span>
<a name="ln-600"></a>    <span class="c">! integrate fluid area at outflow plane in x</span>
<a name="ln-601"></a>    <span class="k">if</span> <span class="p">(</span><span class="n">myid</span><span class="o">==</span><span class="n">nprocs</span><span class="o">-</span><span class="mi">1</span><span class="p">)</span> <span class="k">then</span>
<a name="ln-602"></a><span class="k">      do </span><span class="n">k</span><span class="o">=</span><span class="n">kb</span><span class="p">,</span><span class="n">ke</span>
<a name="ln-603"></a>        <span class="n">sumx</span><span class="p">(</span><span class="n">k</span><span class="p">)</span> <span class="o">=</span> <span class="nb">sum</span><span class="p">(</span><span class="n">IIc</span><span class="p">(</span><span class="n">ib</span><span class="p">:</span><span class="n">ie</span><span class="p">,</span><span class="n">je</span><span class="p">,</span><span class="n">k</span><span class="p">)</span><span class="o">*</span><span class="n">dxf</span><span class="p">(</span><span class="n">ib</span><span class="p">:</span><span class="n">ie</span><span class="p">))</span>
<a name="ln-604"></a>      <span class="k">end do</span>
<a name="ln-605"></a><span class="k">    end if</span>
<a name="ln-606"></a>
<a name="ln-607"></a><span class="k">    call </span><span class="n">MPI_BCAST</span><span class="p">(</span><span class="n">sumx</span><span class="p">,</span><span class="n">ke</span><span class="o">-</span><span class="n">kb</span><span class="o">+</span><span class="mi">1</span><span class="p">,</span><span class="n">MY_REAL</span><span class="p">,</span><span class="n">nprocs</span><span class="o">-</span><span class="mi">1</span><span class="p">,</span><span class="n">comm3d</span><span class="p">,</span><span class="n">mpierr</span><span class="p">)</span>
<a name="ln-608"></a>
<a name="ln-609"></a>    <span class="c">! integrate fluid area at outflow plane in z</span>
<a name="ln-610"></a>    <span class="k">do </span><span class="n">k</span><span class="o">=</span><span class="n">kb</span><span class="p">,</span><span class="n">ke</span>
<a name="ln-611"></a>      <span class="n">sumx</span><span class="p">(</span><span class="n">k</span><span class="p">)</span> <span class="o">=</span> <span class="n">sumx</span><span class="p">(</span><span class="n">k</span><span class="p">)</span><span class="o">*</span><span class="n">dzf</span><span class="p">(</span><span class="n">k</span><span class="p">)</span>
<a name="ln-612"></a>    <span class="k">end do</span>
<a name="ln-613"></a><span class="k">    </span><span class="n">area</span> <span class="o">=</span> <span class="nb">sum</span><span class="p">(</span><span class="n">sumx</span><span class="p">(</span><span class="n">kb</span><span class="p">:</span><span class="n">ke</span><span class="p">))</span>
<a name="ln-614"></a>
<a name="ln-615"></a>  <span class="k">end subroutine </span><span class="n">voutletarea</span>
<a name="ln-616"></a>
<a name="ln-617"></a>  <span class="k">subroutine </span><span class="n">fluidvolume</span><span class="p">(</span><span class="n">volume</span><span class="p">)</span>
<a name="ln-618"></a>    <span class="c">! calculates fluid volume of domain excluding blocks</span>
<a name="ln-619"></a>
<a name="ln-620"></a>    <span class="k">use </span><span class="n">modglobal</span><span class="p">,</span> <span class="n">only</span>   <span class="p">:</span> <span class="n">ib</span><span class="p">,</span><span class="n">ie</span><span class="p">,</span><span class="n">jb</span><span class="p">,</span><span class="n">je</span><span class="p">,</span><span class="n">kb</span><span class="p">,</span><span class="n">ke</span><span class="p">,</span><span class="n">dy</span><span class="p">,</span><span class="n">dxf</span><span class="p">,</span><span class="n">dzf</span>
<a name="ln-621"></a>    <span class="k">use </span><span class="n">modfields</span><span class="p">,</span> <span class="n">only</span>   <span class="p">:</span> <span class="n">IIc</span>
<a name="ln-622"></a>    <span class="k">use </span><span class="n">modmpi</span><span class="p">,</span> <span class="n">only</span>      <span class="p">:</span> <span class="n">sumy_ibm</span>
<a name="ln-623"></a>
<a name="ln-624"></a>    <span class="k">implicit none</span>
<a name="ln-625"></a><span class="k">    </span><span class="kt">real</span><span class="p">,</span> <span class="k">intent</span><span class="p">(</span><span class="n">out</span><span class="p">)</span>             <span class="kd">::</span> <span class="n">volume</span>
<a name="ln-626"></a>    <span class="kt">real</span><span class="p">,</span> <span class="k">dimension</span><span class="p">(</span><span class="n">ib</span><span class="p">:</span><span class="n">ie</span><span class="p">,</span><span class="n">kb</span><span class="p">:</span><span class="n">ke</span><span class="p">)</span>  <span class="kd">::</span> <span class="n">sumy</span>
<a name="ln-627"></a>    <span class="kt">real</span><span class="p">,</span> <span class="k">dimension</span><span class="p">(</span><span class="n">kb</span><span class="p">:</span><span class="n">ke</span><span class="p">)</span>        <span class="kd">::</span> <span class="n">sumxy</span>
<a name="ln-628"></a>    <span class="kt">integer                          </span><span class="n">k</span>
<a name="ln-629"></a>
<a name="ln-630"></a>    <span class="n">sumy</span> <span class="o">=</span> <span class="mf">0.</span>
<a name="ln-631"></a>    <span class="n">sumxy</span> <span class="o">=</span> <span class="mf">0.</span>
<a name="ln-632"></a>
<a name="ln-633"></a>    <span class="c">! integrate fluid volume in y</span>
<a name="ln-634"></a>    <span class="k">call </span><span class="n">sumy_ibm</span><span class="p">(</span><span class="n">sumy</span><span class="p">,</span><span class="n">IIc</span><span class="p">(</span><span class="n">ib</span><span class="p">:</span><span class="n">ie</span><span class="p">,</span><span class="n">jb</span><span class="p">:</span><span class="n">je</span><span class="p">,</span><span class="n">kb</span><span class="p">:</span><span class="n">ke</span><span class="p">)</span><span class="o">*</span><span class="n">dy</span><span class="p">,</span><span class="n">ib</span><span class="p">,</span><span class="n">ie</span><span class="p">,</span><span class="n">jb</span><span class="p">,</span><span class="n">je</span><span class="p">,</span><span class="n">kb</span><span class="p">,</span><span class="n">ke</span><span class="p">,</span><span class="n">IIc</span><span class="p">(</span><span class="n">ib</span><span class="p">:</span><span class="n">ie</span><span class="p">,</span><span class="n">jb</span><span class="p">:</span><span class="n">je</span><span class="p">,</span><span class="n">kb</span><span class="p">:</span><span class="n">ke</span><span class="p">))</span>
<a name="ln-635"></a>
<a name="ln-636"></a>    <span class="c">! integrate fluid area in x</span>
<a name="ln-637"></a>    <span class="k">do </span><span class="n">k</span><span class="o">=</span><span class="n">kb</span><span class="p">,</span><span class="n">ke</span>
<a name="ln-638"></a>      <span class="n">sumxy</span><span class="p">(</span><span class="n">k</span><span class="p">)</span> <span class="o">=</span> <span class="nb">sum</span><span class="p">(</span><span class="n">sumy</span><span class="p">(</span><span class="n">ib</span><span class="p">:</span><span class="n">ie</span><span class="p">,</span><span class="n">k</span><span class="p">)</span><span class="o">*</span><span class="n">dxf</span><span class="p">(</span><span class="n">ib</span><span class="p">:</span><span class="n">ie</span><span class="p">))</span>
<a name="ln-639"></a>    <span class="k">end do</span>
<a name="ln-640"></a>
<a name="ln-641"></a>    <span class="c">! integrate fluid area in z</span>
<a name="ln-642"></a>    <span class="n">volume</span> <span class="o">=</span> <span class="nb">sum</span><span class="p">(</span><span class="n">sumxy</span><span class="p">(</span><span class="n">kb</span><span class="p">:</span><span class="n">ke</span><span class="p">)</span><span class="o">*</span><span class="n">dzf</span><span class="p">(</span><span class="n">kb</span><span class="p">:</span><span class="n">ke</span><span class="p">))</span>
<a name="ln-643"></a>
<a name="ln-644"></a>  <span class="k">end subroutine </span><span class="n">fluidvolume</span>
<a name="ln-645"></a>
<a name="ln-646"></a>  <span class="k">subroutine </span><span class="n">calcfluidvolumes</span>
<a name="ln-647"></a>    <span class="c">!&gt; calculates fluid volume and outlet areas, excluding blocks</span>
<a name="ln-648"></a>    <span class="c">!&gt; and saves it to variables from modfields</span>
<a name="ln-649"></a>
<a name="ln-650"></a>    <span class="k">use </span><span class="n">modfields</span><span class="p">,</span> <span class="n">only</span> <span class="p">:</span> <span class="n">uoutarea</span><span class="p">,</span> <span class="n">voutarea</span><span class="p">,</span> <span class="n">fluidvol</span>
<a name="ln-651"></a>    <span class="k">implicit none</span>
<a name="ln-652"></a><span class="k">    </span><span class="kt">real</span> <span class="kd">::</span> <span class="n">volume</span>
<a name="ln-653"></a>
<a name="ln-654"></a>    <span class="c">! calculate outlet area</span>
<a name="ln-655"></a>    <span class="k">call </span><span class="n">uoutletarea</span><span class="p">(</span><span class="n">volume</span><span class="p">)</span>
<a name="ln-656"></a>    <span class="n">uoutarea</span> <span class="o">=</span> <span class="n">volume</span>
<a name="ln-657"></a>    <span class="c">! calculate outlet area</span>
<a name="ln-658"></a>    <span class="k">call </span><span class="n">voutletarea</span><span class="p">(</span><span class="n">volume</span><span class="p">)</span>
<a name="ln-659"></a>    <span class="n">voutarea</span> <span class="o">=</span> <span class="n">volume</span>
<a name="ln-660"></a>    <span class="c">! calculate fluid volume</span>
<a name="ln-661"></a>    <span class="k">call </span><span class="n">fluidvolume</span><span class="p">(</span><span class="n">volume</span><span class="p">)</span>
<a name="ln-662"></a>    <span class="n">fluidvol</span> <span class="o">=</span> <span class="n">volume</span>
<a name="ln-663"></a>
<a name="ln-664"></a>  <span class="k">end subroutine </span><span class="n">calcfluidvolumes</span>
<a name="ln-665"></a>
<a name="ln-666"></a>  <span class="k">subroutine </span><span class="n">coriolis</span>
<a name="ln-667"></a>
<a name="ln-668"></a>    <span class="c">!-----------------------------------------------------------------|</span>
<a name="ln-669"></a>    <span class="c">!                                                                 |</span>
<a name="ln-670"></a>    <span class="c">!      Thijs Heus TU Delft                                        |</span>
<a name="ln-671"></a>    <span class="c">!                                                                 |</span>
<a name="ln-672"></a>    <span class="c">!     purpose.                                                    |</span>
<a name="ln-673"></a>    <span class="c">!     --------                                                    |</span>
<a name="ln-674"></a>    <span class="c">!                                                                 |</span>
<a name="ln-675"></a>    <span class="c">!      Calculates the Coriolis force.                             |</span>
<a name="ln-676"></a>    <span class="c">!                                                                 |</span>
<a name="ln-677"></a>    <span class="c">!**   interface.                                                  |</span>
<a name="ln-678"></a>    <span class="c">!     ----------                                                  |</span>
<a name="ln-679"></a>    <span class="c">!                                                                 |</span>
<a name="ln-680"></a>    <span class="c">!     *coriolis* is called from *program*.                        |</span>
<a name="ln-681"></a>    <span class="c">!                                                                 |</span>
<a name="ln-682"></a>    <span class="c">!-----------------------------------------------------------------|</span>
<a name="ln-683"></a>
<a name="ln-684"></a>    <span class="c">! use modglobal, only : i1,j1,kmax,dzh,dzf,om22,om23</span>
<a name="ln-685"></a>    <span class="k">use </span><span class="n">modglobal</span><span class="p">,</span> <span class="n">only</span> <span class="p">:</span> <span class="n">ib</span><span class="p">,</span><span class="n">ie</span><span class="p">,</span><span class="n">jb</span><span class="p">,</span><span class="n">je</span><span class="p">,</span><span class="n">kb</span><span class="p">,</span><span class="n">ke</span><span class="p">,</span><span class="n">kh</span><span class="p">,</span><span class="n">dzh</span><span class="p">,</span><span class="n">dzf</span><span class="p">,</span><span class="n">om22</span><span class="p">,</span><span class="n">om23</span><span class="p">,</span><span class="n">lcoriol</span><span class="p">,</span><span class="n">lprofforc</span><span class="p">,</span><span class="n">timee</span>
<a name="ln-686"></a>    <span class="k">use </span><span class="n">modfields</span><span class="p">,</span> <span class="n">only</span> <span class="p">:</span> <span class="n">u0</span><span class="p">,</span><span class="n">v0</span><span class="p">,</span><span class="n">w0</span><span class="p">,</span><span class="n">up</span><span class="p">,</span><span class="n">vp</span><span class="p">,</span><span class="n">wp</span><span class="p">,</span><span class="n">ug</span><span class="p">,</span><span class="n">vg</span>
<a name="ln-687"></a>    <span class="k">use </span><span class="n">modmpi</span><span class="p">,</span> <span class="n">only</span> <span class="p">:</span> <span class="n">myid</span>
<a name="ln-688"></a>    <span class="k">implicit none</span>
<a name="ln-689"></a>
<a name="ln-690"></a><span class="k">    </span><span class="kt">integer </span><span class="n">i</span><span class="p">,</span> <span class="n">j</span><span class="p">,</span> <span class="n">k</span><span class="p">,</span> <span class="n">jm</span><span class="p">,</span> <span class="n">jp</span><span class="p">,</span> <span class="n">km</span><span class="p">,</span> <span class="n">kp</span>
<a name="ln-691"></a>    <span class="kt">real</span><span class="p">,</span> <span class="k">dimension</span><span class="p">(</span><span class="n">kb</span><span class="p">:</span><span class="n">ke</span><span class="o">+</span><span class="n">kh</span><span class="p">)</span> <span class="kd">::</span> <span class="n">ugg</span>
<a name="ln-692"></a>    <span class="kt">real </span><span class="n">om23g</span>
<a name="ln-693"></a>
<a name="ln-694"></a>    <span class="k">if</span> <span class="p">(</span><span class="n">lcoriol</span> <span class="p">)</span> <span class="k">then</span>
<a name="ln-695"></a>      <span class="c">! if (myid==0) then</span>
<a name="ln-696"></a>      <span class="c">!   write(*,*) &quot;up before coriol&quot;,up(3,3,ke)</span>
<a name="ln-697"></a>      <span class="c">! end if</span>
<a name="ln-698"></a>      <span class="k">do </span><span class="n">k</span><span class="o">=</span><span class="n">kb</span><span class="o">+</span><span class="mi">1</span><span class="p">,</span><span class="n">ke</span>
<a name="ln-699"></a>        <span class="n">kp</span><span class="o">=</span><span class="n">k</span><span class="o">+</span><span class="mi">1</span>
<a name="ln-700"></a>        <span class="n">km</span><span class="o">=</span><span class="n">k</span><span class="o">-</span><span class="mi">1</span>
<a name="ln-701"></a>        <span class="k">do </span><span class="n">j</span><span class="o">=</span><span class="n">jb</span><span class="p">,</span><span class="n">je</span>
<a name="ln-702"></a>          <span class="n">jp</span><span class="o">=</span><span class="n">j</span><span class="o">+</span><span class="mi">1</span>
<a name="ln-703"></a>          <span class="n">jm</span><span class="o">=</span><span class="n">j</span><span class="o">-</span><span class="mi">1</span>
<a name="ln-704"></a>          <span class="k">do </span><span class="n">i</span><span class="o">=</span><span class="n">ib</span><span class="p">,</span><span class="n">ie</span>
<a name="ln-705"></a>
<a name="ln-706"></a>            <span class="n">up</span><span class="p">(</span><span class="n">i</span><span class="p">,</span><span class="n">j</span><span class="p">,</span><span class="n">k</span><span class="p">)</span> <span class="o">=</span> <span class="n">up</span><span class="p">(</span><span class="n">i</span><span class="p">,</span><span class="n">j</span><span class="p">,</span><span class="n">k</span><span class="p">)</span>  <span class="p">&amp;</span>
<a name="ln-707"></a>                  <span class="o">+</span><span class="p">((</span><span class="n">v0</span><span class="p">(</span><span class="n">i</span><span class="p">,</span><span class="n">j</span><span class="p">,</span><span class="n">k</span><span class="p">)</span><span class="o">+</span><span class="n">v0</span><span class="p">(</span><span class="n">i</span><span class="p">,</span><span class="n">jp</span><span class="p">,</span><span class="n">k</span><span class="p">)</span><span class="o">+</span><span class="n">v0</span><span class="p">(</span><span class="n">i</span><span class="o">-</span><span class="mi">1</span><span class="p">,</span><span class="n">j</span><span class="p">,</span><span class="n">k</span><span class="p">)</span><span class="o">+</span><span class="n">v0</span><span class="p">(</span><span class="n">i</span><span class="o">-</span><span class="mi">1</span><span class="p">,</span><span class="n">jp</span><span class="p">,</span><span class="n">k</span><span class="p">))</span><span class="o">*</span><span class="n">om23</span><span class="o">*</span><span class="mf">0.25</span><span class="p">)</span> <span class="p">&amp;</span>
<a name="ln-708"></a>                  <span class="o">-</span><span class="p">((</span><span class="n">w0</span><span class="p">(</span><span class="n">i</span><span class="p">,</span><span class="n">j</span><span class="p">,</span><span class="n">k</span><span class="p">)</span><span class="o">+</span><span class="n">w0</span><span class="p">(</span><span class="n">i</span><span class="p">,</span><span class="n">j</span><span class="p">,</span><span class="n">kp</span><span class="p">)</span><span class="o">+</span><span class="n">w0</span><span class="p">(</span><span class="n">i</span><span class="o">-</span><span class="mi">1</span><span class="p">,</span><span class="n">j</span><span class="p">,</span><span class="n">kp</span><span class="p">)</span><span class="o">+</span><span class="n">w0</span><span class="p">(</span><span class="n">i</span><span class="o">-</span><span class="mi">1</span><span class="p">,</span><span class="n">j</span><span class="p">,</span><span class="n">k</span><span class="p">))</span><span class="o">*</span><span class="n">om22</span><span class="o">*</span><span class="mf">0.25</span><span class="p">)</span>
<a name="ln-709"></a>
<a name="ln-710"></a>            <span class="n">vp</span><span class="p">(</span><span class="n">i</span><span class="p">,</span><span class="n">j</span><span class="p">,</span><span class="n">k</span><span class="p">)</span> <span class="o">=</span> <span class="n">vp</span><span class="p">(</span><span class="n">i</span><span class="p">,</span><span class="n">j</span><span class="p">,</span><span class="n">k</span><span class="p">)</span>  <span class="p">&amp;</span>
<a name="ln-711"></a>                  <span class="o">-</span><span class="p">((</span><span class="n">u0</span><span class="p">(</span><span class="n">i</span><span class="p">,</span><span class="n">j</span><span class="p">,</span><span class="n">k</span><span class="p">)</span><span class="o">+</span><span class="n">u0</span><span class="p">(</span><span class="n">i</span><span class="p">,</span><span class="n">jm</span><span class="p">,</span><span class="n">k</span><span class="p">)</span><span class="o">+</span><span class="n">u0</span><span class="p">(</span><span class="n">i</span><span class="o">+</span><span class="mi">1</span><span class="p">,</span><span class="n">jm</span><span class="p">,</span><span class="n">k</span><span class="p">)</span><span class="o">+</span><span class="n">u0</span><span class="p">(</span><span class="n">i</span><span class="o">+</span><span class="mi">1</span><span class="p">,</span><span class="n">j</span><span class="p">,</span><span class="n">k</span><span class="p">))</span><span class="o">*</span><span class="n">om23</span><span class="o">*</span><span class="mf">0.25</span><span class="p">)</span>
<a name="ln-712"></a>
<a name="ln-713"></a>
<a name="ln-714"></a>            <span class="n">wp</span><span class="p">(</span><span class="n">i</span><span class="p">,</span><span class="n">j</span><span class="p">,</span><span class="n">k</span><span class="p">)</span> <span class="o">=</span> <span class="n">wp</span><span class="p">(</span><span class="n">i</span><span class="p">,</span><span class="n">j</span><span class="p">,</span><span class="n">k</span><span class="p">)</span> <span class="o">+</span><span class="p">((</span> <span class="p">(</span><span class="n">dzf</span><span class="p">(</span><span class="n">km</span><span class="p">)</span> <span class="o">*</span> <span class="p">(</span><span class="n">u0</span><span class="p">(</span><span class="n">i</span><span class="p">,</span><span class="n">j</span><span class="p">,</span><span class="n">k</span><span class="p">)</span>  <span class="o">+</span> <span class="n">u0</span><span class="p">(</span><span class="n">i</span><span class="o">+</span><span class="mi">1</span><span class="p">,</span><span class="n">j</span><span class="p">,</span><span class="n">k</span><span class="p">)</span> <span class="p">)</span>    <span class="p">&amp;</span>
<a name="ln-715"></a>                        <span class="o">+</span>    <span class="n">dzf</span><span class="p">(</span><span class="n">k</span><span class="p">)</span>  <span class="o">*</span> <span class="p">(</span><span class="n">u0</span><span class="p">(</span><span class="n">i</span><span class="p">,</span><span class="n">j</span><span class="p">,</span><span class="n">km</span><span class="p">)</span> <span class="o">+</span> <span class="n">u0</span><span class="p">(</span><span class="n">i</span><span class="o">+</span><span class="mi">1</span><span class="p">,</span><span class="n">j</span><span class="p">,</span><span class="n">km</span><span class="p">))</span>  <span class="p">)</span> <span class="o">/</span> <span class="n">dzh</span><span class="p">(</span><span class="n">k</span><span class="p">)</span> <span class="p">)</span> <span class="p">&amp;</span>
<a name="ln-716"></a>                        <span class="o">*</span> <span class="n">om22</span><span class="o">*</span><span class="mf">0.25</span><span class="p">)</span>
<a name="ln-717"></a>
<a name="ln-718"></a>          <span class="k">end do</span>
<a name="ln-719"></a><span class="k">        end do</span>
<a name="ln-720"></a>        <span class="c">! -------------------------------------------end i&amp;j-loop</span>
<a name="ln-721"></a>      <span class="k">end do</span>
<a name="ln-722"></a>      <span class="c">! -------------------------------------------end k-loop</span>
<a name="ln-723"></a>
<a name="ln-724"></a>      <span class="c">! --------------------------------------------</span>
<a name="ln-725"></a>      <span class="c">! special treatment for lowest full level: k=1</span>
<a name="ln-726"></a>      <span class="c">! --------------------------------------------</span>
<a name="ln-727"></a>
<a name="ln-728"></a>      <span class="k">do </span><span class="n">j</span><span class="o">=</span><span class="n">jb</span><span class="p">,</span><span class="n">je</span>
<a name="ln-729"></a>        <span class="n">jp</span> <span class="o">=</span> <span class="n">j</span><span class="o">+</span><span class="mi">1</span>
<a name="ln-730"></a>        <span class="n">jm</span> <span class="o">=</span> <span class="n">j</span><span class="o">-</span><span class="mi">1</span>
<a name="ln-731"></a>        <span class="k">do </span><span class="n">i</span><span class="o">=</span><span class="n">ib</span><span class="p">,</span><span class="n">ie</span>
<a name="ln-732"></a>
<a name="ln-733"></a>          <span class="n">up</span><span class="p">(</span><span class="n">i</span><span class="p">,</span><span class="n">j</span><span class="p">,</span><span class="n">kb</span><span class="p">)</span> <span class="o">=</span> <span class="n">up</span><span class="p">(</span><span class="n">i</span><span class="p">,</span><span class="n">j</span><span class="p">,</span><span class="n">kb</span><span class="p">)</span>  <span class="p">&amp;</span>
<a name="ln-734"></a>                <span class="o">+</span><span class="p">(</span><span class="n">v0</span><span class="p">(</span><span class="n">i</span><span class="p">,</span><span class="n">j</span><span class="p">,</span><span class="n">kb</span><span class="p">)</span><span class="o">+</span><span class="n">v0</span><span class="p">(</span><span class="n">i</span><span class="p">,</span><span class="n">jp</span><span class="p">,</span><span class="n">kb</span><span class="p">)</span><span class="o">+</span><span class="n">v0</span><span class="p">(</span><span class="n">i</span><span class="o">-</span><span class="mi">1</span><span class="p">,</span><span class="n">j</span><span class="p">,</span><span class="n">kb</span><span class="p">)</span><span class="o">+</span><span class="n">v0</span><span class="p">(</span><span class="n">i</span><span class="o">-</span><span class="mi">1</span><span class="p">,</span><span class="n">jp</span><span class="p">,</span><span class="n">kb</span><span class="p">))</span><span class="o">*</span><span class="n">om23</span><span class="o">*</span><span class="mf">0.25</span> <span class="p">&amp;</span>
<a name="ln-735"></a>                <span class="o">-</span><span class="p">(</span><span class="n">w0</span><span class="p">(</span><span class="n">i</span><span class="p">,</span><span class="n">j</span><span class="p">,</span><span class="n">kb</span><span class="p">)</span><span class="o">+</span><span class="n">w0</span><span class="p">(</span><span class="n">i</span><span class="p">,</span><span class="n">j</span> <span class="p">,</span><span class="n">kb</span><span class="o">+</span><span class="mi">1</span><span class="p">)</span><span class="o">+</span><span class="n">w0</span><span class="p">(</span><span class="n">i</span><span class="o">-</span><span class="mi">1</span><span class="p">,</span><span class="n">j</span><span class="p">,</span><span class="n">kb</span><span class="o">+</span><span class="mi">1</span><span class="p">)</span><span class="o">+</span><span class="n">w0</span><span class="p">(</span><span class="n">i</span><span class="o">-</span><span class="mi">1</span><span class="p">,</span><span class="n">j</span> <span class="p">,</span><span class="n">kb</span><span class="p">))</span><span class="o">*</span><span class="n">om22</span><span class="o">*</span><span class="mf">0.25</span>
<a name="ln-736"></a>
<a name="ln-737"></a>          <span class="n">vp</span><span class="p">(</span><span class="n">i</span><span class="p">,</span><span class="n">j</span><span class="p">,</span><span class="n">kb</span><span class="p">)</span> <span class="o">=</span> <span class="n">vp</span><span class="p">(</span><span class="n">i</span><span class="p">,</span><span class="n">j</span><span class="p">,</span><span class="n">kb</span><span class="p">)</span> <span class="p">&amp;</span>
<a name="ln-738"></a>                <span class="o">-</span><span class="p">(</span><span class="n">u0</span><span class="p">(</span><span class="n">i</span><span class="p">,</span><span class="n">j</span><span class="p">,</span><span class="n">kb</span><span class="p">)</span><span class="o">+</span><span class="n">u0</span><span class="p">(</span><span class="n">i</span><span class="p">,</span><span class="n">jm</span><span class="p">,</span><span class="n">kb</span><span class="p">)</span><span class="o">+</span><span class="n">u0</span><span class="p">(</span><span class="n">i</span><span class="o">+</span><span class="mi">1</span><span class="p">,</span><span class="n">jm</span><span class="p">,</span><span class="n">kb</span><span class="p">)</span><span class="o">+</span><span class="n">u0</span><span class="p">(</span><span class="n">i</span><span class="o">+</span><span class="mi">1</span><span class="p">,</span><span class="n">j</span><span class="p">,</span><span class="n">kb</span><span class="p">))</span><span class="o">*</span><span class="n">om23</span><span class="o">*</span><span class="mf">0.25</span>
<a name="ln-739"></a>
<a name="ln-740"></a>          <span class="n">wp</span><span class="p">(</span><span class="n">i</span><span class="p">,</span><span class="n">j</span><span class="p">,</span><span class="n">kb</span><span class="p">)</span> <span class="o">=</span> <span class="mf">0.0</span>
<a name="ln-741"></a>
<a name="ln-742"></a>        <span class="k">end do</span>
<a name="ln-743"></a><span class="k">      end do</span>
<a name="ln-744"></a>      <span class="c">! ----------------------------------------------end i,j-loop</span>
<a name="ln-745"></a>      <span class="c">! if (myid==0) then</span>
<a name="ln-746"></a>      <span class="c">!   write(*,*) &quot;up after coriol&quot;,up(3,3,ke)</span>
<a name="ln-747"></a>      <span class="c">! end if</span>
<a name="ln-748"></a>
<a name="ln-749"></a>    <span class="n">elseif</span> <span class="p">(</span><span class="n">lprofforc</span><span class="p">)</span> <span class="k">then</span>
<a name="ln-750"></a>
<a name="ln-751"></a><span class="k">      </span><span class="n">ugg</span><span class="p">(:)</span> <span class="o">=</span> <span class="n">ug</span><span class="p">(:)</span>
<a name="ln-752"></a>      <span class="n">om23g</span> <span class="o">=</span> <span class="n">om23</span>
<a name="ln-753"></a>
<a name="ln-754"></a>      <span class="k">do </span><span class="n">k</span><span class="o">=</span><span class="n">kb</span><span class="o">+</span><span class="mi">1</span><span class="p">,</span><span class="n">ke</span>
<a name="ln-755"></a>        <span class="k">do </span><span class="n">j</span><span class="o">=</span><span class="n">jb</span><span class="p">,</span><span class="n">je</span>
<a name="ln-756"></a>          <span class="k">do </span><span class="n">i</span><span class="o">=</span><span class="n">ib</span><span class="p">,</span><span class="n">ie</span>
<a name="ln-757"></a>
<a name="ln-758"></a>            <span class="n">up</span><span class="p">(</span><span class="n">i</span><span class="p">,</span><span class="n">j</span><span class="p">,</span><span class="n">k</span><span class="p">)</span> <span class="o">=</span> <span class="n">up</span><span class="p">(</span><span class="n">i</span><span class="p">,</span><span class="n">j</span><span class="p">,</span><span class="n">k</span><span class="p">)</span> <span class="o">+</span> <span class="n">om23g</span><span class="o">*</span><span class="p">(</span><span class="n">ugg</span><span class="p">(</span><span class="n">k</span><span class="p">)</span> <span class="o">-</span> <span class="n">u0</span><span class="p">(</span><span class="n">i</span><span class="p">,</span><span class="n">j</span><span class="p">,</span><span class="n">k</span><span class="p">))</span>
<a name="ln-759"></a>
<a name="ln-760"></a>          <span class="n">enddo</span>
<a name="ln-761"></a>        <span class="n">enddo</span>
<a name="ln-762"></a>      <span class="n">enddo</span>
<a name="ln-763"></a>
<a name="ln-764"></a>      <span class="c">! --------------------------------------------</span>
<a name="ln-765"></a>      <span class="c">! special treatment for lowest full level: k=1</span>
<a name="ln-766"></a>      <span class="c">! --------------------------------------------</span>
<a name="ln-767"></a>
<a name="ln-768"></a>      <span class="k">do </span><span class="n">j</span><span class="o">=</span><span class="n">jb</span><span class="p">,</span><span class="n">je</span>
<a name="ln-769"></a>        <span class="n">jp</span> <span class="o">=</span> <span class="n">j</span><span class="o">+</span><span class="mi">1</span>
<a name="ln-770"></a>        <span class="n">jm</span> <span class="o">=</span> <span class="n">j</span><span class="o">-</span><span class="mi">1</span>
<a name="ln-771"></a>        <span class="k">do </span><span class="n">i</span><span class="o">=</span><span class="n">ib</span><span class="p">,</span><span class="n">ie</span>
<a name="ln-772"></a>
<a name="ln-773"></a>          <span class="n">up</span><span class="p">(</span><span class="n">i</span><span class="p">,</span><span class="n">j</span><span class="p">,</span><span class="n">kb</span><span class="p">)</span> <span class="o">=</span> <span class="n">up</span><span class="p">(</span><span class="n">i</span><span class="p">,</span><span class="n">j</span><span class="p">,</span><span class="n">kb</span><span class="p">)</span> <span class="o">+</span> <span class="n">om23g</span><span class="o">*</span><span class="p">(</span><span class="n">ugg</span><span class="p">(</span><span class="n">kb</span><span class="p">)</span> <span class="o">-</span> <span class="n">u0</span><span class="p">(</span><span class="n">i</span><span class="p">,</span><span class="n">j</span><span class="p">,</span><span class="n">kb</span><span class="p">))</span>
<a name="ln-774"></a>
<a name="ln-775"></a>        <span class="n">enddo</span>
<a name="ln-776"></a>      <span class="n">enddo</span>
<a name="ln-777"></a>      <span class="c">! if (myid==0) then</span>
<a name="ln-778"></a>      <span class="c">!   write(*,*) &quot;up after profforc&quot;,up(3,3,ke)</span>
<a name="ln-779"></a>      <span class="c">! end if</span>
<a name="ln-780"></a>
<a name="ln-781"></a>    <span class="n">endif</span> <span class="c">!lcoriol and lprofforc</span>
<a name="ln-782"></a>
<a name="ln-783"></a>    <span class="k">return</span>
<a name="ln-784"></a><span class="k">  end subroutine </span><span class="n">coriolis</span>
<a name="ln-785"></a>
<a name="ln-786"></a>  <span class="k">subroutine </span><span class="n">lstend</span>
<a name="ln-787"></a>
<a name="ln-788"></a>    <span class="c">!-----------------------------------------------------------------|</span>
<a name="ln-789"></a>    <span class="c">!                                                                 |</span>
<a name="ln-790"></a>    <span class="c">!*** *lstend*  calculates large-scale tendencies                  |</span>
<a name="ln-791"></a>    <span class="c">!                                                                 |</span>
<a name="ln-792"></a>    <span class="c">!      Pier Siebesma   K.N.M.I.     06/01/1995                    |</span>
<a name="ln-793"></a>    <span class="c">!                                                                 |</span>
<a name="ln-794"></a>    <span class="c">!     purpose.                                                    |</span>
<a name="ln-795"></a>    <span class="c">!     --------                                                    |</span>
<a name="ln-796"></a>    <span class="c">!                                                                 |</span>
<a name="ln-797"></a>    <span class="c">!     calculates and adds large-scale tendencies due to           |</span>
<a name="ln-798"></a>    <span class="c">!     large scale advection and subsidence.                       |</span>
<a name="ln-799"></a>    <span class="c">!                                                                 |</span>
<a name="ln-800"></a>    <span class="c">!**   interface.                                                  |</span>
<a name="ln-801"></a>    <span class="c">!     ----------                                                  |</span>
<a name="ln-802"></a>    <span class="c">!                                                                 |</span>
<a name="ln-803"></a>    <span class="c">!             *lstend* is called from *program*.                  |</span>
<a name="ln-804"></a>    <span class="c">!                                                                 |</span>
<a name="ln-805"></a>    <span class="c">!-----------------------------------------------------------------|</span>
<a name="ln-806"></a>
<a name="ln-807"></a>    <span class="k">use </span><span class="n">modglobal</span><span class="p">,</span> <span class="n">only</span> <span class="p">:</span> <span class="n">ib</span><span class="p">,</span><span class="n">ie</span><span class="p">,</span><span class="n">jb</span><span class="p">,</span><span class="n">je</span><span class="p">,</span><span class="n">kb</span><span class="p">,</span><span class="n">ke</span><span class="p">,</span><span class="n">kh</span><span class="p">,</span><span class="n">dzh</span><span class="p">,</span><span class="n">nsv</span><span class="p">,</span><span class="n">lmomsubs</span>
<a name="ln-808"></a>    <span class="k">use </span><span class="n">modfields</span><span class="p">,</span> <span class="n">only</span> <span class="p">:</span> <span class="n">up</span><span class="p">,</span><span class="n">vp</span><span class="p">,</span><span class="n">thlp</span><span class="p">,</span><span class="n">qtp</span><span class="p">,</span><span class="n">svp</span><span class="p">,&amp;</span>
<a name="ln-809"></a>                          <span class="n">whls</span><span class="p">,</span> <span class="n">u0av</span><span class="p">,</span><span class="n">v0av</span><span class="p">,</span><span class="n">thl0av</span><span class="p">,</span><span class="n">qt0av</span><span class="p">,</span><span class="n">sv0av</span><span class="p">,&amp;</span>
<a name="ln-810"></a>                          <span class="n">dudxls</span><span class="p">,</span><span class="n">dudyls</span><span class="p">,</span><span class="n">dvdxls</span><span class="p">,</span><span class="n">dvdyls</span><span class="p">,</span><span class="n">dthldxls</span><span class="p">,</span><span class="n">dthldyls</span><span class="p">,</span><span class="n">dqtdxls</span><span class="p">,</span><span class="n">dqtdyls</span><span class="p">,</span><span class="n">dqtdtls</span>
<a name="ln-811"></a>    <span class="k">use </span><span class="n">modmpi</span><span class="p">,</span> <span class="n">only</span><span class="p">:</span> <span class="n">myid</span>
<a name="ln-812"></a>    <span class="k">implicit none</span>
<a name="ln-813"></a>
<a name="ln-814"></a><span class="k">    </span><span class="kt">integer </span><span class="n">k</span><span class="p">,</span><span class="n">n</span>
<a name="ln-815"></a>    <span class="kt">real </span><span class="n">subs_thl</span><span class="p">,</span><span class="n">subs_qt</span><span class="p">,</span><span class="n">subs_u</span><span class="p">,</span><span class="n">subs_v</span><span class="p">,</span><span class="n">subs_sv</span>
<a name="ln-816"></a>
<a name="ln-817"></a>    <span class="c">! if (ltimedep) then</span>
<a name="ln-818"></a>    <span class="c">!   ! call ls</span>
<a name="ln-819"></a>    <span class="c">! end if</span>
<a name="ln-820"></a>    <span class="c">! if (myid==0) then</span>
<a name="ln-821"></a>    <span class="c">!   write(*,*) &quot;up before lstend&quot;,up(3,3,ke)</span>
<a name="ln-822"></a>    <span class="c">! end if</span>
<a name="ln-823"></a>
<a name="ln-824"></a>
<a name="ln-825"></a>    <span class="c">! 1. DETERMINE LARGE SCALE TENDENCIES</span>
<a name="ln-826"></a>    <span class="c">!    --------------------------------</span>
<a name="ln-827"></a>
<a name="ln-828"></a>    <span class="c">! 1.1 lowest model level above surface : only downward component</span>
<a name="ln-829"></a>
<a name="ln-830"></a>    <span class="n">subs_u</span>   <span class="o">=</span> <span class="mf">0.</span>
<a name="ln-831"></a>    <span class="n">subs_v</span>   <span class="o">=</span> <span class="mf">0.</span>
<a name="ln-832"></a>    <span class="n">subs_thl</span> <span class="o">=</span> <span class="mf">0.</span>
<a name="ln-833"></a>    <span class="n">subs_qt</span>  <span class="o">=</span> <span class="mf">0.</span>
<a name="ln-834"></a>    <span class="n">subs_sv</span>  <span class="o">=</span> <span class="mf">0.</span>
<a name="ln-835"></a>
<a name="ln-836"></a>    <span class="n">k</span> <span class="o">=</span> <span class="n">kb</span>
<a name="ln-837"></a>    <span class="k">if</span> <span class="p">(</span><span class="n">whls</span><span class="p">(</span><span class="n">k</span><span class="o">+</span><span class="mi">1</span><span class="p">).</span><span class="n">lt</span><span class="p">.</span><span class="mi">0</span><span class="p">)</span> <span class="k">then</span> <span class="c">!neglect effect of mean ascending on tendencies at the lowest full level</span>
<a name="ln-838"></a>      <span class="n">subs_thl</span>     <span class="o">=</span> <span class="n">whls</span><span class="p">(</span><span class="n">k</span><span class="o">+</span><span class="mi">1</span><span class="p">)</span>  <span class="o">*</span><span class="p">(</span><span class="n">thl0av</span><span class="p">(</span><span class="n">k</span><span class="o">+</span><span class="mi">1</span><span class="p">)</span><span class="o">-</span><span class="n">thl0av</span><span class="p">(</span><span class="n">k</span><span class="p">))</span><span class="o">/</span><span class="n">dzh</span><span class="p">(</span><span class="n">k</span><span class="o">+</span><span class="mi">1</span><span class="p">)</span> <span class="c">! tg3315 ils13 bss116 31/07/18 Dales 4.0 multiplies these by 0.5. To reduce subsidence towards the ground? Have removed</span>
<a name="ln-839"></a>      <span class="n">subs_qt</span>      <span class="o">=</span> <span class="n">whls</span><span class="p">(</span><span class="n">k</span><span class="o">+</span><span class="mi">1</span><span class="p">)</span>  <span class="o">*</span><span class="p">(</span><span class="n">qt0av</span> <span class="p">(</span><span class="n">k</span><span class="o">+</span><span class="mi">1</span><span class="p">)</span><span class="o">-</span><span class="n">qt0av</span><span class="p">(</span><span class="n">k</span><span class="p">)</span> <span class="p">)</span><span class="o">/</span><span class="n">dzh</span><span class="p">(</span><span class="n">k</span><span class="o">+</span><span class="mi">1</span><span class="p">)</span>
<a name="ln-840"></a>      <span class="k">if</span><span class="p">(</span><span class="n">lmomsubs</span><span class="p">)</span> <span class="k">then</span>
<a name="ln-841"></a><span class="k">        </span><span class="n">subs_u</span>  <span class="o">=</span> <span class="n">whls</span><span class="p">(</span><span class="n">k</span><span class="o">+</span><span class="mi">1</span><span class="p">)</span>  <span class="o">*</span><span class="p">(</span><span class="n">u0av</span>  <span class="p">(</span><span class="n">k</span><span class="o">+</span><span class="mi">1</span><span class="p">)</span><span class="o">-</span><span class="n">u0av</span><span class="p">(</span><span class="n">k</span><span class="p">)</span>  <span class="p">)</span><span class="o">/</span><span class="n">dzh</span><span class="p">(</span><span class="n">k</span><span class="o">+</span><span class="mi">1</span><span class="p">)</span>
<a name="ln-842"></a>        <span class="n">subs_v</span>  <span class="o">=</span> <span class="n">whls</span><span class="p">(</span><span class="n">k</span><span class="o">+</span><span class="mi">1</span><span class="p">)</span>  <span class="o">*</span><span class="p">(</span><span class="n">v0av</span>  <span class="p">(</span><span class="n">k</span><span class="o">+</span><span class="mi">1</span><span class="p">)</span><span class="o">-</span><span class="n">v0av</span><span class="p">(</span><span class="n">k</span><span class="p">)</span>  <span class="p">)</span><span class="o">/</span><span class="n">dzh</span><span class="p">(</span><span class="n">k</span><span class="o">+</span><span class="mi">1</span><span class="p">)</span>
<a name="ln-843"></a>      <span class="n">endif</span>
<a name="ln-844"></a>      <span class="k">do </span><span class="n">n</span><span class="o">=</span><span class="mi">1</span><span class="p">,</span><span class="n">nsv</span>
<a name="ln-845"></a>        <span class="n">subs_sv</span> <span class="o">=</span>  <span class="n">whls</span><span class="p">(</span><span class="n">k</span><span class="o">+</span><span class="mi">1</span><span class="p">)</span>  <span class="o">*</span><span class="p">(</span><span class="n">sv0av</span><span class="p">(</span><span class="n">k</span><span class="o">+</span><span class="mi">1</span><span class="p">,</span><span class="n">n</span><span class="p">)</span><span class="o">-</span><span class="n">sv0av</span><span class="p">(</span><span class="n">k</span><span class="p">,</span><span class="n">n</span><span class="p">)</span>  <span class="p">)</span><span class="o">/</span><span class="n">dzh</span><span class="p">(</span><span class="n">k</span><span class="o">+</span><span class="mi">1</span><span class="p">)</span>
<a name="ln-846"></a>        <span class="c">! svp(2:i1,2:j1,1,n) = svp(2:i1,2:j1,1,n)-subs_sv</span>
<a name="ln-847"></a>        <span class="n">svp</span><span class="p">(</span><span class="n">ib</span><span class="p">:</span><span class="n">ie</span><span class="p">,</span><span class="n">jb</span><span class="p">:</span><span class="n">je</span><span class="p">,</span><span class="n">kb</span><span class="p">,</span><span class="n">n</span><span class="p">)</span> <span class="o">=</span> <span class="n">svp</span><span class="p">(</span><span class="n">ib</span><span class="p">:</span><span class="n">ie</span><span class="p">,</span><span class="n">jb</span><span class="p">:</span><span class="n">je</span><span class="p">,</span><span class="n">kb</span><span class="p">,</span><span class="n">n</span><span class="p">)</span><span class="o">-</span><span class="n">subs_sv</span>
<a name="ln-848"></a>      <span class="n">enddo</span>
<a name="ln-849"></a>    <span class="n">endif</span>
<a name="ln-850"></a>
<a name="ln-851"></a>    <span class="n">thlp</span><span class="p">(</span><span class="n">ib</span><span class="p">:</span><span class="n">ie</span><span class="p">,</span><span class="n">jb</span><span class="p">:</span><span class="n">je</span><span class="p">,</span><span class="n">k</span><span class="p">)</span> <span class="o">=</span> <span class="n">thlp</span><span class="p">(</span><span class="n">ib</span><span class="p">:</span><span class="n">ie</span><span class="p">,</span><span class="n">jb</span><span class="p">:</span><span class="n">je</span><span class="p">,</span><span class="n">k</span><span class="p">)</span> <span class="o">-</span><span class="n">u0av</span><span class="p">(</span><span class="n">k</span><span class="p">)</span><span class="o">*</span><span class="n">dthldxls</span><span class="p">(</span><span class="n">k</span><span class="p">)</span><span class="o">-</span><span class="n">v0av</span><span class="p">(</span><span class="n">k</span><span class="p">)</span><span class="o">*</span><span class="n">dthldyls</span><span class="p">(</span><span class="n">k</span><span class="p">)</span><span class="o">-</span><span class="n">subs_thl</span>
<a name="ln-852"></a>    <span class="n">qtp</span><span class="p">(</span><span class="n">ib</span><span class="p">:</span><span class="n">ie</span><span class="p">,</span><span class="n">jb</span><span class="p">:</span><span class="n">je</span><span class="p">,</span><span class="n">k</span><span class="p">)</span>  <span class="o">=</span> <span class="n">qtp</span> <span class="p">(</span><span class="n">ib</span><span class="p">:</span><span class="n">ie</span><span class="p">,</span><span class="n">jb</span><span class="p">:</span><span class="n">je</span><span class="p">,</span><span class="n">k</span><span class="p">)</span> <span class="o">-</span><span class="n">u0av</span><span class="p">(</span><span class="n">k</span><span class="p">)</span><span class="o">*</span><span class="n">dqtdxls</span> <span class="p">(</span><span class="n">k</span><span class="p">)</span><span class="o">-</span><span class="n">v0av</span><span class="p">(</span><span class="n">k</span><span class="p">)</span><span class="o">*</span><span class="n">dqtdyls</span> <span class="p">(</span><span class="n">k</span><span class="p">)</span><span class="o">-</span><span class="n">subs_qt</span> <span class="o">+</span><span class="n">dqtdtls</span><span class="p">(</span><span class="n">k</span><span class="p">)</span>
<a name="ln-853"></a>    <span class="n">up</span><span class="p">(</span><span class="n">ib</span><span class="p">:</span><span class="n">ie</span><span class="p">,</span><span class="n">jb</span><span class="p">:</span><span class="n">je</span><span class="p">,</span><span class="n">k</span><span class="p">)</span>   <span class="o">=</span> <span class="n">up</span>  <span class="p">(</span><span class="n">ib</span><span class="p">:</span><span class="n">ie</span><span class="p">,</span><span class="n">jb</span><span class="p">:</span><span class="n">je</span><span class="p">,</span><span class="n">k</span><span class="p">)</span> <span class="o">-</span><span class="n">u0av</span><span class="p">(</span><span class="n">k</span><span class="p">)</span><span class="o">*</span><span class="n">dudxls</span><span class="p">(</span><span class="n">k</span><span class="p">)</span>  <span class="o">-</span><span class="n">v0av</span><span class="p">(</span><span class="n">k</span><span class="p">)</span><span class="o">*</span><span class="n">dudyls</span>  <span class="p">(</span><span class="n">k</span><span class="p">)</span><span class="o">-</span><span class="n">subs_u</span>
<a name="ln-854"></a>    <span class="n">vp</span><span class="p">(</span><span class="n">ib</span><span class="p">:</span><span class="n">ie</span><span class="p">,</span><span class="n">jb</span><span class="p">:</span><span class="n">je</span><span class="p">,</span><span class="n">k</span><span class="p">)</span>   <span class="o">=</span> <span class="n">vp</span>  <span class="p">(</span><span class="n">ib</span><span class="p">:</span><span class="n">ie</span><span class="p">,</span><span class="n">jb</span><span class="p">:</span><span class="n">je</span><span class="p">,</span><span class="n">k</span><span class="p">)</span> <span class="o">-</span><span class="n">u0av</span><span class="p">(</span><span class="n">k</span><span class="p">)</span><span class="o">*</span><span class="n">dvdxls</span><span class="p">(</span><span class="n">k</span><span class="p">)</span>  <span class="o">-</span><span class="n">v0av</span><span class="p">(</span><span class="n">k</span><span class="p">)</span><span class="o">*</span><span class="n">dvdyls</span>  <span class="p">(</span><span class="n">k</span><span class="p">)</span><span class="o">-</span><span class="n">subs_v</span>
<a name="ln-855"></a>
<a name="ln-856"></a>
<a name="ln-857"></a>    <span class="c">! 1.2 other model levels twostream</span>
<a name="ln-858"></a>    <span class="k">do </span><span class="n">k</span><span class="o">=</span><span class="n">kb</span><span class="o">+</span><span class="mi">1</span><span class="p">,</span><span class="n">ke</span>
<a name="ln-859"></a>
<a name="ln-860"></a>      <span class="k">if</span> <span class="p">(</span><span class="n">whls</span><span class="p">(</span><span class="n">k</span><span class="o">+</span><span class="mi">1</span><span class="p">).</span><span class="n">lt</span><span class="p">.</span><span class="mi">0</span><span class="p">)</span> <span class="k">then</span>   <span class="c">!downwind scheme for subsidence</span>
<a name="ln-861"></a>        <span class="n">subs_thl</span>    <span class="o">=</span> <span class="n">whls</span><span class="p">(</span><span class="n">k</span><span class="o">+</span><span class="mi">1</span><span class="p">)</span> <span class="o">*</span> <span class="p">(</span><span class="n">thl0av</span><span class="p">(</span><span class="n">k</span><span class="o">+</span><span class="mi">1</span><span class="p">)</span> <span class="o">-</span> <span class="n">thl0av</span><span class="p">(</span><span class="n">k</span><span class="p">))</span><span class="o">/</span><span class="n">dzh</span><span class="p">(</span><span class="n">k</span><span class="o">+</span><span class="mi">1</span><span class="p">)</span>
<a name="ln-862"></a>        <span class="n">subs_qt</span>     <span class="o">=</span> <span class="n">whls</span><span class="p">(</span><span class="n">k</span><span class="o">+</span><span class="mi">1</span><span class="p">)</span> <span class="o">*</span> <span class="p">(</span><span class="n">qt0av</span> <span class="p">(</span><span class="n">k</span><span class="o">+</span><span class="mi">1</span><span class="p">)</span> <span class="o">-</span> <span class="n">qt0av</span> <span class="p">(</span><span class="n">k</span><span class="p">))</span><span class="o">/</span><span class="n">dzh</span><span class="p">(</span><span class="n">k</span><span class="o">+</span><span class="mi">1</span><span class="p">)</span>
<a name="ln-863"></a>        <span class="k">do </span><span class="n">n</span><span class="o">=</span><span class="mi">1</span><span class="p">,</span><span class="n">nsv</span>
<a name="ln-864"></a>          <span class="n">subs_sv</span>   <span class="o">=</span> <span class="n">whls</span><span class="p">(</span><span class="n">k</span><span class="o">+</span><span class="mi">1</span><span class="p">)</span>  <span class="o">*</span><span class="p">(</span><span class="n">sv0av</span><span class="p">(</span><span class="n">k</span><span class="o">+</span><span class="mi">1</span><span class="p">,</span><span class="n">n</span><span class="p">)</span> <span class="o">-</span> <span class="n">sv0av</span><span class="p">(</span><span class="n">k</span><span class="p">,</span><span class="n">n</span><span class="p">))</span><span class="o">/</span><span class="n">dzh</span><span class="p">(</span><span class="n">k</span><span class="o">+</span><span class="mi">1</span><span class="p">)</span>
<a name="ln-865"></a>          <span class="n">svp</span><span class="p">(</span><span class="n">ib</span><span class="p">:</span><span class="n">ie</span><span class="p">,</span><span class="n">jb</span><span class="p">:</span><span class="n">je</span><span class="p">,</span><span class="n">k</span><span class="p">,</span><span class="n">n</span><span class="p">)</span> <span class="o">=</span> <span class="n">svp</span><span class="p">(</span><span class="n">ib</span><span class="p">:</span><span class="n">ie</span><span class="p">,</span><span class="n">jb</span><span class="p">:</span><span class="n">je</span><span class="p">,</span><span class="n">k</span><span class="p">,</span><span class="n">n</span><span class="p">)</span><span class="o">-</span><span class="n">subs_sv</span>
<a name="ln-866"></a>        <span class="n">enddo</span>
<a name="ln-867"></a>        <span class="k">if</span><span class="p">(</span><span class="n">lmomsubs</span><span class="p">)</span> <span class="k">then</span>
<a name="ln-868"></a><span class="k">          </span><span class="n">subs_u</span>   <span class="o">=</span> <span class="n">whls</span><span class="p">(</span><span class="n">k</span><span class="o">+</span><span class="mi">1</span><span class="p">)</span> <span class="o">*</span> <span class="p">(</span><span class="n">u0av</span>  <span class="p">(</span><span class="n">k</span><span class="o">+</span><span class="mi">1</span><span class="p">)</span> <span class="o">-</span> <span class="n">u0av</span>  <span class="p">(</span><span class="n">k</span><span class="p">))</span><span class="o">/</span><span class="n">dzh</span><span class="p">(</span><span class="n">k</span><span class="o">+</span><span class="mi">1</span><span class="p">)</span>
<a name="ln-869"></a>          <span class="n">subs_v</span>   <span class="o">=</span> <span class="n">whls</span><span class="p">(</span><span class="n">k</span><span class="o">+</span><span class="mi">1</span><span class="p">)</span> <span class="o">*</span> <span class="p">(</span><span class="n">v0av</span>  <span class="p">(</span><span class="n">k</span><span class="o">+</span><span class="mi">1</span><span class="p">)</span> <span class="o">-</span> <span class="n">v0av</span>  <span class="p">(</span><span class="n">k</span><span class="p">))</span><span class="o">/</span><span class="n">dzh</span><span class="p">(</span><span class="n">k</span><span class="o">+</span><span class="mi">1</span><span class="p">)</span>
<a name="ln-870"></a>        <span class="n">endif</span>
<a name="ln-871"></a>      <span class="k">else</span> <span class="c">!downwind scheme for mean upward motions</span>
<a name="ln-872"></a>        <span class="n">subs_thl</span>    <span class="o">=</span> <span class="n">whls</span><span class="p">(</span><span class="n">k</span><span class="p">)</span> <span class="o">*</span> <span class="p">(</span><span class="n">thl0av</span><span class="p">(</span><span class="n">k</span><span class="p">)</span> <span class="o">-</span> <span class="n">thl0av</span><span class="p">(</span><span class="n">k</span><span class="o">-</span><span class="mi">1</span><span class="p">))</span><span class="o">/</span><span class="n">dzh</span><span class="p">(</span><span class="n">k</span><span class="p">)</span>
<a name="ln-873"></a>        <span class="n">subs_qt</span>     <span class="o">=</span> <span class="n">whls</span><span class="p">(</span><span class="n">k</span><span class="p">)</span> <span class="o">*</span> <span class="p">(</span><span class="n">qt0av</span> <span class="p">(</span><span class="n">k</span><span class="p">)</span> <span class="o">-</span> <span class="n">qt0av</span> <span class="p">(</span><span class="n">k</span><span class="o">-</span><span class="mi">1</span><span class="p">))</span><span class="o">/</span><span class="n">dzh</span><span class="p">(</span><span class="n">k</span><span class="p">)</span>
<a name="ln-874"></a>        <span class="k">do </span><span class="n">n</span><span class="o">=</span><span class="mi">1</span><span class="p">,</span><span class="n">nsv</span>
<a name="ln-875"></a>          <span class="n">subs_sv</span>   <span class="o">=</span> <span class="n">whls</span><span class="p">(</span><span class="n">k</span><span class="p">)</span> <span class="o">*</span> <span class="p">(</span><span class="n">sv0av</span><span class="p">(</span><span class="n">k</span><span class="p">,</span><span class="n">n</span><span class="p">)</span> <span class="o">-</span> <span class="n">sv0av</span><span class="p">(</span><span class="n">k</span><span class="o">-</span><span class="mi">1</span><span class="p">,</span><span class="n">n</span><span class="p">))</span><span class="o">/</span><span class="n">dzh</span><span class="p">(</span><span class="n">k</span><span class="p">)</span>
<a name="ln-876"></a>          <span class="n">svp</span><span class="p">(</span><span class="n">ib</span><span class="p">:</span><span class="n">ie</span><span class="p">,</span><span class="n">jb</span><span class="p">:</span><span class="n">je</span><span class="p">,</span><span class="n">k</span><span class="p">,</span><span class="n">n</span><span class="p">)</span> <span class="o">=</span> <span class="n">svp</span><span class="p">(</span><span class="n">ib</span><span class="p">:</span><span class="n">ie</span><span class="p">,</span><span class="n">jb</span><span class="p">:</span><span class="n">je</span><span class="p">,</span><span class="n">k</span><span class="p">,</span><span class="n">n</span><span class="p">)</span><span class="o">-</span><span class="n">subs_sv</span>
<a name="ln-877"></a>        <span class="n">enddo</span>
<a name="ln-878"></a>        <span class="k">if</span><span class="p">(</span><span class="n">lmomsubs</span><span class="p">)</span> <span class="k">then</span>
<a name="ln-879"></a><span class="k">          </span><span class="n">subs_u</span>   <span class="o">=</span> <span class="n">whls</span><span class="p">(</span><span class="n">k</span><span class="p">)</span> <span class="o">*</span> <span class="p">(</span><span class="n">u0av</span>  <span class="p">(</span><span class="n">k</span><span class="p">)</span> <span class="o">-</span> <span class="n">u0av</span>  <span class="p">(</span><span class="n">k</span><span class="o">-</span><span class="mi">1</span><span class="p">))</span><span class="o">/</span><span class="n">dzh</span><span class="p">(</span><span class="n">k</span><span class="p">)</span>
<a name="ln-880"></a>          <span class="n">subs_v</span>   <span class="o">=</span> <span class="n">whls</span><span class="p">(</span><span class="n">k</span><span class="p">)</span> <span class="o">*</span> <span class="p">(</span><span class="n">v0av</span>  <span class="p">(</span><span class="n">k</span><span class="p">)</span> <span class="o">-</span> <span class="n">v0av</span>  <span class="p">(</span><span class="n">k</span><span class="o">-</span><span class="mi">1</span><span class="p">))</span><span class="o">/</span><span class="n">dzh</span><span class="p">(</span><span class="n">k</span><span class="p">)</span>
<a name="ln-881"></a>        <span class="n">endif</span>
<a name="ln-882"></a>      <span class="n">endif</span>
<a name="ln-883"></a>
<a name="ln-884"></a>      <span class="n">thlp</span><span class="p">(</span><span class="n">ib</span><span class="p">:</span><span class="n">ie</span><span class="p">,</span><span class="n">jb</span><span class="p">:</span><span class="n">je</span><span class="p">,</span><span class="n">k</span><span class="p">)</span> <span class="o">=</span> <span class="n">thlp</span><span class="p">(</span><span class="n">ib</span><span class="p">:</span><span class="n">ie</span><span class="p">,</span><span class="n">jb</span><span class="p">:</span><span class="n">je</span><span class="p">,</span><span class="n">k</span><span class="p">)</span><span class="o">-</span><span class="n">u0av</span><span class="p">(</span><span class="n">k</span><span class="p">)</span><span class="o">*</span><span class="n">dthldxls</span><span class="p">(</span><span class="n">k</span><span class="p">)</span><span class="o">-</span><span class="n">v0av</span><span class="p">(</span><span class="n">k</span><span class="p">)</span><span class="o">*</span><span class="n">dthldyls</span><span class="p">(</span><span class="n">k</span><span class="p">)</span><span class="o">-</span><span class="n">subs_thl</span>
<a name="ln-885"></a>      <span class="n">qtp</span> <span class="p">(</span><span class="n">ib</span><span class="p">:</span><span class="n">ie</span><span class="p">,</span><span class="n">jb</span><span class="p">:</span><span class="n">je</span><span class="p">,</span><span class="n">k</span><span class="p">)</span> <span class="o">=</span> <span class="n">qtp</span> <span class="p">(</span><span class="n">ib</span><span class="p">:</span><span class="n">ie</span><span class="p">,</span><span class="n">jb</span><span class="p">:</span><span class="n">je</span><span class="p">,</span><span class="n">k</span><span class="p">)</span><span class="o">-</span><span class="n">u0av</span><span class="p">(</span><span class="n">k</span><span class="p">)</span><span class="o">*</span><span class="n">dqtdxls</span> <span class="p">(</span><span class="n">k</span><span class="p">)</span><span class="o">-</span><span class="n">v0av</span><span class="p">(</span><span class="n">k</span><span class="p">)</span><span class="o">*</span><span class="n">dqtdyls</span> <span class="p">(</span><span class="n">k</span><span class="p">)</span><span class="o">-</span><span class="n">subs_qt</span><span class="o">+</span><span class="n">dqtdtls</span><span class="p">(</span><span class="n">k</span><span class="p">)</span>
<a name="ln-886"></a>      <span class="n">up</span>  <span class="p">(</span><span class="n">ib</span><span class="p">:</span><span class="n">ie</span><span class="p">,</span><span class="n">jb</span><span class="p">:</span><span class="n">je</span><span class="p">,</span><span class="n">k</span><span class="p">)</span> <span class="o">=</span> <span class="n">up</span>  <span class="p">(</span><span class="n">ib</span><span class="p">:</span><span class="n">ie</span><span class="p">,</span><span class="n">jb</span><span class="p">:</span><span class="n">je</span><span class="p">,</span><span class="n">k</span><span class="p">)</span><span class="o">-</span><span class="n">u0av</span><span class="p">(</span><span class="n">k</span><span class="p">)</span><span class="o">*</span><span class="n">dudxls</span>  <span class="p">(</span><span class="n">k</span><span class="p">)</span><span class="o">-</span><span class="n">v0av</span><span class="p">(</span><span class="n">k</span><span class="p">)</span><span class="o">*</span><span class="n">dudyls</span>  <span class="p">(</span><span class="n">k</span><span class="p">)</span><span class="o">-</span><span class="n">subs_u</span>
<a name="ln-887"></a>      <span class="n">vp</span>  <span class="p">(</span><span class="n">ib</span><span class="p">:</span><span class="n">ie</span><span class="p">,</span><span class="n">jb</span><span class="p">:</span><span class="n">je</span><span class="p">,</span><span class="n">k</span><span class="p">)</span> <span class="o">=</span> <span class="n">vp</span>  <span class="p">(</span><span class="n">ib</span><span class="p">:</span><span class="n">ie</span><span class="p">,</span><span class="n">jb</span><span class="p">:</span><span class="n">je</span><span class="p">,</span><span class="n">k</span><span class="p">)</span><span class="o">-</span><span class="n">u0av</span><span class="p">(</span><span class="n">k</span><span class="p">)</span><span class="o">*</span><span class="n">dvdxls</span>  <span class="p">(</span><span class="n">k</span><span class="p">)</span><span class="o">-</span><span class="n">v0av</span><span class="p">(</span><span class="n">k</span><span class="p">)</span><span class="o">*</span><span class="n">dvdyls</span>  <span class="p">(</span><span class="n">k</span><span class="p">)</span><span class="o">-</span><span class="n">subs_v</span>
<a name="ln-888"></a>
<a name="ln-889"></a>    <span class="n">enddo</span>
<a name="ln-890"></a>
<a name="ln-891"></a>    <span class="k">return</span>
<a name="ln-892"></a><span class="k">  end subroutine </span><span class="n">lstend</span>
<a name="ln-893"></a>
<a name="ln-894"></a>  <span class="k">subroutine </span><span class="n">nudge</span>
<a name="ln-895"></a>    <span class="k">use </span><span class="n">modglobal</span><span class="p">,</span>  <span class="n">only</span> <span class="p">:</span> <span class="n">kb</span><span class="p">,</span><span class="n">ke</span><span class="p">,</span><span class="n">lmoist</span><span class="p">,</span><span class="n">ltempeq</span><span class="p">,</span><span class="n">lnudge</span><span class="p">,</span><span class="n">tnudge</span><span class="p">,</span><span class="n">nnudge</span><span class="p">,</span><span class="n">numol</span><span class="p">,</span><span class="n">nsv</span>
<a name="ln-896"></a>    <span class="k">use </span><span class="n">modfields</span><span class="p">,</span>  <span class="n">only</span> <span class="p">:</span> <span class="n">thlp</span><span class="p">,</span><span class="n">qtp</span><span class="p">,</span><span class="n">svp</span><span class="p">,</span><span class="n">sv0av</span><span class="p">,</span><span class="n">thl0av</span><span class="p">,</span><span class="n">qt0av</span>
<a name="ln-897"></a>    <span class="k">use </span><span class="n">modmpi</span><span class="p">,</span>     <span class="n">only</span> <span class="p">:</span> <span class="n">myid</span>
<a name="ln-898"></a>    <span class="k">implicit none</span>
<a name="ln-899"></a><span class="k">    </span><span class="kt">integer</span> <span class="kd">::</span> <span class="n">k</span>
<a name="ln-900"></a>    <span class="kt">real</span> <span class="kd">::</span> <span class="n">numoli</span>
<a name="ln-901"></a>
<a name="ln-902"></a>    <span class="n">numoli</span> <span class="o">=</span> <span class="mi">1</span><span class="o">/</span><span class="n">numol</span>
<a name="ln-903"></a>
<a name="ln-904"></a>    <span class="k">if</span> <span class="p">(</span><span class="n">lnudge</span> <span class="p">.</span><span class="n">eqv</span><span class="p">.</span> <span class="p">.</span><span class="n">false</span><span class="p">.)</span> <span class="k">return</span>
<a name="ln-905"></a>
<a name="ln-906"></a><span class="k">    if</span> <span class="p">(</span><span class="n">nsv</span><span class="o">&gt;</span><span class="mi">0</span><span class="p">)</span> <span class="k">then</span>
<a name="ln-907"></a><span class="k">      do </span><span class="n">k</span><span class="o">=</span><span class="n">ke</span><span class="o">-</span><span class="n">nnudge</span><span class="p">,</span><span class="n">ke</span>
<a name="ln-908"></a>        <span class="n">svp</span><span class="p">(:,:,</span><span class="n">k</span><span class="p">,</span><span class="mi">1</span><span class="p">)</span> <span class="o">=</span> <span class="n">svp</span><span class="p">(:,:,</span><span class="n">k</span><span class="p">,</span><span class="mi">1</span><span class="p">)</span> <span class="o">-</span> <span class="p">(</span> <span class="n">sv0av</span><span class="p">(</span><span class="n">k</span><span class="p">,</span><span class="mi">1</span><span class="p">)</span> <span class="o">-</span> <span class="mf">0.</span> <span class="p">)</span> <span class="o">/</span> <span class="p">(</span><span class="n">tnudge</span><span class="o">/</span><span class="mi">2</span> <span class="o">+</span> <span class="p">(</span><span class="n">ke</span><span class="o">-</span><span class="n">k</span><span class="p">)</span><span class="o">*</span><span class="n">tnudge</span><span class="o">/</span><span class="n">nnudge</span><span class="p">)</span>
<a name="ln-909"></a>      <span class="k">end do</span>
<a name="ln-910"></a><span class="k">    end if</span>
<a name="ln-911"></a>
<a name="ln-912"></a><span class="k">    if</span> <span class="p">(</span><span class="n">ltempeq</span><span class="p">)</span> <span class="k">then</span>
<a name="ln-913"></a><span class="k">      do </span><span class="n">k</span><span class="o">=</span><span class="n">ke</span><span class="o">-</span><span class="n">nnudge</span><span class="p">,</span><span class="n">ke</span>
<a name="ln-914"></a>        <span class="n">thlp</span><span class="p">(:,:,</span><span class="n">k</span><span class="p">)</span> <span class="o">=</span> <span class="n">thlp</span><span class="p">(:,:,</span><span class="n">k</span><span class="p">)</span> <span class="o">-</span> <span class="p">(</span> <span class="n">thl0av</span><span class="p">(</span><span class="n">k</span><span class="p">)</span> <span class="o">-</span> <span class="mi">288</span> <span class="p">)</span> <span class="o">/</span> <span class="p">(</span><span class="n">tnudge</span><span class="o">/</span><span class="mi">2</span> <span class="o">+</span> <span class="p">(</span><span class="n">ke</span><span class="o">-</span><span class="n">k</span><span class="p">)</span><span class="o">*</span><span class="n">tnudge</span><span class="o">/</span><span class="n">nnudge</span><span class="p">)</span>
<a name="ln-915"></a>      <span class="k">end do</span>
<a name="ln-916"></a><span class="k">    end if</span> <span class="c">!ltempeq</span>
<a name="ln-917"></a>
<a name="ln-918"></a>    <span class="k">if</span> <span class="p">(</span><span class="n">lmoist</span><span class="p">)</span> <span class="k">then</span>
<a name="ln-919"></a><span class="k">      do </span><span class="n">k</span><span class="o">=</span><span class="n">ke</span><span class="o">-</span><span class="n">nnudge</span><span class="p">,</span><span class="n">ke</span>
<a name="ln-920"></a>        <span class="n">qtp</span><span class="p">(:,:,</span><span class="n">k</span><span class="p">)</span> <span class="o">=</span> <span class="n">qtp</span><span class="p">(:,:,</span><span class="n">k</span><span class="p">)</span> <span class="o">-</span> <span class="p">(</span> <span class="n">qt0av</span><span class="p">(</span><span class="n">k</span><span class="p">)</span> <span class="o">-</span> <span class="mf">0.</span> <span class="p">)</span> <span class="o">/</span> <span class="p">(</span><span class="n">tnudge</span><span class="o">/</span><span class="mi">2</span> <span class="o">+</span><span class="p">(</span><span class="n">ke</span><span class="o">-</span><span class="n">k</span><span class="p">)</span><span class="o">*</span><span class="n">tnudge</span><span class="o">/</span><span class="n">nnudge</span><span class="p">)</span>
<a name="ln-921"></a>      <span class="k">end do</span>
<a name="ln-922"></a><span class="k">    end if</span> <span class="c">!lmoist</span>
<a name="ln-923"></a>
<a name="ln-924"></a>  <span class="k">end subroutine </span><span class="n">nudge</span>
<a name="ln-925"></a>
<a name="ln-926"></a><span class="k">end module </span><span class="n">modforces</span>
</pre></div>

    </section>
    </div>
  </div>

  
    <hr>    
    </div> <!-- /container -->
    <footer>
      <div class="container">
      <div class="row">
        <div class="col-xs-6 col-md-4"><p>&copy; 2021 
                                          </p></div>
        <div class="col-xs-6 col-md-4 col-md-push-4">
          <p class="text-right">
            Documentation generated by 
            <a href="https://github.com/cmacmackin/ford">FORD</a>
            
          </p>
        </div>
        <div class="col-xs-12 col-md-4 col-md-pull-4"><p class="text-center"> uDALES was developed by The uDALES Team</p></div>
      </div>
      <br>
      </div> <!-- /container -->    
    </footer>

    <!-- Bootstrap core JavaScript
    ================================================== -->
    <!-- Placed at the end of the document so the pages load faster -->
<!--
    <script src="https://ajax.googleapis.com/ajax/libs/jquery/1.11.1/jquery.min.js"></script>
-->
    <script src="../js/bootstrap.min.js"></script>
    <!-- IE10 viewport hack for Surface/desktop Windows 8 bug -->
    <script src="../js/ie10-viewport-bug-workaround.js"></script>

    <!-- MathJax JavaScript
    ================================================== -->
    <!-- Placed at the end of the document so the pages load faster -->
    <script type="text/x-mathjax-config">
      MathJax.Hub.Config({
        TeX: { extensions: ['AMSmath.js','AMSsymbols.js','noErrors.js','noUndefined.js'], equationNumbers: { autoNumber: 'AMS' } },
        jax: ['input/TeX','input/MathML','output/HTML-CSS'],
        extensions: ['tex2jax.js','mml2jax.js','MathMenu.js','MathZoom.js']
      });
    </script>
    
    <script src="https://cdnjs.cloudflare.com/ajax/libs/mathjax/2.7.1/MathJax.js?config=TeX-AMS-MML_HTMLorMML"></script>
    
    
    <script src="../tipuesearch/tipuesearch_content.js"></script>
    <script src="../tipuesearch/tipuesearch_set.js"></script>
    <script src="../tipuesearch/tipuesearch.js"></script>
    
    
  </body>
</html>