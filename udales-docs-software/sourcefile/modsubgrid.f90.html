<!DOCTYPE html>
<html lang="en">
  <head>
    <meta charset="utf-8">
    <meta http-equiv="X-UA-Compatible" content="IE=edge">
    <meta name="viewport" content="width=device-width, initial-scale=1">
   
    <meta name="description" content="Documentation for uDALES">
   
    <meta name="author" content="The uDALES Team" >
    <link rel="icon" href="../favicon.png">

    <title>modsubgrid.f90 &ndash; uDALES</title>

    <link href="../css/bootstrap.min.css" rel="stylesheet">
    <link href="../css/pygments.css" rel="stylesheet">
    <link href="../css/font-awesome.min.css" rel="stylesheet">
    <link href="../css/local.css" rel="stylesheet">
    
    <link  href="../tipuesearch/tipuesearch.css" rel="stylesheet">
    
    

    <!-- HTML5 shim and Respond.js for IE8 support of HTML5 elements and media queries -->
    <!--[if lt IE 9]>
      <script src="https://oss.maxcdn.com/html5shiv/3.7.2/html5shiv.min.js"></script>
      <script src="https://oss.maxcdn.com/respond/1.4.2/respond.min.js"></script>
    <![endif]-->
    
    <script src="../js/jquery-2.1.3.min.js"></script>
    <script src="../js/svg-pan-zoom.min.js"></script>

  </head>

  <body>

    <!-- Fixed navbar -->
    <nav class="navbar navbar-inverse navbar-fixed-top">
      <div class="container">
        <div class="navbar-header">
          <button type="button" class="navbar-toggle collapsed" data-toggle="collapse" data-target="#navbar" aria-expanded="false" aria-controls="navbar">
            <span class="sr-only">Toggle navigation</span>
            <span class="icon-bar"></span>
            <span class="icon-bar"></span>
            <span class="icon-bar"></span>
          </button>
          <a class="navbar-brand" href="../index.html">uDALES </a>
        </div>
        <div id="navbar" class="navbar-collapse collapse">
          <ul class="nav navbar-nav">
        
            <li class="dropdown hidden-xs visible-sm visible-md hidden-lg">
              <a href="#" class="dropdown-toggle"
              data-toggle="dropdown" role="button"
              aria-haspopup="true"
     aria-expanded="false">Contents <span class="caret"></span></a>
        <ul class="dropdown-menu">
          
              
            <li><a href="../lists/files.html">Source Files</a></li>
        
        
        
            <li><a href="../lists/modules.html">Modules</a></li>
        
            
                                
            <li><a href="../lists/procedures.html">Procedures</a></li>
        
               
            <li><a href="../lists/types.html">Derived Types</a></li>
        
        
            <li><a href="../program/dalesurban.html">Program</a></li>
      
            </ul>
            </li>


<li class="visible-xs hidden-sm visible-lg"><a href="../lists/files.html">Source Files</a></li>



<li class="visible-xs hidden-sm visible-lg"><a href="../lists/modules.html">Modules</a></li>



<li class="visible-xs hidden-sm visible-lg"><a href="../lists/procedures.html">Procedures</a></li>

                             
<li class="visible-xs hidden-sm visible-lg"><a href="../lists/types.html">Derived Types</a></li>


<li class="visible-xs hidden-sm visible-lg"><a href="../program/dalesurban.html">Program</a></li>

          </ul>
        
        <form action="../search.html" class="navbar-form navbar-right" role="search">
        <div class="form-group">
          <input type="text" class="form-control" placeholder="Search" name="q" id="tipue_search_input" autocomplete="off" required>
        </div>
<!--
        <button type="submit" class="btn btn-default">Submit</button>
-->
        </form>
        
        </div><!--/.nav-collapse -->
      </div>
    </nav>

    <div class="container">
    
  
  <div class="row">
    <h1>modsubgrid.f90
    <small>Source File</small>
    
    </h1>
    
<div class="row">
  <div class="col-lg-12">
<div class="well well-sm">
  <ul class="list-inline" style="margin-bottom:0px;display:inline">
     
     
     
     
    
    
     <li><i class="fa fa-list-ol"></i>
       <a data-toggle="tooltip"
    data-placement="bottom" data-html="true"
    title=" 3.5% of total for source files.">487 statements</a>
     </li> 
     
     
     
    <li><i class="fa fa-code"></i><a href="../src/modsubgrid.f90"> Source File</a></li>
     
     
  </ul>
  <ol class="breadcrumb in-well text-right">
  
    
  
     <li class="active">modsubgrid.f90</li>
  </ol>
</div>
</div>
</div>
<script>
  $(function () {
  $('[data-toggle="tooltip"]').tooltip()
  })
</script>

  </div>
  <div class="row">
    <div class="col-md-3 hidden-xs hidden-sm visible-md visible-lg">
    
<div id="sidebar">
  
<h3>Contents</h3>
 







<div class="panel panel-primary">
  <div class="panel-heading text-left"><h3 class="panel-title"><a data-toggle="collapse" href="#mods-0">Modules</a></h3></div>
  <div id="mods-0" class="panel-collapse collapse">
    <div class="list-group">
      
      <a class="list-group-item" href="../module/modsubgrid.html">modsubgrid</a>
      
    </div>
  </div>
</div>
















<div class="panel panel-primary">
  <div class="panel-heading text-left"><h3 class="panel-title">Source Code</h3></div>
  <div class="list-group">
    <a class="list-group-item" href="../sourcefile/modsubgrid.f90.html#src">modsubgrid.f90</a>
  </div>
</div>



</div>

    </div>
    <div class="col-md-9" id='text'>
      
      <br>
    
    <div class="panel panel-default">
      <div class="panel-heading">
  <h3 class="panel-title">This file depends on</h3>
      </div>
      <div class="panel-body">
  <div class="depgraph"><?xml version="1.0" encoding="UTF-8" standalone="no"?>
<!DOCTYPE svg PUBLIC "-//W3C//DTD SVG 1.1//EN"
 "http://www.w3.org/Graphics/SVG/1.1/DTD/svg11.dtd">
<!-- Generated by graphviz version 2.40.1 (20161225.0304)
 -->
<!-- Title: sourcefile~~modsubgrid.f90~~EfferentGraph Pages: 1 -->
<svg id="sourcefilemodsubgridf90EfferentGraph" width="641pt" height="443pt"
 viewBox="0.00 0.00 641.00 443.19" xmlns="http://www.w3.org/2000/svg" xmlns:xlink="http://www.w3.org/1999/xlink">
<g id="sourcefile~~modsubgrid.f90~~EfferentGraph" class="graph" transform="scale(.7836 .7836) rotate(0) translate(4 561.5636)">
<title>sourcefile~~modsubgrid.f90~~EfferentGraph</title>
<polygon fill="#ffffff" stroke="transparent" points="-4,4 -4,-561.5636 814,-561.5636 814,4 -4,4"/>
<!-- sourcefile~modsubgrid.f90 -->
<g id="sourcefile~~modsubgrid.f90~~EfferentGraph_node1" class="node">
<title>sourcefile~modsubgrid.f90</title>
<polygon fill="none" stroke="#000000" points="810,-206.9268 723,-206.9268 723,-182.9268 810,-182.9268 810,-206.9268"/>
<text text-anchor="middle" x="766.5" y="-192.5268" font-family="Helvetica,sans-Serif" font-size="10.50" fill="#000000">modsubgrid.f90</text>
</g>
<!-- sourcefile~modsubgriddata.f90 -->
<g id="sourcefile~~modsubgrid.f90~~EfferentGraph_node2" class="node">
<title>sourcefile~modsubgriddata.f90</title>
<g id="a_sourcefile~~modsubgrid.f90~~EfferentGraph_node2"><a xlink:href=".././sourcefile/modsubgriddata.f90.html" xlink:title="modsubgriddata.f90">
<polygon fill="#f0ad4e" stroke="#f0ad4e" points="329,-90.9268 221,-90.9268 221,-66.9268 329,-66.9268 329,-90.9268"/>
<text text-anchor="middle" x="275" y="-76.5268" font-family="Helvetica,sans-Serif" font-size="10.50" fill="#ffffff">modsubgriddata.f90</text>
</a>
</g>
</g>
<!-- sourcefile~modsubgrid.f90&#45;&gt;sourcefile~modsubgriddata.f90 -->
<g id="sourcefile~~modsubgrid.f90~~EfferentGraph_edge1" class="edge">
<title>sourcefile~modsubgrid.f90&#45;&gt;sourcefile~modsubgriddata.f90</title>
<path fill="none" stroke="#ff0000" stroke-dasharray="5,2" d="M514.5,-40.9268C463.7066,-26.5995 454.5908,-83.3366 402,-78.9268"/>
<path fill="none" stroke="#ff0000" stroke-dasharray="5,2" d="M402,-78.9268C381.6064,-77.2168 359.3059,-76.7468 339.1622,-76.8424"/>
<polygon fill="#ff0000" stroke="#ff0000" points="339.1234,-73.3425 329.1566,-76.936 339.189,-80.3422 339.1234,-73.3425"/>
</g>
<!-- sourcefile~modsurfdata.f90 -->
<g id="sourcefile~~modsubgrid.f90~~EfferentGraph_node3" class="node">
<title>sourcefile~modsurfdata.f90</title>
<g id="a_sourcefile~~modsubgrid.f90~~EfferentGraph_node3"><a xlink:href=".././sourcefile/modsurfdata.f90.html" xlink:title="modsurfdata.f90">
<polygon fill="#f0ad4e" stroke="#f0ad4e" points="320.5,-528.9268 229.5,-528.9268 229.5,-504.9268 320.5,-504.9268 320.5,-528.9268"/>
<text text-anchor="middle" x="275" y="-514.5268" font-family="Helvetica,sans-Serif" font-size="10.50" fill="#ffffff">modsurfdata.f90</text>
</a>
</g>
</g>
<!-- sourcefile~modsubgrid.f90&#45;&gt;sourcefile~modsurfdata.f90 -->
<g id="sourcefile~~modsubgrid.f90~~EfferentGraph_edge2" class="edge">
<title>sourcefile~modsubgrid.f90&#45;&gt;sourcefile~modsurfdata.f90</title>
<path fill="none" stroke="#ff0000" stroke-dasharray="5,2" d="M514.5,-552.9268C465.249,-561.5487 451.9259,-555.6482 402,-552.9268"/>
</g>
<!-- sourcefile~modinletdata.f90 -->
<g id="sourcefile~~modsubgrid.f90~~EfferentGraph_node4" class="node">
<title>sourcefile~modinletdata.f90</title>
<g id="a_sourcefile~~modsubgrid.f90~~EfferentGraph_node4"><a xlink:href=".././sourcefile/modinletdata.f90.html" xlink:title="modinletdata.f90">
<polygon fill="#f0ad4e" stroke="#f0ad4e" points="321,-448.9268 229,-448.9268 229,-424.9268 321,-424.9268 321,-448.9268"/>
<text text-anchor="middle" x="275" y="-434.5268" font-family="Helvetica,sans-Serif" font-size="10.50" fill="#ffffff">modinletdata.f90</text>
</a>
</g>
</g>
<!-- sourcefile~modsubgrid.f90&#45;&gt;sourcefile~modinletdata.f90 -->
<g id="sourcefile~~modsubgrid.f90~~EfferentGraph_edge3" class="edge">
<title>sourcefile~modsubgrid.f90&#45;&gt;sourcefile~modinletdata.f90</title>
<path fill="none" stroke="#ff0000" stroke-dasharray="5,2" d="M764.3923,-206.935C752.4499,-270.8275 687.5681,-567.4387 514.5,-552.9268"/>
<path fill="none" stroke="#ff0000" stroke-dasharray="5,2" d="M514.5,-552.9268C462.5152,-562.0273 451.41,-533.4709 402,-514.9268"/>
</g>
<!-- sourcefile~modfields.f90 -->
<g id="sourcefile~~modsubgrid.f90~~EfferentGraph_node5" class="node">
<title>sourcefile~modfields.f90</title>
<g id="a_sourcefile~~modsubgrid.f90~~EfferentGraph_node5"><a xlink:href=".././sourcefile/modfields.f90.html" xlink:title="modfields.f90">
<polygon fill="#f0ad4e" stroke="#f0ad4e" points="313,-170.9268 237,-170.9268 237,-146.9268 313,-146.9268 313,-170.9268"/>
<text text-anchor="middle" x="275" y="-156.5268" font-family="Helvetica,sans-Serif" font-size="10.50" fill="#ffffff">modfields.f90</text>
</a>
</g>
</g>
<!-- sourcefile~modsubgrid.f90&#45;&gt;sourcefile~modfields.f90 -->
<g id="sourcefile~~modsubgrid.f90~~EfferentGraph_edge4" class="edge">
<title>sourcefile~modsubgrid.f90&#45;&gt;sourcefile~modfields.f90</title>
<path fill="none" stroke="#ff0000" stroke-dasharray="5,2" d="M638.5,-116.9268C527.2122,-66.9181 378.3184,-115.5823 310.8787,-143.0138"/>
<polygon fill="#ff0000" stroke="#ff0000" points="309.4279,-139.8264 301.5338,-146.8927 312.1116,-146.2915 309.4279,-139.8264"/>
</g>
<!-- sourcefile~modboundary.f90 -->
<g id="sourcefile~~modsubgrid.f90~~EfferentGraph_node6" class="node">
<title>sourcefile~modboundary.f90</title>
<g id="a_sourcefile~~modsubgrid.f90~~EfferentGraph_node6"><a xlink:href=".././sourcefile/modboundary.f90.html" xlink:title="modboundary.f90">
<polygon fill="#f0ad4e" stroke="#f0ad4e" points="687,-206.9268 590,-206.9268 590,-182.9268 687,-182.9268 687,-206.9268"/>
<text text-anchor="middle" x="638.5" y="-192.5268" font-family="Helvetica,sans-Serif" font-size="10.50" fill="#ffffff">modboundary.f90</text>
</a>
</g>
</g>
<!-- sourcefile~modsubgrid.f90&#45;&gt;sourcefile~modboundary.f90 -->
<g id="sourcefile~~modsubgrid.f90~~EfferentGraph_edge5" class="edge">
<title>sourcefile~modsubgrid.f90&#45;&gt;sourcefile~modboundary.f90</title>
<path fill="none" stroke="#ff0000" stroke-dasharray="5,2" d="M722.8077,-194.9268C714.6725,-194.9268 706.049,-194.9268 697.543,-194.9268"/>
<polygon fill="#ff0000" stroke="#ff0000" points="697.2665,-191.4269 687.2664,-194.9268 697.2664,-198.4269 697.2665,-191.4269"/>
</g>
<!-- sourcefile~modglobal.f90 -->
<g id="sourcefile~~modsubgrid.f90~~EfferentGraph_node7" class="node">
<title>sourcefile~modglobal.f90</title>
<g id="a_sourcefile~~modsubgrid.f90~~EfferentGraph_node7"><a xlink:href=".././sourcefile/modglobal.f90.html" xlink:title="modglobal.f90">
<polygon fill="#f0ad4e" stroke="#f0ad4e" points="185,-190.9268 105,-190.9268 105,-166.9268 185,-166.9268 185,-190.9268"/>
<text text-anchor="middle" x="145" y="-176.5268" font-family="Helvetica,sans-Serif" font-size="10.50" fill="#ffffff">modglobal.f90</text>
</a>
</g>
</g>
<!-- sourcefile~modsubgrid.f90&#45;&gt;sourcefile~modglobal.f90 -->
<g id="sourcefile~~modsubgrid.f90~~EfferentGraph_edge6" class="edge">
<title>sourcefile~modsubgrid.f90&#45;&gt;sourcefile~modglobal.f90</title>
<path fill="none" stroke="#ff0000" stroke-dasharray="5,2" d="M402,-2.9268C381.0784,-.905 237.7013,-45.1648 221,-57.9268 186.9176,-83.9703 164.2041,-130.0336 153.0503,-157.1915"/>
<polygon fill="#ff0000" stroke="#ff0000" points="149.7554,-156.0065 149.3419,-166.5933 156.2671,-158.575 149.7554,-156.0065"/>
</g>
<!-- sourcefile~modmpi.f90 -->
<g id="sourcefile~~modsubgrid.f90~~EfferentGraph_node8" class="node">
<title>sourcefile~modmpi.f90</title>
<g id="a_sourcefile~~modsubgrid.f90~~EfferentGraph_node8"><a xlink:href=".././sourcefile/modmpi.f90.html" xlink:title="modmpi.f90">
<polygon fill="#f0ad4e" stroke="#f0ad4e" points="69,-190.9268 0,-190.9268 0,-166.9268 69,-166.9268 69,-190.9268"/>
<text text-anchor="middle" x="34.5" y="-176.5268" font-family="Helvetica,sans-Serif" font-size="10.50" fill="#ffffff">modmpi.f90</text>
</a>
</g>
</g>
<!-- sourcefile~modsubgrid.f90&#45;&gt;sourcefile~modmpi.f90 -->
<g id="sourcefile~~modsubgrid.f90~~EfferentGraph_edge7" class="edge">
<title>sourcefile~modsubgrid.f90&#45;&gt;sourcefile~modmpi.f90</title>
<path fill="none" stroke="#ff0000" stroke-dasharray="5,2" d="M748.8355,-182.7937C724.6491,-166.5037 679.5386,-137.2624 638.5,-116.9268"/>
<path fill="none" stroke="#ff0000" stroke-dasharray="5,2" d="M638.5,-116.9268C580.582,-88.2271 576.7113,-58.4747 514.5,-40.9268"/>
<path fill="none" stroke="#ff0000" stroke-dasharray="5,2" d="M514.5,-40.9268C463.7066,-26.5995 454.5306,-8.0033 402,-2.9268"/>
<path fill="none" stroke="#ff0000" stroke-dasharray="5,2" d="M402,-2.9268C345.8103,2.5033 331.3116,-4.8975 275,-.9268"/>
<path fill="none" stroke="#ff0000" stroke-dasharray="5,2" d="M275,-.9268C169.8523,6.4876 80.2882,-109.6924 47.6686,-158.1878"/>
<polygon fill="#ff0000" stroke="#ff0000" points="44.6597,-156.3931 42.0823,-166.6697 50.5057,-160.2434 44.6597,-156.3931"/>
</g>
<!-- sourcefile~modfields.f90&#45;&gt;sourcefile~modglobal.f90 -->
<g id="sourcefile~~modsubgrid.f90~~EfferentGraph_edge8" class="edge">
<title>sourcefile~modfields.f90&#45;&gt;sourcefile~modglobal.f90</title>
<path fill="none" stroke="#00ff91" stroke-dasharray="5,2" d="M236.6988,-164.8193C223.8074,-166.8026 209.22,-169.0468 195.534,-171.1523"/>
<polygon fill="#00ff91" stroke="#00ff91" points="194.6384,-167.7489 185.2869,-172.7288 195.7029,-174.6675 194.6384,-167.7489"/>
</g>
<!-- sourcefile~modboundary.f90&#45;&gt;sourcefile~modsubgriddata.f90 -->
<g id="sourcefile~~modsubgrid.f90~~EfferentGraph_edge9" class="edge">
<title>sourcefile~modboundary.f90&#45;&gt;sourcefile~modsubgriddata.f90</title>
<path fill="none" stroke="#0091ff" stroke-dasharray="5,2" d="M605.1609,-182.8644C580.3923,-174.2244 545.6468,-162.7758 514.5,-154.9268"/>
<path fill="none" stroke="#0091ff" stroke-dasharray="5,2" d="M514.5,-154.9268C455.9891,-140.182 462.1292,-83.9687 402,-78.9268"/>
</g>
<!-- sourcefile~modboundary.f90&#45;&gt;sourcefile~modsurfdata.f90 -->
<g id="sourcefile~~modsubgrid.f90~~EfferentGraph_edge11" class="edge">
<title>sourcefile~modboundary.f90&#45;&gt;sourcefile~modsurfdata.f90</title>
<path fill="none" stroke="#0091ff" stroke-dasharray="5,2" d="M514.5,-514.9268C494.0517,-531.6054 428.3485,-554.363 402,-552.9268"/>
<path fill="none" stroke="#0091ff" stroke-dasharray="5,2" d="M402,-552.9268C371.2934,-551.253 337.884,-541.4428 313.042,-532.4857"/>
<polygon fill="#0091ff" stroke="#0091ff" points="314.2213,-529.1902 303.6284,-528.9849 311.7812,-535.7512 314.2213,-529.1902"/>
</g>
<!-- sourcefile~modboundary.f90&#45;&gt;sourcefile~modinletdata.f90 -->
<g id="sourcefile~~modsubgrid.f90~~EfferentGraph_edge12" class="edge">
<title>sourcefile~modboundary.f90&#45;&gt;sourcefile~modinletdata.f90</title>
<path fill="none" stroke="#0091ff" stroke-dasharray="5,2" d="M637.8592,-207.2163C634.645,-255.2973 616.0744,-432.0776 514.5,-514.9268"/>
<path fill="none" stroke="#0091ff" stroke-dasharray="5,2" d="M514.5,-514.9268C475.7541,-546.5299 448.8117,-532.4957 402,-514.9268"/>
<path fill="none" stroke="#0091ff" stroke-dasharray="5,2" d="M402,-514.9268C363.1642,-500.3513 323.1646,-473.4429 298.6883,-455.3636"/>
<polygon fill="#0091ff" stroke="#0091ff" points="300.5019,-452.3484 290.404,-449.1415 296.298,-457.9456 300.5019,-452.3484"/>
</g>
<!-- sourcefile~modboundary.f90&#45;&gt;sourcefile~modfields.f90 -->
<g id="sourcefile~~modsubgrid.f90~~EfferentGraph_edge14" class="edge">
<title>sourcefile~modboundary.f90&#45;&gt;sourcefile~modfields.f90</title>
<path fill="none" stroke="#0091ff" stroke-dasharray="5,2" d="M514.5,-154.9268C481.1371,-147.7431 472.9843,-165.8026 439,-168.9268 406.2492,-171.9376 397.8386,-170.7456 365,-168.9268 351.3656,-168.1717 336.6225,-166.7777 323.0926,-165.2654"/>
<polygon fill="#0091ff" stroke="#0091ff" points="323.3585,-161.7729 313.0212,-164.0945 322.5501,-168.726 323.3585,-161.7729"/>
</g>
<!-- sourcefile~modboundary.f90&#45;&gt;sourcefile~modglobal.f90 -->
<g id="sourcefile~~modsubgrid.f90~~EfferentGraph_edge15" class="edge">
<title>sourcefile~modboundary.f90&#45;&gt;sourcefile~modglobal.f90</title>
<path fill="none" stroke="#0091ff" stroke-dasharray="5,2" d="M514.5,-154.9268C466.0158,-142.7088 450.7276,-166.1347 402,-154.9268"/>
<path fill="none" stroke="#0091ff" stroke-dasharray="5,2" d="M402,-154.9268C323.2576,-136.8152 299.3391,-118.1435 221,-137.9268 202.8758,-142.5038 184.3775,-152.3486 170.169,-161.2439"/>
<polygon fill="#0091ff" stroke="#0091ff" points="167.9703,-158.4989 161.4985,-166.8874 171.7889,-164.3656 167.9703,-158.4989"/>
</g>
<!-- sourcefile~modboundary.f90&#45;&gt;sourcefile~modmpi.f90 -->
<g id="sourcefile~~modsubgrid.f90~~EfferentGraph_edge16" class="edge">
<title>sourcefile~modboundary.f90&#45;&gt;sourcefile~modmpi.f90</title>
<path fill="none" stroke="#0091ff" stroke-dasharray="5,2" d="M625.621,-182.844C581.1955,-142.3914 428.6362,-13.5433 275,-.9268"/>
</g>
<!-- sourcefile~moddriver.f90 -->
<g id="sourcefile~~modsubgrid.f90~~EfferentGraph_node9" class="node">
<title>sourcefile~moddriver.f90</title>
<g id="a_sourcefile~~modsubgrid.f90~~EfferentGraph_node9"><a xlink:href=".././sourcefile/moddriver.f90.html" xlink:title="moddriver.f90">
<polygon fill="#f0ad4e" stroke="#f0ad4e" points="554,-206.9268 475,-206.9268 475,-182.9268 554,-182.9268 554,-206.9268"/>
<text text-anchor="middle" x="514.5" y="-192.5268" font-family="Helvetica,sans-Serif" font-size="10.50" fill="#ffffff">moddriver.f90</text>
</a>
</g>
</g>
<!-- sourcefile~modboundary.f90&#45;&gt;sourcefile~moddriver.f90 -->
<g id="sourcefile~~modsubgrid.f90~~EfferentGraph_edge13" class="edge">
<title>sourcefile~modboundary.f90&#45;&gt;sourcefile~moddriver.f90</title>
<path fill="none" stroke="#0091ff" stroke-dasharray="5,2" d="M589.8478,-194.9268C581.4545,-194.9268 572.7186,-194.9268 564.2956,-194.9268"/>
<polygon fill="#0091ff" stroke="#0091ff" points="564.2207,-191.4269 554.2207,-194.9268 564.2206,-198.4269 564.2207,-191.4269"/>
</g>
<!-- sourcefile~modinlet.f90 -->
<g id="sourcefile~~modsubgrid.f90~~EfferentGraph_node10" class="node">
<title>sourcefile~modinlet.f90</title>
<g id="a_sourcefile~~modsubgrid.f90~~EfferentGraph_node10"><a xlink:href=".././sourcefile/modinlet.f90.html" xlink:title="modinlet.f90">
<polygon fill="#f0ad4e" stroke="#f0ad4e" points="550,-302.9268 479,-302.9268 479,-278.9268 550,-278.9268 550,-302.9268"/>
<text text-anchor="middle" x="514.5" y="-288.5268" font-family="Helvetica,sans-Serif" font-size="10.50" fill="#ffffff">modinlet.f90</text>
</a>
</g>
</g>
<!-- sourcefile~modboundary.f90&#45;&gt;sourcefile~modinlet.f90 -->
<g id="sourcefile~~modsubgrid.f90~~EfferentGraph_edge10" class="edge">
<title>sourcefile~modboundary.f90&#45;&gt;sourcefile~modinlet.f90</title>
<path fill="none" stroke="#0091ff" stroke-dasharray="5,2" d="M622.7953,-207.0853C601.459,-223.6037 563.1281,-253.2792 538.2614,-272.5309"/>
<polygon fill="#0091ff" stroke="#0091ff" points="535.8418,-269.9777 530.0772,-278.8671 540.127,-275.5128 535.8418,-269.9777"/>
</g>
<!-- sourcefile~modglobal.f90&#45;&gt;sourcefile~modmpi.f90 -->
<g id="sourcefile~~modsubgrid.f90~~EfferentGraph_edge17" class="edge">
<title>sourcefile~modglobal.f90&#45;&gt;sourcefile~modmpi.f90</title>
<path fill="none" stroke="#4800ff" stroke-dasharray="5,2" d="M104.7944,-178.9268C96.4589,-178.9268 87.6289,-178.9268 79.1455,-178.9268"/>
<polygon fill="#4800ff" stroke="#4800ff" points="79.0261,-175.4269 69.0261,-178.9268 79.0261,-182.4269 79.0261,-175.4269"/>
</g>
<!-- sourcefile~moddriver.f90&#45;&gt;sourcefile~modinletdata.f90 -->
<g id="sourcefile~~modsubgrid.f90~~EfferentGraph_edge18" class="edge">
<title>sourcefile~moddriver.f90&#45;&gt;sourcefile~modinletdata.f90</title>
<path fill="none" stroke="#ff0000" stroke-dasharray="5,2" d="M508.0304,-207.1028C490.6121,-239.8363 443.7208,-327.623 439,-332.9268 403.5053,-372.8051 349.1736,-403.1409 312.8888,-420.4816"/>
<polygon fill="#ff0000" stroke="#ff0000" points="311.1955,-417.4096 303.6201,-424.8166 314.1611,-423.7504 311.1955,-417.4096"/>
</g>
<!-- sourcefile~moddriver.f90&#45;&gt;sourcefile~modfields.f90 -->
<g id="sourcefile~~modsubgrid.f90~~EfferentGraph_edge19" class="edge">
<title>sourcefile~moddriver.f90&#45;&gt;sourcefile~modfields.f90</title>
<path fill="none" stroke="#ff0000" stroke-dasharray="5,2" d="M490.1877,-207.1007C467.8673,-217.2012 433.5684,-230.0508 402,-230.9268"/>
<path fill="none" stroke="#ff0000" stroke-dasharray="5,2" d="M402,-230.9268C363.6661,-231.9905 362.5524,-203.4971 329,-184.9268 323.2647,-181.7524 317.0818,-178.5659 311.0191,-175.5653"/>
<polygon fill="#ff0000" stroke="#ff0000" points="312.1973,-172.2468 301.6724,-171.0318 309.1424,-178.5451 312.1973,-172.2468"/>
</g>
<!-- sourcefile~moddriver.f90&#45;&gt;sourcefile~modglobal.f90 -->
<g id="sourcefile~~modsubgrid.f90~~EfferentGraph_edge21" class="edge">
<title>sourcefile~moddriver.f90&#45;&gt;sourcefile~modglobal.f90</title>
<path fill="none" stroke="#ff0000" stroke-dasharray="5,2" d="M486.3737,-182.8754C463.938,-173.7671 431.4943,-161.7108 402,-154.9268"/>
</g>
<!-- sourcefile~moddriver.f90&#45;&gt;sourcefile~modmpi.f90 -->
<g id="sourcefile~~modsubgrid.f90~~EfferentGraph_edge22" class="edge">
<title>sourcefile~moddriver.f90&#45;&gt;sourcefile~modmpi.f90</title>
<path fill="none" stroke="#ff0000" stroke-dasharray="5,2" d="M402,-230.9268C316.8547,-233.2894 289.573,-243.3991 221,-293.9268 175.2,-327.6744 196.6865,-420.6976 145,-396.9268"/>
<path fill="none" stroke="#ff0000" stroke-dasharray="5,2" d="M145,-396.9268C69.2524,-359.6153 44.4976,-248.5831 37.2292,-200.9881"/>
<polygon fill="#ff0000" stroke="#ff0000" points="40.6949,-200.4989 35.8332,-191.0854 33.7635,-201.4761 40.6949,-200.4989"/>
</g>
<!-- sourcefile~modsave.f90 -->
<g id="sourcefile~~modsubgrid.f90~~EfferentGraph_node11" class="node">
<title>sourcefile~modsave.f90</title>
<g id="a_sourcefile~~modsubgrid.f90~~EfferentGraph_node11"><a xlink:href=".././sourcefile/modsave.f90.html" xlink:title="modsave.f90">
<polygon fill="#f0ad4e" stroke="#f0ad4e" points="439,-323.9268 365,-323.9268 365,-299.9268 439,-299.9268 439,-323.9268"/>
<text text-anchor="middle" x="402" y="-309.5268" font-family="Helvetica,sans-Serif" font-size="10.50" fill="#ffffff">modsave.f90</text>
</a>
</g>
</g>
<!-- sourcefile~moddriver.f90&#45;&gt;sourcefile~modsave.f90 -->
<g id="sourcefile~~modsubgrid.f90~~EfferentGraph_edge20" class="edge">
<title>sourcefile~moddriver.f90&#45;&gt;sourcefile~modsave.f90</title>
<path fill="none" stroke="#ff0000" stroke-dasharray="5,2" d="M505.4113,-206.9667C491.8721,-224.549 465.1829,-257.8794 439,-282.9268 435.1905,-286.5711 430.9479,-290.2226 426.7332,-293.6457"/>
<polygon fill="#ff0000" stroke="#ff0000" points="424.4893,-290.9575 418.7838,-299.8849 428.8112,-296.464 424.4893,-290.9575"/>
</g>
<!-- sourcefile~modinlet.f90&#45;&gt;sourcefile~modsurfdata.f90 -->
<g id="sourcefile~~modsubgrid.f90~~EfferentGraph_edge23" class="edge">
<title>sourcefile~modinlet.f90&#45;&gt;sourcefile~modsurfdata.f90</title>
<path fill="none" stroke="#00ffff" stroke-dasharray="5,2" d="M402,-476.9268C379.9868,-489.3389 353.6145,-498.4446 330.6205,-504.8043"/>
<polygon fill="#00ffff" stroke="#00ffff" points="329.4264,-501.5 320.6595,-507.4491 331.2228,-508.2656 329.4264,-501.5"/>
</g>
<!-- sourcefile~modinlet.f90&#45;&gt;sourcefile~modinletdata.f90 -->
<g id="sourcefile~~modsubgrid.f90~~EfferentGraph_edge24" class="edge">
<title>sourcefile~modinlet.f90&#45;&gt;sourcefile~modinletdata.f90</title>
<path fill="none" stroke="#00ffff" stroke-dasharray="5,2" d="M511.5951,-303.0147C502.5117,-337.7765 471.0339,-438.0021 402,-476.9268"/>
<path fill="none" stroke="#00ffff" stroke-dasharray="5,2" d="M402,-476.9268C385.8959,-486.0071 340.3357,-468.1245 308.4157,-453.4278"/>
<polygon fill="#00ffff" stroke="#00ffff" points="309.5344,-450.0864 298.9952,-449.0025 306.5581,-456.4222 309.5344,-450.0864"/>
</g>
<!-- sourcefile~modinlet.f90&#45;&gt;sourcefile~modfields.f90 -->
<g id="sourcefile~~modsubgrid.f90~~EfferentGraph_edge25" class="edge">
<title>sourcefile~modinlet.f90&#45;&gt;sourcefile~modfields.f90</title>
<path fill="none" stroke="#00ffff" stroke-dasharray="5,2" d="M478.9032,-287.8558C456.1867,-284.9652 426.5122,-279.4298 402,-268.9268"/>
<path fill="none" stroke="#00ffff" stroke-dasharray="5,2" d="M402,-268.9268C383.9833,-261.2069 378.6153,-259.0272 365,-244.9268 343.3983,-222.5554 351.9746,-205.8857 329,-184.9268 325.3487,-181.5958 321.1933,-178.6058 316.8465,-175.945"/>
<polygon fill="#00ffff" stroke="#00ffff" points="318.2041,-172.6971 307.7557,-170.9416 314.8288,-178.8297 318.2041,-172.6971"/>
</g>
<!-- sourcefile~modinlet.f90&#45;&gt;sourcefile~modglobal.f90 -->
<g id="sourcefile~~modsubgrid.f90~~EfferentGraph_edge27" class="edge">
<title>sourcefile~modinlet.f90&#45;&gt;sourcefile~modglobal.f90</title>
<path fill="none" stroke="#00ffff" stroke-dasharray="5,2" d="M402,-268.9268C383.9833,-261.2069 381.0719,-256.1469 365,-244.9268 348.6009,-233.4783 347.211,-226.1948 329,-217.9268 286.3305,-198.5544 233.6787,-188.6459 195.645,-183.6784"/>
<polygon fill="#00ffff" stroke="#00ffff" points="195.6791,-180.1561 185.3256,-182.4046 194.8215,-187.1034 195.6791,-180.1561"/>
</g>
<!-- sourcefile~modinlet.f90&#45;&gt;sourcefile~modmpi.f90 -->
<g id="sourcefile~~modsubgrid.f90~~EfferentGraph_edge28" class="edge">
<title>sourcefile~modinlet.f90&#45;&gt;sourcefile~modmpi.f90</title>
<path fill="none" stroke="#00ffff" stroke-dasharray="5,2" d="M402,-476.9268C366.771,-496.7906 258.3991,-473.3203 221,-457.9268 180.9478,-441.4413 183.8543,-416.0655 145,-396.9268"/>
</g>
<!-- sourcefile~modinlet.f90&#45;&gt;sourcefile~modsave.f90 -->
<g id="sourcefile~~modsubgrid.f90~~EfferentGraph_edge26" class="edge">
<title>sourcefile~modinlet.f90&#45;&gt;sourcefile~modsave.f90</title>
<path fill="none" stroke="#00ffff" stroke-dasharray="5,2" d="M478.9043,-297.5713C469.54,-299.3193 459.2889,-301.2329 449.4108,-303.0768"/>
<polygon fill="#00ffff" stroke="#00ffff" points="448.4925,-299.6876 439.3046,-304.9633 449.7771,-306.5688 448.4925,-299.6876"/>
</g>
<!-- sourcefile~modsave.f90&#45;&gt;sourcefile~modsubgriddata.f90 -->
<g id="sourcefile~~modsubgrid.f90~~EfferentGraph_edge30" class="edge">
<title>sourcefile~modsave.f90&#45;&gt;sourcefile~modsubgriddata.f90</title>
<path fill="none" stroke="#ff0000" stroke-dasharray="5,2" d="M381.698,-299.8094C375.5268,-295.2255 369.259,-289.5033 365,-282.9268 328.9062,-227.1924 360.3828,-196.4435 329,-137.9268 320.8951,-122.8142 308.0427,-108.5518 296.9096,-97.8364"/>
<polygon fill="#ff0000" stroke="#ff0000" points="299.2688,-95.2509 289.5563,-91.0179 294.5092,-100.3838 299.2688,-95.2509"/>
</g>
<!-- sourcefile~modsave.f90&#45;&gt;sourcefile~modsurfdata.f90 -->
<g id="sourcefile~~modsubgrid.f90~~EfferentGraph_edge31" class="edge">
<title>sourcefile~modsave.f90&#45;&gt;sourcefile~modsurfdata.f90</title>
<path fill="none" stroke="#ff0000" stroke-dasharray="5,2" d="M397.1957,-324.2869C386.8103,-350.2654 360.6339,-411.9262 329,-457.9268 319.2498,-472.1051 306.2856,-486.382 295.5038,-497.3396"/>
<polygon fill="#ff0000" stroke="#ff0000" points="292.741,-495.1509 288.1159,-504.683 297.6757,-500.1157 292.741,-495.1509"/>
</g>
<!-- sourcefile~modsave.f90&#45;&gt;sourcefile~modinletdata.f90 -->
<g id="sourcefile~~modsubgrid.f90~~EfferentGraph_edge32" class="edge">
<title>sourcefile~modsave.f90&#45;&gt;sourcefile~modinletdata.f90</title>
<path fill="none" stroke="#ff0000" stroke-dasharray="5,2" d="M395.6499,-324.0722C384.5256,-344.365 359.7458,-385.4437 329,-410.9268 324.9481,-414.2851 320.3895,-417.3313 315.6824,-420.0576"/>
<polygon fill="#ff0000" stroke="#ff0000" points="313.7373,-417.1274 306.542,-424.9042 317.0165,-423.3118 313.7373,-417.1274"/>
</g>
<!-- sourcefile~modsave.f90&#45;&gt;sourcefile~modfields.f90 -->
<g id="sourcefile~~modsubgrid.f90~~EfferentGraph_edge33" class="edge">
<title>sourcefile~modsave.f90&#45;&gt;sourcefile~modfields.f90</title>
<path fill="none" stroke="#ff0000" stroke-dasharray="5,2" d="M384.5873,-299.8604C378.1009,-294.9706 370.8901,-289.0386 365,-282.9268 333.271,-250.0036 303.575,-205.3884 287.4866,-179.6255"/>
<polygon fill="#ff0000" stroke="#ff0000" points="290.4233,-177.7195 282.1964,-171.0434 284.4644,-181.3927 290.4233,-177.7195"/>
</g>
<!-- sourcefile~modsave.f90&#45;&gt;sourcefile~modglobal.f90 -->
<g id="sourcefile~~modsubgrid.f90~~EfferentGraph_edge35" class="edge">
<title>sourcefile~modsave.f90&#45;&gt;sourcefile~modglobal.f90</title>
<path fill="none" stroke="#ff0000" stroke-dasharray="5,2" d="M378.7397,-299.8894C332.6978,-276.0622 229.8675,-222.8465 177.2957,-195.6401"/>
<polygon fill="#ff0000" stroke="#ff0000" points="178.8828,-192.5206 168.3929,-191.0329 175.6655,-198.7374 178.8828,-192.5206"/>
</g>
<!-- sourcefile~modsave.f90&#45;&gt;sourcefile~modmpi.f90 -->
<g id="sourcefile~~modsubgrid.f90~~EfferentGraph_edge36" class="edge">
<title>sourcefile~modsave.f90&#45;&gt;sourcefile~modmpi.f90</title>
<path fill="none" stroke="#ff0000" stroke-dasharray="5,2" d="M372.1086,-323.9956C369.6019,-325.4968 367.1917,-327.1401 365,-328.9268 344.0541,-346.0014 352.4511,-364.4986 329,-377.9268 293.3278,-398.3528 182.2359,-414.34 145,-396.9268"/>
</g>
<!-- sourcefile~modibmdata.f90 -->
<g id="sourcefile~~modsubgrid.f90~~EfferentGraph_node12" class="node">
<title>sourcefile~modibmdata.f90</title>
<g id="a_sourcefile~~modsubgrid.f90~~EfferentGraph_node12"><a xlink:href=".././sourcefile/modibmdata.f90.html" xlink:title="modibmdata.f90">
<polygon fill="#f0ad4e" stroke="#f0ad4e" points="320,-326.9268 230,-326.9268 230,-302.9268 320,-302.9268 320,-326.9268"/>
<text text-anchor="middle" x="275" y="-312.5268" font-family="Helvetica,sans-Serif" font-size="10.50" fill="#ffffff">modibmdata.f90</text>
</a>
</g>
</g>
<!-- sourcefile~modsave.f90&#45;&gt;sourcefile~modibmdata.f90 -->
<g id="sourcefile~~modsubgrid.f90~~EfferentGraph_edge29" class="edge">
<title>sourcefile~modsave.f90&#45;&gt;sourcefile~modibmdata.f90</title>
<path fill="none" stroke="#ff0000" stroke-dasharray="5,2" d="M364.9249,-312.8026C354.1658,-313.0567 342.1749,-313.34 330.5456,-313.6147"/>
<polygon fill="#ff0000" stroke="#ff0000" points="330.3735,-310.1177 320.459,-313.853 330.5389,-317.1157 330.3735,-310.1177"/>
</g>
<!-- sourcefile~initfac.f90 -->
<g id="sourcefile~~modsubgrid.f90~~EfferentGraph_node13" class="node">
<title>sourcefile~initfac.f90</title>
<g id="a_sourcefile~~modsubgrid.f90~~EfferentGraph_node13"><a xlink:href=".././sourcefile/initfac.f90.html" xlink:title="initfac.f90">
<polygon fill="#f0ad4e" stroke="#f0ad4e" points="304,-368.9268 246,-368.9268 246,-344.9268 304,-344.9268 304,-368.9268"/>
<text text-anchor="middle" x="275" y="-354.5268" font-family="Helvetica,sans-Serif" font-size="10.50" fill="#ffffff">initfac.f90</text>
</a>
</g>
</g>
<!-- sourcefile~modsave.f90&#45;&gt;sourcefile~initfac.f90 -->
<g id="sourcefile~~modsubgrid.f90~~EfferentGraph_edge34" class="edge">
<title>sourcefile~modsave.f90&#45;&gt;sourcefile~initfac.f90</title>
<path fill="none" stroke="#ff0000" stroke-dasharray="5,2" d="M367.9663,-323.986C351.3829,-329.862 331.3544,-336.9587 314.1407,-343.058"/>
<polygon fill="#ff0000" stroke="#ff0000" points="312.635,-339.8783 304.3782,-346.5172 314.9729,-346.4763 312.635,-339.8783"/>
</g>
<!-- sourcefile~initfac.f90&#45;&gt;sourcefile~modglobal.f90 -->
<g id="sourcefile~~modsubgrid.f90~~EfferentGraph_edge37" class="edge">
<title>sourcefile~initfac.f90&#45;&gt;sourcefile~modglobal.f90</title>
<path fill="none" stroke="#00ffff" stroke-dasharray="5,2" d="M245.842,-350.0465C237.074,-346.8752 227.9478,-342.3403 221,-335.9268 180.2406,-298.3019 158.8996,-234.1391 150.0563,-200.679"/>
<polygon fill="#00ffff" stroke="#00ffff" points="153.4473,-199.8121 147.6154,-190.9668 146.6584,-201.5183 153.4473,-199.8121"/>
</g>
<!-- sourcefile~initfac.f90&#45;&gt;sourcefile~modmpi.f90 -->
<g id="sourcefile~~modsubgrid.f90~~EfferentGraph_edge38" class="edge">
<title>sourcefile~initfac.f90&#45;&gt;sourcefile~modmpi.f90</title>
<path fill="none" stroke="#00ffff" stroke-dasharray="5,2" d="M249.8131,-369.035C217.5931,-383.7736 163.7165,-405.6795 145,-396.9268"/>
</g>
</g>
</svg>
</div><script>var pansourcefilemodsubgridf90EfferentGraph = svgPanZoom('#sourcefilemodsubgridf90EfferentGraph', {zoomEnabled: true,controlIconsEnabled: true, fit: true, center: true,}); </script><div><a type="button" class="graph-help" data-toggle="modal" href="#graph-help-text">Help</a></div><div class="modal fade" id="graph-help-text" tabindex="-1" role="dialog"><div class="modal-dialog modal-lg" role="document"><div class="modal-content"><div class="modal-header"><button type="button" class="close" data-dismiss="modal" aria-label="Close"><span aria-hidden="true">&times;</span></button><h4 class="modal-title" id="-graph-help-label">Graph Key</h4></div><div class="modal-body">
    <p>Nodes of different colours represent the following: </p>
    <?xml version="1.0" encoding="UTF-8" standalone="no"?>
<!DOCTYPE svg PUBLIC "-//W3C//DTD SVG 1.1//EN"
 "http://www.w3.org/Graphics/SVG/1.1/DTD/svg11.dtd">
<!-- Generated by graphviz version 2.40.1 (20161225.0304)
 -->
<!-- Title: Graph Key Pages: 1 -->
<svg width="190pt" height="32pt"
 viewBox="0.00 0.00 190.00 32.00" xmlns="http://www.w3.org/2000/svg" xmlns:xlink="http://www.w3.org/1999/xlink">
<g id="graph0" class="graph" transform="scale(1 1) rotate(0) translate(4 28)">
<title>Graph Key</title>
<polygon fill="#ffffff" stroke="transparent" points="-4,4 -4,-28 186,-28 186,4 -4,4"/>
<!-- Source File -->
<g id="node1" class="node">
<title>Source File</title>
<polygon fill="#f0ad4e" stroke="#f0ad4e" points="67,-24 0,-24 0,0 67,0 67,-24"/>
<text text-anchor="middle" x="33.5" y="-9.6" font-family="Helvetica,sans-Serif" font-size="10.50" fill="#ffffff">Source File</text>
</g>
<!-- This Page&#39;s Entity -->
<g id="node2" class="node">
<title>This Page&#39;s Entity</title>
<polygon fill="none" stroke="#000000" points="182,-24 85,-24 85,0 182,0 182,-24"/>
<text text-anchor="middle" x="133.5" y="-9.6" font-family="Helvetica,sans-Serif" font-size="10.50" fill="#000000">This Page&#39;s Entity</text>
</g>
</g>
</svg>

    
    <p>Solid arrows point from a file to a file which it depends on. A file
    is dependent upon another if the latter must be compiled before the former
    can be. Where possible, edges connecting nodes are given different colours to make them easier to distinguish in large graphs.
    </p>
    </div></div></div></div>
      </div>
    </div>
    
      
    <div class="panel panel-default">
      <div class="panel-heading">
  <h3 class="panel-title">Files dependent on this one</h3>
      </div>
      <div class="panel-body">
  <div class="depgraph"><?xml version="1.0" encoding="UTF-8" standalone="no"?>
<!DOCTYPE svg PUBLIC "-//W3C//DTD SVG 1.1//EN"
 "http://www.w3.org/Graphics/SVG/1.1/DTD/svg11.dtd">
<!-- Generated by graphviz version 2.40.1 (20161225.0304)
 -->
<!-- Title: sourcefile~~modsubgrid.f90~~AfferentGraph Pages: 1 -->
<svg id="sourcefilemodsubgridf90AfferentGraph" width="339pt" height="88pt"
 viewBox="0.00 0.00 339.00 87.64" xmlns="http://www.w3.org/2000/svg" xmlns:xlink="http://www.w3.org/1999/xlink">
<g id="sourcefile~~modsubgrid.f90~~AfferentGraph" class="graph" transform="scale(1 1) rotate(0) translate(4 83.6401)">
<title>sourcefile~~modsubgrid.f90~~AfferentGraph</title>
<polygon fill="#ffffff" stroke="transparent" points="-4,4 -4,-83.6401 335,-83.6401 335,4 -4,4"/>
<!-- sourcefile~modsubgrid.f90 -->
<g id="sourcefile~~modsubgrid.f90~~AfferentGraph_node1" class="node">
<title>sourcefile~modsubgrid.f90</title>
<polygon fill="none" stroke="#000000" points="87,-66 0,-66 0,-42 87,-42 87,-66"/>
<text text-anchor="middle" x="43.5" y="-51.6" font-family="Helvetica,sans-Serif" font-size="10.50" fill="#000000">modsubgrid.f90</text>
</g>
<!-- sourcefile~modstartup.f90 -->
<g id="sourcefile~~modsubgrid.f90~~AfferentGraph_node2" class="node">
<title>sourcefile~modstartup.f90</title>
<g id="a_sourcefile~~modsubgrid.f90~~AfferentGraph_node2"><a xlink:href=".././sourcefile/modstartup.f90.html" xlink:title="modstartup.f90">
<polygon fill="#f0ad4e" stroke="#f0ad4e" points="216,-66 131,-66 131,-42 216,-42 216,-66"/>
<text text-anchor="middle" x="173.5" y="-51.6" font-family="Helvetica,sans-Serif" font-size="10.50" fill="#ffffff">modstartup.f90</text>
</a>
</g>
</g>
<!-- sourcefile~modstartup.f90&#45;&gt;sourcefile~modsubgrid.f90 -->
<g id="sourcefile~~modsubgrid.f90~~AfferentGraph_edge2" class="edge">
<title>sourcefile~modstartup.f90&#45;&gt;sourcefile~modsubgrid.f90</title>
<path fill="none" stroke="#ff0000" stroke-dasharray="5,2" d="M130.9331,-54C120.1612,-54 108.4524,-54 97.2086,-54"/>
<polygon fill="#ff0000" stroke="#ff0000" points="97.0537,-50.5001 87.0536,-54 97.0536,-57.5001 97.0537,-50.5001"/>
</g>
<!-- sourcefile~program.f90 -->
<g id="sourcefile~~modsubgrid.f90~~AfferentGraph_node3" class="node">
<title>sourcefile~program.f90</title>
<g id="a_sourcefile~~modsubgrid.f90~~AfferentGraph_node3"><a xlink:href=".././sourcefile/program.f90.html" xlink:title="program.f90">
<polygon fill="#f0ad4e" stroke="#f0ad4e" points="331,-66 260,-66 260,-42 331,-42 331,-66"/>
<text text-anchor="middle" x="295.5" y="-51.6" font-family="Helvetica,sans-Serif" font-size="10.50" fill="#ffffff">program.f90</text>
</a>
</g>
</g>
<!-- sourcefile~program.f90&#45;&gt;sourcefile~modsubgrid.f90 -->
<g id="sourcefile~~modsubgrid.f90~~AfferentGraph_edge1" class="edge">
<title>sourcefile~program.f90&#45;&gt;sourcefile~modsubgrid.f90</title>
<path fill="none" stroke="#ff0000" stroke-dasharray="5,2" d="M261.753,-66.0613C249.969,-69.6947 236.5497,-73.1952 224,-75 179.5682,-81.39 167.5152,-80.7802 123,-75 112.4865,-73.6348 101.3823,-71.2944 90.9151,-68.6595"/>
<polygon fill="#ff0000" stroke="#ff0000" points="91.6773,-65.2408 81.1146,-66.0652 89.886,-72.0077 91.6773,-65.2408"/>
</g>
<!-- sourcefile~program.f90&#45;&gt;sourcefile~modstartup.f90 -->
<g id="sourcefile~~modsubgrid.f90~~AfferentGraph_edge4" class="edge">
<title>sourcefile~program.f90&#45;&gt;sourcefile~modstartup.f90</title>
<path fill="none" stroke="#ff0000" stroke-dasharray="5,2" d="M259.8846,-54C249.4381,-54 237.7827,-54 226.499,-54"/>
<polygon fill="#ff0000" stroke="#ff0000" points="226.2862,-50.5001 216.2862,-54 226.2861,-57.5001 226.2862,-50.5001"/>
</g>
<!-- sourcefile~modstatsdump.f90 -->
<g id="sourcefile~~modsubgrid.f90~~AfferentGraph_node4" class="node">
<title>sourcefile~modstatsdump.f90</title>
<g id="a_sourcefile~~modsubgrid.f90~~AfferentGraph_node4"><a xlink:href=".././sourcefile/modstatsdump.f90.html" xlink:title="modstatsdump.f90">
<polygon fill="#f0ad4e" stroke="#f0ad4e" points="224,-24 123,-24 123,0 224,0 224,-24"/>
<text text-anchor="middle" x="173.5" y="-9.6" font-family="Helvetica,sans-Serif" font-size="10.50" fill="#ffffff">modstatsdump.f90</text>
</a>
</g>
</g>
<!-- sourcefile~program.f90&#45;&gt;sourcefile~modstatsdump.f90 -->
<g id="sourcefile~~modsubgrid.f90~~AfferentGraph_edge5" class="edge">
<title>sourcefile~program.f90&#45;&gt;sourcefile~modstatsdump.f90</title>
<path fill="none" stroke="#0000ff" stroke-dasharray="5,2" d="M260.5397,-41.9645C247.2671,-37.3952 231.9697,-32.1289 217.9375,-27.2981"/>
<polygon fill="#0000ff" stroke="#0000ff" points="219.0601,-23.9831 208.4654,-24.0373 216.7815,-30.6019 219.0601,-23.9831"/>
</g>
<!-- sourcefile~modstatsdump.f90&#45;&gt;sourcefile~modsubgrid.f90 -->
<g id="sourcefile~~modsubgrid.f90~~AfferentGraph_edge3" class="edge">
<title>sourcefile~modstatsdump.f90&#45;&gt;sourcefile~modsubgrid.f90</title>
<path fill="none" stroke="#ff0000" stroke-dasharray="5,2" d="M136.2472,-24.0355C121.9683,-28.6487 105.4901,-33.9724 90.4205,-38.8411"/>
<polygon fill="#ff0000" stroke="#ff0000" points="89.1979,-35.5579 80.7582,-41.9627 91.35,-42.2189 89.1979,-35.5579"/>
</g>
</g>
</svg>
</div><div><a type="button" class="graph-help" data-toggle="modal" href="#graph-help-text">Help</a></div><div class="modal fade" id="graph-help-text" tabindex="-1" role="dialog"><div class="modal-dialog modal-lg" role="document"><div class="modal-content"><div class="modal-header"><button type="button" class="close" data-dismiss="modal" aria-label="Close"><span aria-hidden="true">&times;</span></button><h4 class="modal-title" id="-graph-help-label">Graph Key</h4></div><div class="modal-body">
    <p>Nodes of different colours represent the following: </p>
    <?xml version="1.0" encoding="UTF-8" standalone="no"?>
<!DOCTYPE svg PUBLIC "-//W3C//DTD SVG 1.1//EN"
 "http://www.w3.org/Graphics/SVG/1.1/DTD/svg11.dtd">
<!-- Generated by graphviz version 2.40.1 (20161225.0304)
 -->
<!-- Title: Graph Key Pages: 1 -->
<svg width="190pt" height="32pt"
 viewBox="0.00 0.00 190.00 32.00" xmlns="http://www.w3.org/2000/svg" xmlns:xlink="http://www.w3.org/1999/xlink">
<g id="graph0" class="graph" transform="scale(1 1) rotate(0) translate(4 28)">
<title>Graph Key</title>
<polygon fill="#ffffff" stroke="transparent" points="-4,4 -4,-28 186,-28 186,4 -4,4"/>
<!-- Source File -->
<g id="node1" class="node">
<title>Source File</title>
<polygon fill="#f0ad4e" stroke="#f0ad4e" points="67,-24 0,-24 0,0 67,0 67,-24"/>
<text text-anchor="middle" x="33.5" y="-9.6" font-family="Helvetica,sans-Serif" font-size="10.50" fill="#ffffff">Source File</text>
</g>
<!-- This Page&#39;s Entity -->
<g id="node2" class="node">
<title>This Page&#39;s Entity</title>
<polygon fill="none" stroke="#000000" points="182,-24 85,-24 85,0 182,0 182,-24"/>
<text text-anchor="middle" x="133.5" y="-9.6" font-family="Helvetica,sans-Serif" font-size="10.50" fill="#000000">This Page&#39;s Entity</text>
</g>
</g>
</svg>

    
    <p>Solid arrows point from a file to a file which it depends on. A file
    is dependent upon another if the latter must be compiled before the former
    can be. Where possible, edges connecting nodes are given different colours to make them easier to distinguish in large graphs.
    </p>
    </div></div></div></div>
      </div>
    </div>
      
      <br>

    <section class="visible-xs visible-sm hidden-md">
      
<h3>Contents</h3>
 







<div class="panel panel-primary">
  <div class="panel-heading text-left"><h3 class="panel-title"><a data-toggle="collapse" href="#mods-1">Modules</a></h3></div>
  <div id="mods-1" class="panel-collapse collapse">
    <div class="list-group">
      
      <a class="list-group-item" href="../module/modsubgrid.html">modsubgrid</a>
      
    </div>
  </div>
</div>
















<div class="panel panel-primary">
  <div class="panel-heading text-left"><h3 class="panel-title">Source Code</h3></div>
  <div class="list-group">
    <a class="list-group-item" href="../sourcefile/modsubgrid.f90.html#src">modsubgrid.f90</a>
  </div>
</div>



    </section>
    <br class="visible-xs visible-sm hidden-md">

    <section>
      <h2><span class="anchor" id="src"></span>Source Code</h2>
    <div class="hl"><pre><span></span><a name="ln-1"></a><span class="c">!!&gt; \file modsubgrid.f90</span>
<a name="ln-2"></a><span class="c">!!!  Calculates and applies the Sub Filter Scale diffusion</span>
<a name="ln-3"></a><span class="c">!</span>
<a name="ln-4"></a><span class="c">!&gt;</span>
<a name="ln-5"></a><span class="c">!!  \author Jasper Tomas, TU Delft</span>
<a name="ln-6"></a><span class="c">!!  \author Pier Siebesma, K.N.M.I.</span>
<a name="ln-7"></a><span class="c">!!  \author Stephan de Roode,TU Delft</span>
<a name="ln-8"></a><span class="c">!!  \author Chiel van Heerwaarden, Wageningen U.R.</span>
<a name="ln-9"></a><span class="c">!!  \author Thijs Heus,MPI-M</span>
<a name="ln-10"></a><span class="c">!!  \par Revision list</span>
<a name="ln-11"></a><span class="c">!! Jasper Tomas: </span>
<a name="ln-12"></a><span class="c">!!   -Implemented Vreman model (2004)</span>
<a name="ln-13"></a><span class="c">!!   -wall-damping applied for 1-equation and Smagorinsky models</span>
<a name="ln-14"></a><span class="c">!!   -factor 2 smaller constant in 1-equation and Smagorinsky models</span>
<a name="ln-15"></a><span class="c">!!  \todo Documentation</span>
<a name="ln-16"></a><span class="c">!!</span>
<a name="ln-17"></a>
<a name="ln-18"></a><span class="k">module </span><span class="n">modsubgrid</span>
<a name="ln-19"></a>  <span class="k">use </span><span class="n">modsubgriddata</span>
<a name="ln-20"></a>  <span class="k">implicit none</span>
<a name="ln-21"></a><span class="k">  save</span>
<a name="ln-22"></a><span class="k">  public</span> <span class="kd">::</span> <span class="n">subgrid</span><span class="p">,</span> <span class="n">initsubgrid</span><span class="p">,</span> <span class="n">exitsubgrid</span><span class="p">,</span> <span class="n">subgridnamelist</span>
<a name="ln-23"></a>
<a name="ln-24"></a><span class="k">contains</span>
<a name="ln-25"></a><span class="k">  subroutine </span><span class="n">initsubgrid</span>
<a name="ln-26"></a>    <span class="k">use </span><span class="n">modglobal</span><span class="p">,</span> <span class="n">only</span> <span class="p">:</span> <span class="n">ih</span><span class="p">,</span><span class="n">ib</span><span class="p">,</span><span class="n">ie</span><span class="p">,</span><span class="n">jh</span><span class="p">,</span><span class="n">jb</span><span class="p">,</span><span class="n">je</span><span class="p">,</span><span class="n">kb</span><span class="p">,</span><span class="n">ke</span><span class="p">,</span><span class="n">kh</span><span class="p">,</span><span class="n">delta</span><span class="p">,</span><span class="n">zf</span><span class="p">,</span><span class="n">fkar</span><span class="p">,</span> <span class="p">&amp;</span>
<a name="ln-27"></a>         <span class="n">pi</span><span class="p">,</span><span class="n">ifnamopt</span><span class="p">,</span><span class="n">fname_options</span>
<a name="ln-28"></a>    <span class="k">use </span><span class="n">modmpi</span><span class="p">,</span> <span class="n">only</span> <span class="p">:</span> <span class="n">myid</span>
<a name="ln-29"></a>
<a name="ln-30"></a>    <span class="k">implicit none</span>
<a name="ln-31"></a>
<a name="ln-32"></a><span class="k">    </span><span class="kt">integer</span>   <span class="kd">::</span> <span class="n">i</span><span class="p">,</span> <span class="n">k</span>
<a name="ln-33"></a>
<a name="ln-34"></a>    <span class="kt">real</span> <span class="kd">::</span> <span class="n">ceps</span><span class="p">,</span> <span class="n">ch</span>
<a name="ln-35"></a>    <span class="kt">real</span> <span class="kd">::</span> <span class="n">mlen</span>
<a name="ln-36"></a>
<a name="ln-37"></a>    <span class="k">call </span><span class="n">subgridnamelist</span>
<a name="ln-38"></a>
<a name="ln-39"></a>    <span class="k">allocate</span><span class="p">(</span><span class="n">ekm</span><span class="p">(</span><span class="n">ib</span><span class="o">-</span><span class="n">ih</span><span class="p">:</span><span class="n">ie</span><span class="o">+</span><span class="n">ih</span><span class="p">,</span><span class="n">jb</span><span class="o">-</span><span class="n">jh</span><span class="p">:</span><span class="n">je</span><span class="o">+</span><span class="n">jh</span><span class="p">,</span><span class="n">kb</span><span class="o">-</span><span class="n">kh</span><span class="p">:</span><span class="n">ke</span><span class="o">+</span><span class="n">kh</span><span class="p">))</span>
<a name="ln-40"></a>    <span class="k">allocate</span><span class="p">(</span><span class="n">ekh</span><span class="p">(</span><span class="n">ib</span><span class="o">-</span><span class="n">ih</span><span class="p">:</span><span class="n">ie</span><span class="o">+</span><span class="n">ih</span><span class="p">,</span><span class="n">jb</span><span class="o">-</span><span class="n">jh</span><span class="p">:</span><span class="n">je</span><span class="o">+</span><span class="n">jh</span><span class="p">,</span><span class="n">kb</span><span class="o">-</span><span class="n">kh</span><span class="p">:</span><span class="n">ke</span><span class="o">+</span><span class="n">kh</span><span class="p">))</span>
<a name="ln-41"></a>    <span class="k">allocate</span><span class="p">(</span><span class="n">zlt</span><span class="p">(</span><span class="n">ib</span><span class="o">-</span><span class="n">ih</span><span class="p">:</span><span class="n">ie</span><span class="o">+</span><span class="n">ih</span><span class="p">,</span><span class="n">jb</span><span class="o">-</span><span class="n">jh</span><span class="p">:</span><span class="n">je</span><span class="o">+</span><span class="n">jh</span><span class="p">,</span><span class="n">kb</span><span class="p">:</span><span class="n">ke</span><span class="o">+</span><span class="n">kh</span><span class="p">))</span>
<a name="ln-42"></a>    <span class="k">allocate</span><span class="p">(</span><span class="n">sbdiss</span><span class="p">(</span><span class="n">ib</span><span class="o">-</span><span class="n">ih</span><span class="p">:</span><span class="n">ie</span><span class="o">+</span><span class="n">ih</span><span class="p">,</span><span class="n">jb</span><span class="o">-</span><span class="n">jh</span><span class="p">:</span><span class="n">je</span><span class="o">+</span><span class="n">jh</span><span class="p">,</span><span class="n">kb</span><span class="p">:</span><span class="n">ke</span><span class="o">+</span><span class="n">kh</span><span class="p">))</span>
<a name="ln-43"></a>    <span class="k">allocate</span><span class="p">(</span><span class="n">sbshr</span><span class="p">(</span><span class="n">ib</span><span class="o">-</span><span class="n">ih</span><span class="p">:</span><span class="n">ie</span><span class="o">+</span><span class="n">ih</span><span class="p">,</span><span class="n">jb</span><span class="o">-</span><span class="n">jh</span><span class="p">:</span><span class="n">je</span><span class="o">+</span><span class="n">jh</span><span class="p">,</span><span class="n">kb</span><span class="p">:</span><span class="n">ke</span><span class="o">+</span><span class="n">kh</span><span class="p">))</span>
<a name="ln-44"></a>    <span class="k">allocate</span><span class="p">(</span><span class="n">sbbuo</span><span class="p">(</span><span class="n">ib</span><span class="o">-</span><span class="n">ih</span><span class="p">:</span><span class="n">ie</span><span class="o">+</span><span class="n">ih</span><span class="p">,</span><span class="n">jb</span><span class="o">-</span><span class="n">jh</span><span class="p">:</span><span class="n">je</span><span class="o">+</span><span class="n">jh</span><span class="p">,</span><span class="n">kb</span><span class="p">:</span><span class="n">ke</span><span class="o">+</span><span class="n">kh</span><span class="p">))</span>
<a name="ln-45"></a>    <span class="k">allocate</span><span class="p">(</span><span class="n">csz</span><span class="p">(</span><span class="n">ib</span><span class="o">-</span><span class="n">ih</span><span class="p">:</span><span class="n">ie</span><span class="o">+</span><span class="n">ih</span><span class="p">,</span><span class="n">kb</span><span class="p">:</span><span class="n">ke</span><span class="o">+</span><span class="n">kh</span><span class="p">))</span>
<a name="ln-46"></a>    <span class="k">allocate</span><span class="p">(</span><span class="n">damp</span><span class="p">(</span><span class="n">ib</span><span class="p">:</span><span class="n">ie</span><span class="p">,</span><span class="n">jb</span><span class="p">:</span><span class="n">je</span><span class="p">,</span><span class="n">kb</span><span class="p">:</span><span class="n">ke</span><span class="p">))</span>
<a name="ln-47"></a>
<a name="ln-48"></a>
<a name="ln-49"></a>    <span class="n">damp</span> <span class="o">=</span> <span class="mf">1.</span> 
<a name="ln-50"></a>    <span class="n">cm</span> <span class="o">=</span> <span class="n">cf</span> <span class="o">/</span> <span class="p">(</span><span class="mf">2.</span> <span class="o">*</span> <span class="n">pi</span><span class="p">)</span> <span class="o">*</span> <span class="p">(</span><span class="mf">1.5</span><span class="o">*</span><span class="n">alpha_kolm</span><span class="p">)</span><span class="o">**</span><span class="p">(</span><span class="o">-</span><span class="mf">1.5</span><span class="p">)</span>
<a name="ln-51"></a>
<a name="ln-52"></a>    <span class="c">!     ch   = 2. * alpha_kolm / beta_kolm</span>
<a name="ln-53"></a>    <span class="n">ch</span>   <span class="o">=</span> <span class="n">prandtl</span>
<a name="ln-54"></a>    <span class="n">ch2</span>  <span class="o">=</span> <span class="n">ch</span><span class="o">-</span><span class="n">ch1</span>
<a name="ln-55"></a>
<a name="ln-56"></a>    <span class="n">ceps</span> <span class="o">=</span> <span class="mf">2.</span> <span class="o">*</span> <span class="n">pi</span> <span class="o">/</span> <span class="n">cf</span> <span class="o">*</span> <span class="p">(</span><span class="mf">1.5</span><span class="o">*</span><span class="n">alpha_kolm</span><span class="p">)</span><span class="o">**</span><span class="p">(</span><span class="o">-</span><span class="mf">1.5</span><span class="p">)</span>
<a name="ln-57"></a>    <span class="n">ce1</span>  <span class="o">=</span> <span class="p">(</span><span class="n">cn</span><span class="o">**</span><span class="mi">2</span><span class="p">)</span><span class="o">*</span> <span class="p">(</span><span class="n">cm</span><span class="o">/</span><span class="n">Rigc</span> <span class="o">-</span> <span class="n">ch1</span><span class="o">*</span><span class="n">cm</span> <span class="p">)</span>
<a name="ln-58"></a>    <span class="n">ce2</span>  <span class="o">=</span> <span class="n">ceps</span> <span class="o">-</span> <span class="n">ce1</span>
<a name="ln-59"></a>
<a name="ln-60"></a>    <span class="k">if</span><span class="p">(</span><span class="n">cs</span> <span class="o">==</span> <span class="o">-</span><span class="mf">1.</span><span class="p">)</span> <span class="k">then</span>
<a name="ln-61"></a><span class="k">       </span><span class="n">csz</span><span class="p">(:,:)</span>  <span class="o">=</span> <span class="p">(</span><span class="n">cm</span><span class="o">**</span><span class="mi">3</span><span class="o">/</span><span class="n">ceps</span><span class="p">)</span><span class="o">**</span><span class="mf">0.25</span>   <span class="c">!&lt; Smagorinsky constant</span>
<a name="ln-62"></a>    <span class="k">else</span>
<a name="ln-63"></a><span class="k">       </span><span class="n">csz</span><span class="p">(:,:)</span>  <span class="o">=</span> <span class="n">cs</span>
<a name="ln-64"></a>    <span class="k">end if</span>
<a name="ln-65"></a>
<a name="ln-66"></a>    <span class="c">!    if(lmason) then</span>
<a name="ln-67"></a>    <span class="c">!      do k = kb,ke+kh</span>
<a name="ln-68"></a>    <span class="c">!        do i=ib-ih,ie+ih</span>
<a name="ln-69"></a>    <span class="c">!          mlen   = (1. / (csz(i,k) * delta(i,k))**nmason + 1. / (fkar * zf(k))**nmason)**(-1./nmason)</span>
<a name="ln-70"></a>    <span class="c">!          csz(i,k) = mlen / delta(i,k)</span>
<a name="ln-71"></a>    <span class="c">!        end do</span>
<a name="ln-72"></a>    <span class="c">!      end do</span>
<a name="ln-73"></a>    <span class="c">!    end if</span>
<a name="ln-74"></a>
<a name="ln-75"></a>    <span class="k">if</span> <span class="p">(</span><span class="n">myid</span><span class="o">==</span><span class="mi">0</span><span class="p">)</span> <span class="k">then</span>
<a name="ln-76"></a><span class="k">       write</span> <span class="p">(</span><span class="mi">6</span><span class="p">,</span><span class="o">*</span><span class="p">)</span> <span class="s1">&#39;cf    = &#39;</span><span class="p">,</span><span class="n">cf</span>
<a name="ln-77"></a>       <span class="k">write</span> <span class="p">(</span><span class="mi">6</span><span class="p">,</span><span class="o">*</span><span class="p">)</span> <span class="s1">&#39;cm    = &#39;</span><span class="p">,</span><span class="n">cm</span>
<a name="ln-78"></a>       <span class="k">write</span> <span class="p">(</span><span class="mi">6</span><span class="p">,</span><span class="o">*</span><span class="p">)</span> <span class="s1">&#39;ch    = &#39;</span><span class="p">,</span><span class="n">ch</span>
<a name="ln-79"></a>       <span class="k">write</span> <span class="p">(</span><span class="mi">6</span><span class="p">,</span><span class="o">*</span><span class="p">)</span> <span class="s1">&#39;ch1   = &#39;</span><span class="p">,</span><span class="n">ch1</span>
<a name="ln-80"></a>       <span class="k">write</span> <span class="p">(</span><span class="mi">6</span><span class="p">,</span><span class="o">*</span><span class="p">)</span> <span class="s1">&#39;ch2   = &#39;</span><span class="p">,</span><span class="n">ch2</span>
<a name="ln-81"></a>       <span class="k">write</span> <span class="p">(</span><span class="mi">6</span><span class="p">,</span><span class="o">*</span><span class="p">)</span> <span class="s1">&#39;ceps  = &#39;</span><span class="p">,</span><span class="n">ceps</span>
<a name="ln-82"></a>       <span class="k">write</span> <span class="p">(</span><span class="mi">6</span><span class="p">,</span><span class="o">*</span><span class="p">)</span> <span class="s1">&#39;ceps1 = &#39;</span><span class="p">,</span><span class="n">ce1</span>
<a name="ln-83"></a>       <span class="k">write</span> <span class="p">(</span><span class="mi">6</span><span class="p">,</span><span class="o">*</span><span class="p">)</span> <span class="s1">&#39;ceps2 = &#39;</span><span class="p">,</span><span class="n">ce2</span>
<a name="ln-84"></a>       <span class="k">write</span> <span class="p">(</span><span class="mi">6</span><span class="p">,</span><span class="o">*</span><span class="p">)</span> <span class="s1">&#39;cs    = &#39;</span><span class="p">,</span><span class="n">cs</span>
<a name="ln-85"></a>       <span class="k">write</span> <span class="p">(</span><span class="mi">6</span><span class="p">,</span><span class="o">*</span><span class="p">)</span> <span class="s1">&#39;Rigc  = &#39;</span><span class="p">,</span><span class="n">Rigc</span>
<a name="ln-86"></a>    <span class="n">endif</span>
<a name="ln-87"></a>
<a name="ln-88"></a>  <span class="k">end subroutine </span><span class="n">initsubgrid</span>
<a name="ln-89"></a>
<a name="ln-90"></a>  <span class="k">subroutine </span><span class="n">subgridnamelist</span>
<a name="ln-91"></a>    <span class="k">use </span><span class="n">modglobal</span><span class="p">,</span> <span class="n">only</span> <span class="p">:</span> <span class="n">pi</span><span class="p">,</span><span class="n">ifnamopt</span><span class="p">,</span><span class="n">fname_options</span><span class="p">,</span><span class="n">lles</span>
<a name="ln-92"></a>    <span class="k">use </span><span class="n">modmpi</span><span class="p">,</span>    <span class="n">only</span> <span class="p">:</span> <span class="n">myid</span><span class="p">,</span> <span class="n">nprocs</span><span class="p">,</span> <span class="n">comm3d</span><span class="p">,</span> <span class="n">mpierr</span><span class="p">,</span> <span class="n">my_real</span><span class="p">,</span> <span class="n">mpi_logical</span><span class="p">,</span> <span class="n">mpi_integer</span>
<a name="ln-93"></a>
<a name="ln-94"></a>    <span class="k">implicit none</span>
<a name="ln-95"></a>
<a name="ln-96"></a><span class="k">    </span><span class="kt">integer</span> <span class="kd">::</span> <span class="n">ierr</span>
<a name="ln-97"></a>
<a name="ln-98"></a>    <span class="k">namelist</span><span class="o">/</span><span class="n">NAMSUBGRID</span><span class="o">/</span> <span class="p">&amp;</span>
<a name="ln-99"></a>         <span class="n">ldelta</span><span class="p">,</span><span class="n">lmason</span><span class="p">,</span> <span class="n">cf</span><span class="p">,</span><span class="n">cn</span><span class="p">,</span><span class="n">Rigc</span><span class="p">,</span><span class="n">Prandtl</span><span class="p">,</span><span class="n">lsmagorinsky</span><span class="p">,</span><span class="n">lvreman</span><span class="p">,</span><span class="n">loneeqn</span><span class="p">,</span><span class="n">c_vreman</span><span class="p">,</span><span class="n">cs</span><span class="p">,</span><span class="n">nmason</span><span class="p">,</span><span class="n">lbuoycorr</span>
<a name="ln-100"></a>
<a name="ln-101"></a>    <span class="k">if</span><span class="p">(</span><span class="n">myid</span><span class="o">==</span><span class="mi">0</span><span class="p">)</span><span class="k">then</span>
<a name="ln-102"></a><span class="k">       open</span><span class="p">(</span><span class="n">ifnamopt</span><span class="p">,</span><span class="k">file</span><span class="o">=</span><span class="n">fname_options</span><span class="p">,</span><span class="n">status</span><span class="o">=</span><span class="s1">&#39;old&#39;</span><span class="p">,</span><span class="n">iostat</span><span class="o">=</span><span class="n">ierr</span><span class="p">)</span>
<a name="ln-103"></a>       <span class="k">read</span> <span class="p">(</span><span class="n">ifnamopt</span><span class="p">,</span><span class="n">NAMSUBGRID</span><span class="p">,</span><span class="n">iostat</span><span class="o">=</span><span class="n">ierr</span><span class="p">)</span>
<a name="ln-104"></a>       <span class="k">if</span> <span class="p">(</span><span class="n">ierr</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">)</span> <span class="k">then</span>
<a name="ln-105"></a><span class="k">          write</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="o">*</span><span class="p">)</span> <span class="s1">&#39;ERROR: Problem in namoptions NAMSUBGRID&#39;</span>
<a name="ln-106"></a>          <span class="k">write</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="o">*</span><span class="p">)</span> <span class="s1">&#39;iostat error: &#39;</span><span class="p">,</span> <span class="n">ierr</span>
<a name="ln-107"></a>          <span class="k">stop </span><span class="mi">1</span>
<a name="ln-108"></a>       <span class="n">endif</span>
<a name="ln-109"></a>       <span class="k">write</span><span class="p">(</span><span class="mi">6</span> <span class="p">,</span><span class="n">NAMSUBGRID</span><span class="p">)</span>
<a name="ln-110"></a>       <span class="k">close</span><span class="p">(</span><span class="n">ifnamopt</span><span class="p">)</span>
<a name="ln-111"></a>    <span class="k">end if</span>
<a name="ln-112"></a>
<a name="ln-113"></a><span class="k">    call </span><span class="n">MPI_BCAST</span><span class="p">(</span><span class="n">ldelta</span>     <span class="p">,</span><span class="mi">1</span><span class="p">,</span><span class="n">MPI_LOGICAL</span><span class="p">,</span><span class="mi">0</span><span class="p">,</span><span class="n">comm3d</span><span class="p">,</span><span class="n">mpierr</span><span class="p">)</span>
<a name="ln-114"></a>    <span class="k">call </span><span class="n">MPI_BCAST</span><span class="p">(</span><span class="n">lmason</span>     <span class="p">,</span><span class="mi">1</span><span class="p">,</span><span class="n">MPI_LOGICAL</span><span class="p">,</span><span class="mi">0</span><span class="p">,</span><span class="n">comm3d</span><span class="p">,</span><span class="n">mpierr</span><span class="p">)</span>
<a name="ln-115"></a>    <span class="k">call </span><span class="n">MPI_BCAST</span><span class="p">(</span><span class="n">nmason</span>     <span class="p">,</span><span class="mi">1</span><span class="p">,</span><span class="n">MY_REAL</span>    <span class="p">,</span><span class="mi">0</span><span class="p">,</span><span class="n">comm3d</span><span class="p">,</span><span class="n">mpierr</span><span class="p">)</span>
<a name="ln-116"></a>    <span class="k">call </span><span class="n">MPI_BCAST</span><span class="p">(</span><span class="n">lsmagorinsky</span><span class="p">,</span><span class="mi">1</span><span class="p">,</span><span class="n">MPI_LOGICAL</span><span class="p">,</span><span class="mi">0</span><span class="p">,</span><span class="n">comm3d</span><span class="p">,</span><span class="n">mpierr</span><span class="p">)</span>
<a name="ln-117"></a>    <span class="k">call </span><span class="n">MPI_BCAST</span><span class="p">(</span><span class="n">lvreman</span>    <span class="p">,</span><span class="mi">1</span><span class="p">,</span><span class="n">MPI_LOGICAL</span><span class="p">,</span><span class="mi">0</span><span class="p">,</span><span class="n">comm3d</span><span class="p">,</span><span class="n">mpierr</span><span class="p">)</span>
<a name="ln-118"></a>    <span class="k">call </span><span class="n">MPI_BCAST</span><span class="p">(</span><span class="n">loneeqn</span>    <span class="p">,</span><span class="mi">1</span><span class="p">,</span><span class="n">MPI_LOGICAL</span><span class="p">,</span><span class="mi">0</span><span class="p">,</span><span class="n">comm3d</span><span class="p">,</span><span class="n">mpierr</span><span class="p">)</span>
<a name="ln-119"></a>    <span class="k">call </span><span class="n">MPI_BCAST</span><span class="p">(</span><span class="n">c_vreman</span>   <span class="p">,</span><span class="mi">1</span><span class="p">,</span><span class="n">MY_REAL</span>   <span class="p">,</span><span class="mi">0</span><span class="p">,</span><span class="n">comm3d</span><span class="p">,</span><span class="n">mpierr</span><span class="p">)</span>
<a name="ln-120"></a>    <span class="k">call </span><span class="n">MPI_BCAST</span><span class="p">(</span><span class="n">cs</span>         <span class="p">,</span><span class="mi">1</span><span class="p">,</span><span class="n">MY_REAL</span>   <span class="p">,</span><span class="mi">0</span><span class="p">,</span><span class="n">comm3d</span><span class="p">,</span><span class="n">mpierr</span><span class="p">)</span>
<a name="ln-121"></a>    <span class="k">call </span><span class="n">MPI_BCAST</span><span class="p">(</span><span class="n">cf</span>         <span class="p">,</span><span class="mi">1</span><span class="p">,</span><span class="n">MY_REAL</span>   <span class="p">,</span><span class="mi">0</span><span class="p">,</span><span class="n">comm3d</span><span class="p">,</span><span class="n">mpierr</span><span class="p">)</span>
<a name="ln-122"></a>    <span class="k">call </span><span class="n">MPI_BCAST</span><span class="p">(</span><span class="n">cn</span>         <span class="p">,</span><span class="mi">1</span><span class="p">,</span><span class="n">MY_REAL</span>   <span class="p">,</span><span class="mi">0</span><span class="p">,</span><span class="n">comm3d</span><span class="p">,</span><span class="n">mpierr</span><span class="p">)</span>
<a name="ln-123"></a>    <span class="k">call </span><span class="n">MPI_BCAST</span><span class="p">(</span><span class="n">Rigc</span>       <span class="p">,</span><span class="mi">1</span><span class="p">,</span><span class="n">MY_REAL</span>   <span class="p">,</span><span class="mi">0</span><span class="p">,</span><span class="n">comm3d</span><span class="p">,</span><span class="n">mpierr</span><span class="p">)</span>
<a name="ln-124"></a>    <span class="k">call </span><span class="n">MPI_BCAST</span><span class="p">(</span><span class="n">Prandtl</span>    <span class="p">,</span><span class="mi">1</span><span class="p">,</span><span class="n">MY_REAL</span>   <span class="p">,</span><span class="mi">0</span><span class="p">,</span><span class="n">comm3d</span><span class="p">,</span><span class="n">mpierr</span><span class="p">)</span>
<a name="ln-125"></a>    <span class="n">prandtli</span> <span class="o">=</span> <span class="mf">1.</span><span class="o">/</span><span class="n">Prandtl</span>
<a name="ln-126"></a>    <span class="k">write</span><span class="p">(</span><span class="o">*</span><span class="p">,</span><span class="o">*</span><span class="p">)</span> <span class="s1">&#39;1/prandtl&#39;</span><span class="p">,</span><span class="n">prandtli</span>
<a name="ln-127"></a>    <span class="k">if</span> <span class="p">((</span><span class="n">lsmagorinsky</span><span class="p">)</span> <span class="p">.</span><span class="nb">or</span><span class="p">.</span> <span class="p">(</span><span class="n">lvreman</span><span class="p">)</span> <span class="p">.</span><span class="nb">or</span><span class="p">.</span> <span class="p">(</span><span class="n">loneeqn</span><span class="p">))</span> <span class="k">then</span>
<a name="ln-128"></a><span class="k">       </span><span class="n">lles</span> <span class="o">=</span><span class="p">.</span><span class="n">true</span><span class="p">.</span>
<a name="ln-129"></a>    <span class="n">endif</span>
<a name="ln-130"></a>
<a name="ln-131"></a>
<a name="ln-132"></a>  <span class="k">end subroutine </span><span class="n">subgridnamelist</span>
<a name="ln-133"></a>
<a name="ln-134"></a>  <span class="k">subroutine </span><span class="n">subgrid</span>
<a name="ln-135"></a>
<a name="ln-136"></a>    <span class="c">! Diffusion subroutines</span>
<a name="ln-137"></a>    <span class="c">! Thijs Heus, Chiel van Heerwaarden, 15 June 2007</span>
<a name="ln-138"></a>
<a name="ln-139"></a>    <span class="k">use </span><span class="n">modglobal</span><span class="p">,</span> <span class="n">only</span> <span class="p">:</span> <span class="n">ih</span><span class="p">,</span><span class="n">jh</span><span class="p">,</span><span class="n">kh</span><span class="p">,</span><span class="n">nsv</span><span class="p">,</span> <span class="n">lmoist</span><span class="p">,</span><span class="n">lles</span><span class="p">,</span> <span class="n">ib</span><span class="p">,</span><span class="n">ie</span><span class="p">,</span><span class="n">jb</span><span class="p">,</span><span class="n">je</span><span class="p">,</span><span class="n">kb</span><span class="p">,</span><span class="n">ke</span><span class="p">,</span><span class="n">imax</span><span class="p">,</span><span class="n">jmax</span><span class="p">,</span><span class="n">kmax</span><span class="p">,&amp;</span>
<a name="ln-140"></a>         <span class="n">ihc</span><span class="p">,</span><span class="n">jhc</span><span class="p">,</span><span class="n">khc</span><span class="p">,</span><span class="n">ltempeq</span>
<a name="ln-141"></a>    <span class="k">use </span><span class="n">modfields</span><span class="p">,</span> <span class="n">only</span> <span class="p">:</span> <span class="n">up</span><span class="p">,</span><span class="n">vp</span><span class="p">,</span><span class="n">wp</span><span class="p">,</span><span class="n">e12p</span><span class="p">,</span><span class="n">thl0</span><span class="p">,</span><span class="n">thlp</span><span class="p">,</span><span class="n">qt0</span><span class="p">,</span><span class="n">qtp</span><span class="p">,</span><span class="n">sv0</span><span class="p">,</span><span class="n">svp</span><span class="p">,</span><span class="n">shear</span>
<a name="ln-142"></a>    <span class="k">use </span><span class="n">modsurfdata</span><span class="p">,</span><span class="n">only</span> <span class="p">:</span> <span class="n">ustar</span><span class="p">,</span><span class="n">thlflux</span><span class="p">,</span><span class="n">qtflux</span><span class="p">,</span><span class="n">svflux</span>
<a name="ln-143"></a>    <span class="k">use </span><span class="n">modmpi</span><span class="p">,</span> <span class="n">only</span> <span class="p">:</span> <span class="n">myid</span><span class="p">,</span> <span class="n">comm3d</span><span class="p">,</span> <span class="n">mpierr</span><span class="p">,</span> <span class="n">my_real</span><span class="p">,</span><span class="n">nprocs</span>
<a name="ln-144"></a>    <span class="k">implicit none</span>
<a name="ln-145"></a><span class="k">    </span><span class="kt">integer </span><span class="n">n</span><span class="p">,</span> <span class="n">proces</span>
<a name="ln-146"></a>
<a name="ln-147"></a>    <span class="k">call </span><span class="n">closure</span>
<a name="ln-148"></a>    <span class="k">call </span><span class="n">diffu</span><span class="p">(</span><span class="n">up</span><span class="p">)</span>
<a name="ln-149"></a>    <span class="k">call </span><span class="n">diffv</span><span class="p">(</span><span class="n">vp</span><span class="p">)</span>
<a name="ln-150"></a>    <span class="k">call </span><span class="n">diffw</span><span class="p">(</span><span class="n">wp</span><span class="p">)</span>
<a name="ln-151"></a>
<a name="ln-152"></a>    <span class="k">if</span> <span class="p">(</span><span class="n">loneeqn</span><span class="p">)</span> <span class="k">call </span><span class="n">diffe</span><span class="p">(</span><span class="n">e12p</span><span class="p">)</span>   <span class="c">! only in case of LES with 1-eq subgrid model</span>
<a name="ln-153"></a>
<a name="ln-154"></a>    <span class="k">if</span> <span class="p">(</span><span class="n">ltempeq</span><span class="p">)</span> <span class="k">call </span><span class="n">diffc</span><span class="p">(</span><span class="n">ih</span><span class="p">,</span><span class="n">jh</span><span class="p">,</span><span class="n">kh</span><span class="p">,</span><span class="n">thl0</span><span class="p">,</span><span class="n">thlp</span><span class="p">)</span>
<a name="ln-155"></a>    <span class="k">if</span> <span class="p">(</span><span class="n">lmoist</span><span class="p">)</span>  <span class="k">call </span><span class="n">diffc</span><span class="p">(</span><span class="n">ih</span><span class="p">,</span><span class="n">jh</span><span class="p">,</span><span class="n">kh</span><span class="p">,</span><span class="n">qt0</span><span class="p">,</span><span class="n">qtp</span><span class="p">)</span>
<a name="ln-156"></a>    <span class="k">do </span><span class="n">n</span><span class="o">=</span><span class="mi">1</span><span class="p">,</span><span class="n">nsv</span>
<a name="ln-157"></a>       <span class="k">call </span><span class="n">diffc</span><span class="p">(</span><span class="n">ihc</span><span class="p">,</span><span class="n">jhc</span><span class="p">,</span><span class="n">khc</span><span class="p">,</span><span class="n">sv0</span><span class="p">(:,:,:,</span><span class="n">n</span><span class="p">),</span><span class="n">svp</span><span class="p">(:,:,:,</span><span class="n">n</span><span class="p">))</span>
<a name="ln-158"></a>    <span class="k">end do</span>
<a name="ln-159"></a><span class="k">    if</span> <span class="p">(</span><span class="n">loneeqn</span><span class="p">)</span> <span class="k">call </span><span class="n">sources</span>       <span class="c">! only in case of LES with 1-eq subgrid model</span>
<a name="ln-160"></a>  <span class="k">end subroutine</span>
<a name="ln-161"></a>
<a name="ln-162"></a><span class="k">  subroutine </span><span class="n">exitsubgrid</span>
<a name="ln-163"></a>    <span class="k">implicit none</span>
<a name="ln-164"></a><span class="k">    deallocate</span><span class="p">(</span><span class="n">ekm</span><span class="p">,</span><span class="n">ekh</span><span class="p">,</span><span class="n">zlt</span><span class="p">,</span><span class="n">sbdiss</span><span class="p">,</span><span class="n">sbbuo</span><span class="p">,</span><span class="n">sbshr</span><span class="p">,</span><span class="n">csz</span><span class="p">)</span>
<a name="ln-165"></a>  <span class="k">end subroutine </span><span class="n">exitsubgrid</span>
<a name="ln-166"></a>
<a name="ln-167"></a>  <span class="k">subroutine </span><span class="n">closure</span>
<a name="ln-168"></a>
<a name="ln-169"></a>    <span class="c">!-----------------------------------------------------------------|</span>
<a name="ln-170"></a>    <span class="c">!                                                                 |</span>
<a name="ln-171"></a>    <span class="c">!*** *closure*  calculates K-coefficients                         |</span>
<a name="ln-172"></a>    <span class="c">!                                                                 |</span>
<a name="ln-173"></a>    <span class="c">!      Hans Cuijpers   I.M.A.U.   06/01/1995                      |</span>
<a name="ln-174"></a>    <span class="c">!                                                                 |</span>
<a name="ln-175"></a>    <span class="c">!     purpose.                                                    |</span>
<a name="ln-176"></a>    <span class="c">!     --------                                                    |</span>
<a name="ln-177"></a>    <span class="c">!                                                                 |</span>
<a name="ln-178"></a>    <span class="c">!     All the K-closure factors are calculated.                   |</span>
<a name="ln-179"></a>    <span class="c">!                                                                 |</span>
<a name="ln-180"></a>    <span class="c">!     ekm(i,j,k) = k sub m : for velocity-closure                 |</span>
<a name="ln-181"></a>    <span class="c">!     ekh(i,j,k) = k sub h : for temperture-closure               |</span>
<a name="ln-182"></a>    <span class="c">!     ekh(i,j,k) = k sub h = k sub c : for concentration-closure  |</span>
<a name="ln-183"></a>    <span class="c">!                                                                 |</span>
<a name="ln-184"></a>    <span class="c">!     We will use the next model for these factors:               |</span>
<a name="ln-185"></a>    <span class="c">!                                                                 |</span>
<a name="ln-186"></a>    <span class="c">!     k sub m = 0.12 * l * sqrt(E)                                |</span>
<a name="ln-187"></a>    <span class="c">!                                                                 |</span>
<a name="ln-188"></a>    <span class="c">!     k sub h = k sub c = ( 1 + (2*l)/D ) * k sub m               |</span>
<a name="ln-189"></a>    <span class="c">!                                                                 |</span>
<a name="ln-190"></a>    <span class="c">!           where : l = mixing length  ( in model = z2 )          |</span>
<a name="ln-191"></a>    <span class="c">!                   E = subgrid energy                            |</span>
<a name="ln-192"></a>    <span class="c">!                   D = grid-size distance                        |</span>
<a name="ln-193"></a>    <span class="c">!                                                                 |</span>
<a name="ln-194"></a>    <span class="c">!**   interface.                                                  |</span>
<a name="ln-195"></a>    <span class="c">!     ----------                                                  |</span>
<a name="ln-196"></a>    <span class="c">!                                                                 |</span>
<a name="ln-197"></a>    <span class="c">!             *closure* is called from *program*.                 |</span>
<a name="ln-198"></a>    <span class="c">!                                                                 |</span>
<a name="ln-199"></a>    <span class="c">!-----------------------------------------------------------------|</span>
<a name="ln-200"></a>
<a name="ln-201"></a>    <span class="k">use </span><span class="n">modglobal</span><span class="p">,</span>   <span class="n">only</span> <span class="p">:</span> <span class="n">ib</span><span class="p">,</span><span class="n">ie</span><span class="p">,</span><span class="n">jb</span><span class="p">,</span><span class="n">je</span><span class="p">,</span><span class="n">kb</span><span class="p">,</span><span class="n">ke</span><span class="p">,</span><span class="n">kh</span><span class="p">,</span><span class="n">ih</span><span class="p">,</span><span class="n">jh</span><span class="p">,</span><span class="n">jmax</span><span class="p">,</span><span class="n">delta</span><span class="p">,</span><span class="n">ekmin</span><span class="p">,</span><span class="n">grav</span><span class="p">,</span> <span class="n">zf</span><span class="p">,</span> <span class="n">fkar</span><span class="p">,</span><span class="n">jgb</span><span class="p">,</span><span class="n">jge</span><span class="p">,&amp;</span>
<a name="ln-202"></a>         <span class="n">dxf</span><span class="p">,</span><span class="n">dxf2</span><span class="p">,</span><span class="n">dxhi</span><span class="p">,</span><span class="n">dxfi</span><span class="p">,</span><span class="n">dy2</span><span class="p">,</span><span class="n">dyi</span><span class="p">,</span><span class="n">dyiq</span><span class="p">,</span><span class="n">dzf</span><span class="p">,</span><span class="n">dzf2</span><span class="p">,</span><span class="n">dzfi</span><span class="p">,</span><span class="n">dzhi</span><span class="p">,</span><span class="n">rk3step</span><span class="p">,</span><span class="n">rslabs</span><span class="p">,</span> <span class="p">&amp;</span>
<a name="ln-203"></a>         <span class="n">numol</span><span class="p">,</span><span class="n">numoli</span><span class="p">,</span><span class="n">prandtlmoli</span><span class="p">,</span><span class="n">lles</span><span class="p">,</span> <span class="n">rk3step</span><span class="p">,</span><span class="n">dxfiq</span><span class="p">,</span><span class="n">dzfiq</span><span class="p">,</span><span class="n">lbuoyancy</span><span class="p">,</span><span class="n">dzh</span>
<a name="ln-204"></a>    <span class="k">use </span><span class="n">modfields</span><span class="p">,</span>   <span class="n">only</span> <span class="p">:</span> <span class="n">dthvdz</span><span class="p">,</span><span class="n">e120</span><span class="p">,</span><span class="n">u0</span><span class="p">,</span><span class="n">v0</span><span class="p">,</span><span class="n">w0</span><span class="p">,</span><span class="n">thl0</span><span class="p">,</span><span class="n">mindist</span><span class="p">,</span><span class="n">wall</span><span class="p">,</span><span class="n">shear</span>
<a name="ln-205"></a>    <span class="k">use </span><span class="n">modsurfdata</span><span class="p">,</span> <span class="n">only</span> <span class="p">:</span> <span class="n">dudz</span><span class="p">,</span><span class="n">dvdz</span><span class="p">,</span><span class="n">thvs</span><span class="p">,</span><span class="n">ustar</span>
<a name="ln-206"></a>    <span class="k">use </span><span class="n">modmpi</span><span class="p">,</span>    <span class="n">only</span> <span class="p">:</span> <span class="n">excjs</span><span class="p">,</span> <span class="n">myid</span><span class="p">,</span> <span class="n">nprocs</span><span class="p">,</span> <span class="n">comm3d</span><span class="p">,</span> <span class="n">mpierr</span><span class="p">,</span> <span class="n">my_real</span><span class="p">,</span><span class="n">mpi_sum</span><span class="p">,</span><span class="n">slabsumi</span>
<a name="ln-207"></a>    <span class="k">use </span><span class="n">modboundary</span><span class="p">,</span> <span class="n">only</span> <span class="p">:</span> <span class="n">closurebc</span> 
<a name="ln-208"></a>    <span class="k">use </span><span class="n">modinletdata</span><span class="p">,</span> <span class="n">only</span> <span class="p">:</span> <span class="n">utaui</span>
<a name="ln-209"></a>    <span class="k">implicit none</span>
<a name="ln-210"></a>
<a name="ln-211"></a><span class="k">    </span><span class="kt">real</span><span class="p">,</span> <span class="k">dimension</span><span class="p">(</span><span class="n">ib</span><span class="p">:</span><span class="n">ie</span><span class="p">)</span> <span class="kd">::</span> <span class="n">shearbot</span>
<a name="ln-212"></a>    <span class="kt">real</span>    <span class="kd">::</span> <span class="n">strain2</span><span class="p">,</span><span class="n">mlen</span><span class="p">,</span><span class="n">uhor</span><span class="p">,</span><span class="n">distplus</span><span class="p">,</span><span class="n">utaubot</span><span class="p">,</span><span class="n">a11</span><span class="p">,</span><span class="n">a12</span><span class="p">,</span><span class="n">a13</span><span class="p">,</span> <span class="p">&amp;</span>
<a name="ln-213"></a>         <span class="n">a21</span><span class="p">,</span><span class="n">a22</span><span class="p">,</span><span class="n">a23</span><span class="p">,</span><span class="n">a31</span><span class="p">,</span><span class="n">a32</span><span class="p">,</span><span class="n">a33</span><span class="p">,</span><span class="n">aa</span><span class="p">,</span><span class="n">b11</span><span class="p">,</span><span class="n">b12</span><span class="p">,</span><span class="n">b13</span><span class="p">,</span><span class="n">b21</span><span class="p">,</span><span class="n">b22</span><span class="p">,</span> <span class="p">&amp;</span>
<a name="ln-214"></a>         <span class="n">b23</span><span class="p">,</span><span class="n">b33</span><span class="p">,</span><span class="n">bb</span><span class="p">,</span><span class="n">const</span><span class="p">,</span><span class="n">const2</span>
<a name="ln-215"></a>    <span class="kt">integer</span> <span class="kd">::</span> <span class="n">i</span><span class="p">,</span><span class="n">j</span><span class="p">,</span><span class="n">k</span><span class="p">,</span><span class="n">kp</span><span class="p">,</span><span class="n">km</span><span class="p">,</span><span class="n">jp</span><span class="p">,</span><span class="n">jm</span><span class="p">,</span><span class="n">im</span><span class="p">,</span><span class="n">ip</span><span class="p">,</span><span class="n">iw</span><span class="p">,</span><span class="n">jw</span><span class="p">,</span><span class="n">kw</span><span class="p">,</span><span class="n">c1</span><span class="p">,</span><span class="n">c2</span>
<a name="ln-216"></a>
<a name="ln-217"></a>    <span class="c">!  if (lles  .and. rk3step == 1) then        ! compute ekm and ekh only once in complete RK-cycle</span>
<a name="ln-218"></a>    <span class="k">if</span><span class="p">(</span><span class="n">lsmagorinsky</span><span class="p">)</span> <span class="k">then</span>
<a name="ln-219"></a><span class="k">       do </span><span class="n">k</span> <span class="o">=</span> <span class="n">kb</span><span class="p">,</span><span class="n">ke</span>
<a name="ln-220"></a>          <span class="n">kp</span><span class="o">=</span><span class="n">k</span><span class="o">+</span><span class="mi">1</span>
<a name="ln-221"></a>          <span class="n">km</span><span class="o">=</span><span class="n">k</span><span class="o">-</span><span class="mi">1</span>
<a name="ln-222"></a>          <span class="k">do </span><span class="n">i</span> <span class="o">=</span> <span class="n">ib</span><span class="p">,</span><span class="n">ie</span>
<a name="ln-223"></a>             <span class="n">ip</span><span class="o">=</span><span class="n">i</span><span class="o">+</span><span class="mi">1</span>
<a name="ln-224"></a>             <span class="n">im</span><span class="o">=</span><span class="n">i</span><span class="o">-</span><span class="mi">1</span>
<a name="ln-225"></a>             <span class="n">mlen</span>        <span class="o">=</span> <span class="n">csz</span><span class="p">(</span><span class="n">i</span><span class="p">,</span><span class="n">k</span><span class="p">)</span> <span class="o">*</span> <span class="n">delta</span><span class="p">(</span><span class="n">i</span><span class="p">,</span><span class="n">k</span><span class="p">)</span>
<a name="ln-226"></a>             <span class="k">do </span><span class="n">j</span> <span class="o">=</span> <span class="n">jb</span><span class="p">,</span><span class="n">je</span>
<a name="ln-227"></a>                <span class="n">jp</span><span class="o">=</span><span class="n">j</span><span class="o">+</span><span class="mi">1</span>
<a name="ln-228"></a>                <span class="n">jm</span><span class="o">=</span><span class="n">j</span><span class="o">-</span><span class="mi">1</span>
<a name="ln-229"></a>
<a name="ln-230"></a>                <span class="n">iw</span> <span class="o">=</span> <span class="n">wall</span><span class="p">(</span><span class="n">i</span><span class="p">,</span><span class="n">j</span><span class="p">,</span><span class="n">k</span><span class="p">,</span><span class="mi">1</span><span class="p">)</span>   <span class="c">! indices of closest wall</span>
<a name="ln-231"></a>                <span class="n">jw</span> <span class="o">=</span> <span class="n">wall</span><span class="p">(</span><span class="n">i</span><span class="p">,</span><span class="n">j</span><span class="p">,</span><span class="n">k</span><span class="p">,</span><span class="mi">2</span><span class="p">)</span><span class="o">-</span><span class="n">myid</span><span class="o">*</span><span class="n">jmax</span>   <span class="c">! indices of closest wall in local j-index</span>
<a name="ln-232"></a>                <span class="n">kw</span> <span class="o">=</span> <span class="n">wall</span><span class="p">(</span><span class="n">i</span><span class="p">,</span><span class="n">j</span><span class="p">,</span><span class="n">k</span><span class="p">,</span><span class="mi">3</span><span class="p">)</span>
<a name="ln-233"></a>                <span class="n">c1</span> <span class="o">=</span> <span class="n">wall</span><span class="p">(</span><span class="n">i</span><span class="p">,</span><span class="n">j</span><span class="p">,</span><span class="n">k</span><span class="p">,</span><span class="mi">4</span><span class="p">)</span>   <span class="c">! shear stress component</span>
<a name="ln-234"></a>                <span class="n">c2</span> <span class="o">=</span> <span class="n">wall</span><span class="p">(</span><span class="n">i</span><span class="p">,</span><span class="n">j</span><span class="p">,</span><span class="n">k</span><span class="p">,</span><span class="mi">5</span><span class="p">)</span>   <span class="c">! shear stress component</span>
<a name="ln-235"></a>                <span class="k">if</span> <span class="p">((</span><span class="n">jw</span> <span class="o">&gt;=</span> <span class="n">jb</span><span class="o">-</span><span class="mi">1</span><span class="p">)</span> <span class="p">.</span><span class="nb">and</span><span class="p">.</span> <span class="p">(</span><span class="n">jw</span> <span class="o">&lt;=</span> <span class="n">je</span><span class="o">+</span><span class="mi">1</span><span class="p">))</span> <span class="k">then</span>      <span class="c">! check if jw is within the halo of this proc</span>
<a name="ln-236"></a>                   <span class="c">!write(*,&#39;(A,E9.2,A,E9.2,A,E9.2,A,E9.2)&#39;) &#39;component1:&#39;, c1, &#39;component2:&#39;, c2, &#39;shear c1:&#39;, shear(iw,jw,kw,c1), &#39;shear c2:&#39;, shear(iw,jw,kw,c2)</span>
<a name="ln-237"></a>                   <span class="n">distplus</span> <span class="o">=</span> <span class="n">mindist</span><span class="p">(</span><span class="n">i</span><span class="p">,</span><span class="n">j</span><span class="p">,</span><span class="n">k</span><span class="p">)</span><span class="o">*</span><span class="nb">sqrt</span><span class="p">(</span><span class="nb">abs</span><span class="p">(</span><span class="n">shear</span><span class="p">(</span><span class="n">iw</span><span class="p">,</span><span class="n">jw</span><span class="p">,</span><span class="n">kw</span><span class="p">,</span><span class="n">c1</span><span class="p">))</span><span class="o">+</span><span class="nb">abs</span><span class="p">(</span><span class="n">shear</span><span class="p">(</span><span class="n">iw</span><span class="p">,</span><span class="n">jw</span><span class="p">,</span><span class="n">kw</span><span class="p">,</span><span class="n">c2</span><span class="p">)))</span><span class="o">*</span><span class="n">numoli</span>
<a name="ln-238"></a>                   <span class="n">damp</span><span class="p">(</span><span class="n">i</span><span class="p">,</span><span class="n">j</span><span class="p">,</span><span class="n">k</span><span class="p">)</span> <span class="o">=</span> <span class="nb">sqrt</span><span class="p">(</span><span class="mf">1.</span> <span class="o">-</span> <span class="nb">exp</span><span class="p">((</span><span class="o">-</span><span class="n">distplus</span><span class="o">*</span><span class="mf">0.04</span><span class="p">)</span><span class="o">**</span><span class="mf">3.</span><span class="p">))</span>            <span class="c">! Wall-damping according to Piomelli</span>
<a name="ln-239"></a>                   <span class="c">!    write(*,&#39;(A,2(1pE9.2))&#39;) &#39;damp, distplus&#39;, damp(i,j,k), distplus</span>
<a name="ln-240"></a>                <span class="k">else</span>
<a name="ln-241"></a><span class="k">                   </span><span class="n">damp</span><span class="p">(</span><span class="n">i</span><span class="p">,</span><span class="n">j</span><span class="p">,</span><span class="n">k</span><span class="p">)</span> <span class="o">=</span> <span class="mf">1.</span>
<a name="ln-242"></a>                <span class="k">end if</span>
<a name="ln-243"></a>
<a name="ln-244"></a>
<a name="ln-245"></a><span class="k">                   </span><span class="n">strain2</span> <span class="o">=</span>  <span class="p">(</span> <span class="p">&amp;</span>
<a name="ln-246"></a>                        <span class="p">((</span><span class="n">u0</span><span class="p">(</span><span class="n">ip</span><span class="p">,</span><span class="n">j</span><span class="p">,</span><span class="n">k</span><span class="p">)</span><span class="o">-</span><span class="n">u0</span><span class="p">(</span><span class="n">i</span><span class="p">,</span><span class="n">j</span><span class="p">,</span><span class="n">k</span><span class="p">))</span>    <span class="o">*</span><span class="n">dxfi</span><span class="p">(</span><span class="n">i</span><span class="p">)</span>        <span class="p">)</span><span class="o">**</span><span class="mi">2</span>    <span class="o">+</span> <span class="p">&amp;</span>
<a name="ln-247"></a>                        <span class="p">((</span><span class="n">v0</span><span class="p">(</span><span class="n">i</span><span class="p">,</span><span class="n">jp</span><span class="p">,</span><span class="n">k</span><span class="p">)</span><span class="o">-</span><span class="n">v0</span><span class="p">(</span><span class="n">i</span><span class="p">,</span><span class="n">j</span><span class="p">,</span><span class="n">k</span><span class="p">))</span>    <span class="o">*</span><span class="n">dyi</span>        <span class="p">)</span><span class="o">**</span><span class="mi">2</span>    <span class="o">+</span> <span class="p">&amp;</span>
<a name="ln-248"></a>                        <span class="p">((</span><span class="n">w0</span><span class="p">(</span><span class="n">i</span><span class="p">,</span><span class="n">j</span><span class="p">,</span><span class="n">kp</span><span class="p">)</span><span class="o">-</span><span class="n">w0</span><span class="p">(</span><span class="n">i</span><span class="p">,</span><span class="n">j</span><span class="p">,</span><span class="n">k</span><span class="p">))</span>    <span class="o">*</span><span class="n">dzfi</span><span class="p">(</span><span class="n">k</span><span class="p">)</span>     <span class="p">)</span><span class="o">**</span><span class="mi">2</span>    <span class="p">)</span>
<a name="ln-249"></a>
<a name="ln-250"></a>                   <span class="n">strain2</span> <span class="o">=</span> <span class="n">strain2</span> <span class="o">+</span> <span class="mf">0.125</span> <span class="o">*</span> <span class="p">(</span> <span class="p">&amp;</span>
<a name="ln-251"></a>                        <span class="p">((</span><span class="n">w0</span><span class="p">(</span><span class="n">i</span><span class="p">,</span><span class="n">j</span><span class="p">,</span><span class="n">kp</span><span class="p">)</span><span class="o">-</span><span class="n">w0</span><span class="p">(</span><span class="n">im</span><span class="p">,</span><span class="n">j</span><span class="p">,</span><span class="n">kp</span><span class="p">))</span>   <span class="o">*</span><span class="n">dxhi</span><span class="p">(</span><span class="n">i</span><span class="p">)</span>     <span class="o">+</span> <span class="p">&amp;</span>
<a name="ln-252"></a>                        <span class="p">(</span><span class="n">u0</span><span class="p">(</span><span class="n">i</span><span class="p">,</span><span class="n">j</span><span class="p">,</span><span class="n">kp</span><span class="p">)</span><span class="o">-</span><span class="n">u0</span><span class="p">(</span><span class="n">i</span><span class="p">,</span><span class="n">j</span><span class="p">,</span><span class="n">k</span><span class="p">))</span>      <span class="o">*</span><span class="n">dzhi</span><span class="p">(</span><span class="n">kp</span><span class="p">)</span>  <span class="p">)</span><span class="o">**</span><span class="mi">2</span>    <span class="o">+</span> <span class="p">&amp;</span>
<a name="ln-253"></a>                        <span class="p">((</span><span class="n">w0</span><span class="p">(</span><span class="n">i</span><span class="p">,</span><span class="n">j</span><span class="p">,</span><span class="n">k</span><span class="p">)</span><span class="o">-</span><span class="n">w0</span><span class="p">(</span><span class="n">im</span><span class="p">,</span><span class="n">j</span><span class="p">,</span><span class="n">k</span><span class="p">))</span>     <span class="o">*</span><span class="n">dxhi</span><span class="p">(</span><span class="n">i</span><span class="p">)</span>     <span class="o">+</span> <span class="p">&amp;</span>
<a name="ln-254"></a>                        <span class="p">(</span><span class="n">u0</span><span class="p">(</span><span class="n">i</span><span class="p">,</span><span class="n">j</span><span class="p">,</span><span class="n">k</span><span class="p">)</span><span class="o">-</span><span class="n">u0</span><span class="p">(</span><span class="n">i</span><span class="p">,</span><span class="n">j</span><span class="p">,</span><span class="n">km</span><span class="p">))</span>      <span class="o">*</span><span class="n">dzhi</span><span class="p">(</span><span class="n">k</span><span class="p">)</span>   <span class="p">)</span><span class="o">**</span><span class="mi">2</span>    <span class="o">+</span> <span class="p">&amp;</span>
<a name="ln-255"></a>                        <span class="p">((</span><span class="n">w0</span><span class="p">(</span><span class="n">ip</span><span class="p">,</span><span class="n">j</span><span class="p">,</span><span class="n">k</span><span class="p">)</span><span class="o">-</span><span class="n">w0</span><span class="p">(</span><span class="n">i</span><span class="p">,</span><span class="n">j</span><span class="p">,</span><span class="n">k</span><span class="p">))</span>     <span class="o">*</span><span class="n">dxhi</span><span class="p">(</span><span class="n">ip</span><span class="p">)</span>     <span class="o">+</span> <span class="p">&amp;</span>
<a name="ln-256"></a>                        <span class="p">(</span><span class="n">u0</span><span class="p">(</span><span class="n">ip</span><span class="p">,</span><span class="n">j</span><span class="p">,</span><span class="n">k</span><span class="p">)</span><span class="o">-</span><span class="n">u0</span><span class="p">(</span><span class="n">ip</span><span class="p">,</span><span class="n">j</span><span class="p">,</span><span class="n">km</span><span class="p">))</span>    <span class="o">*</span><span class="n">dzhi</span><span class="p">(</span><span class="n">k</span><span class="p">)</span>   <span class="p">)</span><span class="o">**</span><span class="mi">2</span>    <span class="o">+</span> <span class="p">&amp;</span>
<a name="ln-257"></a>                        <span class="p">((</span><span class="n">w0</span><span class="p">(</span><span class="n">ip</span><span class="p">,</span><span class="n">j</span><span class="p">,</span><span class="n">kp</span><span class="p">)</span><span class="o">-</span><span class="n">w0</span><span class="p">(</span><span class="n">i</span><span class="p">,</span><span class="n">j</span><span class="p">,</span><span class="n">kp</span><span class="p">))</span>   <span class="o">*</span><span class="n">dxhi</span><span class="p">(</span><span class="n">ip</span><span class="p">)</span>     <span class="o">+</span> <span class="p">&amp;</span>
<a name="ln-258"></a>                        <span class="p">(</span><span class="n">u0</span><span class="p">(</span><span class="n">ip</span><span class="p">,</span><span class="n">j</span><span class="p">,</span><span class="n">kp</span><span class="p">)</span><span class="o">-</span><span class="n">u0</span><span class="p">(</span><span class="n">ip</span><span class="p">,</span><span class="n">j</span><span class="p">,</span><span class="n">k</span><span class="p">))</span>    <span class="o">*</span><span class="n">dzhi</span><span class="p">(</span><span class="n">kp</span><span class="p">)</span>  <span class="p">)</span><span class="o">**</span><span class="mi">2</span>    <span class="p">)</span>
<a name="ln-259"></a>
<a name="ln-260"></a>                   <span class="n">strain2</span> <span class="o">=</span> <span class="n">strain2</span> <span class="o">+</span> <span class="mf">0.125</span> <span class="o">*</span> <span class="p">(</span> <span class="p">&amp;</span>
<a name="ln-261"></a>                        <span class="p">((</span><span class="n">u0</span><span class="p">(</span><span class="n">i</span><span class="p">,</span><span class="n">jp</span><span class="p">,</span><span class="n">k</span><span class="p">)</span><span class="o">-</span><span class="n">u0</span><span class="p">(</span><span class="n">i</span><span class="p">,</span><span class="n">j</span><span class="p">,</span><span class="n">k</span><span class="p">))</span>     <span class="o">*</span><span class="n">dyi</span>     <span class="o">+</span> <span class="p">&amp;</span>
<a name="ln-262"></a>                        <span class="p">(</span><span class="n">v0</span><span class="p">(</span><span class="n">i</span><span class="p">,</span><span class="n">jp</span><span class="p">,</span><span class="n">k</span><span class="p">)</span><span class="o">-</span><span class="n">v0</span><span class="p">(</span><span class="n">im</span><span class="p">,</span><span class="n">jp</span><span class="p">,</span><span class="n">k</span><span class="p">))</span>    <span class="o">*</span><span class="n">dxhi</span><span class="p">(</span><span class="n">i</span><span class="p">)</span>        <span class="p">)</span><span class="o">**</span><span class="mi">2</span>    <span class="o">+</span> <span class="p">&amp;</span>
<a name="ln-263"></a>                        <span class="p">((</span><span class="n">u0</span><span class="p">(</span><span class="n">i</span><span class="p">,</span><span class="n">j</span><span class="p">,</span><span class="n">k</span><span class="p">)</span><span class="o">-</span><span class="n">u0</span><span class="p">(</span><span class="n">i</span><span class="p">,</span><span class="n">jm</span><span class="p">,</span><span class="n">k</span><span class="p">))</span>     <span class="o">*</span><span class="n">dyi</span>     <span class="o">+</span> <span class="p">&amp;</span>
<a name="ln-264"></a>                        <span class="p">(</span><span class="n">v0</span><span class="p">(</span><span class="n">i</span><span class="p">,</span><span class="n">j</span><span class="p">,</span><span class="n">k</span><span class="p">)</span><span class="o">-</span><span class="n">v0</span><span class="p">(</span><span class="n">im</span><span class="p">,</span><span class="n">j</span><span class="p">,</span><span class="n">k</span><span class="p">))</span>      <span class="o">*</span><span class="n">dxhi</span><span class="p">(</span><span class="n">i</span><span class="p">)</span>        <span class="p">)</span><span class="o">**</span><span class="mi">2</span>    <span class="o">+</span> <span class="p">&amp;</span>
<a name="ln-265"></a>                        <span class="p">((</span><span class="n">u0</span><span class="p">(</span><span class="n">ip</span><span class="p">,</span><span class="n">j</span><span class="p">,</span><span class="n">k</span><span class="p">)</span><span class="o">-</span><span class="n">u0</span><span class="p">(</span><span class="n">ip</span><span class="p">,</span><span class="n">jm</span><span class="p">,</span><span class="n">k</span><span class="p">))</span>   <span class="o">*</span><span class="n">dyi</span>     <span class="o">+</span> <span class="p">&amp;</span>
<a name="ln-266"></a>                        <span class="p">(</span><span class="n">v0</span><span class="p">(</span><span class="n">ip</span><span class="p">,</span><span class="n">j</span><span class="p">,</span><span class="n">k</span><span class="p">)</span><span class="o">-</span><span class="n">v0</span><span class="p">(</span><span class="n">i</span><span class="p">,</span><span class="n">j</span><span class="p">,</span><span class="n">k</span><span class="p">))</span>      <span class="o">*</span><span class="n">dxhi</span><span class="p">(</span><span class="n">ip</span><span class="p">)</span>       <span class="p">)</span><span class="o">**</span><span class="mi">2</span>    <span class="o">+</span> <span class="p">&amp;</span>
<a name="ln-267"></a>                        <span class="p">((</span><span class="n">u0</span><span class="p">(</span><span class="n">ip</span><span class="p">,</span><span class="n">jp</span><span class="p">,</span><span class="n">k</span><span class="p">)</span><span class="o">-</span><span class="n">u0</span><span class="p">(</span><span class="n">ip</span><span class="p">,</span><span class="n">j</span><span class="p">,</span><span class="n">k</span><span class="p">))</span>   <span class="o">*</span><span class="n">dyi</span>     <span class="o">+</span> <span class="p">&amp;</span>
<a name="ln-268"></a>                        <span class="p">(</span><span class="n">v0</span><span class="p">(</span><span class="n">ip</span><span class="p">,</span><span class="n">jp</span><span class="p">,</span><span class="n">k</span><span class="p">)</span><span class="o">-</span><span class="n">v0</span><span class="p">(</span><span class="n">i</span><span class="p">,</span><span class="n">jp</span><span class="p">,</span><span class="n">k</span><span class="p">))</span>    <span class="o">*</span><span class="n">dxhi</span><span class="p">(</span><span class="n">ip</span><span class="p">)</span>       <span class="p">)</span><span class="o">**</span><span class="mi">2</span>    <span class="p">)</span>
<a name="ln-269"></a>
<a name="ln-270"></a>                   <span class="n">strain2</span> <span class="o">=</span> <span class="n">strain2</span> <span class="o">+</span> <span class="mf">0.125</span> <span class="o">*</span> <span class="p">(</span> <span class="p">&amp;</span>
<a name="ln-271"></a>                        <span class="p">((</span><span class="n">v0</span><span class="p">(</span><span class="n">i</span><span class="p">,</span><span class="n">j</span><span class="p">,</span><span class="n">kp</span><span class="p">)</span><span class="o">-</span><span class="n">v0</span><span class="p">(</span><span class="n">i</span><span class="p">,</span><span class="n">j</span><span class="p">,</span><span class="n">k</span><span class="p">))</span>    <span class="o">*</span><span class="n">dzhi</span><span class="p">(</span><span class="n">kp</span><span class="p">)</span> <span class="o">+</span> <span class="p">&amp;</span>
<a name="ln-272"></a>                        <span class="p">(</span><span class="n">w0</span><span class="p">(</span><span class="n">i</span><span class="p">,</span><span class="n">j</span><span class="p">,</span><span class="n">kp</span><span class="p">)</span><span class="o">-</span><span class="n">w0</span><span class="p">(</span><span class="n">i</span><span class="p">,</span><span class="n">jm</span><span class="p">,</span><span class="n">kp</span><span class="p">))</span>   <span class="o">*</span><span class="n">dyi</span>        <span class="p">)</span><span class="o">**</span><span class="mi">2</span>    <span class="o">+</span> <span class="p">&amp;</span>
<a name="ln-273"></a>                        <span class="p">((</span><span class="n">v0</span><span class="p">(</span><span class="n">i</span><span class="p">,</span><span class="n">j</span><span class="p">,</span><span class="n">k</span><span class="p">)</span><span class="o">-</span><span class="n">v0</span><span class="p">(</span><span class="n">i</span><span class="p">,</span><span class="n">j</span><span class="p">,</span><span class="n">km</span><span class="p">))</span>    <span class="o">*</span><span class="n">dzhi</span><span class="p">(</span><span class="n">k</span><span class="p">)</span><span class="o">+</span> <span class="p">&amp;</span>
<a name="ln-274"></a>                        <span class="p">(</span><span class="n">w0</span><span class="p">(</span><span class="n">i</span><span class="p">,</span><span class="n">j</span><span class="p">,</span><span class="n">k</span><span class="p">)</span><span class="o">-</span><span class="n">w0</span><span class="p">(</span><span class="n">i</span><span class="p">,</span><span class="n">jm</span><span class="p">,</span><span class="n">k</span><span class="p">))</span>     <span class="o">*</span><span class="n">dyi</span>        <span class="p">)</span><span class="o">**</span><span class="mi">2</span>    <span class="o">+</span> <span class="p">&amp;</span>
<a name="ln-275"></a>                        <span class="p">((</span><span class="n">v0</span><span class="p">(</span><span class="n">i</span><span class="p">,</span><span class="n">jp</span><span class="p">,</span><span class="n">k</span><span class="p">)</span><span class="o">-</span><span class="n">v0</span><span class="p">(</span><span class="n">i</span><span class="p">,</span><span class="n">jp</span><span class="p">,</span><span class="n">km</span><span class="p">))</span>  <span class="o">*</span><span class="n">dzhi</span><span class="p">(</span><span class="n">k</span><span class="p">)</span><span class="o">+</span> <span class="p">&amp;</span>
<a name="ln-276"></a>                        <span class="p">(</span><span class="n">w0</span><span class="p">(</span><span class="n">i</span><span class="p">,</span><span class="n">jp</span><span class="p">,</span><span class="n">k</span><span class="p">)</span><span class="o">-</span><span class="n">w0</span><span class="p">(</span><span class="n">i</span><span class="p">,</span><span class="n">j</span><span class="p">,</span><span class="n">k</span><span class="p">))</span>     <span class="o">*</span><span class="n">dyi</span>        <span class="p">)</span><span class="o">**</span><span class="mi">2</span>    <span class="o">+</span> <span class="p">&amp;</span>
<a name="ln-277"></a>                        <span class="p">((</span><span class="n">v0</span><span class="p">(</span><span class="n">i</span><span class="p">,</span><span class="n">jp</span><span class="p">,</span><span class="n">kp</span><span class="p">)</span><span class="o">-</span><span class="n">v0</span><span class="p">(</span><span class="n">i</span><span class="p">,</span><span class="n">jp</span><span class="p">,</span><span class="n">k</span><span class="p">))</span>  <span class="o">*</span><span class="n">dzhi</span><span class="p">(</span><span class="n">kp</span><span class="p">)</span> <span class="o">+</span> <span class="p">&amp;</span>
<a name="ln-278"></a>                        <span class="p">(</span><span class="n">w0</span><span class="p">(</span><span class="n">i</span><span class="p">,</span><span class="n">jp</span><span class="p">,</span><span class="n">kp</span><span class="p">)</span><span class="o">-</span><span class="n">w0</span><span class="p">(</span><span class="n">i</span><span class="p">,</span><span class="n">j</span><span class="p">,</span><span class="n">kp</span><span class="p">))</span>   <span class="o">*</span><span class="n">dyi</span>        <span class="p">)</span><span class="o">**</span><span class="mi">2</span>    <span class="p">)</span>
<a name="ln-279"></a>
<a name="ln-280"></a>                <span class="n">ekm</span><span class="p">(</span><span class="n">i</span><span class="p">,</span><span class="n">j</span><span class="p">,</span><span class="n">k</span><span class="p">)</span>  <span class="o">=</span> <span class="p">(</span><span class="n">mlen</span><span class="o">*</span><span class="n">damp</span><span class="p">(</span><span class="n">i</span><span class="p">,</span><span class="n">j</span><span class="p">,</span><span class="n">k</span><span class="p">))</span> <span class="o">**</span> <span class="mf">2.</span> <span class="o">*</span> <span class="nb">sqrt</span><span class="p">(</span><span class="mf">2.</span> <span class="o">*</span> <span class="n">strain2</span><span class="p">)</span>
<a name="ln-281"></a>                <span class="n">ekh</span><span class="p">(</span><span class="n">i</span><span class="p">,</span><span class="n">j</span><span class="p">,</span><span class="n">k</span><span class="p">)</span>  <span class="o">=</span> <span class="n">ekm</span><span class="p">(</span><span class="n">i</span><span class="p">,</span><span class="n">j</span><span class="p">,</span><span class="n">k</span><span class="p">)</span> <span class="o">*</span> <span class="n">prandtli</span>
<a name="ln-282"></a>             <span class="k">end do</span>
<a name="ln-283"></a><span class="k">          end do</span>
<a name="ln-284"></a><span class="k">       end do</span>
<a name="ln-285"></a><span class="k">       </span><span class="n">damp</span><span class="p">(:,:,:)</span> <span class="o">=</span> <span class="nb">max</span><span class="p">(</span><span class="n">damp</span><span class="p">(:,:,:),</span><span class="n">dampmin</span><span class="p">)</span>
<a name="ln-286"></a>       <span class="n">ekm</span><span class="p">(:,:,:)</span> <span class="o">=</span> <span class="n">ekm</span><span class="p">(:,:,:)</span> <span class="o">+</span> <span class="n">numol</span>                             <span class="c">! add molecular viscosity</span>
<a name="ln-287"></a>       <span class="n">ekh</span><span class="p">(:,:,:)</span> <span class="o">=</span> <span class="n">ekh</span><span class="p">(:,:,:)</span> <span class="o">+</span> <span class="n">numol</span><span class="o">*</span><span class="n">prandtlmoli</span>                 <span class="c">! add molecular diffusivity  </span>
<a name="ln-288"></a>       <span class="c">!write(*,&#39;(A,3(1pE9.2))&#39;) &#39;strain2, ekm, ekh&#39;, strain2, ekm(10,10,10), ekh(10,10,10)     </span>
<a name="ln-289"></a>
<a name="ln-290"></a>       <span class="c">!    ekm(:,:,:) = max(ekm(:,:,:),ekmin)</span>
<a name="ln-291"></a>       <span class="c">!    ekh(:,:,:) = max(ekh(:,:,:),ekmin)</span>
<a name="ln-292"></a>    <span class="n">elseif</span><span class="p">(</span><span class="n">lvreman</span><span class="p">)</span> <span class="k">then</span>
<a name="ln-293"></a>
<a name="ln-294"></a><span class="k">       if</span> <span class="p">((</span><span class="n">lbuoyancy</span><span class="p">)</span> <span class="p">.</span><span class="nb">and</span><span class="p">.</span> <span class="p">(</span><span class="n">lbuoycorr</span><span class="p">))</span> <span class="k">then</span>
<a name="ln-295"></a><span class="k">       </span><span class="n">const</span> <span class="o">=</span> <span class="n">prandtli</span><span class="o">*</span><span class="n">grav</span><span class="o">/</span><span class="p">(</span><span class="n">thvs</span><span class="o">*</span><span class="nb">sqrt</span><span class="p">(</span><span class="mf">2.</span><span class="o">*</span><span class="mf">3.</span><span class="p">))</span>
<a name="ln-296"></a>         <span class="k">do </span><span class="n">k</span> <span class="o">=</span> <span class="n">kb</span><span class="p">,</span><span class="n">ke</span>
<a name="ln-297"></a>          <span class="n">kp</span> <span class="o">=</span> <span class="n">k</span><span class="o">+</span><span class="mi">1</span>
<a name="ln-298"></a>          <span class="n">km</span> <span class="o">=</span> <span class="n">k</span><span class="o">-</span><span class="mi">1</span>
<a name="ln-299"></a>          <span class="k">do </span><span class="n">j</span> <span class="o">=</span> <span class="n">jb</span><span class="p">,</span><span class="n">je</span>
<a name="ln-300"></a>             <span class="n">jp</span> <span class="o">=</span> <span class="n">j</span><span class="o">+</span><span class="mi">1</span>
<a name="ln-301"></a>             <span class="n">jm</span> <span class="o">=</span> <span class="n">j</span><span class="o">-</span><span class="mi">1</span>
<a name="ln-302"></a>             <span class="k">do </span><span class="n">i</span> <span class="o">=</span> <span class="n">ib</span><span class="p">,</span><span class="n">ie</span>        <span class="c">! aij = du_i / dx_i</span>
<a name="ln-303"></a>                <span class="n">ip</span> <span class="o">=</span> <span class="n">i</span><span class="o">+</span><span class="mi">1</span>
<a name="ln-304"></a>                <span class="n">im</span> <span class="o">=</span> <span class="n">i</span><span class="o">-</span><span class="mi">1</span>
<a name="ln-305"></a>                <span class="n">a11</span> <span class="o">=</span> <span class="p">(</span><span class="n">u0</span><span class="p">(</span><span class="n">ip</span><span class="p">,</span><span class="n">j</span><span class="p">,</span><span class="n">k</span><span class="p">)</span> <span class="o">-</span> <span class="n">u0</span><span class="p">(</span><span class="n">i</span><span class="p">,</span><span class="n">j</span><span class="p">,</span><span class="n">k</span><span class="p">))</span> <span class="o">*</span> <span class="n">dxfi</span><span class="p">(</span><span class="n">i</span><span class="p">)</span>
<a name="ln-306"></a>
<a name="ln-307"></a>                <span class="n">a12</span> <span class="o">=</span> <span class="p">(((</span><span class="n">v0</span><span class="p">(</span><span class="n">ip</span><span class="p">,</span><span class="n">jp</span><span class="p">,</span><span class="n">k</span><span class="p">)</span><span class="o">+</span> <span class="n">v0</span><span class="p">(</span><span class="n">ip</span><span class="p">,</span><span class="n">j</span><span class="p">,</span><span class="n">k</span><span class="p">))</span><span class="o">*</span><span class="n">dxf</span><span class="p">(</span><span class="n">i</span><span class="p">)</span> <span class="o">+</span> <span class="p">&amp;</span>
<a name="ln-308"></a>                     <span class="p">(</span><span class="n">v0</span><span class="p">(</span><span class="n">i</span><span class="p">,</span><span class="n">jp</span><span class="p">,</span><span class="n">k</span><span class="p">)</span> <span class="o">+</span> <span class="n">v0</span><span class="p">(</span><span class="n">i</span><span class="p">,</span><span class="n">j</span><span class="p">,</span><span class="n">k</span><span class="p">))</span> <span class="o">*</span><span class="n">dxf</span><span class="p">(</span><span class="n">ip</span><span class="p">))</span> <span class="o">*</span> <span class="n">dxhi</span><span class="p">(</span><span class="n">ip</span><span class="p">)</span> <span class="p">&amp;</span>  
<a name="ln-309"></a>                     <span class="o">-</span> <span class="p">&amp;</span>
<a name="ln-310"></a>                     <span class="p">((</span><span class="n">v0</span><span class="p">(</span><span class="n">i</span><span class="p">,</span><span class="n">jp</span><span class="p">,</span><span class="n">k</span><span class="p">)</span> <span class="o">+</span> <span class="n">v0</span><span class="p">(</span><span class="n">i</span><span class="p">,</span><span class="n">j</span><span class="p">,</span><span class="n">k</span><span class="p">))</span> <span class="o">*</span><span class="n">dxf</span><span class="p">(</span><span class="n">im</span><span class="p">)</span>  <span class="o">+</span> <span class="p">&amp;</span>
<a name="ln-311"></a>                     <span class="p">(</span><span class="n">v0</span><span class="p">(</span><span class="n">im</span><span class="p">,</span><span class="n">jp</span><span class="p">,</span><span class="n">k</span><span class="p">)</span><span class="o">+</span> <span class="n">v0</span><span class="p">(</span><span class="n">im</span><span class="p">,</span><span class="n">j</span><span class="p">,</span><span class="n">k</span><span class="p">))</span><span class="o">*</span><span class="n">dxf</span><span class="p">(</span><span class="n">i</span><span class="p">))</span>  <span class="o">*</span> <span class="n">dxhi</span><span class="p">(</span><span class="n">i</span><span class="p">))</span> <span class="o">*</span> <span class="n">dxfiq</span><span class="p">(</span><span class="n">i</span><span class="p">)</span>  
<a name="ln-312"></a>
<a name="ln-313"></a>                <span class="n">a13</span> <span class="o">=</span> <span class="p">(((</span><span class="n">w0</span><span class="p">(</span><span class="n">ip</span><span class="p">,</span><span class="n">j</span><span class="p">,</span><span class="n">kp</span><span class="p">)</span><span class="o">+</span> <span class="n">w0</span><span class="p">(</span><span class="n">ip</span><span class="p">,</span><span class="n">j</span><span class="p">,</span><span class="n">k</span><span class="p">))</span><span class="o">*</span><span class="n">dxf</span><span class="p">(</span><span class="n">i</span><span class="p">)</span> <span class="o">+</span> <span class="p">&amp;</span>
<a name="ln-314"></a>                     <span class="p">(</span><span class="n">w0</span><span class="p">(</span><span class="n">i</span><span class="p">,</span><span class="n">j</span><span class="p">,</span><span class="n">kp</span><span class="p">)</span> <span class="o">+</span> <span class="n">w0</span><span class="p">(</span><span class="n">i</span><span class="p">,</span><span class="n">j</span><span class="p">,</span><span class="n">k</span><span class="p">))</span> <span class="o">*</span><span class="n">dxf</span><span class="p">(</span><span class="n">ip</span><span class="p">))</span> <span class="o">*</span> <span class="n">dxhi</span><span class="p">(</span><span class="n">ip</span><span class="p">)</span> <span class="p">&amp;</span>
<a name="ln-315"></a>                     <span class="o">-</span> <span class="p">&amp;</span>
<a name="ln-316"></a>                     <span class="p">((</span><span class="n">w0</span><span class="p">(</span><span class="n">i</span><span class="p">,</span><span class="n">j</span><span class="p">,</span><span class="n">kp</span><span class="p">)</span> <span class="o">+</span> <span class="n">w0</span><span class="p">(</span><span class="n">i</span><span class="p">,</span><span class="n">j</span><span class="p">,</span><span class="n">k</span><span class="p">))</span> <span class="o">*</span><span class="n">dxf</span><span class="p">(</span><span class="n">im</span><span class="p">)</span>  <span class="o">+</span> <span class="p">&amp;</span>
<a name="ln-317"></a>                     <span class="p">(</span><span class="n">w0</span><span class="p">(</span><span class="n">im</span><span class="p">,</span><span class="n">j</span><span class="p">,</span><span class="n">kp</span><span class="p">)</span><span class="o">+</span> <span class="n">w0</span><span class="p">(</span><span class="n">im</span><span class="p">,</span><span class="n">j</span><span class="p">,</span><span class="n">k</span><span class="p">))</span><span class="o">*</span><span class="n">dxf</span><span class="p">(</span><span class="n">i</span><span class="p">))</span>  <span class="o">*</span> <span class="n">dxhi</span><span class="p">(</span><span class="n">i</span><span class="p">))</span> <span class="o">*</span> <span class="n">dxfiq</span><span class="p">(</span><span class="n">i</span><span class="p">)</span>
<a name="ln-318"></a>
<a name="ln-319"></a>                <span class="n">a21</span> <span class="o">=</span> <span class="p">(</span><span class="n">u0</span><span class="p">(</span><span class="n">ip</span><span class="p">,</span><span class="n">jp</span><span class="p">,</span><span class="n">k</span><span class="p">)</span> <span class="o">+</span> <span class="n">u0</span><span class="p">(</span><span class="n">i</span><span class="p">,</span><span class="n">jp</span><span class="p">,</span><span class="n">k</span><span class="p">)</span> <span class="o">-</span> <span class="n">u0</span><span class="p">(</span><span class="n">ip</span><span class="p">,</span><span class="n">jm</span><span class="p">,</span><span class="n">k</span><span class="p">)</span> <span class="o">-</span> <span class="n">u0</span><span class="p">(</span><span class="n">i</span><span class="p">,</span><span class="n">jm</span><span class="p">,</span><span class="n">k</span><span class="p">)</span> <span class="p">)</span><span class="o">*</span><span class="n">dyiq</span>   <span class="c">! simplified after writing out interpolation.</span>
<a name="ln-320"></a>
<a name="ln-321"></a>                <span class="n">a22</span> <span class="o">=</span> <span class="p">(</span><span class="n">v0</span><span class="p">(</span><span class="n">i</span><span class="p">,</span><span class="n">jp</span><span class="p">,</span><span class="n">k</span><span class="p">)</span> <span class="o">-</span> <span class="n">v0</span><span class="p">(</span><span class="n">i</span><span class="p">,</span><span class="n">j</span><span class="p">,</span><span class="n">k</span><span class="p">))</span> <span class="o">*</span> <span class="n">dyi</span> 
<a name="ln-322"></a>
<a name="ln-323"></a>                <span class="n">a23</span> <span class="o">=</span> <span class="p">(</span><span class="n">w0</span><span class="p">(</span><span class="n">i</span><span class="p">,</span><span class="n">jp</span><span class="p">,</span><span class="n">kp</span><span class="p">)</span> <span class="o">+</span> <span class="n">w0</span><span class="p">(</span><span class="n">i</span><span class="p">,</span><span class="n">jp</span><span class="p">,</span><span class="n">k</span><span class="p">)</span> <span class="o">-</span> <span class="n">w0</span><span class="p">(</span><span class="n">i</span><span class="p">,</span><span class="n">jm</span><span class="p">,</span><span class="n">kp</span><span class="p">)</span> <span class="o">-</span> <span class="n">w0</span><span class="p">(</span><span class="n">i</span><span class="p">,</span><span class="n">jm</span><span class="p">,</span><span class="n">k</span><span class="p">)</span> <span class="p">)</span><span class="o">*</span><span class="n">dyiq</span>   <span class="c">! simplified after writing out interpolation.</span>
<a name="ln-324"></a>
<a name="ln-325"></a>                <span class="n">a31</span> <span class="o">=</span> <span class="p">(((</span><span class="n">u0</span><span class="p">(</span><span class="n">ip</span><span class="p">,</span><span class="n">j</span><span class="p">,</span><span class="n">kp</span><span class="p">)</span> <span class="o">+</span> <span class="n">u0</span><span class="p">(</span><span class="n">i</span><span class="p">,</span><span class="n">j</span><span class="p">,</span><span class="n">kp</span><span class="p">))</span><span class="o">*</span><span class="n">dzf</span><span class="p">(</span><span class="n">k</span><span class="p">)</span>  <span class="o">+</span> <span class="p">&amp;</span>
<a name="ln-326"></a>                     <span class="p">(</span><span class="n">u0</span><span class="p">(</span><span class="n">ip</span><span class="p">,</span><span class="n">j</span><span class="p">,</span><span class="n">k</span><span class="p">)</span>  <span class="o">+</span> <span class="n">u0</span><span class="p">(</span><span class="n">i</span><span class="p">,</span><span class="n">j</span><span class="p">,</span><span class="n">k</span><span class="p">))</span> <span class="o">*</span><span class="n">dzf</span><span class="p">(</span><span class="n">kp</span><span class="p">))</span> <span class="o">*</span> <span class="n">dzhi</span><span class="p">(</span><span class="n">kp</span><span class="p">)</span> <span class="p">&amp;</span>
<a name="ln-327"></a>                     <span class="o">-</span> <span class="p">&amp;</span>
<a name="ln-328"></a>                     <span class="p">((</span><span class="n">u0</span><span class="p">(</span><span class="n">ip</span><span class="p">,</span><span class="n">j</span><span class="p">,</span><span class="n">k</span><span class="p">)</span>  <span class="o">+</span> <span class="n">u0</span><span class="p">(</span><span class="n">i</span><span class="p">,</span><span class="n">j</span><span class="p">,</span><span class="n">k</span><span class="p">))</span> <span class="o">*</span><span class="n">dzf</span><span class="p">(</span><span class="n">km</span><span class="p">)</span> <span class="o">+</span> <span class="p">&amp;</span>
<a name="ln-329"></a>                     <span class="p">(</span><span class="n">u0</span><span class="p">(</span><span class="n">ip</span><span class="p">,</span><span class="n">j</span><span class="p">,</span><span class="n">km</span><span class="p">)</span> <span class="o">+</span> <span class="n">u0</span><span class="p">(</span><span class="n">i</span><span class="p">,</span><span class="n">j</span><span class="p">,</span><span class="n">km</span><span class="p">))</span><span class="o">*</span><span class="n">dzf</span><span class="p">(</span><span class="n">k</span><span class="p">))</span>  <span class="o">*</span> <span class="n">dzhi</span><span class="p">(</span><span class="n">k</span><span class="p">)</span>   <span class="p">)</span><span class="o">*</span><span class="n">dzfiq</span><span class="p">(</span><span class="n">k</span><span class="p">)</span>
<a name="ln-330"></a>
<a name="ln-331"></a>                <span class="n">a32</span> <span class="o">=</span> <span class="p">(((</span><span class="n">v0</span><span class="p">(</span><span class="n">i</span><span class="p">,</span><span class="n">jp</span><span class="p">,</span><span class="n">kp</span><span class="p">)</span> <span class="o">+</span> <span class="n">v0</span><span class="p">(</span><span class="n">i</span><span class="p">,</span><span class="n">j</span><span class="p">,</span><span class="n">kp</span><span class="p">))</span><span class="o">*</span><span class="n">dzf</span><span class="p">(</span><span class="n">k</span><span class="p">)</span>  <span class="o">+</span> <span class="p">&amp;</span>
<a name="ln-332"></a>                     <span class="p">(</span><span class="n">v0</span><span class="p">(</span><span class="n">i</span><span class="p">,</span><span class="n">jp</span><span class="p">,</span><span class="n">k</span><span class="p">)</span>  <span class="o">+</span> <span class="n">v0</span><span class="p">(</span><span class="n">i</span><span class="p">,</span><span class="n">j</span><span class="p">,</span><span class="n">k</span><span class="p">))</span> <span class="o">*</span><span class="n">dzf</span><span class="p">(</span><span class="n">kp</span><span class="p">))</span> <span class="o">*</span> <span class="n">dzhi</span><span class="p">(</span><span class="n">kp</span><span class="p">)</span> <span class="p">&amp;</span>
<a name="ln-333"></a>                     <span class="o">-</span> <span class="p">&amp;</span>
<a name="ln-334"></a>                     <span class="p">((</span><span class="n">v0</span><span class="p">(</span><span class="n">i</span><span class="p">,</span><span class="n">jp</span><span class="p">,</span><span class="n">k</span><span class="p">)</span>  <span class="o">+</span> <span class="n">v0</span><span class="p">(</span><span class="n">i</span><span class="p">,</span><span class="n">j</span><span class="p">,</span><span class="n">k</span><span class="p">))</span> <span class="o">*</span><span class="n">dzf</span><span class="p">(</span><span class="n">km</span><span class="p">)</span> <span class="o">+</span> <span class="p">&amp;</span>
<a name="ln-335"></a>                     <span class="p">(</span><span class="n">v0</span><span class="p">(</span><span class="n">i</span><span class="p">,</span><span class="n">jp</span><span class="p">,</span><span class="n">km</span><span class="p">)</span> <span class="o">+</span> <span class="n">v0</span><span class="p">(</span><span class="n">i</span><span class="p">,</span><span class="n">j</span><span class="p">,</span><span class="n">km</span><span class="p">))</span><span class="o">*</span><span class="n">dzf</span><span class="p">(</span><span class="n">k</span><span class="p">))</span>  <span class="o">*</span> <span class="n">dzhi</span><span class="p">(</span><span class="n">k</span><span class="p">)</span>   <span class="p">)</span><span class="o">*</span><span class="n">dzfiq</span><span class="p">(</span><span class="n">k</span><span class="p">)</span>
<a name="ln-336"></a>
<a name="ln-337"></a>                <span class="n">a33</span> <span class="o">=</span> <span class="p">(</span><span class="n">w0</span><span class="p">(</span><span class="n">i</span><span class="p">,</span><span class="n">j</span><span class="p">,</span><span class="n">kp</span><span class="p">)</span> <span class="o">-</span> <span class="n">w0</span><span class="p">(</span><span class="n">i</span><span class="p">,</span><span class="n">j</span><span class="p">,</span><span class="n">k</span><span class="p">))</span> <span class="o">*</span> <span class="n">dzfi</span><span class="p">(</span><span class="n">k</span><span class="p">)</span>
<a name="ln-338"></a>
<a name="ln-339"></a>                <span class="n">aa</span>  <span class="o">=</span> <span class="n">a11</span><span class="o">*</span><span class="n">a11</span> <span class="o">+</span> <span class="n">a21</span><span class="o">*</span><span class="n">a21</span> <span class="o">+</span> <span class="n">a31</span><span class="o">*</span><span class="n">a31</span> <span class="o">+</span> <span class="p">&amp;</span>
<a name="ln-340"></a>                     <span class="n">a12</span><span class="o">*</span><span class="n">a12</span> <span class="o">+</span> <span class="n">a22</span><span class="o">*</span><span class="n">a22</span> <span class="o">+</span> <span class="n">a32</span><span class="o">*</span><span class="n">a32</span> <span class="o">+</span> <span class="p">&amp;</span>
<a name="ln-341"></a>                     <span class="n">a13</span><span class="o">*</span><span class="n">a13</span> <span class="o">+</span> <span class="n">a23</span><span class="o">*</span><span class="n">a23</span> <span class="o">+</span> <span class="n">a33</span><span class="o">*</span><span class="n">a33</span>
<a name="ln-342"></a>
<a name="ln-343"></a>                <span class="n">b11</span> <span class="o">=</span> <span class="n">dxf2</span><span class="p">(</span><span class="n">i</span><span class="p">)</span><span class="o">*</span><span class="n">a11</span><span class="o">*</span><span class="n">a11</span> <span class="o">+</span> <span class="n">dy2</span><span class="o">*</span><span class="n">a21</span><span class="o">*</span><span class="n">a21</span> <span class="o">+</span> <span class="n">dzf2</span><span class="p">(</span><span class="n">k</span><span class="p">)</span><span class="o">*</span><span class="n">a31</span><span class="o">*</span><span class="n">a31</span>
<a name="ln-344"></a>                <span class="n">b22</span> <span class="o">=</span> <span class="n">dxf2</span><span class="p">(</span><span class="n">i</span><span class="p">)</span><span class="o">*</span><span class="n">a12</span><span class="o">*</span><span class="n">a12</span> <span class="o">+</span> <span class="n">dy2</span><span class="o">*</span><span class="n">a22</span><span class="o">*</span><span class="n">a22</span> <span class="o">+</span> <span class="n">dzf2</span><span class="p">(</span><span class="n">k</span><span class="p">)</span><span class="o">*</span><span class="n">a32</span><span class="o">*</span><span class="n">a32</span> 
<a name="ln-345"></a>                <span class="n">b12</span> <span class="o">=</span> <span class="n">dxf2</span><span class="p">(</span><span class="n">i</span><span class="p">)</span><span class="o">*</span><span class="n">a11</span><span class="o">*</span><span class="n">a12</span> <span class="o">+</span> <span class="n">dy2</span><span class="o">*</span><span class="n">a21</span><span class="o">*</span><span class="n">a22</span> <span class="o">+</span> <span class="n">dzf2</span><span class="p">(</span><span class="n">k</span><span class="p">)</span><span class="o">*</span><span class="n">a31</span><span class="o">*</span><span class="n">a32</span> 
<a name="ln-346"></a>                <span class="n">b33</span> <span class="o">=</span> <span class="n">dxf2</span><span class="p">(</span><span class="n">i</span><span class="p">)</span><span class="o">*</span><span class="n">a13</span><span class="o">*</span><span class="n">a13</span> <span class="o">+</span> <span class="n">dy2</span><span class="o">*</span><span class="n">a23</span><span class="o">*</span><span class="n">a23</span> <span class="o">+</span> <span class="n">dzf2</span><span class="p">(</span><span class="n">k</span><span class="p">)</span><span class="o">*</span><span class="n">a33</span><span class="o">*</span><span class="n">a33</span> 
<a name="ln-347"></a>                <span class="n">b13</span> <span class="o">=</span> <span class="n">dxf2</span><span class="p">(</span><span class="n">i</span><span class="p">)</span><span class="o">*</span><span class="n">a11</span><span class="o">*</span><span class="n">a13</span> <span class="o">+</span> <span class="n">dy2</span><span class="o">*</span><span class="n">a21</span><span class="o">*</span><span class="n">a23</span> <span class="o">+</span> <span class="n">dzf2</span><span class="p">(</span><span class="n">k</span><span class="p">)</span><span class="o">*</span><span class="n">a31</span><span class="o">*</span><span class="n">a33</span>
<a name="ln-348"></a>                <span class="n">b23</span> <span class="o">=</span> <span class="n">dxf2</span><span class="p">(</span><span class="n">i</span><span class="p">)</span><span class="o">*</span><span class="n">a12</span><span class="o">*</span><span class="n">a13</span> <span class="o">+</span> <span class="n">dy2</span><span class="o">*</span><span class="n">a22</span><span class="o">*</span><span class="n">a23</span> <span class="o">+</span> <span class="n">dzf2</span><span class="p">(</span><span class="n">k</span><span class="p">)</span><span class="o">*</span><span class="n">a32</span><span class="o">*</span><span class="n">a33</span>
<a name="ln-349"></a>                <span class="n">bb</span> <span class="o">=</span> <span class="n">b11</span><span class="o">*</span><span class="n">b22</span> <span class="o">-</span> <span class="n">b12</span><span class="o">*</span><span class="n">b12</span> <span class="o">+</span> <span class="n">b11</span><span class="o">*</span><span class="n">b33</span> <span class="o">-</span> <span class="n">b13</span><span class="o">*</span><span class="n">b13</span> <span class="o">+</span> <span class="n">b22</span><span class="o">*</span><span class="n">b33</span> <span class="o">-</span> <span class="n">b23</span><span class="o">*</span><span class="n">b23</span>
<a name="ln-350"></a>
<a name="ln-351"></a>                <span class="n">dthvdz</span><span class="p">(</span><span class="n">i</span><span class="p">,</span><span class="n">j</span><span class="p">,</span><span class="n">k</span><span class="p">)</span> <span class="o">=</span> <span class="p">(</span><span class="n">thl0</span><span class="p">(</span><span class="n">i</span><span class="p">,</span><span class="n">j</span><span class="p">,</span><span class="n">k</span><span class="o">+</span><span class="mi">1</span><span class="p">)</span><span class="o">-</span><span class="n">thl0</span><span class="p">(</span><span class="n">i</span><span class="p">,</span><span class="n">j</span><span class="p">,</span><span class="n">k</span><span class="o">-</span><span class="mi">1</span><span class="p">))</span><span class="o">/</span><span class="p">(</span><span class="n">dzh</span><span class="p">(</span><span class="n">k</span><span class="o">+</span><span class="mi">1</span><span class="p">)</span><span class="o">+</span><span class="n">dzh</span><span class="p">(</span><span class="n">k</span><span class="p">))</span>
<a name="ln-352"></a>                <span class="k">if</span> <span class="p">(</span><span class="n">dthvdz</span><span class="p">(</span><span class="n">i</span><span class="p">,</span><span class="n">j</span><span class="p">,</span><span class="n">k</span><span class="p">)</span> <span class="o">&lt;=</span> <span class="mi">0</span><span class="p">)</span> <span class="k">then</span>
<a name="ln-353"></a><span class="k">                  </span><span class="n">const2</span><span class="o">=</span><span class="p">(</span><span class="n">bb</span><span class="o">/</span><span class="n">aa</span><span class="p">)</span>
<a name="ln-354"></a>                <span class="k">else</span>
<a name="ln-355"></a>                 <span class="c">! write(*,*) &quot;const&quot;,const</span>
<a name="ln-356"></a>                 <span class="c">! write(*,*) &quot;delta&quot;,delta</span>
<a name="ln-357"></a>                  <span class="n">const2</span><span class="o">=</span><span class="p">(</span><span class="n">bb</span><span class="o">/</span><span class="n">aa</span><span class="p">)</span><span class="o">-</span><span class="p">(</span><span class="n">delta</span><span class="p">(</span><span class="n">i</span><span class="p">,</span><span class="n">k</span><span class="p">)</span><span class="o">**</span><span class="mi">4</span><span class="p">)</span><span class="o">*</span><span class="n">dthvdz</span><span class="p">(</span><span class="n">i</span><span class="p">,</span><span class="n">j</span><span class="p">,</span><span class="n">k</span><span class="p">)</span><span class="o">*</span><span class="n">const</span>
<a name="ln-358"></a>                  <span class="k">if</span> <span class="p">(</span><span class="n">const2</span> <span class="o">&lt;</span><span class="mf">0.0</span><span class="p">)</span> <span class="n">const2</span> <span class="o">=</span> <span class="mf">0.0</span>
<a name="ln-359"></a>                <span class="k">end if</span>
<a name="ln-360"></a><span class="k">                </span><span class="n">ekm</span><span class="p">(</span><span class="n">i</span><span class="p">,</span><span class="n">j</span><span class="p">,</span><span class="n">k</span><span class="p">)</span><span class="o">=</span><span class="n">c_vreman</span><span class="o">*</span><span class="nb">sqrt</span><span class="p">(</span><span class="n">const2</span><span class="p">)</span>
<a name="ln-361"></a>                <span class="n">ekh</span><span class="p">(</span><span class="n">i</span><span class="p">,</span><span class="n">j</span><span class="p">,</span><span class="n">k</span><span class="p">)</span><span class="o">=</span><span class="n">ekm</span><span class="p">(</span><span class="n">i</span><span class="p">,</span><span class="n">j</span><span class="p">,</span><span class="n">k</span><span class="p">)</span><span class="o">*</span><span class="n">prandtli</span> 
<a name="ln-362"></a>             <span class="k">end do</span>
<a name="ln-363"></a><span class="k">          end do</span>
<a name="ln-364"></a><span class="k">       end do</span>
<a name="ln-365"></a><span class="k">       </span><span class="n">ekm</span><span class="p">(:,:,:)</span> <span class="o">=</span> <span class="n">ekm</span><span class="p">(:,:,:)</span> <span class="o">+</span> <span class="n">numol</span>                             <span class="c">! add molecular viscosity</span>
<a name="ln-366"></a>       <span class="n">ekh</span><span class="p">(:,:,:)</span> <span class="o">=</span> <span class="n">ekh</span><span class="p">(:,:,:)</span> <span class="o">+</span> <span class="n">numol</span><span class="o">*</span><span class="n">prandtlmoli</span>                 <span class="c">! add molecular diffusivity</span>
<a name="ln-367"></a>       
<a name="ln-368"></a><span class="k">else</span>  <span class="c">! neutral case</span>
<a name="ln-369"></a>
<a name="ln-370"></a>    <span class="k">do </span><span class="n">k</span> <span class="o">=</span> <span class="n">kb</span><span class="p">,</span><span class="n">ke</span>
<a name="ln-371"></a>      <span class="n">kp</span> <span class="o">=</span> <span class="n">k</span><span class="o">+</span><span class="mi">1</span>
<a name="ln-372"></a>      <span class="n">km</span> <span class="o">=</span> <span class="n">k</span><span class="o">-</span><span class="mi">1</span>
<a name="ln-373"></a>      <span class="k">do </span><span class="n">j</span> <span class="o">=</span> <span class="n">jb</span><span class="p">,</span><span class="n">je</span>
<a name="ln-374"></a>        <span class="n">jp</span> <span class="o">=</span> <span class="n">j</span><span class="o">+</span><span class="mi">1</span>
<a name="ln-375"></a>        <span class="n">jm</span> <span class="o">=</span> <span class="n">j</span><span class="o">-</span><span class="mi">1</span>
<a name="ln-376"></a>        <span class="k">do </span><span class="n">i</span> <span class="o">=</span> <span class="n">ib</span><span class="p">,</span><span class="n">ie</span>        <span class="c">! aij = du_i / dx_i</span>
<a name="ln-377"></a>          <span class="n">ip</span> <span class="o">=</span> <span class="n">i</span><span class="o">+</span><span class="mi">1</span>
<a name="ln-378"></a>          <span class="n">im</span> <span class="o">=</span> <span class="n">i</span><span class="o">-</span><span class="mi">1</span>
<a name="ln-379"></a>          <span class="n">a11</span> <span class="o">=</span> <span class="p">(</span><span class="n">u0</span><span class="p">(</span><span class="n">ip</span><span class="p">,</span><span class="n">j</span><span class="p">,</span><span class="n">k</span><span class="p">)</span> <span class="o">-</span> <span class="n">u0</span><span class="p">(</span><span class="n">i</span><span class="p">,</span><span class="n">j</span><span class="p">,</span><span class="n">k</span><span class="p">))</span> <span class="o">*</span> <span class="n">dxfi</span><span class="p">(</span><span class="n">i</span><span class="p">)</span>
<a name="ln-380"></a>
<a name="ln-381"></a>          <span class="n">a12</span> <span class="o">=</span> <span class="p">(((</span><span class="n">v0</span><span class="p">(</span><span class="n">ip</span><span class="p">,</span><span class="n">jp</span><span class="p">,</span><span class="n">k</span><span class="p">)</span><span class="o">+</span> <span class="n">v0</span><span class="p">(</span><span class="n">ip</span><span class="p">,</span><span class="n">j</span><span class="p">,</span><span class="n">k</span><span class="p">))</span><span class="o">*</span><span class="n">dxf</span><span class="p">(</span><span class="n">i</span><span class="p">)</span> <span class="o">+</span> <span class="p">&amp;</span>
<a name="ln-382"></a>                  <span class="p">(</span><span class="n">v0</span><span class="p">(</span><span class="n">i</span><span class="p">,</span><span class="n">jp</span><span class="p">,</span><span class="n">k</span><span class="p">)</span> <span class="o">+</span> <span class="n">v0</span><span class="p">(</span><span class="n">i</span><span class="p">,</span><span class="n">j</span><span class="p">,</span><span class="n">k</span><span class="p">))</span> <span class="o">*</span><span class="n">dxf</span><span class="p">(</span><span class="n">ip</span><span class="p">))</span> <span class="o">*</span> <span class="n">dxhi</span><span class="p">(</span><span class="n">ip</span><span class="p">)</span> <span class="p">&amp;</span>  
<a name="ln-383"></a>                         <span class="o">-</span> <span class="p">&amp;</span>
<a name="ln-384"></a>                  <span class="p">((</span><span class="n">v0</span><span class="p">(</span><span class="n">i</span><span class="p">,</span><span class="n">jp</span><span class="p">,</span><span class="n">k</span><span class="p">)</span> <span class="o">+</span> <span class="n">v0</span><span class="p">(</span><span class="n">i</span><span class="p">,</span><span class="n">j</span><span class="p">,</span><span class="n">k</span><span class="p">))</span> <span class="o">*</span><span class="n">dxf</span><span class="p">(</span><span class="n">im</span><span class="p">)</span>  <span class="o">+</span> <span class="p">&amp;</span>
<a name="ln-385"></a>                   <span class="p">(</span><span class="n">v0</span><span class="p">(</span><span class="n">im</span><span class="p">,</span><span class="n">jp</span><span class="p">,</span><span class="n">k</span><span class="p">)</span><span class="o">+</span> <span class="n">v0</span><span class="p">(</span><span class="n">im</span><span class="p">,</span><span class="n">j</span><span class="p">,</span><span class="n">k</span><span class="p">))</span><span class="o">*</span><span class="n">dxf</span><span class="p">(</span><span class="n">i</span><span class="p">))</span>  <span class="o">*</span> <span class="n">dxhi</span><span class="p">(</span><span class="n">i</span><span class="p">))</span> <span class="o">*</span> <span class="n">dxfiq</span><span class="p">(</span><span class="n">i</span><span class="p">)</span>  
<a name="ln-386"></a>
<a name="ln-387"></a>          <span class="n">a13</span> <span class="o">=</span> <span class="p">(((</span><span class="n">w0</span><span class="p">(</span><span class="n">ip</span><span class="p">,</span><span class="n">j</span><span class="p">,</span><span class="n">kp</span><span class="p">)</span><span class="o">+</span> <span class="n">w0</span><span class="p">(</span><span class="n">ip</span><span class="p">,</span><span class="n">j</span><span class="p">,</span><span class="n">k</span><span class="p">))</span><span class="o">*</span><span class="n">dxf</span><span class="p">(</span><span class="n">i</span><span class="p">)</span> <span class="o">+</span> <span class="p">&amp;</span>
<a name="ln-388"></a>                  <span class="p">(</span><span class="n">w0</span><span class="p">(</span><span class="n">i</span><span class="p">,</span><span class="n">j</span><span class="p">,</span><span class="n">kp</span><span class="p">)</span> <span class="o">+</span> <span class="n">w0</span><span class="p">(</span><span class="n">i</span><span class="p">,</span><span class="n">j</span><span class="p">,</span><span class="n">k</span><span class="p">))</span> <span class="o">*</span><span class="n">dxf</span><span class="p">(</span><span class="n">ip</span><span class="p">))</span> <span class="o">*</span> <span class="n">dxhi</span><span class="p">(</span><span class="n">ip</span><span class="p">)</span> <span class="p">&amp;</span>
<a name="ln-389"></a>                         <span class="o">-</span> <span class="p">&amp;</span>
<a name="ln-390"></a>                 <span class="p">((</span><span class="n">w0</span><span class="p">(</span><span class="n">i</span><span class="p">,</span><span class="n">j</span><span class="p">,</span><span class="n">kp</span><span class="p">)</span> <span class="o">+</span> <span class="n">w0</span><span class="p">(</span><span class="n">i</span><span class="p">,</span><span class="n">j</span><span class="p">,</span><span class="n">k</span><span class="p">))</span> <span class="o">*</span><span class="n">dxf</span><span class="p">(</span><span class="n">im</span><span class="p">)</span>  <span class="o">+</span> <span class="p">&amp;</span>
<a name="ln-391"></a>                  <span class="p">(</span><span class="n">w0</span><span class="p">(</span><span class="n">im</span><span class="p">,</span><span class="n">j</span><span class="p">,</span><span class="n">kp</span><span class="p">)</span><span class="o">+</span> <span class="n">w0</span><span class="p">(</span><span class="n">im</span><span class="p">,</span><span class="n">j</span><span class="p">,</span><span class="n">k</span><span class="p">))</span><span class="o">*</span><span class="n">dxf</span><span class="p">(</span><span class="n">i</span><span class="p">))</span>  <span class="o">*</span> <span class="n">dxhi</span><span class="p">(</span><span class="n">i</span><span class="p">))</span> <span class="o">*</span> <span class="n">dxfiq</span><span class="p">(</span><span class="n">i</span><span class="p">)</span>
<a name="ln-392"></a>
<a name="ln-393"></a>          <span class="n">a21</span> <span class="o">=</span> <span class="p">(</span><span class="n">u0</span><span class="p">(</span><span class="n">ip</span><span class="p">,</span><span class="n">jp</span><span class="p">,</span><span class="n">k</span><span class="p">)</span> <span class="o">+</span> <span class="n">u0</span><span class="p">(</span><span class="n">i</span><span class="p">,</span><span class="n">jp</span><span class="p">,</span><span class="n">k</span><span class="p">)</span> <span class="o">-</span> <span class="n">u0</span><span class="p">(</span><span class="n">ip</span><span class="p">,</span><span class="n">jm</span><span class="p">,</span><span class="n">k</span><span class="p">)</span> <span class="o">-</span> <span class="n">u0</span><span class="p">(</span><span class="n">i</span><span class="p">,</span><span class="n">jm</span><span class="p">,</span><span class="n">k</span><span class="p">)</span> <span class="p">)</span><span class="o">*</span><span class="n">dyiq</span>   <span class="c">!simplified after writing out interpolation.</span>
<a name="ln-394"></a>
<a name="ln-395"></a>          <span class="n">a22</span> <span class="o">=</span> <span class="p">(</span><span class="n">v0</span><span class="p">(</span><span class="n">i</span><span class="p">,</span><span class="n">jp</span><span class="p">,</span><span class="n">k</span><span class="p">)</span> <span class="o">-</span> <span class="n">v0</span><span class="p">(</span><span class="n">i</span><span class="p">,</span><span class="n">j</span><span class="p">,</span><span class="n">k</span><span class="p">))</span> <span class="o">*</span> <span class="n">dyi</span> 
<a name="ln-396"></a>
<a name="ln-397"></a>          <span class="n">a23</span> <span class="o">=</span> <span class="p">(</span><span class="n">w0</span><span class="p">(</span><span class="n">i</span><span class="p">,</span><span class="n">jp</span><span class="p">,</span><span class="n">kp</span><span class="p">)</span> <span class="o">+</span> <span class="n">w0</span><span class="p">(</span><span class="n">i</span><span class="p">,</span><span class="n">jp</span><span class="p">,</span><span class="n">k</span><span class="p">)</span> <span class="o">-</span> <span class="n">w0</span><span class="p">(</span><span class="n">i</span><span class="p">,</span><span class="n">jm</span><span class="p">,</span><span class="n">kp</span><span class="p">)</span> <span class="o">-</span> <span class="n">w0</span><span class="p">(</span><span class="n">i</span><span class="p">,</span><span class="n">jm</span><span class="p">,</span><span class="n">k</span><span class="p">)</span> <span class="p">)</span><span class="o">*</span><span class="n">dyiq</span>   <span class="c">!simplified after writing out interpolation.</span>
<a name="ln-398"></a>
<a name="ln-399"></a>          <span class="n">a31</span> <span class="o">=</span> <span class="p">(((</span><span class="n">u0</span><span class="p">(</span><span class="n">ip</span><span class="p">,</span><span class="n">j</span><span class="p">,</span><span class="n">kp</span><span class="p">)</span> <span class="o">+</span> <span class="n">u0</span><span class="p">(</span><span class="n">i</span><span class="p">,</span><span class="n">j</span><span class="p">,</span><span class="n">kp</span><span class="p">))</span><span class="o">*</span><span class="n">dzf</span><span class="p">(</span><span class="n">k</span><span class="p">)</span>  <span class="o">+</span> <span class="p">&amp;</span>
<a name="ln-400"></a>                  <span class="p">(</span><span class="n">u0</span><span class="p">(</span><span class="n">ip</span><span class="p">,</span><span class="n">j</span><span class="p">,</span><span class="n">k</span><span class="p">)</span>  <span class="o">+</span> <span class="n">u0</span><span class="p">(</span><span class="n">i</span><span class="p">,</span><span class="n">j</span><span class="p">,</span><span class="n">k</span><span class="p">))</span> <span class="o">*</span><span class="n">dzf</span><span class="p">(</span><span class="n">kp</span><span class="p">))</span> <span class="o">*</span> <span class="n">dzhi</span><span class="p">(</span><span class="n">kp</span><span class="p">)</span> <span class="p">&amp;</span>
<a name="ln-401"></a>                         <span class="o">-</span> <span class="p">&amp;</span>
<a name="ln-402"></a>                 <span class="p">((</span><span class="n">u0</span><span class="p">(</span><span class="n">ip</span><span class="p">,</span><span class="n">j</span><span class="p">,</span><span class="n">k</span><span class="p">)</span>  <span class="o">+</span> <span class="n">u0</span><span class="p">(</span><span class="n">i</span><span class="p">,</span><span class="n">j</span><span class="p">,</span><span class="n">k</span><span class="p">))</span> <span class="o">*</span><span class="n">dzf</span><span class="p">(</span><span class="n">km</span><span class="p">)</span> <span class="o">+</span> <span class="p">&amp;</span>
<a name="ln-403"></a>                  <span class="p">(</span><span class="n">u0</span><span class="p">(</span><span class="n">ip</span><span class="p">,</span><span class="n">j</span><span class="p">,</span><span class="n">km</span><span class="p">)</span> <span class="o">+</span> <span class="n">u0</span><span class="p">(</span><span class="n">i</span><span class="p">,</span><span class="n">j</span><span class="p">,</span><span class="n">km</span><span class="p">))</span><span class="o">*</span><span class="n">dzf</span><span class="p">(</span><span class="n">k</span><span class="p">))</span>  <span class="o">*</span> <span class="n">dzhi</span><span class="p">(</span><span class="n">k</span><span class="p">)</span>   <span class="p">)</span><span class="o">*</span><span class="n">dzfiq</span><span class="p">(</span><span class="n">k</span><span class="p">)</span>
<a name="ln-404"></a>
<a name="ln-405"></a>          <span class="n">a32</span> <span class="o">=</span> <span class="p">(((</span><span class="n">v0</span><span class="p">(</span><span class="n">i</span><span class="p">,</span><span class="n">jp</span><span class="p">,</span><span class="n">kp</span><span class="p">)</span> <span class="o">+</span> <span class="n">v0</span><span class="p">(</span><span class="n">i</span><span class="p">,</span><span class="n">j</span><span class="p">,</span><span class="n">kp</span><span class="p">))</span><span class="o">*</span><span class="n">dzf</span><span class="p">(</span><span class="n">k</span><span class="p">)</span>  <span class="o">+</span> <span class="p">&amp;</span>
<a name="ln-406"></a>                  <span class="p">(</span><span class="n">v0</span><span class="p">(</span><span class="n">i</span><span class="p">,</span><span class="n">jp</span><span class="p">,</span><span class="n">k</span><span class="p">)</span>  <span class="o">+</span> <span class="n">v0</span><span class="p">(</span><span class="n">i</span><span class="p">,</span><span class="n">j</span><span class="p">,</span><span class="n">k</span><span class="p">))</span> <span class="o">*</span><span class="n">dzf</span><span class="p">(</span><span class="n">kp</span><span class="p">))</span> <span class="o">*</span> <span class="n">dzhi</span><span class="p">(</span><span class="n">kp</span><span class="p">)</span> <span class="p">&amp;</span>
<a name="ln-407"></a>                         <span class="o">-</span> <span class="p">&amp;</span>
<a name="ln-408"></a>                 <span class="p">((</span><span class="n">v0</span><span class="p">(</span><span class="n">i</span><span class="p">,</span><span class="n">jp</span><span class="p">,</span><span class="n">k</span><span class="p">)</span>  <span class="o">+</span> <span class="n">v0</span><span class="p">(</span><span class="n">i</span><span class="p">,</span><span class="n">j</span><span class="p">,</span><span class="n">k</span><span class="p">))</span> <span class="o">*</span><span class="n">dzf</span><span class="p">(</span><span class="n">km</span><span class="p">)</span> <span class="o">+</span> <span class="p">&amp;</span>
<a name="ln-409"></a>                  <span class="p">(</span><span class="n">v0</span><span class="p">(</span><span class="n">i</span><span class="p">,</span><span class="n">jp</span><span class="p">,</span><span class="n">km</span><span class="p">)</span> <span class="o">+</span> <span class="n">v0</span><span class="p">(</span><span class="n">i</span><span class="p">,</span><span class="n">j</span><span class="p">,</span><span class="n">km</span><span class="p">))</span><span class="o">*</span><span class="n">dzf</span><span class="p">(</span><span class="n">k</span><span class="p">))</span>  <span class="o">*</span> <span class="n">dzhi</span><span class="p">(</span><span class="n">k</span><span class="p">)</span>   <span class="p">)</span><span class="o">*</span><span class="n">dzfiq</span><span class="p">(</span><span class="n">k</span><span class="p">)</span>
<a name="ln-410"></a>
<a name="ln-411"></a>          <span class="n">a33</span> <span class="o">=</span> <span class="p">(</span><span class="n">w0</span><span class="p">(</span><span class="n">i</span><span class="p">,</span><span class="n">j</span><span class="p">,</span><span class="n">kp</span><span class="p">)</span> <span class="o">-</span> <span class="n">w0</span><span class="p">(</span><span class="n">i</span><span class="p">,</span><span class="n">j</span><span class="p">,</span><span class="n">k</span><span class="p">))</span> <span class="o">*</span> <span class="n">dzfi</span><span class="p">(</span><span class="n">k</span><span class="p">)</span>
<a name="ln-412"></a>
<a name="ln-413"></a>          <span class="n">aa</span>  <span class="o">=</span> <span class="n">a11</span><span class="o">*</span><span class="n">a11</span> <span class="o">+</span> <span class="n">a21</span><span class="o">*</span><span class="n">a21</span> <span class="o">+</span> <span class="n">a31</span><span class="o">*</span><span class="n">a31</span> <span class="o">+</span> <span class="p">&amp;</span>
<a name="ln-414"></a>                <span class="n">a12</span><span class="o">*</span><span class="n">a12</span> <span class="o">+</span> <span class="n">a22</span><span class="o">*</span><span class="n">a22</span> <span class="o">+</span> <span class="n">a32</span><span class="o">*</span><span class="n">a32</span> <span class="o">+</span> <span class="p">&amp;</span>
<a name="ln-415"></a>                <span class="n">a13</span><span class="o">*</span><span class="n">a13</span> <span class="o">+</span> <span class="n">a23</span><span class="o">*</span><span class="n">a23</span> <span class="o">+</span> <span class="n">a33</span><span class="o">*</span><span class="n">a33</span>
<a name="ln-416"></a>        
<a name="ln-417"></a>          <span class="n">b11</span> <span class="o">=</span> <span class="n">dxf2</span><span class="p">(</span><span class="n">i</span><span class="p">)</span><span class="o">*</span><span class="n">a11</span><span class="o">*</span><span class="n">a11</span> <span class="o">+</span> <span class="n">dy2</span><span class="o">*</span><span class="n">a21</span><span class="o">*</span><span class="n">a21</span> <span class="o">+</span> <span class="n">dzf2</span><span class="p">(</span><span class="n">k</span><span class="p">)</span><span class="o">*</span><span class="n">a31</span><span class="o">*</span><span class="n">a31</span>
<a name="ln-418"></a>          <span class="n">b22</span> <span class="o">=</span> <span class="n">dxf2</span><span class="p">(</span><span class="n">i</span><span class="p">)</span><span class="o">*</span><span class="n">a12</span><span class="o">*</span><span class="n">a12</span> <span class="o">+</span> <span class="n">dy2</span><span class="o">*</span><span class="n">a22</span><span class="o">*</span><span class="n">a22</span> <span class="o">+</span> <span class="n">dzf2</span><span class="p">(</span><span class="n">k</span><span class="p">)</span><span class="o">*</span><span class="n">a32</span><span class="o">*</span><span class="n">a32</span> 
<a name="ln-419"></a>          <span class="n">b12</span> <span class="o">=</span> <span class="n">dxf2</span><span class="p">(</span><span class="n">i</span><span class="p">)</span><span class="o">*</span><span class="n">a11</span><span class="o">*</span><span class="n">a12</span> <span class="o">+</span> <span class="n">dy2</span><span class="o">*</span><span class="n">a21</span><span class="o">*</span><span class="n">a22</span> <span class="o">+</span> <span class="n">dzf2</span><span class="p">(</span><span class="n">k</span><span class="p">)</span><span class="o">*</span><span class="n">a31</span><span class="o">*</span><span class="n">a32</span> 
<a name="ln-420"></a>          <span class="n">b33</span> <span class="o">=</span> <span class="n">dxf2</span><span class="p">(</span><span class="n">i</span><span class="p">)</span><span class="o">*</span><span class="n">a13</span><span class="o">*</span><span class="n">a13</span> <span class="o">+</span> <span class="n">dy2</span><span class="o">*</span><span class="n">a23</span><span class="o">*</span><span class="n">a23</span> <span class="o">+</span> <span class="n">dzf2</span><span class="p">(</span><span class="n">k</span><span class="p">)</span><span class="o">*</span><span class="n">a33</span><span class="o">*</span><span class="n">a33</span> 
<a name="ln-421"></a>          <span class="n">b13</span> <span class="o">=</span> <span class="n">dxf2</span><span class="p">(</span><span class="n">i</span><span class="p">)</span><span class="o">*</span><span class="n">a11</span><span class="o">*</span><span class="n">a13</span> <span class="o">+</span> <span class="n">dy2</span><span class="o">*</span><span class="n">a21</span><span class="o">*</span><span class="n">a23</span> <span class="o">+</span> <span class="n">dzf2</span><span class="p">(</span><span class="n">k</span><span class="p">)</span><span class="o">*</span><span class="n">a31</span><span class="o">*</span><span class="n">a33</span>
<a name="ln-422"></a>          <span class="n">b23</span> <span class="o">=</span> <span class="n">dxf2</span><span class="p">(</span><span class="n">i</span><span class="p">)</span><span class="o">*</span><span class="n">a12</span><span class="o">*</span><span class="n">a13</span> <span class="o">+</span> <span class="n">dy2</span><span class="o">*</span><span class="n">a22</span><span class="o">*</span><span class="n">a23</span> <span class="o">+</span> <span class="n">dzf2</span><span class="p">(</span><span class="n">k</span><span class="p">)</span><span class="o">*</span><span class="n">a32</span><span class="o">*</span><span class="n">a33</span>
<a name="ln-423"></a>          <span class="n">bb</span> <span class="o">=</span> <span class="n">b11</span><span class="o">*</span><span class="n">b22</span> <span class="o">-</span> <span class="n">b12</span><span class="o">*</span><span class="n">b12</span> <span class="o">+</span> <span class="n">b11</span><span class="o">*</span><span class="n">b33</span> <span class="o">-</span> <span class="n">b13</span><span class="o">*</span><span class="n">b13</span> <span class="o">+</span> <span class="n">b22</span><span class="o">*</span><span class="n">b33</span> <span class="o">-</span> <span class="n">b23</span><span class="o">*</span><span class="n">b23</span>
<a name="ln-424"></a>          <span class="k">if</span> <span class="p">(</span><span class="n">bb</span> <span class="o">&lt;</span> <span class="mf">0.00000001</span><span class="p">)</span> <span class="k">then</span>
<a name="ln-425"></a><span class="k">            </span><span class="n">ekm</span><span class="p">(</span><span class="n">i</span><span class="p">,</span><span class="n">j</span><span class="p">,</span><span class="n">k</span><span class="p">)</span> <span class="o">=</span> <span class="mf">0.</span>
<a name="ln-426"></a>            <span class="n">ekh</span><span class="p">(</span><span class="n">i</span><span class="p">,</span><span class="n">j</span><span class="p">,</span><span class="n">k</span><span class="p">)</span> <span class="o">=</span> <span class="mf">0.</span>
<a name="ln-427"></a>          <span class="k">else</span>
<a name="ln-428"></a><span class="k">            </span><span class="n">ekm</span><span class="p">(</span><span class="n">i</span><span class="p">,</span><span class="n">j</span><span class="p">,</span><span class="n">k</span><span class="p">)</span> <span class="o">=</span> <span class="n">c_vreman</span><span class="o">*</span><span class="nb">sqrt</span><span class="p">(</span><span class="n">bb</span> <span class="o">/</span> <span class="n">aa</span><span class="p">)</span> 
<a name="ln-429"></a>            <span class="n">ekh</span><span class="p">(</span><span class="n">i</span><span class="p">,</span><span class="n">j</span><span class="p">,</span><span class="n">k</span><span class="p">)</span> <span class="o">=</span> <span class="n">ekm</span><span class="p">(</span><span class="n">i</span><span class="p">,</span><span class="n">j</span><span class="p">,</span><span class="n">k</span><span class="p">)</span><span class="o">*</span><span class="n">prandtli</span>
<a name="ln-430"></a>          <span class="k">end if</span>
<a name="ln-431"></a><span class="k">        end do</span>
<a name="ln-432"></a><span class="k">      end do</span>
<a name="ln-433"></a><span class="k">    end do</span>
<a name="ln-434"></a><span class="c">!    ekm(:,:,:) = max(ekm(:,:,:),ekmin)</span>
<a name="ln-435"></a><span class="c">!    ekh(:,:,:) = max(ekh(:,:,:),ekmin)</span>
<a name="ln-436"></a>    <span class="k">end if</span> <span class="c">! lbuoyancy</span>
<a name="ln-437"></a>    <span class="n">ekm</span><span class="p">(:,:,:)</span> <span class="o">=</span> <span class="n">ekm</span><span class="p">(:,:,:)</span> <span class="o">+</span> <span class="n">numol</span>                             <span class="c">! add molecular viscosity</span>
<a name="ln-438"></a>    <span class="n">ekh</span><span class="p">(:,:,:)</span> <span class="o">=</span> <span class="n">ekh</span><span class="p">(:,:,:)</span> <span class="o">+</span> <span class="n">numol</span><span class="o">*</span><span class="n">prandtlmoli</span>                 <span class="c">! add molecular diffusivity</span>
<a name="ln-439"></a>
<a name="ln-440"></a>
<a name="ln-441"></a>        <span class="c">!do TKE scheme</span>
<a name="ln-442"></a>    <span class="n">elseif</span> <span class="p">(</span><span class="n">loneeqn</span> <span class="p">)</span> <span class="k">then </span>
<a name="ln-443"></a><span class="k">       do </span><span class="n">k</span><span class="o">=</span><span class="n">kb</span><span class="p">,</span><span class="n">ke</span>
<a name="ln-444"></a>          <span class="k">do </span><span class="n">j</span><span class="o">=</span><span class="n">jb</span><span class="p">,</span><span class="n">je</span>
<a name="ln-445"></a>             <span class="k">do </span><span class="n">i</span><span class="o">=</span><span class="n">ib</span><span class="p">,</span><span class="n">ie</span>
<a name="ln-446"></a>                <span class="n">iw</span> <span class="o">=</span> <span class="n">wall</span><span class="p">(</span><span class="n">i</span><span class="p">,</span><span class="n">j</span><span class="p">,</span><span class="n">k</span><span class="p">,</span><span class="mi">1</span><span class="p">)</span>   <span class="c">! indices of closest wall</span>
<a name="ln-447"></a>                <span class="n">jw</span> <span class="o">=</span> <span class="n">wall</span><span class="p">(</span><span class="n">i</span><span class="p">,</span><span class="n">j</span><span class="p">,</span><span class="n">k</span><span class="p">,</span><span class="mi">2</span><span class="p">)</span><span class="o">-</span><span class="n">myid</span><span class="o">*</span><span class="n">jmax</span>   <span class="c">! indices of closest wall in local j-index</span>
<a name="ln-448"></a>                <span class="n">kw</span> <span class="o">=</span> <span class="n">wall</span><span class="p">(</span><span class="n">i</span><span class="p">,</span><span class="n">j</span><span class="p">,</span><span class="n">k</span><span class="p">,</span><span class="mi">3</span><span class="p">)</span>
<a name="ln-449"></a>                <span class="n">c1</span> <span class="o">=</span> <span class="n">wall</span><span class="p">(</span><span class="n">i</span><span class="p">,</span><span class="n">j</span><span class="p">,</span><span class="n">k</span><span class="p">,</span><span class="mi">4</span><span class="p">)</span>   <span class="c">! shear stress component</span>
<a name="ln-450"></a>                <span class="n">c2</span> <span class="o">=</span> <span class="n">wall</span><span class="p">(</span><span class="n">i</span><span class="p">,</span><span class="n">j</span><span class="p">,</span><span class="n">k</span><span class="p">,</span><span class="mi">5</span><span class="p">)</span>   <span class="c">! shear stress component</span>
<a name="ln-451"></a>
<a name="ln-452"></a>                <span class="c">!ILS13 removed near-wall damping 25.06.2014</span>
<a name="ln-453"></a>                <span class="c">!if (jw &gt;= jb-1 .and. jw &lt;= je+1) then      ! check if jw is within the halo of this proc</span>
<a name="ln-454"></a>                <span class="c">!  distplus = mindist(i,j,k)*sqrt(abs(shear(iw,jw,kw,c1))+abs(shear(iw,jw,kw,c2)))*numoli</span>
<a name="ln-455"></a>                <span class="c">!  damp(i,j,k) = sqrt(1. - exp((-distplus*0.04)**3.))            ! Wall-damping according to Piomelli</span>
<a name="ln-456"></a>                <span class="c">!else </span>
<a name="ln-457"></a>                <span class="n">damp</span><span class="p">(</span><span class="n">i</span><span class="p">,</span><span class="n">j</span><span class="p">,</span><span class="n">k</span><span class="p">)</span> <span class="o">=</span> <span class="mf">1.</span>
<a name="ln-458"></a>                <span class="c">!end if</span>
<a name="ln-459"></a>                <span class="k">if</span> <span class="p">((</span><span class="n">ldelta</span><span class="p">)</span> <span class="p">.</span><span class="nb">or</span><span class="p">.</span> <span class="p">(</span><span class="n">dthvdz</span><span class="p">(</span><span class="n">i</span><span class="p">,</span><span class="n">j</span><span class="p">,</span><span class="n">k</span><span class="p">)</span><span class="o">&lt;=</span><span class="mi">0</span><span class="p">))</span> <span class="k">then</span>
<a name="ln-460"></a><span class="k">                   </span><span class="n">zlt</span><span class="p">(</span><span class="n">i</span><span class="p">,</span><span class="n">j</span><span class="p">,</span><span class="n">k</span><span class="p">)</span> <span class="o">=</span> <span class="n">delta</span><span class="p">(</span><span class="n">i</span><span class="p">,</span><span class="n">k</span><span class="p">)</span>
<a name="ln-461"></a>                   <span class="n">ekm</span><span class="p">(</span><span class="n">i</span><span class="p">,</span><span class="n">j</span><span class="p">,</span><span class="n">k</span><span class="p">)</span> <span class="o">=</span> <span class="n">cm</span> <span class="o">*</span> <span class="n">zlt</span><span class="p">(</span><span class="n">i</span><span class="p">,</span><span class="n">j</span><span class="p">,</span><span class="n">k</span><span class="p">)</span> <span class="o">*</span><span class="n">damp</span><span class="p">(</span><span class="n">i</span><span class="p">,</span><span class="n">j</span><span class="p">,</span><span class="n">k</span><span class="p">)</span><span class="o">*</span> <span class="n">e120</span><span class="p">(</span><span class="n">i</span><span class="p">,</span><span class="n">j</span><span class="p">,</span><span class="n">k</span><span class="p">)</span> <span class="c">!* 0.5! LES with near-wall damping !!! added factor 0.5 for shear-driven flow</span>
<a name="ln-462"></a>                   <span class="n">ekh</span><span class="p">(</span><span class="n">i</span><span class="p">,</span><span class="n">j</span><span class="p">,</span><span class="n">k</span><span class="p">)</span> <span class="o">=</span> <span class="p">(</span><span class="n">ch1</span> <span class="o">+</span> <span class="n">ch2</span><span class="p">)</span> <span class="o">*</span> <span class="n">ekm</span><span class="p">(</span><span class="n">i</span><span class="p">,</span><span class="n">j</span><span class="p">,</span><span class="n">k</span><span class="p">)</span>               <span class="c">! maybe ekh should be calculated from (molecular) Prandtl number</span>
<a name="ln-463"></a>                   <span class="n">ekm</span><span class="p">(</span><span class="n">i</span><span class="p">,</span><span class="n">j</span><span class="p">,</span><span class="n">k</span><span class="p">)</span> <span class="o">=</span> <span class="n">ekm</span><span class="p">(</span><span class="n">i</span><span class="p">,</span><span class="n">j</span><span class="p">,</span><span class="n">k</span><span class="p">)</span> <span class="o">+</span> <span class="n">numol</span>                     <span class="c">! add molecular viscosity</span>
<a name="ln-464"></a>                   <span class="n">ekh</span><span class="p">(</span><span class="n">i</span><span class="p">,</span><span class="n">j</span><span class="p">,</span><span class="n">k</span><span class="p">)</span> <span class="o">=</span> <span class="n">ekh</span><span class="p">(</span><span class="n">i</span><span class="p">,</span><span class="n">j</span><span class="p">,</span><span class="n">k</span><span class="p">)</span> <span class="o">+</span> <span class="n">numol</span><span class="o">*</span><span class="n">prandtlmoli</span>         <span class="c">! add molecular diffusivity</span>
<a name="ln-465"></a>                <span class="k">else</span>
<a name="ln-466"></a>                   <span class="c">!            zlt(i,j,k) = min(delta(i,k),cn*e120(i,j,k)/sqrt(grav/thvs*abs(dthvdz(i,j,k))))</span>
<a name="ln-467"></a>                   <span class="n">zlt</span><span class="p">(</span><span class="n">i</span><span class="p">,</span><span class="n">j</span><span class="p">,</span><span class="n">k</span><span class="p">)</span> <span class="o">=</span> <span class="nb">min</span><span class="p">(</span><span class="n">delta</span><span class="p">(</span><span class="n">i</span><span class="p">,</span><span class="n">k</span><span class="p">),</span><span class="n">cn</span><span class="o">*</span><span class="n">e120</span><span class="p">(</span><span class="n">i</span><span class="p">,</span><span class="n">j</span><span class="p">,</span><span class="n">k</span><span class="p">)</span><span class="o">/</span><span class="nb">sqrt</span><span class="p">(</span><span class="n">grav</span><span class="o">/</span><span class="n">thvs</span><span class="o">*</span><span class="nb">abs</span><span class="p">(</span><span class="n">dthvdz</span><span class="p">(</span><span class="n">i</span><span class="p">,</span><span class="n">j</span><span class="p">,</span><span class="n">k</span><span class="p">))))</span>   <span class="c">!thls is used</span>
<a name="ln-468"></a>                   <span class="n">ekm</span><span class="p">(</span><span class="n">i</span><span class="p">,</span><span class="n">j</span><span class="p">,</span><span class="n">k</span><span class="p">)</span> <span class="o">=</span> <span class="n">cm</span> <span class="o">*</span> <span class="n">zlt</span><span class="p">(</span><span class="n">i</span><span class="p">,</span><span class="n">j</span><span class="p">,</span><span class="n">k</span><span class="p">)</span> <span class="o">*</span><span class="n">damp</span><span class="p">(</span><span class="n">i</span><span class="p">,</span><span class="n">j</span><span class="p">,</span><span class="n">k</span><span class="p">)</span><span class="o">*</span> <span class="n">e120</span><span class="p">(</span><span class="n">i</span><span class="p">,</span><span class="n">j</span><span class="p">,</span><span class="n">k</span><span class="p">)</span> <span class="c">!* 0.5     ! LES with near-wall damping !!! added factor 0.5 for shear-driven flow</span>
<a name="ln-469"></a>                   <span class="n">ekh</span><span class="p">(</span><span class="n">i</span><span class="p">,</span><span class="n">j</span><span class="p">,</span><span class="n">k</span><span class="p">)</span> <span class="o">=</span> <span class="p">(</span><span class="n">ch1</span> <span class="o">+</span> <span class="n">ch2</span> <span class="o">*</span> <span class="n">zlt</span><span class="p">(</span><span class="n">i</span><span class="p">,</span><span class="n">j</span><span class="p">,</span><span class="n">k</span><span class="p">)</span><span class="o">/</span><span class="n">delta</span><span class="p">(</span><span class="n">i</span><span class="p">,</span><span class="n">k</span><span class="p">))</span> <span class="o">*</span> <span class="n">ekm</span><span class="p">(</span><span class="n">i</span><span class="p">,</span><span class="n">j</span><span class="p">,</span><span class="n">k</span><span class="p">)</span> <span class="c">!  needed in LES!</span>
<a name="ln-470"></a>                   <span class="n">ekm</span><span class="p">(</span><span class="n">i</span><span class="p">,</span><span class="n">j</span><span class="p">,</span><span class="n">k</span><span class="p">)</span> <span class="o">=</span> <span class="n">ekm</span><span class="p">(</span><span class="n">i</span><span class="p">,</span><span class="n">j</span><span class="p">,</span><span class="n">k</span><span class="p">)</span> <span class="o">+</span> <span class="n">numol</span>                     <span class="c">! add molecular viscosity</span>
<a name="ln-471"></a>                   <span class="n">ekh</span><span class="p">(</span><span class="n">i</span><span class="p">,</span><span class="n">j</span><span class="p">,</span><span class="n">k</span><span class="p">)</span> <span class="o">=</span> <span class="n">ekh</span><span class="p">(</span><span class="n">i</span><span class="p">,</span><span class="n">j</span><span class="p">,</span><span class="n">k</span><span class="p">)</span> <span class="o">+</span> <span class="n">numol</span><span class="o">*</span><span class="n">prandtlmoli</span>          <span class="c">! add molecular diffusivity</span>
<a name="ln-472"></a>               <span class="n">endif</span>
<a name="ln-473"></a>             <span class="k">end do</span>
<a name="ln-474"></a><span class="k">          end do</span>
<a name="ln-475"></a><span class="k">       end do</span>
<a name="ln-476"></a>  
<a name="ln-477"></a>               <span class="c">!   write(*,&#39;(1A,F8.4)&#39;) &#39;ekh&#39;, ekh(2,3,3)</span>
<a name="ln-478"></a>
<a name="ln-479"></a>      <span class="n">damp</span><span class="p">(:,:,:)</span> <span class="o">=</span> <span class="nb">max</span><span class="p">(</span><span class="n">damp</span><span class="p">(:,:,:),</span><span class="n">dampmin</span><span class="p">)</span>
<a name="ln-480"></a>       <span class="c">!    ekm(:,:,:) = max(ekm(:,:,:),ekmin)</span>
<a name="ln-481"></a>       <span class="c">!    ekh(:,:,:) = max(ekh(:,:,:),ekmin)</span>
<a name="ln-482"></a>    <span class="k">else</span>   <span class="c">! no subgrid model (DNS!)</span>
<a name="ln-483"></a>       <span class="n">ekm</span> <span class="o">=</span> <span class="n">numol</span>
<a name="ln-484"></a>       <span class="n">ekh</span> <span class="o">=</span> <span class="n">numol</span><span class="o">*</span><span class="n">prandtlmoli</span>
<a name="ln-485"></a>    <span class="k">end if</span>
<a name="ln-486"></a>
<a name="ln-487"></a>    <span class="c">!  write(*,&#39;(A,3(1pE9.2))&#39;) &#39;strain2, ekm, ekh&#39;, strain2, ekm(10,10,10), ekh(10,10,10)     </span>
<a name="ln-488"></a>    <span class="c">!do i=ib,ie  </span>
<a name="ln-489"></a>    <span class="c">!write(*,&#39;(A,1(1pE9.2))&#39;) &#39;damp, ekm&#39;, damp(i,32,kb), ekm(i,32,kb)   </span>
<a name="ln-490"></a>    <span class="c">!end do</span>
<a name="ln-491"></a>
<a name="ln-492"></a>    <span class="c">!*************************************************************</span>
<a name="ln-493"></a>    <span class="c">!     Set boundary condition for K-closure factors.          ! Also other BC&#39;s!!</span>
<a name="ln-494"></a>    <span class="c">!*************************************************************</span>
<a name="ln-495"></a>    <span class="k">call </span><span class="n">closurebc</span>
<a name="ln-496"></a>
<a name="ln-497"></a>    <span class="k">return</span>
<a name="ln-498"></a><span class="k">  end subroutine </span><span class="n">closure</span>
<a name="ln-499"></a>  <span class="k">subroutine </span><span class="n">sources</span>     <span class="c">! only in case of LES computation</span>
<a name="ln-500"></a>
<a name="ln-501"></a>
<a name="ln-502"></a>    <span class="c">!-----------------------------------------------------------------|</span>
<a name="ln-503"></a>    <span class="c">!                                                                 |</span>
<a name="ln-504"></a>    <span class="c">!*** *sources*                                                    |</span>
<a name="ln-505"></a>    <span class="c">!      calculates various terms from the subgrid TKE equation     |</span>
<a name="ln-506"></a>    <span class="c">!                                                                 |</span>
<a name="ln-507"></a>    <span class="c">!     Hans Cuijpers   I.M.A.U.     06/01/1995                     |</span>
<a name="ln-508"></a>    <span class="c">!                                                                 |</span>
<a name="ln-509"></a>    <span class="c">!     purpose.                                                    |</span>
<a name="ln-510"></a>    <span class="c">!     --------                                                    |</span>
<a name="ln-511"></a>    <span class="c">!                                                                 |</span>
<a name="ln-512"></a>    <span class="c">!      Subroutine sources calculates all other terms in the       |</span>
<a name="ln-513"></a>    <span class="c">!      subgrid energy equation, except for the diffusion terms.   |</span>
<a name="ln-514"></a>    <span class="c">!      These terms are calculated in subroutine diff.             |</span>
<a name="ln-515"></a>    <span class="c">!                                                                 |</span>
<a name="ln-516"></a>    <span class="c">!**   interface.                                                  |</span>
<a name="ln-517"></a>    <span class="c">!     ----------                                                  |</span>
<a name="ln-518"></a>    <span class="c">!                                                                 |</span>
<a name="ln-519"></a>    <span class="c">!     *sources* is called from *program*.                         |</span>
<a name="ln-520"></a>    <span class="c">!                                                                 |</span>
<a name="ln-521"></a>    <span class="c">!-----------------------------------------------------------------|</span>
<a name="ln-522"></a>
<a name="ln-523"></a>    <span class="k">use </span><span class="n">modglobal</span><span class="p">,</span>   <span class="n">only</span> <span class="p">:</span> <span class="n">ib</span><span class="p">,</span><span class="n">ie</span><span class="p">,</span><span class="n">jb</span><span class="p">,</span><span class="n">je</span><span class="p">,</span><span class="n">kb</span><span class="p">,</span><span class="n">ke</span><span class="p">,</span><span class="n">delta</span><span class="p">,</span><span class="n">dxhi</span><span class="p">,</span><span class="n">dxfi</span><span class="p">,</span><span class="n">dy</span><span class="p">,</span><span class="n">dyi</span><span class="p">,</span><span class="n">dzfi</span><span class="p">,</span><span class="n">dzhi</span><span class="p">,</span><span class="n">grav</span><span class="p">,</span><span class="n">numol</span><span class="p">,</span><span class="n">prandtlmol</span><span class="p">,&amp;</span>
<a name="ln-524"></a>         <span class="n">dzh</span><span class="p">,</span> <span class="n">delta</span>
<a name="ln-525"></a>    <span class="k">use </span><span class="n">modfields</span><span class="p">,</span>   <span class="n">only</span> <span class="p">:</span> <span class="n">u0</span><span class="p">,</span><span class="n">v0</span><span class="p">,</span><span class="n">w0</span><span class="p">,</span><span class="n">e120</span><span class="p">,</span><span class="n">e12p</span><span class="p">,</span><span class="n">dthvdz</span><span class="p">,</span><span class="n">thl0</span><span class="p">,</span><span class="n">thvf</span>
<a name="ln-526"></a>    <span class="k">use </span><span class="n">modsurfdata</span><span class="p">,</span>  <span class="n">only</span> <span class="p">:</span> <span class="n">dudz</span><span class="p">,</span><span class="n">dvdz</span><span class="p">,</span><span class="n">thvs</span>
<a name="ln-527"></a><span class="c">!    use modmpi,       only : myid</span>
<a name="ln-528"></a>    <span class="k">implicit none</span>
<a name="ln-529"></a>
<a name="ln-530"></a><span class="k">    </span><span class="kt">real    </span><span class="n">tdef2</span><span class="p">,</span><span class="n">prandtlmoli</span>
<a name="ln-531"></a>    <span class="kt">integer </span><span class="n">i</span><span class="p">,</span><span class="n">j</span><span class="p">,</span><span class="n">k</span><span class="p">,</span><span class="n">im</span><span class="p">,</span><span class="n">ip</span><span class="p">,</span><span class="n">jm</span><span class="p">,</span><span class="n">jp</span><span class="p">,</span><span class="n">km</span><span class="p">,</span><span class="n">kp</span>
<a name="ln-532"></a>
<a name="ln-533"></a>    <span class="n">prandtlmoli</span> <span class="o">=</span> <span class="mf">1.</span><span class="o">/</span><span class="n">prandtlmol</span> 
<a name="ln-534"></a>
<a name="ln-535"></a>    <span class="c">! Added by J. Tomas (thermodynamics routine is bypassed)</span>
<a name="ln-536"></a>    <span class="c">! thv does not exist (equals thl), therefore dthvdz is computed here</span>
<a name="ln-537"></a>    <span class="c">! IS+HJ: thermodynamics is back in now (which calculates dthvdz)</span>
<a name="ln-538"></a>    <span class="c">!    do k=kb,ke</span>
<a name="ln-539"></a>    <span class="c">!      do j=jb,je</span>
<a name="ln-540"></a>    <span class="c">!        do i=ib,ie</span>
<a name="ln-541"></a>    <span class="c">!          dthvdz(i,j,k) = (thl0(i,j,k+1)-thl0(i,j,k-1))/(dzh(k+1)+dzh(k))</span>
<a name="ln-542"></a>    <span class="c">! !         if (dthvdz(i,j,k) == 0.0) then</span>
<a name="ln-543"></a>    <span class="c">! !           write(6,*) &#39;dthvdz(i,j,k)=0,i,j,k&#39;,i,j,k</span>
<a name="ln-544"></a>    <span class="c">! !         end if</span>
<a name="ln-545"></a>    <span class="c">!        end do</span>
<a name="ln-546"></a>    <span class="c">!      end do</span>
<a name="ln-547"></a>    <span class="c">!    end do</span>
<a name="ln-548"></a>    <span class="c">! End of addition by J. Tomas (thermodynamics routine is bypassed)</span>
<a name="ln-549"></a>
<a name="ln-550"></a>    <span class="k">do </span><span class="n">k</span><span class="o">=</span><span class="n">kb</span><span class="o">+</span><span class="mi">1</span><span class="p">,</span><span class="n">ke</span>
<a name="ln-551"></a>       <span class="k">do </span><span class="n">j</span><span class="o">=</span><span class="n">jb</span><span class="p">,</span><span class="n">je</span>
<a name="ln-552"></a>          <span class="k">do </span><span class="n">i</span><span class="o">=</span><span class="n">ib</span><span class="p">,</span><span class="n">ie</span>
<a name="ln-553"></a>             <span class="n">kp</span><span class="o">=</span><span class="n">k</span><span class="o">+</span><span class="mi">1</span>
<a name="ln-554"></a>             <span class="n">km</span><span class="o">=</span><span class="n">k</span><span class="o">-</span><span class="mi">1</span>
<a name="ln-555"></a>             <span class="n">jp</span><span class="o">=</span><span class="n">j</span><span class="o">+</span><span class="mi">1</span>
<a name="ln-556"></a>             <span class="n">jm</span><span class="o">=</span><span class="n">j</span><span class="o">-</span><span class="mi">1</span>
<a name="ln-557"></a>             <span class="n">ip</span><span class="o">=</span><span class="n">i</span><span class="o">+</span><span class="mi">1</span>
<a name="ln-558"></a>             <span class="n">im</span><span class="o">=</span><span class="n">i</span><span class="o">-</span><span class="mi">1</span>
<a name="ln-559"></a>
<a name="ln-560"></a>             <span class="n">tdef2</span> <span class="o">=</span> <span class="mf">2.</span> <span class="o">*</span> <span class="p">(</span> <span class="p">&amp;</span>
<a name="ln-561"></a>                  <span class="p">((</span><span class="n">u0</span><span class="p">(</span><span class="n">ip</span><span class="p">,</span><span class="n">j</span><span class="p">,</span><span class="n">k</span><span class="p">)</span><span class="o">-</span><span class="n">u0</span><span class="p">(</span><span class="n">i</span><span class="p">,</span><span class="n">j</span><span class="p">,</span><span class="n">k</span><span class="p">))</span>      <span class="o">*</span> <span class="n">dxfi</span><span class="p">(</span><span class="n">i</span><span class="p">)</span>  <span class="p">)</span><span class="o">**</span><span class="mi">2</span> <span class="o">+</span> <span class="p">&amp;</span>
<a name="ln-562"></a>                  <span class="p">((</span><span class="n">v0</span><span class="p">(</span><span class="n">i</span><span class="p">,</span><span class="n">jp</span><span class="p">,</span><span class="n">k</span><span class="p">)</span><span class="o">-</span><span class="n">v0</span><span class="p">(</span><span class="n">i</span><span class="p">,</span><span class="n">j</span><span class="p">,</span><span class="n">k</span><span class="p">))</span>      <span class="o">*</span> <span class="n">dyi</span>      <span class="p">)</span><span class="o">**</span><span class="mi">2</span> <span class="o">+</span> <span class="p">&amp;</span>
<a name="ln-563"></a>                  <span class="p">((</span><span class="n">w0</span><span class="p">(</span><span class="n">i</span><span class="p">,</span><span class="n">j</span><span class="p">,</span><span class="n">kp</span><span class="p">)</span><span class="o">-</span><span class="n">w0</span><span class="p">(</span><span class="n">i</span><span class="p">,</span><span class="n">j</span><span class="p">,</span><span class="n">k</span><span class="p">))</span>      <span class="o">*</span> <span class="n">dzfi</span><span class="p">(</span><span class="n">k</span><span class="p">)</span>  <span class="p">)</span><span class="o">**</span><span class="mi">2</span>   <span class="p">)</span>
<a name="ln-564"></a>
<a name="ln-565"></a>             <span class="n">tdef2</span> <span class="o">=</span> <span class="n">tdef2</span> <span class="o">+</span> <span class="mf">0.25</span> <span class="o">*</span> <span class="p">(</span> <span class="p">&amp;</span>
<a name="ln-566"></a>                  <span class="p">((</span><span class="n">w0</span><span class="p">(</span><span class="n">i</span><span class="p">,</span><span class="n">j</span><span class="p">,</span><span class="n">kp</span><span class="p">)</span><span class="o">-</span><span class="n">w0</span><span class="p">(</span><span class="n">im</span><span class="p">,</span><span class="n">j</span><span class="p">,</span><span class="n">kp</span><span class="p">))</span>   <span class="o">*</span> <span class="n">dxhi</span><span class="p">(</span><span class="n">i</span><span class="p">)</span>       <span class="o">+</span> <span class="p">&amp;</span>
<a name="ln-567"></a>                  <span class="p">(</span><span class="n">u0</span><span class="p">(</span><span class="n">i</span><span class="p">,</span><span class="n">j</span><span class="p">,</span><span class="n">kp</span><span class="p">)</span><span class="o">-</span><span class="n">u0</span><span class="p">(</span><span class="n">i</span><span class="p">,</span><span class="n">j</span><span class="p">,</span><span class="n">k</span><span class="p">))</span>     <span class="o">*</span> <span class="n">dzhi</span><span class="p">(</span><span class="n">kp</span><span class="p">)</span> <span class="p">)</span><span class="o">**</span><span class="mi">2</span> <span class="o">+</span> <span class="p">&amp;</span>
<a name="ln-568"></a>                  <span class="c">!</span>
<a name="ln-569"></a>                  <span class="p">((</span><span class="n">w0</span><span class="p">(</span><span class="n">i</span><span class="p">,</span><span class="n">j</span><span class="p">,</span><span class="n">k</span><span class="p">)</span><span class="o">-</span><span class="n">w0</span><span class="p">(</span><span class="n">im</span><span class="p">,</span><span class="n">j</span><span class="p">,</span><span class="n">k</span><span class="p">))</span>     <span class="o">*</span> <span class="n">dxhi</span><span class="p">(</span><span class="n">i</span><span class="p">)</span>       <span class="o">+</span> <span class="p">&amp;</span>
<a name="ln-570"></a>                  <span class="p">(</span><span class="n">u0</span><span class="p">(</span><span class="n">i</span><span class="p">,</span><span class="n">j</span><span class="p">,</span><span class="n">k</span><span class="p">)</span><span class="o">-</span><span class="n">u0</span><span class="p">(</span><span class="n">i</span><span class="p">,</span><span class="n">j</span><span class="p">,</span><span class="n">km</span><span class="p">))</span>     <span class="o">*</span> <span class="n">dzhi</span><span class="p">(</span><span class="n">k</span><span class="p">)</span>  <span class="p">)</span><span class="o">**</span><span class="mi">2</span> <span class="o">+</span> <span class="p">&amp;</span>
<a name="ln-571"></a>                  <span class="c">!</span>
<a name="ln-572"></a>                  <span class="p">((</span><span class="n">w0</span><span class="p">(</span><span class="n">ip</span><span class="p">,</span><span class="n">j</span><span class="p">,</span><span class="n">k</span><span class="p">)</span><span class="o">-</span><span class="n">w0</span><span class="p">(</span><span class="n">i</span><span class="p">,</span><span class="n">j</span><span class="p">,</span><span class="n">k</span><span class="p">))</span>     <span class="o">*</span> <span class="n">dxhi</span><span class="p">(</span><span class="n">ip</span><span class="p">)</span>      <span class="o">+</span> <span class="p">&amp;</span>
<a name="ln-573"></a>                  <span class="p">(</span><span class="n">u0</span><span class="p">(</span><span class="n">ip</span><span class="p">,</span><span class="n">j</span><span class="p">,</span><span class="n">k</span><span class="p">)</span><span class="o">-</span><span class="n">u0</span><span class="p">(</span><span class="n">ip</span><span class="p">,</span><span class="n">j</span><span class="p">,</span><span class="n">km</span><span class="p">))</span>   <span class="o">*</span> <span class="n">dzhi</span><span class="p">(</span><span class="n">k</span><span class="p">)</span>  <span class="p">)</span><span class="o">**</span><span class="mi">2</span> <span class="o">+</span> <span class="p">&amp;</span>
<a name="ln-574"></a>                  <span class="c">!</span>
<a name="ln-575"></a>                  <span class="p">((</span><span class="n">w0</span><span class="p">(</span><span class="n">ip</span><span class="p">,</span><span class="n">j</span><span class="p">,</span><span class="n">kp</span><span class="p">)</span><span class="o">-</span><span class="n">w0</span><span class="p">(</span><span class="n">i</span><span class="p">,</span><span class="n">j</span><span class="p">,</span><span class="n">kp</span><span class="p">))</span>   <span class="o">*</span> <span class="n">dxhi</span><span class="p">(</span><span class="n">ip</span><span class="p">)</span>      <span class="o">+</span> <span class="p">&amp;</span>
<a name="ln-576"></a>                  <span class="p">(</span><span class="n">u0</span><span class="p">(</span><span class="n">ip</span><span class="p">,</span><span class="n">j</span><span class="p">,</span><span class="n">kp</span><span class="p">)</span><span class="o">-</span><span class="n">u0</span><span class="p">(</span><span class="n">ip</span><span class="p">,</span><span class="n">j</span><span class="p">,</span><span class="n">k</span><span class="p">))</span>   <span class="o">*</span> <span class="n">dzhi</span><span class="p">(</span><span class="n">kp</span><span class="p">)</span> <span class="p">)</span><span class="o">**</span><span class="mi">2</span>   <span class="p">)</span>
<a name="ln-577"></a>
<a name="ln-578"></a>             <span class="n">tdef2</span> <span class="o">=</span> <span class="n">tdef2</span> <span class="o">+</span> <span class="mf">0.25</span> <span class="o">*</span> <span class="p">(</span> <span class="p">&amp;</span>
<a name="ln-579"></a>                  <span class="p">((</span><span class="n">u0</span><span class="p">(</span><span class="n">i</span><span class="p">,</span><span class="n">jp</span><span class="p">,</span><span class="n">k</span><span class="p">)</span><span class="o">-</span><span class="n">u0</span><span class="p">(</span><span class="n">i</span><span class="p">,</span><span class="n">j</span><span class="p">,</span><span class="n">k</span><span class="p">))</span>     <span class="o">*</span> <span class="n">dyi</span>           <span class="o">+</span> <span class="p">&amp;</span>
<a name="ln-580"></a>                  <span class="p">(</span><span class="n">v0</span><span class="p">(</span><span class="n">i</span><span class="p">,</span><span class="n">jp</span><span class="p">,</span><span class="n">k</span><span class="p">)</span><span class="o">-</span><span class="n">v0</span><span class="p">(</span><span class="n">im</span><span class="p">,</span><span class="n">jp</span><span class="p">,</span><span class="n">k</span><span class="p">))</span>   <span class="o">*</span> <span class="n">dxhi</span><span class="p">(</span><span class="n">i</span><span class="p">)</span>  <span class="p">)</span><span class="o">**</span><span class="mi">2</span> <span class="o">+</span> <span class="p">&amp;</span>
<a name="ln-581"></a>                  <span class="c">!</span>
<a name="ln-582"></a>                  <span class="p">((</span><span class="n">u0</span><span class="p">(</span><span class="n">i</span><span class="p">,</span><span class="n">j</span><span class="p">,</span><span class="n">k</span><span class="p">)</span><span class="o">-</span><span class="n">u0</span><span class="p">(</span><span class="n">i</span><span class="p">,</span><span class="n">jm</span><span class="p">,</span><span class="n">k</span><span class="p">))</span>     <span class="o">*</span> <span class="n">dyi</span>           <span class="o">+</span> <span class="p">&amp;</span>
<a name="ln-583"></a>                  <span class="p">(</span><span class="n">v0</span><span class="p">(</span><span class="n">i</span><span class="p">,</span><span class="n">j</span><span class="p">,</span><span class="n">k</span><span class="p">)</span><span class="o">-</span><span class="n">v0</span><span class="p">(</span><span class="n">im</span><span class="p">,</span><span class="n">j</span><span class="p">,</span><span class="n">k</span><span class="p">))</span>     <span class="o">*</span> <span class="n">dxhi</span><span class="p">(</span><span class="n">i</span><span class="p">)</span>  <span class="p">)</span><span class="o">**</span><span class="mi">2</span> <span class="o">+</span> <span class="p">&amp;</span>       
<a name="ln-584"></a>                  <span class="c">!</span>
<a name="ln-585"></a>                  <span class="p">((</span><span class="n">u0</span><span class="p">(</span><span class="n">ip</span><span class="p">,</span><span class="n">j</span><span class="p">,</span><span class="n">k</span><span class="p">)</span><span class="o">-</span><span class="n">u0</span><span class="p">(</span><span class="n">ip</span><span class="p">,</span><span class="n">jm</span><span class="p">,</span><span class="n">k</span><span class="p">))</span>   <span class="o">*</span> <span class="n">dyi</span>           <span class="o">+</span> <span class="p">&amp;</span>
<a name="ln-586"></a>                  <span class="p">(</span><span class="n">v0</span><span class="p">(</span><span class="n">ip</span><span class="p">,</span><span class="n">j</span><span class="p">,</span><span class="n">k</span><span class="p">)</span><span class="o">-</span><span class="n">v0</span><span class="p">(</span><span class="n">i</span><span class="p">,</span><span class="n">j</span><span class="p">,</span><span class="n">k</span><span class="p">))</span>     <span class="o">*</span> <span class="n">dxhi</span><span class="p">(</span><span class="n">ip</span><span class="p">))</span><span class="o">**</span><span class="mi">2</span>  <span class="o">+</span> <span class="p">&amp;</span>
<a name="ln-587"></a>                  <span class="c">!</span>
<a name="ln-588"></a>                  <span class="p">((</span><span class="n">u0</span><span class="p">(</span><span class="n">ip</span><span class="p">,</span><span class="n">jp</span><span class="p">,</span><span class="n">k</span><span class="p">)</span><span class="o">-</span><span class="n">u0</span><span class="p">(</span><span class="n">ip</span><span class="p">,</span><span class="n">j</span><span class="p">,</span><span class="n">k</span><span class="p">))</span>   <span class="o">*</span> <span class="n">dyi</span>           <span class="o">+</span> <span class="p">&amp;</span>
<a name="ln-589"></a>                  <span class="p">(</span><span class="n">v0</span><span class="p">(</span><span class="n">ip</span><span class="p">,</span><span class="n">jp</span><span class="p">,</span><span class="n">k</span><span class="p">)</span><span class="o">-</span><span class="n">v0</span><span class="p">(</span><span class="n">i</span><span class="p">,</span><span class="n">jp</span><span class="p">,</span><span class="n">k</span><span class="p">))</span>   <span class="o">*</span> <span class="n">dxhi</span><span class="p">(</span><span class="n">ip</span><span class="p">))</span><span class="o">**</span><span class="mi">2</span>    <span class="p">)</span>
<a name="ln-590"></a>
<a name="ln-591"></a>             <span class="n">tdef2</span> <span class="o">=</span> <span class="n">tdef2</span> <span class="o">+</span> <span class="mf">0.25</span> <span class="o">*</span> <span class="p">(</span> <span class="p">&amp;</span>
<a name="ln-592"></a>                  <span class="p">((</span><span class="n">v0</span><span class="p">(</span><span class="n">i</span><span class="p">,</span><span class="n">j</span><span class="p">,</span><span class="n">kp</span><span class="p">)</span><span class="o">-</span><span class="n">v0</span><span class="p">(</span><span class="n">i</span><span class="p">,</span><span class="n">j</span><span class="p">,</span><span class="n">k</span><span class="p">))</span>     <span class="o">*</span> <span class="n">dzhi</span><span class="p">(</span><span class="n">kp</span><span class="p">)</span>      <span class="o">+</span> <span class="p">&amp;</span>
<a name="ln-593"></a>                  <span class="p">(</span><span class="n">w0</span><span class="p">(</span><span class="n">i</span><span class="p">,</span><span class="n">j</span><span class="p">,</span><span class="n">kp</span><span class="p">)</span><span class="o">-</span><span class="n">w0</span><span class="p">(</span><span class="n">i</span><span class="p">,</span><span class="n">jm</span><span class="p">,</span><span class="n">kp</span><span class="p">))</span>   <span class="o">*</span> <span class="n">dyi</span>      <span class="p">)</span><span class="o">**</span><span class="mi">2</span> <span class="o">+</span> <span class="p">&amp;</span>
<a name="ln-594"></a>                  <span class="c">!             </span>
<a name="ln-595"></a>                  <span class="p">((</span><span class="n">v0</span><span class="p">(</span><span class="n">i</span><span class="p">,</span><span class="n">j</span><span class="p">,</span><span class="n">k</span><span class="p">)</span><span class="o">-</span><span class="n">v0</span><span class="p">(</span><span class="n">i</span><span class="p">,</span><span class="n">j</span><span class="p">,</span><span class="n">km</span><span class="p">))</span>     <span class="o">*</span> <span class="n">dzhi</span><span class="p">(</span><span class="n">k</span><span class="p">)</span>       <span class="o">+</span> <span class="p">&amp;</span>
<a name="ln-596"></a>                  <span class="p">(</span><span class="n">w0</span><span class="p">(</span><span class="n">i</span><span class="p">,</span><span class="n">j</span><span class="p">,</span><span class="n">k</span><span class="p">)</span><span class="o">-</span><span class="n">w0</span><span class="p">(</span><span class="n">i</span><span class="p">,</span><span class="n">jm</span><span class="p">,</span><span class="n">k</span><span class="p">))</span>     <span class="o">*</span> <span class="n">dyi</span>      <span class="p">)</span><span class="o">**</span><span class="mi">2</span> <span class="o">+</span> <span class="p">&amp;</span>
<a name="ln-597"></a>                  <span class="c">!</span>
<a name="ln-598"></a>                  <span class="p">((</span><span class="n">v0</span><span class="p">(</span><span class="n">i</span><span class="p">,</span><span class="n">jp</span><span class="p">,</span><span class="n">k</span><span class="p">)</span><span class="o">-</span><span class="n">v0</span><span class="p">(</span><span class="n">i</span><span class="p">,</span><span class="n">jp</span><span class="p">,</span><span class="n">km</span><span class="p">))</span>   <span class="o">*</span> <span class="n">dzhi</span><span class="p">(</span><span class="n">k</span><span class="p">)</span>       <span class="o">+</span> <span class="p">&amp;</span>
<a name="ln-599"></a>                  <span class="p">(</span><span class="n">w0</span><span class="p">(</span><span class="n">i</span><span class="p">,</span><span class="n">jp</span><span class="p">,</span><span class="n">k</span><span class="p">)</span><span class="o">-</span><span class="n">w0</span><span class="p">(</span><span class="n">i</span><span class="p">,</span><span class="n">j</span><span class="p">,</span><span class="n">k</span><span class="p">))</span>     <span class="o">*</span> <span class="n">dyi</span>      <span class="p">)</span><span class="o">**</span><span class="mi">2</span> <span class="o">+</span> <span class="p">&amp;</span>
<a name="ln-600"></a>                  <span class="c">!</span>
<a name="ln-601"></a>                  <span class="p">((</span><span class="n">v0</span><span class="p">(</span><span class="n">i</span><span class="p">,</span><span class="n">jp</span><span class="p">,</span><span class="n">kp</span><span class="p">)</span><span class="o">-</span><span class="n">v0</span><span class="p">(</span><span class="n">i</span><span class="p">,</span><span class="n">jp</span><span class="p">,</span><span class="n">k</span><span class="p">))</span>   <span class="o">*</span> <span class="n">dzhi</span><span class="p">(</span><span class="n">kp</span><span class="p">)</span>      <span class="o">+</span> <span class="p">&amp;</span>
<a name="ln-602"></a>                  <span class="p">(</span><span class="n">w0</span><span class="p">(</span><span class="n">i</span><span class="p">,</span><span class="n">jp</span><span class="p">,</span><span class="n">kp</span><span class="p">)</span><span class="o">-</span><span class="n">w0</span><span class="p">(</span><span class="n">i</span><span class="p">,</span><span class="n">j</span><span class="p">,</span><span class="n">kp</span><span class="p">))</span>   <span class="o">*</span> <span class="n">dyi</span>      <span class="p">)</span><span class="o">**</span><span class="mi">2</span>   <span class="p">)</span>
<a name="ln-603"></a>
<a name="ln-604"></a>
<a name="ln-605"></a>             <span class="c">!    sbshr(i,j,k)  = ekm(i,j,k)*tdef2/ ( 2*e120(i,j,k))</span>
<a name="ln-606"></a>             <span class="c">!    sbbuo(i,j,k)  = -ekh(i,j,k)*grav/thvs*dthvdz(i,j,k)/ ( 2*e120(i,j,k))</span>
<a name="ln-607"></a>             <span class="c">!    sbdiss(i,j,k) = - (ce1 + ce2*zlt(i,j,k)/delta(i,k)) * e120(i,j,k)**2 /(2.*zlt(i,j,k))</span>
<a name="ln-608"></a>             <span class="n">sbshr</span><span class="p">(</span><span class="n">i</span><span class="p">,</span><span class="n">j</span><span class="p">,</span><span class="n">k</span><span class="p">)</span>  <span class="o">=</span> <span class="p">(</span><span class="n">ekm</span><span class="p">(</span><span class="n">i</span><span class="p">,</span><span class="n">j</span><span class="p">,</span><span class="n">k</span><span class="p">)</span><span class="o">-</span><span class="n">numol</span><span class="p">)</span><span class="o">*</span><span class="n">tdef2</span><span class="o">/</span> <span class="p">(</span> <span class="mi">2</span><span class="o">*</span><span class="n">e120</span><span class="p">(</span><span class="n">i</span><span class="p">,</span><span class="n">j</span><span class="p">,</span><span class="n">k</span><span class="p">))</span>                                   <span class="c">! subtract molecular viscosity</span>
<a name="ln-609"></a>             <span class="c">!    sbbuo(i,j,k)  = -(ekh(i,j,k)-numol*prandtlmoli)*grav/thvs*dthvdz(i,j,k)/ ( 2*e120(i,j,k))     ! subtract molecular diffusivity</span>
<a name="ln-610"></a>             <span class="n">sbbuo</span><span class="p">(</span><span class="n">i</span><span class="p">,</span><span class="n">j</span><span class="p">,</span><span class="n">k</span><span class="p">)</span>  <span class="o">=</span> <span class="o">-</span><span class="p">(</span><span class="n">ekh</span><span class="p">(</span><span class="n">i</span><span class="p">,</span><span class="n">j</span><span class="p">,</span><span class="n">k</span><span class="p">)</span><span class="o">-</span><span class="n">numol</span><span class="o">*</span><span class="n">prandtlmoli</span><span class="p">)</span><span class="o">*</span><span class="n">grav</span><span class="o">/</span><span class="n">thvs</span><span class="o">*</span><span class="n">dthvdz</span><span class="p">(</span><span class="n">i</span><span class="p">,</span><span class="n">j</span><span class="p">,</span><span class="n">k</span><span class="p">)</span><span class="o">/</span> <span class="p">(</span> <span class="mi">2</span><span class="o">*</span><span class="n">e120</span><span class="p">(</span><span class="n">i</span><span class="p">,</span><span class="n">j</span><span class="p">,</span><span class="n">k</span><span class="p">))</span>     <span class="c">! subtract molecular diffusivity and use thls instead of thvs (not defined)</span>
<a name="ln-611"></a>             <span class="c">!    sbdiss(i,j,k) = - (ce1 + ce2*zlt(i,j,k)/delta(i,k)) * e120(i,j,k)**2 /(2.*damp*zlt(i,j,k))   ! add near-wall damping function</span>
<a name="ln-612"></a>             <span class="c">! added factor 2. for shear-driven flow</span>
<a name="ln-613"></a>             <span class="n">sbdiss</span><span class="p">(</span><span class="n">i</span><span class="p">,</span><span class="n">j</span><span class="p">,</span><span class="n">k</span><span class="p">)</span> <span class="o">=</span> <span class="o">-</span> <span class="mf">2.</span> <span class="o">*</span> <span class="p">(</span><span class="n">ce1</span> <span class="o">+</span> <span class="n">ce2</span><span class="o">*</span><span class="n">zlt</span><span class="p">(</span><span class="n">i</span><span class="p">,</span><span class="n">j</span><span class="p">,</span><span class="n">k</span><span class="p">)</span><span class="o">/</span><span class="n">delta</span><span class="p">(</span><span class="n">i</span><span class="p">,</span><span class="n">k</span><span class="p">))</span> <span class="o">*</span> <span class="n">e120</span><span class="p">(</span><span class="n">i</span><span class="p">,</span><span class="n">j</span><span class="p">,</span><span class="n">k</span><span class="p">)</span><span class="o">**</span><span class="mi">2</span> <span class="o">/</span><span class="p">(</span><span class="mf">2.</span><span class="o">*</span><span class="n">damp</span><span class="p">(</span><span class="n">i</span><span class="p">,</span><span class="n">j</span><span class="p">,</span><span class="n">k</span><span class="p">)</span><span class="o">*</span><span class="n">zlt</span><span class="p">(</span><span class="n">i</span><span class="p">,</span><span class="n">j</span><span class="p">,</span><span class="n">k</span><span class="p">))</span>   <span class="c">! add near-wall damping function !! added f</span>
<a name="ln-614"></a>          <span class="k">end do</span>
<a name="ln-615"></a><span class="k">       end do</span>
<a name="ln-616"></a><span class="k">    end do</span>
<a name="ln-617"></a>    <span class="c">!     ----------------------------------------------end i,j,k-loop</span>
<a name="ln-618"></a>    <span class="c">!    special treatment for lowest level</span>
<a name="ln-619"></a>
<a name="ln-620"></a>    <span class="k">do </span><span class="n">j</span><span class="o">=</span><span class="n">jb</span><span class="p">,</span><span class="n">je</span>
<a name="ln-621"></a>       <span class="k">do </span><span class="n">i</span><span class="o">=</span><span class="n">ib</span><span class="p">,</span><span class="n">ie</span>
<a name="ln-622"></a>          <span class="n">jp</span><span class="o">=</span><span class="n">j</span><span class="o">+</span><span class="mi">1</span>
<a name="ln-623"></a>          <span class="n">jm</span><span class="o">=</span><span class="n">j</span><span class="o">-</span><span class="mi">1</span>
<a name="ln-624"></a>
<a name="ln-625"></a>
<a name="ln-626"></a>          <span class="n">tdef2</span><span class="o">=</span> <span class="mf">2.</span> <span class="o">*</span> <span class="p">(</span> <span class="p">&amp;</span>
<a name="ln-627"></a>               <span class="p">((</span><span class="n">u0</span><span class="p">(</span><span class="n">i</span><span class="o">+</span><span class="mi">1</span><span class="p">,</span><span class="n">j</span><span class="p">,</span><span class="n">kb</span><span class="p">)</span><span class="o">-</span><span class="n">u0</span><span class="p">(</span><span class="n">i</span><span class="p">,</span><span class="n">j</span><span class="p">,</span><span class="n">kb</span><span class="p">))</span><span class="o">*</span><span class="n">dxfi</span><span class="p">(</span><span class="n">i</span><span class="p">))</span><span class="o">**</span><span class="mi">2</span> <span class="p">&amp;</span>
<a name="ln-628"></a>               <span class="o">+</span> <span class="p">((</span><span class="n">v0</span><span class="p">(</span><span class="n">i</span><span class="p">,</span><span class="n">jp</span><span class="p">,</span><span class="n">kb</span><span class="p">)</span><span class="o">-</span><span class="n">v0</span><span class="p">(</span><span class="n">i</span><span class="p">,</span><span class="n">j</span><span class="p">,</span><span class="n">kb</span><span class="p">))</span><span class="o">*</span><span class="n">dyi</span><span class="p">)</span><span class="o">**</span><span class="mi">2</span> <span class="p">&amp;</span>
<a name="ln-629"></a>               <span class="o">+</span> <span class="p">((</span><span class="n">w0</span><span class="p">(</span><span class="n">i</span><span class="p">,</span><span class="n">j</span><span class="p">,</span><span class="n">kb</span><span class="o">+</span><span class="mi">1</span><span class="p">)</span><span class="o">-</span><span class="n">w0</span><span class="p">(</span><span class="n">i</span><span class="p">,</span><span class="n">j</span><span class="p">,</span><span class="n">kb</span><span class="p">))</span><span class="o">*</span><span class="n">dzfi</span><span class="p">(</span><span class="n">kb</span><span class="p">))</span><span class="o">**</span><span class="mi">2</span>   <span class="p">)</span>
<a name="ln-630"></a>
<a name="ln-631"></a>          <span class="n">tdef2</span> <span class="o">=</span> <span class="n">tdef2</span> <span class="o">+</span> <span class="p">(</span> <span class="mf">0.25</span><span class="o">*</span><span class="p">(</span><span class="n">w0</span><span class="p">(</span><span class="n">i</span><span class="o">+</span><span class="mi">1</span><span class="p">,</span><span class="n">j</span><span class="p">,</span><span class="n">kb</span><span class="o">+</span><span class="mi">1</span><span class="p">)</span><span class="o">-</span><span class="n">w0</span><span class="p">(</span><span class="n">i</span><span class="o">-</span><span class="mi">1</span><span class="p">,</span><span class="n">j</span><span class="p">,</span><span class="n">kb</span><span class="o">+</span><span class="mi">1</span><span class="p">))</span><span class="o">*</span><span class="n">dxfi</span><span class="p">(</span><span class="n">i</span><span class="p">)</span> <span class="o">+</span> <span class="p">&amp;</span>
<a name="ln-632"></a>               <span class="n">dudz</span><span class="p">(</span><span class="n">i</span><span class="p">,</span><span class="n">j</span><span class="p">)</span>   <span class="p">)</span><span class="o">**</span><span class="mi">2</span>
<a name="ln-633"></a>
<a name="ln-634"></a>          <span class="n">tdef2</span> <span class="o">=</span> <span class="n">tdef2</span> <span class="o">+</span>   <span class="mf">0.25</span> <span class="o">*</span><span class="p">(</span> <span class="p">&amp;</span>
<a name="ln-635"></a>               <span class="p">((</span><span class="n">u0</span><span class="p">(</span><span class="n">i</span><span class="p">,</span><span class="n">jp</span><span class="p">,</span><span class="n">kb</span><span class="p">)</span><span class="o">-</span><span class="n">u0</span><span class="p">(</span><span class="n">i</span><span class="p">,</span><span class="n">j</span><span class="p">,</span><span class="n">kb</span><span class="p">))</span><span class="o">*</span><span class="n">dyi</span><span class="o">+</span><span class="p">(</span><span class="n">v0</span><span class="p">(</span><span class="n">i</span><span class="p">,</span><span class="n">jp</span><span class="p">,</span><span class="n">kb</span><span class="p">)</span><span class="o">-</span><span class="n">v0</span><span class="p">(</span><span class="n">i</span><span class="o">-</span><span class="mi">1</span><span class="p">,</span><span class="n">jp</span><span class="p">,</span><span class="n">kb</span><span class="p">))</span><span class="o">*</span><span class="n">dxfi</span><span class="p">(</span><span class="n">i</span><span class="p">))</span><span class="o">**</span><span class="mi">2</span> <span class="p">&amp;</span>
<a name="ln-636"></a>               <span class="o">+</span><span class="p">((</span><span class="n">u0</span><span class="p">(</span><span class="n">i</span><span class="p">,</span><span class="n">j</span><span class="p">,</span><span class="n">kb</span><span class="p">)</span><span class="o">-</span><span class="n">u0</span><span class="p">(</span><span class="n">i</span><span class="p">,</span><span class="n">jm</span><span class="p">,</span><span class="n">kb</span><span class="p">))</span><span class="o">*</span><span class="n">dyi</span><span class="o">+</span><span class="p">(</span><span class="n">v0</span><span class="p">(</span><span class="n">i</span><span class="p">,</span><span class="n">j</span><span class="p">,</span><span class="n">kb</span><span class="p">)</span><span class="o">-</span><span class="n">v0</span><span class="p">(</span><span class="n">i</span><span class="o">-</span><span class="mi">1</span><span class="p">,</span><span class="n">j</span><span class="p">,</span><span class="n">kb</span><span class="p">))</span><span class="o">*</span><span class="n">dxfi</span><span class="p">(</span><span class="n">i</span><span class="p">))</span><span class="o">**</span><span class="mi">2</span> <span class="p">&amp;</span>
<a name="ln-637"></a>               <span class="o">+</span><span class="p">((</span><span class="n">u0</span><span class="p">(</span><span class="n">i</span><span class="o">+</span><span class="mi">1</span><span class="p">,</span><span class="n">j</span><span class="p">,</span><span class="n">kb</span><span class="p">)</span><span class="o">-</span><span class="n">u0</span><span class="p">(</span><span class="n">i</span><span class="o">+</span><span class="mi">1</span><span class="p">,</span><span class="n">jm</span><span class="p">,</span><span class="n">kb</span><span class="p">))</span><span class="o">*</span><span class="n">dyi</span><span class="o">+</span><span class="p">(</span><span class="n">v0</span><span class="p">(</span><span class="n">i</span><span class="o">+</span><span class="mi">1</span><span class="p">,</span><span class="n">j</span><span class="p">,</span><span class="n">kb</span><span class="p">)</span><span class="o">-</span><span class="n">v0</span><span class="p">(</span><span class="n">i</span><span class="p">,</span><span class="n">j</span><span class="p">,</span><span class="n">kb</span><span class="p">))</span><span class="o">*</span><span class="n">dxfi</span><span class="p">(</span><span class="n">i</span><span class="p">))</span><span class="o">**</span><span class="mi">2</span> <span class="p">&amp;</span>
<a name="ln-638"></a>               <span class="o">+</span><span class="p">((</span><span class="n">u0</span><span class="p">(</span><span class="n">i</span><span class="o">+</span><span class="mi">1</span><span class="p">,</span><span class="n">jp</span><span class="p">,</span><span class="n">kb</span><span class="p">)</span><span class="o">-</span><span class="n">u0</span><span class="p">(</span><span class="n">i</span><span class="o">+</span><span class="mi">1</span><span class="p">,</span><span class="n">j</span><span class="p">,</span><span class="n">kb</span><span class="p">))</span><span class="o">*</span><span class="n">dyi</span><span class="o">+</span><span class="p">(</span><span class="n">v0</span><span class="p">(</span><span class="n">i</span><span class="o">+</span><span class="mi">1</span><span class="p">,</span><span class="n">jp</span><span class="p">,</span><span class="n">kb</span><span class="p">)</span><span class="o">-</span><span class="n">v0</span><span class="p">(</span><span class="n">i</span><span class="p">,</span><span class="n">jp</span><span class="p">,</span><span class="n">kb</span><span class="p">))</span><span class="o">*</span><span class="n">dxfi</span><span class="p">(</span><span class="n">i</span><span class="p">))</span><span class="o">**</span><span class="mi">2</span>   <span class="p">)</span>
<a name="ln-639"></a>
<a name="ln-640"></a>          <span class="n">tdef2</span> <span class="o">=</span> <span class="n">tdef2</span> <span class="o">+</span> <span class="p">(</span> <span class="mf">0.25</span><span class="o">*</span><span class="p">(</span><span class="n">w0</span><span class="p">(</span><span class="n">i</span><span class="p">,</span><span class="n">jp</span><span class="p">,</span><span class="n">kb</span><span class="o">+</span><span class="mi">1</span><span class="p">)</span><span class="o">-</span><span class="n">w0</span><span class="p">(</span><span class="n">i</span><span class="p">,</span><span class="n">jm</span><span class="p">,</span><span class="n">kb</span><span class="o">+</span><span class="mi">1</span><span class="p">))</span><span class="o">*</span><span class="n">dyi</span> <span class="o">+</span> <span class="p">&amp;</span>
<a name="ln-641"></a>               <span class="n">dvdz</span><span class="p">(</span><span class="n">i</span><span class="p">,</span><span class="n">j</span><span class="p">)</span>   <span class="p">)</span><span class="o">**</span><span class="mi">2</span>
<a name="ln-642"></a>
<a name="ln-643"></a>          <span class="c">! **  Include shear and buoyancy production terms and dissipation **</span>
<a name="ln-644"></a>
<a name="ln-645"></a>          <span class="n">sbshr</span><span class="p">(</span><span class="n">i</span><span class="p">,</span><span class="n">j</span><span class="p">,</span><span class="n">kb</span><span class="p">)</span>  <span class="o">=</span> <span class="n">ekm</span><span class="p">(</span><span class="n">i</span><span class="p">,</span><span class="n">j</span><span class="p">,</span><span class="n">kb</span><span class="p">)</span><span class="o">*</span><span class="n">tdef2</span><span class="o">/</span> <span class="p">(</span> <span class="mi">2</span><span class="o">*</span><span class="n">e120</span><span class="p">(</span><span class="n">i</span><span class="p">,</span><span class="n">j</span><span class="p">,</span><span class="n">kb</span><span class="p">))</span>
<a name="ln-646"></a>          <span class="n">sbbuo</span><span class="p">(</span><span class="n">i</span><span class="p">,</span><span class="n">j</span><span class="p">,</span><span class="n">kb</span><span class="p">)</span>  <span class="o">=</span> <span class="o">-</span><span class="n">ekh</span><span class="p">(</span><span class="n">i</span><span class="p">,</span><span class="n">j</span><span class="p">,</span><span class="n">kb</span><span class="p">)</span><span class="o">*</span><span class="n">grav</span><span class="o">/</span><span class="n">thvf</span><span class="p">(</span><span class="n">kb</span><span class="p">)</span><span class="o">*</span><span class="n">dthvdz</span><span class="p">(</span><span class="n">i</span><span class="p">,</span><span class="n">j</span><span class="p">,</span><span class="n">kb</span><span class="p">)</span><span class="o">/</span> <span class="p">(</span> <span class="mi">2</span><span class="o">*</span><span class="n">e120</span><span class="p">(</span><span class="n">i</span><span class="p">,</span><span class="n">j</span><span class="p">,</span><span class="n">kb</span><span class="p">))</span>
<a name="ln-647"></a>          <span class="n">sbdiss</span><span class="p">(</span><span class="n">i</span><span class="p">,</span><span class="n">j</span><span class="p">,</span><span class="n">kb</span><span class="p">)</span> <span class="o">=</span> <span class="o">-</span> <span class="p">(</span><span class="n">ce1</span> <span class="o">+</span> <span class="n">ce2</span><span class="o">*</span><span class="n">zlt</span><span class="p">(</span><span class="n">i</span><span class="p">,</span><span class="n">j</span><span class="p">,</span><span class="n">kb</span><span class="p">)</span><span class="o">/</span><span class="n">delta</span><span class="p">(</span><span class="n">i</span><span class="p">,</span><span class="n">kb</span><span class="p">))</span> <span class="o">*</span> <span class="n">e120</span><span class="p">(</span><span class="n">i</span><span class="p">,</span><span class="n">j</span><span class="p">,</span><span class="n">kb</span><span class="p">)</span><span class="o">**</span><span class="mi">2</span> <span class="o">/</span><span class="p">(</span><span class="mf">2.</span><span class="o">*</span><span class="n">zlt</span><span class="p">(</span><span class="n">i</span><span class="p">,</span><span class="n">j</span><span class="p">,</span><span class="n">kb</span><span class="p">))</span>
<a name="ln-648"></a>       <span class="k">end do</span>
<a name="ln-649"></a><span class="k">    end do</span>
<a name="ln-650"></a>
<a name="ln-651"></a>    <span class="c">!    ------------------------------------------------</span>
<a name="ln-652"></a>
<a name="ln-653"></a>    <span class="n">e12p</span><span class="p">(</span><span class="n">ib</span><span class="p">:</span><span class="n">ie</span><span class="p">,</span><span class="n">jb</span><span class="p">:</span><span class="n">je</span><span class="p">,</span><span class="n">kb</span><span class="p">:</span><span class="n">ke</span><span class="p">)</span> <span class="o">=</span> <span class="n">e12p</span><span class="p">(</span><span class="n">ib</span><span class="p">:</span><span class="n">ie</span><span class="p">,</span><span class="n">jb</span><span class="p">:</span><span class="n">je</span><span class="p">,</span><span class="n">kb</span><span class="p">:</span><span class="n">ke</span><span class="p">)</span><span class="o">+</span> <span class="p">&amp;</span>
<a name="ln-654"></a>         <span class="n">sbshr</span><span class="p">(</span><span class="n">ib</span><span class="p">:</span><span class="n">ie</span><span class="p">,</span><span class="n">jb</span><span class="p">:</span><span class="n">je</span><span class="p">,</span><span class="n">kb</span><span class="p">:</span><span class="n">ke</span><span class="p">)</span><span class="o">+</span><span class="n">sbbuo</span><span class="p">(</span><span class="n">ib</span><span class="p">:</span><span class="n">ie</span><span class="p">,</span><span class="n">jb</span><span class="p">:</span><span class="n">je</span><span class="p">,</span><span class="n">kb</span><span class="p">:</span><span class="n">ke</span><span class="p">)</span><span class="o">+</span><span class="n">sbdiss</span><span class="p">(</span><span class="n">ib</span><span class="p">:</span><span class="n">ie</span><span class="p">,</span><span class="n">jb</span><span class="p">:</span><span class="n">je</span><span class="p">,</span><span class="n">kb</span><span class="p">:</span><span class="n">ke</span><span class="p">)</span>
<a name="ln-655"></a>
<a name="ln-656"></a>    <span class="c">!write(*,&#39;(A,3(1pE9.2))&#39;) &#39;for check if called and e12p =&#39;, e12p(32,32,kb)</span>
<a name="ln-657"></a>    <span class="k">return</span>
<a name="ln-658"></a>
<a name="ln-659"></a><span class="k">  end subroutine </span><span class="n">sources</span>
<a name="ln-660"></a>
<a name="ln-661"></a>  <span class="k">subroutine </span><span class="n">diffc</span> <span class="p">(</span><span class="n">hi</span><span class="p">,</span><span class="n">hj</span><span class="p">,</span><span class="n">hk</span><span class="p">,</span><span class="n">putin</span><span class="p">,</span><span class="n">putout</span><span class="p">)</span>
<a name="ln-662"></a>
<a name="ln-663"></a>    <span class="k">use </span><span class="n">modglobal</span><span class="p">,</span> <span class="n">only</span> <span class="p">:</span> <span class="n">ib</span><span class="p">,</span><span class="n">ie</span><span class="p">,</span><span class="n">ih</span><span class="p">,</span><span class="n">jb</span><span class="p">,</span><span class="n">je</span><span class="p">,</span><span class="n">jh</span><span class="p">,</span><span class="n">kb</span><span class="p">,</span><span class="n">ke</span><span class="p">,</span><span class="n">kh</span><span class="p">,</span><span class="n">dxh</span><span class="p">,</span><span class="n">dxhi</span><span class="p">,</span><span class="n">dxh2i</span><span class="p">,</span><span class="n">dxf</span><span class="p">,</span><span class="n">dxfi</span><span class="p">,</span><span class="n">dzf</span><span class="p">,</span><span class="n">dzfi</span><span class="p">,</span><span class="n">dyi</span><span class="p">,</span><span class="n">dy2i</span><span class="p">,&amp;</span>
<a name="ln-664"></a>         <span class="n">dzhi</span><span class="p">,</span><span class="n">dzh2i</span><span class="p">,</span><span class="n">jmax</span><span class="p">,</span> <span class="n">numol</span><span class="p">,</span> <span class="n">prandtlmoli</span><span class="p">,</span><span class="n">lles</span>
<a name="ln-665"></a>    <span class="k">use </span><span class="n">modmpi</span><span class="p">,</span> <span class="n">only</span> <span class="p">:</span> <span class="n">myid</span>
<a name="ln-666"></a>    <span class="k">implicit none</span>
<a name="ln-667"></a>
<a name="ln-668"></a><span class="k">    </span><span class="kt">integer</span><span class="p">,</span> <span class="k">intent</span><span class="p">(</span><span class="n">in</span><span class="p">)</span> <span class="kd">::</span> <span class="n">hi</span>                                                  <span class="c">!&lt;size of halo in i</span>
<a name="ln-669"></a>    <span class="kt">integer</span><span class="p">,</span> <span class="k">intent</span><span class="p">(</span><span class="n">in</span><span class="p">)</span> <span class="kd">::</span> <span class="n">hj</span>                                                  <span class="c">!&lt;size of halo in j</span>
<a name="ln-670"></a>    <span class="kt">integer</span><span class="p">,</span> <span class="k">intent</span><span class="p">(</span><span class="n">in</span><span class="p">)</span> <span class="kd">::</span> <span class="n">hk</span>                                                  <span class="c">!&lt;size of halo in k</span>
<a name="ln-671"></a>    <span class="kt">real</span><span class="p">,</span> <span class="k">intent</span><span class="p">(</span><span class="n">in</span><span class="p">)</span>    <span class="kd">::</span> <span class="n">putin</span> <span class="p">(</span><span class="n">ib</span><span class="o">-</span><span class="n">hi</span><span class="p">:</span><span class="n">ie</span><span class="o">+</span><span class="n">hi</span><span class="p">,</span><span class="n">jb</span><span class="o">-</span><span class="n">hj</span><span class="p">:</span><span class="n">je</span><span class="o">+</span><span class="n">hj</span><span class="p">,</span><span class="n">kb</span><span class="o">-</span><span class="n">hk</span><span class="p">:</span><span class="n">ke</span><span class="o">+</span><span class="n">hk</span><span class="p">)</span>
<a name="ln-672"></a>    <span class="kt">real</span><span class="p">,</span> <span class="k">intent</span><span class="p">(</span><span class="n">inout</span><span class="p">)</span> <span class="kd">::</span> <span class="n">putout</span><span class="p">(</span><span class="n">ib</span><span class="o">-</span><span class="n">hi</span><span class="p">:</span><span class="n">ie</span><span class="o">+</span><span class="n">hi</span><span class="p">,</span><span class="n">jb</span><span class="o">-</span><span class="n">hj</span><span class="p">:</span><span class="n">je</span><span class="o">+</span><span class="n">hj</span><span class="p">,</span><span class="n">kb</span>   <span class="p">:</span><span class="n">ke</span><span class="o">+</span><span class="n">hk</span><span class="p">)</span>
<a name="ln-673"></a>
<a name="ln-674"></a>    <span class="kt">real    </span><span class="n">cekh</span>
<a name="ln-675"></a>    <span class="kt">integer </span><span class="n">i</span><span class="p">,</span><span class="n">j</span><span class="p">,</span><span class="n">k</span><span class="p">,</span><span class="n">jm</span><span class="p">,</span><span class="n">jp</span><span class="p">,</span><span class="n">km</span><span class="p">,</span><span class="n">kp</span>
<a name="ln-676"></a>
<a name="ln-677"></a>    <span class="k">if</span> <span class="p">(</span><span class="n">lles</span><span class="p">)</span> <span class="k">then</span>
<a name="ln-678"></a>
<a name="ln-679"></a><span class="k">       do </span><span class="n">k</span><span class="o">=</span><span class="n">kb</span><span class="p">,</span><span class="n">ke</span>
<a name="ln-680"></a>          <span class="n">kp</span><span class="o">=</span><span class="n">k</span><span class="o">+</span><span class="mi">1</span>
<a name="ln-681"></a>          <span class="n">km</span><span class="o">=</span><span class="n">k</span><span class="o">-</span><span class="mi">1</span>
<a name="ln-682"></a>
<a name="ln-683"></a>          <span class="k">do </span><span class="n">j</span><span class="o">=</span><span class="n">jb</span><span class="p">,</span><span class="n">je</span>
<a name="ln-684"></a>             <span class="n">jp</span><span class="o">=</span><span class="n">j</span><span class="o">+</span><span class="mi">1</span>
<a name="ln-685"></a>             <span class="n">jm</span><span class="o">=</span><span class="n">j</span><span class="o">-</span><span class="mi">1</span>
<a name="ln-686"></a>
<a name="ln-687"></a>             <span class="k">do </span><span class="n">i</span><span class="o">=</span><span class="n">ib</span><span class="p">,</span><span class="n">ie</span>
<a name="ln-688"></a>                <span class="n">putout</span><span class="p">(</span><span class="n">i</span><span class="p">,</span><span class="n">j</span><span class="p">,</span><span class="n">k</span><span class="p">)</span> <span class="o">=</span> <span class="n">putout</span><span class="p">(</span><span class="n">i</span><span class="p">,</span><span class="n">j</span><span class="p">,</span><span class="n">k</span><span class="p">)</span> <span class="p">&amp;</span>
<a name="ln-689"></a>                     <span class="o">+</span>  <span class="mf">0.5</span> <span class="o">*</span>  <span class="p">(</span> <span class="p">&amp;</span>
<a name="ln-690"></a>                     <span class="p">(</span> <span class="p">(</span><span class="n">ekh</span><span class="p">(</span><span class="n">i</span><span class="o">+</span><span class="mi">1</span><span class="p">,</span><span class="n">j</span><span class="p">,</span><span class="n">k</span><span class="p">)</span><span class="o">*</span><span class="n">dxf</span><span class="p">(</span><span class="n">i</span><span class="p">)</span><span class="o">+</span><span class="n">ekh</span><span class="p">(</span><span class="n">i</span><span class="p">,</span><span class="n">j</span><span class="p">,</span><span class="n">k</span><span class="p">)</span><span class="o">*</span><span class="n">dxf</span><span class="p">(</span><span class="n">i</span><span class="o">+</span><span class="mi">1</span><span class="p">))</span> <span class="o">*</span><span class="p">(</span><span class="n">putin</span><span class="p">(</span><span class="n">i</span><span class="o">+</span><span class="mi">1</span><span class="p">,</span><span class="n">j</span><span class="p">,</span><span class="n">k</span><span class="p">)</span><span class="o">-</span><span class="n">putin</span><span class="p">(</span><span class="n">i</span><span class="p">,</span><span class="n">j</span><span class="p">,</span><span class="n">k</span><span class="p">))</span><span class="o">*</span><span class="n">dxh2i</span><span class="p">(</span><span class="n">i</span><span class="o">+</span><span class="mi">1</span><span class="p">)</span> <span class="p">&amp;</span>
<a name="ln-691"></a>                     <span class="o">-</span><span class="p">(</span><span class="n">ekh</span><span class="p">(</span><span class="n">i</span><span class="p">,</span><span class="n">j</span><span class="p">,</span><span class="n">k</span><span class="p">)</span><span class="o">*</span><span class="n">dxf</span><span class="p">(</span><span class="n">i</span><span class="o">-</span><span class="mi">1</span><span class="p">)</span><span class="o">+</span><span class="n">ekh</span><span class="p">(</span><span class="n">i</span><span class="o">-</span><span class="mi">1</span><span class="p">,</span><span class="n">j</span><span class="p">,</span><span class="n">k</span><span class="p">)</span><span class="o">*</span><span class="n">dxf</span><span class="p">(</span><span class="n">i</span><span class="p">))</span><span class="o">*</span><span class="p">(</span><span class="n">putin</span><span class="p">(</span><span class="n">i</span><span class="p">,</span><span class="n">j</span><span class="p">,</span><span class="n">k</span><span class="p">)</span><span class="o">-</span><span class="n">putin</span><span class="p">(</span><span class="n">i</span><span class="o">-</span><span class="mi">1</span><span class="p">,</span><span class="n">j</span><span class="p">,</span><span class="n">k</span><span class="p">))</span><span class="o">*</span><span class="n">dxh2i</span><span class="p">(</span><span class="n">i</span><span class="p">))</span> <span class="o">*</span> <span class="n">dxfi</span><span class="p">(</span><span class="n">i</span><span class="p">)</span> <span class="p">&amp;</span>
<a name="ln-692"></a>                     <span class="o">+</span> <span class="p">&amp;</span>
<a name="ln-693"></a>                     <span class="p">(</span> <span class="p">(</span><span class="n">ekh</span><span class="p">(</span><span class="n">i</span><span class="p">,</span><span class="n">jp</span><span class="p">,</span><span class="n">k</span><span class="p">)</span><span class="o">+</span><span class="n">ekh</span><span class="p">(</span><span class="n">i</span><span class="p">,</span><span class="n">j</span><span class="p">,</span><span class="n">k</span><span class="p">))</span> <span class="o">*</span><span class="p">(</span><span class="n">putin</span><span class="p">(</span><span class="n">i</span><span class="p">,</span><span class="n">jp</span><span class="p">,</span><span class="n">k</span><span class="p">)</span><span class="o">-</span><span class="n">putin</span><span class="p">(</span><span class="n">i</span><span class="p">,</span><span class="n">j</span><span class="p">,</span><span class="n">k</span><span class="p">))</span> <span class="p">&amp;</span>
<a name="ln-694"></a>                     <span class="o">-</span><span class="p">(</span><span class="n">ekh</span><span class="p">(</span><span class="n">i</span><span class="p">,</span><span class="n">j</span><span class="p">,</span><span class="n">k</span><span class="p">)</span><span class="o">+</span><span class="n">ekh</span><span class="p">(</span><span class="n">i</span><span class="p">,</span><span class="n">jm</span><span class="p">,</span><span class="n">k</span><span class="p">))</span> <span class="o">*</span><span class="p">(</span><span class="n">putin</span><span class="p">(</span><span class="n">i</span><span class="p">,</span><span class="n">j</span><span class="p">,</span><span class="n">k</span><span class="p">)</span><span class="o">-</span><span class="n">putin</span><span class="p">(</span><span class="n">i</span><span class="p">,</span><span class="n">jm</span><span class="p">,</span><span class="n">k</span><span class="p">))</span> <span class="p">)</span><span class="o">*</span><span class="n">dy2i</span> <span class="p">&amp;</span>
<a name="ln-695"></a>                     <span class="o">+</span> <span class="p">&amp;</span>
<a name="ln-696"></a>                     <span class="p">(</span> <span class="p">(</span><span class="n">dzf</span><span class="p">(</span><span class="n">kp</span><span class="p">)</span><span class="o">*</span><span class="n">ekh</span><span class="p">(</span><span class="n">i</span><span class="p">,</span><span class="n">j</span><span class="p">,</span><span class="n">k</span><span class="p">)</span> <span class="o">+</span> <span class="n">dzf</span><span class="p">(</span><span class="n">k</span><span class="p">)</span><span class="o">*</span><span class="n">ekh</span><span class="p">(</span><span class="n">i</span><span class="p">,</span><span class="n">j</span><span class="p">,</span><span class="n">kp</span><span class="p">))</span> <span class="p">&amp;</span>
<a name="ln-697"></a>                     <span class="o">*</span>  <span class="p">(</span><span class="n">putin</span><span class="p">(</span><span class="n">i</span><span class="p">,</span><span class="n">j</span><span class="p">,</span><span class="n">kp</span><span class="p">)</span><span class="o">-</span><span class="n">putin</span><span class="p">(</span><span class="n">i</span><span class="p">,</span><span class="n">j</span><span class="p">,</span><span class="n">k</span><span class="p">))</span> <span class="o">*</span> <span class="n">dzh2i</span><span class="p">(</span><span class="n">kp</span><span class="p">)</span> <span class="p">&amp;</span>
<a name="ln-698"></a>                     <span class="o">-</span> <span class="p">&amp;</span>
<a name="ln-699"></a>                     <span class="p">(</span><span class="n">dzf</span><span class="p">(</span><span class="n">km</span><span class="p">)</span><span class="o">*</span><span class="n">ekh</span><span class="p">(</span><span class="n">i</span><span class="p">,</span><span class="n">j</span><span class="p">,</span><span class="n">k</span><span class="p">)</span> <span class="o">+</span> <span class="n">dzf</span><span class="p">(</span><span class="n">k</span><span class="p">)</span><span class="o">*</span><span class="n">ekh</span><span class="p">(</span><span class="n">i</span><span class="p">,</span><span class="n">j</span><span class="p">,</span><span class="n">km</span><span class="p">))</span> <span class="p">&amp;</span>
<a name="ln-700"></a>                     <span class="o">*</span>  <span class="p">(</span><span class="n">putin</span><span class="p">(</span><span class="n">i</span><span class="p">,</span><span class="n">j</span><span class="p">,</span><span class="n">k</span><span class="p">)</span><span class="o">-</span><span class="n">putin</span><span class="p">(</span><span class="n">i</span><span class="p">,</span><span class="n">j</span><span class="p">,</span><span class="n">km</span><span class="p">))</span> <span class="o">*</span> <span class="n">dzh2i</span><span class="p">(</span><span class="n">k</span><span class="p">)</span>           <span class="p">)</span><span class="o">*</span><span class="n">dzfi</span><span class="p">(</span><span class="n">k</span><span class="p">)</span> <span class="p">&amp;</span>
<a name="ln-701"></a>                     <span class="p">)</span> 
<a name="ln-702"></a>             <span class="k">end do</span>
<a name="ln-703"></a><span class="k">          end do</span>
<a name="ln-704"></a><span class="k">       end do</span>
<a name="ln-705"></a>
<a name="ln-706"></a><span class="k">    else</span> <span class="c">! DNS</span>
<a name="ln-707"></a>       <span class="n">cekh</span> <span class="o">=</span> <span class="n">numol</span><span class="o">*</span> <span class="n">prandtlmoli</span>
<a name="ln-708"></a>       <span class="k">do </span><span class="n">k</span><span class="o">=</span><span class="n">kb</span><span class="p">,</span><span class="n">ke</span>
<a name="ln-709"></a>          <span class="n">kp</span><span class="o">=</span><span class="n">k</span><span class="o">+</span><span class="mi">1</span>
<a name="ln-710"></a>          <span class="n">km</span><span class="o">=</span><span class="n">k</span><span class="o">-</span><span class="mi">1</span>
<a name="ln-711"></a>
<a name="ln-712"></a>          <span class="k">do </span><span class="n">j</span><span class="o">=</span><span class="n">jb</span><span class="p">,</span><span class="n">je</span>
<a name="ln-713"></a>             <span class="n">jp</span><span class="o">=</span><span class="n">j</span><span class="o">+</span><span class="mi">1</span>
<a name="ln-714"></a>             <span class="n">jm</span><span class="o">=</span><span class="n">j</span><span class="o">-</span><span class="mi">1</span>
<a name="ln-715"></a>
<a name="ln-716"></a>             <span class="k">do </span><span class="n">i</span><span class="o">=</span><span class="n">ib</span><span class="p">,</span><span class="n">ie</span>
<a name="ln-717"></a>                <span class="n">putout</span><span class="p">(</span><span class="n">i</span><span class="p">,</span><span class="n">j</span><span class="p">,</span><span class="n">k</span><span class="p">)</span> <span class="o">=</span> <span class="n">putout</span><span class="p">(</span><span class="n">i</span><span class="p">,</span><span class="n">j</span><span class="p">,</span><span class="n">k</span><span class="p">)</span> <span class="p">&amp;</span>
<a name="ln-718"></a>                     <span class="o">+</span><span class="p">(</span> <span class="p">&amp;</span>
<a name="ln-719"></a>                     <span class="p">(</span> <span class="n">cekh</span> <span class="o">*</span><span class="p">(</span><span class="n">putin</span><span class="p">(</span><span class="n">i</span><span class="o">+</span><span class="mi">1</span><span class="p">,</span><span class="n">j</span><span class="p">,</span><span class="n">k</span><span class="p">)</span><span class="o">-</span><span class="n">putin</span><span class="p">(</span><span class="n">i</span><span class="p">,</span><span class="n">j</span><span class="p">,</span><span class="n">k</span><span class="p">))</span><span class="o">*</span><span class="n">dxhi</span><span class="p">(</span><span class="n">i</span><span class="o">+</span><span class="mi">1</span><span class="p">)</span> <span class="p">&amp;</span>
<a name="ln-720"></a>                     <span class="o">-</span><span class="n">cekh</span><span class="o">*</span><span class="p">(</span><span class="n">putin</span><span class="p">(</span><span class="n">i</span><span class="p">,</span><span class="n">j</span><span class="p">,</span><span class="n">k</span><span class="p">)</span><span class="o">-</span><span class="n">putin</span><span class="p">(</span><span class="n">i</span><span class="o">-</span><span class="mi">1</span><span class="p">,</span><span class="n">j</span><span class="p">,</span><span class="n">k</span><span class="p">))</span><span class="o">*</span><span class="n">dxhi</span><span class="p">(</span><span class="n">i</span><span class="p">))</span> <span class="o">*</span> <span class="n">dxfi</span><span class="p">(</span><span class="n">i</span><span class="p">)</span> <span class="p">&amp;</span>
<a name="ln-721"></a>                     <span class="o">+</span> <span class="p">&amp;</span>
<a name="ln-722"></a>                     <span class="p">(</span> <span class="n">cekh</span> <span class="o">*</span><span class="p">(</span><span class="n">putin</span><span class="p">(</span><span class="n">i</span><span class="p">,</span><span class="n">jp</span><span class="p">,</span><span class="n">k</span><span class="p">)</span><span class="o">-</span><span class="n">putin</span><span class="p">(</span><span class="n">i</span><span class="p">,</span><span class="n">j</span><span class="p">,</span><span class="n">k</span><span class="p">))</span> <span class="p">&amp;</span>
<a name="ln-723"></a>                     <span class="o">-</span><span class="n">cekh</span> <span class="o">*</span><span class="p">(</span><span class="n">putin</span><span class="p">(</span><span class="n">i</span><span class="p">,</span><span class="n">j</span><span class="p">,</span><span class="n">k</span><span class="p">)</span><span class="o">-</span><span class="n">putin</span><span class="p">(</span><span class="n">i</span><span class="p">,</span><span class="n">jm</span><span class="p">,</span><span class="n">k</span><span class="p">))</span> <span class="p">)</span><span class="o">*</span><span class="n">dy2i</span> <span class="p">&amp;</span>
<a name="ln-724"></a>                     <span class="o">+</span> <span class="p">&amp;</span>
<a name="ln-725"></a>                     <span class="p">(</span> <span class="n">cekh</span> <span class="o">*</span> <span class="p">(</span><span class="n">putin</span><span class="p">(</span><span class="n">i</span><span class="p">,</span><span class="n">j</span><span class="p">,</span><span class="n">kp</span><span class="p">)</span><span class="o">-</span><span class="n">putin</span><span class="p">(</span><span class="n">i</span><span class="p">,</span><span class="n">j</span><span class="p">,</span><span class="n">k</span><span class="p">))</span> <span class="o">*</span> <span class="n">dzhi</span><span class="p">(</span><span class="n">kp</span><span class="p">)</span> <span class="p">&amp;</span>
<a name="ln-726"></a>                     <span class="o">-</span><span class="n">cekh</span> <span class="o">*</span> <span class="p">(</span><span class="n">putin</span><span class="p">(</span><span class="n">i</span><span class="p">,</span><span class="n">j</span><span class="p">,</span><span class="n">k</span><span class="p">)</span><span class="o">-</span><span class="n">putin</span><span class="p">(</span><span class="n">i</span><span class="p">,</span><span class="n">j</span><span class="p">,</span><span class="n">km</span><span class="p">))</span> <span class="o">*</span> <span class="n">dzhi</span><span class="p">(</span><span class="n">k</span><span class="p">)</span>           <span class="p">)</span><span class="o">*</span><span class="n">dzfi</span><span class="p">(</span><span class="n">k</span><span class="p">)</span> <span class="p">&amp;</span>
<a name="ln-727"></a>                     <span class="p">)</span> 
<a name="ln-728"></a>             <span class="k">end do</span>
<a name="ln-729"></a><span class="k">          end do</span>
<a name="ln-730"></a><span class="k">       end do</span>
<a name="ln-731"></a>
<a name="ln-732"></a><span class="k">    end if</span> <span class="c">! lles=.true.</span>
<a name="ln-733"></a>
<a name="ln-734"></a>  <span class="k">end subroutine </span><span class="n">diffc</span>
<a name="ln-735"></a>
<a name="ln-736"></a>
<a name="ln-737"></a>
<a name="ln-738"></a>  <span class="k">subroutine </span><span class="n">diffe</span><span class="p">(</span><span class="n">putout</span><span class="p">)</span>
<a name="ln-739"></a>
<a name="ln-740"></a>    <span class="k">use </span><span class="n">modglobal</span><span class="p">,</span> <span class="n">only</span> <span class="p">:</span> <span class="n">ib</span><span class="p">,</span><span class="n">ie</span><span class="p">,</span><span class="n">ih</span><span class="p">,</span><span class="n">jb</span><span class="p">,</span><span class="n">je</span><span class="p">,</span><span class="n">jh</span><span class="p">,</span><span class="n">kb</span><span class="p">,</span><span class="n">ke</span><span class="p">,</span><span class="n">kh</span><span class="p">,</span><span class="n">dxf</span><span class="p">,</span><span class="n">dxfi</span><span class="p">,</span><span class="n">dxh2i</span><span class="p">,</span><span class="n">dzf</span><span class="p">,</span><span class="n">dzfi</span><span class="p">,&amp;</span>
<a name="ln-741"></a>         <span class="n">dy2i</span><span class="p">,</span><span class="n">dzhi</span><span class="p">,</span><span class="n">dzh2i</span><span class="p">,</span><span class="n">jmax</span>
<a name="ln-742"></a>    <span class="k">use </span><span class="n">modfields</span><span class="p">,</span> <span class="n">only</span> <span class="p">:</span> <span class="n">e120</span>
<a name="ln-743"></a>    <span class="k">use </span><span class="n">modmpi</span><span class="p">,</span>    <span class="n">only</span> <span class="p">:</span> <span class="n">myid</span>
<a name="ln-744"></a>    <span class="k">implicit none</span>
<a name="ln-745"></a>
<a name="ln-746"></a><span class="k">    </span><span class="kt">real</span><span class="p">,</span> <span class="k">intent</span><span class="p">(</span><span class="n">inout</span><span class="p">)</span> <span class="kd">::</span> <span class="n">putout</span><span class="p">(</span><span class="n">ib</span><span class="o">-</span><span class="n">ih</span><span class="p">:</span><span class="n">ie</span><span class="o">+</span><span class="n">ih</span><span class="p">,</span><span class="n">jb</span><span class="o">-</span><span class="n">jh</span><span class="p">:</span><span class="n">je</span><span class="o">+</span><span class="n">jh</span><span class="p">,</span><span class="n">kb</span><span class="p">:</span><span class="n">ke</span><span class="o">+</span><span class="n">kh</span><span class="p">)</span>
<a name="ln-747"></a>    <span class="kt">integer</span>             <span class="kd">::</span> <span class="n">i</span><span class="p">,</span><span class="n">j</span><span class="p">,</span><span class="n">k</span><span class="p">,</span><span class="n">jm</span><span class="p">,</span><span class="n">jp</span><span class="p">,</span><span class="n">km</span><span class="p">,</span><span class="n">kp</span>
<a name="ln-748"></a>
<a name="ln-749"></a>    <span class="k">do </span><span class="n">k</span><span class="o">=</span><span class="n">kb</span><span class="p">,</span><span class="n">ke</span>
<a name="ln-750"></a>       <span class="n">kp</span><span class="o">=</span><span class="n">k</span><span class="o">+</span><span class="mi">1</span>
<a name="ln-751"></a>       <span class="n">km</span><span class="o">=</span><span class="n">k</span><span class="o">-</span><span class="mi">1</span>
<a name="ln-752"></a>
<a name="ln-753"></a>       <span class="k">do </span><span class="n">j</span><span class="o">=</span><span class="n">jb</span><span class="p">,</span><span class="n">je</span>
<a name="ln-754"></a>          <span class="n">jp</span><span class="o">=</span><span class="n">j</span><span class="o">+</span><span class="mi">1</span>
<a name="ln-755"></a>          <span class="n">jm</span><span class="o">=</span><span class="n">j</span><span class="o">-</span><span class="mi">1</span>
<a name="ln-756"></a>
<a name="ln-757"></a>          <span class="k">do </span><span class="n">i</span><span class="o">=</span><span class="n">ib</span><span class="p">,</span><span class="n">ie</span>
<a name="ln-758"></a>
<a name="ln-759"></a>             <span class="n">putout</span><span class="p">(</span><span class="n">i</span><span class="p">,</span><span class="n">j</span><span class="p">,</span><span class="n">k</span><span class="p">)</span> <span class="o">=</span> <span class="n">putout</span><span class="p">(</span><span class="n">i</span><span class="p">,</span><span class="n">j</span><span class="p">,</span><span class="n">k</span><span class="p">)</span> <span class="p">&amp;</span>
<a name="ln-760"></a>                  <span class="o">+</span>  <span class="mf">1.0</span> <span class="o">*</span>  <span class="p">(</span> <span class="p">&amp;</span>
<a name="ln-761"></a>                  <span class="p">(</span> <span class="p">(</span><span class="n">ekm</span><span class="p">(</span><span class="n">i</span><span class="o">+</span><span class="mi">1</span><span class="p">,</span><span class="n">j</span><span class="p">,</span><span class="n">k</span><span class="p">)</span><span class="o">*</span><span class="n">dxf</span><span class="p">(</span><span class="n">i</span><span class="p">)</span><span class="o">+</span><span class="n">ekm</span><span class="p">(</span><span class="n">i</span><span class="p">,</span><span class="n">j</span><span class="p">,</span><span class="n">k</span><span class="p">)</span><span class="o">*</span><span class="n">dxf</span><span class="p">(</span><span class="n">i</span><span class="o">+</span><span class="mi">1</span><span class="p">))</span> <span class="o">*</span> <span class="p">(</span><span class="n">e120</span><span class="p">(</span><span class="n">i</span><span class="o">+</span><span class="mi">1</span><span class="p">,</span><span class="n">j</span><span class="p">,</span><span class="n">k</span><span class="p">)</span><span class="o">-</span><span class="n">e120</span><span class="p">(</span><span class="n">i</span><span class="p">,</span><span class="n">j</span><span class="p">,</span><span class="n">k</span><span class="p">))</span><span class="o">*</span><span class="n">dxh2i</span><span class="p">(</span><span class="n">i</span><span class="o">+</span><span class="mi">1</span><span class="p">)</span> <span class="p">&amp;</span>
<a name="ln-762"></a>                  <span class="o">-</span><span class="p">(</span><span class="n">ekm</span><span class="p">(</span><span class="n">i</span><span class="p">,</span><span class="n">j</span><span class="p">,</span><span class="n">k</span><span class="p">)</span><span class="o">*</span><span class="n">dxf</span><span class="p">(</span><span class="n">i</span><span class="o">-</span><span class="mi">1</span><span class="p">)</span><span class="o">+</span><span class="n">ekm</span><span class="p">(</span><span class="n">i</span><span class="o">-</span><span class="mi">1</span><span class="p">,</span><span class="n">j</span><span class="p">,</span><span class="n">k</span><span class="p">)</span><span class="o">*</span><span class="n">dxf</span><span class="p">(</span><span class="n">i</span><span class="p">))</span><span class="o">*</span><span class="p">(</span><span class="n">e120</span><span class="p">(</span><span class="n">i</span><span class="p">,</span><span class="n">j</span><span class="p">,</span><span class="n">k</span><span class="p">)</span><span class="o">-</span><span class="n">e120</span><span class="p">(</span><span class="n">i</span><span class="o">-</span><span class="mi">1</span><span class="p">,</span><span class="n">j</span><span class="p">,</span><span class="n">k</span><span class="p">))</span><span class="o">*</span><span class="n">dxh2i</span><span class="p">(</span><span class="n">i</span><span class="p">))</span> <span class="o">*</span> <span class="n">dxfi</span><span class="p">(</span><span class="n">i</span><span class="p">)</span> <span class="p">&amp;</span>
<a name="ln-763"></a>                  <span class="o">+</span> <span class="p">&amp;</span>
<a name="ln-764"></a>                  <span class="p">((</span><span class="n">ekm</span><span class="p">(</span><span class="n">i</span><span class="p">,</span><span class="n">jp</span><span class="p">,</span><span class="n">k</span><span class="p">)</span><span class="o">+</span><span class="n">ekm</span><span class="p">(</span><span class="n">i</span><span class="p">,</span><span class="n">j</span><span class="p">,</span><span class="n">k</span><span class="p">))</span> <span class="o">*</span><span class="p">(</span><span class="n">e120</span><span class="p">(</span><span class="n">i</span><span class="p">,</span><span class="n">jp</span><span class="p">,</span><span class="n">k</span><span class="p">)</span><span class="o">-</span><span class="n">e120</span><span class="p">(</span><span class="n">i</span><span class="p">,</span><span class="n">j</span><span class="p">,</span><span class="n">k</span><span class="p">))</span> <span class="p">&amp;</span>
<a name="ln-765"></a>                  <span class="o">-</span><span class="p">(</span><span class="n">ekm</span><span class="p">(</span><span class="n">i</span><span class="p">,</span><span class="n">j</span><span class="p">,</span><span class="n">k</span><span class="p">)</span><span class="o">+</span><span class="n">ekm</span><span class="p">(</span><span class="n">i</span><span class="p">,</span><span class="n">jm</span><span class="p">,</span><span class="n">k</span><span class="p">))</span> <span class="o">*</span><span class="p">(</span><span class="n">e120</span><span class="p">(</span><span class="n">i</span><span class="p">,</span><span class="n">j</span><span class="p">,</span><span class="n">k</span><span class="p">)</span><span class="o">-</span><span class="n">e120</span><span class="p">(</span><span class="n">i</span><span class="p">,</span><span class="n">jm</span><span class="p">,</span><span class="n">k</span><span class="p">))</span> <span class="p">)</span><span class="o">*</span><span class="n">dy2i</span> <span class="p">&amp;</span>
<a name="ln-766"></a>                  <span class="o">+</span> <span class="p">&amp;</span>
<a name="ln-767"></a>                  <span class="p">((</span><span class="n">dzf</span><span class="p">(</span><span class="n">kp</span><span class="p">)</span><span class="o">*</span><span class="n">ekm</span><span class="p">(</span><span class="n">i</span><span class="p">,</span><span class="n">j</span><span class="p">,</span><span class="n">k</span><span class="p">)</span> <span class="o">+</span> <span class="n">dzf</span><span class="p">(</span><span class="n">k</span><span class="p">)</span><span class="o">*</span><span class="n">ekm</span><span class="p">(</span><span class="n">i</span><span class="p">,</span><span class="n">j</span><span class="p">,</span><span class="n">kp</span><span class="p">))</span> <span class="p">&amp;</span>
<a name="ln-768"></a>                  <span class="o">*</span><span class="p">(</span><span class="n">e120</span><span class="p">(</span><span class="n">i</span><span class="p">,</span><span class="n">j</span><span class="p">,</span><span class="n">kp</span><span class="p">)</span><span class="o">-</span><span class="n">e120</span><span class="p">(</span><span class="n">i</span><span class="p">,</span><span class="n">j</span><span class="p">,</span><span class="n">k</span><span class="p">))</span> <span class="o">*</span><span class="n">dzh2i</span><span class="p">(</span><span class="n">kp</span><span class="p">)</span> <span class="p">&amp;</span>
<a name="ln-769"></a>                  <span class="o">-</span><span class="p">(</span><span class="n">dzf</span><span class="p">(</span><span class="n">km</span><span class="p">)</span><span class="o">*</span><span class="n">ekm</span><span class="p">(</span><span class="n">i</span><span class="p">,</span><span class="n">j</span><span class="p">,</span><span class="n">k</span><span class="p">)</span> <span class="o">+</span> <span class="n">dzf</span><span class="p">(</span><span class="n">k</span><span class="p">)</span><span class="o">*</span><span class="n">ekm</span><span class="p">(</span><span class="n">i</span><span class="p">,</span><span class="n">j</span><span class="p">,</span><span class="n">km</span><span class="p">))</span> <span class="p">&amp;</span>
<a name="ln-770"></a>                  <span class="o">*</span><span class="p">(</span><span class="n">e120</span><span class="p">(</span><span class="n">i</span><span class="p">,</span><span class="n">j</span><span class="p">,</span><span class="n">k</span><span class="p">)</span><span class="o">-</span><span class="n">e120</span><span class="p">(</span><span class="n">i</span><span class="p">,</span><span class="n">j</span><span class="p">,</span><span class="n">km</span><span class="p">))</span> <span class="o">*</span><span class="n">dzh2i</span><span class="p">(</span><span class="n">k</span><span class="p">)</span>        <span class="p">)</span><span class="o">*</span><span class="n">dzfi</span><span class="p">(</span><span class="n">k</span><span class="p">)</span> <span class="p">&amp;</span>
<a name="ln-771"></a>                  <span class="p">)</span>      
<a name="ln-772"></a>          <span class="k">end do</span>
<a name="ln-773"></a><span class="k">       end do</span>
<a name="ln-774"></a><span class="k">    end do</span>
<a name="ln-775"></a>
<a name="ln-776"></a>
<a name="ln-777"></a><span class="k">  end subroutine </span><span class="n">diffe</span>
<a name="ln-778"></a>
<a name="ln-779"></a>
<a name="ln-780"></a>  <span class="k">subroutine </span><span class="n">diffu</span> <span class="p">(</span><span class="n">putout</span><span class="p">)</span>
<a name="ln-781"></a>
<a name="ln-782"></a>    <span class="k">use </span><span class="n">modglobal</span><span class="p">,</span> <span class="n">only</span> <span class="p">:</span> <span class="n">ib</span><span class="p">,</span><span class="n">ie</span><span class="p">,</span><span class="n">ih</span><span class="p">,</span><span class="n">jb</span><span class="p">,</span><span class="n">je</span><span class="p">,</span><span class="n">jh</span><span class="p">,</span><span class="n">kb</span><span class="p">,</span><span class="n">ke</span><span class="p">,</span><span class="n">kh</span><span class="p">,</span><span class="n">kmax</span><span class="p">,</span><span class="n">dxhi</span><span class="p">,</span><span class="n">dxf</span><span class="p">,</span><span class="n">dxfi</span><span class="p">,</span><span class="n">lles</span><span class="p">,&amp;</span>          
<a name="ln-783"></a>         <span class="n">dzf</span><span class="p">,</span><span class="n">dzfi</span><span class="p">,</span><span class="n">dy</span><span class="p">,</span><span class="n">dyi</span><span class="p">,</span><span class="n">dy2i</span><span class="p">,</span><span class="n">dzhi</span><span class="p">,</span><span class="n">dzhiq</span><span class="p">,</span><span class="n">jmax</span><span class="p">,</span><span class="n">numol</span>
<a name="ln-784"></a>    <span class="k">use </span><span class="n">modfields</span><span class="p">,</span> <span class="n">only</span> <span class="p">:</span> <span class="n">u0</span><span class="p">,</span><span class="n">v0</span><span class="p">,</span><span class="n">w0</span>
<a name="ln-785"></a>    <span class="k">use </span><span class="n">modsurfdata</span><span class="p">,</span><span class="n">only</span> <span class="p">:</span> <span class="n">ustar</span>
<a name="ln-786"></a>    <span class="k">use </span><span class="n">modmpi</span><span class="p">,</span> <span class="n">only</span>    <span class="p">:</span> <span class="n">myid</span>
<a name="ln-787"></a>    <span class="k">implicit none</span>
<a name="ln-788"></a>
<a name="ln-789"></a><span class="k">    </span><span class="kt">real</span><span class="p">,</span> <span class="k">intent</span><span class="p">(</span><span class="n">inout</span><span class="p">)</span> <span class="kd">::</span> <span class="n">putout</span><span class="p">(</span><span class="n">ib</span><span class="o">-</span><span class="n">ih</span><span class="p">:</span><span class="n">ie</span><span class="o">+</span><span class="n">ih</span><span class="p">,</span><span class="n">jb</span><span class="o">-</span><span class="n">jh</span><span class="p">:</span><span class="n">je</span><span class="o">+</span><span class="n">jh</span><span class="p">,</span><span class="n">kb</span><span class="p">:</span><span class="n">ke</span><span class="o">+</span><span class="n">kh</span><span class="p">)</span>
<a name="ln-790"></a>    <span class="kt">real</span>                <span class="kd">::</span> <span class="n">emmo</span><span class="p">,</span><span class="n">emom</span><span class="p">,</span><span class="n">emop</span><span class="p">,</span><span class="n">empo</span>
<a name="ln-791"></a>    <span class="kt">real</span>                <span class="kd">::</span> <span class="n">fu</span><span class="p">,</span><span class="n">dummy</span>
<a name="ln-792"></a>    <span class="kt">real</span>                <span class="kd">::</span> <span class="n">ucu</span><span class="p">,</span> <span class="n">upcu</span>
<a name="ln-793"></a>    <span class="kt">integer</span>             <span class="kd">::</span> <span class="n">i</span><span class="p">,</span><span class="n">j</span><span class="p">,</span><span class="n">k</span><span class="p">,</span><span class="n">jm</span><span class="p">,</span><span class="n">jp</span><span class="p">,</span><span class="n">km</span><span class="p">,</span><span class="n">kp</span>
<a name="ln-794"></a>
<a name="ln-795"></a>    <span class="k">if</span> <span class="p">(</span><span class="n">lles</span><span class="p">)</span> <span class="k">then</span>
<a name="ln-796"></a>
<a name="ln-797"></a><span class="k">       do </span><span class="n">k</span><span class="o">=</span><span class="n">kb</span><span class="p">,</span><span class="n">ke</span>
<a name="ln-798"></a>          <span class="n">kp</span><span class="o">=</span><span class="n">k</span><span class="o">+</span><span class="mi">1</span>
<a name="ln-799"></a>          <span class="n">km</span><span class="o">=</span><span class="n">k</span><span class="o">-</span><span class="mi">1</span>
<a name="ln-800"></a>
<a name="ln-801"></a>          <span class="k">do </span><span class="n">j</span><span class="o">=</span><span class="n">jb</span><span class="p">,</span><span class="n">je</span>
<a name="ln-802"></a>             <span class="n">jp</span><span class="o">=</span><span class="n">j</span><span class="o">+</span><span class="mi">1</span>
<a name="ln-803"></a>             <span class="n">jm</span><span class="o">=</span><span class="n">j</span><span class="o">-</span><span class="mi">1</span>
<a name="ln-804"></a>
<a name="ln-805"></a>             <span class="k">do </span><span class="n">i</span><span class="o">=</span><span class="n">ib</span><span class="p">,</span><span class="n">ie</span>
<a name="ln-806"></a>
<a name="ln-807"></a>                <span class="n">emom</span> <span class="o">=</span> <span class="p">(</span> <span class="n">dzf</span><span class="p">(</span><span class="n">km</span><span class="p">)</span> <span class="o">*</span> <span class="p">(</span> <span class="n">ekm</span><span class="p">(</span><span class="n">i</span><span class="p">,</span><span class="n">j</span><span class="p">,</span><span class="n">k</span><span class="p">)</span><span class="o">*</span><span class="n">dxf</span><span class="p">(</span><span class="n">i</span><span class="o">-</span><span class="mi">1</span><span class="p">)</span>  <span class="o">+</span> <span class="n">ekm</span><span class="p">(</span><span class="n">i</span><span class="o">-</span><span class="mi">1</span><span class="p">,</span><span class="n">j</span><span class="p">,</span><span class="n">k</span><span class="p">)</span><span class="o">*</span><span class="n">dxf</span><span class="p">(</span><span class="n">i</span><span class="p">)</span> <span class="p">)</span>  <span class="o">+</span> <span class="p">&amp;</span>             <span class="c">! dx is non-equidistant</span>
<a name="ln-808"></a>                     <span class="n">dzf</span><span class="p">(</span><span class="n">k</span><span class="p">)</span>  <span class="o">*</span> <span class="p">(</span> <span class="n">ekm</span><span class="p">(</span><span class="n">i</span><span class="p">,</span><span class="n">j</span><span class="p">,</span><span class="n">km</span><span class="p">)</span><span class="o">*</span><span class="n">dxf</span><span class="p">(</span><span class="n">i</span><span class="o">-</span><span class="mi">1</span><span class="p">)</span> <span class="o">+</span> <span class="n">ekm</span><span class="p">(</span><span class="n">i</span><span class="o">-</span><span class="mi">1</span><span class="p">,</span><span class="n">j</span><span class="p">,</span><span class="n">km</span><span class="p">)</span><span class="o">*</span><span class="n">dxf</span><span class="p">(</span><span class="n">i</span><span class="p">)</span> <span class="p">)</span> <span class="p">)</span><span class="o">*</span><span class="n">dxhi</span><span class="p">(</span><span class="n">i</span><span class="p">)</span> <span class="o">*</span> <span class="n">dzhiq</span><span class="p">(</span><span class="n">k</span><span class="p">)</span> 
<a name="ln-809"></a>
<a name="ln-810"></a>                <span class="n">emop</span> <span class="o">=</span> <span class="p">(</span> <span class="n">dzf</span><span class="p">(</span><span class="n">kp</span><span class="p">)</span> <span class="o">*</span> <span class="p">(</span> <span class="n">ekm</span><span class="p">(</span><span class="n">i</span><span class="p">,</span><span class="n">j</span><span class="p">,</span><span class="n">k</span><span class="p">)</span><span class="o">*</span><span class="n">dxf</span><span class="p">(</span><span class="n">i</span><span class="o">-</span><span class="mi">1</span><span class="p">)</span>  <span class="o">+</span> <span class="n">ekm</span><span class="p">(</span><span class="n">i</span><span class="o">-</span><span class="mi">1</span><span class="p">,</span><span class="n">j</span><span class="p">,</span><span class="n">k</span><span class="p">)</span><span class="o">*</span><span class="n">dxf</span><span class="p">(</span><span class="n">i</span><span class="p">)</span> <span class="p">)</span>  <span class="o">+</span> <span class="p">&amp;</span>              <span class="c">! dx is non-equidistant</span>
<a name="ln-811"></a>                     <span class="n">dzf</span><span class="p">(</span><span class="n">k</span><span class="p">)</span>  <span class="o">*</span> <span class="p">(</span> <span class="n">ekm</span><span class="p">(</span><span class="n">i</span><span class="p">,</span><span class="n">j</span><span class="p">,</span><span class="n">kp</span><span class="p">)</span><span class="o">*</span><span class="n">dxf</span><span class="p">(</span><span class="n">i</span><span class="o">-</span><span class="mi">1</span><span class="p">)</span> <span class="o">+</span> <span class="n">ekm</span><span class="p">(</span><span class="n">i</span><span class="o">-</span><span class="mi">1</span><span class="p">,</span><span class="n">j</span><span class="p">,</span><span class="n">kp</span><span class="p">)</span><span class="o">*</span><span class="n">dxf</span><span class="p">(</span><span class="n">i</span><span class="p">)</span> <span class="p">)</span> <span class="p">)</span><span class="o">*</span><span class="n">dxhi</span><span class="p">(</span><span class="n">i</span><span class="p">)</span> <span class="o">*</span> <span class="n">dzhiq</span><span class="p">(</span><span class="n">kp</span><span class="p">)</span>
<a name="ln-812"></a>
<a name="ln-813"></a>                <span class="n">empo</span> <span class="o">=</span> <span class="mf">0.25</span> <span class="o">*</span> <span class="p">(</span> <span class="p">(</span> <span class="n">ekm</span><span class="p">(</span><span class="n">i</span><span class="p">,</span><span class="n">j</span><span class="p">,</span><span class="n">k</span><span class="p">)</span><span class="o">+</span><span class="n">ekm</span><span class="p">(</span><span class="n">i</span><span class="p">,</span><span class="n">jp</span><span class="p">,</span><span class="n">k</span><span class="p">))</span><span class="o">*</span><span class="n">dxf</span><span class="p">(</span><span class="n">i</span><span class="o">-</span><span class="mi">1</span><span class="p">)</span> <span class="o">+</span> <span class="p">(</span><span class="n">ekm</span><span class="p">(</span><span class="n">i</span><span class="o">-</span><span class="mi">1</span><span class="p">,</span><span class="n">j</span><span class="p">,</span><span class="n">k</span><span class="p">)</span><span class="o">+</span><span class="n">ekm</span><span class="p">(</span><span class="n">i</span><span class="o">-</span><span class="mi">1</span><span class="p">,</span><span class="n">jp</span><span class="p">,</span><span class="n">k</span><span class="p">))</span><span class="o">*</span><span class="n">dxf</span><span class="p">(</span><span class="n">i</span><span class="p">)</span> <span class="p">)</span> <span class="o">*</span> <span class="n">dxhi</span><span class="p">(</span><span class="n">i</span><span class="p">)</span>  <span class="c">! dx is non-equidistant</span>
<a name="ln-814"></a>
<a name="ln-815"></a>                <span class="n">emmo</span> <span class="o">=</span> <span class="mf">0.25</span> <span class="o">*</span> <span class="p">(</span> <span class="p">(</span> <span class="n">ekm</span><span class="p">(</span><span class="n">i</span><span class="p">,</span><span class="n">j</span><span class="p">,</span><span class="n">k</span><span class="p">)</span><span class="o">+</span><span class="n">ekm</span><span class="p">(</span><span class="n">i</span><span class="p">,</span><span class="n">jm</span><span class="p">,</span><span class="n">k</span><span class="p">))</span><span class="o">*</span><span class="n">dxf</span><span class="p">(</span><span class="n">i</span><span class="o">-</span><span class="mi">1</span><span class="p">)</span>  <span class="o">+</span><span class="p">(</span><span class="n">ekm</span><span class="p">(</span><span class="n">i</span><span class="o">-</span><span class="mi">1</span><span class="p">,</span><span class="n">jm</span><span class="p">,</span><span class="n">k</span><span class="p">)</span><span class="o">+</span><span class="n">ekm</span><span class="p">(</span><span class="n">i</span><span class="o">-</span><span class="mi">1</span><span class="p">,</span><span class="n">j</span><span class="p">,</span><span class="n">k</span><span class="p">))</span><span class="o">*</span><span class="n">dxf</span><span class="p">(</span><span class="n">i</span><span class="p">)</span> <span class="p">)</span> <span class="o">*</span> <span class="n">dxhi</span><span class="p">(</span><span class="n">i</span><span class="p">)</span>  <span class="c">! dx is non-equidistant</span>
<a name="ln-816"></a>
<a name="ln-817"></a>
<a name="ln-818"></a>                <span class="c">! Discretized diffusion term</span>
<a name="ln-819"></a>                <span class="n">putout</span><span class="p">(</span><span class="n">i</span><span class="p">,</span><span class="n">j</span><span class="p">,</span><span class="n">k</span><span class="p">)</span> <span class="o">=</span> <span class="n">putout</span><span class="p">(</span><span class="n">i</span><span class="p">,</span><span class="n">j</span><span class="p">,</span><span class="n">k</span><span class="p">)</span> <span class="p">&amp;</span>
<a name="ln-820"></a>                     <span class="o">+</span> <span class="p">&amp;</span>
<a name="ln-821"></a>                     <span class="p">(</span> <span class="n">ekm</span><span class="p">(</span><span class="n">i</span><span class="p">,</span><span class="n">j</span><span class="p">,</span><span class="n">k</span><span class="p">)</span>  <span class="o">*</span> <span class="p">(</span><span class="n">u0</span><span class="p">(</span><span class="n">i</span><span class="o">+</span><span class="mi">1</span><span class="p">,</span><span class="n">j</span><span class="p">,</span><span class="n">k</span><span class="p">)</span><span class="o">-</span><span class="n">u0</span><span class="p">(</span><span class="n">i</span><span class="p">,</span><span class="n">j</span><span class="p">,</span><span class="n">k</span><span class="p">))</span><span class="o">*</span><span class="n">dxfi</span><span class="p">(</span><span class="n">i</span><span class="p">)</span> <span class="p">&amp;</span>
<a name="ln-822"></a>                     <span class="o">-</span><span class="n">ekm</span><span class="p">(</span><span class="n">i</span><span class="o">-</span><span class="mi">1</span><span class="p">,</span><span class="n">j</span><span class="p">,</span><span class="n">k</span><span class="p">)</span><span class="o">*</span> <span class="p">(</span><span class="n">u0</span><span class="p">(</span><span class="n">i</span><span class="p">,</span><span class="n">j</span><span class="p">,</span><span class="n">k</span><span class="p">)</span><span class="o">-</span><span class="n">u0</span><span class="p">(</span><span class="n">i</span><span class="o">-</span><span class="mi">1</span><span class="p">,</span><span class="n">j</span><span class="p">,</span><span class="n">k</span><span class="p">))</span><span class="o">*</span><span class="n">dxfi</span><span class="p">(</span><span class="n">i</span><span class="o">-</span><span class="mi">1</span><span class="p">)</span> <span class="p">)</span> <span class="o">*</span> <span class="mf">2.</span> <span class="o">*</span> <span class="n">dxhi</span><span class="p">(</span><span class="n">i</span><span class="p">)</span> <span class="p">&amp;</span>
<a name="ln-823"></a>                     <span class="o">+</span> <span class="p">&amp;</span>
<a name="ln-824"></a>                     <span class="p">(</span> <span class="n">empo</span> <span class="o">*</span> <span class="p">(</span> <span class="p">(</span><span class="n">u0</span><span class="p">(</span><span class="n">i</span><span class="p">,</span><span class="n">jp</span><span class="p">,</span><span class="n">k</span><span class="p">)</span><span class="o">-</span><span class="n">u0</span><span class="p">(</span><span class="n">i</span><span class="p">,</span><span class="n">j</span><span class="p">,</span><span class="n">k</span><span class="p">))</span>   <span class="o">*</span><span class="n">dyi</span> <span class="p">&amp;</span>
<a name="ln-825"></a>                     <span class="o">+</span><span class="p">(</span><span class="n">v0</span><span class="p">(</span><span class="n">i</span><span class="p">,</span><span class="n">jp</span><span class="p">,</span><span class="n">k</span><span class="p">)</span><span class="o">-</span><span class="n">v0</span><span class="p">(</span><span class="n">i</span><span class="o">-</span><span class="mi">1</span><span class="p">,</span><span class="n">jp</span><span class="p">,</span><span class="n">k</span><span class="p">))</span><span class="o">*</span><span class="n">dxhi</span><span class="p">(</span><span class="n">i</span><span class="p">))</span> <span class="p">&amp;</span>
<a name="ln-826"></a>                     <span class="o">-</span><span class="n">emmo</span> <span class="o">*</span> <span class="p">(</span> <span class="p">(</span><span class="n">u0</span><span class="p">(</span><span class="n">i</span><span class="p">,</span><span class="n">j</span><span class="p">,</span><span class="n">k</span><span class="p">)</span><span class="o">-</span><span class="n">u0</span><span class="p">(</span><span class="n">i</span><span class="p">,</span><span class="n">jm</span><span class="p">,</span><span class="n">k</span><span class="p">))</span>   <span class="o">*</span><span class="n">dyi</span> <span class="p">&amp;</span>
<a name="ln-827"></a>                     <span class="o">+</span><span class="p">(</span><span class="n">v0</span><span class="p">(</span><span class="n">i</span><span class="p">,</span><span class="n">j</span><span class="p">,</span><span class="n">k</span><span class="p">)</span><span class="o">-</span><span class="n">v0</span><span class="p">(</span><span class="n">i</span><span class="o">-</span><span class="mi">1</span><span class="p">,</span><span class="n">j</span><span class="p">,</span><span class="n">k</span><span class="p">))</span>  <span class="o">*</span><span class="n">dxhi</span><span class="p">(</span><span class="n">i</span><span class="p">))</span> <span class="p">&amp;</span>  
<a name="ln-828"></a>                     <span class="p">)</span> <span class="o">*</span> <span class="n">dyi</span> <span class="p">&amp;</span>
<a name="ln-829"></a>                     <span class="o">+</span> <span class="p">&amp;</span>
<a name="ln-830"></a>                     <span class="p">(</span> <span class="n">emop</span> <span class="o">*</span> <span class="p">(</span> <span class="p">(</span><span class="n">u0</span><span class="p">(</span><span class="n">i</span><span class="p">,</span><span class="n">j</span><span class="p">,</span><span class="n">kp</span><span class="p">)</span><span class="o">-</span><span class="n">u0</span><span class="p">(</span><span class="n">i</span><span class="p">,</span><span class="n">j</span><span class="p">,</span><span class="n">k</span><span class="p">))</span>   <span class="o">*</span><span class="n">dzhi</span><span class="p">(</span><span class="n">kp</span><span class="p">)</span> <span class="p">&amp;</span>
<a name="ln-831"></a>                     <span class="o">+</span><span class="p">(</span><span class="n">w0</span><span class="p">(</span><span class="n">i</span><span class="p">,</span><span class="n">j</span><span class="p">,</span><span class="n">kp</span><span class="p">)</span><span class="o">-</span><span class="n">w0</span><span class="p">(</span><span class="n">i</span><span class="o">-</span><span class="mi">1</span><span class="p">,</span><span class="n">j</span><span class="p">,</span><span class="n">kp</span><span class="p">))</span><span class="o">*</span><span class="n">dxhi</span><span class="p">(</span><span class="n">i</span><span class="p">))</span> <span class="p">&amp;</span>
<a name="ln-832"></a>                     <span class="o">-</span><span class="n">emom</span> <span class="o">*</span> <span class="p">(</span> <span class="p">(</span><span class="n">u0</span><span class="p">(</span><span class="n">i</span><span class="p">,</span><span class="n">j</span><span class="p">,</span><span class="n">k</span><span class="p">)</span><span class="o">-</span><span class="n">u0</span><span class="p">(</span><span class="n">i</span><span class="p">,</span><span class="n">j</span><span class="p">,</span><span class="n">km</span><span class="p">))</span>   <span class="o">*</span><span class="n">dzhi</span><span class="p">(</span><span class="n">k</span><span class="p">)</span> <span class="p">&amp;</span>
<a name="ln-833"></a>                     <span class="o">+</span><span class="p">(</span><span class="n">w0</span><span class="p">(</span><span class="n">i</span><span class="p">,</span><span class="n">j</span><span class="p">,</span><span class="n">k</span><span class="p">)</span><span class="o">-</span><span class="n">w0</span><span class="p">(</span><span class="n">i</span><span class="o">-</span><span class="mi">1</span><span class="p">,</span><span class="n">j</span><span class="p">,</span><span class="n">k</span><span class="p">))</span>  <span class="o">*</span><span class="n">dxhi</span><span class="p">(</span><span class="n">i</span><span class="p">))</span> <span class="p">&amp;</span>
<a name="ln-834"></a>                     <span class="p">)</span> <span class="o">*</span><span class="n">dzfi</span><span class="p">(</span><span class="n">k</span><span class="p">)</span> 
<a name="ln-835"></a>             <span class="k">end do</span>
<a name="ln-836"></a><span class="k">          end do</span>
<a name="ln-837"></a><span class="k">       end do</span>
<a name="ln-838"></a><span class="k">    else</span> <span class="c">! DNS</span>
<a name="ln-839"></a>       <span class="k">do </span><span class="n">k</span><span class="o">=</span><span class="n">kb</span><span class="p">,</span><span class="n">ke</span>
<a name="ln-840"></a>          <span class="n">kp</span><span class="o">=</span><span class="n">k</span><span class="o">+</span><span class="mi">1</span>
<a name="ln-841"></a>          <span class="n">km</span><span class="o">=</span><span class="n">k</span><span class="o">-</span><span class="mi">1</span>
<a name="ln-842"></a>
<a name="ln-843"></a>          <span class="k">do </span><span class="n">j</span><span class="o">=</span><span class="n">jb</span><span class="p">,</span><span class="n">je</span>
<a name="ln-844"></a>             <span class="n">jp</span><span class="o">=</span><span class="n">j</span><span class="o">+</span><span class="mi">1</span>
<a name="ln-845"></a>             <span class="n">jm</span><span class="o">=</span><span class="n">j</span><span class="o">-</span><span class="mi">1</span>
<a name="ln-846"></a>
<a name="ln-847"></a>             <span class="k">do </span><span class="n">i</span><span class="o">=</span><span class="n">ib</span><span class="p">,</span><span class="n">ie</span>
<a name="ln-848"></a>
<a name="ln-849"></a>                <span class="c">! Discretized diffusion term</span>
<a name="ln-850"></a>                <span class="n">putout</span><span class="p">(</span><span class="n">i</span><span class="p">,</span><span class="n">j</span><span class="p">,</span><span class="n">k</span><span class="p">)</span> <span class="o">=</span> <span class="n">putout</span><span class="p">(</span><span class="n">i</span><span class="p">,</span><span class="n">j</span><span class="p">,</span><span class="n">k</span><span class="p">)</span> <span class="p">&amp;</span>
<a name="ln-851"></a>                     <span class="o">+</span> <span class="p">&amp;</span>
<a name="ln-852"></a>                     <span class="p">(</span> <span class="n">numol</span>  <span class="o">*</span> <span class="p">(</span><span class="n">u0</span><span class="p">(</span><span class="n">i</span><span class="o">+</span><span class="mi">1</span><span class="p">,</span><span class="n">j</span><span class="p">,</span><span class="n">k</span><span class="p">)</span><span class="o">-</span><span class="n">u0</span><span class="p">(</span><span class="n">i</span><span class="p">,</span><span class="n">j</span><span class="p">,</span><span class="n">k</span><span class="p">))</span><span class="o">*</span><span class="n">dxfi</span><span class="p">(</span><span class="n">i</span><span class="p">)</span> <span class="p">&amp;</span>
<a name="ln-853"></a>                     <span class="o">-</span><span class="n">numol</span> <span class="o">*</span> <span class="p">(</span><span class="n">u0</span><span class="p">(</span><span class="n">i</span><span class="p">,</span><span class="n">j</span><span class="p">,</span><span class="n">k</span><span class="p">)</span><span class="o">-</span><span class="n">u0</span><span class="p">(</span><span class="n">i</span><span class="o">-</span><span class="mi">1</span><span class="p">,</span><span class="n">j</span><span class="p">,</span><span class="n">k</span><span class="p">))</span><span class="o">*</span><span class="n">dxfi</span><span class="p">(</span><span class="n">i</span><span class="o">-</span><span class="mi">1</span><span class="p">)</span> <span class="p">)</span> <span class="o">*</span> <span class="mf">2.</span> <span class="o">*</span> <span class="n">dxhi</span><span class="p">(</span><span class="n">i</span><span class="p">)</span> <span class="p">&amp;</span>
<a name="ln-854"></a>                     <span class="o">+</span> <span class="p">&amp;</span>
<a name="ln-855"></a>                     <span class="p">(</span> <span class="n">numol</span> <span class="o">*</span> <span class="p">(</span> <span class="p">(</span><span class="n">u0</span><span class="p">(</span><span class="n">i</span><span class="p">,</span><span class="n">jp</span><span class="p">,</span><span class="n">k</span><span class="p">)</span><span class="o">-</span><span class="n">u0</span><span class="p">(</span><span class="n">i</span><span class="p">,</span><span class="n">j</span><span class="p">,</span><span class="n">k</span><span class="p">))</span>   <span class="o">*</span><span class="n">dyi</span> <span class="p">&amp;</span>
<a name="ln-856"></a>                     <span class="o">+</span><span class="p">(</span><span class="n">v0</span><span class="p">(</span><span class="n">i</span><span class="p">,</span><span class="n">jp</span><span class="p">,</span><span class="n">k</span><span class="p">)</span><span class="o">-</span><span class="n">v0</span><span class="p">(</span><span class="n">i</span><span class="o">-</span><span class="mi">1</span><span class="p">,</span><span class="n">jp</span><span class="p">,</span><span class="n">k</span><span class="p">))</span><span class="o">*</span><span class="n">dxhi</span><span class="p">(</span><span class="n">i</span><span class="p">))</span> <span class="p">&amp;</span>
<a name="ln-857"></a>                     <span class="o">-</span><span class="n">numol</span> <span class="o">*</span> <span class="p">(</span> <span class="p">(</span><span class="n">u0</span><span class="p">(</span><span class="n">i</span><span class="p">,</span><span class="n">j</span><span class="p">,</span><span class="n">k</span><span class="p">)</span><span class="o">-</span><span class="n">u0</span><span class="p">(</span><span class="n">i</span><span class="p">,</span><span class="n">jm</span><span class="p">,</span><span class="n">k</span><span class="p">))</span>   <span class="o">*</span><span class="n">dyi</span> <span class="p">&amp;</span>
<a name="ln-858"></a>                     <span class="o">+</span><span class="p">(</span><span class="n">v0</span><span class="p">(</span><span class="n">i</span><span class="p">,</span><span class="n">j</span><span class="p">,</span><span class="n">k</span><span class="p">)</span><span class="o">-</span><span class="n">v0</span><span class="p">(</span><span class="n">i</span><span class="o">-</span><span class="mi">1</span><span class="p">,</span><span class="n">j</span><span class="p">,</span><span class="n">k</span><span class="p">))</span>  <span class="o">*</span><span class="n">dxhi</span><span class="p">(</span><span class="n">i</span><span class="p">))</span> <span class="p">&amp;</span>  
<a name="ln-859"></a>                     <span class="p">)</span> <span class="o">*</span> <span class="n">dyi</span> <span class="p">&amp;</span>
<a name="ln-860"></a>                     <span class="o">+</span> <span class="p">&amp;</span>
<a name="ln-861"></a>                     <span class="p">(</span> <span class="n">numol</span> <span class="o">*</span> <span class="p">(</span> <span class="p">(</span><span class="n">u0</span><span class="p">(</span><span class="n">i</span><span class="p">,</span><span class="n">j</span><span class="p">,</span><span class="n">kp</span><span class="p">)</span><span class="o">-</span><span class="n">u0</span><span class="p">(</span><span class="n">i</span><span class="p">,</span><span class="n">j</span><span class="p">,</span><span class="n">k</span><span class="p">))</span>   <span class="o">*</span><span class="n">dzhi</span><span class="p">(</span><span class="n">kp</span><span class="p">)</span> <span class="p">&amp;</span>
<a name="ln-862"></a>                     <span class="o">+</span><span class="p">(</span><span class="n">w0</span><span class="p">(</span><span class="n">i</span><span class="p">,</span><span class="n">j</span><span class="p">,</span><span class="n">kp</span><span class="p">)</span><span class="o">-</span><span class="n">w0</span><span class="p">(</span><span class="n">i</span><span class="o">-</span><span class="mi">1</span><span class="p">,</span><span class="n">j</span><span class="p">,</span><span class="n">kp</span><span class="p">))</span><span class="o">*</span><span class="n">dxhi</span><span class="p">(</span><span class="n">i</span><span class="p">))</span> <span class="p">&amp;</span>
<a name="ln-863"></a>                     <span class="o">-</span><span class="n">numol</span> <span class="o">*</span> <span class="p">(</span> <span class="p">(</span><span class="n">u0</span><span class="p">(</span><span class="n">i</span><span class="p">,</span><span class="n">j</span><span class="p">,</span><span class="n">k</span><span class="p">)</span><span class="o">-</span><span class="n">u0</span><span class="p">(</span><span class="n">i</span><span class="p">,</span><span class="n">j</span><span class="p">,</span><span class="n">km</span><span class="p">))</span>   <span class="o">*</span><span class="n">dzhi</span><span class="p">(</span><span class="n">k</span><span class="p">)</span> <span class="p">&amp;</span>
<a name="ln-864"></a>                     <span class="o">+</span><span class="p">(</span><span class="n">w0</span><span class="p">(</span><span class="n">i</span><span class="p">,</span><span class="n">j</span><span class="p">,</span><span class="n">k</span><span class="p">)</span><span class="o">-</span><span class="n">w0</span><span class="p">(</span><span class="n">i</span><span class="o">-</span><span class="mi">1</span><span class="p">,</span><span class="n">j</span><span class="p">,</span><span class="n">k</span><span class="p">))</span>  <span class="o">*</span><span class="n">dxhi</span><span class="p">(</span><span class="n">i</span><span class="p">))</span> <span class="p">&amp;</span>
<a name="ln-865"></a>                     <span class="p">)</span> <span class="o">*</span><span class="n">dzfi</span><span class="p">(</span><span class="n">k</span><span class="p">)</span> 
<a name="ln-866"></a>             <span class="k">end do</span>
<a name="ln-867"></a><span class="k">          end do</span>
<a name="ln-868"></a><span class="k">       end do</span>
<a name="ln-869"></a>
<a name="ln-870"></a><span class="k">    end if</span>   <span class="c">! lles</span>
<a name="ln-871"></a>
<a name="ln-872"></a>  <span class="k">end subroutine </span><span class="n">diffu</span>
<a name="ln-873"></a>
<a name="ln-874"></a>
<a name="ln-875"></a>  <span class="k">subroutine </span><span class="n">diffv</span> <span class="p">(</span><span class="n">putout</span><span class="p">)</span>
<a name="ln-876"></a>
<a name="ln-877"></a>    <span class="k">use </span><span class="n">modglobal</span><span class="p">,</span> <span class="n">only</span>   <span class="p">:</span> <span class="n">ib</span><span class="p">,</span><span class="n">ie</span><span class="p">,</span><span class="n">ih</span><span class="p">,</span><span class="n">jb</span><span class="p">,</span><span class="n">je</span><span class="p">,</span><span class="n">jh</span><span class="p">,</span><span class="n">kb</span><span class="p">,</span><span class="n">ke</span><span class="p">,</span><span class="n">kh</span><span class="p">,</span><span class="n">dxf</span><span class="p">,</span><span class="n">dxhi</span><span class="p">,</span><span class="n">dxfi</span><span class="p">,</span><span class="n">dzf</span><span class="p">,</span><span class="n">dzfi</span><span class="p">,</span><span class="n">dyi</span><span class="p">,&amp;</span>
<a name="ln-878"></a>         <span class="n">dy2i</span><span class="p">,</span><span class="n">dzhi</span><span class="p">,</span><span class="n">dzhiq</span><span class="p">,</span><span class="n">jmax</span><span class="p">,</span><span class="n">numol</span><span class="p">,</span><span class="n">lles</span>
<a name="ln-879"></a>    <span class="k">use </span><span class="n">modfields</span><span class="p">,</span> <span class="n">only</span>   <span class="p">:</span> <span class="n">u0</span><span class="p">,</span><span class="n">v0</span><span class="p">,</span><span class="n">w0</span>
<a name="ln-880"></a>    <span class="k">use </span><span class="n">modsurfdata</span><span class="p">,</span><span class="n">only</span>  <span class="p">:</span> <span class="n">ustar</span>
<a name="ln-881"></a>    <span class="k">use </span><span class="n">modmpi</span><span class="p">,</span> <span class="n">only</span>      <span class="p">:</span> <span class="n">myid</span>
<a name="ln-882"></a>
<a name="ln-883"></a>    <span class="k">implicit none</span>
<a name="ln-884"></a>
<a name="ln-885"></a><span class="k">    </span><span class="kt">real</span><span class="p">,</span> <span class="k">intent</span><span class="p">(</span><span class="n">inout</span><span class="p">)</span> <span class="kd">::</span> <span class="n">putout</span><span class="p">(</span><span class="n">ib</span><span class="o">-</span><span class="n">ih</span><span class="p">:</span><span class="n">ie</span><span class="o">+</span><span class="n">ih</span><span class="p">,</span><span class="n">jb</span><span class="o">-</span><span class="n">jh</span><span class="p">:</span><span class="n">je</span><span class="o">+</span><span class="n">jh</span><span class="p">,</span><span class="n">kb</span><span class="p">:</span><span class="n">ke</span><span class="o">+</span><span class="n">kh</span><span class="p">)</span>
<a name="ln-886"></a>    <span class="kt">real</span>                <span class="kd">::</span> <span class="n">emmo</span><span class="p">,</span> <span class="n">eomm</span><span class="p">,</span><span class="n">eomp</span><span class="p">,</span><span class="n">epmo</span>
<a name="ln-887"></a>    <span class="kt">real</span>                <span class="kd">::</span> <span class="n">fv</span><span class="p">,</span> <span class="n">vcv</span><span class="p">,</span><span class="n">vpcv</span>
<a name="ln-888"></a>    <span class="kt">integer</span>             <span class="kd">::</span> <span class="n">i</span><span class="p">,</span><span class="n">j</span><span class="p">,</span><span class="n">k</span><span class="p">,</span><span class="n">jm</span><span class="p">,</span><span class="n">jp</span><span class="p">,</span><span class="n">km</span><span class="p">,</span><span class="n">kp</span>
<a name="ln-889"></a>
<a name="ln-890"></a>    <span class="k">if</span> <span class="p">(</span><span class="n">lles</span><span class="p">)</span> <span class="k">then</span>
<a name="ln-891"></a>
<a name="ln-892"></a><span class="k">       do </span><span class="n">k</span><span class="o">=</span><span class="n">kb</span><span class="p">,</span><span class="n">ke</span>
<a name="ln-893"></a>          <span class="n">kp</span><span class="o">=</span><span class="n">k</span><span class="o">+</span><span class="mi">1</span>
<a name="ln-894"></a>          <span class="n">km</span><span class="o">=</span><span class="n">k</span><span class="o">-</span><span class="mi">1</span>
<a name="ln-895"></a>
<a name="ln-896"></a>          <span class="k">do </span><span class="n">j</span><span class="o">=</span><span class="n">jb</span><span class="p">,</span><span class="n">je</span>
<a name="ln-897"></a>             <span class="n">jp</span><span class="o">=</span><span class="n">j</span><span class="o">+</span><span class="mi">1</span>
<a name="ln-898"></a>             <span class="n">jm</span><span class="o">=</span><span class="n">j</span><span class="o">-</span><span class="mi">1</span>
<a name="ln-899"></a>
<a name="ln-900"></a>             <span class="k">do </span><span class="n">i</span><span class="o">=</span><span class="n">ib</span><span class="p">,</span><span class="n">ie</span>
<a name="ln-901"></a>
<a name="ln-902"></a>                <span class="n">eomm</span> <span class="o">=</span> <span class="p">(</span> <span class="n">dzf</span><span class="p">(</span><span class="n">km</span><span class="p">)</span> <span class="o">*</span> <span class="p">(</span> <span class="n">ekm</span><span class="p">(</span><span class="n">i</span><span class="p">,</span><span class="n">j</span><span class="p">,</span><span class="n">k</span><span class="p">)</span>  <span class="o">+</span> <span class="n">ekm</span><span class="p">(</span><span class="n">i</span><span class="p">,</span><span class="n">jm</span><span class="p">,</span><span class="n">k</span><span class="p">)</span>  <span class="p">)</span>  <span class="o">+</span> <span class="p">&amp;</span>
<a name="ln-903"></a>                     <span class="n">dzf</span><span class="p">(</span><span class="n">k</span><span class="p">)</span>  <span class="o">*</span> <span class="p">(</span> <span class="n">ekm</span><span class="p">(</span><span class="n">i</span><span class="p">,</span><span class="n">j</span><span class="p">,</span><span class="n">km</span><span class="p">)</span> <span class="o">+</span> <span class="n">ekm</span><span class="p">(</span><span class="n">i</span><span class="p">,</span><span class="n">jm</span><span class="p">,</span><span class="n">km</span><span class="p">)</span> <span class="p">)</span> <span class="p">)</span> <span class="o">*</span> <span class="n">dzhiq</span><span class="p">(</span><span class="n">k</span><span class="p">)</span>
<a name="ln-904"></a>
<a name="ln-905"></a>                <span class="n">eomp</span> <span class="o">=</span> <span class="p">(</span> <span class="n">dzf</span><span class="p">(</span><span class="n">kp</span><span class="p">)</span> <span class="o">*</span> <span class="p">(</span> <span class="n">ekm</span><span class="p">(</span><span class="n">i</span><span class="p">,</span><span class="n">j</span><span class="p">,</span><span class="n">k</span><span class="p">)</span>  <span class="o">+</span> <span class="n">ekm</span><span class="p">(</span><span class="n">i</span><span class="p">,</span><span class="n">jm</span><span class="p">,</span><span class="n">k</span><span class="p">)</span>  <span class="p">)</span>  <span class="o">+</span> <span class="p">&amp;</span>
<a name="ln-906"></a>                     <span class="n">dzf</span><span class="p">(</span><span class="n">k</span><span class="p">)</span>  <span class="o">*</span> <span class="p">(</span> <span class="n">ekm</span><span class="p">(</span><span class="n">i</span><span class="p">,</span><span class="n">j</span><span class="p">,</span><span class="n">kp</span><span class="p">)</span> <span class="o">+</span> <span class="n">ekm</span><span class="p">(</span><span class="n">i</span><span class="p">,</span><span class="n">jm</span><span class="p">,</span><span class="n">kp</span><span class="p">)</span> <span class="p">)</span> <span class="p">)</span> <span class="o">*</span> <span class="n">dzhiq</span><span class="p">(</span><span class="n">kp</span><span class="p">)</span>
<a name="ln-907"></a>
<a name="ln-908"></a>                <span class="n">emmo</span> <span class="o">=</span> <span class="mf">0.25</span> <span class="o">*</span> <span class="p">(</span> <span class="p">(</span> <span class="n">ekm</span><span class="p">(</span><span class="n">i</span><span class="p">,</span><span class="n">j</span><span class="p">,</span><span class="n">k</span><span class="p">)</span><span class="o">+</span><span class="n">ekm</span><span class="p">(</span><span class="n">i</span><span class="p">,</span><span class="n">jm</span><span class="p">,</span><span class="n">k</span><span class="p">))</span><span class="o">*</span><span class="n">dxf</span><span class="p">(</span><span class="n">i</span><span class="o">-</span><span class="mi">1</span><span class="p">)</span>  <span class="o">+</span><span class="p">(</span><span class="n">ekm</span><span class="p">(</span><span class="n">i</span><span class="o">-</span><span class="mi">1</span><span class="p">,</span><span class="n">jm</span><span class="p">,</span><span class="n">k</span><span class="p">)</span><span class="o">+</span><span class="n">ekm</span><span class="p">(</span><span class="n">i</span><span class="o">-</span><span class="mi">1</span><span class="p">,</span><span class="n">j</span><span class="p">,</span><span class="n">k</span><span class="p">))</span><span class="o">*</span><span class="n">dxf</span><span class="p">(</span><span class="n">i</span><span class="p">)</span> <span class="p">)</span> <span class="o">*</span> <span class="n">dxhi</span><span class="p">(</span><span class="n">i</span><span class="p">)</span>  <span class="c">! dx is non-equidistant</span>
<a name="ln-909"></a>
<a name="ln-910"></a>                <span class="n">epmo</span> <span class="o">=</span> <span class="mf">0.25</span> <span class="o">*</span> <span class="p">(</span> <span class="p">(</span> <span class="n">ekm</span><span class="p">(</span><span class="n">i</span><span class="p">,</span><span class="n">j</span><span class="p">,</span><span class="n">k</span><span class="p">)</span><span class="o">+</span><span class="n">ekm</span><span class="p">(</span><span class="n">i</span><span class="p">,</span><span class="n">jm</span><span class="p">,</span><span class="n">k</span><span class="p">))</span><span class="o">*</span><span class="n">dxf</span><span class="p">(</span><span class="n">i</span><span class="o">+</span><span class="mi">1</span><span class="p">)</span> <span class="o">+</span> <span class="p">(</span><span class="n">ekm</span><span class="p">(</span><span class="n">i</span><span class="o">+</span><span class="mi">1</span><span class="p">,</span><span class="n">jm</span><span class="p">,</span><span class="n">k</span><span class="p">)</span><span class="o">+</span><span class="n">ekm</span><span class="p">(</span><span class="n">i</span><span class="o">+</span><span class="mi">1</span><span class="p">,</span><span class="n">j</span><span class="p">,</span><span class="n">k</span><span class="p">))</span><span class="o">*</span><span class="n">dxf</span><span class="p">(</span><span class="n">i</span><span class="p">)</span> <span class="p">)</span> <span class="o">*</span> <span class="n">dxhi</span><span class="p">(</span><span class="n">i</span><span class="o">+</span><span class="mi">1</span><span class="p">)</span>  <span class="c">! dx is non-equidistant</span>
<a name="ln-911"></a>
<a name="ln-912"></a>
<a name="ln-913"></a>                <span class="c">! discretized diffusion term</span>
<a name="ln-914"></a>                <span class="n">putout</span><span class="p">(</span><span class="n">i</span><span class="p">,</span><span class="n">j</span><span class="p">,</span><span class="n">k</span><span class="p">)</span> <span class="o">=</span> <span class="n">putout</span><span class="p">(</span><span class="n">i</span><span class="p">,</span><span class="n">j</span><span class="p">,</span><span class="n">k</span><span class="p">)</span> <span class="p">&amp;</span>
<a name="ln-915"></a>                     <span class="o">+</span> <span class="p">&amp;</span>
<a name="ln-916"></a>                     <span class="p">(</span> <span class="n">epmo</span> <span class="o">*</span> <span class="p">(</span> <span class="p">(</span><span class="n">v0</span><span class="p">(</span><span class="n">i</span><span class="o">+</span><span class="mi">1</span><span class="p">,</span><span class="n">j</span><span class="p">,</span><span class="n">k</span><span class="p">)</span><span class="o">-</span><span class="n">v0</span><span class="p">(</span><span class="n">i</span><span class="p">,</span><span class="n">j</span><span class="p">,</span><span class="n">k</span><span class="p">))</span>   <span class="o">*</span><span class="n">dxhi</span><span class="p">(</span><span class="n">i</span><span class="o">+</span><span class="mi">1</span><span class="p">)</span> <span class="p">&amp;</span>
<a name="ln-917"></a>                     <span class="o">+</span><span class="p">(</span><span class="n">u0</span><span class="p">(</span><span class="n">i</span><span class="o">+</span><span class="mi">1</span><span class="p">,</span><span class="n">j</span><span class="p">,</span><span class="n">k</span><span class="p">)</span><span class="o">-</span><span class="n">u0</span><span class="p">(</span><span class="n">i</span><span class="o">+</span><span class="mi">1</span><span class="p">,</span><span class="n">jm</span><span class="p">,</span><span class="n">k</span><span class="p">))</span><span class="o">*</span><span class="n">dyi</span><span class="p">)</span> <span class="p">&amp;</span>
<a name="ln-918"></a>                     <span class="o">-</span><span class="n">emmo</span> <span class="o">*</span> <span class="p">(</span> <span class="p">(</span><span class="n">v0</span><span class="p">(</span><span class="n">i</span><span class="p">,</span><span class="n">j</span><span class="p">,</span><span class="n">k</span><span class="p">)</span><span class="o">-</span><span class="n">v0</span><span class="p">(</span><span class="n">i</span><span class="o">-</span><span class="mi">1</span><span class="p">,</span><span class="n">j</span><span class="p">,</span><span class="n">k</span><span class="p">))</span>   <span class="o">*</span><span class="n">dxhi</span><span class="p">(</span><span class="n">i</span><span class="p">)</span> <span class="p">&amp;</span>
<a name="ln-919"></a>                     <span class="o">+</span><span class="p">(</span><span class="n">u0</span><span class="p">(</span><span class="n">i</span><span class="p">,</span><span class="n">j</span><span class="p">,</span><span class="n">k</span><span class="p">)</span><span class="o">-</span><span class="n">u0</span><span class="p">(</span><span class="n">i</span><span class="p">,</span><span class="n">jm</span><span class="p">,</span><span class="n">k</span><span class="p">))</span>    <span class="o">*</span><span class="n">dyi</span><span class="p">)</span> <span class="p">&amp;</span>
<a name="ln-920"></a>                     <span class="p">)</span> <span class="o">*</span> <span class="n">dxfi</span><span class="p">(</span><span class="n">i</span><span class="p">)</span> <span class="p">&amp;</span>        <span class="c">! = d/dx( Km*(dv/dx + du/dy) )</span>
<a name="ln-921"></a>                     <span class="o">+</span> <span class="p">&amp;</span>
<a name="ln-922"></a>                     <span class="p">(</span><span class="n">ekm</span><span class="p">(</span><span class="n">i</span><span class="p">,</span><span class="n">j</span><span class="p">,</span><span class="n">k</span><span class="p">)</span> <span class="o">*</span> <span class="p">(</span><span class="n">v0</span><span class="p">(</span><span class="n">i</span><span class="p">,</span><span class="n">jp</span><span class="p">,</span><span class="n">k</span><span class="p">)</span><span class="o">-</span><span class="n">v0</span><span class="p">(</span><span class="n">i</span><span class="p">,</span><span class="n">j</span><span class="p">,</span><span class="n">k</span><span class="p">))</span> <span class="p">&amp;</span>
<a name="ln-923"></a>                     <span class="o">-</span><span class="n">ekm</span><span class="p">(</span><span class="n">i</span><span class="p">,</span><span class="n">jm</span><span class="p">,</span><span class="n">k</span><span class="p">)</span><span class="o">*</span> <span class="p">(</span><span class="n">v0</span><span class="p">(</span><span class="n">i</span><span class="p">,</span><span class="n">j</span><span class="p">,</span><span class="n">k</span><span class="p">)</span><span class="o">-</span><span class="n">v0</span><span class="p">(</span><span class="n">i</span><span class="p">,</span><span class="n">jm</span><span class="p">,</span><span class="n">k</span><span class="p">))</span>  <span class="p">)</span> <span class="o">*</span> <span class="mf">2.</span> <span class="o">*</span> <span class="n">dy2i</span> <span class="p">&amp;</span>        <span class="c">! = d/dy( 2*Km*(dv/dy) )</span>
<a name="ln-924"></a>                     <span class="o">+</span> <span class="p">&amp;</span>
<a name="ln-925"></a>                     <span class="p">(</span> <span class="n">eomp</span> <span class="o">*</span> <span class="p">(</span> <span class="p">(</span><span class="n">v0</span><span class="p">(</span><span class="n">i</span><span class="p">,</span><span class="n">j</span><span class="p">,</span><span class="n">kp</span><span class="p">)</span><span class="o">-</span><span class="n">v0</span><span class="p">(</span><span class="n">i</span><span class="p">,</span><span class="n">j</span><span class="p">,</span><span class="n">k</span><span class="p">))</span>    <span class="o">*</span><span class="n">dzhi</span><span class="p">(</span><span class="n">kp</span><span class="p">)</span> <span class="p">&amp;</span>
<a name="ln-926"></a>                     <span class="o">+</span><span class="p">(</span><span class="n">w0</span><span class="p">(</span><span class="n">i</span><span class="p">,</span><span class="n">j</span><span class="p">,</span><span class="n">kp</span><span class="p">)</span><span class="o">-</span><span class="n">w0</span><span class="p">(</span><span class="n">i</span><span class="p">,</span><span class="n">jm</span><span class="p">,</span><span class="n">kp</span><span class="p">))</span>  <span class="o">*</span><span class="n">dyi</span><span class="p">)</span> <span class="p">&amp;</span>
<a name="ln-927"></a>                     <span class="o">-</span><span class="n">eomm</span> <span class="o">*</span> <span class="p">(</span> <span class="p">(</span><span class="n">v0</span><span class="p">(</span><span class="n">i</span><span class="p">,</span><span class="n">j</span><span class="p">,</span><span class="n">k</span><span class="p">)</span><span class="o">-</span><span class="n">v0</span><span class="p">(</span><span class="n">i</span><span class="p">,</span><span class="n">j</span><span class="p">,</span><span class="n">km</span><span class="p">))</span>    <span class="o">*</span><span class="n">dzhi</span><span class="p">(</span><span class="n">k</span><span class="p">)</span> <span class="p">&amp;</span>
<a name="ln-928"></a>                     <span class="o">+</span><span class="p">(</span><span class="n">w0</span><span class="p">(</span><span class="n">i</span><span class="p">,</span><span class="n">j</span><span class="p">,</span><span class="n">k</span><span class="p">)</span><span class="o">-</span><span class="n">w0</span><span class="p">(</span><span class="n">i</span><span class="p">,</span><span class="n">jm</span><span class="p">,</span><span class="n">k</span><span class="p">))</span>    <span class="o">*</span><span class="n">dyi</span><span class="p">)</span>   <span class="p">&amp;</span>
<a name="ln-929"></a>                     <span class="p">)</span> <span class="o">*</span> <span class="n">dzfi</span><span class="p">(</span><span class="n">k</span><span class="p">)</span>       <span class="c">! = d/dz( Km*(dv/dz + dw/dy) )</span>
<a name="ln-930"></a>             <span class="k">end do</span>
<a name="ln-931"></a><span class="k">          end do</span>
<a name="ln-932"></a><span class="k">       end do</span>
<a name="ln-933"></a>
<a name="ln-934"></a><span class="k">    else</span>  <span class="c">! DNS</span>
<a name="ln-935"></a>
<a name="ln-936"></a>       <span class="k">do </span><span class="n">k</span><span class="o">=</span><span class="n">kb</span><span class="p">,</span><span class="n">ke</span>
<a name="ln-937"></a>          <span class="n">kp</span><span class="o">=</span><span class="n">k</span><span class="o">+</span><span class="mi">1</span>
<a name="ln-938"></a>          <span class="n">km</span><span class="o">=</span><span class="n">k</span><span class="o">-</span><span class="mi">1</span>
<a name="ln-939"></a>
<a name="ln-940"></a>          <span class="k">do </span><span class="n">j</span><span class="o">=</span><span class="n">jb</span><span class="p">,</span><span class="n">je</span>
<a name="ln-941"></a>             <span class="n">jp</span><span class="o">=</span><span class="n">j</span><span class="o">+</span><span class="mi">1</span>
<a name="ln-942"></a>             <span class="n">jm</span><span class="o">=</span><span class="n">j</span><span class="o">-</span><span class="mi">1</span>
<a name="ln-943"></a>
<a name="ln-944"></a>             <span class="k">do </span><span class="n">i</span><span class="o">=</span><span class="n">ib</span><span class="p">,</span><span class="n">ie</span>
<a name="ln-945"></a>
<a name="ln-946"></a>                <span class="n">putout</span><span class="p">(</span><span class="n">i</span><span class="p">,</span><span class="n">j</span><span class="p">,</span><span class="n">k</span><span class="p">)</span> <span class="o">=</span> <span class="n">putout</span><span class="p">(</span><span class="n">i</span><span class="p">,</span><span class="n">j</span><span class="p">,</span><span class="n">k</span><span class="p">)</span> <span class="p">&amp;</span>
<a name="ln-947"></a>                     <span class="o">+</span> <span class="p">&amp;</span>
<a name="ln-948"></a>                     <span class="p">(</span> <span class="n">numol</span> <span class="o">*</span> <span class="p">(</span> <span class="p">(</span><span class="n">v0</span><span class="p">(</span><span class="n">i</span><span class="o">+</span><span class="mi">1</span><span class="p">,</span><span class="n">j</span><span class="p">,</span><span class="n">k</span><span class="p">)</span><span class="o">-</span><span class="n">v0</span><span class="p">(</span><span class="n">i</span><span class="p">,</span><span class="n">j</span><span class="p">,</span><span class="n">k</span><span class="p">))</span>   <span class="o">*</span><span class="n">dxhi</span><span class="p">(</span><span class="n">i</span><span class="o">+</span><span class="mi">1</span><span class="p">)</span> <span class="p">&amp;</span>
<a name="ln-949"></a>                     <span class="o">+</span><span class="p">(</span><span class="n">u0</span><span class="p">(</span><span class="n">i</span><span class="o">+</span><span class="mi">1</span><span class="p">,</span><span class="n">j</span><span class="p">,</span><span class="n">k</span><span class="p">)</span><span class="o">-</span><span class="n">u0</span><span class="p">(</span><span class="n">i</span><span class="o">+</span><span class="mi">1</span><span class="p">,</span><span class="n">jm</span><span class="p">,</span><span class="n">k</span><span class="p">))</span><span class="o">*</span><span class="n">dyi</span><span class="p">)</span> <span class="p">&amp;</span>
<a name="ln-950"></a>                     <span class="o">-</span><span class="n">numol</span> <span class="o">*</span> <span class="p">(</span> <span class="p">(</span><span class="n">v0</span><span class="p">(</span><span class="n">i</span><span class="p">,</span><span class="n">j</span><span class="p">,</span><span class="n">k</span><span class="p">)</span><span class="o">-</span><span class="n">v0</span><span class="p">(</span><span class="n">i</span><span class="o">-</span><span class="mi">1</span><span class="p">,</span><span class="n">j</span><span class="p">,</span><span class="n">k</span><span class="p">))</span>   <span class="o">*</span><span class="n">dxhi</span><span class="p">(</span><span class="n">i</span><span class="p">)</span> <span class="p">&amp;</span>
<a name="ln-951"></a>                     <span class="o">+</span><span class="p">(</span><span class="n">u0</span><span class="p">(</span><span class="n">i</span><span class="p">,</span><span class="n">j</span><span class="p">,</span><span class="n">k</span><span class="p">)</span><span class="o">-</span><span class="n">u0</span><span class="p">(</span><span class="n">i</span><span class="p">,</span><span class="n">jm</span><span class="p">,</span><span class="n">k</span><span class="p">))</span>    <span class="o">*</span><span class="n">dyi</span><span class="p">)</span> <span class="p">&amp;</span>
<a name="ln-952"></a>                     <span class="p">)</span> <span class="o">*</span> <span class="n">dxfi</span><span class="p">(</span><span class="n">i</span><span class="p">)</span> <span class="p">&amp;</span>        <span class="c">! = d/dx( Km*(dv/dx + du/dy) )</span>
<a name="ln-953"></a>                     <span class="o">+</span> <span class="p">&amp;</span>
<a name="ln-954"></a>                     <span class="p">(</span><span class="n">numol</span> <span class="o">*</span> <span class="p">(</span><span class="n">v0</span><span class="p">(</span><span class="n">i</span><span class="p">,</span><span class="n">jp</span><span class="p">,</span><span class="n">k</span><span class="p">)</span><span class="o">-</span><span class="n">v0</span><span class="p">(</span><span class="n">i</span><span class="p">,</span><span class="n">j</span><span class="p">,</span><span class="n">k</span><span class="p">))</span> <span class="p">&amp;</span>
<a name="ln-955"></a>                     <span class="o">-</span><span class="n">numol</span> <span class="o">*</span> <span class="p">(</span><span class="n">v0</span><span class="p">(</span><span class="n">i</span><span class="p">,</span><span class="n">j</span><span class="p">,</span><span class="n">k</span><span class="p">)</span><span class="o">-</span><span class="n">v0</span><span class="p">(</span><span class="n">i</span><span class="p">,</span><span class="n">jm</span><span class="p">,</span><span class="n">k</span><span class="p">))</span>  <span class="p">)</span> <span class="o">*</span> <span class="mf">2.</span> <span class="o">*</span> <span class="n">dy2i</span> <span class="p">&amp;</span>        <span class="c">! = d/dy( 2*Km*(dv/dy) )</span>
<a name="ln-956"></a>                     <span class="o">+</span> <span class="p">&amp;</span>
<a name="ln-957"></a>                     <span class="p">(</span> <span class="n">numol</span> <span class="o">*</span> <span class="p">(</span> <span class="p">(</span><span class="n">v0</span><span class="p">(</span><span class="n">i</span><span class="p">,</span><span class="n">j</span><span class="p">,</span><span class="n">kp</span><span class="p">)</span><span class="o">-</span><span class="n">v0</span><span class="p">(</span><span class="n">i</span><span class="p">,</span><span class="n">j</span><span class="p">,</span><span class="n">k</span><span class="p">))</span>    <span class="o">*</span><span class="n">dzhi</span><span class="p">(</span><span class="n">kp</span><span class="p">)</span> <span class="p">&amp;</span>
<a name="ln-958"></a>                     <span class="o">+</span><span class="p">(</span><span class="n">w0</span><span class="p">(</span><span class="n">i</span><span class="p">,</span><span class="n">j</span><span class="p">,</span><span class="n">kp</span><span class="p">)</span><span class="o">-</span><span class="n">w0</span><span class="p">(</span><span class="n">i</span><span class="p">,</span><span class="n">jm</span><span class="p">,</span><span class="n">kp</span><span class="p">))</span>  <span class="o">*</span><span class="n">dyi</span><span class="p">)</span> <span class="p">&amp;</span>
<a name="ln-959"></a>                     <span class="o">-</span><span class="n">numol</span> <span class="o">*</span> <span class="p">(</span> <span class="p">(</span><span class="n">v0</span><span class="p">(</span><span class="n">i</span><span class="p">,</span><span class="n">j</span><span class="p">,</span><span class="n">k</span><span class="p">)</span><span class="o">-</span><span class="n">v0</span><span class="p">(</span><span class="n">i</span><span class="p">,</span><span class="n">j</span><span class="p">,</span><span class="n">km</span><span class="p">))</span>    <span class="o">*</span><span class="n">dzhi</span><span class="p">(</span><span class="n">k</span><span class="p">)</span> <span class="p">&amp;</span>
<a name="ln-960"></a>                     <span class="o">+</span><span class="p">(</span><span class="n">w0</span><span class="p">(</span><span class="n">i</span><span class="p">,</span><span class="n">j</span><span class="p">,</span><span class="n">k</span><span class="p">)</span><span class="o">-</span><span class="n">w0</span><span class="p">(</span><span class="n">i</span><span class="p">,</span><span class="n">jm</span><span class="p">,</span><span class="n">k</span><span class="p">))</span>    <span class="o">*</span><span class="n">dyi</span><span class="p">)</span>   <span class="p">&amp;</span>
<a name="ln-961"></a>                     <span class="p">)</span> <span class="o">*</span> <span class="n">dzfi</span><span class="p">(</span><span class="n">k</span><span class="p">)</span>       <span class="c">! = d/dz( Km*(dv/dz + dw/dy) )</span>
<a name="ln-962"></a>             <span class="k">end do</span>
<a name="ln-963"></a><span class="k">          end do</span>
<a name="ln-964"></a><span class="k">       end do</span>
<a name="ln-965"></a>
<a name="ln-966"></a><span class="k">    end if</span>
<a name="ln-967"></a>
<a name="ln-968"></a>
<a name="ln-969"></a><span class="k">  end subroutine </span><span class="n">diffv</span>
<a name="ln-970"></a>
<a name="ln-971"></a>
<a name="ln-972"></a>
<a name="ln-973"></a>  <span class="k">subroutine </span><span class="n">diffw</span><span class="p">(</span><span class="n">putout</span><span class="p">)</span>
<a name="ln-974"></a>
<a name="ln-975"></a>    <span class="k">use </span><span class="n">modglobal</span><span class="p">,</span> <span class="n">only</span>   <span class="p">:</span> <span class="n">ib</span><span class="p">,</span><span class="n">ie</span><span class="p">,</span><span class="n">ih</span><span class="p">,</span><span class="n">jb</span><span class="p">,</span><span class="n">je</span><span class="p">,</span><span class="n">jh</span><span class="p">,</span><span class="n">kb</span><span class="p">,</span><span class="n">ke</span><span class="p">,</span><span class="n">kh</span><span class="p">,</span><span class="n">kmax</span><span class="p">,</span><span class="n">dxf</span><span class="p">,</span><span class="n">dxhi</span><span class="p">,</span><span class="n">dxfi</span><span class="p">,</span><span class="n">dy</span><span class="p">,&amp;</span>
<a name="ln-976"></a>         <span class="n">dyi</span><span class="p">,</span><span class="n">dy2i</span><span class="p">,</span><span class="n">dzf</span><span class="p">,</span><span class="n">dzfi</span><span class="p">,</span><span class="n">dzhi</span><span class="p">,</span><span class="n">dzhiq</span><span class="p">,</span><span class="n">jmax</span><span class="p">,</span><span class="n">numol</span><span class="p">,</span><span class="n">lles</span>
<a name="ln-977"></a>    <span class="k">use </span><span class="n">modfields</span><span class="p">,</span> <span class="n">only</span>   <span class="p">:</span> <span class="n">u0</span><span class="p">,</span><span class="n">v0</span><span class="p">,</span><span class="n">w0</span>
<a name="ln-978"></a>    <span class="k">use </span><span class="n">modmpi</span><span class="p">,</span> <span class="n">only</span>      <span class="p">:</span> <span class="n">myid</span>
<a name="ln-979"></a>    <span class="k">implicit none</span>
<a name="ln-980"></a>
<a name="ln-981"></a>    <span class="c">!*****************************************************************</span>
<a name="ln-982"></a>
<a name="ln-983"></a>    <span class="kt">real</span><span class="p">,</span> <span class="k">intent</span><span class="p">(</span><span class="n">inout</span><span class="p">)</span> <span class="kd">::</span> <span class="n">putout</span><span class="p">(</span><span class="n">ib</span><span class="o">-</span><span class="n">ih</span><span class="p">:</span><span class="n">ie</span><span class="o">+</span><span class="n">ih</span><span class="p">,</span><span class="n">jb</span><span class="o">-</span><span class="n">jh</span><span class="p">:</span><span class="n">je</span><span class="o">+</span><span class="n">jh</span><span class="p">,</span><span class="n">kb</span><span class="p">:</span><span class="n">ke</span><span class="o">+</span><span class="n">kh</span><span class="p">)</span>
<a name="ln-984"></a>    <span class="kt">real</span>                <span class="kd">::</span> <span class="n">emom</span><span class="p">,</span> <span class="n">eomm</span><span class="p">,</span> <span class="n">eopm</span><span class="p">,</span> <span class="n">epom</span>
<a name="ln-985"></a>    <span class="kt">integer</span>             <span class="kd">::</span> <span class="n">i</span><span class="p">,</span><span class="n">j</span><span class="p">,</span><span class="n">k</span><span class="p">,</span><span class="n">jm</span><span class="p">,</span><span class="n">jp</span><span class="p">,</span><span class="n">km</span><span class="p">,</span><span class="n">kp</span>
<a name="ln-986"></a>
<a name="ln-987"></a>    <span class="k">if</span> <span class="p">(</span><span class="n">lles</span><span class="p">)</span> <span class="k">then</span>
<a name="ln-988"></a>
<a name="ln-989"></a><span class="k">       do </span><span class="n">k</span><span class="o">=</span><span class="n">kb</span><span class="o">+</span><span class="mi">1</span><span class="p">,</span><span class="n">ke</span>
<a name="ln-990"></a>          <span class="n">kp</span><span class="o">=</span><span class="n">k</span><span class="o">+</span><span class="mi">1</span>
<a name="ln-991"></a>          <span class="n">km</span><span class="o">=</span><span class="n">k</span><span class="o">-</span><span class="mi">1</span>
<a name="ln-992"></a>          <span class="k">do </span><span class="n">j</span><span class="o">=</span><span class="n">jb</span><span class="p">,</span><span class="n">je</span>
<a name="ln-993"></a>             <span class="n">jp</span><span class="o">=</span><span class="n">j</span><span class="o">+</span><span class="mi">1</span>
<a name="ln-994"></a>             <span class="n">jm</span><span class="o">=</span><span class="n">j</span><span class="o">-</span><span class="mi">1</span>
<a name="ln-995"></a>             <span class="k">do </span><span class="n">i</span><span class="o">=</span><span class="n">ib</span><span class="p">,</span><span class="n">ie</span>
<a name="ln-996"></a>
<a name="ln-997"></a>                <span class="n">emom</span> <span class="o">=</span> <span class="p">(</span> <span class="n">dzf</span><span class="p">(</span><span class="n">km</span><span class="p">)</span> <span class="o">*</span> <span class="p">(</span> <span class="n">ekm</span><span class="p">(</span><span class="n">i</span><span class="p">,</span><span class="n">j</span><span class="p">,</span><span class="n">k</span><span class="p">)</span><span class="o">*</span><span class="n">dxf</span><span class="p">(</span><span class="n">i</span><span class="o">-</span><span class="mi">1</span><span class="p">)</span>  <span class="o">+</span> <span class="n">ekm</span><span class="p">(</span><span class="n">i</span><span class="o">-</span><span class="mi">1</span><span class="p">,</span><span class="n">j</span><span class="p">,</span><span class="n">k</span><span class="p">)</span><span class="o">*</span><span class="n">dxf</span><span class="p">(</span><span class="n">i</span><span class="p">)</span> <span class="p">)</span><span class="o">*</span><span class="n">dxhi</span><span class="p">(</span><span class="n">i</span><span class="p">)</span>  <span class="o">+</span> <span class="p">&amp;</span>
<a name="ln-998"></a>                     <span class="n">dzf</span><span class="p">(</span><span class="n">k</span><span class="p">)</span>  <span class="o">*</span> <span class="p">(</span> <span class="n">ekm</span><span class="p">(</span><span class="n">i</span><span class="p">,</span><span class="n">j</span><span class="p">,</span><span class="n">km</span><span class="p">)</span><span class="o">*</span><span class="n">dxf</span><span class="p">(</span><span class="n">i</span><span class="o">-</span><span class="mi">1</span><span class="p">)</span> <span class="o">+</span> <span class="n">ekm</span><span class="p">(</span><span class="n">i</span><span class="o">-</span><span class="mi">1</span><span class="p">,</span><span class="n">j</span><span class="p">,</span><span class="n">km</span><span class="p">)</span><span class="o">*</span><span class="n">dxf</span><span class="p">(</span><span class="n">i</span><span class="p">)</span> <span class="p">)</span><span class="o">*</span><span class="n">dxhi</span><span class="p">(</span><span class="n">i</span><span class="p">)</span> <span class="p">)</span> <span class="o">*</span> <span class="n">dzhiq</span><span class="p">(</span><span class="n">k</span><span class="p">)</span>
<a name="ln-999"></a>
<a name="ln-1000"></a>                <span class="n">eomm</span> <span class="o">=</span> <span class="p">(</span> <span class="n">dzf</span><span class="p">(</span><span class="n">km</span><span class="p">)</span> <span class="o">*</span> <span class="p">(</span> <span class="n">ekm</span><span class="p">(</span><span class="n">i</span><span class="p">,</span><span class="n">j</span><span class="p">,</span><span class="n">k</span><span class="p">)</span>  <span class="o">+</span> <span class="n">ekm</span><span class="p">(</span><span class="n">i</span><span class="p">,</span><span class="n">jm</span><span class="p">,</span><span class="n">k</span><span class="p">)</span>  <span class="p">)</span>  <span class="o">+</span> <span class="p">&amp;</span>
<a name="ln-1001"></a>                     <span class="n">dzf</span><span class="p">(</span><span class="n">k</span><span class="p">)</span>  <span class="o">*</span> <span class="p">(</span> <span class="n">ekm</span><span class="p">(</span><span class="n">i</span><span class="p">,</span><span class="n">j</span><span class="p">,</span><span class="n">km</span><span class="p">)</span> <span class="o">+</span> <span class="n">ekm</span><span class="p">(</span><span class="n">i</span><span class="p">,</span><span class="n">jm</span><span class="p">,</span><span class="n">km</span><span class="p">)</span> <span class="p">)</span> <span class="p">)</span> <span class="o">*</span> <span class="n">dzhiq</span><span class="p">(</span><span class="n">k</span><span class="p">)</span>
<a name="ln-1002"></a>
<a name="ln-1003"></a>                <span class="n">eopm</span> <span class="o">=</span> <span class="p">(</span> <span class="n">dzf</span><span class="p">(</span><span class="n">km</span><span class="p">)</span> <span class="o">*</span> <span class="p">(</span> <span class="n">ekm</span><span class="p">(</span><span class="n">i</span><span class="p">,</span><span class="n">j</span><span class="p">,</span><span class="n">k</span><span class="p">)</span>  <span class="o">+</span> <span class="n">ekm</span><span class="p">(</span><span class="n">i</span><span class="p">,</span><span class="n">jp</span><span class="p">,</span><span class="n">k</span><span class="p">)</span>  <span class="p">)</span>  <span class="o">+</span> <span class="p">&amp;</span>
<a name="ln-1004"></a>                     <span class="n">dzf</span><span class="p">(</span><span class="n">k</span><span class="p">)</span>  <span class="o">*</span> <span class="p">(</span> <span class="n">ekm</span><span class="p">(</span><span class="n">i</span><span class="p">,</span><span class="n">j</span><span class="p">,</span><span class="n">km</span><span class="p">)</span> <span class="o">+</span> <span class="n">ekm</span><span class="p">(</span><span class="n">i</span><span class="p">,</span><span class="n">jp</span><span class="p">,</span><span class="n">km</span><span class="p">)</span> <span class="p">)</span> <span class="p">)</span> <span class="o">*</span> <span class="n">dzhiq</span><span class="p">(</span><span class="n">k</span><span class="p">)</span>
<a name="ln-1005"></a>
<a name="ln-1006"></a>                <span class="n">epom</span> <span class="o">=</span> <span class="p">(</span> <span class="n">dzf</span><span class="p">(</span><span class="n">km</span><span class="p">)</span> <span class="o">*</span> <span class="p">(</span> <span class="n">ekm</span><span class="p">(</span><span class="n">i</span><span class="p">,</span><span class="n">j</span><span class="p">,</span><span class="n">k</span><span class="p">)</span><span class="o">*</span><span class="n">dxf</span><span class="p">(</span><span class="n">i</span><span class="o">+</span><span class="mi">1</span><span class="p">)</span>  <span class="o">+</span> <span class="n">ekm</span><span class="p">(</span><span class="n">i</span><span class="o">+</span><span class="mi">1</span><span class="p">,</span><span class="n">j</span><span class="p">,</span><span class="n">k</span><span class="p">)</span><span class="o">*</span><span class="n">dxf</span><span class="p">(</span><span class="n">i</span><span class="p">)</span> <span class="p">)</span><span class="o">*</span><span class="n">dxhi</span><span class="p">(</span><span class="n">i</span><span class="o">+</span><span class="mi">1</span><span class="p">)</span>  <span class="o">+</span> <span class="p">&amp;</span>
<a name="ln-1007"></a>                     <span class="n">dzf</span><span class="p">(</span><span class="n">k</span><span class="p">)</span>  <span class="o">*</span> <span class="p">(</span> <span class="n">ekm</span><span class="p">(</span><span class="n">i</span><span class="p">,</span><span class="n">j</span><span class="p">,</span><span class="n">km</span><span class="p">)</span><span class="o">*</span><span class="n">dxf</span><span class="p">(</span><span class="n">i</span><span class="o">+</span><span class="mi">1</span><span class="p">)</span> <span class="o">+</span> <span class="n">ekm</span><span class="p">(</span><span class="n">i</span><span class="o">+</span><span class="mi">1</span><span class="p">,</span><span class="n">j</span><span class="p">,</span><span class="n">km</span><span class="p">)</span><span class="o">*</span><span class="n">dxf</span><span class="p">(</span><span class="n">i</span><span class="p">)</span> <span class="p">)</span><span class="o">*</span><span class="n">dxhi</span><span class="p">(</span><span class="n">i</span><span class="o">+</span><span class="mi">1</span><span class="p">)</span> <span class="p">)</span> <span class="o">*</span> <span class="n">dzhiq</span><span class="p">(</span><span class="n">k</span><span class="p">)</span>
<a name="ln-1008"></a>
<a name="ln-1009"></a>
<a name="ln-1010"></a>                <span class="c">! discretized diffusion term</span>
<a name="ln-1011"></a>                <span class="n">putout</span><span class="p">(</span><span class="n">i</span><span class="p">,</span><span class="n">j</span><span class="p">,</span><span class="n">k</span><span class="p">)</span> <span class="o">=</span> <span class="n">putout</span><span class="p">(</span><span class="n">i</span><span class="p">,</span><span class="n">j</span><span class="p">,</span><span class="n">k</span><span class="p">)</span> <span class="p">&amp;</span>
<a name="ln-1012"></a>                     <span class="o">+</span> <span class="p">&amp;</span>
<a name="ln-1013"></a>                     <span class="p">(</span> <span class="n">epom</span> <span class="o">*</span> <span class="p">(</span> <span class="p">(</span><span class="n">w0</span><span class="p">(</span><span class="n">i</span><span class="o">+</span><span class="mi">1</span><span class="p">,</span><span class="n">j</span><span class="p">,</span><span class="n">k</span><span class="p">)</span><span class="o">-</span><span class="n">w0</span><span class="p">(</span><span class="n">i</span><span class="p">,</span><span class="n">j</span><span class="p">,</span><span class="n">k</span><span class="p">))</span>    <span class="o">*</span><span class="n">dxhi</span><span class="p">(</span><span class="n">i</span><span class="o">+</span><span class="mi">1</span><span class="p">)</span> <span class="p">&amp;</span>
<a name="ln-1014"></a>                     <span class="o">+</span><span class="p">(</span><span class="n">u0</span><span class="p">(</span><span class="n">i</span><span class="o">+</span><span class="mi">1</span><span class="p">,</span><span class="n">j</span><span class="p">,</span><span class="n">k</span><span class="p">)</span><span class="o">-</span><span class="n">u0</span><span class="p">(</span><span class="n">i</span><span class="o">+</span><span class="mi">1</span><span class="p">,</span><span class="n">j</span><span class="p">,</span><span class="n">km</span><span class="p">))</span> <span class="o">*</span><span class="n">dzhi</span><span class="p">(</span><span class="n">k</span><span class="p">)</span> <span class="p">)</span> <span class="p">&amp;</span>
<a name="ln-1015"></a>                     <span class="o">-</span><span class="n">emom</span> <span class="o">*</span> <span class="p">(</span> <span class="p">(</span><span class="n">w0</span><span class="p">(</span><span class="n">i</span><span class="p">,</span><span class="n">j</span><span class="p">,</span><span class="n">k</span><span class="p">)</span><span class="o">-</span><span class="n">w0</span><span class="p">(</span><span class="n">i</span><span class="o">-</span><span class="mi">1</span><span class="p">,</span><span class="n">j</span><span class="p">,</span><span class="n">k</span><span class="p">))</span>    <span class="o">*</span><span class="n">dxhi</span><span class="p">(</span><span class="n">i</span><span class="p">)</span> <span class="p">&amp;</span>
<a name="ln-1016"></a>                     <span class="o">+</span><span class="p">(</span><span class="n">u0</span><span class="p">(</span><span class="n">i</span><span class="p">,</span><span class="n">j</span><span class="p">,</span><span class="n">k</span><span class="p">)</span><span class="o">-</span><span class="n">u0</span><span class="p">(</span><span class="n">i</span><span class="p">,</span><span class="n">j</span><span class="p">,</span><span class="n">km</span><span class="p">))</span>     <span class="o">*</span><span class="n">dzhi</span><span class="p">(</span><span class="n">k</span><span class="p">)</span> <span class="p">)</span> <span class="p">&amp;</span>
<a name="ln-1017"></a>                     <span class="p">)</span><span class="o">*</span><span class="n">dxfi</span><span class="p">(</span><span class="n">i</span><span class="p">)</span> <span class="p">&amp;</span>
<a name="ln-1018"></a>                     <span class="o">+</span> <span class="p">&amp;</span>
<a name="ln-1019"></a>                     <span class="p">(</span> <span class="n">eopm</span> <span class="o">*</span> <span class="p">(</span> <span class="p">(</span><span class="n">w0</span><span class="p">(</span><span class="n">i</span><span class="p">,</span><span class="n">jp</span><span class="p">,</span><span class="n">k</span><span class="p">)</span><span class="o">-</span><span class="n">w0</span><span class="p">(</span><span class="n">i</span><span class="p">,</span><span class="n">j</span><span class="p">,</span><span class="n">k</span><span class="p">))</span>     <span class="o">*</span><span class="n">dyi</span> <span class="p">&amp;</span>
<a name="ln-1020"></a>                     <span class="o">+</span><span class="p">(</span><span class="n">v0</span><span class="p">(</span><span class="n">i</span><span class="p">,</span><span class="n">jp</span><span class="p">,</span><span class="n">k</span><span class="p">)</span><span class="o">-</span><span class="n">v0</span><span class="p">(</span><span class="n">i</span><span class="p">,</span><span class="n">jp</span><span class="p">,</span><span class="n">km</span><span class="p">))</span>   <span class="o">*</span><span class="n">dzhi</span><span class="p">(</span><span class="n">k</span><span class="p">)</span> <span class="p">)</span> <span class="p">&amp;</span>
<a name="ln-1021"></a>                     <span class="o">-</span><span class="n">eomm</span> <span class="o">*</span> <span class="p">(</span> <span class="p">(</span><span class="n">w0</span><span class="p">(</span><span class="n">i</span><span class="p">,</span><span class="n">j</span><span class="p">,</span><span class="n">k</span><span class="p">)</span><span class="o">-</span><span class="n">w0</span><span class="p">(</span><span class="n">i</span><span class="p">,</span><span class="n">jm</span><span class="p">,</span><span class="n">k</span><span class="p">))</span>     <span class="o">*</span><span class="n">dyi</span> <span class="p">&amp;</span>
<a name="ln-1022"></a>                     <span class="o">+</span><span class="p">(</span><span class="n">v0</span><span class="p">(</span><span class="n">i</span><span class="p">,</span><span class="n">j</span><span class="p">,</span><span class="n">k</span><span class="p">)</span><span class="o">-</span><span class="n">v0</span><span class="p">(</span><span class="n">i</span><span class="p">,</span><span class="n">j</span><span class="p">,</span><span class="n">km</span><span class="p">))</span>     <span class="o">*</span><span class="n">dzhi</span><span class="p">(</span><span class="n">k</span><span class="p">)</span> <span class="p">)</span> <span class="p">&amp;</span>
<a name="ln-1023"></a>                     <span class="p">)</span><span class="o">*</span><span class="n">dyi</span> <span class="p">&amp;</span>
<a name="ln-1024"></a>                     <span class="o">+</span> <span class="p">&amp;</span>
<a name="ln-1025"></a>                     <span class="p">(</span> <span class="n">ekm</span><span class="p">(</span><span class="n">i</span><span class="p">,</span><span class="n">j</span><span class="p">,</span><span class="n">k</span><span class="p">)</span> <span class="o">*</span> <span class="p">(</span><span class="n">w0</span><span class="p">(</span><span class="n">i</span><span class="p">,</span><span class="n">j</span><span class="p">,</span><span class="n">kp</span><span class="p">)</span><span class="o">-</span><span class="n">w0</span><span class="p">(</span><span class="n">i</span><span class="p">,</span><span class="n">j</span><span class="p">,</span><span class="n">k</span><span class="p">))</span> <span class="o">*</span><span class="n">dzfi</span><span class="p">(</span><span class="n">k</span><span class="p">)</span> <span class="p">&amp;</span>
<a name="ln-1026"></a>                     <span class="o">-</span><span class="n">ekm</span><span class="p">(</span><span class="n">i</span><span class="p">,</span><span class="n">j</span><span class="p">,</span><span class="n">km</span><span class="p">)</span><span class="o">*</span> <span class="p">(</span><span class="n">w0</span><span class="p">(</span><span class="n">i</span><span class="p">,</span><span class="n">j</span><span class="p">,</span><span class="n">k</span><span class="p">)</span><span class="o">-</span><span class="n">w0</span><span class="p">(</span><span class="n">i</span><span class="p">,</span><span class="n">j</span><span class="p">,</span><span class="n">km</span><span class="p">))</span> <span class="o">*</span><span class="n">dzfi</span><span class="p">(</span><span class="n">km</span><span class="p">)</span> <span class="p">)</span> <span class="o">*</span> <span class="mf">2.</span> <span class="p">&amp;</span>
<a name="ln-1027"></a>                     <span class="o">*</span> <span class="n">dzhi</span><span class="p">(</span><span class="n">k</span><span class="p">)</span> 
<a name="ln-1028"></a>             <span class="k">end do</span>
<a name="ln-1029"></a><span class="k">          end do</span>
<a name="ln-1030"></a><span class="k">       end do</span>
<a name="ln-1031"></a>
<a name="ln-1032"></a><span class="k">    else</span> <span class="c">! DNS</span>
<a name="ln-1033"></a>
<a name="ln-1034"></a>       <span class="k">do </span><span class="n">k</span><span class="o">=</span><span class="n">kb</span><span class="o">+</span><span class="mi">1</span><span class="p">,</span><span class="n">ke</span>
<a name="ln-1035"></a>          <span class="n">kp</span><span class="o">=</span><span class="n">k</span><span class="o">+</span><span class="mi">1</span>
<a name="ln-1036"></a>          <span class="n">km</span><span class="o">=</span><span class="n">k</span><span class="o">-</span><span class="mi">1</span>
<a name="ln-1037"></a>          <span class="k">do </span><span class="n">j</span><span class="o">=</span><span class="n">jb</span><span class="p">,</span><span class="n">je</span>
<a name="ln-1038"></a>             <span class="n">jp</span><span class="o">=</span><span class="n">j</span><span class="o">+</span><span class="mi">1</span>
<a name="ln-1039"></a>             <span class="n">jm</span><span class="o">=</span><span class="n">j</span><span class="o">-</span><span class="mi">1</span>
<a name="ln-1040"></a>             <span class="k">do </span><span class="n">i</span><span class="o">=</span><span class="n">ib</span><span class="p">,</span><span class="n">ie</span>
<a name="ln-1041"></a>
<a name="ln-1042"></a>                <span class="c">! discretized diffusion term</span>
<a name="ln-1043"></a>                <span class="n">putout</span><span class="p">(</span><span class="n">i</span><span class="p">,</span><span class="n">j</span><span class="p">,</span><span class="n">k</span><span class="p">)</span> <span class="o">=</span> <span class="n">putout</span><span class="p">(</span><span class="n">i</span><span class="p">,</span><span class="n">j</span><span class="p">,</span><span class="n">k</span><span class="p">)</span> <span class="p">&amp;</span>
<a name="ln-1044"></a>                     <span class="o">+</span> <span class="p">&amp;</span>
<a name="ln-1045"></a>                     <span class="p">(</span> <span class="n">numol</span> <span class="o">*</span> <span class="p">(</span> <span class="p">(</span><span class="n">w0</span><span class="p">(</span><span class="n">i</span><span class="o">+</span><span class="mi">1</span><span class="p">,</span><span class="n">j</span><span class="p">,</span><span class="n">k</span><span class="p">)</span><span class="o">-</span><span class="n">w0</span><span class="p">(</span><span class="n">i</span><span class="p">,</span><span class="n">j</span><span class="p">,</span><span class="n">k</span><span class="p">))</span>    <span class="o">*</span><span class="n">dxhi</span><span class="p">(</span><span class="n">i</span><span class="o">+</span><span class="mi">1</span><span class="p">)</span> <span class="p">&amp;</span>
<a name="ln-1046"></a>                     <span class="o">+</span><span class="p">(</span><span class="n">u0</span><span class="p">(</span><span class="n">i</span><span class="o">+</span><span class="mi">1</span><span class="p">,</span><span class="n">j</span><span class="p">,</span><span class="n">k</span><span class="p">)</span><span class="o">-</span><span class="n">u0</span><span class="p">(</span><span class="n">i</span><span class="o">+</span><span class="mi">1</span><span class="p">,</span><span class="n">j</span><span class="p">,</span><span class="n">km</span><span class="p">))</span> <span class="o">*</span><span class="n">dzhi</span><span class="p">(</span><span class="n">k</span><span class="p">)</span> <span class="p">)</span> <span class="p">&amp;</span>
<a name="ln-1047"></a>                     <span class="o">-</span><span class="n">numol</span> <span class="o">*</span> <span class="p">(</span> <span class="p">(</span><span class="n">w0</span><span class="p">(</span><span class="n">i</span><span class="p">,</span><span class="n">j</span><span class="p">,</span><span class="n">k</span><span class="p">)</span><span class="o">-</span><span class="n">w0</span><span class="p">(</span><span class="n">i</span><span class="o">-</span><span class="mi">1</span><span class="p">,</span><span class="n">j</span><span class="p">,</span><span class="n">k</span><span class="p">))</span>    <span class="o">*</span><span class="n">dxhi</span><span class="p">(</span><span class="n">i</span><span class="p">)</span> <span class="p">&amp;</span>
<a name="ln-1048"></a>                     <span class="o">+</span><span class="p">(</span><span class="n">u0</span><span class="p">(</span><span class="n">i</span><span class="p">,</span><span class="n">j</span><span class="p">,</span><span class="n">k</span><span class="p">)</span><span class="o">-</span><span class="n">u0</span><span class="p">(</span><span class="n">i</span><span class="p">,</span><span class="n">j</span><span class="p">,</span><span class="n">km</span><span class="p">))</span>     <span class="o">*</span><span class="n">dzhi</span><span class="p">(</span><span class="n">k</span><span class="p">)</span> <span class="p">)</span> <span class="p">&amp;</span>
<a name="ln-1049"></a>                     <span class="p">)</span><span class="o">*</span><span class="n">dxfi</span><span class="p">(</span><span class="n">i</span><span class="p">)</span> <span class="p">&amp;</span>
<a name="ln-1050"></a>                     <span class="o">+</span> <span class="p">&amp;</span>
<a name="ln-1051"></a>                     <span class="p">(</span> <span class="n">numol</span> <span class="o">*</span> <span class="p">(</span> <span class="p">(</span><span class="n">w0</span><span class="p">(</span><span class="n">i</span><span class="p">,</span><span class="n">jp</span><span class="p">,</span><span class="n">k</span><span class="p">)</span><span class="o">-</span><span class="n">w0</span><span class="p">(</span><span class="n">i</span><span class="p">,</span><span class="n">j</span><span class="p">,</span><span class="n">k</span><span class="p">))</span>     <span class="o">*</span><span class="n">dyi</span> <span class="p">&amp;</span>
<a name="ln-1052"></a>                     <span class="o">+</span><span class="p">(</span><span class="n">v0</span><span class="p">(</span><span class="n">i</span><span class="p">,</span><span class="n">jp</span><span class="p">,</span><span class="n">k</span><span class="p">)</span><span class="o">-</span><span class="n">v0</span><span class="p">(</span><span class="n">i</span><span class="p">,</span><span class="n">jp</span><span class="p">,</span><span class="n">km</span><span class="p">))</span>   <span class="o">*</span><span class="n">dzhi</span><span class="p">(</span><span class="n">k</span><span class="p">)</span> <span class="p">)</span> <span class="p">&amp;</span>
<a name="ln-1053"></a>                     <span class="o">-</span><span class="n">numol</span> <span class="o">*</span> <span class="p">(</span> <span class="p">(</span><span class="n">w0</span><span class="p">(</span><span class="n">i</span><span class="p">,</span><span class="n">j</span><span class="p">,</span><span class="n">k</span><span class="p">)</span><span class="o">-</span><span class="n">w0</span><span class="p">(</span><span class="n">i</span><span class="p">,</span><span class="n">jm</span><span class="p">,</span><span class="n">k</span><span class="p">))</span>     <span class="o">*</span><span class="n">dyi</span> <span class="p">&amp;</span>
<a name="ln-1054"></a>                     <span class="o">+</span><span class="p">(</span><span class="n">v0</span><span class="p">(</span><span class="n">i</span><span class="p">,</span><span class="n">j</span><span class="p">,</span><span class="n">k</span><span class="p">)</span><span class="o">-</span><span class="n">v0</span><span class="p">(</span><span class="n">i</span><span class="p">,</span><span class="n">j</span><span class="p">,</span><span class="n">km</span><span class="p">))</span>     <span class="o">*</span><span class="n">dzhi</span><span class="p">(</span><span class="n">k</span><span class="p">)</span> <span class="p">)</span> <span class="p">&amp;</span>
<a name="ln-1055"></a>                     <span class="p">)</span><span class="o">*</span><span class="n">dyi</span> <span class="p">&amp;</span>
<a name="ln-1056"></a>                     <span class="o">+</span> <span class="p">&amp;</span>
<a name="ln-1057"></a>                     <span class="p">(</span> <span class="n">numol</span> <span class="o">*</span> <span class="p">(</span><span class="n">w0</span><span class="p">(</span><span class="n">i</span><span class="p">,</span><span class="n">j</span><span class="p">,</span><span class="n">kp</span><span class="p">)</span><span class="o">-</span><span class="n">w0</span><span class="p">(</span><span class="n">i</span><span class="p">,</span><span class="n">j</span><span class="p">,</span><span class="n">k</span><span class="p">))</span> <span class="o">*</span><span class="n">dzfi</span><span class="p">(</span><span class="n">k</span><span class="p">)</span> <span class="p">&amp;</span>
<a name="ln-1058"></a>                     <span class="o">-</span><span class="n">numol</span> <span class="o">*</span> <span class="p">(</span><span class="n">w0</span><span class="p">(</span><span class="n">i</span><span class="p">,</span><span class="n">j</span><span class="p">,</span><span class="n">k</span><span class="p">)</span><span class="o">-</span><span class="n">w0</span><span class="p">(</span><span class="n">i</span><span class="p">,</span><span class="n">j</span><span class="p">,</span><span class="n">km</span><span class="p">))</span> <span class="o">*</span><span class="n">dzfi</span><span class="p">(</span><span class="n">km</span><span class="p">)</span> <span class="p">)</span> <span class="o">*</span> <span class="mf">2.</span> <span class="p">&amp;</span>
<a name="ln-1059"></a>                     <span class="o">*</span> <span class="n">dzhi</span><span class="p">(</span><span class="n">k</span><span class="p">)</span> 
<a name="ln-1060"></a>             <span class="k">end do</span>
<a name="ln-1061"></a><span class="k">          end do</span>
<a name="ln-1062"></a><span class="k">       end do</span>
<a name="ln-1063"></a>
<a name="ln-1064"></a><span class="k">    end if</span>
<a name="ln-1065"></a>
<a name="ln-1066"></a><span class="k">  end subroutine </span><span class="n">diffw</span>
<a name="ln-1067"></a>
<a name="ln-1068"></a><span class="k">end module </span><span class="n">modsubgrid</span>
</pre></div>

    </section>
    </div>
  </div>

  
    <hr>    
    </div> <!-- /container -->
    <footer>
      <div class="container">
      <div class="row">
        <div class="col-xs-6 col-md-4"><p>&copy; 2021 
                                          </p></div>
        <div class="col-xs-6 col-md-4 col-md-push-4">
          <p class="text-right">
            Documentation generated by 
            <a href="https://github.com/cmacmackin/ford">FORD</a>
            
          </p>
        </div>
        <div class="col-xs-12 col-md-4 col-md-pull-4"><p class="text-center"> uDALES was developed by The uDALES Team</p></div>
      </div>
      <br>
      </div> <!-- /container -->    
    </footer>

    <!-- Bootstrap core JavaScript
    ================================================== -->
    <!-- Placed at the end of the document so the pages load faster -->
<!--
    <script src="https://ajax.googleapis.com/ajax/libs/jquery/1.11.1/jquery.min.js"></script>
-->
    <script src="../js/bootstrap.min.js"></script>
    <!-- IE10 viewport hack for Surface/desktop Windows 8 bug -->
    <script src="../js/ie10-viewport-bug-workaround.js"></script>

    <!-- MathJax JavaScript
    ================================================== -->
    <!-- Placed at the end of the document so the pages load faster -->
    <script type="text/x-mathjax-config">
      MathJax.Hub.Config({
        TeX: { extensions: ['AMSmath.js','AMSsymbols.js','noErrors.js','noUndefined.js'], equationNumbers: { autoNumber: 'AMS' } },
        jax: ['input/TeX','input/MathML','output/HTML-CSS'],
        extensions: ['tex2jax.js','mml2jax.js','MathMenu.js','MathZoom.js']
      });
    </script>
    
    <script src="https://cdnjs.cloudflare.com/ajax/libs/mathjax/2.7.1/MathJax.js?config=TeX-AMS-MML_HTMLorMML"></script>
    
    
    <script src="../tipuesearch/tipuesearch_content.js"></script>
    <script src="../tipuesearch/tipuesearch_set.js"></script>
    <script src="../tipuesearch/tipuesearch.js"></script>
    
    
  </body>
</html>